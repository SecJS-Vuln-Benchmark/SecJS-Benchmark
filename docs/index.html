<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecJS ‚Äì JavaScript Vulnerability Benchmark</title>
    <style>
        :root {
            --primary: #1f3af5;
            --secondary: #0f172a;
            --accent: #22d3ee;
            --bg: #f4f6fb;
            --card: #ffffff;
            --muted: #6b7280;
            --border: #e2e8f0;
            --success: #0ea5e9;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--secondary);
            line-height: 1.6;
        }
        header {
            background: linear-gradient(135deg, var(--primary), #4338ca);
            color: white;
            padding: 60px 0 40px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        h1 { font-size: 2.75rem; margin: 0 0 0.5rem; }
        p.lead { font-size: 1.15rem; opacity: 0.9; }
        section { padding: 60px 0; }
        .section-title { font-size: 2rem; margin-bottom: 1.5rem; text-align: center; }
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }
        .variant-explainer {
            margin-top: 24px;
            background: var(--card);
            border-radius: 16px;
            padding: 20px 24px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(15, 23, 42, 0.05);
        }
        .variant-explainer ul {
            margin: 0;
            padding-left: 20px;
            color: var(--muted);
            line-height: 1.5;
        }
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(15, 23, 42, 0.05);
        }
        .stat-value { font-size: 2rem; font-weight: 700; margin: 0; }
        .stat-label { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.08em; color: var(--muted); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: #f8fafc; text-transform: uppercase; font-size: 0.8rem; color: var(--muted); }
        .metadata-block { margin-top: 32px; }
        .highlight {
            padding: 20px;
            background: rgba(34, 211, 238, 0.15);
            border: 1px solid rgba(34, 211, 238, 0.5);
            border-radius: 12px;
            margin: 20px 0 0;
        }
        .demo-selects {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .select-group {
            flex: 1;
            min-width: 200px;
        }
        .select-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--muted);
        }
        .select-group select {
            width: 100%;
            padding: 0.65rem 0.85rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            color: var(--text-primary);
        }
        .variant-tabs { display: flex; gap: 8px; margin: 20px 0 16px; flex-wrap: wrap; justify-content: center; }
        .variant-tabs button {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .variant-tabs button:hover {
            background: #f1f5f9;
        }
        .variant-tabs button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .version-toggle { display: flex; gap: 12px; margin-bottom: 16px; }
        .version-toggle button {
            flex: 1;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: white;
            padding: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .version-toggle button.active {
            background: #10b981;
            color: white;
            border-color: #0f9d7a;
        }
        .code-panel {
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 18px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            min-height: 260px;
        }
        pre { margin: 0; font-family: "JetBrains Mono", "Fira Code", monospace; font-size: 0.95rem; white-space: pre-wrap; }
        .code-meta { display: flex; flex-wrap: wrap; gap: 16px; margin: 16px 0; }
        .chip {
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.08);
            font-size: 0.9rem;
            font-weight: 600;
        }
        .chip span { color: var(--muted); font-weight: 500; margin-right: 6px; text-transform: uppercase; }
        .dataset-note {
            margin-top: 16px;
            font-size: 0.95rem;
            color: #d9534f;
            display: none;
        }
        .dataset-note.is-visible {
            display: block;
        }
        .case-study {
            background: #0f172a;
            color: white;
            border-radius: 24px;
            padding: 40px;
        }
        .case-study h3 { margin-top: 0; }
        .pill-list { display: grid; gap: 14px; margin-top: 24px; }
        .pill {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 16px;
            border-radius: 14px;
        }
        .pill strong { display: block; margin-bottom: 6px; color: var(--accent); }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .results-table th,
        .results-table td {
            padding: 8px;
            border: 1px solid var(--border);
            text-align: center;
            white-space: nowrap;
        }
        .results-table th {
            background: #f1f5f9;
            font-weight: 600;
        }
        .table-scroll {
            overflow-x: auto;
            margin-top: 16px;
        }
        footer { text-align: center; padding: 30px 0 60px; color: var(--muted); font-size: 0.9rem; }
        @media (max-width: 768px) {
            .code-meta { flex-direction: column; }
            .case-study { padding: 28px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>SecJS Benchmark</h1>
            <p class="lead"><em>Large Language Models Cannot Reliably Detect Vulnerabilities in JavaScript: The First Systematic Benchmark and Evaluation</em></p>
        </div>
    </header>

    <section id="metadata">
        <div class="container">
            <h2 class="section-title">A. Metadata</h2>
            <div class="metadata-grid">
                <div class="card">
                    <p class="stat-value">1,852</p>
                    <p class="stat-label">Original GitHub projects</p>
                    <p>Each sample bundles a vulnerable and fixed commit taken from CVE-linked GitHub projects (2018‚Äì2024).</p>
                </div>
                <div class="card">
                    <p class="stat-value">7,408</p>
                    <p class="stat-label">Instances after augmentation</p>
                    <p>Noise, obfuscation, noise+obf, and prompt-injection variants grow the corpus while keeping behavior unchanged.</p>
                </div>
                <div class="card">
                    <p class="stat-value">52,137</p>
                    <p class="stat-label">Projects evaluated (RQ3)</p>
                    <p>Across all five variants, JudgeJS runs both versions of every project (104,274 executions total).</p>
                </div>
                <div class="card">
                    <p class="stat-value">317.2M</p>
                    <p class="stat-label">Total tokens consumed</p>
                    <p>Average 6,085 tokens per project (5,491 input + 594 output), adding up to 286.3M input and 31.0M output tokens.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="demo">
        <div class="container">
            <h2 class="section-title">B. Demo</h2>
            <p style="text-align:center; max-width:800px; margin:0 auto 24px; color: var(--muted); font-size:0.95rem;">
                Due to the large dataset size (over 1 TB), we can only display one case per CWE type. Select a CWE to view its five variants (Original, Noise, Obfuscated, Noise+Obf, Prompt Injection) with both vulnerable and fixed versions.
            </p>

            <div class="demo-selects">
                <div class="select-group">
                    <label for="cweSelect">CWE Type</label>
                    <select id="cweSelect"></select>
                </div>
            </div>

            <div class="variant-tabs" id="variantTabs"></div>
            <div class="version-toggle" id="versionToggle"></div>

            <div class="code-panel">
                <pre id="codeSnippet"></pre>
            </div>
            <p class="dataset-note" id="datasetNote"></p>
        </div>
    </section>

    <section id="case-study">
        <div class="container">
            <h2 class="section-title">C. Case Study</h2>
            <div class="case-study">
                <h3>CVE-2021-25941 Case Study (deep-override)</h3>
                <p>
                    Prototype pollution in <code>src/index.js::override()</code> lets attacker-controlled keys overwrite <code>Object.prototype</code>, which can break or hijack Node.js apps that use deep-override while merging configs. The vulnerable release blocks only <code>__proto__</code>; the fixed release blocks <code>['__proto__','constructor','prototype']</code> and keeps the merge logic. Repo: <a href="https://github.com/ASaiAnudeep/deep-override" target="_blank" rel="noreferrer">ASaiAnudeep/deep-override</a>.
                </p>

                <h4>How this case instantiates the three SecJS principles (nine checkpoints)</h4>
                <div class="pill-list">
                    <div class="pill">
                        <strong>Principle 1 ¬∑ Comprehensiveness</strong>
                        <ul>
                            <li><em>Principle I-1 ¬∑ CWE coverage:</em> SecJS-Gen pulls CVEs from NVD and Mend.io so the dataset covers older CWEs (SQLi-89, XSS-79, command injection-78, auth bypass-287, hard-coded creds-798) plus newer CWEs (prototype pollution-1321, ReDoS-1333, XXE-611).</li>
                            <li><em>Principle I-2 ¬∑ Result and reasoning:</em> JudgeJS checks both project-level ‚ü®has_vulnerability, CWE‚ü© pairs and function-level ‚ü®has_vulnerability, CWE, file, function‚ü© pairs, so the model must point to `src/index.js::override()` instead of giving a one-line verdict.</li>
                            <li><em>Principle I-3 ¬∑ Real GitHub projects:</em> Every sample keeps the full repo (15 files here) plus a frontend/backend/full-stack tag, so the Node.js dependency path (express-session ‚Üí body-parser ‚Üí deep-override) stays in context.</li>
                        </ul>
                    </div>
                    <div class="pill">
                        <strong>Principle 2 ¬∑ Avoid Underestimation</strong>
                        <ul>
                            <li><em>Principle II-1 ¬∑ CWE equivalence:</em> MITRE CAPEC groups (for example XSS ‚áí CWE-79/80/83, prototype pollution ‚áí CWE-1321/915) mean predictions inside the same group are counted as correct.</li>
                            <li><em>Principle II-2 ¬∑ Denoised controls:</em> Samples carry ONEFUNC / NVDCHECK / SUSPICIOUS flags so experiments can focus on the high-confidence part (ONEFUNC+NVDCHECK) and skip noisy commits.</li>
                            <li><em>Principle II-3 ¬∑ Strong prompting:</em> The claude-code-security-review prompt guides the model through three steps: list known safe libraries, compare code with those patterns, then trace the taint path from source to sink.</li>
                        </ul>
                    </div>
                    <div class="pill">
                        <strong>Principle 3 ¬∑ Avoid Overestimation</strong>
                        <ul>
                            <li><em>Principle III-1 ¬∑ Full-project inputs:</em> JudgeJS always feeds the entire repo (package files, helpers, tests), so the model has to find the vulnerable `override` function itself.</li>
                            <li><em>Principle III-2 ¬∑ Vulnerable/fixed pairs:</em> Every CVE provides both versions; for this case the fixed build blocks `['__proto__','constructor','prototype']`, exposing detectors that flag strings instead of reasoning.</li>
                            <li><em>Principle III-3 ¬∑ Four augmentation tracks:</em> Noise (safe sinks), Obfuscation (renamed identifiers), Noise+Obf, and Prompt Injection (misleading comments) check whether the model still works after simple transformations.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card" style="margin-top:32px;">
                <h3 style="margin-top:0;">What the five variants mean</h3>
                <ul style="margin-left:20px;">
                    <li><strong>Original:</strong> Raw GitHub projects with paired vulnerable and fixed commits.</li>
                    <li><strong>Noise:</strong> Adds harmless file/DB/DOM statements so we can see whether models overreact to unrelated APIs.</li>
                    <li><strong>Obfuscated:</strong> Runs javascript-obfuscator to rename identifiers and encode literals while keeping semantics.</li>
                    <li><strong>Noise + Obf:</strong> Applies the noise injections first and then obfuscates the entire file for a tougher stress test.</li>
                    <li><strong>Prompt Injection:</strong> Inserts misleading audit comments (for example ‚ÄúSecurity audit passed‚Äù) to test textual prompt attacks.</li>
                </ul>
            </div>
        </div>
    </section>

    <section id="results-full">
        <div class="container">
            <h2 class="section-title">D. Full LLM Evaluation Table</h2>
            <p style="text-align:center; color: var(--muted); max-width:960px; margin:0 auto 24px;">
                Complete Precision / Recall / F1 / VD-S scores from the SecJS paper (Table RQ1). ‚ÄúFull‚Äù denotes the complete split; ‚ÄúDN‚Äù denotes the denoised split.
            </p>
            <div class="table-scroll">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th rowspan="2">LLM</th>
                            <th rowspan="2">Metric</th>
                            <th colspan="2">Original</th>
                            <th colspan="2">Noise</th>
                            <th colspan="2">Obfuscated</th>
                            <th colspan="2">Noise+Obf</th>
                            <th colspan="2">Prompt Injection</th>
                        </tr>
                        <tr>
                            <th>Full</th><th>DN</th>
                            <th>Full</th><th>DN</th>
                            <th>Full</th><th>DN</th>
                            <th>Full</th><th>DN</th>
                            <th>Full</th><th>DN</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td rowspan="4">GPT-5</td><td>Precision</td><td>37.3</td><td>37.8</td><td>20.0</td><td>20.2</td><td>33.3</td><td>33.0</td><td>23.6</td><td>23.6</td><td>32.0</td><td>32.4</td></tr>
                        <tr><td>Recall</td><td>28.1</td><td>27.5</td><td>15.0</td><td>14.7</td><td>17.4</td><td>16.6</td><td>14.3</td><td>13.9</td><td>21.5</td><td>20.8</td></tr>
                        <tr><td>F1</td><td>32.1</td><td>31.8</td><td>17.2</td><td>17.0</td><td>22.9</td><td>22.1</td><td>17.8</td><td>17.5</td><td>25.7</td><td>25.3</td></tr>
                        <tr><td>VD-S</td><td>57.2</td><td>58.1</td><td>61.9</td><td>62.5</td><td>77.2</td><td>77.8</td><td>76.6</td><td>77.2</td><td>78.5</td><td>79.2</td></tr>

                        <tr><td rowspan="4">GPT-5-Mini</td><td>Precision</td><td>34.1</td><td>34.1</td><td>13.8</td><td>13.3</td><td>34.7</td><td>35.7</td><td>12.0</td><td>11.9</td><td>26.9</td><td>26.6</td></tr>
                        <tr><td>Recall</td><td>26.4</td><td>25.7</td><td>12.5</td><td>11.7</td><td>20.2</td><td>20.2</td><td>10.1</td><td>10.0</td><td>24.1</td><td>23.2</td></tr>
                        <tr><td>F1</td><td>29.8</td><td>29.3</td><td>13.1</td><td>12.5</td><td>25.6</td><td>25.8</td><td>10.9</td><td>10.9</td><td>25.4</td><td>24.8</td></tr>
                        <tr><td>VD-S</td><td>73.6</td><td>74.3</td><td>56.2</td><td>57.0</td><td>79.8</td><td>79.8</td><td>59.4</td><td>60.0</td><td>75.9</td><td>76.8</td></tr>

                        <tr><td rowspan="4">GPT-5-Codex</td><td>Precision</td><td>43.0</td><td>43.7</td><td>18.8</td><td>18.0</td><td>43.4</td><td>44.8</td><td>12.4</td><td>11.8</td><td>38.1</td><td>39.2</td></tr>
                        <tr><td>Recall</td><td>29.1</td><td>28.9</td><td>12.8</td><td>12.0</td><td>19.3</td><td>19.3</td><td>8.1</td><td>7.7</td><td>21.2</td><td>20.9</td></tr>
                        <tr><td>F1</td><td>34.7</td><td>34.8</td><td>15.2</td><td>14.4</td><td>26.7</td><td>27.0</td><td>9.8</td><td>9.3</td><td>27.2</td><td>27.2</td></tr>
                        <tr><td>VD-S</td><td>70.9</td><td>71.1</td><td>62.7</td><td>63.5</td><td>80.7</td><td>80.7</td><td>59.0</td><td>59.8</td><td>78.8</td><td>79.1</td></tr>

                        <tr><td rowspan="4">DeepSeek-v3.1</td><td>Precision</td><td>31.0</td><td>30.6</td><td>6.3</td><td>5.9</td><td>32.7</td><td>32.4</td><td>4.7</td><td>4.6</td><td>27.9</td><td>28.2</td></tr>
                        <tr><td>Recall</td><td>22.8</td><td>21.6</td><td>5.4</td><td>5.0</td><td>17.0</td><td>16.9</td><td>3.8</td><td>3.6</td><td>27.2</td><td>27.1</td></tr>
                        <tr><td>F1</td><td>26.3</td><td>25.3</td><td>5.8</td><td>5.4</td><td>22.4</td><td>22.2</td><td>4.2</td><td>4.0</td><td>27.5</td><td>27.7</td></tr>
                        <tr><td>VD-S</td><td>77.0</td><td>78.4</td><td>64.8</td><td>65.5</td><td>83.0</td><td>83.1</td><td>50.0</td><td>50.8</td><td>72.7</td><td>72.9</td></tr>

                        <tr><td rowspan="4">Gemini-2.5-Pro</td><td>Precision</td><td>34.9</td><td>35.2</td><td>19.7</td><td>20.0</td><td>34.1</td><td>34.1</td><td>16.2</td><td>15.6</td><td>33.7</td><td>34.0</td></tr>
                        <tr><td>Recall</td><td>38.4</td><td>38.2</td><td>20.4</td><td>20.3</td><td>32.9</td><td>33.2</td><td>17.8</td><td>17.2</td><td>36.2</td><td>36.0</td></tr>
                        <tr><td>F1</td><td>36.6</td><td>36.6</td><td>20.0</td><td>20.1</td><td>33.5</td><td>33.7</td><td>17.0</td><td>16.4</td><td>34.9</td><td>35.0</td></tr>
                        <tr><td>VD-S</td><td>61.6</td><td>61.8</td><td>51.0</td><td>51.2</td><td>67.1</td><td>66.8</td><td>39.5</td><td>40.3</td><td>63.8</td><td>64.0</td></tr>

                        <tr><td rowspan="4">Gemini-Flash</td><td>Precision</td><td>28.8</td><td>28.7</td><td>16.9</td><td>16.5</td><td>27.2</td><td>27.0</td><td>14.4</td><td>12.8</td><td>28.8</td><td>29.0</td></tr>
                        <tr><td>Recall</td><td>31.4</td><td>31.2</td><td>17.7</td><td>17.4</td><td>25.0</td><td>25.0</td><td>12.0</td><td>10.8</td><td>31.8</td><td>31.5</td></tr>
                        <tr><td>F1</td><td>30.1</td><td>29.9</td><td>17.3</td><td>17.0</td><td>26.1</td><td>25.9</td><td>13.1</td><td>11.7</td><td>30.2</td><td>30.2</td></tr>
                        <tr><td>VD-S</td><td>68.6</td><td>68.8</td><td>54.2</td><td>54.5</td><td>75.0</td><td>75.0</td><td>63.4</td><td>64.7</td><td>68.2</td><td>68.5</td></tr>

                        <tr><td rowspan="4">Claude-4.5</td><td>Precision</td><td>37.2</td><td>37.7</td><td>4.4</td><td>4.2</td><td>17.8</td><td>16.9</td><td>4.0</td><td>3.9</td><td>28.8</td><td>29.1</td></tr>
                        <tr><td>Recall</td><td>34.8</td><td>34.3</td><td>4.0</td><td>3.8</td><td>16.5</td><td>15.5</td><td>3.8</td><td>3.6</td><td>25.5</td><td>24.8</td></tr>
                        <tr><td>F1</td><td>35.9</td><td>35.9</td><td>4.2</td><td>4.0</td><td>17.2</td><td>16.2</td><td>3.9</td><td>3.7</td><td>27.1</td><td>26.8</td></tr>
                        <tr><td>VD-S</td><td>65.2</td><td>65.7</td><td>58.6</td><td>59.0</td><td>83.5</td><td>84.5</td><td>48.7</td><td>49.2</td><td>74.5</td><td>75.2</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="results">
        <div class="container">
            <h2 class="section-title">E. LLM Evaluation Results (Summary)</h2>
            <p style="text-align:center; max-width:900px; margin:0 auto 20px; color: var(--muted);">
                Project-level F1 scores (Full split, %) reproduced from Table&nbsp;RQ1 of the paper. Each column shows how the same model behaves on a different dataset variant.
            </p>
            <div class="table-scroll">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Original</th>
                            <th>Noise</th>
                            <th>Obfuscated</th>
                            <th>Noise+Obf</th>
                            <th>Prompt Injection</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>GPT-5</td><td>32.1</td><td>17.2</td><td>22.9</td><td>17.8</td><td>25.7</td></tr>
                        <tr><td>GPT-5-Mini</td><td>29.8</td><td>13.1</td><td>25.6</td><td>10.9</td><td>25.4</td></tr>
                        <tr><td>GPT-5-Codex</td><td>34.7</td><td>15.2</td><td>26.7</td><td>9.8</td><td>27.2</td></tr>
                        <tr><td>DeepSeek-v3.1</td><td>26.3</td><td>5.8</td><td>22.4</td><td>4.2</td><td>27.5</td></tr>
                        <tr><td>Gemini-2.5-Pro</td><td>36.6</td><td>20.0</td><td>33.5</td><td>17.0</td><td>34.9</td></tr>
                        <tr><td>Gemini-Flash</td><td>30.1</td><td>17.3</td><td>26.1</td><td>13.1</td><td>30.2</td></tr>
                        <tr><td>Claude-4.5</td><td>35.9</td><td>4.2</td><td>17.2</td><td>3.9</td><td>27.1</td></tr>
                    </tbody>
                </table>
            </div>
            <p style="text-align:center; max-width:900px; margin:16px auto 0; color: var(--muted); font-size:0.9rem;">
                Scores illustrate how robustness drops once noise, obfuscation, or prompt injection is applied‚Äîhighlighting the need for all three SecJS principles.
            </p>
        </div>
    </section>

    <footer>
        SecJS Benchmark ¬∑ GitHub: <a href="https://github.com/SecJS-Vuln-Benchmark/SecJS-Benchmark" target="_blank">SecJS-Benchmark</a>
    </footer>

    <script>
        (function() {
            const manifestUrl = 'cwe_index.json';
            const cweSelect = document.getElementById('cweSelect');
            const variantTabs = document.getElementById('variantTabs');
            const versionToggle = document.getElementById('versionToggle');
            const codeSnippet = document.getElementById('codeSnippet');
            const datasetNote = document.getElementById('datasetNote');

            const shardCache = new Map();
            const textCache = new Map();
            let manifest = {};
            let activeCWE = '';
            let activeVariant = 'original'; // Will be updated based on available variants
            let activeVersion = 'vuln';
            let variantSamples = {}; // Store samples for each variant: {original: sample, noise: sample, ...}
            let allCweEntries = [];
            let controlsEnabled = true;

            const variantLabels = {
                original: 'Original',
                noise: 'Noise',
                obfuscated: 'Obfuscated',
                noise_obfuscated: 'Noise+Obf',
                prompt_injection: 'Prompt Injection'
            };

            const versionLabels = {
                vuln: 'Vulnerable build',
                fixed: 'Fixed build',
            };

            function normalizePath(path) {
                if (!path) return null;
                return path.startsWith('docs/') ? path.slice(5) : path;
            }

            function setNote(message, isError = false) {
                if (!isError || !message) {
                    datasetNote.textContent = '';
                    datasetNote.classList.remove('is-visible');
                    return;
                }
                datasetNote.textContent = message;
                datasetNote.classList.add('is-visible');
            }

            function reportError(prefix, detail) {
                const msg = detail && detail.message ? detail.message : detail;
                setNote(`${prefix}: ${msg}`, true);
                console.error(prefix, detail);
            }

            window.addEventListener('error', event => {
                reportError('Script error', event.error || event.message);
            });

            window.addEventListener('unhandledrejection', event => {
                reportError('Data fetch failed', event.reason);
            });

            function disableControls(disabled) {
                controlsEnabled = !disabled;
                if (cweSelect) cweSelect.disabled = disabled;
                if (variantTabs) {
                    Array.from(variantTabs.querySelectorAll('button')).forEach(btn => {
                        btn.style.opacity = disabled ? '0.5' : '1';
                        btn.style.cursor = disabled ? 'not-allowed' : 'pointer';
                    });
                }
                if (versionToggle) {
                    Array.from(versionToggle.querySelectorAll('button')).forEach(btn => {
                        btn.disabled = disabled;
                        btn.style.opacity = disabled ? '0.5' : '1';
                        btn.style.cursor = disabled ? 'not-allowed' : 'pointer';
                    });
                }
            }

            async function fetchJSON(url) {
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`Failed to load ${url}`);
                }
                return res.json();
            }

            async function fetchText(url) {
                if (textCache.has(url)) {
                    return textCache.get(url);
                }
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`Unable to fetch source: ${url}`);
                }
                const txt = await res.text();
                textCache.set(url, txt);
                return txt;
            }

            function renderVersionButtons() {
                if (!versionToggle) return;
                versionToggle.innerHTML = '';
                ['vuln', 'fixed'].forEach(version => {
                    const btn = document.createElement('button');
                    btn.textContent = versionLabels[version];
                    btn.classList.toggle('active', version === activeVersion);
                    btn.addEventListener('click', () => {
                        activeVersion = version;
                        renderVersionButtons();
                        updateCodeBlock();
                    });
                    versionToggle.appendChild(btn);
                });
            }

            function extractFileNames(fileEntry) {
                if (!fileEntry) {
                    return { vulnFull: '', fixedFull: '', vulnName: '', fixedName: '' };
                }
                const vulnFull = fileEntry.original_vulnerable || fileEntry.vulnerable_path || '';
                const fixedFull = fileEntry.original_fixed || fileEntry.fixed_path || '';
                const vulnName = vulnFull ? vulnFull.split('/').pop() : '';
                const fixedName = fixedFull ? fixedFull.split('/').pop() : '';
                return { vulnFull, fixedFull, vulnName, fixedName };
            }

            function populateCWESelect() {
                if (!cweSelect) return;
                const entries = Object.keys(manifest).sort((a, b) =>
                    a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
                );
                cweSelect.innerHTML = '';
                entries.forEach(cwe => {
                    const option = document.createElement('option');
                    option.value = cwe;
                    option.textContent = cwe;
                    cweSelect.appendChild(option);
                });
                if (entries.length) {
                    activeCWE = entries[0];
                    cweSelect.value = activeCWE;
                }
            }

            function loadVariantSamples(entries) {
                variantSamples = {};
                if (!entries || !entries.length) return;

                // Group entries by dataset
                const entriesByDataset = {};
                entries.forEach(entry => {
                    const ds = (entry.dataset || '').toLowerCase().trim();
                    if (!entriesByDataset[ds]) {
                        entriesByDataset[ds] = [];
                    }
                    entriesByDataset[ds].push(entry);
                });

                // For each dataset, use the first file (index 0) to show the same source file in different variants
                Object.keys(entriesByDataset).forEach(ds => {
                    const datasetEntries = entriesByDataset[ds];
                    if (datasetEntries.length > 0) {
                        const entry = datasetEntries[0]; // Take first entry (usually the main project)

                        // Create a modified entry that uses the first file (index 0)
                        // This ensures we show the same source file (_http_server) in different variants
                        const modifiedEntry = { ...entry };
                        if (modifiedEntry.files && modifiedEntry.files.length > 0) {
                            modifiedEntry.files = [modifiedEntry.files[0]]; // Always use first file
                        }

                        // Map to our variant keys
                        if (ds === 'final' || ds === 'original') {
                            variantSamples.original = modifiedEntry;
                        } else if (ds === 'noise') {
                            variantSamples.noise = modifiedEntry;
                        } else if (ds === 'obfuscated') {
                            variantSamples.obfuscated = modifiedEntry;
                        } else if (ds === 'noise_obfuscated') {
                            variantSamples.noise_obfuscated = modifiedEntry;
                        } else if (ds === 'prompt_injection') {
                            variantSamples.prompt_injection = modifiedEntry;
                        }
                    }
                });
            }

            async function switchVariant(variant) {
                console.log('üîÑ switchVariant called with:', variant);
                console.log('üìä Available variantSamples:', Object.keys(variantSamples));
                console.log('üéØ Current activeVariant:', activeVariant);

                if (!controlsEnabled || !variant || !variantSamples[variant]) {
                    console.log('‚ùå switchVariant blocked:', {controlsEnabled, variant, hasSample: !!variantSamples[variant]});
                    return;
                }

                activeVariant = variant;
                console.log('‚úÖ Set activeVariant to:', activeVariant);
                updateVariantTabStates();
                await updateCodeBlock();
                console.log('üéâ switchVariant completed');
            }

            function updateVariantTabStates() {
                if (!variantTabs) return;
                const buttons = variantTabs.querySelectorAll('button');
                buttons.forEach(btn => {
                    const variant = Object.keys(variantLabels).find(v => variantLabels[v] === btn.textContent);
                    if (variant) {
                        const hasData = variantSamples[variant];
                        btn.className = (variant === activeVariant && hasData) ? 'active' : '';
                        btn.disabled = !hasData;
                        btn.style.opacity = hasData ? '1' : '0.3';
                        btn.style.cursor = hasData ? 'pointer' : 'not-allowed';
                    }
                });
            }

            function renderVariantTabs() {
                if (!variantTabs) return;
                variantTabs.innerHTML = '';
                Object.keys(variantLabels).forEach(variant => {
                    const btn = document.createElement('button');
                    btn.textContent = variantLabels[variant];
                    const hasData = variantSamples[variant];
                    btn.className = (variant === activeVariant && hasData) ? 'active' : '';
                    btn.disabled = !hasData;
                    btn.style.opacity = hasData ? '1' : '0.3';
                    btn.style.cursor = hasData ? 'pointer' : 'not-allowed';
                    if (hasData) {
                        btn.onclick = () => switchVariant(variant);
                    }
                    variantTabs.appendChild(btn);
                });
            }

            async function updateCodeBlockWithSample(sample) {
                if (!codeSnippet) return;
                const files = sample.files || [];
                if (!files.length) {
                    codeSnippet.textContent = 'This sample does not include any files.';
                    setNote('No files listed for this sample. Regenerate the index.', true);
                    return;
                }
                const fileEntry = files[0];
                const targetPathRaw = activeVersion === 'vuln' ? fileEntry.vulnerable_path : fileEntry.fixed_path;
                if (!targetPathRaw) {
                    codeSnippet.textContent = 'No file is available for this version.';
                    return;
                }
                const targetPath = normalizePath(targetPathRaw);
                try {
                    codeSnippet.textContent = 'Loading code‚Ä¶';
                    const code = await fetchText(targetPath);
                    codeSnippet.textContent = code;
                    setNote('', false);
                } catch (err) {
                    codeSnippet.textContent = err.message;
                    setNote('Unable to load code. Run scripts/build_cwe_index.py before publishing.', true);
                }
            }

            async function updateCodeBlock() {
                console.log('üìù updateCodeBlock called for activeVariant:', activeVariant);
                const sample = variantSamples[activeVariant];
                console.log('üìÑ Sample found:', !!sample);
                if (sample) {
                    console.log('üìÑ Sample details:', {dataset: sample.dataset, filesCount: sample.files?.length});
                    await updateCodeBlockWithSample(sample);
                } else {
                    console.log('‚ùå No sample found for variant:', activeVariant);
                    if (codeSnippet) codeSnippet.textContent = '';
                    setNote('', false);
                }
            }

            async function handleCWEChange() {
                if (!cweSelect) return;
                activeCWE = cweSelect.value;
                if (!activeCWE) return;
                const meta = manifest[activeCWE];
                if (!meta) return;
                try {
                    disableControls(true);
                    if (!shardCache.has(activeCWE)) {
                        const shardPath = normalizePath(meta.file);
                        const data = await fetchJSON(shardPath);
                        allCweEntries = Array.isArray(data) ? data : [];
                        shardCache.set(activeCWE, allCweEntries);
                    } else {
                        allCweEntries = shardCache.get(activeCWE) || [];
                    }
                    if (!allCweEntries.length) {
                        if (codeSnippet) codeSnippet.textContent = '';
                        setNote(`No sample available for ${activeCWE}.`, true);
                        variantSamples = {};
                        renderVariantTabs(); // Clear buttons
                    } else {
                        loadVariantSamples(allCweEntries);
                        // If current variant is not available, switch to first available
                        if (!variantSamples[activeVariant]) {
                            const firstAvailable = Object.keys(variantSamples)[0];
                            if (firstAvailable) {
                                activeVariant = firstAvailable;
                            }
                        }
                        renderVariantTabs(); // Re-render buttons with correct data
                        await updateCodeBlock();
                    }
                } catch (err) {
                    setNote('Unable to load the CWE shard. Run scripts/build_cwe_index.py before publishing.', true);
                    if (codeSnippet) codeSnippet.textContent = err.message;
                    variantSamples = {};
                } finally {
                    disableControls(false);
                }
            }

            if (cweSelect) {
                cweSelect.addEventListener('change', () => {
                    handleCWEChange();
                });
            }

            async function init() {
                if (!cweSelect || !variantTabs || !versionToggle || !codeSnippet || !datasetNote) {
                    console.error('Required DOM elements not found');
                    return;
                }
                renderVersionButtons();
                disableControls(true);
                try {
                    manifest = await fetchJSON(manifestUrl);
                    if (!Object.keys(manifest).length) {
                        throw new Error('cwe_index.json is empty.');
                    }
                    populateCWESelect();
                    await handleCWEChange();
                    // renderVariantTabs() is already called in handleCWEChange()
                } catch (err) {
                    setNote('Missing cwe_index.json. Run scripts/build_cwe_index.py before publishing.', true);
                    if (codeSnippet) codeSnippet.textContent = err.message;
                } finally {
                    disableControls(false);
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
