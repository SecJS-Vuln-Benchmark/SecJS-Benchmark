<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecJS – JavaScript Vulnerability Benchmark</title>
    <style>
        :root {
            --primary: #1f3af5;
            --secondary: #0f172a;
            --accent: #22d3ee;
            --bg: #f4f6fb;
            --card: #ffffff;
            --muted: #6b7280;
            --border: #e2e8f0;
            --success: #0ea5e9;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--secondary);
            line-height: 1.6;
        }
        header {
            background: linear-gradient(135deg, var(--primary), #4338ca);
            color: white;
            padding: 60px 0 40px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        h1 { font-size: 2.75rem; margin: 0 0 0.5rem; }
        p.lead { font-size: 1.15rem; opacity: 0.9; }
        section { padding: 60px 0; }
        .section-title { font-size: 2rem; margin-bottom: 1.5rem; text-align: center; }
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }
        .variant-explainer {
            margin-top: 24px;
            background: var(--card);
            border-radius: 16px;
            padding: 20px 24px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(15, 23, 42, 0.05);
        }
        .variant-explainer ul {
            margin: 0;
            padding-left: 20px;
            color: var(--muted);
            line-height: 1.5;
        }
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(15, 23, 42, 0.05);
        }
        .stat-value { font-size: 2rem; font-weight: 700; margin: 0; }
        .stat-label { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.08em; color: var(--muted); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: #f8fafc; text-transform: uppercase; font-size: 0.8rem; color: var(--muted); }
        .metadata-block { margin-top: 32px; }
        .highlight {
            padding: 20px;
            background: rgba(34, 211, 238, 0.15);
            border: 1px solid rgba(34, 211, 238, 0.5);
            border-radius: 12px;
            margin: 20px 0 0;
        }
        .demo-selects {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .select-group {
            flex: 1;
            min-width: 200px;
        }
        .select-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--muted);
        }
        .select-group select {
            width: 100%;
            padding: 0.65rem 0.85rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            color: var(--text-primary);
        }
        .variant-tabs { display: flex; gap: 8px; margin: 20px 0 16px; flex-wrap: wrap; justify-content: center; }
        .cwe-description { margin: 20px 0; padding: 16px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid var(--primary); }
        .cwe-description h4 { color: var(--primary) !important; }
        .variant-tabs button {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .variant-tabs button:hover {
            background: #f1f5f9;
        }
        .variant-tabs button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .version-toggle { display: flex; gap: 12px; margin-bottom: 16px; }
        .version-toggle button {
            flex: 1;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: white;
            padding: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .version-toggle button.active {
            background: #10b981;
            color: white;
            border-color: #0f9d7a;
        }
        .code-panel {
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 18px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            min-height: 260px;
            max-height: 400px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }
        .code-panel.expanded {
            max-height: none;
            overflow-y: visible;
        }
        .code-footer {
            display: flex;
            justify-content: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .expand-collapse-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(31, 58, 245, 0.3);
        }
        .expand-collapse-btn:hover {
            background: #4338ca;
            box-shadow: 0 6px 16px rgba(31, 58, 245, 0.4);
            transform: translateY(-1px);
        }
        .expand-collapse-btn:active {
            transform: translateY(0);
        }
        pre { margin: 0; font-family: "JetBrains Mono", "Fira Code", monospace; font-size: 0.95rem; white-space: pre-wrap; }
        .code-meta { display: flex; flex-wrap: wrap; gap: 16px; margin: 16px 0; }
        .chip {
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.08);
            font-size: 0.9rem;
            font-weight: 600;
        }
        .chip span { color: var(--muted); font-weight: 500; margin-right: 6px; text-transform: uppercase; }
        .dataset-note {
            margin-top: 16px;
            font-size: 0.95rem;
            color: #d9534f;
            display: none;
        }
        .dataset-note.is-visible {
            display: block;
        }
        .case-study {
            background: #0f172a;
            color: white;
            border-radius: 24px;
            padding: 40px;
        }
        .case-study h3 { margin-top: 0; }
        .pill-list { display: grid; gap: 14px; margin-top: 24px; }
        .pill {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 16px;
            border-radius: 14px;
        }
        .pill strong { display: block; margin-bottom: 6px; color: var(--accent); }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .results-table th,
        .results-table td {
            padding: 8px;
            border: 1px solid var(--border);
            text-align: center;
            white-space: nowrap;
        }
        .results-table th {
            background: #f1f5f9;
            font-weight: 600;
        }
        .table-scroll {
            overflow-x: auto;
            margin-top: 16px;
        }
        footer { text-align: center; padding: 30px 0 60px; color: var(--muted); font-size: 0.9rem; }

        /* Interactive Controls */
        .interactive-controls {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(15, 23, 42, 0.05);
        }
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        .metric-btn, .split-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .metric-btn:hover, .split-btn:hover {
            background: #f1f5f9;
        }
        .metric-btn.active, .split-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .model-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
        }
        .model-checkbox input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        @media (max-width: 768px) {
            .interactive-controls {
                flex-direction: column;
                gap: 16px;
            }
            .model-checkboxes {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* Score color coding */
        .score-excellent { background-color: rgba(34, 197, 94, 0.1); color: #16a34a; font-weight: 600; }
        .score-good { background-color: rgba(59, 130, 246, 0.1); color: #2563eb; font-weight: 600; }
        .score-average { background-color: rgba(234, 179, 8, 0.1); color: #d97706; font-weight: 600; }
        .score-poor { background-color: rgba(239, 68, 68, 0.1); color: #dc2626; font-weight: 600; }
        @media (max-width: 768px) {
            .code-meta { flex-direction: column; }
            .case-study { padding: 28px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>SecJS Benchmark</h1>
            <p class="lead"><em>Large Language Models Cannot Reliably Detect Vulnerabilities in JavaScript: The First Systematic Benchmark and Evaluation</em></p>
        </div>
    </header>

    <section id="metadata">
        <div class="container">
            <h2 class="section-title">A. Metadata</h2>
            <div class="metadata-grid">
                <div class="card">
                    <p class="stat-value">1,852</p>
                    <p class="stat-label">Original GitHub projects</p>
                    <p>Each sample bundles a vulnerable and fixed commit taken from CVE-linked GitHub projects (2018–2024).</p>
                </div>
                <div class="card">
                    <p class="stat-value">7,408</p>
                    <p class="stat-label">Instances after augmentation</p>
                    <p>Noise, obfuscation, noise+obf, and prompt-injection variants grow the corpus while keeping behavior unchanged.</p>
                </div>
                <div class="card">
                    <p class="stat-value">52,137</p>
                    <p class="stat-label">Projects evaluated (RQ3)</p>
                    <p>Across all five variants, JudgeJS runs both versions of every project (104,274 executions total).</p>
                </div>
                <div class="card">
                    <p class="stat-value">317.2M</p>
                    <p class="stat-label">Total tokens consumed</p>
                    <p>Average 6,085 tokens per project (5,491 input + 594 output), adding up to 286.3M input and 31.0M output tokens.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="demo">
        <div class="container">
            <h2 class="section-title">B. Demo</h2>
            <p style="text-align:center; max-width:800px; margin:0 auto 24px; color: var(--muted); font-size:0.95rem;">
                Due to the large dataset size (over 1 TB), we can only display one case per CWE type here, showing the vulnerable code files with both vulnerable and fixed versions. Select a CWE to view its five variants (Original, Noise, Obfuscated, Noise+Obf, Prompt Injection); the complete projects are available via the GitHub links in the CWE descriptions below.
            </p>

            <div class="demo-selects">
                <div class="select-group">
                    <label for="cweSelect">CWE Type</label>
                    <select id="cweSelect"></select>
                </div>
            </div>

            <div id="cweDescription" class="cwe-description" style="display: none;">
                <h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 1.1rem;">CWE Description</h4>
                <div id="cweDescContent"></div>
            </div>

            <div class="variant-tabs" id="variantTabs"></div>

            <div class="card" style="margin: 20px 0;">
                <h3 style="margin-top:0;">What the five variants mean</h3>
                <ul style="margin-left:20px;">
                    <li><strong>Original:</strong> Raw GitHub projects with paired vulnerable and fixed commits.</li>
                    <li><strong>Noise:</strong> Adds harmless file/DB/DOM statements so we can see whether models overreact to unrelated APIs.</li>
                    <li><strong>Obfuscated:</strong> Runs javascript-obfuscator to rename identifiers and encode literals while keeping semantics.</li>
                    <li><strong>Noise + Obf:</strong> Applies the noise injections first and then obfuscates the entire file for a tougher stress test.</li>
                    <li><strong>Prompt Injection:</strong> Inserts misleading audit comments (for example "Security audit passed") to test textual prompt attacks.</li>
                </ul>
            </div>

            <div class="version-toggle" id="versionToggle"></div>

            <div class="code-panel">
                <pre id="codeSnippet"></pre>
                <div class="code-footer">
                    <button id="toggleCodeBtn" class="expand-collapse-btn">
                        <span id="toggleIcon">▼</span>
                        <span id="toggleText">Show Full Code</span>
                    </button>
                </div>
            </div>
            <p class="dataset-note" id="datasetNote"></p>
        </div>
    </section>

    <section id="case-study">
        <div class="container">
            <h2 class="section-title">C. Motivating Example</h2>
            <div class="case-study">
                <h3>CVE-2021-25941 Case Study (deep-override)</h3>
                <p>
                    Prototype pollution in <code>src/index.js::override()</code> lets attacker-controlled keys overwrite <code>Object.prototype</code>, which can break or hijack Node.js apps that use deep-override while merging configs. The vulnerable release blocks only <code>__proto__</code>; the fixed release blocks <code>['__proto__','constructor','prototype']</code> and keeps the merge logic. Repo: <a href="https://github.com/ASaiAnudeep/deep-override" target="_blank" rel="noreferrer">ASaiAnudeep/deep-override</a>.
                </p>

                <h4>How this case instantiates the three SecJS principles (nine checkpoints)</h4>
                <div class="pill-list">
                    <div class="pill">
                        <strong>Principle 1 · Comprehensiveness</strong>
                        <ul>
                            <li><em>Principle I-1 · CWE coverage:</em> SecJS-Gen pulls CVEs from NVD and Mend.io so the dataset covers older CWEs (SQLi-89, XSS-79, command injection-78, auth bypass-287, hard-coded creds-798) plus newer CWEs (prototype pollution-1321, ReDoS-1333, XXE-611).</li>
                            <li><em>Principle I-2 · Result and reasoning:</em> JudgeJS checks both project-level ⟨has_vulnerability, CWE⟩ pairs and function-level ⟨has_vulnerability, CWE, file, function⟩ pairs, so the model must point to `src/index.js::override()` instead of giving a one-line verdict.</li>
                            <li><em>Principle I-3 · Real GitHub projects:</em> Every sample keeps the full repo (15 files here) plus a frontend/backend/full-stack tag, so the Node.js dependency path (express-session → body-parser → deep-override) stays in context.</li>
                        </ul>
                    </div>
                    <div class="pill">
                        <strong>Principle 2 · Avoid Underestimation</strong>
                        <ul>
                            <li><em>Principle II-1 · CWE equivalence:</em> MITRE CAPEC groups (for example XSS ⇒ CWE-79/80/83, prototype pollution ⇒ CWE-1321/915) mean predictions inside the same group are counted as correct.</li>
                            <li><em>Principle II-2 · Denoised controls:</em> Samples carry ONEFUNC / NVDCHECK / SUSPICIOUS flags so experiments can focus on the high-confidence part (ONEFUNC+NVDCHECK) and skip noisy commits.</li>
                            <li><em>Principle II-3 · Strong prompting:</em> The claude-code-security-review prompt guides the model through three steps: list known safe libraries, compare code with those patterns, then trace the taint path from source to sink.</li>
                        </ul>
                    </div>
                    <div class="pill">
                        <strong>Principle 3 · Avoid Overestimation</strong>
                        <ul>
                            <li><em>Principle III-1 · Full-project inputs:</em> JudgeJS always feeds the entire repo (package files, helpers, tests), so the model has to find the vulnerable `override` function itself.</li>
                            <li><em>Principle III-2 · Vulnerable/fixed pairs:</em> Every CVE provides both versions; for this case the fixed build blocks `['__proto__','constructor','prototype']`, exposing detectors that flag strings instead of reasoning.</li>
                            <li><em>Principle III-3 · Four augmentation tracks:</em> Noise (safe sinks), Obfuscation (renamed identifiers), Noise+Obf, and Prompt Injection (misleading comments) check whether the model still works after simple transformations.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="results-full">
        <div class="container">
            <h2 class="section-title">D. LLM Evaluation Results</h2>
            <p style="text-align:center; color: var(--muted); max-width:960px; margin:0 auto 24px;">
                Complete Precision / Recall / F1 / VD-S scores from the SecJS paper (Table RQ1). "Full" denotes the complete split; "DN" denotes the denoised split. Use the controls below to filter and explore the results.
            </p>

            <div class="evaluation-info" style="display: flex; gap: 32px; margin-bottom: 24px; justify-content: center; flex-wrap: wrap;">
                <div class="info-section">
                    <h4 style="margin: 0 0 12px 0; color: var(--secondary); font-size: 1rem;">Color Legend</h4>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(34, 197, 94, 0.2); border: 2px solid #16a34a; border-radius: 3px;"></div>
                            <span style="font-size: 0.85rem; color: var(--muted);">Excellent (≥35%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(59, 130, 246, 0.2); border: 2px solid #2563eb; border-radius: 3px;"></div>
                            <span style="font-size: 0.85rem; color: var(--muted);">Good (25-35%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(234, 179, 8, 0.2); border: 2px solid #d97706; border-radius: 3px;"></div>
                            <span style="font-size: 0.85rem; color: var(--muted);">Average (15-25%)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(239, 68, 68, 0.2); border: 2px solid #dc2626; border-radius: 3px;"></div>
                            <span style="font-size: 0.85rem; color: var(--muted);">Poor (<15%)</span>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h4 style="margin: 0 0 12px 0; color: var(--secondary); font-size: 1rem;">Dataset Variants</h4>
                    <div style="display: grid; gap: 8px; font-size: 0.85rem; color: var(--muted);">
                        <div><strong>Original:</strong> Raw GitHub projects with paired vulnerable and fixed commits</div>
                        <div><strong>Noise:</strong> Adds harmless file/DB/DOM statements to test model robustness</div>
                        <div><strong>Obfuscated:</strong> Renamed identifiers and encoded literals while keeping semantics</div>
                        <div><strong>Noise+Obf:</strong> Combines noise injection with obfuscation for tougher stress tests</div>
                        <div><strong>Prompt Injection:</strong> Misleading audit comments to test resistance to prompt attacks</div>
                    </div>
                </div>
            </div>

            <!-- Interactive Controls -->
            <div class="interactive-controls" style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 24px; justify-content: center;">
                <!-- Metric Selector -->
                <div class="control-group">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--muted); font-size: 0.9rem;">Select Metric</label>
                    <div class="metric-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="metric-btn active" data-metric="F1">F1 Score</button>
                        <button class="metric-btn" data-metric="Precision">Precision</button>
                        <button class="metric-btn" data-metric="Recall">Recall</button>
                        <button class="metric-btn" data-metric="VD-S">VD-S Score</button>
                    </div>
                </div>

                <!-- Dataset Split Selector -->
                <div class="control-group">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--muted); font-size: 0.9rem;">Dataset Split</label>
                    <div class="split-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="split-btn active" data-split="Full">Full Split</button>
                        <button class="split-btn" data-split="DN">Denoised</button>
                    </div>
                </div>

                <!-- Model Filter -->
                <div class="control-group">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--muted); font-size: 0.9rem;">Filter Models</label>
                    <div class="model-checkboxes" style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <label class="model-checkbox"><input type="checkbox" checked data-model="GPT-5"> GPT-5</label>
                        <label class="model-checkbox"><input type="checkbox" checked data-model="GPT-5-Mini"> GPT-5-Mini</label>
                        <label class="model-checkbox"><input type="checkbox" checked data-model="GPT-5-Codex"> GPT-5-Codex</label>
                        <label class="model-checkbox"><input type="checkbox" checked data-model="DeepSeek-v3.1"> DeepSeek</label>
                        <label class="model-checkbox"><input type="checkbox" checked data-model="Gemini-2.5-Pro"> Gemini-2.5</label>
                        <label class="model-checkbox"><input type="checkbox" checked data-model="Gemini-Flash"> Gemini-Flash</label>
                        <label class="model-checkbox"><input type="checkbox" checked data-model="Claude-4.5"> Claude-4.5</label>
                    </div>
                </div>
            </div>

            <div class="table-scroll" id="resultsTableContainer">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th rowspan="2">LLM</th>
                            <th rowspan="2">Metric</th>
                            <th colspan="2">Original</th>
                            <th colspan="2">Noise</th>
                            <th colspan="2">Obfuscated</th>
                            <th colspan="2">Noise+Obf</th>
                            <th colspan="2">Prompt Injection</th>
                        </tr>
                        <tr>
                            <th>Full</th><th>DN</th>
                            <th>Full</th><th>DN</th>
                            <th>Full</th><th>DN</th>
                            <th>Full</th><th>DN</th>
                            <th>Full</th><th>DN</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td rowspan="4">GPT-5</td><td>Precision</td><td>37.3</td><td>37.8</td><td>20.0</td><td>20.2</td><td>33.3</td><td>33.0</td><td>23.6</td><td>23.6</td><td>32.0</td><td>32.4</td></tr>
                        <tr><td>Recall</td><td>28.1</td><td>27.5</td><td>15.0</td><td>14.7</td><td>17.4</td><td>16.6</td><td>14.3</td><td>13.9</td><td>21.5</td><td>20.8</td></tr>
                        <tr><td>F1</td><td>32.1</td><td>31.8</td><td>17.2</td><td>17.0</td><td>22.9</td><td>22.1</td><td>17.8</td><td>17.5</td><td>25.7</td><td>25.3</td></tr>
                        <tr><td>VD-S</td><td>57.2</td><td>58.1</td><td>61.9</td><td>62.5</td><td>77.2</td><td>77.8</td><td>76.6</td><td>77.2</td><td>78.5</td><td>79.2</td></tr>

                        <tr><td rowspan="4">GPT-5-Mini</td><td>Precision</td><td>34.1</td><td>34.1</td><td>13.8</td><td>13.3</td><td>34.7</td><td>35.7</td><td>12.0</td><td>11.9</td><td>26.9</td><td>26.6</td></tr>
                        <tr><td>Recall</td><td>26.4</td><td>25.7</td><td>12.5</td><td>11.7</td><td>20.2</td><td>20.2</td><td>10.1</td><td>10.0</td><td>24.1</td><td>23.2</td></tr>
                        <tr><td>F1</td><td>29.8</td><td>29.3</td><td>13.1</td><td>12.5</td><td>25.6</td><td>25.8</td><td>10.9</td><td>10.9</td><td>25.4</td><td>24.8</td></tr>
                        <tr><td>VD-S</td><td>73.6</td><td>74.3</td><td>56.2</td><td>57.0</td><td>79.8</td><td>79.8</td><td>59.4</td><td>60.0</td><td>75.9</td><td>76.8</td></tr>

                        <tr><td rowspan="4">GPT-5-Codex</td><td>Precision</td><td>43.0</td><td>43.7</td><td>18.8</td><td>18.0</td><td>43.4</td><td>44.8</td><td>12.4</td><td>11.8</td><td>38.1</td><td>39.2</td></tr>
                        <tr><td>Recall</td><td>29.1</td><td>28.9</td><td>12.8</td><td>12.0</td><td>19.3</td><td>19.3</td><td>8.1</td><td>7.7</td><td>21.2</td><td>20.9</td></tr>
                        <tr><td>F1</td><td>34.7</td><td>34.8</td><td>15.2</td><td>14.4</td><td>26.7</td><td>27.0</td><td>9.8</td><td>9.3</td><td>27.2</td><td>27.2</td></tr>
                        <tr><td>VD-S</td><td>70.9</td><td>71.1</td><td>62.7</td><td>63.5</td><td>80.7</td><td>80.7</td><td>59.0</td><td>59.8</td><td>78.8</td><td>79.1</td></tr>

                        <tr><td rowspan="4">DeepSeek-v3.1</td><td>Precision</td><td>31.0</td><td>30.6</td><td>6.3</td><td>5.9</td><td>32.7</td><td>32.4</td><td>4.7</td><td>4.6</td><td>27.9</td><td>28.2</td></tr>
                        <tr><td>Recall</td><td>22.8</td><td>21.6</td><td>5.4</td><td>5.0</td><td>17.0</td><td>16.9</td><td>3.8</td><td>3.6</td><td>27.2</td><td>27.1</td></tr>
                        <tr><td>F1</td><td>26.3</td><td>25.3</td><td>5.8</td><td>5.4</td><td>22.4</td><td>22.2</td><td>4.2</td><td>4.0</td><td>27.5</td><td>27.7</td></tr>
                        <tr><td>VD-S</td><td>77.0</td><td>78.4</td><td>64.8</td><td>65.5</td><td>83.0</td><td>83.1</td><td>50.0</td><td>50.8</td><td>72.7</td><td>72.9</td></tr>

                        <tr><td rowspan="4">Gemini-2.5-Pro</td><td>Precision</td><td>34.9</td><td>35.2</td><td>19.7</td><td>20.0</td><td>34.1</td><td>34.1</td><td>16.2</td><td>15.6</td><td>33.7</td><td>34.0</td></tr>
                        <tr><td>Recall</td><td>38.4</td><td>38.2</td><td>20.4</td><td>20.3</td><td>32.9</td><td>33.2</td><td>17.8</td><td>17.2</td><td>36.2</td><td>36.0</td></tr>
                        <tr><td>F1</td><td>36.6</td><td>36.6</td><td>20.0</td><td>20.1</td><td>33.5</td><td>33.7</td><td>17.0</td><td>16.4</td><td>34.9</td><td>35.0</td></tr>
                        <tr><td>VD-S</td><td>61.6</td><td>61.8</td><td>51.0</td><td>51.2</td><td>67.1</td><td>66.8</td><td>39.5</td><td>40.3</td><td>63.8</td><td>64.0</td></tr>

                        <tr><td rowspan="4">Gemini-Flash</td><td>Precision</td><td>28.8</td><td>28.7</td><td>16.9</td><td>16.5</td><td>27.2</td><td>27.0</td><td>14.4</td><td>12.8</td><td>28.8</td><td>29.0</td></tr>
                        <tr><td>Recall</td><td>31.4</td><td>31.2</td><td>17.7</td><td>17.4</td><td>25.0</td><td>25.0</td><td>12.0</td><td>10.8</td><td>31.8</td><td>31.5</td></tr>
                        <tr><td>F1</td><td>30.1</td><td>29.9</td><td>17.3</td><td>17.0</td><td>26.1</td><td>25.9</td><td>13.1</td><td>11.7</td><td>30.2</td><td>30.2</td></tr>
                        <tr><td>VD-S</td><td>68.6</td><td>68.8</td><td>54.2</td><td>54.5</td><td>75.0</td><td>75.0</td><td>63.4</td><td>64.7</td><td>68.2</td><td>68.5</td></tr>

                        <tr><td rowspan="4">Claude-4.5</td><td>Precision</td><td>37.2</td><td>37.7</td><td>4.4</td><td>4.2</td><td>17.8</td><td>16.9</td><td>4.0</td><td>3.9</td><td>28.8</td><td>29.1</td></tr>
                        <tr><td>Recall</td><td>34.8</td><td>34.3</td><td>4.0</td><td>3.8</td><td>16.5</td><td>15.5</td><td>3.8</td><td>3.6</td><td>25.5</td><td>24.8</td></tr>
                        <tr><td>F1</td><td>35.9</td><td>35.9</td><td>4.2</td><td>4.0</td><td>17.2</td><td>16.2</td><td>3.9</td><td>3.7</td><td>27.1</td><td>26.8</td></tr>
                        <tr><td>VD-S</td><td>65.2</td><td>65.7</td><td>58.6</td><td>59.0</td><td>83.5</td><td>84.5</td><td>48.7</td><td>49.2</td><td>74.5</td><td>75.2</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>


    <footer>
        SecJS Benchmark · GitHub: <a href="https://github.com/SecJS-Vuln-Benchmark/SecJS-Benchmark" target="_blank">SecJS-Benchmark</a>
    </footer>

    <script>
        (function() {
            const manifestUrl = 'cwe_index.json';
            const cweSelect = document.getElementById('cweSelect');
            const variantTabs = document.getElementById('variantTabs');
            const versionToggle = document.getElementById('versionToggle');
            const codeSnippet = document.getElementById('codeSnippet');
            const datasetNote = document.getElementById('datasetNote');

            const shardCache = new Map();
            const textCache = new Map();
            let manifest = {};
            let activeCWE = '';
            let activeVariant = 'original'; // Will be updated based on available variants
            let activeVersion = 'vuln';
            let variantSamples = {}; // Store samples for each variant: {original: sample, noise: sample, ...}
            let allCweEntries = [];
            let controlsEnabled = true;
            let codeExpanded = false; // Track if code is expanded or collapsed (default: collapsed)

            // Interactive table data and state
            let evaluationData = {};
            let currentMetric = 'F1';
            let currentSplit = 'Full';
            let selectedModels = ['GPT-5', 'GPT-5-Mini', 'GPT-5-Codex', 'DeepSeek-v3.1', 'Gemini-2.5-Pro', 'Gemini-Flash', 'Claude-4.5'];

            const variantLabels = {
                original: 'Original',
                noise: 'Noise',
                obfuscated: 'Obfuscated',
                noise_obfuscated: 'Noise+Obf',
                prompt_injection: 'Prompt Injection'
            };

            const versionLabels = {
                vuln: 'Vulnerable build',
                fixed: 'Fixed build',
            };

            function normalizePath(path) {
                if (!path) return null;
                return path.startsWith('docs/') ? path.slice(5) : path;
            }

            function setNote(message, isError = false) {
                if (!datasetNote) {
                    console.warn('Dataset note element not found');
                    return;
                }

                if (!isError || !message) {
                    datasetNote.textContent = '';
                    datasetNote.classList.remove('is-visible');
                    return;
                }
                datasetNote.textContent = message;
                datasetNote.classList.add('is-visible');
            }

            function reportError(prefix, detail) {
                const msg = detail && detail.message ? detail.message : detail;
                setNote(`${prefix}: ${msg}`, true);
                console.error(prefix, detail);
            }

            window.addEventListener('error', event => {
                reportError('Script error', event.error || event.message);
            });

            window.addEventListener('unhandledrejection', event => {
                reportError('Data fetch failed', event.reason);
            });

            function toggleCodeExpansion() {
                const codePanel = document.querySelector('.code-panel');
                const toggleBtn = document.getElementById('toggleCodeBtn');
                const toggleIcon = document.getElementById('toggleIcon');
                const toggleText = document.getElementById('toggleText');

                if (!codePanel || !toggleBtn) return;

                codeExpanded = !codeExpanded;

                if (codeExpanded) {
                    codePanel.classList.add('expanded');
                    toggleIcon.textContent = '▲';
                    toggleText.textContent = 'Collapse Code';
                } else {
                    codePanel.classList.remove('expanded');
                    toggleIcon.textContent = '▼';
                    toggleText.textContent = 'Show Full Code';
                }
            }

            function disableControls(disabled) {
                controlsEnabled = !disabled;
                if (cweSelect) cweSelect.disabled = disabled;
                if (variantTabs) {
                    Array.from(variantTabs.querySelectorAll('button')).forEach(btn => {
                        btn.style.opacity = disabled ? '0.5' : '1';
                        btn.style.cursor = disabled ? 'not-allowed' : 'pointer';
                    });
                }
                if (versionToggle) {
                    Array.from(versionToggle.querySelectorAll('button')).forEach(btn => {
                        btn.disabled = disabled;
                        btn.style.opacity = disabled ? '0.5' : '1';
                        btn.style.cursor = disabled ? 'not-allowed' : 'pointer';
                    });
                }
            }

            // Interactive table functions
            function initializeEvaluationData() {
                // Hard-coded evaluation data for better reliability
                evaluationData = {
                    'GPT-5': {
                        'Precision': {
                            'Full': { 'Original': '37.3', 'Noise': '20.0', 'Obfuscated': '33.3', 'Noise+Obf': '23.6', 'Prompt Injection': '32.0' },
                            'DN': { 'Original': '37.8', 'Noise': '20.2', 'Obfuscated': '33.0', 'Noise+Obf': '23.6', 'Prompt Injection': '32.4' }
                        },
                        'Recall': {
                            'Full': { 'Original': '28.1', 'Noise': '15.0', 'Obfuscated': '17.4', 'Noise+Obf': '14.3', 'Prompt Injection': '21.5' },
                            'DN': { 'Original': '27.5', 'Noise': '14.7', 'Obfuscated': '16.6', 'Noise+Obf': '13.9', 'Prompt Injection': '20.8' }
                        },
                        'F1': {
                            'Full': { 'Original': '32.1', 'Noise': '17.2', 'Obfuscated': '22.9', 'Noise+Obf': '17.8', 'Prompt Injection': '25.7' },
                            'DN': { 'Original': '31.8', 'Noise': '17.0', 'Obfuscated': '22.1', 'Noise+Obf': '17.5', 'Prompt Injection': '25.3' }
                        },
                        'VD-S': {
                            'Full': { 'Original': '57.2', 'Noise': '61.9', 'Obfuscated': '77.2', 'Noise+Obf': '76.6', 'Prompt Injection': '78.5' },
                            'DN': { 'Original': '58.1', 'Noise': '62.5', 'Obfuscated': '77.8', 'Noise+Obf': '77.2', 'Prompt Injection': '79.2' }
                        }
                    },
                    'GPT-5-Mini': {
                        'Precision': {
                            'Full': { 'Original': '34.1', 'Noise': '13.8', 'Obfuscated': '34.7', 'Noise+Obf': '12.0', 'Prompt Injection': '26.9' },
                            'DN': { 'Original': '34.1', 'Noise': '13.3', 'Obfuscated': '35.7', 'Noise+Obf': '11.9', 'Prompt Injection': '26.6' }
                        },
                        'Recall': {
                            'Full': { 'Original': '26.4', 'Noise': '12.5', 'Obfuscated': '20.2', 'Noise+Obf': '10.1', 'Prompt Injection': '24.1' },
                            'DN': { 'Original': '25.7', 'Noise': '11.7', 'Obfuscated': '20.2', 'Noise+Obf': '10.0', 'Prompt Injection': '23.2' }
                        },
                        'F1': {
                            'Full': { 'Original': '29.8', 'Noise': '13.1', 'Obfuscated': '25.6', 'Noise+Obf': '10.9', 'Prompt Injection': '25.4' },
                            'DN': { 'Original': '29.3', 'Noise': '12.5', 'Obfuscated': '25.8', 'Noise+Obf': '10.9', 'Prompt Injection': '24.8' }
                        },
                        'VD-S': {
                            'Full': { 'Original': '73.6', 'Noise': '56.2', 'Obfuscated': '79.8', 'Noise+Obf': '59.4', 'Prompt Injection': '75.9' },
                            'DN': { 'Original': '74.3', 'Noise': '57.0', 'Obfuscated': '79.8', 'Noise+Obf': '60.0', 'Prompt Injection': '76.8' }
                        }
                    },
                    'GPT-5-Codex': {
                        'Precision': {
                            'Full': { 'Original': '43.0', 'Noise': '18.8', 'Obfuscated': '43.4', 'Noise+Obf': '12.4', 'Prompt Injection': '38.1' },
                            'DN': { 'Original': '43.7', 'Noise': '18.0', 'Obfuscated': '44.8', 'Noise+Obf': '11.8', 'Prompt Injection': '39.2' }
                        },
                        'Recall': {
                            'Full': { 'Original': '29.1', 'Noise': '12.8', 'Obfuscated': '19.3', 'Noise+Obf': '8.1', 'Prompt Injection': '21.2' },
                            'DN': { 'Original': '28.9', 'Noise': '12.0', 'Obfuscated': '19.3', 'Noise+Obf': '7.7', 'Prompt Injection': '20.9' }
                        },
                        'F1': {
                            'Full': { 'Original': '34.7', 'Noise': '15.2', 'Obfuscated': '26.7', 'Noise+Obf': '9.8', 'Prompt Injection': '27.2' },
                            'DN': { 'Original': '34.8', 'Noise': '14.4', 'Obfuscated': '27.0', 'Noise+Obf': '9.3', 'Prompt Injection': '27.2' }
                        },
                        'VD-S': {
                            'Full': { 'Original': '70.9', 'Noise': '62.7', 'Obfuscated': '80.7', 'Noise+Obf': '59.0', 'Prompt Injection': '78.8' },
                            'DN': { 'Original': '71.1', 'Noise': '63.5', 'Obfuscated': '80.7', 'Noise+Obf': '59.8', 'Prompt Injection': '79.1' }
                        }
                    },
                    'DeepSeek-v3.1': {
                        'Precision': {
                            'Full': { 'Original': '31.0', 'Noise': '6.3', 'Obfuscated': '32.7', 'Noise+Obf': '4.7', 'Prompt Injection': '27.9' },
                            'DN': { 'Original': '30.6', 'Noise': '5.9', 'Obfuscated': '32.4', 'Noise+Obf': '4.6', 'Prompt Injection': '28.2' }
                        },
                        'Recall': {
                            'Full': { 'Original': '22.8', 'Noise': '5.4', 'Obfuscated': '17.0', 'Noise+Obf': '3.8', 'Prompt Injection': '27.2' },
                            'DN': { 'Original': '21.6', 'Noise': '5.0', 'Obfuscated': '16.9', 'Noise+Obf': '3.6', 'Prompt Injection': '27.1' }
                        },
                        'F1': {
                            'Full': { 'Original': '26.3', 'Noise': '5.8', 'Obfuscated': '22.4', 'Noise+Obf': '4.2', 'Prompt Injection': '27.5' },
                            'DN': { 'Original': '25.3', 'Noise': '5.4', 'Obfuscated': '22.2', 'Noise+Obf': '4.0', 'Prompt Injection': '27.7' }
                        },
                        'VD-S': {
                            'Full': { 'Original': '77.0', 'Noise': '64.8', 'Obfuscated': '83.0', 'Noise+Obf': '50.0', 'Prompt Injection': '72.7' },
                            'DN': { 'Original': '78.4', 'Noise': '65.5', 'Obfuscated': '83.1', 'Noise+Obf': '50.8', 'Prompt Injection': '72.9' }
                        }
                    },
                    'Gemini-2.5-Pro': {
                        'Precision': {
                            'Full': { 'Original': '34.9', 'Noise': '19.7', 'Obfuscated': '34.1', 'Noise+Obf': '16.2', 'Prompt Injection': '33.7' },
                            'DN': { 'Original': '35.2', 'Noise': '20.0', 'Obfuscated': '34.1', 'Noise+Obf': '15.6', 'Prompt Injection': '34.0' }
                        },
                        'Recall': {
                            'Full': { 'Original': '38.4', 'Noise': '20.4', 'Obfuscated': '32.9', 'Noise+Obf': '17.8', 'Prompt Injection': '36.2' },
                            'DN': { 'Original': '38.2', 'Noise': '20.3', 'Obfuscated': '33.2', 'Noise+Obf': '17.2', 'Prompt Injection': '36.0' }
                        },
                        'F1': {
                            'Full': { 'Original': '36.6', 'Noise': '20.0', 'Obfuscated': '33.5', 'Noise+Obf': '17.0', 'Prompt Injection': '34.9' },
                            'DN': { 'Original': '36.6', 'Noise': '20.1', 'Obfuscated': '33.7', 'Noise+Obf': '16.4', 'Prompt Injection': '35.0' }
                        },
                        'VD-S': {
                            'Full': { 'Original': '61.6', 'Noise': '51.0', 'Obfuscated': '67.1', 'Noise+Obf': '39.5', 'Prompt Injection': '63.8' },
                            'DN': { 'Original': '61.8', 'Noise': '51.2', 'Obfuscated': '66.8', 'Noise+Obf': '40.3', 'Prompt Injection': '64.0' }
                        }
                    },
                    'Gemini-Flash': {
                        'Precision': {
                            'Full': { 'Original': '28.8', 'Noise': '16.9', 'Obfuscated': '27.2', 'Noise+Obf': '14.4', 'Prompt Injection': '28.8' },
                            'DN': { 'Original': '28.7', 'Noise': '16.5', 'Obfuscated': '27.0', 'Noise+Obf': '12.8', 'Prompt Injection': '29.0' }
                        },
                        'Recall': {
                            'Full': { 'Original': '31.4', 'Noise': '17.7', 'Obfuscated': '25.0', 'Noise+Obf': '12.0', 'Prompt Injection': '31.8' },
                            'DN': { 'Original': '31.2', 'Noise': '17.4', 'Obfuscated': '25.0', 'Noise+Obf': '10.8', 'Prompt Injection': '31.5' }
                        },
                        'F1': {
                            'Full': { 'Original': '30.1', 'Noise': '17.3', 'Obfuscated': '26.1', 'Noise+Obf': '13.1', 'Prompt Injection': '30.2' },
                            'DN': { 'Original': '29.9', 'Noise': '17.0', 'Obfuscated': '25.9', 'Noise+Obf': '11.7', 'Prompt Injection': '30.2' }
                        },
                        'VD-S': {
                            'Full': { 'Original': '68.6', 'Noise': '54.2', 'Obfuscated': '75.0', 'Noise+Obf': '63.4', 'Prompt Injection': '68.2' },
                            'DN': { 'Original': '68.8', 'Noise': '54.5', 'Obfuscated': '75.0', 'Noise+Obf': '64.7', 'Prompt Injection': '68.5' }
                        }
                    },
                    'Claude-4.5': {
                        'Precision': {
                            'Full': { 'Original': '37.2', 'Noise': '4.4', 'Obfuscated': '17.8', 'Noise+Obf': '4.0', 'Prompt Injection': '28.8' },
                            'DN': { 'Original': '37.7', 'Noise': '4.2', 'Obfuscated': '16.9', 'Noise+Obf': '3.9', 'Prompt Injection': '29.1' }
                        },
                        'Recall': {
                            'Full': { 'Original': '34.8', 'Noise': '4.0', 'Obfuscated': '16.5', 'Noise+Obf': '3.8', 'Prompt Injection': '25.5' },
                            'DN': { 'Original': '34.3', 'Noise': '3.8', 'Obfuscated': '15.5', 'Noise+Obf': '3.6', 'Prompt Injection': '24.8' }
                        },
                        'F1': {
                            'Full': { 'Original': '35.9', 'Noise': '4.2', 'Obfuscated': '17.2', 'Noise+Obf': '3.9', 'Prompt Injection': '27.1' },
                            'DN': { 'Original': '35.9', 'Noise': '4.0', 'Obfuscated': '16.2', 'Noise+Obf': '3.7', 'Prompt Injection': '26.8' }
                        },
                        'VD-S': {
                            'Full': { 'Original': '65.2', 'Noise': '58.6', 'Obfuscated': '83.5', 'Noise+Obf': '48.7', 'Prompt Injection': '74.5' },
                            'DN': { 'Original': '65.7', 'Noise': '59.0', 'Obfuscated': '84.5', 'Noise+Obf': '49.2', 'Prompt Injection': '75.2' }
                        }
                    }
                };
            }

            function updateInteractiveTable() {
                const container = document.getElementById('resultsTableContainer');
                if (!container) {
                    console.warn('Results table container not found');
                    return;
                }

                if (!Object.keys(evaluationData).length) {
                    console.warn('No evaluation data available');
                    container.innerHTML = '<p>Loading evaluation data...</p>';
                    return;
                }

                let html = '<table class="results-table"><thead><tr><th>Model</th>';
                const variants = ['Original', 'Noise', 'Obfuscated', 'Noise+Obf', 'Prompt Injection'];

                variants.forEach(variant => {
                    html += `<th>${variant}</th>`;
                });
                html += '</tr></thead><tbody>';

                selectedModels.forEach(model => {
                    if (!evaluationData[model]) {
                        console.warn(`Model ${model} not found in evaluation data`);
                        return;
                    }

                    html += `<tr><td>${model}</td>`;
                    variants.forEach(variant => {
                        const value = evaluationData[model][currentMetric]?.[currentSplit]?.[variant];
                        if (!value) {
                            console.warn(`Missing data for ${model} ${currentMetric} ${currentSplit} ${variant}`);
                            html += '<td>N/A</td>';
                            return;
                        }

                        const score = parseFloat(value);
                        let colorClass = '';

                        // Color coding based on performance
                        if (currentMetric === 'VD-S') {
                            // For VD-S, lower is better (green for low, red for high)
                            if (score < 60) colorClass = 'score-excellent';
                            else if (score < 70) colorClass = 'score-good';
                            else if (score < 80) colorClass = 'score-average';
                            else colorClass = 'score-poor';
                        } else {
                            // For other metrics, higher is better
                            if (score > 35) colorClass = 'score-excellent';
                            else if (score > 25) colorClass = 'score-good';
                            else if (score > 15) colorClass = 'score-average';
                            else colorClass = 'score-poor';
                        }

                        html += `<td class="${colorClass}">${value}</td>`;
                    });
                    html += '</tr>';
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function setupInteractiveControls() {
                // Check if controls exist before setting up
                const metricBtns = document.querySelectorAll('.metric-btn');
                const splitBtns = document.querySelectorAll('.split-btn');
                const modelCheckboxes = document.querySelectorAll('.model-checkbox input');

                if (metricBtns.length === 0 || splitBtns.length === 0 || modelCheckboxes.length === 0) {
                    console.warn('Interactive controls not found, skipping setup');
                    return;
                }

                // Metric buttons
                metricBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.metric-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        currentMetric = e.target.dataset.metric;
                        updateInteractiveTable();
                    });
                });

                // Split buttons
                splitBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.split-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        currentSplit = e.target.dataset.split;
                        updateInteractiveTable();
                    });
                });

                // Model checkboxes
                modelCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const model = e.target.dataset.model;
                        if (e.target.checked) {
                            if (!selectedModels.includes(model)) {
                                selectedModels.push(model);
                            }
                        } else {
                            selectedModels = selectedModels.filter(m => m !== model);
                        }
                        updateInteractiveTable();
                    });
                });
            }

            async function fetchJSON(url) {
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`Failed to load ${url}`);
                }
                return res.json();
            }

            async function fetchText(url) {
                if (textCache.has(url)) {
                    return textCache.get(url);
                }
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`Unable to fetch source: ${url}`);
                }
                const txt = await res.text();
                textCache.set(url, txt);
                return txt;
            }

            function renderVersionButtons() {
                if (!versionToggle) return;
                versionToggle.innerHTML = '';
                ['vuln', 'fixed'].forEach(version => {
                    const btn = document.createElement('button');
                    btn.textContent = versionLabels[version];
                    btn.classList.toggle('active', version === activeVersion);
                    btn.addEventListener('click', () => {
                        activeVersion = version;
                        renderVersionButtons();
                        updateCodeBlock();
                    });
                    versionToggle.appendChild(btn);
                });
            }

            function extractFileNames(fileEntry) {
                if (!fileEntry) {
                    return { vulnFull: '', fixedFull: '', vulnName: '', fixedName: '' };
                }
                const vulnFull = fileEntry.original_vulnerable || fileEntry.vulnerable_path || '';
                const fixedFull = fileEntry.original_fixed || fileEntry.fixed_path || '';
                const vulnName = vulnFull ? vulnFull.split('/').pop() : '';
                const fixedName = fixedFull ? fixedFull.split('/').pop() : '';
                return { vulnFull, fixedFull, vulnName, fixedName };
            }

            function populateCWESelect() {
                if (!cweSelect) return;
                const entries = Object.keys(manifest).sort((a, b) =>
                    a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
                );
                cweSelect.innerHTML = '';
                entries.forEach(cwe => {
                    const option = document.createElement('option');
                    option.value = cwe;
                    option.textContent = cwe;
                    cweSelect.appendChild(option);
                });
                if (entries.length) {
                    activeCWE = entries[0];
                    cweSelect.value = activeCWE;
                }
            }

            function loadVariantSamples(entries) {
                variantSamples = {};
                if (!entries || !entries.length) return;

                // Group entries by dataset
                const entriesByDataset = {};
                entries.forEach(entry => {
                    const ds = (entry.dataset || '').toLowerCase().trim();
                    if (!entriesByDataset[ds]) {
                        entriesByDataset[ds] = [];
                    }
                    entriesByDataset[ds].push(entry);
                });

                // For each dataset, select the best entry
                Object.keys(entriesByDataset).forEach(ds => {
                    const datasetEntries = entriesByDataset[ds];
                    if (datasetEntries.length > 0) {
                        let entry = datasetEntries[0]; // Default: take first entry

                        // Special handling for CWE-15: prefer instantsoft/icms2 over gitpod-io/gitpod
                        if (entries.some(e => e.project === 'instantsoft/icms2')) {
                            const instantsoftEntry = datasetEntries.find(e => e.project === 'instantsoft/icms2');
                            if (instantsoftEntry) {
                                entry = instantsoftEntry;
                            }
                        }

                        // Create a modified entry that uses the first file (index 0)
                        // This ensures we show the same source file (_http_server) in different variants
                        const modifiedEntry = { ...entry };
                        if (modifiedEntry.files && modifiedEntry.files.length > 0) {
                            modifiedEntry.files = [modifiedEntry.files[0]]; // Always use first file
                        }

                        // Map to our variant keys
                        if (ds === 'final' || ds === 'original') {
                            variantSamples.original = modifiedEntry;
                        } else if (ds === 'noise') {
                            variantSamples.noise = modifiedEntry;
                        } else if (ds === 'obfuscated') {
                            variantSamples.obfuscated = modifiedEntry;
                        } else if (ds === 'noise_obfuscated') {
                            variantSamples.noise_obfuscated = modifiedEntry;
                        } else if (ds === 'prompt_injection') {
                            variantSamples.prompt_injection = modifiedEntry;
                        }
                    }
                });
            }

            function displayCWEInfo(entries) {
                const cweDescription = document.getElementById('cweDescription');
                const cweDescContent = document.getElementById('cweDescContent');

                if (!cweDescription || !cweDescContent || !entries || !entries.length) {
                    if (cweDescription) cweDescription.style.display = 'none';
                    return;
                }

                // Get information from the first entry (they should have consistent metadata)
                const entry = entries[0];
                const project = entry.project || '';
                const cveIds = entry.cve_ids || '';
                const summary = entry.summary || '';
                const publishDate = entry.publish_date || '';
                const severity = entry.severity || '';
                const projectType = entry.project_type || '';

                // Generate GitHub repository link
                let repoLink = '';
                if (project) {
                    const projectParts = project.split('/');
                    if (projectParts.length === 2) {
                        const [org, repo] = projectParts;
                        repoLink = `https://github.com/${org}/${repo}`;
                    }
                }

                // Build description HTML
                let html = '';

                // CVE Information
                if (cveIds) {
                    html += `<p><strong>CVE IDs:</strong> ${cveIds}</p>`;
                }

                // Project Information
                if (project) {
                    html += `<p><strong>Project:</strong> ${project}`;
                    if (projectType) {
                        html += ` (${projectType})`;
                    }
                    html += '</p>';
                }

                // Repository Link
                if (repoLink) {
                    html += `<p><strong>Repository:</strong> <a href="${repoLink}" target="_blank" rel="noopener noreferrer">${repoLink}</a></p>`;
                }

                // Publish Date and Severity
                if (publishDate || severity) {
                    html += '<p><strong>Details:</strong> ';
                    if (publishDate) html += `Published: ${publishDate}`;
                    if (publishDate && severity) html += ' | ';
                    if (severity) html += `Severity: ${severity}`;
                    html += '</p>';
                }

                // Summary
                if (summary) {
                    html += `<p><strong>Description:</strong> ${summary}</p>`;
                }

                cweDescContent.innerHTML = html;
                cweDescription.style.display = 'block';
            }

            async function switchVariant(variant) {
                console.log('🔄 switchVariant called with:', variant);
                console.log('📊 Available variantSamples:', Object.keys(variantSamples));
                console.log('🎯 Current activeVariant:', activeVariant);

                if (!controlsEnabled || !variant || !variantSamples[variant]) {
                    console.log('❌ switchVariant blocked:', {controlsEnabled, variant, hasSample: !!variantSamples[variant]});
                    return;
                }

                activeVariant = variant;
                console.log('✅ Set activeVariant to:', activeVariant);
                updateVariantTabStates();
                await updateCodeBlock();
                console.log('🎉 switchVariant completed');
            }

            function updateVariantTabStates() {
                if (!variantTabs) return;
                const buttons = variantTabs.querySelectorAll('button');
                buttons.forEach(btn => {
                    const variant = Object.keys(variantLabels).find(v => variantLabels[v] === btn.textContent);
                    if (variant) {
                        const hasData = variantSamples[variant];
                        btn.className = (variant === activeVariant && hasData) ? 'active' : '';
                        btn.disabled = !hasData;
                        btn.style.opacity = hasData ? '1' : '0.3';
                        btn.style.cursor = hasData ? 'pointer' : 'not-allowed';
                    }
                });
            }

            function renderVariantTabs() {
                if (!variantTabs) return;
                variantTabs.innerHTML = '';
                Object.keys(variantLabels).forEach(variant => {
                    const btn = document.createElement('button');
                    btn.textContent = variantLabels[variant];
                    const hasData = variantSamples[variant];
                    btn.className = (variant === activeVariant && hasData) ? 'active' : '';
                    btn.disabled = !hasData;
                    btn.style.opacity = hasData ? '1' : '0.3';
                    btn.style.cursor = hasData ? 'pointer' : 'not-allowed';
                    if (hasData) {
                        btn.onclick = () => switchVariant(variant);
                    }
                    variantTabs.appendChild(btn);
                });
            }

            async function updateCodeBlockWithSample(sample) {
                if (!codeSnippet) return;
                const files = sample.files || [];
                if (!files.length) {
                    codeSnippet.textContent = 'This sample does not include any files.';
                    setNote('No files listed for this sample. Regenerate the index.', true);
                    return;
                }
                const fileEntry = files[0];
                const targetPathRaw = activeVersion === 'vuln' ? fileEntry.vulnerable_path : fileEntry.fixed_path;
                if (!targetPathRaw) {
                    codeSnippet.textContent = 'No file is available for this version.';
                    return;
                }
                const targetPath = normalizePath(targetPathRaw);
                try {
                    codeSnippet.textContent = 'Loading code…';
                    const code = await fetchText(targetPath);
                    codeSnippet.textContent = code;
                    setNote('', false);
                } catch (err) {
                    codeSnippet.textContent = err.message;
                    setNote('Unable to load code. Run scripts/build_cwe_index.py before publishing.', true);
                }
            }

            async function updateCodeBlock() {
                console.log('📝 updateCodeBlock called for activeVariant:', activeVariant);
                const sample = variantSamples[activeVariant];
                console.log('📄 Sample found:', !!sample);
                if (sample) {
                    console.log('📄 Sample details:', {dataset: sample.dataset, filesCount: sample.files?.length});
                    await updateCodeBlockWithSample(sample);
                } else {
                    console.log('❌ No sample found for variant:', activeVariant);
                    if (codeSnippet) codeSnippet.textContent = '';
                    setNote('', false);
                }
            }

            async function handleCWEChange() {
                if (!cweSelect) return;
                activeCWE = cweSelect.value;
                if (!activeCWE) {
                    // Hide CWE description when no CWE is selected
                    const cweDescription = document.getElementById('cweDescription');
                    if (cweDescription) cweDescription.style.display = 'none';
                    return;
                }
                const meta = manifest[activeCWE];
                if (!meta) return;
                try {
                    disableControls(true);
                    if (!shardCache.has(activeCWE)) {
                        const shardPath = normalizePath(meta.file);
                        const data = await fetchJSON(shardPath);
                        allCweEntries = Array.isArray(data) ? data : [];
                        shardCache.set(activeCWE, allCweEntries);
                    } else {
                        allCweEntries = shardCache.get(activeCWE) || [];
                    }
                    if (!allCweEntries.length) {
                        if (codeSnippet) codeSnippet.textContent = '';
                        setNote(`No sample available for ${activeCWE}.`, true);
                        variantSamples = {};
                        renderVariantTabs(); // Clear buttons
                    } else {
                        loadVariantSamples(allCweEntries);
                        // Display CWE description
                        displayCWEInfo(allCweEntries);
                        // If current variant is not available, switch to first available
                        if (!variantSamples[activeVariant]) {
                            const firstAvailable = Object.keys(variantSamples)[0];
                            if (firstAvailable) {
                                activeVariant = firstAvailable;
                            }
                        }
                        renderVariantTabs(); // Re-render buttons with correct data
                        await updateCodeBlock();
                    }
                } catch (err) {
                    setNote('Unable to load the CWE shard. Run scripts/build_cwe_index.py before publishing.', true);
                    if (codeSnippet) codeSnippet.textContent = err.message;
                    variantSamples = {};
                } finally {
                    disableControls(false);
                }
            }

            if (cweSelect) {
                cweSelect.addEventListener('change', () => {
                    handleCWEChange();
                });
            }

            async function init() {
                if (!cweSelect || !variantTabs || !versionToggle || !codeSnippet || !datasetNote) {
                    console.error('Required DOM elements not found');
                    return;
                }

                // Add event listener for code toggle button
                const toggleCodeBtn = document.getElementById('toggleCodeBtn');
                if (toggleCodeBtn) {
                    toggleCodeBtn.addEventListener('click', toggleCodeExpansion);
                }

                renderVersionButtons();
                // Hide CWE description initially
                const cweDescription = document.getElementById('cweDescription');
                if (cweDescription) cweDescription.style.display = 'none';

                // Initialize interactive evaluation table
                initializeEvaluationData();
                updateInteractiveTable();

                disableControls(true);
                try {
                    manifest = await fetchJSON(manifestUrl);
                    if (!Object.keys(manifest).length) {
                        throw new Error('cwe_index.json is empty.');
                    }
                    populateCWESelect();
                    await handleCWEChange();
                    // renderVariantTabs() is already called in handleCWEChange()
                } catch (err) {
                    setNote('Missing cwe_index.json. Run scripts/build_cwe_index.py before publishing.', true);
                    if (codeSnippet) codeSnippet.textContent = err.message;
                } finally {
                    disableControls(false);
                }

                // Set up interactive controls after a short delay to ensure DOM is fully loaded
                setTimeout(() => {
                    setupInteractiveControls();
                }, 100);
            }

            function initializePage() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', init);
                } else {
                    init();
                }
            }

            initializePage();
        })();
    </script>
</body>
</html>
