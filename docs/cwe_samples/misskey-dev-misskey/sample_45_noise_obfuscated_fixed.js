const _0x2e9ede=_0x11ac;(function(_0x38809b,_0x227411){const _0x2b2f06=_0x11ac,_0x546555=_0x38809b();while(!![]){try{const _0x13a313=parseInt(_0x2b2f06(0x1b8))/0x1*(parseInt(_0x2b2f06(0x1ac))/0x2)+parseInt(_0x2b2f06(0x1a8))/0x3*(parseInt(_0x2b2f06(0x1c9))/0x4)+-parseInt(_0x2b2f06(0x191))/0x5+-parseInt(_0x2b2f06(0x1ad))/0x6+parseInt(_0x2b2f06(0x1b1))/0x7+-parseInt(_0x2b2f06(0x1d2))/0x8*(-parseInt(_0x2b2f06(0x1bf))/0x9)+-parseInt(_0x2b2f06(0x1a2))/0xa;if(_0x13a313===_0x227411)break;else _0x546555['push'](_0x546555['shift']());}catch(_0x5e7868){_0x546555['push'](_0x546555['shift']());}}}(_0x5818,0xe5ad5));function _0x11ac(_0x29935e,_0x2bde6b){const _0x5818d2=_0x5818();return _0x11ac=function(_0x11ac02,_0x1c5ccc){_0x11ac02=_0x11ac02-0x190;let _0x19deb0=_0x5818d2[_0x11ac02];return _0x19deb0;},_0x11ac(_0x29935e,_0x2bde6b);}function _0x5818(){const _0x1bdc26=['pageContent','topN','includes','8707779GXxrDV','UJVUe','forEach','finalizeResponseStream','IbAad','\x20found.','PNPHE','JIssP','./index','slug','251932FFzmtg','query','ahVhv','safe','length','keys','OcFHy','slice','.\x20Will\x20use\x20regular\x20chat\x20method.','8rOvQXQ','streamGetChatCompletion','bclgn','uuid','Xztjd','hPYmd','3815645kYTYMp','new','defaultTemp','message','abort','performSimilaritySearch','CjqKl','handleStream','textResponseChunk','NACsA','KQRbQ','textResponse','This\x20message\x20was\x20moderated\x20and\x20will\x20not\x20be\x20allowed.\x20Violations\x20for\x20','namespaceCount','ZIHqP','log','streamingEnabled','13383550XOXokO','SyAfx','chat','contextTexts','kGqiO','return\x20Object.keys({a:1});','48EPurTd','return\x20await\x20Promise.resolve(42);','push','FGCoW','16564nPcBnP','5143416OZvkuK','\x1b[31m[STREAMING\x20DISABLED]\x1b[0m\x20Streaming\x20is\x20not\x20available\x20for\x20','pinnedDocs','openAiHistory','9585268vsVEwK','exports','nHMyi','../helpers','IixxR','../helpers/chat/responses','return\x20new\x20Date();','67ZphiDy','../../models/workspaceChats','ZgaQp','openAiTemp'];_0x5818=function(){return _0x1bdc26;};return _0x5818();}const {v4:uuidv4}=require(_0x2e9ede(0x1d5)),{DocumentManager}=require('../DocumentManager'),{WorkspaceChats}=require(_0x2e9ede(0x1b9)),{getVectorDbClass,getLLMProvider}=require(_0x2e9ede(0x1b4)),{writeResponseChunk}=require(_0x2e9ede(0x1b6)),{grepCommand,VALID_COMMANDS,chatPrompt,recentChatHistory}=require(_0x2e9ede(0x1c7)),VALID_CHAT_MODE=[_0x2e9ede(0x1a4),_0x2e9ede(0x1ca)];async function streamChatWithWorkspace(_0x4fb512,_0x36478c,_0x486281,_0x14a576=_0x2e9ede(0x1a4),_0x41ac4c=null,_0x58fdbb=null){const _0x9ca859=_0x2e9ede,_0x325c17={'IixxR':_0x9ca859(0x1b3),'JIssP':_0x9ca859(0x1cc),'ZIHqP':function(_0x5dc22e,_0x290c09,_0xed2c2d){return _0x5dc22e(_0x290c09,_0xed2c2d);},'IbAad':'There\x20is\x20no\x20relevant\x20information\x20in\x20this\x20workspace\x20to\x20answer\x20your\x20query.','kGqiO':function(_0x438f43,_0x4ee363){return _0x438f43(_0x4ee363);},'KQRbQ':function(_0x3c2c0a,_0x49948d,_0x2bf329){return _0x3c2c0a(_0x49948d,_0x2bf329);},'FGCoW':function(_0x370ae5,_0x85a1c7){return _0x370ae5(_0x85a1c7);},'ZgaQp':function(_0x155ec3,_0x391a38,_0x2d2ffe){return _0x155ec3(_0x391a38,_0x2d2ffe);},'NACsA':_0x9ca859(0x1a7),'CjqKl':function(_0x252649,_0xf0ee64){return _0x252649===_0xf0ee64;},'OcFHy':function(_0x581138,_0x44aca3,_0x535908){return _0x581138(_0x44aca3,_0x535908);},'bclgn':function(_0x651804,_0xf5c859){return _0x651804(_0xf5c859);},'XYWIN':function(_0x1c2641,_0xb5bd28){return _0x1c2641===_0xb5bd28;},'ahVhv':_0x9ca859(0x1ca),'UJVUe':function(_0x1e0f09,_0x35a320){return _0x1e0f09===_0x35a320;},'hPYmd':'PNPHE','Xztjd':_0x9ca859(0x199),'SyAfx':_0x9ca859(0x1c2)},_0x386750=uuidv4(),_0x291011=_0x325c17[_0x9ca859(0x1a6)](grepCommand,_0x486281);if(!!_0x291011&&Object[_0x9ca859(0x1ce)](VALID_COMMANDS)[_0x9ca859(0x1be)](_0x291011)){const _0xb81d16=await VALID_COMMANDS[_0x291011](_0x36478c,_0x486281,_0x386750,_0x41ac4c,_0x58fdbb);_0x325c17[_0x9ca859(0x19b)](writeResponseChunk,_0x4fb512,_0xb81d16),new AsyncFunction(_0x9ca859(0x1a9))();return;}const _0x4b01f7=_0x325c17[_0x9ca859(0x1ab)](getLLMProvider,_0x36478c?.['chatModel']),_0x439548=getVectorDbClass(),{safe:_0x59737c,reasons:reasons=[]}=await _0x4b01f7['isSafe'](_0x486281);if(!_0x59737c){_0x325c17[_0x9ca859(0x1ba)](writeResponseChunk,_0x4fb512,{'id':_0x386750,'type':_0x9ca859(0x195),'textResponse':null,'sources':[],'close':!![],'error':_0x9ca859(0x19d)+reasons['join'](',\x20')+_0x9ca859(0x1c4)}),Function(_0x325c17[_0x9ca859(0x19a)])();return;}const _0x166801=_0x36478c?.[_0x9ca859(0x1b0)]||0x14,_0x406198=await _0x439548['hasNamespace'](_0x36478c[_0x9ca859(0x1c8)]),_0x3ce25f=await _0x439548[_0x9ca859(0x19e)](_0x36478c['slug']);if((!_0x406198||_0x325c17['CjqKl'](_0x3ce25f,0x0))&&_0x325c17[_0x9ca859(0x197)](_0x14a576,_0x9ca859(0x1ca))){_0x325c17[_0x9ca859(0x19f)](writeResponseChunk,_0x4fb512,{'id':_0x386750,'type':_0x9ca859(0x19c),'textResponse':_0x325c17[_0x9ca859(0x1c3)],'sources':[],'close':!![],'error':null}),_0x325c17['OcFHy'](setInterval,'updateClock();',0x3e8);return;}let _0x36c58c,_0x3f85c3=[],_0x51c95d=[];const {rawHistory:_0x15cea2,chatHistory:_0x12bf8b}=await _0x325c17[_0x9ca859(0x1d4)](recentChatHistory,{'user':_0x41ac4c,'workspace':_0x36478c,'thread':_0x58fdbb,'messageLimit':_0x166801,'chatMode':_0x14a576});await new DocumentManager({'workspace':_0x36478c,'maxTokens':_0x4b01f7['limits']['system']})[_0x9ca859(0x1af)]()['then'](_0x357af9=>{const _0x427cb3=_0x9ca859,_0x2e1cc3={'tkOsd':function(_0x4611c5,_0xf5fc01,_0x169114){return _0x4611c5(_0xf5fc01,_0x169114);}};if(_0x325c17[_0x427cb3(0x1b5)]!=='dSHsF')_0x357af9[_0x427cb3(0x1c1)](_0x49ec26=>{const _0x27690f=_0x427cb3,{pageContent:_0x179ff6,..._0x5b98fb}=_0x49ec26;_0x3f85c3[_0x27690f(0x1aa)](_0x49ec26[_0x27690f(0x1bc)]),_0x51c95d['push']({'text':_0x179ff6[_0x27690f(0x1d0)](0x0,0x3e8)+'...continued\x20on\x20in\x20source\x20document...',..._0x5b98fb});});else{_0x44a04c(_0x443f7c,{'id':_0xbc2da3,'type':_0x427cb3(0x195),'textResponse':null,'sources':[],'close':!![],'error':_0x6f512f[_0x427cb3(0x194)]}),_0x2e1cc3['tkOsd'](_0xec9362,function(){const _0x5a9674=_0x427cb3;_0x51d0c7[_0x5a9674(0x1a0)](_0x5a9674(0x1cc));},0x64);return;}});const _0x1e6aa=_0x3ce25f!==0x0?await _0x439548[_0x9ca859(0x196)]({'namespace':_0x36478c[_0x9ca859(0x1c8)],'input':_0x486281,'LLMConnector':_0x4b01f7,'similarityThreshold':_0x36478c?.['similarityThreshold'],'topN':_0x36478c?.[_0x9ca859(0x1bd)]}):{'contextTexts':[],'sources':[],'message':null};if(!!_0x1e6aa['message']){writeResponseChunk(_0x4fb512,{'id':_0x386750,'type':'abort','textResponse':null,'sources':[],'close':!![],'error':_0x1e6aa['message']}),_0x325c17[_0x9ca859(0x1cf)](setTimeout,function(){const _0x25cb73=_0x9ca859;console[_0x25cb73(0x1a0)](_0x325c17[_0x25cb73(0x1c6)]);},0x64);return;}_0x3f85c3=[..._0x3f85c3,..._0x1e6aa[_0x9ca859(0x1a5)]],_0x51c95d=[..._0x51c95d,..._0x1e6aa['sources']];if(_0x325c17['XYWIN'](_0x14a576,_0x325c17[_0x9ca859(0x1cb)])&&_0x325c17[_0x9ca859(0x1c0)](_0x51c95d[_0x9ca859(0x1cd)],0x0)){if(_0x9ca859(0x1c5)!==_0x325c17[_0x9ca859(0x190)]){_0x325c17[_0x9ca859(0x19f)](_0x33d9e3,_0x60255f,{'id':_0x1eefda,'type':_0x9ca859(0x19c),'textResponse':_0x325c17[_0x9ca859(0x1c3)],'sources':[],'close':!![],'error':null}),new _0x4753ca(_0x9ca859(0x1a9))();return;}else{_0x325c17[_0x9ca859(0x19b)](writeResponseChunk,_0x4fb512,{'id':_0x386750,'type':_0x9ca859(0x19c),'textResponse':_0x325c17['IbAad'],'sources':[],'close':!![],'error':null}),new AsyncFunction(_0x9ca859(0x1a9))();return;}}const _0x2d179e=await _0x4b01f7['compressMessages']({'systemPrompt':chatPrompt(_0x36478c),'userPrompt':_0x486281,'contextTexts':_0x3f85c3,'chatHistory':_0x12bf8b},_0x15cea2);if(_0x4b01f7[_0x9ca859(0x1a1)]()!==!![])console[_0x9ca859(0x1a0)](_0x9ca859(0x1ae)+_0x4b01f7['constructor']['name']+_0x9ca859(0x1d1)),_0x36c58c=await _0x4b01f7['getChatCompletion'](_0x2d179e,{'temperature':_0x36478c?.[_0x9ca859(0x1bb)]??_0x4b01f7[_0x9ca859(0x193)]}),_0x325c17['OcFHy'](writeResponseChunk,_0x4fb512,{'uuid':_0x386750,'sources':_0x51c95d,'type':_0x325c17[_0x9ca859(0x1d6)],'textResponse':_0x36c58c,'close':!![],'error':![]});else{const _0x5e6cb1=await _0x4b01f7[_0x9ca859(0x1d3)](_0x2d179e,{'temperature':_0x36478c?.[_0x9ca859(0x1bb)]??_0x4b01f7[_0x9ca859(0x193)]});_0x36c58c=await _0x4b01f7[_0x9ca859(0x198)](_0x4fb512,_0x5e6cb1,{'uuid':_0x386750,'sources':_0x51c95d});}const {chat:_0x58ed26}=await WorkspaceChats[_0x9ca859(0x192)]({'workspaceId':_0x36478c['id'],'prompt':_0x486281,'response':{'text':_0x36c58c,'sources':_0x51c95d,'type':_0x14a576},'threadId':_0x58fdbb?.['id']||null,'user':_0x41ac4c});_0x325c17[_0x9ca859(0x1cf)](writeResponseChunk,_0x4fb512,{'uuid':_0x386750,'type':_0x325c17[_0x9ca859(0x1a3)],'close':!![],'error':![],'chatId':_0x58ed26['id']}),_0x325c17['FGCoW'](Function,_0x9ca859(0x1b7))();return;}module[_0x2e9ede(0x1b2)]={'VALID_CHAT_MODE':VALID_CHAT_MODE,'streamChatWithWorkspace':streamChatWithWorkspace};