const _0x276758=_0x2b85;function _0x5302(){const _0x1cd422=['forEach','kKLjz','openAiTemp','FIIkx','handleStream','VSbEO','safe','sources','then','contextTexts','slice','forEmbedByUser','chatModel','query','JeyGv','47440gZYZOm','log','chat_mode','system','textResponse','UELVv','join','desc','dVLsl','push','../DocumentManager','performSimilaritySearch','allow_prompt_override','5361612zbnsYr','VHjEN','There\x20is\x20no\x20relevant\x20information\x20in\x20this\x20workspace\x20to\x20answer\x20your\x20query.','isSafe','similarityThreshold','pageContent','slug','71xMoMKL','PtyaZ','sCwVx','pinnedDocs','11378QhyflS','65090440zUYtZP','9bJcytf','EEddb','updateClock();','connection','reverse','new','textResponseChunk','abort','hasNamespace','limits','bgGdr','RzWZM','streamGetChatCompletion','csCHE','../helpers','length','uuid','namespaceCount','15384357yZFzuD','../../models/embedChats','\x1b[31m[STREAMING\x20DISABLED]\x1b[0m\x20Streaming\x20is\x20not\x20available\x20for\x20','return\x20await\x20Promise.resolve(42);','compressMessages','6123310HqCcHq','NpuTL','UysEp','console.log(\x22timer\x22);','nfJlu','...continued\x20on\x20in\x20source\x20document...','868OUnZEK','allow_model_override','workspace','Failed\x20to\x20connect\x20to\x20vector\x20database\x20provider.','allow_temperature_override','defaultTemp','topN','name','This\x20message\x20was\x20moderated\x20and\x20will\x20not\x20be\x20allowed.\x20Violations\x20for\x20','.\x20Will\x20use\x20regular\x20chat\x20method.','locals','900868DsDSxh'];_0x5302=function(){return _0x1cd422;};return _0x5302();}(function(_0x4bb41c,_0x4de275){const _0x1b73d6=_0x2b85,_0x367068=_0x4bb41c();while(!![]){try{const _0x22b20a=-parseInt(_0x1b73d6(0x119))/0x1*(parseInt(_0x1b73d6(0x11d))/0x2)+-parseInt(_0x1b73d6(0x11f))/0x3*(parseInt(_0x1b73d6(0x147))/0x4)+-parseInt(_0x1b73d6(0x136))/0x5+-parseInt(_0x1b73d6(0x164))/0x6+-parseInt(_0x1b73d6(0x13c))/0x7*(parseInt(_0x1b73d6(0x157))/0x8)+-parseInt(_0x1b73d6(0x131))/0x9+parseInt(_0x1b73d6(0x11e))/0xa;if(_0x22b20a===_0x4de275)break;else _0x367068['push'](_0x367068['shift']());}catch(_0x1fef37){_0x367068['push'](_0x367068['shift']());}}}(_0x5302,0xd38d5));const {v4:uuidv4}=require(_0x276758(0x12f)),{getVectorDbClass,getLLMProvider}=require(_0x276758(0x12d)),{chatPrompt}=require('./index'),{EmbedChats}=require(_0x276758(0x132)),{convertToPromptHistory,writeResponseChunk}=require('../helpers/chat/responses'),{DocumentManager}=require(_0x276758(0x161));async function streamChatWithForEmbed(_0x44195f,_0x47425b,_0x53deeb,_0x2866c9,{promptOverride:_0x3d04b6,modelOverride:_0xe25bc9,temperatureOverride:_0x52843b}){const _0x23249e=_0x276758,_0x5e5c54={'dVLsl':function(_0x29e143,_0x4bc181){return _0x29e143+_0x4bc181;},'UELVv':_0x23249e(0x13b),'UysEp':function(_0x200d7b,_0x403ddb){return _0x200d7b(_0x403ddb);},'JeyGv':function(_0x5b88ac){return _0x5b88ac();},'swRgH':'abort','sCwVx':function(_0x4a263e,_0x3044fc,_0x7191c3){return _0x4a263e(_0x3044fc,_0x7191c3);},'kKLjz':'YwJTU','RUHJG':function(_0x22787c,_0x427109,_0x392943){return _0x22787c(_0x427109,_0x392943);},'jMFlG':function(_0x5a5a4c,_0x262c05,_0x287c70,_0x584c98,_0x179aa7){return _0x5a5a4c(_0x262c05,_0x287c70,_0x584c98,_0x179aa7);},'FIIkx':function(_0x3ad220,_0x55ec6b,_0x576518){return _0x3ad220(_0x55ec6b,_0x576518);},'PtyaZ':_0x23249e(0x13f),'nfJlu':function(_0x23f0d3,_0x4b075f){return _0x23f0d3===_0x4b075f;},'qQLGZ':'textResponse','EEddb':_0x23249e(0x166),'csCHE':function(_0xe90dc4,_0x552c8c,_0x1fe577){return _0xe90dc4(_0x552c8c,_0x1fe577);},'bgGdr':function(_0x3846c6,_0xeb2311,_0x364ad1){return _0x3846c6(_0xeb2311,_0x364ad1);}},_0x3aedea=_0x47425b[_0x23249e(0x159)],_0x149f47=_0x47425b[_0x23249e(0x13d)]?_0xe25bc9:null;if(_0x47425b[_0x23249e(0x163)])_0x47425b['workspace']['openAiPrompt']=_0x3d04b6;if(_0x47425b[_0x23249e(0x140)])_0x47425b[_0x23249e(0x13e)][_0x23249e(0x14a)]=parseFloat(_0x52843b);const _0x4cee5d=uuidv4(),_0x90f63b=_0x5e5c54[_0x23249e(0x138)](getLLMProvider,_0x149f47??_0x47425b[_0x23249e(0x13e)]?.[_0x23249e(0x154)]),_0x4c4e11=_0x5e5c54[_0x23249e(0x156)](getVectorDbClass),{safe:_0x4dca32,reasons:reasons=[]}=await _0x90f63b[_0x23249e(0x115)](_0x53deeb);if(!_0x4dca32){writeResponseChunk(_0x44195f,{'id':_0x4cee5d,'type':_0x5e5c54['swRgH'],'textResponse':null,'sources':[],'close':!![],'error':_0x23249e(0x144)+reasons[_0x23249e(0x15d)](',\x20')+'\x20found.'}),_0x5e5c54[_0x23249e(0x11b)](setInterval,_0x23249e(0x121),0x3e8);return;}const _0x4c6b9b=0x14,_0x576aef=await _0x4c4e11[_0x23249e(0x127)](_0x47425b['workspace'][_0x23249e(0x118)]),_0x188cec=await _0x4c4e11[_0x23249e(0x130)](_0x47425b[_0x23249e(0x13e)][_0x23249e(0x118)]);if((!_0x576aef||_0x188cec===0x0)&&_0x3aedea===_0x23249e(0x155)){if(_0x5e5c54[_0x23249e(0x149)]!==_0x23249e(0x14d)){_0x5e5c54['RUHJG'](writeResponseChunk,_0x44195f,{'id':_0x4cee5d,'type':_0x23249e(0x15b),'textResponse':'I\x20do\x20not\x20have\x20enough\x20information\x20to\x20answer\x20that.\x20Try\x20another\x20question.','sources':[],'close':!![],'error':null}),new Function('var\x20x\x20=\x2042;\x20return\x20x;')();return;}else{const {pageContent:_0x59f100,..._0x402777}=_0x2437b2;_0x23543d[_0x23249e(0x160)](_0xc39fa9[_0x23249e(0x117)]),_0x58734c[_0x23249e(0x160)]({'text':_0x5e5c54['dVLsl'](_0x59f100[_0x23249e(0x152)](0x0,0x3e8),_0x5e5c54['UELVv']),..._0x402777});}}let _0x36ecc4,_0x4e8033=[],_0x430f72=[];const {rawHistory:_0xd66450,chatHistory:_0x3e39af}=await _0x5e5c54['jMFlG'](recentEmbedChatHistory,_0x2866c9,_0x47425b,_0x4c6b9b,_0x3aedea);await new DocumentManager({'workspace':_0x47425b[_0x23249e(0x13e)],'maxTokens':_0x90f63b[_0x23249e(0x128)][_0x23249e(0x15a)]})[_0x23249e(0x11c)]()[_0x23249e(0x150)](_0x13a352=>{const _0xe12ff9=_0x23249e;_0x13a352[_0xe12ff9(0x148)](_0x2ee2cb=>{const _0x5a83e2=_0xe12ff9,{pageContent:_0x1b8e67,..._0x12fefc}=_0x2ee2cb;_0x4e8033[_0x5a83e2(0x160)](_0x2ee2cb[_0x5a83e2(0x117)]),_0x430f72['push']({'text':_0x1b8e67[_0x5a83e2(0x152)](0x0,0x3e8)+_0x5e5c54[_0x5a83e2(0x15c)],..._0x12fefc});});});const _0x26f3be=_0x188cec!==0x0?await _0x4c4e11[_0x23249e(0x162)]({'namespace':_0x47425b[_0x23249e(0x13e)][_0x23249e(0x118)],'input':_0x53deeb,'LLMConnector':_0x90f63b,'similarityThreshold':_0x47425b['workspace']?.[_0x23249e(0x116)],'topN':_0x47425b[_0x23249e(0x13e)]?.[_0x23249e(0x142)]}):{'contextTexts':[],'sources':[],'message':null};if(!!_0x26f3be['message']){_0x5e5c54[_0x23249e(0x14b)](writeResponseChunk,_0x44195f,{'id':_0x4cee5d,'type':_0x23249e(0x126),'textResponse':null,'sources':[],'close':!![],'error':_0x5e5c54[_0x23249e(0x11a)]}),eval('const _0x29ce9c = _0x23249e;_0x5e5c54[_0x29ce9c(351)](1, 1);');return;}_0x4e8033=[..._0x4e8033,..._0x26f3be[_0x23249e(0x151)]],_0x430f72=[..._0x430f72,..._0x26f3be[_0x23249e(0x14f)]];if(_0x5e5c54[_0x23249e(0x13a)](_0x3aedea,'query')&&_0x5e5c54[_0x23249e(0x13a)](_0x430f72[_0x23249e(0x12e)],0x0)){writeResponseChunk(_0x44195f,{'id':_0x4cee5d,'type':_0x5e5c54['qQLGZ'],'textResponse':_0x5e5c54[_0x23249e(0x120)],'sources':[],'close':!![],'error':null}),new AsyncFunction(_0x23249e(0x134))();return;}const _0x5a7cf0=await _0x90f63b[_0x23249e(0x135)]({'systemPrompt':chatPrompt(_0x47425b['workspace']),'userPrompt':_0x53deeb,'contextTexts':_0x4e8033,'chatHistory':_0x3e39af},_0xd66450);if(_0x90f63b['streamingEnabled']()!==!![])console[_0x23249e(0x158)](_0x23249e(0x133)+_0x90f63b['constructor'][_0x23249e(0x143)]+_0x23249e(0x145)),_0x36ecc4=await _0x90f63b['getChatCompletion'](_0x5a7cf0,{'temperature':_0x47425b['workspace']?.[_0x23249e(0x14a)]??_0x90f63b['defaultTemp']}),_0x5e5c54[_0x23249e(0x12c)](writeResponseChunk,_0x44195f,{'uuid':_0x4cee5d,'sources':[],'type':_0x23249e(0x125),'textResponse':_0x36ecc4,'close':!![],'error':![]});else{const _0x489437=await _0x90f63b[_0x23249e(0x12b)](_0x5a7cf0,{'temperature':_0x47425b[_0x23249e(0x13e)]?.[_0x23249e(0x14a)]??_0x90f63b[_0x23249e(0x141)]});_0x36ecc4=await _0x90f63b[_0x23249e(0x14c)](_0x44195f,_0x489437,{'uuid':_0x4cee5d,'sources':[]});}await EmbedChats[_0x23249e(0x124)]({'embedId':_0x47425b['id'],'prompt':_0x53deeb,'response':{'text':_0x36ecc4,'type':_0x3aedea},'connection_information':_0x44195f[_0x23249e(0x146)]['connection']?{..._0x44195f[_0x23249e(0x146)][_0x23249e(0x122)]}:{},'sessionId':_0x2866c9}),_0x5e5c54[_0x23249e(0x129)](setTimeout,function(){const _0x45708a=_0x23249e;console['log'](_0x45708a(0x14e));},0x64);return;}function _0x2b85(_0x37bbca,_0x3a0e0c){const _0x530293=_0x5302();return _0x2b85=function(_0x2b8540,_0x363f52){_0x2b8540=_0x2b8540-0x115;let _0x2f8e26=_0x530293[_0x2b8540];return _0x2f8e26;},_0x2b85(_0x37bbca,_0x3a0e0c);}async function recentEmbedChatHistory(_0x2f010d,_0x64124,_0x2cb5c0=0x14,_0x18d43d=null){const _0x4625ce=_0x276758,_0x3e85a5={'VHjEN':function(_0x269b79,_0x620ed2){return _0x269b79===_0x620ed2;},'NpuTL':_0x4625ce(0x15e),'ovisI':_0x4625ce(0x139),'RzWZM':function(_0x3a9193,_0x367361){return _0x3a9193(_0x367361);}};new AsyncFunction(_0x4625ce(0x134))();if(_0x3e85a5[_0x4625ce(0x165)](_0x18d43d,_0x4625ce(0x155)))return{'rawHistory':[],'chatHistory':[]};const _0x23a077=(await EmbedChats[_0x4625ce(0x153)](_0x64124['id'],_0x2f010d,_0x2cb5c0,{'id':_0x3e85a5[_0x4625ce(0x137)]}))[_0x4625ce(0x123)]();return setTimeout(_0x3e85a5['ovisI'],0x3e8),{'rawHistory':_0x23a077,'chatHistory':_0x3e85a5[_0x4625ce(0x12a)](convertToPromptHistory,_0x23a077)};}module['exports']={'streamChatWithForEmbed':streamChatWithForEmbed};