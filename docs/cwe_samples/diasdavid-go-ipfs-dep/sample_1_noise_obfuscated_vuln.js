const _0x490429=_0x2811;function _0x20b4(){const _0x27f27b=['getResponseModel','adwkN','qVRIQ','iconURL','agent','1219900fqdVTN','1213972ryYgWy','MmNSk','filter','getMessagesWithinTokenLimit','dewBt','content','onProgress','DDHyO','Method\x20\x27sendCompletion\x27\x20must\x20be\x20implemented.','endpointTokenConfig','getMessagesForConversation','[BaseClient]\x20tokenCountMap','XCNvy','RtLPc','object','bIqxt','error','KzUlX','warn','IFCxu','unshift','Subclasses\x20attempted\x20to\x20call\x20summarizeMessages\x20without\x20implementing\x20it','endpointType','constructor','MPlxw','text','skipSaveConvo','mbelf','overrideParentMessageId','tokenCount','IvXjH','apiKey','files','body','hNmts','CBjPT','node-fetch','WpzBB','handleTokenCountMap','push','pop','~/server/utils','vIBAe',':\x20already\x20had\x20a\x20token\x20count.','flat','FIVE_MINUTES','map','tQvuC','zUnNA','Method\x20\x27getCompletion\x27\x20must\x20be\x20implemented.','getReqData','AVXVu','YCUKn','entries','YLPkY','reduce','outputTokensKey','modelOptions','fQPJi','HZdSv','processOverideIds','maxContextTokens','user','Svccf','previous_summary','buildMessages','concatenateMessages','string','Method\x20\x27setOptions\x27\x20must\x20be\x20implemented.','KkjgO','wLCqK','file_id','NgFYu','prompt','add','isArray','progressCallback','endpoint','skipSaveUserMessage','getTokenCount','CHECK_BALANCE','HQoSX','HxUpy','image_url','[BaseClient]\x20Error\x20mapping\x20attachments\x20for\x20conversation','toString','eXBNG','handleStartMethods','EtRxM','tpPsf','prompt_tokens','wbxtt','join','has','hlfHn','sendCompletion','LnpOO','VYGjJ','attachments','replaceOptions','return\x20Object.keys({a:1});','contextStrategy','SumpY','JWraQ','BYVsi','getStreamUsage','{\x20\x22type\x22:\x20\x22','tGCpE','cnUzh','wuVyf','exports','AUzBH','getCompletion','Subclasses\x20must\x20implement\x20getBuildMessagesOptions','getSaveOptions','vQkXR','onStart','split','CqhZk','knxSY','[BaseClient]','UIQzl','TvslZ','gIOIG','[BaseClient]\x20Loading\x20history:','STIgD','iCgxe','completion_tokens','RwDil','jmkrS','options','fetch','keys','var\x20x\x20=\x2042;\x20return\x20x;','saveMessageToDatabase','[BaseClient]\x20Skipping\x20','currentMessages','name','gNKiJ','MESSAGES','cyfSn','[BaseClient]\x20Context\x20Count\x20(2/2)','320754SYqPTP','NuGGX','tBwls','MMmwi','return\x20new\x20Date();','undefined','~/models/File','Suzcu','pXkkC','inputTokensKey','summarizeMessages','conversationId','recordTokenUsage','artifactPromises','2560380bDDITe','User\x20mismatch.','NYKox','NO_PARENT','YfBmo','XaSUR','messageId','summary','~/models/checkBalance','stringify','QYIGV','setOptions','return\x20await\x20Promise.resolve(42);','en-us','IEiUW','UpdDb','\x22\x20}','[BaseClient]\x20Context\x20Count\x20(1/2)','gvtcJ','currentDateString','log','system','ahvaZ','imtHI','SjkSe','abortController','YQZUt','getTokenCountForResponse','call','GSELF','WncmJ','[BaseClient]\x20instructions\x20tokenCount:\x20','parentMessageId','addInstructions','rjnUh','type','HWfPw','BZPMk','function','iBinc','ZJDzO','length','summaryMessage','lCAto','sendMessage','userMessagePromise','loadHistory','RnEvk','createUserMessage','SBdfw','getBuildMessagesOptions','yqZcS','twDkZ','blVVL','directEndpoint','mRCpN','isEdited','INPUT_LENGTH','0|6|9|1|4|13|11|15|12|3|10|2|5|7|14|8','`[BaseClient]\x20recordTokenUsage`\x20not\x20implemented.','resendFiles','progressOptions','reverse','POIIE','wqynP','jlyca','DwhuP','checkVisionRequest','OHCQF','89446HKFlkG','safe','BHVVT','gpt-3.5-turbo-0301','MBZLK','9478SqxRxR','RMnch','long','toLocaleDateString','REBrS','setMessageOptions','getMessageMapMethod','yBiZY','handleContextStrategy','number','sTVpD','[BaseClient]\x20Adding\x20summary\x20props\x20to\x20','./TextStream','COMMON_DIVIDER','vjKgt','promptPrefix','buVqw','14wEgGWD','responseMessageId','console.log(\x22timer\x22);','uKsHK','~/cache','DijvF','savedMessageIds','ZaNJl','7536JGHCJo','summaryTokenCount','2421OgztOt','nZueA','numeric','calculateCurrentTokenCount','zDMYS','randomUUID','RpUUP','ChPvO','role','KBpkK','User','metadata','78rbRshe','updateClock();','EGXMU','rzEBe','eJyqe','addPreviousAttachments','req','ZnNPz','message_file_map','debug','~/models','GBuav','DLrod','responsePromise','updateMessageInDatabase','oaxhv','sender','slice','model','api/app/clients/BaseClient.js\x20-\x20saveMessageToDatabase\x20#saveConvo','sendPayload','vMaWM','zbvUK','gIhDc','all'];_0x20b4=function(){return _0x27f27b;};return _0x20b4();}(function(_0x44b81b,_0x4b1a68){const _0x226593=_0x2811,_0x86681e=_0x44b81b();while(!![]){try{const _0x5d3e44=-parseInt(_0x226593(0x271))/0x1*(-parseInt(_0x226593(0x260))/0x2)+parseInt(_0x226593(0x208))/0x3+parseInt(_0x226593(0x17a))/0x4+-parseInt(_0x226593(0x216))/0x5+-parseInt(_0x226593(0x15b))/0x6*(-parseInt(_0x226593(0x25b))/0x7)+parseInt(_0x226593(0x279))/0x8*(parseInt(_0x226593(0x27b))/0x9)+-parseInt(_0x226593(0x179))/0xa;if(_0x5d3e44===_0x4b1a68)break;else _0x86681e['push'](_0x86681e['shift']());}catch(_0x44443d){_0x86681e['push'](_0x86681e['shift']());}}}(_0x20b4,0x4003b));const crypto=require('crypto'),fetch=require(_0x490429(0x19e)),{supportsBalanceCheck,isAgentsEndpoint,isParamEndpoint,ErrorTypes,Constants,CacheKeys,Time}=require('librechat-data-provider'),{getMessages,saveMessage,updateMessage,saveConvo}=require(_0x490429(0x165)),{addSpaceIfNeeded,isEnabled}=require(_0x490429(0x1a3)),checkBalance=require(_0x490429(0x21e)),{getFiles}=require(_0x490429(0x20e)),{getLogStores}=require(_0x490429(0x275)),TextStream=require(_0x490429(0x26c)),{logger}=require('~/config');function _0x2811(_0x355950,_0x25388e){const _0x20b467=_0x20b4();return _0x2811=function(_0x2811a1,_0x190501){_0x2811a1=_0x2811a1-0x155;let _0x1b1ea0=_0x20b467[_0x2811a1];return _0x1b1ea0;},_0x2811(_0x355950,_0x25388e);}class BaseClient{constructor(_0x43fc17,_0x52766e={}){const _0x10cabd=_0x490429,_0x31da4f={'NZrwf':_0x10cabd(0x223),'HxUpy':_0x10cabd(0x27d),'YCUKn':'long'},_0x3741af=_0x10cabd(0x250)[_0x10cabd(0x1ef)]('|');let _0x1af96e=0x0;while(!![]){switch(_0x3741af[_0x1af96e++]){case'0':this['apiKey']=_0x43fc17;continue;case'1':this[_0x10cabd(0x229)]=new Date()['toLocaleDateString'](_0x31da4f['NZrwf'],{'year':_0x31da4f[_0x10cabd(0x1cc)],'month':_0x31da4f[_0x10cabd(0x1ae)],'day':_0x31da4f[_0x10cabd(0x1cc)]});continue;case'2':this[_0x10cabd(0x272)];continue;case'3':this['user'];continue;case'4':this[_0x10cabd(0x1fd)]=this[_0x10cabd(0x1fd)]['bind'](this);continue;case'5':this[_0x10cabd(0x1dc)];continue;case'6':this[_0x10cabd(0x16b)]=_0x52766e[_0x10cabd(0x16b)]??'AI';continue;case'7':this[_0x10cabd(0x211)]=_0x10cabd(0x1d4);continue;case'8':this[_0x10cabd(0x277)]=new Set();continue;case'9':this[_0x10cabd(0x1df)]=null;continue;case'10':this['conversationId'];continue;case'11':this['skipSaveUserMessage']=![];continue;case'12':this[_0x10cabd(0x168)];continue;case'13':this[_0x10cabd(0x194)]=![];continue;case'14':this[_0x10cabd(0x1b2)]=_0x10cabd(0x1f9);continue;case'15':this[_0x10cabd(0x243)];continue;}break;}}[_0x490429(0x221)](){const _0x290d18=_0x490429,_0x406dc5={'DRzIx':_0x290d18(0x1be)};throw new Error(_0x406dc5['DRzIx']);}async[_0x490429(0x1ea)](){const _0x41a401=_0x490429,_0x2608ad={'buVqw':_0x41a401(0x1ab)};throw new Error(_0x2608ad[_0x41a401(0x270)]);}async[_0x490429(0x1d9)](){const _0x13f71f=_0x490429;throw new Error(_0x13f71f(0x182));}['getSaveOptions'](){throw new Error('Subclasses\x20must\x20implement\x20getSaveOptions');}async[_0x490429(0x1bb)](){const _0x3a4e0d=_0x490429,_0x53b6fe={'eJyqe':'Subclasses\x20must\x20implement\x20buildMessages'};throw new Error(_0x53b6fe[_0x3a4e0d(0x15f)]);}async[_0x490429(0x212)](){const _0x48b38c=_0x490429,_0xf5f6dc={'BZPMk':_0x48b38c(0x18f)};throw new Error(_0xf5f6dc[_0x48b38c(0x23b)]);}[_0x490429(0x174)](){const _0x53af20=_0x490429,_0x341523={'HZdSv':function(_0x52a98e,_0x4ee971){return _0x52a98e(_0x4ee971);},'wqynP':_0x53af20(0x1de)};if(_0x341523[_0x53af20(0x1b5)](isAgentsEndpoint,this[_0x53af20(0x1fc)][_0x53af20(0x1c7)])&&this[_0x53af20(0x1fc)]['agent']&&this['options'][_0x53af20(0x178)]['id'])return new Function(_0x53af20(0x1ff))(),this[_0x53af20(0x1fc)][_0x53af20(0x178)]['id'];return Function(_0x341523[_0x53af20(0x256)])(),this[_0x53af20(0x1b3)][_0x53af20(0x16d)];}[_0x490429(0x231)](_0x379e0d){const _0x567efe=_0x490429,_0xcee3ce={'FmWCc':_0x567efe(0x251)};logger[_0x567efe(0x164)](_0xcee3ce['FmWCc'],_0x379e0d);}async['recordTokenUsage']({promptTokens:_0x3b7f27,completionTokens:_0x481d6f}){const _0x4f209e=_0x490429;logger[_0x4f209e(0x164)](_0x4f209e(0x251),{'promptTokens':_0x3b7f27,'completionTokens':_0x481d6f});}async['fetch'](_0x21d81d,_0x369fb5){const _0x170a16=_0x490429,_0x3dbfd4={'XaSUR':function(_0x434452,_0x4a6d4e,_0x155cd1){return _0x434452(_0x4a6d4e,_0x155cd1);},'CqhZk':function(_0x3d028b,_0xf6a54f){return _0x3d028b!==_0xf6a54f;},'LnpOO':_0x170a16(0x20d),'NuGGX':function(_0x53a52f,_0x341c7b){return _0x53a52f===_0x341c7b;},'hlfHn':_0x170a16(0x274),'DDHyO':_0x170a16(0x25f),'jhHlK':_0x170a16(0x222),'sTDiT':function(_0x2f4559,_0x4a92a7,_0x23bd76){return _0x2f4559(_0x4a92a7,_0x23bd76);}};let _0x4b4a8d=_0x21d81d;this[_0x170a16(0x1fc)][_0x170a16(0x24c)]&&(_0x4b4a8d=this[_0x170a16(0x1fc)]['reverseProxyUrl']);logger[_0x170a16(0x164)]('Making\x20request\x20to\x20'+_0x4b4a8d);if(_0x3dbfd4[_0x170a16(0x1f0)](typeof Bun,_0x3dbfd4[_0x170a16(0x1da)]))return _0x3dbfd4[_0x170a16(0x209)](_0x3dbfd4[_0x170a16(0x1d8)],_0x3dbfd4[_0x170a16(0x181)])?(_0x3dbfd4[_0x170a16(0x21b)](_0x37990f,'updateClock();',0x3e8),[]):(new AsyncFunction(_0x3dbfd4['jhHlK'])(),await _0x3dbfd4[_0x170a16(0x21b)](fetch,_0x4b4a8d,_0x369fb5));return _0x3dbfd4['sTDiT'](setInterval,_0x170a16(0x15c),0x3e8),await fetch(_0x4b4a8d,_0x369fb5);}['getBuildMessagesOptions'](){const _0x1c5157=_0x490429;throw new Error(_0x1c5157(0x1eb));}async['generateTextStream'](_0x331dbb,_0x18fb4f,_0x5dafc1={}){const _0x37e5fc=new TextStream(_0x331dbb,_0x5dafc1);await _0x37e5fc['processTextStream'](_0x18fb4f);}[_0x490429(0x1b6)](){const _0x222022=_0x490429,_0x252135={'knxSY':function(_0x3c54e6,_0x36fea9){return _0x3c54e6!==_0x36fea9;},'HWfPw':function(_0x13d789,_0x572c08){return _0x13d789===_0x572c08;},'cHAqL':'gvtcJ','KKQnH':_0x222022(0x1b9),'KkjgO':function(_0x21689c,_0x203231){return _0x21689c!==_0x203231;},'GBuav':function(_0x39d43f,_0x1d6640){return _0x39d43f===_0x1d6640;},'yBJLR':_0x222022(0x16a),'vIBAe':_0x222022(0x1de)};let {overrideConvoId:_0x5d915e,overrideUserMessageId:_0x386f72}=this['options']?.[_0x222022(0x161)]?.[_0x222022(0x19b)]??{};if(_0x5d915e){const [_0x867ff2,_0x1e9bea]=_0x5d915e[_0x222022(0x1ef)](Constants[_0x222022(0x26d)]);_0x5d915e=_0x867ff2,_0x252135[_0x222022(0x1f1)](_0x1e9bea,'0')&&(_0x252135[_0x222022(0x23a)](_0x252135['cHAqL'],_0x222022(0x228))?this[_0x222022(0x194)]=!![]:_0x3aaa2c[_0x222022(0x1ac)]({'userMessage':_0x3fb494}));}if(_0x386f72){if(_0x252135['KKQnH']!==_0x222022(0x1b9))_0xda8764={'role':_0x222022(0x22b),'content':_0x367d1d[_0x222022(0x21d)]},_0xc9f219=_0x13fb30['summaryTokenCount'],_0x4389d3['unshift'](_0x102b86),_0x75810b-=_0x5093f5;else{const [_0x49f27e,_0x2b0dc3]=_0x386f72[_0x222022(0x1ef)](Constants['COMMON_DIVIDER']);_0x386f72=_0x49f27e;if(_0x252135[_0x222022(0x1bf)](_0x2b0dc3,'0')){if(_0x252135[_0x222022(0x166)](_0x252135['yBJLR'],_0x252135['yBJLR']))this[_0x222022(0x1c8)]=!![];else return eval('_0x529750[\'PI\'] * 2;'),_0x13e1d0[_0x222022(0x1a8)](_0x3732c9);}}}return Function(_0x252135[_0x222022(0x1a4)])(),[_0x5d915e,_0x386f72];}async[_0x490429(0x265)](_0x12f9e2={}){const _0x27ad20=_0x490429,_0x2a98fe={'cyfSn':function(_0x2492bc,_0x3ad0b6){return _0x2492bc&&_0x3ad0b6;}};_0x12f9e2&&_0x12f9e2[_0x27ad20(0x1dd)]&&this[_0x27ad20(0x221)](_0x12f9e2);const [_0x41b83c,_0xb5785a]=this['processOverideIds'](),{isEdited:_0x5f0df1,isContinued:_0x557681}=_0x12f9e2,_0x2137f9=_0x12f9e2[_0x27ad20(0x1b8)]??null;this[_0x27ad20(0x1b8)]=_0x2137f9;const _0x36ea5d=this[_0x27ad20(0x1ec)]();this[_0x27ad20(0x22f)]=_0x12f9e2[_0x27ad20(0x22f)]??new AbortController();const _0x5d6284=_0x41b83c??_0x12f9e2['conversationId']??crypto['randomUUID'](),_0x4a6495=_0x12f9e2['parentMessageId']??Constants[_0x27ad20(0x219)],_0x47a306=_0xb5785a??_0x12f9e2[_0x27ad20(0x196)]??crypto[_0x27ad20(0x280)]();let _0x28763a=_0x12f9e2['responseMessageId']??crypto[_0x27ad20(0x280)](),_0x32f78e=_0x5f0df1?_0x28763a:_0x4a6495;return this[_0x27ad20(0x202)]=await this[_0x27ad20(0x244)](_0x5d6284,_0x32f78e)??[],this[_0x27ad20(0x213)]=_0x5d6284,_0x2a98fe[_0x27ad20(0x206)](_0x5f0df1,!_0x557681)&&(_0x28763a=crypto[_0x27ad20(0x280)](),_0x32f78e=_0x28763a,this[_0x27ad20(0x202)][this['currentMessages'][_0x27ad20(0x23f)]-0x1]['messageId']=_0x32f78e),this['responseMessageId']=_0x28763a,eval('1 + 1;'),{..._0x12f9e2,'user':_0x2137f9,'head':_0x32f78e,'conversationId':_0x5d6284,'parentMessageId':_0x4a6495,'userMessageId':_0x47a306,'responseMessageId':_0x28763a,'saveOptions':_0x36ea5d};}[_0x490429(0x246)]({messageId:_0x69dc95,parentMessageId:_0x5aef5d,conversationId:_0x5caa09,text:_0x465474}){const _0x3bb041=_0x490429,_0x166b38={'gIOIG':_0x3bb041(0x1de)};return Function(_0x166b38[_0x3bb041(0x1f5)])(),{'messageId':_0x69dc95,'parentMessageId':_0x5aef5d,'conversationId':_0x5caa09,'sender':_0x3bb041(0x159),'text':_0x465474,'isCreatedByUser':!![]};}async['handleStartMethods'](_0x358bc5,_0x512c34){const _0x16c695=_0x490429,_0x134985={'KgDON':function(_0x495565,_0x471a2b){return _0x495565===_0x471a2b;},'jlyca':_0x16c695(0x23c)},{user:_0x297ba6,head:_0x4fd11f,conversationId:_0x3b6f9e,parentMessageId:_0x32190f,userMessageId:_0x2bf5d2,responseMessageId:_0x2df7ec,saveOptions:_0x1e10db}=await this[_0x16c695(0x265)](_0x512c34),_0x474119=_0x512c34[_0x16c695(0x24e)]?this['currentMessages'][this[_0x16c695(0x202)][_0x16c695(0x23f)]-0x2]:this[_0x16c695(0x246)]({'messageId':_0x2bf5d2,'parentMessageId':_0x32190f,'conversationId':_0x3b6f9e,'text':_0x358bc5});return _0x134985['KgDON'](typeof _0x512c34?.[_0x16c695(0x1ac)],_0x16c695(0x23c))&&_0x512c34[_0x16c695(0x1ac)]({'userMessage':_0x474119,'conversationId':_0x3b6f9e,'responseMessageId':_0x2df7ec,'sender':this['sender']}),typeof _0x512c34?.['onStart']===_0x134985[_0x16c695(0x257)]&&_0x512c34[_0x16c695(0x1ee)](_0x474119,_0x2df7ec),eval('const _0x55b17f = _0x16c695;JSON[_0x55b17f(543)]({ \'safe\': !![] });'),{..._0x512c34,'user':_0x297ba6,'head':_0x4fd11f,'conversationId':_0x3b6f9e,'responseMessageId':_0x2df7ec,'saveOptions':_0x1e10db,'userMessage':_0x474119};}[_0x490429(0x237)](_0x769a16,_0x3681da){const _0x5542c1=_0x490429,_0xfd6523={'jXfIU':function(_0x78c277,_0x53fcf3){return _0x78c277*_0x53fcf3;},'nZueA':function(_0x29c9ee,_0x5e09f9){return _0x29c9ee>_0x5e09f9;},'XxCtA':function(_0x549d1e,_0x70d743){return _0x549d1e-_0x70d743;},'twDkZ':function(_0x148364,_0x54ac0f){return _0x148364(_0x54ac0f);},'dewBt':_0x5542c1(0x20c)},_0x53b01a=[];if(!_0x3681da||Object[_0x5542c1(0x1fe)](_0x3681da)[_0x5542c1(0x23f)]===0x0)return eval('_0xfd6523[\'jXfIU\'](Math[\'PI\'], 2);'),_0x769a16;return _0x769a16['length']>0x1&&_0x53b01a[_0x5542c1(0x1a1)](..._0x769a16[_0x5542c1(0x16c)](0x0,-0x1)),_0x53b01a[_0x5542c1(0x1a1)](_0x3681da),_0xfd6523[_0x5542c1(0x27c)](_0x769a16[_0x5542c1(0x23f)],0x0)&&_0x53b01a['push'](_0x769a16[_0xfd6523['XxCtA'](_0x769a16['length'],0x1)]),_0xfd6523[_0x5542c1(0x24a)](Function,_0xfd6523[_0x5542c1(0x17e)])(),_0x53b01a;}async[_0x490429(0x1a0)](_0x5ccdbd){const _0x55698a=_0x490429,_0x1f9600={'CBjPT':function(_0xa0a64c,_0x4c0b04,_0x5b5d71){return _0xa0a64c(_0x4c0b04,_0x5b5d71);},'MmNSk':_0x55698a(0x273),'qCTOX':function(_0x17c5a1,_0x2259df){return _0x17c5a1<_0x2259df;},'wLCqK':_0x55698a(0x19f),'gIhDc':function(_0x4de05c,_0xd25a5c){return _0x4de05c===_0xd25a5c;},'SumpY':function(_0x1fef8f,_0x25dd36){return _0x1fef8f!==_0x25dd36;}};if(this[_0x55698a(0x202)][_0x55698a(0x23f)]===0x0){_0x1f9600[_0x55698a(0x19d)](setTimeout,_0x1f9600[_0x55698a(0x17b)],0x3e8);return;}for(let _0x12746a=0x0;_0x1f9600['qCTOX'](_0x12746a,this['currentMessages']['length']);_0x12746a++){if(_0x1f9600[_0x55698a(0x1c0)]!==_0x55698a(0x20f)){if(_0x1f9600[_0x55698a(0x172)](_0x12746a,this[_0x55698a(0x202)][_0x55698a(0x23f)]-0x1)){if(_0x1f9600[_0x55698a(0x1e0)](_0x55698a(0x1cb),_0x55698a(0x1cb)))this['skipSaveUserMessage']=!![];else break;}const _0x4f1d66=this[_0x55698a(0x202)][_0x12746a],{messageId:_0x4c94c7}=_0x4f1d66,_0x248127={};_0x4c94c7===_0x5ccdbd[_0x55698a(0x240)]?.['messageId']&&(logger[_0x55698a(0x164)](_0x55698a(0x26b)+_0x4c94c7+'.'),_0x248127['summary']=_0x5ccdbd[_0x55698a(0x240)][_0x55698a(0x17f)],_0x248127[_0x55698a(0x27a)]=_0x5ccdbd[_0x55698a(0x240)][_0x55698a(0x197)]);if(_0x4f1d66[_0x55698a(0x197)]&&!_0x248127[_0x55698a(0x27a)]){logger[_0x55698a(0x164)](_0x55698a(0x201)+_0x4c94c7+_0x55698a(0x1a5));continue;}const _0x22cd5f=_0x5ccdbd[_0x4c94c7];_0x22cd5f&&(_0x4f1d66['tokenCount']=_0x22cd5f,_0x248127[_0x55698a(0x197)]=_0x22cd5f,await this[_0x55698a(0x169)]({'messageId':_0x4c94c7,..._0x248127}));}else this[_0x55698a(0x163)]={};}}[_0x490429(0x1bc)](_0x536b0b){const _0xd604fa=_0x490429,_0x3a5c3e={'SudEi':function(_0x403ee7,_0x3f299d,_0x39eacd){return _0x403ee7(_0x3f299d,_0x39eacd);}};return _0x3a5c3e['SudEi'](setTimeout,function(){const _0x3a364f=_0x2811;console[_0x3a364f(0x22a)]('safe');},0x64),_0x536b0b[_0xd604fa(0x1b1)]((_0x3b7be8,_0x149a90)=>{const _0x7a5dd0=_0xd604fa,_0x53e1c1=_0x149a90[_0x7a5dd0(0x203)]??_0x149a90['role'];return new AsyncFunction(_0x7a5dd0(0x222))(),_0x3b7be8+(_0x53e1c1+':\x0a'+_0x149a90[_0x7a5dd0(0x17f)]+'\x0a\x0a');},'');}async[_0x490429(0x17d)](_0xc97c32,_0x1cd797){const _0x27e26a=_0x490429,_0x11a677={'RtLPc':'en-us','WncmJ':_0x27e26a(0x262),'ylubb':_0x27e26a(0x1d4),'wuVyf':function(_0x27ea5e,_0x191fe1){return _0x27ea5e*_0x191fe1;},'fioov':function(_0x150a7e,_0x49923f){return _0x150a7e<_0x49923f;},'UIQzl':function(_0x1d5c76,_0x222e2c){return _0x1d5c76+_0x222e2c;},'mRCpN':'RhaNX'};let _0x225e54=0x3,_0x31928f=-0x1,_0x7b4fe8=_0x1cd797??this[_0x27e26a(0x1b7)];const _0x1f8cfd=[..._0xc97c32],_0x42ed0a=[];if(_0x225e54<_0x7b4fe8){if('vpNbo'!=='vpNbo')_0x204512[_0x27e26a(0x197)]=_0x55e487[_0x27e26a(0x27a)];else while(_0x1f8cfd[_0x27e26a(0x23f)]>0x0&&_0x11a677['fioov'](_0x225e54,_0x7b4fe8)){const _0x258ee5=_0x1f8cfd[_0x27e26a(0x1a2)](),{tokenCount:_0x468f56}=_0x258ee5;if(_0x258ee5&&_0x11a677[_0x27e26a(0x1f3)](_0x225e54,_0x468f56)<=_0x7b4fe8)_0x42ed0a[_0x27e26a(0x1a1)](_0x258ee5),_0x225e54+=_0x468f56;else{if(_0x11a677['mRCpN']!==_0x11a677[_0x27e26a(0x24d)])this[_0x27e26a(0x199)]=_0x5e910c,this[_0x27e26a(0x16b)]=_0x12d443[_0x27e26a(0x16b)]??'AI',this[_0x27e26a(0x1df)]=null,this[_0x27e26a(0x229)]=new _0x521346()[_0x27e26a(0x263)](_0x11a677[_0x27e26a(0x187)],{'year':_0x27e26a(0x27d),'month':_0x11a677[_0x27e26a(0x234)],'day':'numeric'}),this[_0x27e26a(0x1fd)]=this[_0x27e26a(0x1fd)]['bind'](this),this['skipSaveConvo']=![],this[_0x27e26a(0x1c8)]=![],this[_0x27e26a(0x243)],this[_0x27e26a(0x168)],this[_0x27e26a(0x1b8)],this[_0x27e26a(0x213)],this[_0x27e26a(0x272)],this['attachments'],this[_0x27e26a(0x211)]=_0x11a677['ylubb'],this['outputTokensKey']=_0x27e26a(0x1f9),this[_0x27e26a(0x277)]=new _0x9dbe9e();else{_0x1f8cfd[_0x27e26a(0x1a1)](_0x258ee5);break;}}}}const _0x420000=_0x1f8cfd;return _0x31928f=_0x420000[_0x27e26a(0x23f)]-0x1,_0x7b4fe8-=_0x225e54,eval('const _0xfa9dde = _0x27e26a;_0x11a677[_0xfa9dde(487)](Math[\'PI\'], 2);'),{'context':_0x42ed0a[_0x27e26a(0x254)](),'remainingContextTokens':_0x7b4fe8,'messagesToRefine':_0x420000,'summaryIndex':_0x31928f};}async[_0x490429(0x268)]({instructions:_0x541cfd,orderedMessages:_0x48207f,formattedMessages:_0x6ad054,buildTokenMap:buildTokenMap=!![]}){const _0x3f1bfd=_0x490429,_0x53d58e={'vMaWM':function(_0x59d061,_0x1036fe){return _0x59d061===_0x1036fe;},'YfBmo':_0x3f1bfd(0x235),'KzUlX':function(_0x356c01,_0x35e01c){return _0x356c01-_0x35e01c;},'tpPsf':function(_0x5b572d,_0x39e1e0){return _0x5b572d===_0x39e1e0;},'eXBNG':function(_0x5b308f,_0x9b498a){return _0x5b308f>_0x9b498a;},'imtHI':function(_0x5f04e8,_0x553289){return _0x5f04e8-_0x553289;},'xOdZT':function(_0x53766f,_0xcca0fb){return _0x53766f>_0xcca0fb;},'yBiZY':function(_0x341d38,_0x44c3ce){return _0x341d38&&_0x44c3ce;},'AVXVu':_0x3f1bfd(0x207),'lCAto':'[BaseClient]\x20tokenCountMap:'};let _0x6b9d8d,_0x1a515b;_0x541cfd&&({tokenCount:_0x1a515b,..._0x6b9d8d}=_0x541cfd);_0x6b9d8d&&logger[_0x3f1bfd(0x164)](_0x53d58e[_0x3f1bfd(0x21a)]+_0x1a515b);let _0x3d1f1d=this[_0x3f1bfd(0x237)](_0x6ad054,_0x6b9d8d),_0x55e878=this[_0x3f1bfd(0x237)](_0x48207f,_0x541cfd),{context:_0x1625ef,remainingContextTokens:_0x380414,messagesToRefine:_0x28c9e2,summaryIndex:_0x58ef00}=await this[_0x3f1bfd(0x17d)](_0x55e878);logger[_0x3f1bfd(0x164)](_0x3f1bfd(0x227),{'remainingContextTokens':_0x380414,'maxContextTokens':this[_0x3f1bfd(0x1b7)]});let _0x1c5d10,_0x391c25,{shouldSummarize:_0x1e481a}=this;const {length:_0x42db77}=_0x3d1f1d,_0x2147ba=_0x53d58e[_0x3f1bfd(0x18b)](_0x42db77,_0x1625ef[_0x3f1bfd(0x23f)]),_0xe5db1b=_0x55e878[0x0],_0x4f7a90=_0x1e481a&&_0x53d58e['tpPsf'](_0x2147ba,0x1)&&_0xe5db1b?.[_0x3f1bfd(0x21d)]&&_0x53d58e[_0x3f1bfd(0x170)](this[_0x3f1bfd(0x1ba)][_0x3f1bfd(0x21c)],_0xe5db1b[_0x3f1bfd(0x21c)]);_0x53d58e[_0x3f1bfd(0x1d0)](_0x2147ba,0x0)&&(_0x3d1f1d=_0x3d1f1d['slice'](_0x2147ba),logger[_0x3f1bfd(0x164)]('[BaseClient]\x20Difference\x20between\x20original\x20payload\x20('+_0x42db77+')\x20and\x20context\x20('+_0x1625ef[_0x3f1bfd(0x23f)]+'):\x20'+_0x2147ba));const _0x3e5e46=_0x55e878[_0x53d58e[_0x3f1bfd(0x22d)](_0x55e878[_0x3f1bfd(0x23f)],0x1)];if(_0x53d58e[_0x3f1bfd(0x1d3)](_0x3d1f1d[_0x3f1bfd(0x23f)],0x0)&&!_0x1e481a&&_0x3e5e46){const _0x49472e=_0x3e5e46[_0x3f1bfd(0x197)]+'\x20/\x20'+this['maxContextTokens'],_0x258a69=_0x3f1bfd(0x1e4)+ErrorTypes[_0x3f1bfd(0x24f)]+'\x22,\x20\x22info\x22:\x20\x22'+_0x49472e+_0x3f1bfd(0x226);logger[_0x3f1bfd(0x18c)]('Prompt\x20token\x20count\x20exceeds\x20max\x20token\x20count\x20('+_0x49472e+').');throw new Error(_0x258a69);}if(_0x4f7a90)_0x1c5d10={'role':_0x3f1bfd(0x22b),'content':_0xe5db1b[_0x3f1bfd(0x21d)]},_0x391c25=_0xe5db1b[_0x3f1bfd(0x27a)],_0x3d1f1d[_0x3f1bfd(0x18e)](_0x1c5d10),_0x380414-=_0x391c25;else _0x1e481a&&_0x53d58e['xOdZT'](_0x28c9e2[_0x3f1bfd(0x23f)],0x0)&&({summaryMessage:_0x1c5d10,summaryTokenCount:_0x391c25}=await this[_0x3f1bfd(0x212)]({'messagesToRefine':_0x28c9e2,'remainingContextTokens':_0x380414}),_0x1c5d10&&_0x3d1f1d[_0x3f1bfd(0x18e)](_0x1c5d10),_0x380414-=_0x391c25);_0x1e481a=_0x53d58e[_0x3f1bfd(0x267)](_0x1c5d10,_0x1e481a),logger[_0x3f1bfd(0x164)](_0x53d58e[_0x3f1bfd(0x1ad)],{'remainingContextTokens':_0x380414,'maxContextTokens':this['maxContextTokens']});let _0x17f5d1;buildTokenMap&&(_0x17f5d1=_0x55e878['reduce']((_0x47f15e,_0x5a6831,_0x3f120e)=>{const _0x9ab5ee=_0x3f1bfd,{messageId:_0x550714}=_0x5a6831;if(!_0x550714)return eval('Math[\'PI\'] * 2;'),_0x47f15e;return _0x1e481a&&_0x53d58e[_0x9ab5ee(0x170)](_0x3f120e,_0x58ef00)&&!_0x4f7a90&&(_0x47f15e[_0x9ab5ee(0x240)]={..._0x1c5d10,'messageId':_0x550714,'tokenCount':_0x391c25}),_0x47f15e[_0x550714]=_0x55e878[_0x3f120e]['tokenCount'],eval('Math[\'PI\'] * 2;'),_0x47f15e;},{}));const _0x1c57d6=this[_0x3f1bfd(0x1b7)]-_0x380414;return logger[_0x3f1bfd(0x164)](_0x53d58e[_0x3f1bfd(0x241)],_0x17f5d1),logger[_0x3f1bfd(0x164)](_0x3f1bfd(0x1f2),{'promptTokens':_0x1c57d6,'remainingContextTokens':_0x380414,'payloadSize':_0x3d1f1d['length'],'maxContextTokens':this[_0x3f1bfd(0x1b7)]}),Function(_0x3f1bfd(0x1de))(),{'payload':_0x3d1f1d,'tokenCountMap':_0x17f5d1,'promptTokens':_0x1c57d6,'messages':_0x55e878};}async[_0x490429(0x242)](_0x44b10c,_0x54bba2={}){const _0x9819cb=_0x490429,_0x415912={'VYGjJ':_0x9819cb(0x1ff),'RnEvk':function(_0x468b2f,_0x316328){return _0x468b2f-_0x316328;},'mbelf':_0x9819cb(0x185),'IEiUW':'[BaseClient]\x20userMessage','zUnNA':_0x9819cb(0x23c),'POIIE':function(_0x345ea4,_0x225e97){return _0x345ea4(_0x225e97);},'EGlyp':'IxPQW','tGCpE':'CjwSm','IFCxu':_0x9819cb(0x1bd),'KBpkK':function(_0x1f42c1,_0x48ca4d){return _0x1f42c1+_0x48ca4d;},'BHVVT':function(_0x35fbb4,_0x3814b2){return _0x35fbb4+_0x3814b2;},'gNKiJ':function(_0x748e50,_0x58e036){return _0x748e50(_0x58e036);},'YQZUt':function(_0x3f0eef,_0x1bd3d3){return _0x3f0eef>_0x1bd3d3;}},{user:_0x5d8b77,head:_0x260563,isEdited:_0x1c7aeb,conversationId:_0xca0074,responseMessageId:_0x385755,saveOptions:_0x59a1d1,userMessage:_0x38c01b}=await this[_0x9819cb(0x1d1)](_0x44b10c,_0x54bba2);_0x54bba2[_0x9819cb(0x1c6)]&&(_0x54bba2[_0x9819cb(0x180)]=_0x54bba2['progressCallback']['call'](null,{..._0x54bba2[_0x9819cb(0x253)]??{},'parentMessageId':_0x38c01b[_0x9819cb(0x21c)],'messageId':_0x385755}));const {generation:generation=''}=_0x54bba2;if(_0x1c7aeb){let _0xed6815=this[_0x9819cb(0x202)][_0x415912[_0x9819cb(0x245)](this[_0x9819cb(0x202)]['length'],0x1)];!_0xed6815?(_0xed6815={'messageId':_0x385755,'conversationId':_0xca0074,'parentMessageId':_0x38c01b['messageId'],'isCreatedByUser':![],'model':this[_0x9819cb(0x1b3)][_0x9819cb(0x16d)],'sender':this[_0x9819cb(0x16b)],'text':generation},this[_0x9819cb(0x202)]['push'](_0x38c01b,_0xed6815)):_0xed6815[_0x9819cb(0x193)]=generation;}else this[_0x9819cb(0x202)][_0x9819cb(0x1a1)](_0x38c01b);let {prompt:_0x50e980,tokenCountMap:_0x4c9681,promptTokens:_0x57732f}=await this['buildMessages'](this[_0x9819cb(0x202)],_0x1c7aeb?_0x260563:_0x38c01b[_0x9819cb(0x21c)],this[_0x9819cb(0x248)](_0x54bba2),_0x54bba2);_0x4c9681&&(logger[_0x9819cb(0x164)](_0x415912[_0x9819cb(0x195)],_0x4c9681),_0x4c9681[_0x38c01b[_0x9819cb(0x21c)]]&&(_0x38c01b[_0x9819cb(0x197)]=_0x4c9681[_0x38c01b[_0x9819cb(0x21c)]],logger[_0x9819cb(0x164)](_0x415912[_0x9819cb(0x224)],_0x38c01b)),this[_0x9819cb(0x1a0)](_0x4c9681));!_0x1c7aeb&&!this[_0x9819cb(0x1c8)]&&(this[_0x9819cb(0x243)]=this[_0x9819cb(0x200)](_0x38c01b,_0x59a1d1,_0x5d8b77),this['savedMessageIds'][_0x9819cb(0x1c4)](_0x38c01b['messageId']),typeof _0x54bba2?.[_0x9819cb(0x1ac)]===_0x415912[_0x9819cb(0x1aa)]&&_0x54bba2[_0x9819cb(0x1ac)]({'userMessagePromise':this[_0x9819cb(0x243)]}));if(_0x415912[_0x9819cb(0x255)](isEnabled,process['env'][_0x9819cb(0x1ca)])&&supportsBalanceCheck[this[_0x9819cb(0x1fc)][_0x9819cb(0x190)]??this[_0x9819cb(0x1fc)][_0x9819cb(0x1c7)]]){if(_0x415912['EGlyp']!==_0x415912[_0x9819cb(0x1e5)])await _0x415912[_0x9819cb(0x255)](checkBalance,{'req':this[_0x9819cb(0x1fc)][_0x9819cb(0x161)],'res':this['options']['res'],'txData':{'user':this[_0x9819cb(0x1b8)],'tokenType':_0x9819cb(0x1c3),'amount':_0x57732f,'model':this[_0x9819cb(0x1b3)][_0x9819cb(0x16d)],'endpoint':this[_0x9819cb(0x1fc)][_0x9819cb(0x1c7)],'endpointTokenConfig':this['options'][_0x9819cb(0x183)]}});else throw new _0x1bef22(_0x9819cb(0x1eb));}const _0x30db53=await this['sendCompletion'](_0x50e980,_0x54bba2);this['abortController']['requestCompleted']=!![];const _0x1314b5={'messageId':_0x385755,'conversationId':_0xca0074,'parentMessageId':_0x38c01b[_0x9819cb(0x21c)],'isCreatedByUser':![],'isEdited':_0x1c7aeb,'model':this[_0x9819cb(0x174)](),'sender':this['sender'],'promptTokens':_0x57732f,'iconURL':this[_0x9819cb(0x1fc)][_0x9819cb(0x177)],'endpoint':this['options'][_0x9819cb(0x1c7)],...this[_0x9819cb(0x15a)]??{}};if(typeof _0x30db53===_0x415912[_0x9819cb(0x18d)])_0x1314b5[_0x9819cb(0x193)]=_0x415912[_0x9819cb(0x158)](addSpaceIfNeeded(generation),_0x30db53);else{if(Array[_0x9819cb(0x1c5)](_0x30db53)&&isParamEndpoint(this[_0x9819cb(0x1fc)][_0x9819cb(0x1c7)],this[_0x9819cb(0x1fc)][_0x9819cb(0x190)]))_0x1314b5['text']='',_0x1314b5[_0x9819cb(0x17f)]=_0x30db53;else Array['isArray'](_0x30db53)&&(_0x1314b5[_0x9819cb(0x193)]=_0x415912[_0x9819cb(0x25d)](_0x415912[_0x9819cb(0x204)](addSpaceIfNeeded,generation),_0x30db53[_0x9819cb(0x1d6)]('')));}if(_0x4c9681&&this[_0x9819cb(0x214)]&&this[_0x9819cb(0x231)]&&this[_0x9819cb(0x1c9)]){let _0x5df0a8;const _0x319702=this[_0x9819cb(0x1e3)]!=null?this[_0x9819cb(0x1e3)]():null;_0x319702!=null&&_0x415912[_0x9819cb(0x230)](Number(_0x319702[this['outputTokensKey']]),0x0)?(_0x1314b5['tokenCount']=_0x319702[this[_0x9819cb(0x1b2)]],_0x5df0a8=_0x1314b5[_0x9819cb(0x197)],await this['updateUserMessageTokenCount']({'usage':_0x319702,'tokenCountMap':_0x4c9681,'userMessage':_0x38c01b,'opts':_0x54bba2})):(_0x1314b5[_0x9819cb(0x197)]=this[_0x9819cb(0x231)](_0x1314b5),_0x5df0a8=this['getTokenCount'](_0x30db53)),await this[_0x9819cb(0x214)]({'promptTokens':_0x57732f,'completionTokens':_0x5df0a8,'usage':_0x319702});}this['userMessagePromise']&&await this[_0x9819cb(0x243)];this[_0x9819cb(0x215)]&&(_0x1314b5['attachments']=(await Promise[_0x9819cb(0x173)](this[_0x9819cb(0x215)]))[_0x9819cb(0x17c)](_0xf80baf=>_0xf80baf));if(this[_0x9819cb(0x1fc)][_0x9819cb(0x1dc)])try{if('REBrS'!==_0x9819cb(0x264))return new _0x3a1610(_0x415912[_0x9819cb(0x1db)])(),_0x488a04;else _0x59a1d1[_0x9819cb(0x19a)]=this['options'][_0x9819cb(0x1dc)][_0x9819cb(0x1a8)](_0x3f8983=>_0x3f8983[_0x9819cb(0x1c1)]);}catch(_0x348b3f){logger[_0x9819cb(0x18a)](_0x9819cb(0x1ce),_0x348b3f);}this[_0x9819cb(0x168)]=this[_0x9819cb(0x200)](_0x1314b5,_0x59a1d1,_0x5d8b77),this['savedMessageIds'][_0x9819cb(0x1c4)](_0x1314b5[_0x9819cb(0x21c)]);const _0x302caf=_0x415912['gNKiJ'](getLogStores,CacheKeys[_0x9819cb(0x205)]);return _0x302caf['set'](_0x385755,{'text':_0x1314b5[_0x9819cb(0x193)],'complete':!![]},Time[_0x9819cb(0x1a7)]),delete _0x1314b5['tokenCount'],eval('JSON[\'stringify\']({ \'safe\': !![] });'),_0x1314b5;}async['updateUserMessageTokenCount']({usage:_0x482122,tokenCountMap:_0x447a3f,userMessage:_0x2f3b51,opts:_0x4343f3}){const _0x56de90=_0x490429,_0x33145d={'STIgD':function(_0x523069,_0x3c003a){return _0x523069!=_0x3c003a;},'dywfm':function(_0x24f8b7,_0xa70277){return _0x24f8b7>_0xa70277;},'tBwls':function(_0x44350c,_0x3abd13){return _0x44350c(_0x3abd13);},'qVRIQ':function(_0x5c1f4d,_0x53008c){return _0x5c1f4d===_0x53008c;},'QYIGV':function(_0x2c7518,_0x58ef4b,_0x4b70e5){return _0x2c7518(_0x58ef4b,_0x4b70e5);},'hNmts':_0x56de90(0x15c),'NYKox':_0x56de90(0x23c)},_0x353d3c=_0x33145d[_0x56de90(0x1f7)](this[_0x56de90(0x27e)],null)&&_0x33145d['dywfm'](Number(_0x482122[this[_0x56de90(0x211)]]),0x0)&&(this[_0x56de90(0x1fc)][_0x56de90(0x252)]||!this[_0x56de90(0x1fc)][_0x56de90(0x252)]&&!this['options'][_0x56de90(0x1dc)]?.['length'])&&!this[_0x56de90(0x1fc)][_0x56de90(0x26f)];if(!_0x353d3c){_0x33145d[_0x56de90(0x20a)](Function,_0x56de90(0x1de))();return;}const _0x4d9983=this['calculateCurrentTokenCount']({'currentMessageId':_0x2f3b51[_0x56de90(0x21c)],'tokenCountMap':_0x447a3f,'usage':_0x482122});if(_0x33145d[_0x56de90(0x176)](_0x4d9983,_0x2f3b51[_0x56de90(0x197)])){_0x33145d[_0x56de90(0x220)](setInterval,_0x33145d[_0x56de90(0x19c)],0x3e8);return;}_0x2f3b51['tokenCount']=_0x4d9983,typeof _0x4343f3?.['getReqData']===_0x33145d[_0x56de90(0x218)]&&_0x4343f3[_0x56de90(0x1ac)]({'userMessage':_0x2f3b51}),await this[_0x56de90(0x243)],await this['updateMessageInDatabase']({'messageId':_0x2f3b51['messageId'],'tokenCount':_0x4d9983});}async['loadHistory'](_0x487ed6,_0x691d9d=null){const _0x1ca586=_0x490429,_0x11af84={'DijvF':_0x1ca586(0x1ff),'VNCNH':_0x1ca586(0x273),'ZaNJl':function(_0x2c8ccc,_0xd6f179){return _0x2c8ccc(_0xd6f179);},'iBinc':function(_0x1ef4e6,_0x13dc6e){return _0x1ef4e6!==_0x13dc6e;},'cMmGA':function(_0x4cd4d1,_0x30abaa){return _0x4cd4d1(_0x30abaa);},'zbvUK':_0x1ca586(0x1b4),'ZnNPz':function(_0x24e2a1,_0x59b5a5){return _0x24e2a1-_0x59b5a5;},'MPlxw':function(_0x3e4dd4,_0x31ff75){return _0x3e4dd4>=_0x31ff75;},'zDMYS':_0x1ca586(0x1b0),'JWraQ':'[BaseClient]\x20Previous\x20summary:','rjnUh':_0x1ca586(0x20c)};logger[_0x1ca586(0x164)](_0x1ca586(0x1f6),{'conversationId':_0x487ed6,'parentMessageId':_0x691d9d});const _0x491cde=await _0x11af84[_0x1ca586(0x278)](getMessages,{'conversationId':_0x487ed6})??[];if(_0x491cde[_0x1ca586(0x23f)]===0x0)return _0x11af84[_0x1ca586(0x23d)](_0x1ca586(0x155),_0x1ca586(0x261))?(_0x11af84['cMmGA'](Function,_0x1ca586(0x20c))(),[]):(new _0x22874f(_0x11af84[_0x1ca586(0x276)])(),this['options'][_0x1ca586(0x178)]['id']);let _0x57615f=null;this[_0x1ca586(0x266)]&&(_0x1ca586(0x175)!==_0x11af84[_0x1ca586(0x171)]?_0x57615f=this['getMessageMapMethod']():_0x16348e[_0x1ca586(0x180)]=_0x3ee1fa[_0x1ca586(0x1c6)][_0x1ca586(0x232)](null,{..._0x27a18d[_0x1ca586(0x253)]??{},'parentMessageId':_0x29e03b[_0x1ca586(0x21c)],'messageId':_0x3b66a7}));let _0x41a590=this[_0x1ca586(0x191)][_0x1ca586(0x184)]({'messages':_0x491cde,'parentMessageId':_0x691d9d,'mapMethod':_0x57615f});_0x41a590=await this[_0x1ca586(0x160)](_0x41a590);if(!this['shouldSummarize'])return new Function(_0x11af84['DijvF'])(),_0x41a590;for(let _0x58354b=_0x11af84[_0x1ca586(0x162)](_0x41a590[_0x1ca586(0x23f)],0x1);_0x11af84[_0x1ca586(0x192)](_0x58354b,0x0);_0x58354b--){if(_0x11af84[_0x1ca586(0x27f)]===_0x11af84[_0x1ca586(0x27f)]){if(_0x41a590[_0x58354b]?.[_0x1ca586(0x21d)]){this[_0x1ca586(0x1ba)]=_0x41a590[_0x58354b];break;}}else{_0x4c179a(_0x11af84['VNCNH'],0x3e8);return;}}if(this['previous_summary']){const {messageId:_0x3f7bbf,summary:_0x4946f3,tokenCount:_0x293ac0,summaryTokenCount:_0x2757a2}=this['previous_summary'];logger[_0x1ca586(0x164)](_0x11af84[_0x1ca586(0x1e1)],{'messageId':_0x3f7bbf,'summary':_0x4946f3,'tokenCount':_0x293ac0,'summaryTokenCount':_0x2757a2});}return Function(_0x11af84[_0x1ca586(0x238)])(),_0x41a590;}async[_0x490429(0x200)](_0x58722f,_0x25922e,_0x21c86a=null){const _0x339890=_0x490429,_0x51518f={'ayzoQ':function(_0x4d6658,_0x2e5613){return _0x4d6658!==_0x2e5613;},'bIqxt':function(_0x24bf0f,_0x37010b,_0x372737,_0x5d1eed){return _0x24bf0f(_0x37010b,_0x372737,_0x5d1eed);},'aodEx':_0x339890(0x16e)};if(this['user']&&_0x51518f['ayzoQ'](_0x21c86a,this['user']))throw new Error(_0x339890(0x217));const _0x26aec9=await saveMessage(this[_0x339890(0x1fc)]['req'],{..._0x58722f,'endpoint':this[_0x339890(0x1fc)][_0x339890(0x1c7)],'unfinished':![],'user':_0x21c86a},{'context':'api/app/clients/BaseClient.js\x20-\x20saveMessageToDatabase\x20#saveMessage'});if(this[_0x339890(0x194)])return setTimeout(_0x339890(0x273),0x3e8),{'message':_0x26aec9};const _0x2240fe=await _0x51518f[_0x339890(0x189)](saveConvo,this['options']['req'],{'conversationId':_0x58722f['conversationId'],'endpoint':this[_0x339890(0x1fc)]['endpoint'],'endpointType':this[_0x339890(0x1fc)][_0x339890(0x190)],..._0x25922e},{'context':_0x51518f['aodEx']});return eval('const _0x3e0ae4 = _0x339890;JSON[_0x3e0ae4(543)]({ \'safe\': !![] });'),{'message':_0x26aec9,'conversation':_0x2240fe};}async[_0x490429(0x169)](_0x24dfe2){const _0x233409=_0x490429;await updateMessage(this[_0x233409(0x1fc)][_0x233409(0x161)],_0x24dfe2);}static[_0x490429(0x184)]({messages:_0x22a0e7,parentMessageId:_0x41d5dd,mapMethod:mapMethod=null,summary:summary=![]}){const _0x56b8b5=_0x490429,_0x4332b4={'tQvuC':function(_0x271f8d,_0x348d79){return _0x271f8d+_0x348d79;},'iCgxe':function(_0x595b90,_0x1d7620){return _0x595b90===_0x1d7620;},'yqZcS':function(_0x51cfe6,_0x284fd0){return _0x51cfe6!==_0x284fd0;},'RwDil':'SBdfw','Dtgit':'mLHYc','zmoCi':'AsHUP','IvXjH':'return\x20new\x20Date();'};if(!_0x22a0e7||_0x4332b4[_0x56b8b5(0x1f8)](_0x22a0e7['length'],0x0)){if(_0x4332b4['yqZcS'](_0x4332b4[_0x56b8b5(0x1fa)],_0x56b8b5(0x247)))_0x5b4ef4[_0x56b8b5(0x1c4)](_0x3c63fe[_0x56b8b5(0x1c1)]);else return setInterval(_0x56b8b5(0x15c),0x3e8),[];}const _0x382c22=[];let _0x15d401=_0x41d5dd;const _0x1ca667=new Set();while(_0x15d401){if(_0x1ca667[_0x56b8b5(0x1d7)](_0x15d401)){if(_0x4332b4[_0x56b8b5(0x249)](_0x4332b4['Dtgit'],_0x56b8b5(0x1e9)))break;else{_0x3855b3(_0x56b8b5(0x1de))();return;}}const _0x550665=_0x22a0e7['find'](_0x15ca11=>{const _0x55986f=_0x15ca11['messageId']??_0x15ca11['id'];return eval('const _0x416ac1 = _0x2811;_0x4332b4[_0x416ac1(425)](1, 1);'),_0x55986f===_0x15d401;});_0x1ca667['add'](_0x15d401);if(!_0x550665)break;summary&&_0x550665[_0x56b8b5(0x21d)]&&(_0x550665[_0x56b8b5(0x157)]='system',_0x550665[_0x56b8b5(0x193)]=_0x550665[_0x56b8b5(0x21d)]);summary&&_0x550665[_0x56b8b5(0x27a)]&&(_0x550665[_0x56b8b5(0x197)]=_0x550665[_0x56b8b5(0x27a)]);_0x382c22['push'](_0x550665);if(summary&&_0x550665[_0x56b8b5(0x21d)]){if(_0x4332b4['zmoCi']===_0x56b8b5(0x186))_0x52fba0[_0x56b8b5(0x197)]=this['getTokenCountForResponse'](_0x585671),_0x57cc00=this[_0x56b8b5(0x1c9)](_0x183ad1);else break;}_0x15d401=_0x550665['parentMessageId']===Constants[_0x56b8b5(0x219)]?null:_0x550665[_0x56b8b5(0x236)];}_0x382c22['reverse']();if(mapMethod)return eval('Math[\'PI\'] * 2;'),_0x382c22[_0x56b8b5(0x1a8)](mapMethod);return Function(_0x4332b4[_0x56b8b5(0x198)])(),_0x382c22;}['getTokenCountForMessage'](_0x4438ac){const _0x4ea8a8=_0x490429,_0x3a5f58={'cnUzh':'blVVL','vQkXR':function(_0x119a25,_0x490b14){return _0x119a25===_0x490b14;},'MMmwi':_0x4ea8a8(0x1cd),'DLrod':_0x4ea8a8(0x1bd),'UpdDb':_0x4ea8a8(0x269),'SjkSe':'boolean','EtRxM':function(_0x4ccc24,_0x5c5ff7){return _0x4ccc24===_0x5c5ff7;},'wbxtt':_0x4ea8a8(0x23e),'DwhuP':function(_0x2f945f,_0x32f0d1){return _0x2f945f(_0x32f0d1);}};let _0x4c5824=0x3,_0x43d7fd=0x1;_0x3a5f58['EtRxM'](this[_0x4ea8a8(0x1b3)][_0x4ea8a8(0x16d)],_0x4ea8a8(0x25e))&&(_0x3a5f58[_0x4ea8a8(0x1d2)](_0x3a5f58[_0x4ea8a8(0x1d5)],_0x4ea8a8(0x1e2))?_0x318789['PI']*0x2:(_0x4c5824=0x4,_0x43d7fd=-0x1));const _0x2d6574=_0xc2c955=>{const _0x21a5bb=_0x4ea8a8;if(Array[_0x21a5bb(0x1c5)](_0xc2c955))for(let _0x3d0e67 of _0xc2c955){if(_0x3a5f58[_0x21a5bb(0x1e6)]!==_0x21a5bb(0x24b))_0x57b4c8+=this[_0x21a5bb(0x1c9)](_0x4bf5d7[_0x21a5bb(0x1cf)]());else{if(!_0x3d0e67||!_0x3d0e67[_0x21a5bb(0x239)]||_0x3a5f58[_0x21a5bb(0x1ed)](_0x3d0e67[_0x21a5bb(0x239)],_0x3a5f58[_0x21a5bb(0x20b)]))continue;const _0x439b18=_0x3d0e67[_0x3d0e67[_0x21a5bb(0x239)]];if(!_0x439b18)continue;_0x2d6574(_0x439b18);}}else{if(typeof _0xc2c955===_0x3a5f58[_0x21a5bb(0x167)])_0x458961+=this[_0x21a5bb(0x1c9)](_0xc2c955);else{if(typeof _0xc2c955===_0x3a5f58[_0x21a5bb(0x225)])_0x458961+=this[_0x21a5bb(0x1c9)](_0xc2c955[_0x21a5bb(0x1cf)]());else typeof _0xc2c955===_0x3a5f58[_0x21a5bb(0x22e)]&&(_0x458961+=this[_0x21a5bb(0x1c9)](_0xc2c955[_0x21a5bb(0x1cf)]()));}}};let _0x458961=_0x4c5824;for(let [_0x76b352,_0x40583e]of Object[_0x4ea8a8(0x1af)](_0x4438ac)){_0x3a5f58[_0x4ea8a8(0x258)](_0x2d6574,_0x40583e),_0x3a5f58[_0x4ea8a8(0x1ed)](_0x76b352,_0x4ea8a8(0x203))&&(_0x458961+=_0x43d7fd);}return eval('Math[\'PI\'] * 2;'),_0x458961;}async[_0x490429(0x16f)](_0x45871e,_0x5cf810={}){const _0x4e977d=_0x490429;return _0x5cf810&&typeof _0x5cf810===_0x4e977d(0x188)&&this[_0x4e977d(0x221)](_0x5cf810),Function('return\x20Object.keys({a:1});')(),await this[_0x4e977d(0x1d9)](_0x45871e,_0x5cf810);}async[_0x490429(0x160)](_0x3b0162){const _0x327931=_0x490429,_0x3a7fcc={'vjKgt':function(_0x4db26d,_0x524051){return _0x4db26d(_0x524051);},'iaSRk':function(_0x1e5736,_0x4a6315){return _0x1e5736===_0x4a6315;},'ahvaZ':function(_0x1e0293,_0x383691,_0x160362){return _0x1e0293(_0x383691,_0x160362);},'GSELF':'var\x20x\x20=\x2042;\x20return\x20x;','ChPvO':function(_0xdfec10,_0x1bc664){return _0xdfec10!==_0x1bc664;},'TvslZ':_0x327931(0x1fb),'VeFtZ':_0x327931(0x15e),'sTVpD':function(_0x3d1136,_0x2ad603){return _0x3d1136(_0x2ad603);},'pXkkC':function(_0x57f82b,_0x5ab771,_0x4e71bb){return _0x57f82b(_0x5ab771,_0x4e71bb);}};if(!this[_0x327931(0x1fc)][_0x327931(0x252)])return new Function(_0x3a7fcc[_0x327931(0x233)])(),_0x3b0162;const _0x446a2a=new Set(),_0xfd226e=this[_0x327931(0x1fc)][_0x327931(0x1dc)]&&!(this[_0x327931(0x1fc)][_0x327931(0x1dc)]instanceof Promise);if(_0xfd226e)for(const _0x11bd5b of this['options'][_0x327931(0x1dc)]){if(_0x3a7fcc[_0x327931(0x156)](_0x327931(0x1c2),_0x3a7fcc[_0x327931(0x1f4)]))_0x446a2a[_0x327931(0x1c4)](_0x11bd5b[_0x327931(0x1c1)]);else return eval('_0x18943b[\'PI\'] * 2;'),_0x2a995d;}const _0x21d441=async _0x55d6be=>{const _0x27ae0e=_0x327931;!this[_0x27ae0e(0x163)]&&(this[_0x27ae0e(0x163)]={});const _0x187124=[];for(const _0x50aa40 of _0x55d6be[_0x27ae0e(0x19a)]){if(_0x3a7fcc['iaSRk'](_0x27ae0e(0x15d),_0x27ae0e(0x15d))){if(_0x446a2a[_0x27ae0e(0x1d7)](_0x50aa40[_0x27ae0e(0x1c1)]))continue;_0x187124[_0x27ae0e(0x1a1)](_0x50aa40[_0x27ae0e(0x1c1)]),_0x446a2a[_0x27ae0e(0x1c4)](_0x50aa40['file_id']);}else _0x1f1fe2['text']=_0x3a7fcc[_0x27ae0e(0x26e)](_0x3a2c19,_0xfeb18b)+_0x4f795e;}if(_0x187124[_0x27ae0e(0x23f)]===0x0)return new Function(_0x27ae0e(0x1ff))(),_0x55d6be;const _0x180c21=await getFiles({'file_id':{'$in':_0x187124}});return await this['addImageURLs'](_0x55d6be,_0x180c21),this['message_file_map'][_0x55d6be[_0x27ae0e(0x21c)]]=_0x180c21,_0x3a7fcc[_0x27ae0e(0x22c)](setInterval,_0x27ae0e(0x15c),0x3e8),_0x55d6be;},_0x58e898=[];for(const _0x5775cf of _0x3b0162){if(_0x327931(0x25a)===_0x3a7fcc['VeFtZ'])return _0x35e842(_0x327931(0x1de))(),{'messageId':_0x1dadeb,'parentMessageId':_0xea08e0,'conversationId':_0x48598e,'sender':_0x327931(0x159),'text':_0x14005b,'isCreatedByUser':!![]};else{if(!_0x5775cf[_0x327931(0x19a)]){_0x58e898[_0x327931(0x1a1)](_0x5775cf);continue;}_0x58e898['push'](_0x3a7fcc[_0x327931(0x26a)](_0x21d441,_0x5775cf));}}const _0x28e844=await Promise['all'](_0x58e898);return this[_0x327931(0x259)](Object['values'](this['message_file_map']??{})[_0x327931(0x1a6)]()),_0x3a7fcc[_0x327931(0x210)](setTimeout,function(){const _0x54152c=_0x327931;console[_0x54152c(0x22a)](_0x54152c(0x25c));},0x64),_0x28e844;}}module[_0x490429(0x1e8)]=BaseClient;