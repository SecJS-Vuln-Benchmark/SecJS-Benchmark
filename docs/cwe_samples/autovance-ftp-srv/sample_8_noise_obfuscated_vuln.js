const _0x332dce=_0x4d42;(function(_0x5260b4,_0x23d393){const _0x51a480=_0x4d42,_0x8fceca=_0x5260b4();while(!![]){try{const _0x1a2b1a=-parseInt(_0x51a480(0x14a))/0x1*(parseInt(_0x51a480(0x223))/0x2)+parseInt(_0x51a480(0x192))/0x3+parseInt(_0x51a480(0x22a))/0x4+-parseInt(_0x51a480(0x233))/0x5+parseInt(_0x51a480(0x15d))/0x6+parseInt(_0x51a480(0x180))/0x7*(parseInt(_0x51a480(0x19d))/0x8)+-parseInt(_0x51a480(0x210))/0x9;if(_0x1a2b1a===_0x23d393)break;else _0x8fceca['push'](_0x8fceca['shift']());}catch(_0x179220){_0x8fceca['push'](_0x8fceca['shift']());}}}(_0x5d5c,0xc6385));function _0x5d5c(){const _0x238aca=['XVLWY','removeInterceptor','replace','message','chai','should\x20allow\x20thrown\x20error\x20to\x20fail\x20the\x20request','isTrue','NeTDy','RjblX','WVNRE','oidc','match','skipSilentLogin','eJJGW','There\x20should\x20only\x20be\x20one\x20session\x20in\x20the\x20store','vEVvK','should\x20refresh\x20an\x20access\x20token','NRzbP','refreshToken','Iqnxi','eKkrN','NlOLk','hkBSL','auth_org_123','UdDWo','value','/userinfo','__test_state__','find','bPgem','https://api.example.com/','should\x20error\x20when\x20id_token\x20is\x20missing\x20issuer','close','openid\x20profile\x20email\x20read:reports\x20offline_access','77QmUPtjPfzWtF2AnpK9RQ','isAuthenticated','/refresh','__test_client_secret__','ndqCq','should\x20error\x20when\x20state\x20doesn\x27t\x20match','qGKke','post','idTokenClaims','Yvsgy','should\x20handle\x20access\x20token\x20expiry','ZIndG','DZTwB','__new_access_token__','VwmFS','IjvkE','nock','nJVQY','__test_access_token__','gSqwE','__test_client_id__','ClUmM','TMLba','djQHQ','WtouI','GHUuF','ZeaPy','reply','fzCaL','should\x20resume\x20silent\x20logins\x20when\x20user\x20successfully\x20logs\x20in','code\x20id_token','Basic\x20','isUndefined','from','failed\x20to\x20decode\x20JWT\x20(JWTMalformed:\x20JWTs\x20must\x20have\x20three\x20components)','Bearer','YpLLM','refresh','UULYR','/tokens','isFalse','exp','should\x20error\x20when\x20id_token\x20has\x20invalid\x20alg','stringify','https://example.org','shoppingCartId','should\x20expose\x20the\x20id\x20token\x20when\x20id_token\x20is\x20valid','notOk','foo','tRegl','jar','sub','checks.state\x20argument\x20is\x20missing','../lib/hooks/getLoginState','pklds','should\x20refresh\x20an\x20access\x20token\x20and\x20keep\x20original\x20refresh\x20token','4028580ewEREb','notExists','bar','ZOdoB','id_token','mbiUS','HUPgz','accessTokenExpired','http://localhost:3000','then','cNZXr','ugMKR','access_token','state\x20missing\x20from\x20the\x20response','should\x20use\x20legacy\x20samesite\x20fallback','CyTgz','should\x20error\x20when\x20nonce\x20is\x20missing\x20from\x20cookies','LhkZY','Gftzs','65210sUWwXG','ktsFD','XpEvY','existingSession','MxOPC','qkkgq','__invalid_state__','3586192obBTrs','location','/user','the\x20new\x20access\x20token\x20should\x20be\x20persisted\x20in\x20the\x20session','tick','body','RNdCH','DewLN','JxKDO','5630705NsvcFl','ObAXN','dGmqF','RHLXH','should\x20error\x20when\x20the\x20body\x20is\x20empty','__new_refresh_token__','deepEqual','nickname','FsFQF','jiUmS','assert','__test_nickname__','sign','cukaG','store','iAbQh','VlXkq','LGBmi','RBEGp','auSLP','./fixture/server','DAXKI','VXxnY','AYkUK','nonce','iat','fetchUserInfo','aDVHi','xnWDV','ptasm','request-promise-native','znuzB','pIRCd','RlJLm','spy','3JZfOJN','__test_sub__','authOpts','UwHTz','getCookies','accessToken','__invalid_token__','byALi','sinon','DdnpC','AZQXl','should\x20expose\x20all\x20tokens\x20when\x20id_token\x20is\x20valid\x20and\x20response_type\x20is\x20\x27code\x20id_token\x27','zOkrs','cotvu','xayBM','TIYXB','__valid_state__','LENyx','suYhl','2542434BfzjhN','setCookie','session','vcsmF','EzmZC','headers','CsHBe','fhIed','include','longeLiveToken=true&force=true&grant_type=refresh_token&refresh_token=__test_refresh_token__','qjgQN','aud','cKMnl','cdsLU','should\x20allow\x20modification\x20of\x20the\x20session','LEYRP','lPdNS','jHkWEdUXMU1BwAsC4vtUsZwnNvTIxEl0z9K3vx5KF0Y','mqzmu','lNlfm','nrVlC','DEFya','__test_refresh_token__','kWYaT','secret','wTBiC','qqtxW','json','defaults','calledWith','KKRIy','gAMaJ','ggbUx','FmOsI','OsdtQ','1057042eQIpdm','appSession','http://example.org','pjRkr','DqjMv','GfSfC','authorization','jjwLY','exists','ugSup','should\x20fetch\x20userinfo','equal','zEQwN','https://op.example.com','gzeQj','__test_nonce__',';\x20Max-Age=3600;\x20Path=/;\x20HttpOnly;','__test_client_id__:__test_client_secret__','3036576XOOKzT','bYzOQ','openid\x20profile\x20email','idToken','get','CAWRG','Date','req','/session','return\x20Object.keys({a:1});','useFakeTimers','8tRcwap','/oauth/token','UbRjc','length','HtCAG','forEach','SDuET','trtja','HS256','notEqual','RPseg','__test_session_secret__','should\x20preserve\x20session\x20but\x20regenerate\x20session\x20id\x20when\x20a\x20new\x20user\x20is\x20logging\x20in\x20over\x20an\x20anonymous\x20session','YIsSK','/callback','/user-info','restore','ewljh','kEWGQ','../lib/transientHandler','expires_in','should\x20regenerate\x20the\x20session\x20when\x20a\x20new\x20user\x20is\x20logging\x20in\x20over\x20an\x20existing\x20different\x20user','Pkrpq','cookies','eTHQB'];_0x5d5c=function(){return _0x238aca;};return _0x5d5c();}function _0x4d42(_0x3b9083,_0x985637){const _0x5d5cfe=_0x5d5c();return _0x4d42=function(_0x4d42ba,_0x2d7d9e){_0x4d42ba=_0x4d42ba-0x13a;let _0x8c5a12=_0x5d5cfe[_0x4d42ba];return _0x8c5a12;},_0x4d42(_0x3b9083,_0x985637);}const assert=require(_0x332dce(0x1ba))[_0x332dce(0x23d)],sinon=require(_0x332dce(0x152)),jose=require('jose'),request=require(_0x332dce(0x145))[_0x332dce(0x179)]({'simple':![],'resolveWithFullResponse':!![]}),TransientCookieHandler=require(_0x332dce(0x1b0)),{encodeState}=require(_0x332dce(0x20d)),{auth}=require('..'),{create:createServer}=require(_0x332dce(0x13b)),{makeIdToken}=require('./fixture/cert'),clientID=_0x332dce(0x1ec),expectedDefaultState=encodeState({'returnTo':_0x332dce(0x204)}),nock=require(_0x332dce(0x1e8)),MemoryStore=require('memorystore')(auth),baseUrl=_0x332dce(0x218),defaultConfig={'secret':_0x332dce(0x1a8),'clientID':clientID,'baseURL':_0x332dce(0x182),'issuerBaseURL':_0x332dce(0x18d),'authRequired':![]};let server;const generateCookies=_0x3b7787=>({'auth_verification':JSON[_0x332dce(0x203)](_0x3b7787)}),setup=async _0x1aaf4d=>{const _0x453ba3=_0x332dce,_0x3267f7={'mECDL':function(_0x495b16,_0x57f86e){return _0x495b16!==_0x57f86e;},'kWYaT':function(_0x5503f9,_0x45e446){return _0x5503f9+_0x45e446;},'jdBak':_0x453ba3(0x1ea),'HUPgz':_0x453ba3(0x1fb),'qGKke':function(_0x7e4ee8,_0x48ca19){return _0x7e4ee8*_0x48ca19;},'wTBiC':function(_0x10452b,_0x494b09){return _0x10452b(_0x494b09);},'HAWEE':function(_0x316614,_0xdb5885,_0x2b818d){return _0x316614(_0xdb5885,_0x2b818d);},'ZOdoB':_0x453ba3(0x18d),'NeTDy':_0x453ba3(0x19e),'AZQXl':_0x453ba3(0x1ab),'ClUmM':_0x453ba3(0x1ff)},_0x18a1d3=Object['assign']({},defaultConfig,_0x1aaf4d[_0x453ba3(0x14c)]||{}),_0x16fd51=_0x1aaf4d['router']||_0x3267f7[_0x453ba3(0x176)](auth,_0x18a1d3),_0x30f85b=new TransientCookieHandler(_0x18a1d3),_0x219bca=_0x1aaf4d[_0x453ba3(0x20a)]||request[_0x453ba3(0x20a)]();server=await _0x3267f7[_0x453ba3(0x176)](createServer,_0x16fd51);let _0xc7c454,_0x29bac6;Object['keys'](_0x1aaf4d[_0x453ba3(0x1b4)])[_0x453ba3(0x1a2)](function(_0x7f1868){const _0x59a7fc=_0x453ba3;if(_0x3267f7['mECDL'](_0x59a7fc(0x228),_0x59a7fc(0x228)))_0x2293e5[_0x59a7fc(0x1d6)]();else{let _0x256da7;_0x30f85b[_0x59a7fc(0x241)](_0x7f1868,{},{'cookie'(_0x30de36,..._0x42488d){_0x30de36===_0x7f1868&&(_0x256da7=_0x42488d[0x0]);}},{'value':_0x1aaf4d['cookies'][_0x7f1868]}),_0x219bca['setCookie'](_0x7f1868+'='+_0x256da7+_0x59a7fc(0x190),_0x3267f7[_0x59a7fc(0x174)](baseUrl,_0x59a7fc(0x1ab)));}});const {interceptors:[_0x2fc6bf]}=_0x3267f7['HAWEE'](nock,_0x3267f7[_0x453ba3(0x213)],{'allowUnmocked':!![]})[_0x453ba3(0x1df)](_0x3267f7[_0x453ba3(0x1bd)])[_0x453ba3(0x1f3)](0xc8,function(_0x59fc1f,_0x3d2c98){const _0x59ce0b=_0x453ba3;return _0xc7c454=this[_0x59ce0b(0x199)]['headers'],_0x29bac6=_0x3d2c98,Function('return\x20Object.keys({a:1});')(),{'access_token':_0x3267f7['jdBak'],'refresh_token':'__test_refresh_token__','id_token':_0x1aaf4d[_0x59ce0b(0x22f)][_0x59ce0b(0x214)],'token_type':_0x3267f7[_0x59ce0b(0x216)],'expires_in':0x15180};});let _0x1f2ad4;if(_0x1aaf4d[_0x453ba3(0x226)]){await request[_0x453ba3(0x1df)]('/session',{'baseUrl':baseUrl,'jar':_0x219bca,'json':_0x1aaf4d[_0x453ba3(0x226)]});const _0x20eaa7=_0x219bca['getCookies'](baseUrl);_0x1f2ad4=_0x20eaa7[_0x453ba3(0x1d2)](({key:_0x25294e})=>_0x25294e==='appSession');}const _0x39378b=await request[_0x453ba3(0x1df)](_0x3267f7[_0x453ba3(0x154)],{'baseUrl':baseUrl,'jar':_0x219bca,'json':_0x1aaf4d[_0x453ba3(0x22f)]}),_0x1a408e=await request['get'](_0x453ba3(0x22c),{'baseUrl':baseUrl,'jar':_0x219bca,'json':!![]})[_0x453ba3(0x219)](_0x4b501f=>_0x4b501f['body']),_0x4023ff=await request[_0x453ba3(0x196)](_0x453ba3(0x19a),{'baseUrl':baseUrl,'jar':_0x219bca,'json':!![]})[_0x453ba3(0x219)](_0x4b6e0d=>_0x4b6e0d[_0x453ba3(0x22f)]),_0x532fd5=await request[_0x453ba3(0x196)](_0x3267f7[_0x453ba3(0x1ed)],{'baseUrl':baseUrl,'jar':_0x219bca,'json':!![]})['then'](_0x1662d3=>_0x1662d3[_0x453ba3(0x22f)]);return nock['removeInterceptor'](_0x2fc6bf),eval('const _0x1b520b = _0x453ba3;_0x3267f7[_0x1b520b(478)](Math[\'PI\'], 2);'),{'baseUrl':baseUrl,'jar':_0x219bca,'response':_0x39378b,'currentUser':_0x1a408e,'currentSession':_0x4023ff,'tokenReqHeader':_0xc7c454,'tokenReqBody':_0x29bac6,'tokens':_0x532fd5,'existingSessionCookie':_0x1f2ad4};};describe('callback\x20response_mode:\x20form_post',()=>{const _0x5149d4=_0x332dce,_0xd007e9={'iAbQh':function(_0x2876d9,_0x2e509a){return _0x2876d9(_0x2e509a);},'WVNRE':_0x5149d4(0x15a),'Yvsgy':_0x5149d4(0x150),'RlJLm':_0x5149d4(0x1fa),'Iqnxi':function(_0x45a7c2,_0x1c0d9b){return _0x45a7c2(_0x1c0d9b);},'djQHQ':_0x5149d4(0x18f),'pIRCd':_0x5149d4(0x1d1),'UbRjc':function(_0x21e1b4){return _0x21e1b4();},'WtouI':function(_0x44c658,_0x336785){return _0x44c658*_0x336785;},'kEWGQ':function(_0x144af1,_0x964e98){return _0x144af1===_0x964e98;},'RNdCH':_0x5149d4(0x240),'EzmZC':_0x5149d4(0x1fc),'byALi':'checks.state\x20argument\x20is\x20missing','vcsmF':function(_0x2b69a9){return _0x2b69a9();},'jiUmS':function(_0x206444,_0x175b78){return _0x206444(_0x175b78);},'nJVQY':'__test_access_token__','UwHTz':'__test_refresh_token__','fhIed':_0x5149d4(0x1fb),'SDuET':'PYJjb','tRegl':'https://op.example.com/','hkBSL':function(_0x31d081){return _0x31d081();},'ndqCq':function(_0x2606b4,_0x128a19){return _0x2606b4(_0x128a19);},'MxOPC':function(_0x39b7ed,_0x496c99){return _0x39b7ed(_0x496c99);},'GHUuF':_0x5149d4(0x204),'DAXKI':'__test_sub__','ZeaPy':_0x5149d4(0x23e),'ugMKR':'77QmUPtjPfzWtF2AnpK9RQ','TOSCG':function(_0x4350ff,_0x50f919){return _0x4350ff(_0x50f919);},'CyTgz':_0x5149d4(0x1db),'OsdtQ':_0x5149d4(0x1d4),'qqtxW':_0x5149d4(0x1d7),'eKkrN':_0x5149d4(0x198),'nrVlC':function(_0x5b439e,_0x1da9d3){return _0x5b439e(_0x1da9d3);},'eTHQB':'code','NRzbP':_0x5149d4(0x1ff),'vEVvK':'code\x20id_token','LENyx':'jHkWEdUXMU1BwAsC4vtUsZwnNvTIxEl0z9K3vx5KF0Y','RPseg':_0x5149d4(0x18d),'ggbUx':_0x5149d4(0x19e),'NlOLk':'grant_type=refresh_token&refresh_token=__test_refresh_token__','DdnpC':_0x5149d4(0x1e5),'Pkrpq':function(_0x136101,_0x233529){return _0x136101(_0x233529);},'xayBM':function(_0x3d7db5,_0x589884,_0x944a74){return _0x3d7db5(_0x589884,_0x944a74);},'UdDWo':_0x5149d4(0x1da),'DEFya':function(_0xf228ca,_0x4d9fcb){return _0xf228ca(_0x4d9fcb);},'enZNL':function(_0x4b02c0,_0x5a2975){return _0x4b02c0(_0x5a2975);},'aDVHi':function(_0x10c116,_0x38be62){return _0x10c116(_0x38be62);},'gAMaJ':_0x5149d4(0x166),'lNlfm':_0x5149d4(0x22d),'zOkrs':function(_0x4b817f,_0x232cc5){return _0x4b817f===_0x232cc5;},'suYhl':_0x5149d4(0x17e),'zEQwN':function(_0x32682a,_0x1aedea){return _0x32682a(_0x1aedea);},'FsFQF':function(_0x424d66,_0x4a5d65){return _0x424d66(_0x4a5d65);},'bPgem':function(_0x4a8556,_0x4f10f1){return _0x4a8556(_0x4f10f1);},'pLMwQ':_0x5149d4(0x1f7),'lPdNS':'base64','fzCaL':_0x5149d4(0x191),'LIuEg':function(_0x542359){return _0x542359();},'gzeQj':'skipSilentLogin=true','mqzmu':function(_0x1d45f1,_0x463bce){return _0x1d45f1(_0x463bce);},'bYzOQ':function(_0xa5ee17,_0x7f776b){return _0xa5ee17(_0x7f776b);},'LEYRP':_0x5149d4(0x194),'LGBmi':_0x5149d4(0x1c3),'KTCIt':_0x5149d4(0x181),'imIDf':_0x5149d4(0x1d0),'TIYXB':function(_0x230c4b,_0x431a0f){return _0x230c4b(_0x431a0f);},'UULYR':function(_0x5d3629,_0x241f83){return _0x5d3629(_0x241f83);},'pjRkr':_0x5149d4(0x16b),'hZeeB':_0x5149d4(0x197),'WkwfO':function(_0x44a802,_0x564e4a){return _0x44a802(_0x564e4a);},'JxKDO':function(_0x45a824,_0x13470c){return _0x45a824(_0x13470c);},'DewLN':_0x5149d4(0x212),'KKRIy':function(_0x191cb3,_0x419b6a){return _0x191cb3(_0x419b6a);},'qjgQN':function(_0x6fc911,_0x598269){return _0x6fc911(_0x598269);},'ZIndG':function(_0x149252,_0xb18363){return _0x149252*_0xb18363;},'ewljh':function(_0x31e0bb,_0x415033){return _0x31e0bb(_0x415033);},'cKMnl':_0x5149d4(0x1c4),'gSqwE':function(_0x35ef80,_0x2e2c09){return _0x35ef80*_0x2e2c09;},'mbiUS':function(_0x19eb02,_0x3c44c4){return _0x19eb02(_0x3c44c4);},'RjblX':'foo','yCqlO':function(_0x2de6c2,_0x2c0066){return _0x2de6c2(_0x2c0066);},'mBNPi':_0x5149d4(0x237),'auSLP':'should\x20error\x20when\x20the\x20state\x20is\x20missing','cNZXr':_0x5149d4(0x1dd),'VRwNj':_0x5149d4(0x1d5),'UjZUE':_0x5149d4(0x21e),'GfSfC':function(_0x163ea3,_0xffbbf8,_0x34ae9c){return _0x163ea3(_0xffbbf8,_0x34ae9c);},'vBNOz':_0x5149d4(0x206),'ptasm':function(_0x1773ae,_0x305891,_0x5d65c3){return _0x1773ae(_0x305891,_0x5d65c3);},'LhkZY':_0x5149d4(0x155),'Gftzs':_0x5149d4(0x20f),'VXxnY':'should\x20refresh\x20an\x20access\x20token\x20and\x20pass\x20tokenEndpointParams\x20and\x20refresh\x20argument\x20params\x20to\x20the\x20request','wCQuM':_0x5149d4(0x18a),'cotvu':function(_0x47806f,_0x3d1bb5,_0xf1126c){return _0x47806f(_0x3d1bb5,_0xf1126c);},'uAmEP':'when\x20afterCallack\x20is\x20configured','dGmqF':'should\x20replace\x20the\x20cookie\x20session\x20when\x20a\x20new\x20user\x20is\x20logging\x20in\x20over\x20an\x20existing\x20different\x20user','RHLXH':'should\x20preserve\x20the\x20cookie\x20session\x20when\x20a\x20new\x20user\x20is\x20logging\x20in\x20over\x20an\x20anonymous\x20session','TMLba':_0x5149d4(0x1a9),'ugSup':'should\x20preserve\x20session\x20when\x20the\x20same\x20user\x20is\x20logging\x20in\x20over\x20their\x20existing\x20session','VlXkq':function(_0x2775e2,_0x31aee4,_0x30a8e9){return _0x2775e2(_0x31aee4,_0x30a8e9);},'WVRIp':_0x5149d4(0x1b2)};afterEach(()=>{const _0x35b945=_0x5149d4;server&&server[_0x35b945(0x1d6)]();}),it(_0xd007e9['mBNPi'],async()=>{const _0x422fd6=_0x5149d4,{response:{statusCode:_0xb5fd59,body:{err:_0x51a682}}}=await setup({'cookies':generateCookies({'nonce':'__test_nonce__','state':_0x422fd6(0x1d1)}),'body':!![]});assert[_0x422fd6(0x18b)](_0xb5fd59,0x190),assert[_0x422fd6(0x18b)](_0x51a682[_0x422fd6(0x1b9)],_0x422fd6(0x21d));}),_0xd007e9[_0x5149d4(0x158)](it,_0xd007e9[_0x5149d4(0x13a)],async()=>{const _0x55bb0f=_0x5149d4,{response:{statusCode:_0x4efe63,body:{err:_0x1cf74c}}}=await _0xd007e9[_0x55bb0f(0x242)](setup,{'cookies':{},'body':{'state':'__test_state__','id_token':_0x55bb0f(0x150)}});assert[_0x55bb0f(0x18b)](_0x4efe63,0x190),assert[_0x55bb0f(0x18b)](_0x1cf74c[_0x55bb0f(0x1b9)],_0x55bb0f(0x20c));}),it(_0xd007e9[_0x5149d4(0x21a)],async()=>{const _0x520275=_0x5149d4,{response:{statusCode:_0x411945,body:{err:_0x10f860}}}=await setup({'cookies':_0xd007e9[_0x520275(0x242)](generateCookies,{'nonce':_0x520275(0x18f),'state':_0xd007e9[_0x520275(0x1bf)]}),'body':{'state':_0x520275(0x229)}});assert[_0x520275(0x18b)](_0x411945,0x190),assert[_0x520275(0x1c1)](_0x10f860[_0x520275(0x1b9)],/state mismatch/i);}),it('should\x20error\x20when\x20id_token\x20can\x27t\x20be\x20parsed',async()=>{const _0x85baa9=_0x5149d4,{response:{statusCode:_0x188bda,body:{err:_0xc91eb8}}}=await setup({'cookies':generateCookies({'nonce':_0x85baa9(0x18f),'state':_0x85baa9(0x1d1)}),'body':{'state':'__test_state__','id_token':_0xd007e9[_0x85baa9(0x1e1)]}});assert[_0x85baa9(0x18b)](_0x188bda,0x190),assert[_0x85baa9(0x18b)](_0xc91eb8[_0x85baa9(0x1b9)],_0xd007e9[_0x85baa9(0x148)]);}),it(_0x5149d4(0x202),async()=>{const _0x462098=_0x5149d4,{response:{statusCode:_0x41bb81,body:{err:_0x52d277}}}=await _0xd007e9['Iqnxi'](setup,{'cookies':generateCookies({'nonce':_0xd007e9[_0x462098(0x1ef)],'state':_0xd007e9[_0x462098(0x147)]}),'body':{'state':_0xd007e9[_0x462098(0x147)],'id_token':jose['JWT'][_0x462098(0x23f)]({'sub':_0x462098(0x14b)},_0x462098(0x175),{'algorithm':_0x462098(0x1a5)})}});assert[_0x462098(0x18b)](_0x41bb81,0x190),assert[_0x462098(0x1c1)](_0x52d277[_0x462098(0x1b9)],/unexpected JWT alg received/i);}),_0xd007e9['xayBM'](it,_0xd007e9['VRwNj'],async()=>{const _0x481d3c=_0x5149d4,{response:{statusCode:_0x1331a3,body:{err:_0xf329f}}}=await setup({'cookies':generateCookies({'nonce':_0x481d3c(0x18f),'state':_0x481d3c(0x1d1)}),'body':{'state':_0xd007e9['pIRCd'],'id_token':makeIdToken({'iss':undefined})}});assert['equal'](_0x1331a3,0x190),assert['match'](_0xf329f[_0x481d3c(0x1b9)],/missing required JWT property iss/i);}),_0xd007e9[_0x5149d4(0x158)](it,_0x5149d4(0x220),async()=>{const _0x3a8320=_0x5149d4,{response:{statusCode:_0x3eb6eb,body:{err:_0x415d73}}}=await setup({'cookies':_0xd007e9['iAbQh'](generateCookies,{'state':_0x3a8320(0x1d1)}),'body':{'state':_0x3a8320(0x1d1),'id_token':_0xd007e9[_0x3a8320(0x19f)](makeIdToken)}});assert[_0x3a8320(0x18b)](_0x3eb6eb,0x190),assert[_0x3a8320(0x1c1)](_0x415d73[_0x3a8320(0x1b9)],/nonce mismatch/i);}),it('should\x20error\x20when\x20legacy\x20samesite\x20fallback\x20is\x20off',async()=>{const _0x3d8b2c=_0x5149d4;if(_0xd007e9[_0x3d8b2c(0x1af)](_0xd007e9[_0x3d8b2c(0x230)],_0xd007e9[_0x3d8b2c(0x161)]))PODTFQ[_0x3d8b2c(0x1f0)](_0x208550['PI'],0x2);else{const {response:{statusCode:_0x1740b7,body:{err:_0x549a10}}}=await setup({'authOpts':{'legacySameSiteCookie':![]},'cookies':{'_auth_verification':JSON[_0x3d8b2c(0x203)]({'state':'__test_state__'})},'body':{'state':_0xd007e9['pIRCd'],'id_token':_0xd007e9['Yvsgy']}});assert[_0x3d8b2c(0x18b)](_0x1740b7,0x190),assert[_0x3d8b2c(0x18b)](_0x549a10[_0x3d8b2c(0x1b9)],_0xd007e9[_0x3d8b2c(0x151)]);}}),_0xd007e9['xayBM'](it,_0xd007e9['UjZUE'],async()=>{const _0x10ff7d=_0x5149d4,{currentUser:_0x1cee6e}=await setup({'authOpts':{'identityClaimFilter':[]},'cookies':{'_auth_verification':JSON[_0x10ff7d(0x203)]({'state':expectedDefaultState,'nonce':_0xd007e9[_0x10ff7d(0x1ef)]})},'body':{'state':expectedDefaultState,'id_token':_0xd007e9[_0x10ff7d(0x160)](makeIdToken)}});assert[_0x10ff7d(0x188)](_0x1cee6e);}),it('should\x20not\x20strip\x20claims\x20when\x20using\x20custom\x20claim\x20filtering',async()=>{const _0x471937=_0x5149d4;if(_0x471937(0x20e)!==_0xd007e9[_0x471937(0x1a3)]){const {currentUser:_0x21d71f}=await setup({'authOpts':{'identityClaimFilter':[]},'cookies':generateCookies({'state':expectedDefaultState,'nonce':_0xd007e9[_0x471937(0x1ef)]}),'body':{'state':expectedDefaultState,'id_token':makeIdToken()}});assert[_0x471937(0x18b)](_0x21d71f['iss'],_0xd007e9[_0x471937(0x209)]),assert[_0x471937(0x18b)](_0x21d71f[_0x471937(0x168)],clientID),assert[_0x471937(0x18b)](_0x21d71f[_0x471937(0x13f)],_0x471937(0x18f)),assert[_0x471937(0x188)](_0x21d71f['iat']),assert['exists'](_0x21d71f[_0x471937(0x201)]);}else return _0x45b601=this[_0x471937(0x199)][_0x471937(0x162)],_0x24674b=_0x3473b4,_0xd007e9[_0x471937(0x23c)](_0x3871d1,_0x471937(0x19b))(),{'access_token':_0xd007e9[_0x471937(0x1e9)],'refresh_token':_0xd007e9[_0x471937(0x14d)],'id_token':_0x554692[_0x471937(0x22f)]['id_token'],'token_type':_0xd007e9[_0x471937(0x164)],'expires_in':0x15180};}),_0xd007e9[_0x5149d4(0x185)](it,_0xd007e9['vBNOz'],async()=>{const _0x434d03=_0x5149d4,_0x413a18=_0xd007e9[_0x434d03(0x1cc)](makeIdToken),{response:{statusCode:_0x4e9191,headers:_0x229b8f},currentUser:_0x1ad2c2,tokens:_0x1a2cbc}=await _0xd007e9['ndqCq'](setup,{'cookies':_0xd007e9[_0x434d03(0x227)](generateCookies,{'state':expectedDefaultState,'nonce':_0x434d03(0x18f)}),'body':{'state':expectedDefaultState,'id_token':_0x413a18}});assert[_0x434d03(0x18b)](_0x4e9191,0x12e),assert[_0x434d03(0x18b)](_0x229b8f[_0x434d03(0x22b)],_0xd007e9[_0x434d03(0x1f1)]),assert['ok'](_0x1ad2c2),assert[_0x434d03(0x18b)](_0x1ad2c2['sub'],_0xd007e9[_0x434d03(0x13c)]),assert[_0x434d03(0x18b)](_0x1ad2c2[_0x434d03(0x23a)],_0xd007e9[_0x434d03(0x1f2)]),assert[_0x434d03(0x211)](_0x1ad2c2[_0x434d03(0x140)]),assert[_0x434d03(0x211)](_0x1ad2c2['iss']),assert['notExists'](_0x1ad2c2[_0x434d03(0x168)]),assert[_0x434d03(0x211)](_0x1ad2c2['exp']),assert['notExists'](_0x1ad2c2['nonce']),assert[_0x434d03(0x18b)](_0x1a2cbc[_0x434d03(0x1d9)],!![]),assert['equal'](_0x1a2cbc[_0x434d03(0x195)],_0x413a18),assert[_0x434d03(0x1f8)](_0x1a2cbc['refreshToken']),assert[_0x434d03(0x1f8)](_0x1a2cbc['accessToken']),assert[_0x434d03(0x165)](_0x1a2cbc[_0x434d03(0x1e0)],{'sub':_0x434d03(0x14b)});}),_0xd007e9[_0x5149d4(0x144)](it,_0xd007e9[_0x5149d4(0x221)],async()=>{const _0x287d41=_0x5149d4,_0x25e44c=makeIdToken({'c_hash':_0xd007e9[_0x287d41(0x21b)]}),{tokens:_0x3edb2e}=await _0xd007e9['TOSCG'](setup,{'authOpts':{'clientSecret':_0xd007e9[_0x287d41(0x21f)],'authorizationParams':{'response_type':_0x287d41(0x1f6),'audience':_0xd007e9[_0x287d41(0x17f)],'scope':_0xd007e9[_0x287d41(0x177)]}},'cookies':_0xd007e9[_0x287d41(0x1c9)](generateCookies,{'state':expectedDefaultState,'nonce':_0x287d41(0x18f)}),'body':{'state':expectedDefaultState,'id_token':_0x25e44c,'code':'jHkWEdUXMU1BwAsC4vtUsZwnNvTIxEl0z9K3vx5KF0Y'}});assert['equal'](_0x3edb2e[_0x287d41(0x1d9)],!![]),assert['equal'](_0x3edb2e[_0x287d41(0x195)],_0x25e44c),assert[_0x287d41(0x18b)](_0x3edb2e[_0x287d41(0x1c8)],'__test_refresh_token__'),assert['include'](_0x3edb2e['accessToken'],{'access_token':_0xd007e9[_0x287d41(0x1e9)],'token_type':_0xd007e9['fhIed']}),assert[_0x287d41(0x165)](_0x3edb2e[_0x287d41(0x1e0)],{'sub':_0x287d41(0x14b)});}),_0xd007e9['ptasm'](it,_0x5149d4(0x1e2),async()=>{const _0x128ded=_0x5149d4,_0x5e2e85=sinon[_0x128ded(0x19c)]({'toFake':[_0xd007e9[_0x128ded(0x1ca)]]}),_0x406283=_0xd007e9[_0x128ded(0x171)](makeIdToken,{'c_hash':_0xd007e9[_0x128ded(0x21b)]}),_0x4c3b0f=0x3c*0x3c,_0x1caabd=_0x4c3b0f*0x3e8,{tokens:_0x55ea32,jar:_0x20177b}=await setup({'authOpts':{'clientSecret':_0xd007e9[_0x128ded(0x21f)],'authorizationParams':{'response_type':_0xd007e9[_0x128ded(0x1b5)]}},'cookies':generateCookies({'state':expectedDefaultState,'nonce':_0x128ded(0x18f)}),'body':{'state':expectedDefaultState,'id_token':_0x406283,'code':_0x128ded(0x16e)}});assert[_0x128ded(0x18b)](_0x55ea32[_0x128ded(0x14f)][_0x128ded(0x1b1)],_0xd007e9[_0x128ded(0x1f0)](0x18,_0x4c3b0f)),_0x5e2e85['tick'](0x4*_0x1caabd);const _0x2ce884=await request[_0x128ded(0x196)](_0xd007e9[_0x128ded(0x1c7)],{'baseUrl':baseUrl,'jar':_0x20177b,'json':!![]})['then'](_0x3d4b67=>_0x3d4b67[_0x128ded(0x22f)]);assert[_0x128ded(0x18b)](_0x2ce884[_0x128ded(0x14f)][_0x128ded(0x1b1)],_0xd007e9[_0x128ded(0x1f0)](0x14,_0x4c3b0f)),assert[_0x128ded(0x200)](_0x2ce884['accessTokenExpired']),_0x5e2e85[_0x128ded(0x22e)](_0xd007e9['WtouI'](0x15,_0x1caabd));const _0x3c296a=await request['get'](_0xd007e9['NRzbP'],{'baseUrl':baseUrl,'jar':_0x20177b,'json':!![]})[_0x128ded(0x219)](_0x4b8b0d=>_0x4b8b0d[_0x128ded(0x22f)]);assert[_0x128ded(0x1bc)](_0x3c296a[_0x128ded(0x217)]),_0x5e2e85[_0x128ded(0x1ad)]();}),it(_0x5149d4(0x1c6),async()=>{const _0x1676c3=_0x5149d4,_0x4f3bb6={'jjwLY':function(_0x32d200,_0x2172f7){return _0x32d200===_0x2172f7;},'znuzB':_0x1676c3(0x1e6)},_0x2379c4=makeIdToken({'c_hash':_0xd007e9[_0x1676c3(0x21b)]}),_0x4d8a21={...defaultConfig,'clientSecret':'__test_client_secret__','authorizationParams':{'response_type':_0xd007e9[_0x1676c3(0x1c5)],'audience':_0x1676c3(0x1d4),'scope':_0x1676c3(0x1d7)}},_0x2bd58a=_0xd007e9['Iqnxi'](auth,_0x4d8a21);_0x2bd58a[_0x1676c3(0x196)]('/refresh',async(_0x42834f,_0x41fb31)=>{const _0x539fc5=_0x1676c3;if(_0x4f3bb6[_0x539fc5(0x187)](_0x4f3bb6[_0x539fc5(0x146)],_0x539fc5(0x16a)))throw{'status':0x3e7};else{const _0x4672c0=await _0x42834f[_0x539fc5(0x1c0)][_0x539fc5(0x14f)][_0x539fc5(0x1fd)]();_0x41fb31['json']({'accessToken':_0x4672c0,'refreshToken':_0x42834f[_0x539fc5(0x1c0)][_0x539fc5(0x1c8)]});}});const {tokens:_0x26dfd2,jar:_0x3d610a}=await setup({'router':_0x2bd58a,'authOpts':{'clientSecret':_0x1676c3(0x1db),'authorizationParams':{'response_type':_0xd007e9[_0x1676c3(0x1c5)],'audience':_0x1676c3(0x1d4),'scope':_0xd007e9[_0x1676c3(0x177)]}},'cookies':_0xd007e9[_0x1676c3(0x242)](generateCookies,{'state':expectedDefaultState,'nonce':_0xd007e9['djQHQ']}),'body':{'state':expectedDefaultState,'id_token':_0x2379c4,'code':_0xd007e9[_0x1676c3(0x15b)]}}),_0x51bad7=sinon['spy'](()=>({'access_token':_0x1676c3(0x1e5),'refresh_token':'__new_refresh_token__','id_token':_0x26dfd2[_0x1676c3(0x195)],'token_type':_0x1676c3(0x1fb),'expires_in':0x15180})),{interceptors:[_0x49f6b4]}=nock(_0xd007e9[_0x1676c3(0x1a7)],{'allowUnmocked':!![]})[_0x1676c3(0x1df)](_0x1676c3(0x19e))[_0x1676c3(0x1f3)](0xc8,_0x51bad7),_0x482b17=await request[_0x1676c3(0x196)](_0x1676c3(0x1da),{'baseUrl':baseUrl,'jar':_0x3d610a,'json':!![]})['then'](_0x28ab7b=>_0x28ab7b[_0x1676c3(0x22f)]);nock['removeInterceptor'](_0x49f6b4),sinon[_0x1676c3(0x23d)][_0x1676c3(0x17a)](_0x51bad7,_0xd007e9[_0x1676c3(0x17d)],_0xd007e9[_0x1676c3(0x1cb)]),assert[_0x1676c3(0x18b)](_0x26dfd2[_0x1676c3(0x14f)][_0x1676c3(0x21c)],_0xd007e9[_0x1676c3(0x1e9)]),assert['equal'](_0x26dfd2[_0x1676c3(0x1c8)],'__test_refresh_token__'),assert[_0x1676c3(0x18b)](_0x482b17[_0x1676c3(0x14f)]['access_token'],_0x1676c3(0x1e5)),assert['equal'](_0x482b17[_0x1676c3(0x1c8)],_0x1676c3(0x238));const _0x3e1142=await request[_0x1676c3(0x196)]('/tokens',{'baseUrl':baseUrl,'jar':_0x3d610a,'json':!![]})[_0x1676c3(0x219)](_0x23f141=>_0x23f141['body']);assert[_0x1676c3(0x18b)](_0x3e1142[_0x1676c3(0x14f)][_0x1676c3(0x21c)],_0xd007e9[_0x1676c3(0x153)],_0x1676c3(0x22d));}),_0xd007e9[_0x5149d4(0x185)](it,_0xd007e9[_0x5149d4(0x222)],async()=>{const _0x40a07a=_0x5149d4,_0x1c3381=_0xd007e9[_0x40a07a(0x171)](makeIdToken,{'c_hash':_0x40a07a(0x1d8)}),_0x666072={...defaultConfig,'clientSecret':_0xd007e9['CyTgz'],'authorizationParams':{'response_type':_0xd007e9[_0x40a07a(0x1c5)],'audience':_0xd007e9[_0x40a07a(0x17f)],'scope':_0xd007e9['qqtxW']}},_0x19119d=auth(_0x666072);_0x19119d[_0x40a07a(0x196)]('/refresh',async(_0x3632a6,_0x305285)=>{const _0x546c2a=_0x40a07a,_0x46f5de=await _0x3632a6[_0x546c2a(0x1c0)][_0x546c2a(0x14f)][_0x546c2a(0x1fd)]();_0x305285[_0x546c2a(0x178)]({'accessToken':_0x46f5de,'refreshToken':_0x3632a6[_0x546c2a(0x1c0)][_0x546c2a(0x1c8)]});});const {tokens:_0x23beb9,jar:_0x316606}=await _0xd007e9[_0x40a07a(0x1b3)](setup,{'router':_0x19119d,'authOpts':{'clientSecret':_0xd007e9[_0x40a07a(0x21f)],'authorizationParams':{'response_type':_0xd007e9[_0x40a07a(0x1c5)],'audience':'https://api.example.com/','scope':_0x40a07a(0x1d7)}},'cookies':generateCookies({'state':expectedDefaultState,'nonce':'__test_nonce__'}),'body':{'state':expectedDefaultState,'id_token':_0x1c3381,'code':_0xd007e9[_0x40a07a(0x15b)]}}),_0x3d4f01=sinon['spy'](()=>({'access_token':_0x40a07a(0x1e5),'id_token':_0x23beb9[_0x40a07a(0x214)],'token_type':'Bearer','expires_in':0x15180})),{interceptors:[_0x2d55c8]}=_0xd007e9[_0x40a07a(0x158)](nock,'https://op.example.com',{'allowUnmocked':!![]})[_0x40a07a(0x1df)](_0x40a07a(0x19e))['reply'](0xc8,_0x3d4f01),_0x4fdeb0=await request[_0x40a07a(0x196)](_0xd007e9[_0x40a07a(0x1ce)],{'baseUrl':baseUrl,'jar':_0x316606,'json':!![]})[_0x40a07a(0x219)](_0x2a17ae=>_0x2a17ae[_0x40a07a(0x22f)]);nock[_0x40a07a(0x1b7)](_0x2d55c8),sinon[_0x40a07a(0x23d)][_0x40a07a(0x17a)](_0x3d4f01,_0xd007e9[_0x40a07a(0x17d)],_0xd007e9[_0x40a07a(0x1cb)]),assert['equal'](_0x23beb9['accessToken']['access_token'],_0x40a07a(0x1ea)),assert[_0x40a07a(0x18b)](_0x23beb9[_0x40a07a(0x1c8)],_0x40a07a(0x173)),assert[_0x40a07a(0x18b)](_0x4fdeb0['accessToken'][_0x40a07a(0x21c)],_0x40a07a(0x1e5)),assert['equal'](_0x4fdeb0[_0x40a07a(0x1c8)],_0xd007e9['UwHTz']);}),it(_0xd007e9[_0x5149d4(0x13d)],async()=>{const _0x4d78b0=_0x5149d4,_0x1f002e=_0xd007e9[_0x4d78b0(0x172)](makeIdToken,{'c_hash':_0xd007e9[_0x4d78b0(0x21b)]}),_0x4beed2={...defaultConfig,'clientSecret':_0x4d78b0(0x1db),'authorizationParams':{'response_type':_0xd007e9['vEVvK'],'audience':_0x4d78b0(0x1d4),'scope':'openid\x20profile\x20email\x20read:reports\x20offline_access'},'tokenEndpointParams':{'longeLiveToken':!![]}},_0xcf39cc=_0xd007e9['enZNL'](auth,_0x4beed2);_0xcf39cc[_0x4d78b0(0x196)](_0x4d78b0(0x1da),async(_0x34e583,_0x12eeca)=>{const _0x19404d=_0x4d78b0,_0x3403b9=await _0x34e583[_0x19404d(0x1c0)][_0x19404d(0x14f)][_0x19404d(0x1fd)]({'tokenEndpointParams':{'force':!![]}});_0x12eeca[_0x19404d(0x178)]({'accessToken':_0x3403b9,'refreshToken':_0x34e583[_0x19404d(0x1c0)][_0x19404d(0x1c8)]});});const {tokens:_0x579171,jar:_0x2a6189,tokenReqBody:_0x751316}=await setup({'router':_0xcf39cc,'authOpts':{'clientSecret':_0xd007e9[_0x4d78b0(0x21f)],'authorizationParams':{'response_type':_0x4d78b0(0x1f6),'audience':_0xd007e9[_0x4d78b0(0x17f)],'scope':_0x4d78b0(0x1d7)}},'cookies':_0xd007e9[_0x4d78b0(0x142)](generateCookies,{'state':expectedDefaultState,'nonce':_0xd007e9['djQHQ']}),'body':{'state':expectedDefaultState,'id_token':_0x1f002e,'code':_0x4d78b0(0x16e)}}),_0x1e5123=sinon[_0x4d78b0(0x149)](()=>({'access_token':_0x4d78b0(0x1e5),'refresh_token':'__new_refresh_token__','id_token':_0x579171[_0x4d78b0(0x195)],'token_type':'Bearer','expires_in':0x15180})),{interceptors:[_0x2864e1]}=nock(_0xd007e9[_0x4d78b0(0x1a7)],{'allowUnmocked':!![]})[_0x4d78b0(0x1df)](_0xd007e9[_0x4d78b0(0x17d)])[_0x4d78b0(0x1f3)](0xc8,_0x1e5123),_0x10a540=await request[_0x4d78b0(0x196)](_0x4d78b0(0x1da),{'baseUrl':baseUrl,'jar':_0x2a6189,'json':!![]})[_0x4d78b0(0x219)](_0x44fc4c=>_0x44fc4c[_0x4d78b0(0x22f)]);nock[_0x4d78b0(0x1b7)](_0x2864e1),sinon[_0x4d78b0(0x23d)]['calledWith'](_0x1e5123,_0xd007e9[_0x4d78b0(0x17d)],_0xd007e9[_0x4d78b0(0x17c)]),assert[_0x4d78b0(0x18b)](_0x579171[_0x4d78b0(0x14f)][_0x4d78b0(0x21c)],_0xd007e9[_0x4d78b0(0x1e9)]),assert[_0x4d78b0(0x18b)](_0x579171[_0x4d78b0(0x1c8)],_0xd007e9[_0x4d78b0(0x14d)]),assert[_0x4d78b0(0x18b)](_0x10a540[_0x4d78b0(0x14f)][_0x4d78b0(0x21c)],_0xd007e9[_0x4d78b0(0x153)]),assert['equal'](_0x10a540['refreshToken'],_0x4d78b0(0x238)),assert[_0x4d78b0(0x1c1)](_0x751316,/longeLiveToken=true/);const _0x427eea=await request[_0x4d78b0(0x196)](_0xd007e9[_0x4d78b0(0x1c7)],{'baseUrl':baseUrl,'jar':_0x2a6189,'json':!![]})[_0x4d78b0(0x219)](_0x2fc5f5=>_0x2fc5f5[_0x4d78b0(0x22f)]);assert[_0x4d78b0(0x18b)](_0x427eea[_0x4d78b0(0x14f)][_0x4d78b0(0x21c)],_0xd007e9[_0x4d78b0(0x153)],_0xd007e9[_0x4d78b0(0x170)]);}),it(_0xd007e9['wCQuM'],async()=>{const _0x3c9038=_0x5149d4;if(_0xd007e9[_0x3c9038(0x156)]('MpQOM',_0xd007e9[_0x3c9038(0x15c)]))_0x9061ad=_0x31878e[0x0];else{const _0x93366e=_0xd007e9[_0x3c9038(0x18c)](makeIdToken,{'c_hash':_0xd007e9['ugMKR']}),_0x3c6ae={...defaultConfig,'clientSecret':_0xd007e9[_0x3c9038(0x21f)],'authorizationParams':{'response_type':_0x3c9038(0x1f6),'audience':_0xd007e9['OsdtQ'],'scope':'openid\x20profile\x20email'}},_0x58ee49=_0xd007e9[_0x3c9038(0x23b)](auth,_0x3c6ae);_0x58ee49[_0x3c9038(0x196)](_0x3c9038(0x1ac),async(_0x1508ea,_0x422e24)=>{const _0x3a7264=_0x3c9038;_0x422e24['json'](await _0x1508ea['oidc'][_0x3a7264(0x141)]());});const {jar:_0x240652}=await setup({'router':_0x58ee49,'authOpts':{'clientSecret':_0xd007e9['CyTgz'],'authorizationParams':{'response_type':_0xd007e9['vEVvK'],'audience':_0x3c9038(0x1d4),'scope':_0xd007e9[_0x3c9038(0x177)]}},'cookies':_0xd007e9[_0x3c9038(0x1d3)](generateCookies,{'state':expectedDefaultState,'nonce':_0xd007e9[_0x3c9038(0x1ef)]}),'body':{'state':expectedDefaultState,'id_token':_0x93366e,'code':_0xd007e9[_0x3c9038(0x15b)]}}),{interceptors:[_0x12e2e3]}=nock(_0xd007e9[_0x3c9038(0x1a7)],{'allowUnmocked':!![]})['get'](_0x3c9038(0x1d0))['reply'](0xc8,()=>({'userInfo':!![],'sub':'__test_sub__'})),_0xa23d02=await request[_0x3c9038(0x196)]('/user-info',{'baseUrl':baseUrl,'jar':_0x240652,'json':!![]})[_0x3c9038(0x219)](_0x27513b=>_0x27513b[_0x3c9038(0x22f)]);nock[_0x3c9038(0x1b7)](_0x12e2e3),assert[_0x3c9038(0x239)](_0xa23d02,{'userInfo':!![],'sub':_0xd007e9[_0x3c9038(0x13c)]});}}),_0xd007e9[_0x5149d4(0x157)](it,'should\x20use\x20basic\x20auth\x20on\x20token\x20endpoint\x20when\x20using\x20code\x20flow',async()=>{const _0x9aa59=_0x5149d4,_0x3a259e=makeIdToken({'c_hash':_0xd007e9['ugMKR']}),{tokenReqBody:_0x5d1666,tokenReqHeader:_0x3677f7}=await setup({'authOpts':{'clientSecret':'__test_client_secret__','authorizationParams':{'response_type':_0x9aa59(0x1f6),'audience':_0xd007e9[_0x9aa59(0x17f)],'scope':_0x9aa59(0x1d7)}},'cookies':generateCookies({'state':expectedDefaultState,'nonce':_0xd007e9[_0x9aa59(0x1ef)]}),'body':{'state':expectedDefaultState,'id_token':_0x3a259e,'code':_0xd007e9['LENyx']}}),_0x20f96e=Buffer[_0x9aa59(0x1f9)](_0x3677f7[_0x9aa59(0x186)][_0x9aa59(0x1b8)](_0xd007e9['pLMwQ'],''),_0xd007e9[_0x9aa59(0x16d)]);assert[_0x9aa59(0x18b)](_0x20f96e,_0xd007e9[_0x9aa59(0x1f4)]),assert[_0x9aa59(0x1c1)](_0x5d1666,/code=jHkWEdUXMU1BwAsC4vtUsZwnNvTIxEl0z9K3vx5KF0Y/);}),it(_0x5149d4(0x1f5),async()=>{const _0x58b119=_0x5149d4,_0x1dec32=_0xd007e9['LIuEg'](makeIdToken),_0x983bc9=request[_0x58b119(0x20a)]();_0x983bc9[_0x58b119(0x15e)](_0xd007e9[_0x58b119(0x18e)],baseUrl),await _0xd007e9[_0x58b119(0x172)](setup,{'cookies':_0xd007e9[_0x58b119(0x16f)](generateCookies,{'state':expectedDefaultState,'nonce':_0x58b119(0x18f),'skipSilentLogin':'1'}),'body':{'state':expectedDefaultState,'id_token':_0x1dec32},'jar':_0x983bc9});const _0x3549cd=_0x983bc9[_0x58b119(0x14e)](baseUrl);assert[_0x58b119(0x207)](_0x3549cd['find'](({key:_0x23105a})=>_0x23105a===_0x58b119(0x1c2)));}),_0xd007e9[_0x5149d4(0x185)](context,_0xd007e9['uAmEP'],async()=>{const _0x522596=_0x5149d4,_0x57a5b9={'AYkUK':_0xd007e9[_0x522596(0x244)],'trtja':_0xd007e9['KTCIt'],'DZTwB':function(_0x5eaed1,_0x302341){return _0x5eaed1(_0x302341);},'RBEGp':_0x522596(0x1d8),'HtCAG':_0x522596(0x1d4),'ktsFD':function(_0x5aeb97,_0x53d3f9,_0x230595){return _0x5aeb97(_0x53d3f9,_0x230595);},'YIsSK':'https://op.example.com','CsHBe':_0xd007e9['imIDf'],'xnWDV':function(_0x4661e3,_0x18e554){return _0x4661e3(_0x18e554);},'WEDji':function(_0x27d563,_0xdd329){const _0x57affc=_0x522596;return _0xd007e9[_0x57affc(0x159)](_0x27d563,_0xdd329);},'XVLWY':'openid\x20profile\x20email','XpEvY':function(_0x5d1264,_0x566ad1){const _0x393727=_0x522596;return _0xd007e9[_0x393727(0x1fe)](_0x5d1264,_0x566ad1);},'ObAXN':_0x522596(0x18f),'IjvkE':_0xd007e9[_0x522596(0x15b)]};it(_0xd007e9[_0x522596(0x183)],async()=>{const _0x6ecd5f=_0x522596,_0x30d004=_0x57a5b9[_0x6ecd5f(0x1e4)](makeIdToken,{'c_hash':_0x57a5b9[_0x6ecd5f(0x245)]}),_0x5a8682={...defaultConfig,'clientSecret':'__test_client_secret__','authorizationParams':{'response_type':'code\x20id_token','audience':_0x57a5b9['HtCAG'],'scope':_0x6ecd5f(0x194)},'afterCallback':async(_0x2cde7d,_0x12659b,_0x3218a1)=>{const _0x51fbf3=_0x6ecd5f,_0x56f423=await _0x2cde7d[_0x51fbf3(0x1c0)][_0x51fbf3(0x141)]();return Function(_0x51fbf3(0x19b))(),{..._0x3218a1,..._0x56f423};}},{interceptors:[_0x425df2]}=_0x57a5b9[_0x6ecd5f(0x224)](nock,_0x57a5b9[_0x6ecd5f(0x1aa)],{'allowUnmocked':!![]})[_0x6ecd5f(0x196)](_0x57a5b9[_0x6ecd5f(0x163)])[_0x6ecd5f(0x1f3)](0xc8,()=>({'org_id':'auth_org_123'})),_0x4a3f45=_0x57a5b9[_0x6ecd5f(0x143)](auth,_0x5a8682);_0x4a3f45['get'](_0x6ecd5f(0x19a),async(_0x526724,_0x192871)=>{const _0x1ba4bd=_0x6ecd5f,_0x7a7221={'DqjMv':function(_0x45f9ba,_0xe014e0){return _0x45f9ba===_0xe014e0;}};if(_0x57a5b9['AYkUK']===_0x57a5b9[_0x1ba4bd(0x13e)])_0x192871[_0x1ba4bd(0x178)]({'session':_0x526724[_0x57a5b9[_0x1ba4bd(0x1a4)]]});else{let _0x38c405;_0x423848[_0x1ba4bd(0x241)](_0x103ac9,{},{'cookie'(_0x106f0e,..._0x5faac6){const _0x2fabc2=_0x1ba4bd;_0x7a7221[_0x2fabc2(0x184)](_0x106f0e,_0x1da39f)&&(_0x38c405=_0x5faac6[0x0]);}},{'value':_0x398c2e[_0x1ba4bd(0x1b4)][_0x11ae5b]}),_0x2bc65e[_0x1ba4bd(0x15e)](_0x41b334+'='+_0x38c405+_0x1ba4bd(0x190),_0x5d49b9+_0x1ba4bd(0x1ab));}});const {jar:_0x45cb20}=await _0x57a5b9['WEDji'](setup,{'router':_0x4a3f45,'authOpts':{'clientSecret':_0x6ecd5f(0x1db),'authorizationParams':{'response_type':_0x6ecd5f(0x1f6),'audience':_0x57a5b9[_0x6ecd5f(0x1a1)],'scope':_0x57a5b9[_0x6ecd5f(0x1b6)]}},'cookies':_0x57a5b9[_0x6ecd5f(0x225)](generateCookies,{'state':expectedDefaultState,'nonce':_0x57a5b9[_0x6ecd5f(0x234)]}),'body':{'state':expectedDefaultState,'id_token':_0x30d004,'code':_0x57a5b9[_0x6ecd5f(0x1e7)]}});nock['removeInterceptor'](_0x425df2);const _0x1af092=await request['get'](_0x6ecd5f(0x19a),{'baseUrl':baseUrl,'jar':_0x45cb20,'json':!![]})[_0x6ecd5f(0x219)](_0x130daf=>_0x130daf['body']);assert[_0x6ecd5f(0x239)](_0x1af092[_0x6ecd5f(0x15f)]['org_id'],_0x6ecd5f(0x1cd));}),it(_0x522596(0x1bb),async()=>{const _0x1aef77=_0x522596,_0xffcd7a=_0xd007e9[_0x1aef77(0x193)](makeIdToken,{'c_hash':_0xd007e9[_0x1aef77(0x21b)]}),_0x576bed={...defaultConfig,'clientSecret':_0x1aef77(0x1db),'authorizationParams':{'response_type':'code\x20id_token','audience':_0x1aef77(0x1d4),'scope':_0xd007e9[_0x1aef77(0x16c)]},'afterCallback':async()=>{throw{'status':0x3e7};}},{response:{statusCode:_0x57d91d}}=await setup({'router':_0xd007e9[_0x1aef77(0x1dc)](auth,_0x576bed),'authOpts':_0x576bed,'cookies':generateCookies({'state':expectedDefaultState,'nonce':'__test_nonce__'}),'body':{'state':expectedDefaultState,'id_token':_0xffcd7a,'code':_0x1aef77(0x16e)}});assert[_0x1aef77(0x18b)](_0x57d91d,0x3e7);});}),it(_0xd007e9[_0x5149d4(0x235)],async()=>{const _0x1b7021=_0x5149d4;if(_0x1b7021(0x197)===_0xd007e9['hZeeB']){const {currentSession:_0x333833,currentUser:_0x4822ea}=await setup({'cookies':_0xd007e9['WkwfO'](generateCookies,{'state':expectedDefaultState,'nonce':_0xd007e9[_0x1b7021(0x1ef)]}),'body':{'state':expectedDefaultState,'id_token':_0xd007e9[_0x1b7021(0x232)](makeIdToken,{'sub':_0x1b7021(0x212)})},'existingSession':{'shoppingCartId':_0xd007e9[_0x1b7021(0x231)],'id_token':_0xd007e9[_0x1b7021(0x17b)](makeIdToken,{'sub':_0x1b7021(0x208)})}});assert['equal'](_0x4822ea['sub'],_0x1b7021(0x212)),assert[_0x1b7021(0x1f8)](_0x333833['shoppingCartId']);}else _0x589e29===_0x489a61&&(_0x3b0fdd=_0x1302d5[0x0]);}),_0xd007e9[_0x5149d4(0x157)](it,_0xd007e9[_0x5149d4(0x236)],async()=>{const _0x2137ac=_0x5149d4,{currentSession:_0x2d869a,currentUser:_0x467828}=await _0xd007e9[_0x2137ac(0x167)](setup,{'cookies':generateCookies({'state':expectedDefaultState,'nonce':_0xd007e9[_0x2137ac(0x1ef)]}),'body':{'state':expectedDefaultState,'id_token':makeIdToken({'sub':'foo'})},'existingSession':{'shoppingCartId':_0xd007e9[_0x2137ac(0x231)]}});assert['equal'](_0x467828[_0x2137ac(0x20b)],_0x2137ac(0x208)),assert['equal'](_0x2d869a[_0x2137ac(0x205)],_0x2137ac(0x212));}),it(_0xd007e9[_0x5149d4(0x1ee)],async()=>{const _0x124492=_0x5149d4,_0x1a7abe=new MemoryStore({'checkPeriod':_0xd007e9['WtouI'](_0xd007e9[_0x124492(0x1e3)](0x18,0x3c),0x3e8)}),{currentSession:_0x520d34,currentUser:_0x104f2e,existingSessionCookie:_0xfa80d6,jar:_0x421f1f}=await _0xd007e9[_0x124492(0x1ae)](setup,{'cookies':generateCookies({'state':expectedDefaultState,'nonce':_0xd007e9[_0x124492(0x1ef)]}),'body':{'state':expectedDefaultState,'id_token':_0xd007e9[_0x124492(0x142)](makeIdToken,{'sub':_0x124492(0x208)})},'existingSession':{'shoppingCartId':_0x124492(0x212)},'authOpts':{'session':{'store':_0x1a7abe}}}),_0x1858c6=_0x421f1f[_0x124492(0x14e)](baseUrl),_0x5bc3f8=_0x1858c6[_0x124492(0x1d2)](({key:_0x1c5e5b})=>_0x1c5e5b===_0x124492(0x181));assert['equal'](_0x104f2e['sub'],'foo'),assert[_0x124492(0x18b)](_0x520d34[_0x124492(0x205)],_0x124492(0x212)),assert[_0x124492(0x18b)](_0x1a7abe[_0x124492(0x241)][_0x124492(0x1a0)],0x1,_0xd007e9[_0x124492(0x169)]),assert[_0x124492(0x1a6)](_0xfa80d6[_0x124492(0x1cf)],_0x5bc3f8[_0x124492(0x1cf)]);}),it(_0xd007e9[_0x5149d4(0x189)],async()=>{const _0x266ecc=_0x5149d4,_0x1e6f95=new MemoryStore({'checkPeriod':_0xd007e9[_0x266ecc(0x1eb)](0x18*0x3c,0x3e8)}),{currentSession:_0x1230df,currentUser:_0x20788a,existingSessionCookie:_0x2f3383,jar:_0x25d5ce}=await _0xd007e9[_0x266ecc(0x215)](setup,{'cookies':generateCookies({'state':expectedDefaultState,'nonce':'__test_nonce__'}),'body':{'state':expectedDefaultState,'id_token':_0xd007e9['iAbQh'](makeIdToken,{'sub':'foo'})},'existingSession':{'shoppingCartId':'bar','id_token':makeIdToken({'sub':_0xd007e9[_0x266ecc(0x1be)]})},'authOpts':{'session':{'store':_0x1e6f95}}}),_0x3e43e1=_0x25d5ce[_0x266ecc(0x14e)](baseUrl),_0x35a832=_0x3e43e1[_0x266ecc(0x1d2)](({key:_0x3641c7})=>_0x3641c7===_0x266ecc(0x181));assert[_0x266ecc(0x18b)](_0x20788a[_0x266ecc(0x20b)],_0xd007e9['RjblX']),assert[_0x266ecc(0x18b)](_0x1230df[_0x266ecc(0x205)],_0xd007e9[_0x266ecc(0x231)]),assert['equal'](_0x1e6f95['store']['length'],0x1,_0xd007e9['cKMnl']),assert[_0x266ecc(0x18b)](_0x2f3383[_0x266ecc(0x1cf)],_0x35a832[_0x266ecc(0x1cf)]);}),_0xd007e9[_0x5149d4(0x243)](it,_0xd007e9['WVRIp'],async()=>{const _0x271144=_0x5149d4,_0x3b1735=new MemoryStore({'checkPeriod':_0xd007e9[_0x271144(0x1f0)](0x18*0x3c,0x3e8)}),{currentSession:_0x21f269,currentUser:_0x415599,existingSessionCookie:_0x4f94a5,jar:_0x5b0079}=await setup({'cookies':generateCookies({'state':expectedDefaultState,'nonce':_0x271144(0x18f)}),'body':{'state':expectedDefaultState,'id_token':_0xd007e9['yCqlO'](makeIdToken,{'sub':'bar'})},'existingSession':{'shoppingCartId':'bar','id_token':makeIdToken({'sub':_0x271144(0x208)})},'authOpts':{'session':{'store':_0x3b1735}}}),_0x2e341b=_0x5b0079[_0x271144(0x14e)](baseUrl),_0x525ea9=_0x2e341b[_0x271144(0x1d2)](({key:_0x35a6ce})=>_0x35a6ce===_0x271144(0x181));assert[_0x271144(0x18b)](_0x415599[_0x271144(0x20b)],_0x271144(0x212)),assert[_0x271144(0x1f8)](_0x21f269[_0x271144(0x205)]),assert[_0x271144(0x18b)](_0x3b1735['store'][_0x271144(0x1a0)],0x1,_0x271144(0x1c4)),assert['notEqual'](_0x4f94a5[_0x271144(0x1cf)],_0x525ea9[_0x271144(0x1cf)]);});});