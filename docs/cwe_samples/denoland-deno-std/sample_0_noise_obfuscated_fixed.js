const _0x422488=_0x4f1b;(function(_0x1032ae,_0x55bd90){const _0x3d644c=_0x4f1b,_0x521578=_0x1032ae();while(!![]){try{const _0x452187=parseInt(_0x3d644c(0x8e))/0x1+parseInt(_0x3d644c(0x98))/0x2+parseInt(_0x3d644c(0xd1))/0x3+parseInt(_0x3d644c(0xc6))/0x4*(parseInt(_0x3d644c(0x8a))/0x5)+-parseInt(_0x3d644c(0xcd))/0x6*(parseInt(_0x3d644c(0x8c))/0x7)+parseInt(_0x3d644c(0xb6))/0x8+-parseInt(_0x3d644c(0xb2))/0x9;if(_0x452187===_0x55bd90)break;else _0x521578['push'](_0x521578['shift']());}catch(_0x2355c7){_0x521578['push'](_0x521578['shift']());}}}(_0x5498,0x35477));const {z}=require(_0x422488(0xa2)),Message=require(_0x422488(0x9b)),{logger}=require(_0x422488(0xa8)),idSchema=z[_0x422488(0xd2)]()[_0x422488(0xac)]();async function saveMessage(_0x37a213,_0x40ad88,_0x20bb53){const _0x58498c=_0x422488,_0x50aabe={'tLZcc':_0x58498c(0x95),'swamh':_0x58498c(0x78),'reguj':function(_0x567d06,_0xb3a43d){return _0x567d06(_0xb3a43d);},'wDyPf':_0x58498c(0xd8),'Fivqj':function(_0x30c482,_0x11d22b){return _0x30c482!==_0x11d22b;},'cILCs':'hoSkA','FYfGT':_0x58498c(0x7f),'yufzI':_0x58498c(0xaa),'glLcm':function(_0x526f53,_0x5c7560){return _0x526f53(_0x5c7560);},'tITst':'updateClock();','MKlXU':_0x58498c(0xbb)};if(!_0x37a213?.[_0x58498c(0x97)]?.['id']){if(_0x50aabe[_0x58498c(0x7b)](_0x50aabe['cILCs'],_0x50aabe[_0x58498c(0xc5)])){_0x120314[_0x58498c(0xa4)](_0x50aabe[_0x58498c(0x9a)],_0x2faab7);throw _0x85a186;}else throw new Error(_0x50aabe['FYfGT']);}const _0x201324=idSchema[_0x58498c(0x7c)](_0x40ad88[_0x58498c(0x9f)]);if(!_0x201324[_0x58498c(0xa7)]){if(_0x50aabe[_0x58498c(0x7b)]('ChIxz',_0x50aabe[_0x58498c(0xd6)])){const _0x4bf812=_0x50aabe['swamh']['split']('|');let _0x5104e7=0x0;while(!![]){switch(_0x4bf812[_0x5104e7++]){case'0':_0x50aabe[_0x58498c(0xda)](_0x8f143c,_0x50aabe['wDyPf'])();continue;case'1':return;case'2':_0x1339b7[_0x58498c(0x94)](_0x58498c(0xb1)+_0x441772?.[_0x58498c(0x8f)]);continue;case'3':_0x36e647[_0x58498c(0x8b)](_0x58498c(0xcc)+_0x4e35e6['conversationId']);continue;case'4':_0x31844f[_0x58498c(0x94)]('---Invalid\x20conversation\x20ID\x20Params:\x20'+_0x49c3f2[_0x58498c(0x84)](_0x681f61,null,0x2));continue;}break;}}else{logger[_0x58498c(0x8b)]('Invalid\x20conversation\x20ID:\x20'+_0x40ad88['conversationId']),logger[_0x58498c(0x94)](_0x58498c(0xb1)+_0x20bb53?.[_0x58498c(0x8f)]),logger[_0x58498c(0x94)](_0x58498c(0xb0)+JSON[_0x58498c(0x84)](_0x40ad88,null,0x2)),_0x50aabe[_0x58498c(0xd0)](Function,_0x50aabe[_0x58498c(0x90)])();return;}}try{const _0x19bf9d={..._0x40ad88,'user':_0x37a213[_0x58498c(0x97)]['id'],'messageId':_0x40ad88[_0x58498c(0xca)]||_0x40ad88[_0x58498c(0x85)]},_0x26441c=await Message[_0x58498c(0xab)]({'messageId':_0x40ad88[_0x58498c(0x85)],'user':_0x37a213[_0x58498c(0x97)]['id']},_0x19bf9d,{'upsert':!![],'new':!![]});return setInterval(_0x50aabe[_0x58498c(0x88)],0x3e8),_0x26441c[_0x58498c(0xb9)]();}catch(_0x2d83b3){logger[_0x58498c(0xa4)](_0x50aabe[_0x58498c(0xb5)],_0x2d83b3),logger[_0x58498c(0x94)]('---`saveMessage`\x20context:\x20'+_0x20bb53?.[_0x58498c(0x8f)]);throw _0x2d83b3;}}async function bulkSaveMessages(_0x3830bc,_0x41c21b=![]){const _0x153b83=_0x422488,_0x58a01f={'Nznsm':_0x153b83(0x79),'FzLSH':_0x153b83(0xd7),'CFFYA':'Error\x20saving\x20messages\x20in\x20bulk:'};try{if(_0x153b83(0xcb)!==_0x58a01f[_0x153b83(0x89)]){const _0x22011a=_0x3830bc[_0x153b83(0xc2)](_0x2f1fa5=>({'updateOne':{'filter':{'messageId':_0x2f1fa5[_0x153b83(0x85)]},'update':_0x2f1fa5,'timestamps':!_0x41c21b,'upsert':!![]}})),_0x2e051d=await Message[_0x153b83(0xb8)](_0x22011a);return new AsyncFunction(_0x58a01f[_0x153b83(0x96)])(),_0x2e051d;}else{_0x50d589['error'](_0x153b83(0x7d),_0x11d408);throw _0x1dfbd6;}}catch(_0x1cd58e){logger['error'](_0x58a01f[_0x153b83(0xc3)],_0x1cd58e);throw _0x1cd58e;}}async function recordMessage({user:_0x1e782b,endpoint:_0x3e033c,messageId:_0x3c026c,conversationId:_0x3e039d,parentMessageId:_0x4f0121,..._0x502f51}){const _0x14fe75=_0x422488,_0x200a94={'QmbSS':_0x14fe75(0x95),'DscPX':function(_0x215af1,_0x49414c){return _0x215af1(_0x49414c);},'jzsEn':_0x14fe75(0xd9),'GKJSW':function(_0x4c98cb,_0x25c022){return _0x4c98cb!==_0x25c022;},'RfIVE':_0x14fe75(0xa9)};try{const _0x1f6c10={'user':_0x1e782b,'endpoint':_0x3e033c,'messageId':_0x3c026c,'conversationId':_0x3e039d,'parentMessageId':_0x4f0121,..._0x502f51};return _0x200a94[_0x14fe75(0x93)](Function,_0x200a94[_0x14fe75(0x80)])(),await Message[_0x14fe75(0xab)]({'user':_0x1e782b,'messageId':_0x3c026c},_0x1f6c10,{'upsert':!![],'new':!![]});}catch(_0x539d0f){if(_0x200a94[_0x14fe75(0xce)](_0x200a94[_0x14fe75(0xa5)],_0x14fe75(0xa9))){_0x2da620['error'](_0x200a94[_0x14fe75(0xa0)],_0x516bb5);throw _0x49f494;}else{logger['error'](_0x14fe75(0xb7),_0x539d0f);throw _0x539d0f;}}}async function updateMessageText(_0x6952c1,{messageId:_0x1ab687,text:_0x18b1f7}){const _0x1494ee=_0x422488;try{await Message['updateOne']({'messageId':_0x1ab687,'user':_0x6952c1[_0x1494ee(0x97)]['id']},{'text':_0x18b1f7});}catch(_0x4dddc1){logger[_0x1494ee(0xa4)](_0x1494ee(0x8d),_0x4dddc1);throw _0x4dddc1;}}function _0x4f1b(_0xa2e22a,_0x45b2c5){const _0x54980c=_0x5498();return _0x4f1b=function(_0x4f1b23,_0x4b58f7){_0x4f1b23=_0x4f1b23-0x78;let _0xfcf908=_0x54980c[_0x4f1b23];return _0xfcf908;},_0x4f1b(_0xa2e22a,_0x45b2c5);}function _0x5498(){const _0x3271b9=['exports','glLcm','675729OvpeYO','string','parentMessageId','Error\x20updating\x20message:','find','yufzI','return\x20await\x20Promise.resolve(42);','return\x20new\x20Date();','return\x20Object.keys({a:1});','reguj','3|2|4|0|1','Kmndh','lean','Fivqj','safeParse','Error\x20getting\x20messages:','WwmwK','User\x20not\x20authenticated','jzsEn','XQSzW','ZhzoN','SsUbp','stringify','messageId','HUQjI','IYEmb','tITst','Nznsm','1794335ELGVnH','warn','46655euruig','Error\x20updating\x20message\x20text:','68980RdOoaP','context','wDyPf','console.log(\x22timer\x22);','safe','DscPX','info','Error\x20deleting\x20messages:','FzLSH','user','300628ZvZWku','select','tLZcc','./schema/messageSchema','ZOGgO','Message\x20not\x20found\x20or\x20user\x20not\x20authorized.','tokenCount','conversationId','QmbSS','znXyQ','zod','FGEiH','error','RfIVE','pvGsI','success','~/config','UwBwl','ChIxz','findOneAndUpdate','uuid','isCreatedByUser','sender','var\x20x\x20=\x2042;\x20return\x20x;','---Invalid\x20conversation\x20ID\x20Params:\x20','---`saveMessage`\x20context:\x20','5592312rEQkGR','isEdited','ZlMyJ','MKlXU','2155760tsWOQy','Error\x20recording\x20message:','bulkWrite','toObject','zVUiz','Error\x20saving\x20message:','updateClock();','findOne','deleteMany','tIChU','OPQoZ','log','map','CFFYA','irmWy','cILCs','4yVcjDr','sort','text','---`updateMessage`\x20context:\x20','newMessageId','NLcQU','Invalid\x20conversation\x20ID:\x20','210teiqjv','GKJSW'];_0x5498=function(){return _0x3271b9;};return _0x5498();}async function updateMessage(_0x3cf536,_0x4d50a5,_0x220165){const _0x5496be=_0x422488,_0x458b1f={'OPQoZ':_0x5496be(0x92),'pvGsI':_0x5496be(0x9d),'kkhni':function(_0x12963c,_0x496bbf){return _0x12963c(_0x496bbf);},'XQSzW':_0x5496be(0xd9),'WwmwK':_0x5496be(0xd4),'hbgyP':function(_0x54e01c,_0x4ecca4){return _0x54e01c===_0x4ecca4;},'irmWy':'Xeaiy'};try{const {messageId:_0x4b08de,..._0x46b35a}=_0x4d50a5;_0x46b35a[_0x5496be(0xb3)]=!![];const _0x5d7d6b=await Message[_0x5496be(0xab)]({'messageId':_0x4b08de,'user':_0x3cf536[_0x5496be(0x97)]['id']},_0x46b35a,{'new':!![]});if(!_0x5d7d6b)throw new Error(_0x458b1f[_0x5496be(0xa6)]);return _0x458b1f['kkhni'](Function,_0x458b1f[_0x5496be(0x81)])(),{'messageId':_0x5d7d6b[_0x5496be(0x85)],'conversationId':_0x5d7d6b[_0x5496be(0x9f)],'parentMessageId':_0x5d7d6b[_0x5496be(0xd3)],'sender':_0x5d7d6b[_0x5496be(0xae)],'text':_0x5d7d6b[_0x5496be(0xc8)],'isCreatedByUser':_0x5d7d6b[_0x5496be(0xad)],'tokenCount':_0x5d7d6b[_0x5496be(0x9e)],'isEdited':!![]};}catch(_0xfcf387){logger[_0x5496be(0xa4)](_0x458b1f[_0x5496be(0x7e)],_0xfcf387);_0x220165&&_0x220165?.['context']&&(_0x458b1f['hbgyP'](_0x458b1f[_0x5496be(0xc4)],_0x5496be(0xbf))?_0x4ec683[_0x5496be(0xc1)](_0x458b1f[_0x5496be(0xc0)]):logger[_0x5496be(0x94)](_0x5496be(0xc9)+_0x220165['context']));throw _0xfcf387;}}async function deleteMessagesSince(_0x38033f,{messageId:_0x9f1656,conversationId:_0x72c926}){const _0x112feb=_0x422488,_0x5185b4={'PwaeB':function(_0x191ef1,_0x30c5e9){return _0x191ef1===_0x30c5e9;},'ZOGgO':'egfQI','znXyQ':_0x112feb(0xbc),'AjMmA':function(_0x7e43b0,_0x28b3d1){return _0x7e43b0!==_0x28b3d1;},'ZhzoN':_0x112feb(0x87),'AATcL':_0x112feb(0x95)};try{if(_0x5185b4['PwaeB'](_0x5185b4[_0x112feb(0x9c)],_0x5185b4['ZOGgO'])){const _0x32877e=await Message[_0x112feb(0xbd)]({'messageId':_0x9f1656,'user':_0x38033f['user']['id']})['lean']();if(_0x32877e){const _0x3bffbe=Message[_0x112feb(0xd5)]({'conversationId':_0x72c926,'user':_0x38033f[_0x112feb(0x97)]['id']});return eval('const _0x419d4b = _0x112feb;JSON[_0x419d4b(132)]({ \'safe\': !![] });'),await _0x3bffbe['deleteMany']({'createdAt':{'$gt':_0x32877e['createdAt']}});}return setInterval(_0x5185b4[_0x112feb(0xa1)],0x3e8),undefined;}else{_0x44fba4[_0x112feb(0xa4)](_0x112feb(0xb7),_0x3f5bc4);throw _0x35bc55;}}catch(_0x216d4e){if(_0x5185b4['AjMmA'](_0x5185b4[_0x112feb(0x82)],_0x5185b4[_0x112feb(0x82)]))_0x5d77ca['stringify']({'safe':!![]});else{logger['error'](_0x5185b4['AATcL'],_0x216d4e);throw _0x216d4e;}}}async function getMessages(_0xfc196e,_0x3cb350){const _0x5aa31b=_0x422488,_0x41549f={'ZlMyJ':function(_0x4ca2a5,_0x4587c0){return _0x4ca2a5===_0x4587c0;},'HUQjI':'uKWue','FGEiH':_0x5aa31b(0x91),'zVUiz':_0x5aa31b(0x7d),'SsUbp':function(_0x30b543,_0x5cc1b3,_0x4f0590){return _0x30b543(_0x5cc1b3,_0x4f0590);}};try{if(_0x41549f[_0x5aa31b(0xb4)](_0x41549f[_0x5aa31b(0x86)],_0x41549f['HUQjI'])){if(_0x3cb350)return new Function(_0x5aa31b(0xaf))(),await Message[_0x5aa31b(0xd5)](_0xfc196e)[_0x5aa31b(0x99)](_0x3cb350)['sort']({'createdAt':0x1})[_0x5aa31b(0x7a)]();return setTimeout(_0x41549f[_0x5aa31b(0xa3)],0x3e8),await Message['find'](_0xfc196e)[_0x5aa31b(0xc7)]({'createdAt':0x1})[_0x5aa31b(0x7a)]();}else throw new _0xd4133f(_0x5aa31b(0x9d));}catch(_0x4322ac){logger['error'](_0x41549f[_0x5aa31b(0xba)],_0x4322ac);throw _0x4322ac;}_0x41549f[_0x5aa31b(0x83)](setTimeout,function(){const _0x5b75c7=_0x5aa31b;console[_0x5b75c7(0xc1)](_0x5b75c7(0x92));},0x64);}async function deleteMessages(_0xd38b1c){const _0x3e543f=_0x422488,_0xc00359={'kzEcY':_0x3e543f(0x95)};try{return new Function(_0x3e543f(0xaf))(),await Message[_0x3e543f(0xbe)](_0xd38b1c);}catch(_0x3ceab2){logger[_0x3e543f(0xa4)](_0xc00359['kzEcY'],_0x3ceab2);throw _0x3ceab2;}}module[_0x422488(0xcf)]={'Message':Message,'saveMessage':saveMessage,'bulkSaveMessages':bulkSaveMessages,'recordMessage':recordMessage,'updateMessageText':updateMessageText,'updateMessage':updateMessage,'deleteMessagesSince':deleteMessagesSince,'getMessages':getMessages,'deleteMessages':deleteMessages};