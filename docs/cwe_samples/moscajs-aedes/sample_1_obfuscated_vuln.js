const _0x40c27c=_0x1bb2;(function(_0x3f7edb,_0x3852d2){const _0x4e20e8=_0x1bb2,_0x1f45d2=_0x3f7edb();while(!![]){try{const _0x393b7e=parseInt(_0x4e20e8(0x196))/0x1+parseInt(_0x4e20e8(0x177))/0x2+-parseInt(_0x4e20e8(0x186))/0x3+-parseInt(_0x4e20e8(0x16b))/0x4*(-parseInt(_0x4e20e8(0x175))/0x5)+parseInt(_0x4e20e8(0x10e))/0x6+parseInt(_0x4e20e8(0x1b1))/0x7+parseInt(_0x4e20e8(0x179))/0x8*(-parseInt(_0x4e20e8(0x16d))/0x9);if(_0x393b7e===_0x3852d2)break;else _0x1f45d2['push'](_0x1f45d2['shift']());}catch(_0x5af6ff){_0x1f45d2['push'](_0x1f45d2['shift']());}}}(_0x4f92,0x9e986));const path=require(_0x40c27c(0x178)),fs=require('fs'),{reqBody,multiUserMode,userFromSession,safeJsonParse}=require(_0x40c27c(0x17a)),{normalizePath}=require('../utils/files'),{Workspace}=require(_0x40c27c(0x146)),{Document}=require(_0x40c27c(0x100)),{DocumentVectors}=require(_0x40c27c(0x163)),{WorkspaceChats}=require(_0x40c27c(0x10d)),{getVectorDbClass}=require(_0x40c27c(0x15b)),{handleFileUpload,handlePfpUpload}=require(_0x40c27c(0x137)),{validatedRequest}=require(_0x40c27c(0x11e)),{Telemetry}=require(_0x40c27c(0x195)),{flexUserRoleValid,ROLES}=require('../utils/middleware/multiUserProtected'),{EventLogs}=require(_0x40c27c(0x15e)),{WorkspaceSuggestedMessages}=require(_0x40c27c(0x165)),{validWorkspaceSlug}=require('../utils/middleware/validWorkspace'),{convertToChatHistory}=require('../utils/helpers/chat/responses'),{CollectorApi}=require(_0x40c27c(0x170)),{determineWorkspacePfpFilepath,fetchPfp}=require(_0x40c27c(0x122)),{getTTSProvider}=require(_0x40c27c(0x14e));function workspaceEndpoints(_0x38073a){const _0x505059=_0x40c27c,_0x1b6b79={'bzFHb':function(_0x3a5eaa,_0x174444,_0x3aa9ef){return _0x3a5eaa(_0x174444,_0x3aa9ef);},'wYpdU':function(_0x526598,_0x290311){return _0x526598(_0x290311);},'ZNyYr':'workspace_created','jLqvq':_0x505059(0x11b),'gYXoR':_0x505059(0x110),'qrbIf':'Unknown\x20Workspace','OtZAf':_0x505059(0x14b),'jpuof':function(_0x4ce5ca,_0x228690){return _0x4ce5ca(_0x228690);},'CxLTC':_0x505059(0x145),'ICwqL':'Error\x20updating\x20chat\x20feedback:','jhDNR':function(_0x3406a2,_0x157f53){return _0x3406a2===_0x157f53;},'CcmcB':function(_0x23f193,_0x650825,_0x2ab84a){return _0x23f193(_0x650825,_0x2ab84a);},'QRKZz':function(_0x551ac0,_0x1f2269){return _0x551ac0>_0x1f2269;},'OxcHg':function(_0x2d3d22,_0x3a9621){return _0x2d3d22!==_0x3a9621;},'kOQXi':_0x505059(0x1a4),'ytnXt':function(_0x21078f){return _0x21078f();},'hrWkB':function(_0x52b311,_0x28b35d){return _0x52b311(_0x28b35d);},'PUrtK':_0x505059(0x172),'FyRly':function(_0xe1d996){return _0xe1d996();},'icKQt':_0x505059(0x118),'kwCAT':_0x505059(0x143),'cbIbq':function(_0x215632,_0x449ae7,_0x242640){return _0x215632(_0x449ae7,_0x242640);},'iIDuP':_0x505059(0x1b3),'WsUze':_0x505059(0x191),'gORTz':_0x505059(0x184),'QIkCf':_0x505059(0x192),'UVGsF':function(_0x2afb61,_0x2680af){return _0x2afb61(_0x2680af);},'LDGpl':_0x505059(0x1a6),'woLkR':'Internal\x20server\x20error','aUJBH':_0x505059(0x183),'ooBLN':'Error\x20processing\x20the\x20pin\x20status\x20update:','RXfgu':_0x505059(0x12b),'lRoPF':_0x505059(0x12c),'ZQDla':function(_0x49bcc1,_0x4db396,_0x7da56c){return _0x49bcc1(_0x4db396,_0x7da56c);},'RXSGo':_0x505059(0x18c),'hHYUz':'TTS\x20could\x20not\x20be\x20completed','pahip':function(_0x327656,_0x5a41ca){return _0x327656!==_0x5a41ca;},'ynEzv':_0x505059(0x198),'ypbGf':'image/png','jmyJX':_0x505059(0x10c),'DODpV':_0x505059(0x180),'DSNmc':_0x505059(0x1bf),'TNHbr':function(_0x18fb0c,_0x14def3){return _0x18fb0c!==_0x14def3;},'mlIKe':_0x505059(0x13a),'tzgkj':_0x505059(0x189),'ZIMwL':_0x505059(0x150),'qZEdN':_0x505059(0x18e),'kiDfU':function(_0xb82559,_0x28896e){return _0xb82559(_0x28896e);},'FHXDS':'/workspaces','fSzHb':'/workspace/:slug/chats','kJKnv':function(_0x27e772,_0x180f49){return _0x27e772(_0x180f49);},'XgqyV':'/workspace/:slug/delete-chats','Ncmxk':function(_0x462ec4,_0x543ce1){return _0x462ec4(_0x543ce1);},'lxFTN':function(_0x3d1ac9,_0x39f947){return _0x3d1ac9(_0x39f947);},'vcAzU':_0x505059(0x160),'EzxRS':function(_0x401abd,_0x189e95){return _0x401abd(_0x189e95);},'MgHJV':'/workspace/:slug/tts/:chatId','XPLFS':_0x505059(0x1b5),'MfBFl':function(_0x3ed5d6,_0x58a38d){return _0x3ed5d6(_0x58a38d);}};if(!_0x38073a)return;const _0x17ff3f=new Map();_0x38073a['post'](_0x505059(0x1c0),[validatedRequest,flexUserRoleValid([ROLES[_0x505059(0x113)],ROLES['manager']])],async(_0x3dae7c,_0x464911)=>{const _0x37eaef=_0x505059;try{const _0x2c1bc1=await _0x1b6b79[_0x37eaef(0x132)](userFromSession,_0x3dae7c,_0x464911),{name:name=null,onboardingComplete:onboardingComplete=![]}=_0x1b6b79['wYpdU'](reqBody,_0x3dae7c),{workspace:_0x1b69b8,message:_0x57f92e}=await Workspace[_0x37eaef(0x1a1)](name,_0x2c1bc1?.['id']);await Telemetry[_0x37eaef(0x19d)](_0x1b6b79[_0x37eaef(0x141)],{'multiUserMode':multiUserMode(_0x464911),'LLMSelection':process[_0x37eaef(0x1b7)][_0x37eaef(0x158)]||_0x1b6b79[_0x37eaef(0x190)],'Embedder':process[_0x37eaef(0x1b7)][_0x37eaef(0x1c1)]||_0x1b6b79[_0x37eaef(0x155)],'VectorDbSelection':process[_0x37eaef(0x1b7)][_0x37eaef(0x14d)]||_0x37eaef(0x104)},_0x2c1bc1?.['id']),await EventLogs[_0x37eaef(0x199)]('workspace_created',{'workspaceName':_0x1b69b8?.[_0x37eaef(0x115)]||_0x1b6b79[_0x37eaef(0x1ac)]},_0x2c1bc1?.['id']);if(onboardingComplete===!![])await Telemetry[_0x37eaef(0x19d)](_0x1b6b79['OtZAf']);_0x464911[_0x37eaef(0x12a)](0xc8)[_0x37eaef(0x1b4)]({'workspace':_0x1b69b8,'message':_0x57f92e});}catch(_0x5f0ca5){console[_0x37eaef(0x136)](_0x5f0ca5['message'],_0x5f0ca5),_0x464911[_0x37eaef(0x1bb)](0x1f4)[_0x37eaef(0x168)]();}}),_0x38073a[_0x505059(0x16f)](_0x1b6b79[_0x505059(0x162)],[validatedRequest,flexUserRoleValid([ROLES[_0x505059(0x113)],ROLES[_0x505059(0x15f)]])],async(_0x3bb1fa,_0x12d35d)=>{const _0x12e987=_0x505059;try{const _0x42dfaa=await userFromSession(_0x3bb1fa,_0x12d35d),{slug:slug=null}=_0x3bb1fa[_0x12e987(0x128)],_0x540ff7=reqBody(_0x3bb1fa),_0x401b47=_0x1b6b79[_0x12e987(0x148)](multiUserMode,_0x12d35d)?await Workspace['getWithUser'](_0x42dfaa,{'slug':slug}):await Workspace[_0x12e987(0x13f)]({'slug':slug});if(!_0x401b47){_0x12d35d[_0x12e987(0x1bb)](0x190)[_0x12e987(0x168)]();return;}await Workspace[_0x12e987(0x171)](_0x401b47,_0x540ff7,_0x42dfaa);const {workspace:_0x2085d1,message:_0x3ee732}=await Workspace[_0x12e987(0x152)](_0x401b47['id'],_0x540ff7);_0x12d35d[_0x12e987(0x12a)](0xc8)[_0x12e987(0x1b4)]({'workspace':_0x2085d1,'message':_0x3ee732});}catch(_0x5ae73e){console[_0x12e987(0x136)](_0x5ae73e[_0x12e987(0x1bc)],_0x5ae73e),_0x12d35d['sendStatus'](0x1f4)['end']();}}),_0x38073a[_0x505059(0x16f)](_0x1b6b79[_0x505059(0x164)],[validatedRequest,_0x1b6b79['hrWkB'](flexUserRoleValid,[ROLES[_0x505059(0x113)],ROLES['manager']]),handleFileUpload],async function(_0x492548,_0x14e7f8){const _0x3d5e61=_0x505059,_0x2556c7=new CollectorApi(),{originalname:_0x481301}=_0x492548[_0x3d5e61(0x107)],_0x33d1d3=await _0x2556c7[_0x3d5e61(0x139)]();if(!_0x33d1d3){_0x14e7f8['status'](0x1f4)[_0x3d5e61(0x1b4)]({'success':![],'error':'Document\x20processing\x20API\x20is\x20not\x20online.\x20Document\x20'+_0x481301+_0x3d5e61(0x1b6)})[_0x3d5e61(0x168)]();return;}const {success:_0x3b2b2f,reason:_0x3ce13c}=await _0x2556c7['processDocument'](_0x481301);if(!_0x3b2b2f){_0x14e7f8[_0x3d5e61(0x12a)](0x1f4)[_0x3d5e61(0x1b4)]({'success':![],'error':_0x3ce13c})[_0x3d5e61(0x168)]();return;}_0x2556c7[_0x3d5e61(0x136)](_0x3d5e61(0x12f)+_0x481301+_0x3d5e61(0x176)),await Telemetry[_0x3d5e61(0x19d)](_0x3d5e61(0x1ab)),await EventLogs[_0x3d5e61(0x199)]('document_uploaded',{'documentName':_0x481301},_0x14e7f8[_0x3d5e61(0x10f)]?.['user']?.['id']),_0x14e7f8[_0x3d5e61(0x12a)](0xc8)['json']({'success':!![],'error':null});}),_0x38073a['post'](_0x1b6b79[_0x505059(0x1aa)],[validatedRequest,flexUserRoleValid([ROLES[_0x505059(0x113)],ROLES[_0x505059(0x15f)]])],async(_0x32944b,_0x255368)=>{const _0x5a82e0=_0x505059,_0x506632=new CollectorApi(),{link:link=''}=_0x1b6b79[_0x5a82e0(0x154)](reqBody,_0x32944b),_0x237dad=await _0x506632[_0x5a82e0(0x139)]();if(!_0x237dad){_0x255368[_0x5a82e0(0x12a)](0x1f4)[_0x5a82e0(0x1b4)]({'success':![],'error':_0x5a82e0(0x1ad)+link+'\x20will\x20not\x20be\x20processed\x20automatically.'})[_0x5a82e0(0x168)]();return;}const {success:_0x1b3289,reason:_0x495f86}=await _0x506632[_0x5a82e0(0x116)](link);if(!_0x1b3289){_0x255368[_0x5a82e0(0x12a)](0x1f4)['json']({'success':![],'error':_0x495f86})['end']();return;}_0x506632['log'](_0x5a82e0(0x105)+link+_0x5a82e0(0x176)),await Telemetry[_0x5a82e0(0x19d)](_0x5a82e0(0x145)),await EventLogs[_0x5a82e0(0x199)](_0x1b6b79[_0x5a82e0(0x111)],{'link':link},_0x255368[_0x5a82e0(0x10f)]?.[_0x5a82e0(0x19f)]?.['id']),_0x255368[_0x5a82e0(0x12a)](0xc8)[_0x5a82e0(0x1b4)]({'success':!![],'error':null});}),_0x38073a[_0x505059(0x16f)](_0x505059(0x1a3),[validatedRequest,_0x1b6b79['kiDfU'](flexUserRoleValid,[ROLES[_0x505059(0x113)],ROLES['manager']])],async(_0x3313b3,_0x5aa9ac)=>{const _0x172801=_0x505059;try{if(_0x1b6b79[_0x172801(0x1a5)](_0x172801(0x1b0),'iZNfk'))_0x16c3da[_0x172801(0x1af)](_0x1b6b79['ICwqL'],_0x579b4d),_0x121aaa[_0x172801(0x12a)](0x1f4)[_0x172801(0x168)]();else{const _0x48f8ed=await _0x1b6b79[_0x172801(0x125)](userFromSession,_0x3313b3,_0x5aa9ac),{slug:slug=null}=_0x3313b3[_0x172801(0x128)],{adds:adds=[],deletes:deletes=[]}=reqBody(_0x3313b3),_0xd1a15f=multiUserMode(_0x5aa9ac)?await Workspace[_0x172801(0x11c)](_0x48f8ed,{'slug':slug}):await Workspace['get']({'slug':slug});if(!_0xd1a15f){_0x5aa9ac[_0x172801(0x1bb)](0x190)[_0x172801(0x168)]();return;}await Document[_0x172801(0x16c)](_0xd1a15f,deletes,_0x5aa9ac['locals']?.[_0x172801(0x19f)]?.['id']);const {failedToEmbed:failedToEmbed=[],errors:errors=[]}=await Document[_0x172801(0x14c)](_0xd1a15f,adds,_0x5aa9ac['locals']?.[_0x172801(0x19f)]?.['id']),_0x416f72=await Workspace[_0x172801(0x13f)]({'id':_0xd1a15f['id']});_0x5aa9ac[_0x172801(0x12a)](0xc8)[_0x172801(0x1b4)]({'workspace':_0x416f72,'message':_0x1b6b79[_0x172801(0x16a)](failedToEmbed[_0x172801(0x1a2)],0x0)?failedToEmbed['length']+_0x172801(0x1b2)+errors['map'](_0x1a97bc=>''+_0x1a97bc)[_0x172801(0x19b)]('\x0a\x0a'):null});}}catch(_0x3572a5){console[_0x172801(0x136)](_0x3572a5[_0x172801(0x1bc)],_0x3572a5),_0x5aa9ac['sendStatus'](0x1f4)[_0x172801(0x168)]();}}),_0x38073a['delete']('/workspace/:slug',[validatedRequest,_0x1b6b79['wYpdU'](flexUserRoleValid,[ROLES[_0x505059(0x113)],ROLES[_0x505059(0x15f)]])],async(_0xa44791,_0x15c31a)=>{const _0x4767e9=_0x505059;if(_0x1b6b79[_0x4767e9(0x126)](_0x4767e9(0x17d),_0x4767e9(0x17d)))_0x4596e6[_0x4767e9(0x1af)](_0x3a6bac[_0x4767e9(0x1bc)]);else try{if(_0x1b6b79[_0x4767e9(0x18f)]===_0x4767e9(0x15c)){_0x575b0a[_0x4767e9(0x1bb)](0x190)[_0x4767e9(0x168)]();return;}else{const {slug:slug=''}=_0xa44791[_0x4767e9(0x128)],_0x58c8b8=await _0x1b6b79['CcmcB'](userFromSession,_0xa44791,_0x15c31a),_0x417f41=_0x1b6b79[_0x4767e9(0x13d)](getVectorDbClass),_0x423a44=multiUserMode(_0x15c31a)?await Workspace[_0x4767e9(0x11c)](_0x58c8b8,{'slug':slug}):await Workspace[_0x4767e9(0x13f)]({'slug':slug});if(!_0x423a44){_0x15c31a[_0x4767e9(0x1bb)](0x190)['end']();return;}await WorkspaceChats[_0x4767e9(0x13c)]({'workspaceId':_0x1b6b79['jpuof'](Number,_0x423a44['id'])}),await DocumentVectors[_0x4767e9(0x17f)](_0x423a44['id']),await Document['delete']({'workspaceId':_0x1b6b79[_0x4767e9(0x194)](Number,_0x423a44['id'])}),await Workspace['delete']({'id':_0x1b6b79[_0x4767e9(0x148)](Number,_0x423a44['id'])}),await EventLogs[_0x4767e9(0x199)](_0x4767e9(0x121),{'workspaceName':_0x423a44?.[_0x4767e9(0x115)]||_0x4767e9(0x18a)},_0x15c31a[_0x4767e9(0x10f)]?.[_0x4767e9(0x19f)]?.['id']);try{await _0x417f41[_0x1b6b79[_0x4767e9(0x173)]]({'namespace':slug});}catch(_0x3f0ced){console['error'](_0x3f0ced[_0x4767e9(0x1bc)]);}_0x15c31a[_0x4767e9(0x1bb)](0xc8)['end']();}}catch(_0x24e0cc){console['log'](_0x24e0cc[_0x4767e9(0x1bc)],_0x24e0cc),_0x15c31a[_0x4767e9(0x1bb)](0x1f4)[_0x4767e9(0x168)]();}}),_0x38073a['delete'](_0x505059(0x12d),[validatedRequest,_0x1b6b79[_0x505059(0x10a)](flexUserRoleValid,[ROLES['admin'],ROLES[_0x505059(0x15f)]])],async(_0x2a8923,_0x51eb55)=>{const _0x495557=_0x505059,_0x43ef6b={'HLvYV':function(_0x579db1,_0x41747b){return _0x1b6b79['hrWkB'](_0x579db1,_0x41747b);}};try{const {slug:slug=''}=_0x2a8923[_0x495557(0x128)],_0x24850f=await userFromSession(_0x2a8923,_0x51eb55),_0x50ef66=_0x1b6b79[_0x495557(0x147)](getVectorDbClass),_0x1a6aef=multiUserMode(_0x51eb55)?await Workspace[_0x495557(0x11c)](_0x24850f,{'slug':slug}):await Workspace[_0x495557(0x13f)]({'slug':slug});if(!_0x1a6aef){if(_0x1b6b79[_0x495557(0x11d)]===_0x495557(0x118)){_0x51eb55[_0x495557(0x1bb)](0x190)['end']();return;}else{_0x4be65f[_0x495557(0x12a)](0x1f4)[_0x495557(0x1b4)]({'success':![],'error':_0x495557(0x1ad)+_0xdc80b2+_0x495557(0x1b6)})[_0x495557(0x168)]();return;}}await DocumentVectors[_0x495557(0x17f)](_0x1a6aef['id']),await Document[_0x495557(0x13c)]({'workspaceId':Number(_0x1a6aef['id'])}),await EventLogs[_0x495557(0x199)](_0x495557(0x1b9),{'workspaceName':_0x1a6aef?.['name']||_0x495557(0x18a)},_0x51eb55[_0x495557(0x10f)]?.[_0x495557(0x19f)]?.['id']);try{await _0x50ef66['delete-namespace']({'namespace':slug});}catch(_0x562549){console['error'](_0x562549[_0x495557(0x1bc)]);}_0x51eb55[_0x495557(0x1bb)](0xc8)[_0x495557(0x168)]();}catch(_0x3bc58c){if(_0x1b6b79[_0x495557(0x169)]!==_0x495557(0x157))console['log'](_0x3bc58c[_0x495557(0x1bc)],_0x3bc58c),_0x51eb55[_0x495557(0x1bb)](0x1f4)['end']();else{const _0x6b2e8d=_0x518dee['join'](_0x2580a1,_0x495557(0x167)+_0x43ef6b[_0x495557(0x14f)](_0x2a3cf3,_0x29d00d[_0x495557(0x156)]));if(_0x20302f[_0x495557(0x140)](_0x6b2e8d))_0x52191c[_0x495557(0x144)](_0x6b2e8d);}}}),_0x38073a[_0x505059(0x13f)](_0x1b6b79[_0x505059(0x112)],[validatedRequest,_0x1b6b79[_0x505059(0x154)](flexUserRoleValid,[ROLES[_0x505059(0x14a)]])],async(_0x392a29,_0x47941b)=>{const _0x1079e6=_0x505059;try{const _0x4e40e1=await _0x1b6b79['bzFHb'](userFromSession,_0x392a29,_0x47941b),_0x4b67f1=_0x1b6b79[_0x1079e6(0x154)](multiUserMode,_0x47941b)?await Workspace[_0x1079e6(0x16e)](_0x4e40e1):await Workspace['where']();_0x47941b[_0x1079e6(0x12a)](0xc8)[_0x1079e6(0x1b4)]({'workspaces':_0x4b67f1});}catch(_0x3781be){console[_0x1079e6(0x136)](_0x3781be['message'],_0x3781be),_0x47941b[_0x1079e6(0x1bb)](0x1f4)[_0x1079e6(0x168)]();}}),_0x38073a[_0x505059(0x13f)](_0x505059(0x103),[validatedRequest,_0x1b6b79[_0x505059(0x194)](flexUserRoleValid,[ROLES[_0x505059(0x14a)]])],async(_0x56dc47,_0x3bc5a1)=>{const _0xb62b63=_0x505059;try{const {slug:_0x126e78}=_0x56dc47[_0xb62b63(0x128)],_0x196e52=await _0x1b6b79[_0xb62b63(0x142)](userFromSession,_0x56dc47,_0x3bc5a1),_0x61f350=_0x1b6b79[_0xb62b63(0x194)](multiUserMode,_0x3bc5a1)?await Workspace['getWithUser'](_0x196e52,{'slug':_0x126e78}):await Workspace['get']({'slug':_0x126e78});_0x3bc5a1[_0xb62b63(0x12a)](0xc8)['json']({'workspace':_0x61f350});}catch(_0xc06d74){console['log'](_0xc06d74[_0xb62b63(0x1bc)],_0xc06d74),_0x3bc5a1[_0xb62b63(0x1bb)](0x1f4)[_0xb62b63(0x168)]();}}),_0x38073a[_0x505059(0x13f)](_0x1b6b79[_0x505059(0x166)],[validatedRequest,_0x1b6b79[_0x505059(0x17e)](flexUserRoleValid,[ROLES[_0x505059(0x14a)]])],async(_0x10fb25,_0x5a2e2a)=>{const _0x29d0d0=_0x505059;if(_0x1b6b79['iIDuP']===_0x1b6b79[_0x29d0d0(0x12e)]){_0x532f6c[_0x29d0d0(0x1bb)](0x190)[_0x29d0d0(0x168)]();return;}else try{const {slug:_0x4efc46}=_0x10fb25['params'],_0xa59f1c=await userFromSession(_0x10fb25,_0x5a2e2a),_0x1b2860=multiUserMode(_0x5a2e2a)?await Workspace[_0x29d0d0(0x11c)](_0xa59f1c,{'slug':_0x4efc46}):await Workspace[_0x29d0d0(0x13f)]({'slug':_0x4efc46});if(!_0x1b2860){if(_0x29d0d0(0x1ba)!=='OvqrE')_0x24bd03[_0x29d0d0(0x136)](_0x416820[_0x29d0d0(0x1bc)],_0x8f169a),_0x20e60a[_0x29d0d0(0x1bb)](0x1f4)[_0x29d0d0(0x168)]();else{_0x5a2e2a[_0x29d0d0(0x1bb)](0x190)[_0x29d0d0(0x168)]();return;}}const _0x5c1ff2=multiUserMode(_0x5a2e2a)?await WorkspaceChats[_0x29d0d0(0x119)](_0x1b2860['id'],_0xa59f1c['id']):await WorkspaceChats[_0x29d0d0(0x135)](_0x1b2860['id']);_0x5a2e2a[_0x29d0d0(0x12a)](0xc8)[_0x29d0d0(0x1b4)]({'history':convertToChatHistory(_0x5c1ff2)});}catch(_0x1ae594){console[_0x29d0d0(0x136)](_0x1ae594[_0x29d0d0(0x1bc)],_0x1ae594),_0x5a2e2a[_0x29d0d0(0x1bb)](0x1f4)[_0x29d0d0(0x168)]();}}),_0x38073a[_0x505059(0x13c)](_0x1b6b79[_0x505059(0x18b)],[validatedRequest,flexUserRoleValid([ROLES[_0x505059(0x14a)]]),validWorkspaceSlug],async(_0x3922d9,_0x317c2e)=>{const _0x22306e=_0x505059;try{const {chatIds:chatIds=[]}=reqBody(_0x3922d9),_0x39c6e5=await userFromSession(_0x3922d9,_0x317c2e),_0x32647e=_0x317c2e[_0x22306e(0x10f)][_0x22306e(0x124)];if(!_0x32647e||!Array['isArray'](chatIds)){_0x317c2e[_0x22306e(0x1bb)](0x190)[_0x22306e(0x168)]();return;}await WorkspaceChats['delete']({'id':{'in':chatIds[_0x22306e(0x123)](_0x1e337c=>Number(_0x1e337c))},'user_id':_0x39c6e5?.['id']??null,'workspaceId':_0x32647e['id']}),_0x317c2e[_0x22306e(0x1bb)](0xc8)[_0x22306e(0x168)]();}catch(_0x5807b4){console[_0x22306e(0x136)](_0x5807b4[_0x22306e(0x1bc)],_0x5807b4),_0x317c2e[_0x22306e(0x1bb)](0x1f4)[_0x22306e(0x168)]();}}),_0x38073a['post'](_0x505059(0x13e),[validatedRequest,_0x1b6b79[_0x505059(0x13b)](flexUserRoleValid,[ROLES['all']]),validWorkspaceSlug],async(_0x41cb5e,_0x51678a)=>{const _0x5789d2=_0x505059,_0x5ab5a3={'vdKuG':_0x1b6b79['gORTz']};if('OesRm'===_0x1b6b79[_0x5789d2(0x134)])try{const {chatId:_0x21c392}=_0x41cb5e['params'],{feedback:feedback=null}=reqBody(_0x41cb5e),_0x5825cf=await WorkspaceChats['get']({'id':_0x1b6b79[_0x5789d2(0x10a)](Number,_0x21c392),'workspaceId':_0x51678a[_0x5789d2(0x10f)][_0x5789d2(0x124)]['id']});if(!_0x5825cf){if(_0x5789d2(0x1a7)===_0x5789d2(0x1a7)){_0x51678a['status'](0x194)['end']();return;}else{const _0x1caa8d=_0x18b3d9['join'](_0x5659b9,'../storage/assets/pfp/'+_0x4ddbbd(_0x5cbf7d));if(_0x1017d5[_0x5789d2(0x140)](_0x1caa8d))_0x5317c8[_0x5789d2(0x144)](_0x1caa8d);}}const _0x808525=await WorkspaceChats['updateFeedbackScore'](_0x21c392,feedback);_0x51678a[_0x5789d2(0x12a)](0xc8)[_0x5789d2(0x1b4)]({'success':_0x808525});}catch(_0x31d8b4){console['error'](_0x1b6b79['ICwqL'],_0x31d8b4),_0x51678a[_0x5789d2(0x12a)](0x1f4)[_0x5789d2(0x168)]();}else return _0x34892f[_0x5789d2(0x12a)](0x190)[_0x5789d2(0x1b4)]({'message':_0x5ab5a3['vdKuG']});}),_0x38073a[_0x505059(0x13f)](_0x505059(0x159),[validatedRequest,flexUserRoleValid([ROLES[_0x505059(0x14a)]])],async function(_0x2595dc,_0x5bd0e8){const _0x463df0=_0x505059;try{const {slug:_0x484aa1}=_0x2595dc[_0x463df0(0x128)],_0x598117=await WorkspaceSuggestedMessages[_0x463df0(0x1a0)](_0x484aa1);_0x5bd0e8['status'](0xc8)[_0x463df0(0x1b4)]({'success':!![],'suggestedMessages':_0x598117});}catch(_0x270c25){if(_0x1b6b79[_0x463df0(0x17c)]!=='ruvwt'){_0x3b8378[_0x463df0(0x1bb)](0x190)['end']();return;}else console['error'](_0x463df0(0x18d),_0x270c25),_0x5bd0e8[_0x463df0(0x12a)](0x1f4)['json']({'success':![],'message':_0x1b6b79[_0x463df0(0x11f)]});}}),_0x38073a['post']('/workspace/:slug/suggested-messages',[validatedRequest,_0x1b6b79[_0x505059(0x19c)](flexUserRoleValid,[ROLES['admin'],ROLES[_0x505059(0x15f)]])],async(_0x51d45f,_0x197a4c)=>{const _0x481a7d=_0x505059;try{const {messages:messages=[]}=_0x1b6b79[_0x481a7d(0x10a)](reqBody,_0x51d45f),{slug:_0x47bb51}=_0x51d45f[_0x481a7d(0x128)];if(!Array[_0x481a7d(0x185)](messages))return _0x197a4c['status'](0x190)[_0x481a7d(0x1b4)]({'success':![],'message':_0x1b6b79['aUJBH']});return await WorkspaceSuggestedMessages['saveAll'](messages,_0x47bb51),_0x197a4c[_0x481a7d(0x12a)](0xc8)['json']({'success':!![],'message':'Suggested\x20messages\x20saved\x20successfully.'});}catch(_0x5a7726){console[_0x481a7d(0x1af)]('Error\x20processing\x20the\x20suggested\x20messages:',_0x5a7726),_0x197a4c['status'](0x1f4)[_0x481a7d(0x1b4)]({'success':!![],'message':_0x481a7d(0x1b8)});}}),_0x38073a[_0x505059(0x16f)](_0x1b6b79[_0x505059(0x106)],[validatedRequest,_0x1b6b79[_0x505059(0x15d)](flexUserRoleValid,[ROLES[_0x505059(0x113)],ROLES[_0x505059(0x15f)]]),validWorkspaceSlug],async(_0x278aec,_0x139415)=>{const _0x547b89=_0x505059;try{const {docPath:_0x37ee11,pinStatus:pinStatus=![]}=reqBody(_0x278aec),_0x161dae=_0x139415['locals'][_0x547b89(0x124)],_0x4ff188=await Document[_0x547b89(0x13f)]({'workspaceId':_0x161dae['id'],'docpath':_0x37ee11});if(!_0x4ff188)return _0x139415['sendStatus'](0x194)[_0x547b89(0x168)]();return await Document[_0x547b89(0x152)](_0x4ff188['id'],{'pinned':pinStatus}),_0x139415[_0x547b89(0x12a)](0xc8)[_0x547b89(0x168)]();}catch(_0x291880){return console[_0x547b89(0x1af)](_0x547b89(0x174),_0x291880),_0x139415['status'](0x1f4)[_0x547b89(0x168)]();}}),_0x38073a[_0x505059(0x13f)](_0x1b6b79[_0x505059(0x17b)],[validatedRequest,_0x1b6b79['UVGsF'](flexUserRoleValid,[ROLES[_0x505059(0x14a)]]),validWorkspaceSlug],async function(_0x5df48a,_0x49cf35){const _0x5293f5=_0x505059;try{if('fExBq'!==_0x1b6b79[_0x5293f5(0x19e)])return _0x2f8397['error'](_0x1b6b79[_0x5293f5(0x19a)],_0xa20fc1),_0x4e4c35[_0x5293f5(0x12a)](0x1f4)['end']();else{const {chatId:_0x278903}=_0x5df48a[_0x5293f5(0x128)],_0x486e30=_0x49cf35[_0x5293f5(0x10f)][_0x5293f5(0x124)],_0x5cde87=_0x486e30[_0x5293f5(0x193)]+':'+_0x278903,_0x4fff79=await WorkspaceChats[_0x5293f5(0x13f)]({'id':_0x1b6b79[_0x5293f5(0x10a)](Number,_0x278903),'workspaceId':_0x486e30['id']}),_0x11d6e7=_0x17ff3f[_0x5293f5(0x13f)](_0x5cde87);if(_0x11d6e7){_0x49cf35[_0x5293f5(0x187)](0xc8,{'Content-Type':_0x11d6e7[_0x5293f5(0x1ae)]||_0x1b6b79['lRoPF']}),_0x49cf35[_0x5293f5(0x168)](_0x11d6e7['buffer']);return;}const _0x78d39d=_0x1b6b79[_0x5293f5(0x129)](safeJsonParse,_0x4fff79['response'],null)?.['text'];if(!_0x78d39d)return _0x49cf35[_0x5293f5(0x1bb)](0xcc)[_0x5293f5(0x168)]();const _0x3ee5a0=getTTSProvider(),_0x37a741=await _0x3ee5a0[_0x5293f5(0x102)](_0x78d39d);if(_0x37a741===null)return _0x49cf35[_0x5293f5(0x1bb)](0xcc)[_0x5293f5(0x168)]();_0x17ff3f['set'](_0x5cde87,{'buffer':_0x37a741,'mime':_0x1b6b79['lRoPF']}),_0x49cf35[_0x5293f5(0x187)](0xc8,{'Content-Type':_0x1b6b79[_0x5293f5(0x133)]}),_0x49cf35[_0x5293f5(0x168)](_0x37a741);return;}}catch(_0xa1da33){console['error'](_0x1b6b79[_0x5293f5(0x101)],_0xa1da33),_0x49cf35[_0x5293f5(0x12a)](0x1f4)[_0x5293f5(0x1b4)]({'message':_0x1b6b79[_0x5293f5(0x1be)]});}}),_0x38073a[_0x505059(0x13f)]('/workspace/:slug/pfp',[validatedRequest,_0x1b6b79[_0x505059(0x154)](flexUserRoleValid,[ROLES[_0x505059(0x14a)]])],async function(_0x4276d1,_0x204226){const _0x19af5a=_0x505059;if(_0x1b6b79[_0x19af5a(0x130)](_0x19af5a(0x127),_0x1b6b79['ynEzv']))try{const {slug:_0x9212f9}=_0x4276d1[_0x19af5a(0x128)],_0x160b06=_0x17ff3f[_0x19af5a(0x13f)](_0x9212f9);if(_0x160b06){_0x204226[_0x19af5a(0x187)](0xc8,{'Content-Type':_0x160b06['mime']||_0x1b6b79[_0x19af5a(0x188)]}),_0x204226[_0x19af5a(0x168)](_0x160b06[_0x19af5a(0x151)]);return;}const _0x4308d3=await determineWorkspacePfpFilepath(_0x9212f9);if(!_0x4308d3){if(_0x1b6b79[_0x19af5a(0x1a5)]('kDltR','kDltR')){_0x204226[_0x19af5a(0x1bb)](0xcc)[_0x19af5a(0x168)]();return;}else _0x2d2d81[_0x19af5a(0x136)](_0x40c7a4[_0x19af5a(0x1bc)],_0x270f21),_0x3972da[_0x19af5a(0x1bb)](0x1f4)[_0x19af5a(0x168)]();}const {found:_0x227121,buffer:_0xcb4c6a,mime:_0x2de23b}=_0x1b6b79['hrWkB'](fetchPfp,_0x4308d3);if(!_0x227121){_0x204226[_0x19af5a(0x1bb)](0xcc)['end']();return;}_0x17ff3f[_0x19af5a(0x15a)](_0x9212f9,{'buffer':_0xcb4c6a,'mime':_0x2de23b}),_0x204226[_0x19af5a(0x187)](0xc8,{'Content-Type':_0x2de23b||_0x19af5a(0x11a)}),_0x204226[_0x19af5a(0x168)](_0xcb4c6a);return;}catch(_0x5d9fde){console[_0x19af5a(0x1af)](_0x1b6b79[_0x19af5a(0x138)],_0x5d9fde),_0x204226[_0x19af5a(0x12a)](0x1f4)[_0x19af5a(0x1b4)]({'message':_0x1b6b79[_0x19af5a(0x11f)]});}else _0x4d26a0['log'](_0x2c9e07[_0x19af5a(0x1bc)],_0x9cafb2),_0x4dd2d4[_0x19af5a(0x1bb)](0x1f4)[_0x19af5a(0x168)]();}),_0x38073a['post'](_0x1b6b79[_0x505059(0x182)],[validatedRequest,flexUserRoleValid([ROLES[_0x505059(0x113)],ROLES[_0x505059(0x15f)]]),handlePfpUpload],async function(_0x1d23b8,_0x2df48a){const _0x598a06=_0x505059;try{const {slug:_0x42faa9}=_0x1d23b8['params'],_0x17990b=_0x1d23b8[_0x598a06(0x149)];if(!_0x17990b)return _0x2df48a[_0x598a06(0x12a)](0x190)[_0x598a06(0x1b4)]({'message':_0x598a06(0x184)});const _0x43c7a7=await Workspace[_0x598a06(0x13f)]({'slug':_0x42faa9}),_0x507eae=_0x43c7a7[_0x598a06(0x156)];if(_0x507eae){const _0x464ce3=path[_0x598a06(0x19b)](__dirname,'../storage/assets/pfp/'+_0x1b6b79[_0x598a06(0x154)](normalizePath,_0x43c7a7[_0x598a06(0x156)]));if(fs[_0x598a06(0x140)](_0x464ce3))fs[_0x598a06(0x144)](_0x464ce3);}const {workspace:_0x226332,message:_0x2cb4aa}=await Workspace['_update'](_0x43c7a7['id'],{'pfpFilename':_0x17990b});return _0x2df48a[_0x598a06(0x12a)](_0x226332?0xc8:0x1f4)['json']({'message':_0x226332?_0x598a06(0x161):_0x2cb4aa});}catch(_0x58de8a){if(_0x1b6b79[_0x598a06(0x117)]!==_0x1b6b79[_0x598a06(0x108)])console[_0x598a06(0x1af)](_0x598a06(0x114),_0x58de8a),_0x2df48a[_0x598a06(0x12a)](0x1f4)[_0x598a06(0x1b4)]({'message':_0x1b6b79[_0x598a06(0x11f)]});else{_0x438335[_0x598a06(0x1bb)](0x190)['end']();return;}}}),_0x38073a[_0x505059(0x13c)](_0x505059(0x153),[validatedRequest,_0x1b6b79[_0x505059(0x1a9)](flexUserRoleValid,[ROLES[_0x505059(0x113)],ROLES['manager']])],async function(_0x11c6dc,_0x2b15e0){const _0x19f990=_0x505059;if(_0x19f990(0x120)===_0x19f990(0x120))try{if(_0x19f990(0x10b)!=='ArKyx')return _0x182663[_0x19f990(0x12a)](0x190)[_0x19f990(0x1b4)]({'success':![],'message':_0x1b6b79[_0x19f990(0x131)]});else{const {slug:_0x345b73}=_0x11c6dc['params'],_0x4efe66=await Workspace[_0x19f990(0x13f)]({'slug':_0x345b73}),_0xd0d94c=_0x4efe66[_0x19f990(0x156)];if(_0xd0d94c){const _0x36a502=path[_0x19f990(0x19b)](__dirname,'../storage/assets/pfp/'+normalizePath(_0xd0d94c));if(fs['existsSync'](_0x36a502))fs[_0x19f990(0x144)](_0x36a502);}const {workspace:_0x454d16,message:_0x3d4b0e}=await Workspace[_0x19f990(0x197)](_0x4efe66['id'],{'pfpFilename':null});return _0x17ff3f[_0x19f990(0x13c)](_0x345b73),_0x2b15e0[_0x19f990(0x12a)](_0x454d16?0xc8:0x1f4)[_0x19f990(0x1b4)]({'message':_0x454d16?_0x19f990(0x1bd):_0x3d4b0e});}}catch(_0x11f572){_0x1b6b79[_0x19f990(0x181)](_0x1b6b79[_0x19f990(0x109)],'XFgYl')?(_0x367c14['error'](_0x19f990(0x18c),_0x31d8d4),_0x1cd3f5[_0x19f990(0x12a)](0x1f4)['json']({'message':'TTS\x20could\x20not\x20be\x20completed'})):(console[_0x19f990(0x1af)](_0x19f990(0x1a8),_0x11f572),_0x2b15e0[_0x19f990(0x12a)](0x1f4)[_0x19f990(0x1b4)]({'message':_0x1b6b79['woLkR']}));}else{_0x59d7d3['status'](0x1f4)['json']({'success':![],'error':_0x5b207c})[_0x19f990(0x168)]();return;}});}function _0x1bb2(_0x2e528f,_0x2cc705){const _0x4f92e5=_0x4f92();return _0x1bb2=function(_0x1bb239,_0x6cea25){_0x1bb239=_0x1bb239-0x100;let _0x62d593=_0x4f92e5[_0x1bb239];return _0x62d593;},_0x1bb2(_0x2e528f,_0x2cc705);}function _0x4f92(){const _0x10e5b3=['logEvent','ooBLN','join','lxFTN','sendTelemetry','RXfgu','user','getMessages','new','length','/workspace/:slug/update-embeddings','ZiTsG','jhDNR','ruvwt','RIvWg','Error\x20processing\x20the\x20profile\x20picture\x20removal:','MfBFl','qZEdN','document_uploaded','qrbIf','Document\x20processing\x20API\x20is\x20not\x20online.\x20Link\x20','mime','error','Ujkqh','4945017SiLBoe','\x20documents\x20failed\x20to\x20add.\x0a\x0a','yDXHB','json','/workspace/:slug/upload-pfp','\x20will\x20not\x20be\x20processed\x20automatically.','env','Error\x20saving\x20the\x20suggested\x20messages.','workspace_vectors_reset','OvqrE','sendStatus','message','Profile\x20picture\x20removed\x20successfully.','hHYUz','Dkdwb','/workspace/new','EMBEDDING_ENGINE','../models/documents','RXSGo','ttsBuffer','/workspace/:slug','lancedb','Link\x20','vcAzU','file','DSNmc','mlIKe','UVGsF','ArKyx','Error\x20processing\x20the\x20logo\x20request:','../models/workspaceChats','6924066NdVNGr','locals','inherit','CxLTC','FHXDS','admin','Error\x20processing\x20the\x20profile\x20picture\x20upload:','name','processLink','DODpV','lXKup','forWorkspaceByUser','image/png','openai','getWithUser','icKQt','../utils/middleware/validatedRequest','woLkR','bxBEi','workspace_deleted','../utils/files/pfp','map','workspace','CcmcB','OxcHg','yTqrH','params','ZQDla','status','fExBq','audio/mpeg','/workspace/:slug/reset-vector-db','WsUze','Document\x20','pahip','aUJBH','bzFHb','lRoPF','QIkCf','forWorkspace','log','../utils/files/multer','jmyJX','online','XFgYl','Ncmxk','delete','ytnXt','/workspace/:slug/chat-feedback/:chatId','get','existsSync','ZNyYr','cbIbq','KNrEL','unlinkSync','link_uploaded','../models/workspace','FyRly','jpuof','randomFileName','all','onboarding_complete','addDocuments','VECTOR_DB','../utils/TextToSpeech','HLvYV','/workspace/:slug/upload','buffer','update','/workspace/:slug/remove-pfp','wYpdU','gYXoR','pfpFilename','wVjcG','LLM_PROVIDER','/workspace/:slug/suggested-messages','set','../utils/helpers','MLgdC','EzxRS','../models/eventLogs','manager','/workspace/:slug/update-pin','Profile\x20picture\x20uploaded\x20successfully.','tzgkj','../models/vectors','ZIMwL','../models/workspacesSuggestedMessages','fSzHb','../storage/assets/pfp/','end','kwCAT','QRKZz','49272iEsNTM','removeDocuments','1737VsbRIV','whereWithUser','post','../utils/collectorApi','trackChange','delete-namespace','PUrtK','Error\x20processing\x20the\x20pin\x20status\x20update:','55jhdqch','\x20uploaded\x20processed\x20and\x20successfully.\x20It\x20is\x20now\x20available\x20in\x20documents.','582578muJGTr','path','65432fjwTai','../utils/http','MgHJV','LDGpl','AMRUY','kJKnv','deleteForWorkspace','CyWae','TNHbr','XPLFS','Invalid\x20message\x20format.\x20Expected\x20an\x20array\x20of\x20messages.','File\x20upload\x20failed.','isArray','466662rcueBS','writeHead','ypbGf','/workspace/:slug/update','Unknown\x20Workspace','XgqyV','Error\x20processing\x20the\x20TTS\x20request:','Error\x20fetching\x20suggested\x20messages:','/workspace/:slug/upload-link','kOQXi','jLqvq','TQShB','OesRm','slug','hrWkB','../models/telemetry','96478mGfBzp','_update','GXGzM'];_0x4f92=function(){return _0x10e5b3;};return _0x4f92();}module['exports']={'workspaceEndpoints':workspaceEndpoints};