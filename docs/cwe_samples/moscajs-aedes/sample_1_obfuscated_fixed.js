const _0x573a9c=_0x4938;(function(_0x111ad3,_0xfadd9d){const _0x183a55=_0x4938,_0x5ce165=_0x111ad3();while(!![]){try{const _0x2c5b5e=parseInt(_0x183a55(0xab))/0x1+-parseInt(_0x183a55(0xde))/0x2*(parseInt(_0x183a55(0xbd))/0x3)+parseInt(_0x183a55(0x9e))/0x4*(-parseInt(_0x183a55(0xa5))/0x5)+-parseInt(_0x183a55(0xb1))/0x6+parseInt(_0x183a55(0xc6))/0x7+-parseInt(_0x183a55(0xb7))/0x8+parseInt(_0x183a55(0xc5))/0x9;if(_0x2c5b5e===_0xfadd9d)break;else _0x5ce165['push'](_0x5ce165['shift']());}catch(_0x2b5dde){_0x5ce165['push'](_0x5ce165['shift']());}}}(_0x1ba9,0x1c981));const {v4:uuidv4}=require(_0x573a9c(0xa6)),{getVectorDbClass,getLLMProvider}=require(_0x573a9c(0xd6)),{chatPrompt}=require('./index'),{EmbedChats}=require(_0x573a9c(0xd5)),{convertToPromptHistory,writeResponseChunk}=require('../helpers/chat/responses'),{DocumentManager}=require(_0x573a9c(0xa2));async function streamChatWithForEmbed(_0x4e2e76,_0xc8ad81,_0x22e411,_0x3f1a21,{promptOverride:_0x43eee1,modelOverride:_0x155cd6,temperatureOverride:_0x2b4121}){const _0x5ba73c=_0x573a9c,_0x1e33d4={'afyhG':_0x5ba73c(0xc1),'dhgdK':'Failed\x20to\x20connect\x20to\x20vector\x20database\x20provider.','eIseJ':function(_0x3aba99,_0x263125){return _0x3aba99(_0x263125);},'cXabb':function(_0x515729){return _0x515729();},'YodSC':_0x5ba73c(0xa4),'qYalT':_0x5ba73c(0xdc),'jUecy':_0x5ba73c(0xc2),'wuTkR':function(_0x30f883,_0x4ca7ed,_0x2ac933){return _0x30f883(_0x4ca7ed,_0x2ac933);},'Hrtky':function(_0x217025,_0x4c6be3){return _0x217025===_0x4c6be3;},'MauZf':function(_0x537b39,_0x4d4c1a){return _0x537b39!==_0x4d4c1a;},'NbgJo':function(_0x13d88a,_0x4565a2){return _0x13d88a===_0x4565a2;}},_0x33f052=_0xc8ad81[_0x5ba73c(0xb4)],_0x1e32b5=_0xc8ad81[_0x5ba73c(0xb6)]?_0x155cd6:null;if(_0xc8ad81[_0x5ba73c(0xcb)])_0xc8ad81['workspace']['openAiPrompt']=_0x43eee1;if(_0xc8ad81[_0x5ba73c(0xd8)])_0xc8ad81[_0x5ba73c(0xd1)][_0x5ba73c(0xda)]=_0x1e33d4[_0x5ba73c(0xaa)](parseFloat,_0x2b4121);const _0x21701f=uuidv4(),_0x349ec5=_0x1e33d4[_0x5ba73c(0xaa)](getLLMProvider,_0x1e32b5??_0xc8ad81['workspace']?.['chatModel']),_0x586d8a=_0x1e33d4['cXabb'](getVectorDbClass),{safe:_0x41bbe2,reasons:reasons=[]}=await _0x349ec5[_0x5ba73c(0xc8)](_0x22e411);if(!_0x41bbe2){writeResponseChunk(_0x4e2e76,{'id':_0x21701f,'type':_0x1e33d4[_0x5ba73c(0xaf)],'textResponse':null,'sources':[],'close':!![],'error':_0x5ba73c(0x9c)+reasons[_0x5ba73c(0xdf)](',\x20')+_0x5ba73c(0xbb)});return;}const _0x208edc=0x14,_0x4a5639=await _0x586d8a[_0x5ba73c(0xa7)](_0xc8ad81[_0x5ba73c(0xd1)][_0x5ba73c(0xbf)]),_0x3217e5=await _0x586d8a[_0x5ba73c(0xa1)](_0xc8ad81[_0x5ba73c(0xd1)][_0x5ba73c(0xbf)]);if((!_0x4a5639||_0x3217e5===0x0)&&_0x33f052===_0x1e33d4[_0x5ba73c(0xba)]){writeResponseChunk(_0x4e2e76,{'id':_0x21701f,'type':_0x1e33d4[_0x5ba73c(0xb8)],'textResponse':_0x5ba73c(0xce),'sources':[],'close':!![],'error':null});return;}let _0x386423,_0x37e8df=[],_0x27770e=[];const {rawHistory:_0x5a5f22,chatHistory:_0x16a708}=await recentEmbedChatHistory(_0x3f1a21,_0xc8ad81,_0x208edc,_0x33f052);await new DocumentManager({'workspace':_0xc8ad81[_0x5ba73c(0xd1)],'maxTokens':_0x349ec5[_0x5ba73c(0xa8)][_0x5ba73c(0xc9)]})[_0x5ba73c(0xbe)]()[_0x5ba73c(0xdd)](_0x590fac=>{const _0x3d8a22=_0x5ba73c;_0x590fac[_0x3d8a22(0xa9)](_0x3ee48a=>{const _0x4a0723=_0x3d8a22,{pageContent:_0x164f73,..._0x5cbdb1}=_0x3ee48a;_0x37e8df['push'](_0x3ee48a['pageContent']),_0x27770e[_0x4a0723(0x9a)]({'text':_0x164f73[_0x4a0723(0xa3)](0x0,0x3e8)+_0x1e33d4['afyhG'],..._0x5cbdb1});});});const _0x3c5d9a=_0x3217e5!==0x0?await _0x586d8a[_0x5ba73c(0xae)]({'namespace':_0xc8ad81[_0x5ba73c(0xd1)][_0x5ba73c(0xbf)],'input':_0x22e411,'LLMConnector':_0x349ec5,'similarityThreshold':_0xc8ad81[_0x5ba73c(0xd1)]?.['similarityThreshold'],'topN':_0xc8ad81[_0x5ba73c(0xd1)]?.['topN']}):{'contextTexts':[],'sources':[],'message':null};if(!!_0x3c5d9a[_0x5ba73c(0xd4)]){_0x1e33d4[_0x5ba73c(0xbc)](writeResponseChunk,_0x4e2e76,{'id':_0x21701f,'type':_0x1e33d4['YodSC'],'textResponse':null,'sources':[],'close':!![],'error':_0x1e33d4['dhgdK']});return;}_0x37e8df=[..._0x37e8df,..._0x3c5d9a[_0x5ba73c(0xcd)]],_0x27770e=[..._0x27770e,..._0x3c5d9a[_0x5ba73c(0xca)]];if(_0x1e33d4[_0x5ba73c(0xd3)](_0x33f052,_0x5ba73c(0xdc))&&_0x27770e[_0x5ba73c(0xd2)]===0x0){writeResponseChunk(_0x4e2e76,{'id':_0x21701f,'type':_0x5ba73c(0xc2),'textResponse':_0x5ba73c(0xd7),'sources':[],'close':!![],'error':null});return;}const _0x42d655=await _0x349ec5[_0x5ba73c(0xb9)]({'systemPrompt':_0x1e33d4['eIseJ'](chatPrompt,_0xc8ad81[_0x5ba73c(0xd1)]),'userPrompt':_0x22e411,'contextTexts':_0x37e8df,'chatHistory':_0x16a708},_0x5a5f22);if(_0x1e33d4[_0x5ba73c(0xc3)](_0x349ec5[_0x5ba73c(0xa0)](),!![]))console[_0x5ba73c(0xb3)](_0x5ba73c(0xc4)+_0x349ec5[_0x5ba73c(0xb5)]['name']+_0x5ba73c(0xcc)),_0x386423=await _0x349ec5['getChatCompletion'](_0x42d655,{'temperature':_0xc8ad81['workspace']?.[_0x5ba73c(0xda)]??_0x349ec5[_0x5ba73c(0xb2)]}),_0x1e33d4['wuTkR'](writeResponseChunk,_0x4e2e76,{'uuid':_0x21701f,'sources':[],'type':_0x5ba73c(0xcf),'textResponse':_0x386423,'close':!![],'error':![]});else{if(_0x1e33d4['NbgJo'](_0x5ba73c(0xac),_0x5ba73c(0x9d))){_0x1068b5(_0x589714,{'id':_0x6910e6,'type':_0x5ba73c(0xa4),'textResponse':null,'sources':[],'close':!![],'error':_0x1e33d4[_0x5ba73c(0xad)]});return;}else{const _0x5c3584=await _0x349ec5[_0x5ba73c(0xc0)](_0x42d655,{'temperature':_0xc8ad81[_0x5ba73c(0xd1)]?.[_0x5ba73c(0xda)]??_0x349ec5['defaultTemp']});_0x386423=await _0x349ec5['handleStream'](_0x4e2e76,_0x5c3584,{'uuid':_0x21701f,'sources':[]});}}await EmbedChats[_0x5ba73c(0x9b)]({'embedId':_0xc8ad81['id'],'prompt':_0x22e411,'response':{'text':_0x386423,'type':_0x33f052},'connection_information':_0x4e2e76[_0x5ba73c(0x9f)][_0x5ba73c(0xdb)]?{..._0x4e2e76['locals'][_0x5ba73c(0xdb)]}:{},'sessionId':_0x3f1a21});return;}async function recentEmbedChatHistory(_0x982d6f,_0x2b8926,_0x279c99=0x14,_0x580282=null){const _0x59530b=_0x573a9c;if(_0x580282===_0x59530b(0xdc))return{'rawHistory':[],'chatHistory':[]};const _0x383afd=(await EmbedChats[_0x59530b(0xd0)](_0x2b8926['id'],_0x982d6f,_0x279c99,{'id':_0x59530b(0xd9)}))[_0x59530b(0xc7)]();return{'rawHistory':_0x383afd,'chatHistory':convertToPromptHistory(_0x383afd)};}function _0x1ba9(){const _0x5eaed8=['pinnedDocs','slug','streamGetChatCompletion','...continued\x20on\x20in\x20source\x20document...','textResponse','MauZf','\x1b[31m[STREAMING\x20DISABLED]\x1b[0m\x20Streaming\x20is\x20not\x20available\x20for\x20','1120680HTlZFE','756798EOwCzu','reverse','isSafe','system','sources','allow_prompt_override','.\x20Will\x20use\x20regular\x20chat\x20method.','contextTexts','I\x20do\x20not\x20have\x20enough\x20information\x20to\x20answer\x20that.\x20Try\x20another\x20question.','textResponseChunk','forEmbedByUser','workspace','length','Hrtky','message','../../models/embedChats','../helpers','There\x20is\x20no\x20relevant\x20information\x20in\x20this\x20workspace\x20to\x20answer\x20your\x20query.','allow_temperature_override','desc','openAiTemp','connection','query','then','2XkNAgo','join','push','new','This\x20message\x20was\x20moderated\x20and\x20will\x20not\x20be\x20allowed.\x20Violations\x20for\x20','gkKyM','139204arDSEO','locals','streamingEnabled','namespaceCount','../DocumentManager','slice','abort','5Xfujot','uuid','hasNamespace','limits','forEach','eIseJ','204318ABSgfQ','opWLo','dhgdK','performSimilaritySearch','YodSC','exports','796494mqCxQo','defaultTemp','log','chat_mode','constructor','allow_model_override','1091664NOtbdV','jUecy','compressMessages','qYalT','\x20found.','wuTkR','47469ceKhzk'];_0x1ba9=function(){return _0x5eaed8;};return _0x1ba9();}function _0x4938(_0x5d4079,_0x252878){const _0x1ba93b=_0x1ba9();return _0x4938=function(_0x493844,_0x1c11f7){_0x493844=_0x493844-0x9a;let _0x47d198=_0x1ba93b[_0x493844];return _0x47d198;},_0x4938(_0x5d4079,_0x252878);}module[_0x573a9c(0xb0)]={'streamChatWithForEmbed':streamChatWithForEmbed};