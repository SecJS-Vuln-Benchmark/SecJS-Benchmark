'use strict';const _0x5ee5e0=_0x4a8c;function _0x403a(){const _0x47b5b4=['del','isDirectory','BCrgx','findIndex','rmdir','NpekL','buckedLocked','lock','QmJkv','6caQpXV','exports','zzOkm','Expired\x20','Remove\x20','1569670luCJzV','Update\x20metadata\x20','retention','ensureDirSync','createdAt','maxAge','562107tfpJBJ','metadata','ipynk','initialized','OEJKB','_import','info','uploadDir','Updated\x20','psitransfer:db','kRpKh','init','update','updateLastDownload','fICUK','pjpsV','1296430LjkjkC','DB\x20not\x20initialized','TywYn','KUBjv','forEach','find','isInteger','debug','splice','key','uploadLength','readdirSync','message','updateMetadata','get','all','lTRsw','store','huFnu','map','isLocked','1100022mixoeQ','add','some','error','push','remove','nrRds','13727040XEIKlT','_sync','143861RoZsYC','DB\x20not\x20initialized_','fs-promise','eZCIu','reduce','1769104vbiEah','resolve','now','YUUxQ','TyDYq'];_0x403a=function(){return _0x47b5b4;};return _0x403a();}function _0x4a8c(_0x21b86a,_0x1ca3e5){const _0x403aec=_0x403a();return _0x4a8c=function(_0x4a8cd0,_0xa02cea){_0x4a8cd0=_0x4a8cd0-0x1c0;let _0xc8e359=_0x403aec[_0x4a8cd0];return _0xc8e359;},_0x4a8c(_0x21b86a,_0x1ca3e5);}(function(_0x37e3c0,_0x5508da){const _0x1997cf=_0x4a8c,_0x29b53c=_0x37e3c0();while(!![]){try{const _0xf0282c=-parseInt(_0x1997cf(0x1de))/0x1+-parseInt(_0x1997cf(0x1c0))/0x2+parseInt(_0x1997cf(0x1fc))/0x3+-parseInt(_0x1997cf(0x1e3))/0x4+-parseInt(_0x1997cf(0x1f6))/0x5+parseInt(_0x1997cf(0x1f1))/0x6*(parseInt(_0x1997cf(0x1d5))/0x7)+parseInt(_0x1997cf(0x1dc))/0x8;if(_0xf0282c===_0x5508da)break;else _0x29b53c['push'](_0x29b53c['shift']());}catch(_0x1f4f9f){_0x29b53c['push'](_0x29b53c['shift']());}}}(_0x403a,0x7d06d));const fsp=require(_0x5ee5e0(0x1e0)),path=require('path'),debug=require(_0x5ee5e0(0x1c7))(_0x5ee5e0(0x205)),config=require('../config');module[_0x5ee5e0(0x1f2)]=class DB{constructor(_0x55a4ec,_0x5ae492){const _0x200153=_0x5ee5e0,_0x3f0cd6={'TyDYq':function(_0x911d1,_0x22347c){return _0x911d1(_0x22347c);},'OEJKB':function(_0x440e07,_0x84a58c){return _0x440e07!==_0x84a58c;},'NpekL':'titbx','DVxYB':function(_0x24cf02,_0x44a0bc){return _0x24cf02*_0x44a0bc;},'nrRds':function(_0x3c5689,_0x2e4e6c){return _0x3c5689>_0x2e4e6c;},'BCrgx':function(_0x463dc3,_0x289c03){return _0x463dc3-_0x289c03;},'eZCIu':function(_0x495d35,_0x216f6b){return _0x495d35*_0x216f6b;},'JOqxq':function(_0x3cbec1,_0x7a5e2d){return _0x3cbec1<=_0x7a5e2d;},'pjpsV':function(_0x21d56f,_0x6c33ec){return _0x21d56f(_0x6c33ec);}};this[_0x200153(0x1ff)]=![],this['db']={},this[_0x200153(0x203)]=_0x55a4ec,this['store']=_0x5ae492;const _0x5f0463=()=>{const _0x308fa0=_0x200153;let _0x5c540a,_0x5c5099,_0x1493b0;for(_0x5c540a of Object['keys'](this['db'])){if(_0x3f0cd6[_0x308fa0(0x200)](_0x3f0cd6[_0x308fa0(0x1ed)],_0x3f0cd6['NpekL']))this['db'][_0x1ab26a][_0x308fa0(0x1d9)](_0x228829),_0x3f0cd6[_0x308fa0(0x1e7)](_0x4653d9,'Added\x20'+_0x196d92+'++'+_0x418f70);else for(_0x5c5099 of this['db'][_0x5c540a]){_0x1493b0=+_0x5c5099['metadata'][_0x308fa0(0x1fa)]+_0x3f0cd6['DVxYB'](config[_0x308fa0(0x1fb)],0x3e8)-Date['now'](),_0x3f0cd6[_0x308fa0(0x1db)](_0x1493b0,0x0)&&Number[_0x308fa0(0x1c6)](+_0x5c5099['metadata']['retention'])&&(_0x1493b0=_0x3f0cd6[_0x308fa0(0x1ea)](+_0x5c5099[_0x308fa0(0x1fd)][_0x308fa0(0x1fa)]+_0x3f0cd6[_0x308fa0(0x1e1)](+_0x5c5099[_0x308fa0(0x1fd)][_0x308fa0(0x1f8)],0x3e8),Date[_0x308fa0(0x1e5)]())),_0x3f0cd6['JOqxq'](_0x1493b0,0x0)&&(_0x3f0cd6[_0x308fa0(0x20b)](debug,_0x308fa0(0x1f4)+_0x5c540a+'++'+_0x5c5099[_0x308fa0(0x1c9)]),this[_0x308fa0(0x1da)](_0x5c540a,_0x5c5099[_0x308fa0(0x1c9)])['catch'](_0x190174=>console[_0x308fa0(0x1d8)](_0x190174)));}}};setInterval(_0x5f0463,_0x3f0cd6[_0x200153(0x1e1)](0x3c,0x3e8));}[_0x5ee5e0(0x207)](){const _0x4e0745=_0x5ee5e0,_0x246f9c={'ZgyHB':'SOkBU'};if(this[_0x4e0745(0x1ff)])return;this[_0x4e0745(0x1ff)]=!![];try{this[_0x4e0745(0x1dd)]();}catch(_0x2bdd6b){if(_0x246f9c['ZgyHB']===_0x246f9c['ZgyHB']){this['initialized']=![],_0x2bdd6b[_0x4e0745(0x1cc)]='db\x20initialization\x20failed\x20with\x20error\x20'+_0x2bdd6b['message'];throw _0x2bdd6b;}else return this['db'][_0x5df1ac];}}[_0x5ee5e0(0x1dd)](){const _0x2a220e=_0x5ee5e0;fsp[_0x2a220e(0x1f9)](this[_0x2a220e(0x203)]),fsp[_0x2a220e(0x1cb)](this[_0x2a220e(0x203)])[_0x2a220e(0x1c4)](_0x21a9f6=>{const _0xa3b2ad=_0x2a220e;this[_0xa3b2ad(0x201)](_0x21a9f6);});}[_0x5ee5e0(0x201)](_0x2057e7){const _0x255745=_0x5ee5e0,_0x11a643={'kRpKh':function(_0x3d3eee,_0xdf2cf3){return _0x3d3eee!==_0xdf2cf3;},'fICUK':_0x255745(0x1fe)},_0x5925cf=path['resolve'](this[_0x255745(0x203)],_0x2057e7),_0x2be8cd=fsp['statSync'](_0x5925cf);if(!_0x2be8cd[_0x255745(0x1e9)]())return;fsp['readdirSync'](_0x5925cf)[_0x255745(0x1c4)](async _0x475856=>{const _0x547616=_0x255745;if(_0x11a643[_0x547616(0x206)](path['extname'](_0x475856),'')){if(_0x11a643['kRpKh'](_0x547616(0x1fe),_0x11a643[_0x547616(0x20a)])){const _0x206a38=this[_0x547616(0x1ce)](_0x4ed9f6);if(!_0x206a38)return 0x0;return _0x206a38[_0x547616(0x1e2)]((_0x35f573,_0x39ceca)=>_0x35f573+ +_0x39ceca[_0x547616(0x1fd)][_0x547616(0x1ca)],0x0);}else return Promise['resolve']();}try{let _0x548d37=await this[_0x547616(0x1d1)][_0x547616(0x202)](_0x2057e7+'++'+_0x475856);this[_0x547616(0x1d6)](_0x2057e7,_0x475856,_0x548d37);}catch(_0x3f46f0){console[_0x547616(0x1d8)](_0x3f46f0);}});}['add'](_0x394218,_0x5a8d81,_0x5c3d90){const _0x28f9f2=_0x5ee5e0,_0x434a7b={'zzOkm':_0x28f9f2(0x1df),'sgUFi':function(_0x4e5b06,_0x3c22e1){return _0x4e5b06!==_0x3c22e1;},'TywYn':function(_0x4e9428,_0x22798f){return _0x4e9428(_0x22798f);}};if(!this[_0x28f9f2(0x1ff)])throw new Error(_0x434a7b[_0x28f9f2(0x1f3)]);if(!this['db'][_0x394218])this['db'][_0x394218]=[];_0x5c3d90[_0x28f9f2(0x1c9)]=_0x5a8d81;const _0xce9d8=this['db'][_0x394218][_0x28f9f2(0x1eb)](_0x520bd7=>_0x520bd7[_0x28f9f2(0x1c9)]===_0x5a8d81);_0x434a7b['sgUFi'](_0xce9d8,-0x1)?(this['db'][_0x394218]['splice'](_0xce9d8,0x1,_0x5c3d90),_0x434a7b[_0x28f9f2(0x1c2)](debug,_0x28f9f2(0x204)+_0x394218+'++'+_0x5a8d81)):(this['db'][_0x394218][_0x28f9f2(0x1d9)](_0x5c3d90),debug('Added\x20'+_0x394218+'++'+_0x5a8d81));}async[_0x5ee5e0(0x1da)](_0x21a105,_0xb8b5b6){const _0x54c7b1=_0x5ee5e0,_0x58f377={'YUUxQ':_0x54c7b1(0x1c1),'huFnu':function(_0x7d8d03,_0x4d37b8){return _0x7d8d03+_0x4d37b8;},'lTRsw':function(_0x3a3d46,_0x44b0ac){return _0x3a3d46===_0x44b0ac;}};if(!this['initialized'])throw new Error(_0x58f377[_0x54c7b1(0x1e6)]);debug(_0x54c7b1(0x1f5)+_0x21a105+'++'+_0xb8b5b6),await this[_0x54c7b1(0x1d1)][_0x54c7b1(0x1e8)](_0x58f377[_0x54c7b1(0x1d2)](_0x58f377[_0x54c7b1(0x1d2)](_0x21a105,'++'),_0xb8b5b6));const _0x546e58=this['db'][_0x21a105]['findIndex'](_0x21e5af=>_0x21e5af[_0x54c7b1(0x1c9)]===_0xb8b5b6);this[_0x54c7b1(0x1ce)](_0x21a105)[_0x54c7b1(0x1c8)](_0x546e58,0x1),_0x58f377[_0x54c7b1(0x1d0)](this[_0x54c7b1(0x1ce)](_0x21a105)['length'],0x0)&&(delete this['db'][_0x21a105],await fsp[_0x54c7b1(0x1ec)](path[_0x54c7b1(0x1e4)](this[_0x54c7b1(0x203)],_0x21a105)));}async[_0x5ee5e0(0x209)](_0x23253a,_0x3b3cfe){const _0x10e62b=_0x5ee5e0,_0x22f086={'QmJkv':function(_0x1f7148,_0x1efe30){return _0x1f7148(_0x1efe30);}};_0x22f086[_0x10e62b(0x1f0)](debug,'Update\x20last\x20download\x20'+_0x23253a+'++'+_0x3b3cfe);const _0x4e15b6=this['get'](_0x23253a)[_0x10e62b(0x1c5)](_0xec7eba=>_0xec7eba[_0x10e62b(0x1c9)]===_0x3b3cfe);if(!_0x4e15b6)return;_0x4e15b6['metadata']['lastDownload']=Date[_0x10e62b(0x1e5)](),await this[_0x10e62b(0x1d1)][_0x10e62b(0x208)](_0x23253a+'++'+_0x3b3cfe,_0x4e15b6);}async['updateMetadata'](_0x199c0d,_0xc6e591,_0xc445dd){const _0x4c0e67=_0x5ee5e0,_0x10b418={'KUBjv':function(_0x1cf498,_0x4c00d0){return _0x1cf498(_0x4c00d0);}};_0x10b418[_0x4c0e67(0x1c3)](debug,_0x4c0e67(0x1f7)+_0x199c0d+'++'+_0xc6e591);const _0x4792c2=this[_0x4c0e67(0x1ce)](_0x199c0d)[_0x4c0e67(0x1c5)](_0x46980a=>_0x46980a[_0x4c0e67(0x1c9)]===_0xc6e591);if(!_0x4792c2)return;_0x4792c2[_0x4c0e67(0x1fd)]={..._0x4792c2[_0x4c0e67(0x1fd)],..._0xc445dd},await this['store'][_0x4c0e67(0x208)](_0x199c0d+'++'+_0xc6e591,_0x4792c2);}async[_0x5ee5e0(0x1ef)](_0x40a509){const _0x33ac92=_0x5ee5e0,_0x1cd115=this[_0x33ac92(0x1ce)](_0x40a509);if(!_0x1cd115)return;await Promise[_0x33ac92(0x1cf)](_0x1cd115[_0x33ac92(0x1d3)](async _0x5efe09=>{const _0x18d7b6=_0x33ac92;await this[_0x18d7b6(0x1cd)](_0x40a509,_0x5efe09[_0x18d7b6(0x1c9)],{'buckedLocked':!![]});}));}[_0x5ee5e0(0x1d4)](_0x5932df){const _0x45ce79=_0x5ee5e0,_0x49dc81=this['get'](_0x5932df);if(!_0x49dc81)return![];return _0x49dc81[_0x45ce79(0x1d7)](_0x119c29=>_0x119c29['metadata'][_0x45ce79(0x1ee)]);}[_0x5ee5e0(0x1ce)](_0x69563d){return this['db'][_0x69563d];}['bucketSize'](_0x4db34b){const _0x33ae1c=_0x5ee5e0,_0x3fac05=this[_0x33ae1c(0x1ce)](_0x4db34b);if(!_0x3fac05)return 0x0;return _0x3fac05[_0x33ae1c(0x1e2)]((_0x349e32,_0x5ec7af)=>_0x349e32+ +_0x5ec7af[_0x33ae1c(0x1fd)][_0x33ae1c(0x1ca)],0x0);}};