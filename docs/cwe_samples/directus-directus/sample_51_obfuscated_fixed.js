const _0x254bed=_0x546b;(function(_0x313c7e,_0x15ff27){const _0xc803ea=_0x546b,_0x489bb4=_0x313c7e();while(!![]){try{const _0xc19433=parseInt(_0xc803ea(0xbd))/0x1+parseInt(_0xc803ea(0x6e))/0x2+parseInt(_0xc803ea(0xc0))/0x3*(-parseInt(_0xc803ea(0xc5))/0x4)+-parseInt(_0xc803ea(0xae))/0x5*(parseInt(_0xc803ea(0x9b))/0x6)+parseInt(_0xc803ea(0xc1))/0x7+-parseInt(_0xc803ea(0x89))/0x8*(parseInt(_0xc803ea(0xa3))/0x9)+parseInt(_0xc803ea(0x6d))/0xa*(parseInt(_0xc803ea(0xcc))/0xb);if(_0xc19433===_0x15ff27)break;else _0x489bb4['push'](_0x489bb4['shift']());}catch(_0x268675){_0x489bb4['push'](_0x489bb4['shift']());}}}(_0x1fb5,0x864c8));const {Callback,createMetadataAggregator}=require('@librechat/agents'),{Constants,VisionModes,openAISchema,EModelEndpoint,KnownEndpoints,anthropicSchema,bedrockOutputParser,removeNullishValues}=require(_0x254bed(0xd9)),{extractBaseURL}=require(_0x254bed(0x9e)),{formatMessage,formatAgentMessages,formatContentStrings,createContextHandlers}=require(_0x254bed(0x69)),{encodeAndFormat}=require('~/server/services/Files/images/encode'),Tokenizer=require(_0x254bed(0xa4)),{spendTokens}=require(_0x254bed(0x8f)),BaseClient=require(_0x254bed(0x7d)),{createRun}=require(_0x254bed(0xb4)),{logger}=require('~/config'),providerParsers={[EModelEndpoint['openAI']]:openAISchema,[EModelEndpoint[_0x254bed(0xce)]]:openAISchema,[EModelEndpoint['anthropic']]:anthropicSchema,[EModelEndpoint[_0x254bed(0x7c)]]:bedrockOutputParser},legacyContentEndpoints=new Set([KnownEndpoints[_0x254bed(0xa7)],KnownEndpoints[_0x254bed(0xbe)]]);function _0x546b(_0x4f80cf,_0x2b7df5){const _0x1fb594=_0x1fb5();return _0x546b=function(_0x546b88,_0x2260cf){_0x546b88=_0x546b88-0x64;let _0x239bf4=_0x1fb594[_0x546b88];return _0x239bf4;},_0x546b(_0x4f80cf,_0x2b7df5);}class AgentClient extends BaseClient{constructor(_0x13b9bc={}){const _0x58777e=_0x254bed;super(null,_0x13b9bc),this[_0x58777e(0xba)]='discard',this[_0x58777e(0x84)]=!![],this[_0x58777e(0xd3)];const {contentParts:_0x580747,collectedUsage:_0x1b23a9,artifactPromises:_0x43693b,maxContextTokens:_0x45837e,modelOptions:modelOptions={},..._0x49eb10}=_0x13b9bc;this['modelOptions']=modelOptions,this[_0x58777e(0x97)]=_0x45837e,this[_0x58777e(0xe9)]=_0x580747,this[_0x58777e(0xd2)]=_0x1b23a9,this[_0x58777e(0x8d)]=_0x43693b,this[_0x58777e(0x7b)]=Object[_0x58777e(0x81)]({'endpoint':_0x13b9bc[_0x58777e(0x8e)]},_0x49eb10);}[_0x254bed(0xc9)](){const _0x1e7689=_0x254bed;return this[_0x1e7689(0xe9)];}[_0x254bed(0xc4)](_0x4a863c){const _0x27cc54=_0x254bed;logger['info'](_0x27cc54(0xd7),_0x4a863c);}[_0x254bed(0xb5)](_0x140eda){const _0x390dfa=_0x254bed;logger[_0x390dfa(0xac)](_0x390dfa(0x8a),_0x140eda);}[_0x254bed(0xa6)](){const _0x2402da=_0x254bed,_0x5cb657={'uSkgg':function(_0x266373,_0x6daa78){return _0x266373===_0x6daa78;},'fNSoZ':function(_0x8fe042,_0x5cbce8){return _0x8fe042(_0x5cbce8);}},_0x4a874c=providerParsers[this[_0x2402da(0x7b)][_0x2402da(0x8e)]];let _0x105b23=_0x5cb657[_0x2402da(0x9d)](this[_0x2402da(0x7b)][_0x2402da(0x8e)],EModelEndpoint[_0x2402da(0xaf)])?{'model':undefined}:{};return _0x4a874c&&(_0x105b23=_0x5cb657['fNSoZ'](_0x4a874c,this[_0x2402da(0xa8)])),_0x5cb657['fNSoZ'](removeNullishValues,Object[_0x2402da(0x81)]({'endpoint':this[_0x2402da(0x7b)][_0x2402da(0x8e)],'agent_id':this['options'][_0x2402da(0x88)]['id'],'modelLabel':this[_0x2402da(0x7b)]['modelLabel'],'maxContextTokens':this[_0x2402da(0x7b)]['maxContextTokens'],'resendFiles':this[_0x2402da(0x7b)]['resendFiles'],'imageDetail':this[_0x2402da(0x7b)]['imageDetail'],'spec':this['options'][_0x2402da(0x8b)]},_0x105b23));}[_0x254bed(0x92)](){const _0x2be65c=_0x254bed;return{'instructions':this[_0x2be65c(0x7b)][_0x2be65c(0x88)][_0x2be65c(0x72)],'additional_instructions':this[_0x2be65c(0x7b)]['agent'][_0x2be65c(0x7a)]};}async['addImageURLs'](_0x447c36,_0x17845a){const _0x55a5a4=_0x254bed,_0x4e917a={'zFgTZ':function(_0x3e6a5a,_0x58c842,_0x3a4272,_0x203ab7,_0x2c26f4){return _0x3e6a5a(_0x58c842,_0x3a4272,_0x203ab7,_0x2c26f4);}},{files:_0x305943,image_urls:_0x47a9cf}=await _0x4e917a['zFgTZ'](encodeAndFormat,this[_0x55a5a4(0x7b)][_0x55a5a4(0xdc)],_0x17845a,this[_0x55a5a4(0x7b)][_0x55a5a4(0x88)]['provider'],VisionModes[_0x55a5a4(0xaf)]);return _0x447c36[_0x55a5a4(0x6c)]=_0x47a9cf['length']?_0x47a9cf:undefined,_0x305943;}async['buildMessages'](_0x3a5fac,_0x37aa2e,{instructions:instructions=null,additional_instructions:additional_instructions=null},_0x324da3){const _0x46e87d=_0x254bed,_0x184b57={'BeNkb':function(_0x3ac771,_0xc9f036){return _0x3ac771(_0xc9f036);},'VwTBo':function(_0x5edd14,_0x2ccd5a){return _0x5edd14??_0x2ccd5a;},'rSaLn':function(_0x57f7ca,_0x7af535){return _0x57f7ca-_0x7af535;},'Wlyga':function(_0x55d8d2,_0xc709db){return _0x55d8d2-_0xc709db;},'tKHtV':function(_0x3af7ca,_0x56d84c){return _0x3af7ca+_0x56d84c;},'wNIqO':function(_0x5ed432,_0x236abc){return _0x5ed432===_0x236abc;},'cusoC':_0x46e87d(0x67)};let _0x1c87e7=this['constructor']['getMessagesForConversation']({'messages':_0x3a5fac,'parentMessageId':_0x37aa2e,'summary':this['shouldSummarize']}),_0x5db8ae,_0x570a25,_0x1b2bb5=''+(instructions??'')+_0x184b57[_0x46e87d(0xb8)](additional_instructions,'');if(this['options'][_0x46e87d(0x83)]){const _0x4e032c=await this[_0x46e87d(0x7b)][_0x46e87d(0x83)];this['message_file_map']?this[_0x46e87d(0xe1)][_0x1c87e7[_0x184b57[_0x46e87d(0xc7)](_0x1c87e7['length'],0x1)][_0x46e87d(0xa1)]]=_0x4e032c:this[_0x46e87d(0xe1)]={[_0x1c87e7[_0x184b57[_0x46e87d(0xc7)](_0x1c87e7[_0x46e87d(0xdf)],0x1)][_0x46e87d(0xa1)]]:_0x4e032c};const _0x490576=await this[_0x46e87d(0x65)](_0x1c87e7[_0x184b57[_0x46e87d(0x7e)](_0x1c87e7[_0x46e87d(0xdf)],0x1)],_0x4e032c);this['options'][_0x46e87d(0x83)]=_0x490576;}this['message_file_map']&&(this[_0x46e87d(0x8c)]=createContextHandlers(this[_0x46e87d(0x7b)]['req'],_0x1c87e7[_0x184b57[_0x46e87d(0xc7)](_0x1c87e7[_0x46e87d(0xdf)],0x1)]['text']));const _0x4a0a4d=_0x1c87e7[_0x46e87d(0x99)]((_0x210037,_0x1261d3)=>{const _0x45fdf1=_0x46e87d,_0x233702=_0x184b57['BeNkb'](formatMessage,{'message':_0x210037,'userName':this['options']?.[_0x45fdf1(0xb2)],'assistantName':this[_0x45fdf1(0x7b)]?.[_0x45fdf1(0xde)]}),_0x5a568a=this[_0x45fdf1(0xba)]&&!_0x1c87e7[_0x1261d3][_0x45fdf1(0x80)];(_0x5a568a||this[_0x45fdf1(0xa2)]&&(_0x210037['image_urls']||_0x210037[_0x45fdf1(0xc8)]))&&(_0x1c87e7[_0x1261d3][_0x45fdf1(0x80)]=this[_0x45fdf1(0xa0)](_0x233702));if(this[_0x45fdf1(0xe1)]&&this['message_file_map'][_0x210037[_0x45fdf1(0xa1)]]){const _0x5dabef=this[_0x45fdf1(0xe1)][_0x210037[_0x45fdf1(0xa1)]];for(const _0x2ce5fb of _0x5dabef){if(_0x2ce5fb[_0x45fdf1(0xe2)]){this[_0x45fdf1(0x8c)]?.[_0x45fdf1(0xa5)](_0x2ce5fb);continue;}}}return _0x233702;});this[_0x46e87d(0x8c)]&&(this['augmentedPrompt']=await this['contextHandlers'][_0x46e87d(0xe4)](),_0x1b2bb5=_0x184b57[_0x46e87d(0xbc)](this[_0x46e87d(0xab)],_0x1b2bb5));_0x1b2bb5&&(this[_0x46e87d(0x7b)][_0x46e87d(0x88)][_0x46e87d(0x72)]=_0x1b2bb5);this[_0x46e87d(0xba)]&&({payload:_0x5db8ae,promptTokens:_0x570a25,messages:_0x3a5fac}=await this[_0x46e87d(0xaa)]({'orderedMessages':_0x1c87e7,'formattedMessages':_0x4a0a4d,'buildTokenMap':![]}));const _0x2604f7={'prompt':_0x5db8ae,'promptTokens':_0x570a25,'messages':_0x3a5fac};return _0x570a25>=0x0&&_0x184b57[_0x46e87d(0xdd)](typeof _0x324da3?.[_0x46e87d(0x76)],_0x184b57[_0x46e87d(0xd8)])&&_0x324da3[_0x46e87d(0x76)]({'promptTokens':_0x570a25}),_0x2604f7;}async['sendCompletion'](_0x4d0290,_0x397fbf={}){const _0x3142c8=_0x254bed;return this[_0x3142c8(0xa8)]['user']=this[_0x3142c8(0xbb)],await this[_0x3142c8(0xc3)]({'payload':_0x4d0290,'onProgress':_0x397fbf[_0x3142c8(0xe8)],'abortController':_0x397fbf[_0x3142c8(0x64)]}),this['contentParts'];}async[_0x254bed(0x87)]({model:_0x32dfd0,context:context='message',collectedUsage:collectedUsage=this[_0x254bed(0xd2)]}){const _0xf2ecb6=_0x254bed,_0x3e4a51={'dzEHU':function(_0x87f97,_0x2671a7,_0x452885){return _0x87f97(_0x2671a7,_0x452885);}};for(const _0x1407c8 of collectedUsage){await _0x3e4a51['dzEHU'](spendTokens,{'context':context,'model':_0x32dfd0??this['modelOptions']['model'],'conversationId':this[_0xf2ecb6(0xd6)],'user':this[_0xf2ecb6(0xbb)]??this[_0xf2ecb6(0x7b)]['req'][_0xf2ecb6(0xbb)]?.['id'],'endpointTokenConfig':this[_0xf2ecb6(0x7b)]['endpointTokenConfig']},{'promptTokens':_0x1407c8[_0xf2ecb6(0xcf)],'completionTokens':_0x1407c8['output_tokens']});}}async['chatCompletion']({payload:_0x5aa096,abortController:abortController=null}){const _0x123ece=_0x254bed,_0x533011={'AfiyY':_0x123ece(0x66),'OplkF':_0x123ece(0xb9),'DDkqn':function(_0x5edb72,_0x6cc874){return _0x5edb72(_0x6cc874);},'MpoBG':_0x123ece(0xad),'GfZYF':function(_0x5613f1,_0x28ab8e){return _0x5613f1(_0x28ab8e);},'hPjCO':function(_0x3ca50d,_0x1659ca){return _0x3ca50d(_0x1659ca);},'oRGsB':_0x123ece(0xca),'IOrCe':_0x123ece(0x75),'mrnqi':_0x123ece(0x6f)};try{!abortController&&(abortController=new AbortController());const _0x4beccb=_0x533011[_0x123ece(0x79)](extractBaseURL,this[_0x123ece(0xbf)]);logger[_0x123ece(0x78)](_0x533011[_0x123ece(0x74)],{'baseURL':_0x4beccb,'payload':_0x5aa096});const _0x2036d8=await _0x533011[_0x123ece(0x79)](createRun,{'req':this[_0x123ece(0x7b)][_0x123ece(0xdc)],'agent':this[_0x123ece(0x7b)][_0x123ece(0x88)],'tools':this[_0x123ece(0x7b)][_0x123ece(0xda)],'runId':this[_0x123ece(0xc6)],'modelOptions':this['modelOptions'],'customHandlers':this[_0x123ece(0x7b)]['eventHandlers']}),_0x42fdcc={'configurable':{'thread_id':this['conversationId']},'signal':abortController[_0x123ece(0x77)],'streamMode':_0x123ece(0x82),'version':'v2'};if(!_0x2036d8)throw new Error(_0x123ece(0x9c));this[_0x123ece(0xd3)]=_0x2036d8;const _0x4020d8=_0x533011[_0x123ece(0x86)](formatAgentMessages,_0x5aa096);legacyContentEndpoints[_0x123ece(0xdb)](this[_0x123ece(0x7b)]['agent'][_0x123ece(0x8e)])&&_0x533011['hPjCO'](formatContentStrings,_0x4020d8),await _0x2036d8[_0x123ece(0x73)]({'messages':_0x4020d8},_0x42fdcc,{[Callback[_0x123ece(0xcb)]]:(_0x1a2b28,_0x28202b,_0x49fdf7)=>{const _0x2bb8ff=_0x123ece;_0x533011['AfiyY']==='XUuVJ'?(_0x33a7ca=_0x32a616[_0x2bb8ff(0x6b)][_0x2bb8ff(0x94)],_0x36723a=_0x8ba505['tokenUsage'][_0x2bb8ff(0xb0)]):logger[_0x2bb8ff(0x71)](_0x533011[_0x2bb8ff(0x95)],_0x28202b,_0x49fdf7);}}),this[_0x123ece(0x87)]({'context':_0x533011[_0x123ece(0xc2)]})['catch'](_0xe14611=>{const _0x95065f=_0x123ece;logger[_0x95065f(0x71)]('[api/server/controllers/agents/client.js\x20#chatCompletion]\x20Error\x20recording\x20collected\x20usage',_0xe14611);});}catch(_0xb038bf){if(!abortController[_0x123ece(0x77)]['aborted']){if(_0x533011['IOrCe']===_0x123ece(0xb3))_0x23e663=new _0x587388();else{logger['error'](_0x533011['mrnqi'],_0xb038bf);throw _0xb038bf;}}logger[_0x123ece(0xe7)](_0x123ece(0xe0),_0xb038bf);}}async[_0x254bed(0x9f)]({text:_0x202867}){const _0x557eec=_0x254bed,_0x2cc3b0={'YhqvI':_0x557eec(0x8a),'zeBZp':_0x557eec(0xe3),'Sxozy':_0x557eec(0xeb),'sYdcY':function(_0x1cbd20,_0x2f4ae3){return _0x1cbd20===_0x2f4ae3;},'BGKVy':_0x557eec(0x91),'eXYaN':_0x557eec(0x98)};if(!this[_0x557eec(0xd3)])throw new Error(_0x2cc3b0['Sxozy']);const {handleLLMEnd:_0x9b91ca,collected:_0x205dfd}=createMetadataAggregator(),_0x2b7d7a={},_0x3bbd7a=this[_0x557eec(0x7b)][_0x557eec(0xdc)]['app'][_0x557eec(0xe6)][this['options'][_0x557eec(0x88)][_0x557eec(0x9a)]];_0x3bbd7a&&_0x3bbd7a[_0x557eec(0xd5)]&&_0x3bbd7a['titleModel']!==Constants[_0x557eec(0xb1)]&&(_0x2b7d7a[_0x557eec(0x85)]=_0x3bbd7a['titleModel']);try{if(_0x2cc3b0['sYdcY'](_0x2cc3b0['BGKVy'],_0x2cc3b0[_0x557eec(0xe5)]))_0x1ab505[_0x557eec(0x71)]('[api/server/controllers/agents/client.js\x20#chatCompletion]\x20Error\x20recording\x20collected\x20usage',_0x21fd0d);else{const _0x4fa607=await this[_0x557eec(0xd3)]['generateTitle']({'inputText':_0x202867,'contentParts':this[_0x557eec(0xe9)],'clientOptions':_0x2b7d7a,'chainOptions':{'callbacks':[{'handleLLMEnd':_0x9b91ca}]}}),_0x1c10e5=_0x205dfd[_0x557eec(0x99)](_0x12e00a=>{const _0xc6f009=_0x557eec;let _0x423275,_0x17dd5b;if(_0x12e00a['usage'])_0x2cc3b0[_0xc6f009(0x93)]===_0xc6f009(0xe3)?(_0x423275=_0x12e00a['usage']['input_tokens']||_0x12e00a[_0xc6f009(0xd1)]['inputTokens'],_0x17dd5b=_0x12e00a[_0xc6f009(0xd1)][_0xc6f009(0xd0)]||_0x12e00a['usage'][_0xc6f009(0x96)]):_0x4ddb46[_0xc6f009(0xac)](_0x2cc3b0[_0xc6f009(0x7f)],_0x498ec0);else _0x12e00a[_0xc6f009(0x6b)]&&(_0x423275=_0x12e00a[_0xc6f009(0x6b)][_0xc6f009(0x94)],_0x17dd5b=_0x12e00a[_0xc6f009(0x6b)][_0xc6f009(0xb0)]);return{'input_tokens':_0x423275,'output_tokens':_0x17dd5b};});return this[_0x557eec(0x87)]({'model':_0x2b7d7a[_0x557eec(0x85)],'context':_0x557eec(0xa9),'collectedUsage':_0x1c10e5})['catch'](_0x3b2ec5=>{const _0x42f6be=_0x557eec;logger[_0x42f6be(0x71)]('[api/server/controllers/agents/client.js\x20#titleConvo]\x20Error\x20recording\x20collected\x20usage',_0x3b2ec5);}),_0x4fa607['title'];}}catch(_0x17aec0){logger[_0x557eec(0x71)](_0x557eec(0xb6),_0x17aec0);return;}}[_0x254bed(0xd4)](){const _0x5dff46=_0x254bed,_0x59d076={'ZYpKt':_0x5dff46(0x6a),'idSqf':_0x5dff46(0x70)};return this['modelOptions'][_0x5dff46(0x85)]?.[_0x5dff46(0x68)](_0x59d076[_0x5dff46(0xcd)])?_0x59d076[_0x5dff46(0xea)]:_0x5dff46(0x90);}['getTokenCount'](_0x5dcfda){const _0x20ea45=_0x254bed,_0x2cf89f=this[_0x20ea45(0xd4)]();return Tokenizer['getTokenCount'](_0x5dcfda,_0x2cf89f);}}module[_0x254bed(0xb7)]=AgentClient;function _0x1fb5(){const _0x138ca7=['[api/server/controllers/agents/client.js\x20#sendCompletion]\x20Operation\x20aborted','message_file_map','embedded','UJijC','createContext','eXYaN','locals','warn','onProgress','contentParts','idSqf','Run\x20not\x20initialized','abortController','addImageURLs','MUkkt','function','includes','~/app/clients/prompts','gpt-4o','tokenUsage','image_urls','17539090wAwOYq','1320734YtnFtm','[api/server/controllers/agents/client.js\x20#sendCompletion]\x20Unhandled\x20error\x20type','o200k_base','error','instructions','processStream','MpoBG','DeHrV','getReqData','signal','debug','DDkqn','additional_instructions','options','bedrock','~/app/clients/BaseClient','Wlyga','YhqvI','tokenCount','assign','values','attachments','isChatCompletion','model','GfZYF','recordCollectedUsage','agent','306568ncNjSd','[api/server/controllers/agents/client.js\x20#checkVisionRequest]\x20not\x20implemented','spec','contextHandlers','artifactPromises','endpoint','~/models/spendTokens','cl100k_base','mMqWO','getBuildMessagesOptions','zeBZp','promptTokens','OplkF','outputTokens','maxContextTokens','gmrcm','map','provider','672ecBCGk','Failed\x20to\x20create\x20run','uSkgg','~/utils','titleConvo','getTokenCountForMessage','messageId','isVisionModel','207fLYQxy','~/server/services/Tokenizer','processFile','getSaveOptions','groq','modelOptions','title','handleContextStrategy','augmentedPrompt','info','[api/server/controllers/agents/client.js]\x20chatCompletion','31445jTICso','agents','completionTokens','CURRENT_MODEL','name','BKIBr','./run','checkVisionRequest','[api/server/controllers/agents/client.js\x20#titleConvo]\x20Error','exports','VwTBo','[api/server/controllers/agents/client.js\x20#chatCompletion]\x20Tool\x20Error','contextStrategy','user','tKHtV','508673SKeTCU','deepseek','completionsUrl','61653KUmdML','963795xCjYaf','oRGsB','chatCompletion','setOptions','180dOaBYU','responseMessageId','rSaLn','files','getContentParts','message','TOOL_ERROR','11KWGhAT','ZYpKt','azureOpenAI','input_tokens','output_tokens','usage','collectedUsage','run','getEncoding','titleModel','conversationId','[api/server/controllers/agents/client.js]\x20setOptions','cusoC','librechat-data-provider','tools','has','req','wNIqO','modelLabel','length'];_0x1fb5=function(){return _0x138ca7;};return _0x1fb5();}