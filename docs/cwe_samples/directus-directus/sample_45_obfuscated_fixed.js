const _0xdf829f=_0x358f;function _0x358f(_0x161a38,_0x42f1a2){const _0x5dbee4=_0x5dbe();return _0x358f=function(_0x358ffe,_0x53a617){_0x358ffe=_0x358ffe-0x13d;let _0x26a4fa=_0x5dbee4[_0x358ffe];return _0x26a4fa;},_0x358f(_0x161a38,_0x42f1a2);}(function(_0x53b46d,_0xf0f913){const _0x7bacbe=_0x358f,_0x40edaf=_0x53b46d();while(!![]){try{const _0xc3ab02=parseInt(_0x7bacbe(0x15c))/0x1*(-parseInt(_0x7bacbe(0x140))/0x2)+-parseInt(_0x7bacbe(0x14d))/0x3*(-parseInt(_0x7bacbe(0x160))/0x4)+parseInt(_0x7bacbe(0x16b))/0x5*(-parseInt(_0x7bacbe(0x151))/0x6)+parseInt(_0x7bacbe(0x144))/0x7*(parseInt(_0x7bacbe(0x165))/0x8)+parseInt(_0x7bacbe(0x154))/0x9+-parseInt(_0x7bacbe(0x155))/0xa+parseInt(_0x7bacbe(0x15f))/0xb;if(_0xc3ab02===_0xf0f913)break;else _0x40edaf['push'](_0x40edaf['shift']());}catch(_0x514066){_0x40edaf['push'](_0x40edaf['shift']());}}}(_0x5dbe,0x710b7));const {z}=require('zod'),Message=require(_0xdf829f(0x15d)),{logger}=require(_0xdf829f(0x156)),idSchema=z[_0xdf829f(0x178)]()[_0xdf829f(0x153)]();async function saveMessage(_0x5a0799,_0x352ccd,_0x951dcd){const _0x104ead=_0xdf829f,_0x47bd23={'CyoOP':_0x104ead(0x162)};if(!_0x5a0799?.[_0x104ead(0x177)]?.['id'])throw new Error(_0x104ead(0x164));const _0x2dbaf7=idSchema['safeParse'](_0x352ccd[_0x104ead(0x163)]);if(!_0x2dbaf7[_0x104ead(0x16a)]){if(_0x47bd23[_0x104ead(0x15b)]===_0x104ead(0x162)){logger['warn'](_0x104ead(0x173)+_0x352ccd[_0x104ead(0x163)]),logger['info'](_0x104ead(0x143)+_0x951dcd?.[_0x104ead(0x176)]),logger[_0x104ead(0x170)](_0x104ead(0x149)+JSON['stringify'](_0x352ccd,null,0x2));return;}else _0xa47041[_0x104ead(0x170)](_0x104ead(0x13f)+_0xbc2f0c[_0x104ead(0x176)]);}try{const _0xeca3be={..._0x352ccd,'user':_0x5a0799[_0x104ead(0x177)]['id'],'messageId':_0x352ccd[_0x104ead(0x16e)]||_0x352ccd[_0x104ead(0x167)]},_0x9d1913=await Message[_0x104ead(0x161)]({'messageId':_0x352ccd['messageId'],'user':_0x5a0799[_0x104ead(0x177)]['id']},_0xeca3be,{'upsert':!![],'new':!![]});return _0x9d1913[_0x104ead(0x145)]();}catch(_0x81355b){logger[_0x104ead(0x152)](_0x104ead(0x141),_0x81355b),logger[_0x104ead(0x170)](_0x104ead(0x143)+_0x951dcd?.[_0x104ead(0x176)]);throw _0x81355b;}}async function bulkSaveMessages(_0x2d7531,_0x1d70b6=![]){const _0x4ee0ce=_0xdf829f,_0x175494={'GtIcH':_0x4ee0ce(0x150)};try{if(_0x175494[_0x4ee0ce(0x172)]!==_0x175494['GtIcH']){_0x2131dd['warn']('Invalid\x20conversation\x20ID:\x20'+_0x71f6ce[_0x4ee0ce(0x163)]),_0x2da9d8[_0x4ee0ce(0x170)]('---`saveMessage`\x20context:\x20'+_0x1d7866?.['context']),_0x33f8cd[_0x4ee0ce(0x170)](_0x4ee0ce(0x149)+_0x1256eb[_0x4ee0ce(0x166)](_0x16d01f,null,0x2));return;}else{const _0x17d618=_0x2d7531[_0x4ee0ce(0x157)](_0x50a458=>({'updateOne':{'filter':{'messageId':_0x50a458[_0x4ee0ce(0x167)]},'update':_0x50a458,'timestamps':!_0x1d70b6,'upsert':!![]}})),_0x1f4053=await Message['bulkWrite'](_0x17d618);return _0x1f4053;}}catch(_0x29b415){logger[_0x4ee0ce(0x152)](_0x4ee0ce(0x142),_0x29b415);throw _0x29b415;}}function _0x5dbe(){const _0x2f4430=['Oaxxd','GtIcH','Invalid\x20conversation\x20ID:\x20','find','Error\x20getting\x20messages:','context','user','string','SKhXj','gpCEk','Error\x20updating\x20message\x20text:','---`updateMessage`\x20context:\x20','16582xIYaZu','Error\x20saving\x20message:','Error\x20saving\x20messages\x20in\x20bulk:','---`saveMessage`\x20context:\x20','7fwWAIv','toObject','deleteMany','Message\x20not\x20found\x20or\x20user\x20not\x20authorized.','Error\x20deleting\x20messages:','---Invalid\x20conversation\x20ID\x20Params:\x20','Error\x20recording\x20message:','select','findOne','104649BZPNvf','EmAjv','lean','MHqEN','5199114wscwXu','error','uuid','2640393KCSDCc','1867700gCMUfo','~/config','map','isEdited','createdAt','sort','CyoOP','53bwVSxo','./schema/messageSchema','XKnbD','7434570Rgmszk','40pQTBfx','findOneAndUpdate','dXPDA','conversationId','User\x20not\x20authenticated','5101328htEHCg','stringify','messageId','VjzNp','ZsHtK','success','5BiLpuq','text','LwhMf','newMessageId','isCreatedByUser','info'];_0x5dbe=function(){return _0x2f4430;};return _0x5dbe();}async function recordMessage({user:_0x227348,endpoint:_0x19bc28,messageId:_0x156f1f,conversationId:_0x24a52b,parentMessageId:_0x2f511a,..._0x5e3272}){const _0x5ecb3f=_0xdf829f,_0x49bcdd={'gpCEk':_0x5ecb3f(0x14a)};try{const _0x3ab3b8={'user':_0x227348,'endpoint':_0x19bc28,'messageId':_0x156f1f,'conversationId':_0x24a52b,'parentMessageId':_0x2f511a,..._0x5e3272};return await Message[_0x5ecb3f(0x161)]({'user':_0x227348,'messageId':_0x156f1f},_0x3ab3b8,{'upsert':!![],'new':!![]});}catch(_0x497ebb){logger[_0x5ecb3f(0x152)](_0x49bcdd[_0x5ecb3f(0x13d)],_0x497ebb);throw _0x497ebb;}}async function updateMessageText(_0x69e1e7,{messageId:_0xb98642,text:_0x2df0dd}){const _0x5c6bc9=_0xdf829f,_0x34545f={'LwhMf':_0x5c6bc9(0x141),'Roxbp':function(_0x360551,_0x16bee4){return _0x360551!==_0x16bee4;},'SKhXj':_0x5c6bc9(0x13e)};try{await Message['updateOne']({'messageId':_0xb98642,'user':_0x69e1e7[_0x5c6bc9(0x177)]['id']},{'text':_0x2df0dd});}catch(_0x20051f){if(_0x34545f['Roxbp'](_0x5c6bc9(0x14e),_0x5c6bc9(0x14e))){_0x3b9069[_0x5c6bc9(0x152)](_0x34545f[_0x5c6bc9(0x16d)],_0x3ced34),_0x5f044c['info'](_0x5c6bc9(0x143)+_0x462373?.[_0x5c6bc9(0x176)]);throw _0x1769fd;}else{logger['error'](_0x34545f[_0x5c6bc9(0x179)],_0x20051f);throw _0x20051f;}}}async function updateMessage(_0x5dfe68,_0x2a569f,_0x3c81fb){const _0x28e0cd=_0xdf829f,_0x4849a5={'XKnbD':'Error\x20updating\x20message:'};try{const {messageId:_0x168548,..._0x5bf33c}=_0x2a569f;_0x5bf33c[_0x28e0cd(0x158)]=!![];const _0x34e8e=await Message[_0x28e0cd(0x161)]({'messageId':_0x168548,'user':_0x5dfe68['user']['id']},_0x5bf33c,{'new':!![]});if(!_0x34e8e)throw new Error(_0x28e0cd(0x147));return{'messageId':_0x34e8e['messageId'],'conversationId':_0x34e8e[_0x28e0cd(0x163)],'parentMessageId':_0x34e8e['parentMessageId'],'sender':_0x34e8e['sender'],'text':_0x34e8e[_0x28e0cd(0x16c)],'isCreatedByUser':_0x34e8e[_0x28e0cd(0x16f)],'tokenCount':_0x34e8e['tokenCount'],'isEdited':!![]};}catch(_0x60aad4){logger['error'](_0x4849a5[_0x28e0cd(0x15e)],_0x60aad4);_0x3c81fb&&_0x3c81fb?.['context']&&logger['info'](_0x28e0cd(0x13f)+_0x3c81fb[_0x28e0cd(0x176)]);throw _0x60aad4;}}async function deleteMessagesSince(_0x3d1fcc,{messageId:_0x40ed01,conversationId:_0x12adad}){const _0x1f06f6=_0xdf829f,_0x911ada={'ZsHtK':function(_0x35a615,_0x254cd7){return _0x35a615!==_0x254cd7;},'xvIVU':_0x1f06f6(0x168)};try{const _0x5a4a62=await Message[_0x1f06f6(0x14c)]({'messageId':_0x40ed01,'user':_0x3d1fcc[_0x1f06f6(0x177)]['id']})[_0x1f06f6(0x14f)]();if(_0x5a4a62){if(_0x911ada[_0x1f06f6(0x169)](_0x911ada['xvIVU'],_0x911ada['xvIVU'])){_0x3c2421[_0x1f06f6(0x152)]('Error\x20updating\x20message\x20text:',_0x1567df);throw _0x9b3473;}else{const _0x55cc02=Message[_0x1f06f6(0x174)]({'conversationId':_0x12adad,'user':_0x3d1fcc['user']['id']});return await _0x55cc02[_0x1f06f6(0x146)]({'createdAt':{'$gt':_0x5a4a62[_0x1f06f6(0x159)]}});}}return undefined;}catch(_0xdaa03b){logger[_0x1f06f6(0x152)]('Error\x20deleting\x20messages:',_0xdaa03b);throw _0xdaa03b;}}async function getMessages(_0x7b770c,_0x2bb7b7){const _0x4f5362=_0xdf829f;try{if(_0x2bb7b7)return await Message[_0x4f5362(0x174)](_0x7b770c)[_0x4f5362(0x14b)](_0x2bb7b7)['sort']({'createdAt':0x1})[_0x4f5362(0x14f)]();return await Message[_0x4f5362(0x174)](_0x7b770c)[_0x4f5362(0x15a)]({'createdAt':0x1})['lean']();}catch(_0x35989f){logger['error'](_0x4f5362(0x175),_0x35989f);throw _0x35989f;}}async function deleteMessages(_0x12db0d){const _0xf88841=_0xdf829f,_0xdc68e5={'Oaxxd':_0xf88841(0x148)};try{return await Message[_0xf88841(0x146)](_0x12db0d);}catch(_0x5dbf15){logger['error'](_0xdc68e5[_0xf88841(0x171)],_0x5dbf15);throw _0x5dbf15;}}module['exports']={'Message':Message,'saveMessage':saveMessage,'bulkSaveMessages':bulkSaveMessages,'recordMessage':recordMessage,'updateMessageText':updateMessageText,'updateMessage':updateMessage,'deleteMessagesSince':deleteMessagesSince,'getMessages':getMessages,'deleteMessages':deleteMessages};