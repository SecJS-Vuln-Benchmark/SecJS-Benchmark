const _0x2f341e=_0x5274;(function(_0x96ea81,_0x139cb9){const _0x14fbfb=_0x5274,_0x15d590=_0x96ea81();while(!![]){try{const _0xfac862=parseInt(_0x14fbfb(0xbb))/0x1*(-parseInt(_0x14fbfb(0xe1))/0x2)+parseInt(_0x14fbfb(0xe4))/0x3*(parseInt(_0x14fbfb(0xc3))/0x4)+parseInt(_0x14fbfb(0xc7))/0x5+parseInt(_0x14fbfb(0xc5))/0x6+parseInt(_0x14fbfb(0xfd))/0x7*(-parseInt(_0x14fbfb(0xe8))/0x8)+-parseInt(_0x14fbfb(0xe7))/0x9+-parseInt(_0x14fbfb(0xee))/0xa;if(_0xfac862===_0x139cb9)break;else _0x15d590['push'](_0x15d590['shift']());}catch(_0x5a094a){_0x15d590['push'](_0x15d590['shift']());}}}(_0x372b,0xd8686));import{assertEquals,assertRejects,assertThrows}from'@std/assert';import*as _0x47e1f1 from'mock_fetch';function _0x5274(_0x384521,_0x6c0899){const _0x372b25=_0x372b();return _0x5274=function(_0x5274d0,_0x447af8){_0x5274d0=_0x5274d0-0xb8;let _0x1c647e=_0x372b25[_0x5274d0];return _0x1c647e;},_0x5274(_0x384521,_0x6c0899);}import{MemoryKvStore}from'../federation/kv.ts';import{verify}from'../httpsig/mod.ts';import{mockDocumentLoader}from'../testing/docloader.ts';import{privateKey2}from'../testing/keys.ts';function _0x372b(){const _0x8393b8=['Now','NPTjv','AbCXv','RgoQx','194906LqNZTj','deny\x20private\x20network','get','3eocMjI','zkGzU','qwChP','3002616nOgJpo','18064vHSIbj','https://www.w3.org/ns/activitystreams','uauGm','Object','gPMCg','eAKQC','21835980LQhKyk','new\x20FetchError()','ZcnlV','mock','application/json','Duration','aBUPj','The\x20maximum\x20cache\x20duration\x20is\x2030\x20days','https://example.com/object','message','LXAKF','wxXqJ','TivNM','https://example.com/*','CpmTG','917HzyZZw','YsffL','deny\x20non-HTTP/HTTPS','stringify','fetchDocumentLoader()','An\x20error\x20message.','5dijtZG','test2','Ahrlz','Fetched\x20object','cached','https://example.com/','GET@/404','NmYfK','6666008DkwaKM','CYTbq','6132606ICEWBC','GET@/object','7490440dOuZir','install','url','VIeWv','mZyIA','not\x20cached','BKUNx','ckmtq','https://example.net/','from','FetchError','TIBsQ','_test','step','uninstall','oPWOW','https://example.org/','ddMdk','test','https://example.com/key2','not\x20ok','https://localhost'];_0x372b=function(){return _0x8393b8;};return _0x372b();}import{fetchDocumentLoader,FetchError,getAuthenticatedDocumentLoader,kvCache}from'./docloader.ts';import{UrlError}from'./url.ts';Deno['test'](_0x2f341e(0xef),()=>{const _0x2cc9a5=_0x2f341e,_0x6d268e={'uauGm':_0x2cc9a5(0xc0),'YsffL':function(_0x57c7da,_0x70f467,_0x263132){return _0x57c7da(_0x70f467,_0x263132);},'RgoQx':_0x2cc9a5(0xd1),'wxXqJ':function(_0x11db6e,_0xe4d8d2,_0x8154b9){return _0x11db6e(_0xe4d8d2,_0x8154b9);}},_0x59e105=new FetchError(_0x6d268e['uauGm'],_0x2cc9a5(0xba));_0x6d268e[_0x2cc9a5(0xfe)](assertEquals,_0x59e105['name'],_0x6d268e[_0x2cc9a5(0xe0)]),_0x6d268e['YsffL'](assertEquals,_0x59e105['url'],new URL(_0x6d268e[_0x2cc9a5(0xea)])),_0x6d268e[_0x2cc9a5(0xf9)](assertEquals,_0x59e105[_0x2cc9a5(0xf7)],'https://example.com/:\x20An\x20error\x20message.');const _0x27420e=new FetchError(new URL(_0x2cc9a5(0xd7)));assertEquals(_0x27420e[_0x2cc9a5(0xc9)],new URL(_0x2cc9a5(0xd7))),assertEquals(_0x27420e[_0x2cc9a5(0xf7)],_0x2cc9a5(0xd7));}),Deno['test'](_0x2f341e(0xb9),async _0x2826df=>{const _0x158691=_0x2f341e,_0x112018={'ddMdk':function(_0x41634c,_0x361fef,_0x3c7bd3){return _0x41634c(_0x361fef,_0x3c7bd3);},'BBXpB':function(_0x354935,_0x3363c2){return _0x354935(_0x3363c2);},'TuLha':_0x158691(0xf6),'BKUNx':_0x158691(0xeb),'CpmTG':function(_0x59c4b0,_0x40e778,_0x2c4438,_0x1396f4){return _0x59c4b0(_0x40e778,_0x2c4438,_0x1396f4);},'TivNM':_0x158691(0xe2)};_0x47e1f1[_0x158691(0xc8)](),_0x47e1f1[_0x158691(0xf1)](_0x158691(0xc6),_0x454eaa=>new Response(JSON[_0x158691(0xb8)]({'@context':_0x158691(0xe9),'id':_0x158691(0xf6),'name':_0x158691(0xbe),'type':_0x158691(0xeb)}),{'status':0xc8})),await _0x2826df[_0x158691(0xd4)]('ok',async()=>{const _0x551f96=_0x158691;_0x112018[_0x551f96(0xd8)](assertEquals,await _0x112018['BBXpB'](fetchDocumentLoader,_0x551f96(0xf6)),{'contextUrl':null,'documentUrl':_0x112018['TuLha'],'document':{'@context':_0x551f96(0xe9),'id':_0x551f96(0xf6),'name':'Fetched\x20object','type':_0x112018[_0x551f96(0xcd)]}});}),_0x47e1f1[_0x158691(0xf1)](_0x158691(0xc1),_0x688d39=>new Response('',{'status':0x194})),await _0x2826df['step'](_0x158691(0xdb),async()=>{const _0x576ac5=_0x158691;await _0x112018[_0x576ac5(0xfc)](assertRejects,()=>fetchDocumentLoader('https://example.com/404'),FetchError,'HTTP\x20404:\x20https://example.com/404');}),_0x47e1f1[_0x158691(0xd5)](),await _0x2826df[_0x158691(0xd4)](_0x158691(0xff),async()=>{await assertRejects(()=>fetchDocumentLoader('ftp://localhost'),UrlError);}),await _0x2826df['step'](_0x112018[_0x158691(0xfa)],async()=>{const _0x243dd9=_0x158691;await assertRejects(()=>fetchDocumentLoader(_0x243dd9(0xdc)),UrlError);});}),Deno[_0x2f341e(0xd9)]('getAuthenticatedDocumentLoader()',async _0x542ef0=>{const _0x5506d2=_0x2f341e,_0x31fae9={'CYTbq':function(_0x41cf60,_0x32d995){return _0x41cf60!=_0x32d995;},'mZyIA':_0x5506d2(0xf2),'gPMCg':_0x5506d2(0xda),'XBzuj':'https://example.com/object','zkGzU':function(_0x386334,_0x52f115,_0x117c35){return _0x386334(_0x52f115,_0x117c35);},'LXAKF':_0x5506d2(0xd9),'NmYfK':_0x5506d2(0xff),'WZeus':_0x5506d2(0xe2)};_0x47e1f1[_0x5506d2(0xc8)](),_0x47e1f1[_0x5506d2(0xf1)](_0x5506d2(0xc6),async _0x8d60e3=>{const _0x55b9c1=_0x5506d2,_0x57643b=await verify(_0x8d60e3,{'documentLoader':mockDocumentLoader,'contextLoader':mockDocumentLoader,'currentTime':Temporal[_0x55b9c1(0xdd)]['instant']()});return new Response(JSON['stringify'](_0x31fae9[_0x55b9c1(0xc4)](_0x57643b,null)),{'headers':{'Content-Type':_0x31fae9[_0x55b9c1(0xcb)]}});}),await _0x542ef0[_0x5506d2(0xd4)](_0x31fae9[_0x5506d2(0xf8)],async()=>{const _0x548662=_0x5506d2,_0x53eb18=await getAuthenticatedDocumentLoader({'keyId':new URL(_0x31fae9[_0x548662(0xec)]),'privateKey':privateKey2});assertEquals(await _0x53eb18(_0x31fae9['XBzuj']),{'contextUrl':null,'documentUrl':_0x548662(0xf6),'document':!![]});}),_0x47e1f1[_0x5506d2(0xd5)](),await _0x542ef0[_0x5506d2(0xd4)](_0x31fae9[_0x5506d2(0xc2)],async()=>{const _0xf3e339=_0x5506d2,_0x384e64=await getAuthenticatedDocumentLoader({'keyId':new URL(_0x31fae9[_0xf3e339(0xec)]),'privateKey':privateKey2});_0x31fae9[_0xf3e339(0xe5)](assertRejects,()=>_0x384e64('ftp://localhost'),UrlError);}),await _0x542ef0['step'](_0x31fae9['WZeus'],async()=>{const _0x56250c=_0x5506d2,_0x47fecc=await getAuthenticatedDocumentLoader({'keyId':new URL(_0x31fae9[_0x56250c(0xec)]),'privateKey':privateKey2});assertRejects(()=>_0x47fecc('http://localhost'),UrlError);});}),Deno[_0x2f341e(0xd9)]('kvCache()',async _0x5f5bb4=>{const _0xd0c864=_0x2f341e,_0x5c750e={'NPTjv':function(_0x36672b,_0x442bc4){return _0x36672b(_0x442bc4);},'qwChP':'https://example.org/','lXiRb':'https://example.com/*','ZcnlV':_0xd0c864(0xd3),'ckmtq':_0xd0c864(0xbf),'eAKQC':'https://example.com/object','Ahrlz':_0xd0c864(0xeb),'TIBsQ':function(_0x320203,_0x5cdc05,_0xf9a5f){return _0x320203(_0x5cdc05,_0xf9a5f);},'VIeWv':'https://example.net/','crLEx':function(_0x527ec5,_0x126103){return _0x527ec5(_0x126103);},'AbCXv':'not\x20cached','UWcar':_0xd0c864(0xe9),'EdZsg':_0xd0c864(0xbe),'oPWOW':function(_0x5d8635,_0x5662f2,_0x58a991,_0x168fd0){return _0x5d8635(_0x5662f2,_0x58a991,_0x168fd0);},'aBUPj':'The\x20maximum\x20cache\x20duration\x20is\x2030\x20days'},_0x569203=new MemoryKvStore();await _0x5f5bb4[_0xd0c864(0xd4)](_0x5c750e[_0xd0c864(0xce)],async()=>{const _0x4410e8=_0xd0c864,_0x19f940=_0x5c750e[_0x4410e8(0xde)](kvCache,{'kv':_0x569203,'loader':mockDocumentLoader,'rules':[[_0x5c750e[_0x4410e8(0xe6)],Temporal['Duration'][_0x4410e8(0xd0)]({'days':0x1})],[new URL('https://example.net/'),Temporal['Duration'][_0x4410e8(0xd0)]({'days':0x1})],[new URLPattern(_0x5c750e['lXiRb']),Temporal[_0x4410e8(0xf3)][_0x4410e8(0xd0)]({'days':0x1e})]],'prefix':[_0x5c750e[_0x4410e8(0xf0)],_0x5c750e[_0x4410e8(0xce)]]}),_0x45d2c1=await _0x19f940(_0x5c750e[_0x4410e8(0xed)]);assertEquals(_0x45d2c1,{'contextUrl':null,'documentUrl':_0x4410e8(0xf6),'document':{'@context':'https://www.w3.org/ns/activitystreams','id':'https://example.com/object','name':'Fetched\x20object','type':_0x5c750e[_0x4410e8(0xbd)]}});const _0x40ebc7=await _0x569203[_0x4410e8(0xe3)](['_test',_0x4410e8(0xbf),_0x4410e8(0xf6)]);assertEquals(_0x40ebc7,_0x45d2c1),await _0x569203['set'](['_test','cached','https://example.org/'],{'contextUrl':null,'documentUrl':_0x5c750e[_0x4410e8(0xe6)],'document':{'id':_0x4410e8(0xd7)}});const _0x14ed06=await _0x19f940(_0x4410e8(0xd7));_0x5c750e[_0x4410e8(0xd2)](assertEquals,_0x14ed06,{'contextUrl':null,'documentUrl':_0x5c750e[_0x4410e8(0xe6)],'document':{'id':_0x4410e8(0xd7)}}),await _0x569203['set']([_0x5c750e['ZcnlV'],_0x5c750e[_0x4410e8(0xce)],_0x5c750e[_0x4410e8(0xca)]],{'contextUrl':null,'documentUrl':_0x5c750e[_0x4410e8(0xca)],'document':{'id':_0x4410e8(0xcf)}});const _0x4a4412=await _0x5c750e['crLEx'](_0x19f940,_0x5c750e[_0x4410e8(0xca)]);assertEquals(_0x4a4412,{'contextUrl':null,'documentUrl':_0x4410e8(0xcf),'document':{'id':_0x5c750e['VIeWv']}});}),await _0x5f5bb4[_0xd0c864(0xd4)](_0xd0c864(0xcc),async()=>{const _0x28d002=_0xd0c864,_0x392014=kvCache({'kv':_0x569203,'loader':mockDocumentLoader,'rules':[],'prefix':[_0x28d002(0xd3),_0x5c750e[_0x28d002(0xdf)]]}),_0x35b8e2=await _0x5c750e[_0x28d002(0xde)](_0x392014,_0x28d002(0xf6));_0x5c750e[_0x28d002(0xd2)](assertEquals,_0x35b8e2,{'contextUrl':null,'documentUrl':_0x28d002(0xf6),'document':{'@context':_0x5c750e['UWcar'],'id':_0x5c750e[_0x28d002(0xed)],'name':_0x5c750e['EdZsg'],'type':_0x5c750e['Ahrlz']}});const _0xf71ba3=await _0x569203[_0x28d002(0xe3)]([_0x28d002(0xbc),'not\x20cached',_0x28d002(0xf6)]);_0x5c750e[_0x28d002(0xd2)](assertEquals,_0xf71ba3,undefined);}),await _0x5f5bb4[_0xd0c864(0xd4)]('maximum\x20cache\x20duration',()=>{const _0x7ed2dc=_0xd0c864;_0x5c750e[_0x7ed2dc(0xd6)](assertThrows,()=>kvCache({'kv':_0x569203,'loader':mockDocumentLoader,'rules':[['https://example.com/',Temporal[_0x7ed2dc(0xf3)][_0x7ed2dc(0xd0)]({'days':0x1e,'seconds':0x1})]]}),TypeError,_0x5c750e[_0x7ed2dc(0xf4)]),assertThrows(()=>kvCache({'kv':_0x569203,'loader':mockDocumentLoader,'rules':[[new URLPattern(_0x7ed2dc(0xfb)),Temporal['Duration']['from']({'days':0x1e,'seconds':0x1})]]}),TypeError,_0x7ed2dc(0xf5));});});