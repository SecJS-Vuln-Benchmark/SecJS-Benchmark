const _0x2e7538=_0x5acc;function _0x5acc(_0x27cccc,_0x53ca1f){const _0x5dfd3c=_0x5dfd();return _0x5acc=function(_0x5accbd,_0x425002){_0x5accbd=_0x5accbd-0x1ca;let _0x34f930=_0x5dfd3c[_0x5accbd];return _0x34f930;},_0x5acc(_0x27cccc,_0x53ca1f);}(function(_0x4135fa,_0x5b3c0d){const _0x8e9e8=_0x5acc,_0x3cdac8=_0x4135fa();while(!![]){try{const _0x8b3479=-parseInt(_0x8e9e8(0x26e))/0x1*(-parseInt(_0x8e9e8(0x238))/0x2)+-parseInt(_0x8e9e8(0x1fd))/0x3+-parseInt(_0x8e9e8(0x1d3))/0x4+parseInt(_0x8e9e8(0x1fb))/0x5*(parseInt(_0x8e9e8(0x266))/0x6)+-parseInt(_0x8e9e8(0x21f))/0x7+-parseInt(_0x8e9e8(0x1cc))/0x8+parseInt(_0x8e9e8(0x248))/0x9;if(_0x8b3479===_0x5b3c0d)break;else _0x3cdac8['push'](_0x3cdac8['shift']());}catch(_0x58bf85){_0x3cdac8['push'](_0x3cdac8['shift']());}}}(_0x5dfd,0xbcd77));const fs=require('fs'),path=require('path'),mime=require(_0x2e7538(0x1f9)),{v4}=require(_0x2e7538(0x25e)),{isUUID,megabyte,FileContext,FileSources,imageExtRegex,EModelEndpoint,EToolResources,mergeFileConfig,hostImageIdSuffix,checkOpenAIStorage,removeNullishValues,hostImageNamePrefix,isAssistantsEndpoint}=require(_0x2e7538(0x206)),{EnvVar}=require(_0x2e7538(0x1fa)),{addResourceFileId,deleteResourceFileId}=require('~/server/controllers/assistants/v2'),{convertImage,resizeAndConvert}=require(_0x2e7538(0x229)),{addAgentResourceFile,removeAgentResourceFile}=require(_0x2e7538(0x21b)),{getOpenAIClient}=require(_0x2e7538(0x220)),{createFile,updateFileUsage,deleteFiles}=require(_0x2e7538(0x23b)),{loadAuthValues}=require(_0x2e7538(0x247)),{LB_QueueAsyncCall}=require(_0x2e7538(0x23a)),{getStrategyFunctions}=require('./strategies'),{determineFileType}=require(_0x2e7538(0x20f)),{logger}=require(_0x2e7538(0x277)),processFiles=async _0x2b6d83=>{const _0xd7a083=_0x2e7538,_0x192a5a={'JEemp':function(_0x2bf97d,_0x2a8d57){return _0x2bf97d(_0x2a8d57);}},_0x589aae=[];for(let _0x1edf3c of _0x2b6d83){const {file_id:_0x20f456}=_0x1edf3c;_0x589aae[_0xd7a083(0x225)](_0x192a5a['JEemp'](updateFileUsage,{'file_id':_0x20f456}));}return await Promise[_0xd7a083(0x1e5)](_0x589aae);};function enqueueDeleteOperation({req:_0x1548cd,file:_0x24e6c3,deleteFile:_0x400dc8,promises:_0x509f9d,resolvedFileIds:_0x451d78,openai:_0x37a96a}){const _0x93e4de=_0x2e7538,_0x2a1336={'WsPyk':function(_0x86ba87,_0x2471fd){return _0x86ba87(_0x2471fd);},'TsoiI':_0x93e4de(0x201),'DBpsx':function(_0x505812,_0x3bedc0){return _0x505812(_0x3bedc0);},'Nzmcy':function(_0x4a836f,_0x416a02){return _0x4a836f===_0x416a02;},'sAfxl':function(_0x27a0c1,_0xd349a,_0x36fe70,_0x264bec){return _0x27a0c1(_0xd349a,_0x36fe70,_0x264bec);},'bTjhZ':'Error\x20deleting\x20file','lTaVu':function(_0x5b9e51,_0x230099){return _0x5b9e51===_0x230099;},'eaviY':'ZPJGp'};checkOpenAIStorage(_0x24e6c3[_0x93e4de(0x270)])?_0x2a1336[_0x93e4de(0x24c)](_0x2a1336['eaviY'],_0x93e4de(0x251))?_0x17d3b5['push'](_0x2f44de({'req':_0xf07046,'openai':_0x1cb645,'file_id':_0x34d422[_0x93e4de(0x1ca)],'assistant_id':_0x382db1[_0x93e4de(0x1f5)]['assistant_id'],'tool_resource':_0x2b3fb3[_0x93e4de(0x1f5)][_0x93e4de(0x1ec)]})):_0x509f9d[_0x93e4de(0x225)](new Promise((_0x29c6e5,_0x70f483)=>{const _0x942967=_0x93e4de;_0x2a1336[_0x942967(0x203)](_0x942967(0x23d),_0x942967(0x1d2))?_0x53838c[_0x942967(0x225)](_0x2a1336[_0x942967(0x21d)](_0x435e9b,{'req':_0x356652,'file_id':_0x384346['file_id'],'agent_id':_0x37509d[_0x942967(0x1f5)][_0x942967(0x263)],'tool_resource':_0x119ac9[_0x942967(0x1f5)][_0x942967(0x1ec)]})):_0x2a1336[_0x942967(0x278)](LB_QueueAsyncCall,()=>_0x400dc8(_0x1548cd,_0x24e6c3,_0x37a96a),[],(_0x308061,_0x25ef54)=>{const _0x2be4e4=_0x942967;_0x308061?(logger[_0x2be4e4(0x1d9)](_0x2a1336[_0x2be4e4(0x1d4)],_0x308061),_0x70f483(_0x308061)):(_0x451d78[_0x2be4e4(0x225)](_0x24e6c3['file_id']),_0x2a1336['DBpsx'](_0x29c6e5,_0x25ef54));});})):_0x509f9d[_0x93e4de(0x225)](_0x400dc8(_0x1548cd,_0x24e6c3)[_0x93e4de(0x232)](()=>_0x451d78['push'](_0x24e6c3[_0x93e4de(0x1ca)]))[_0x93e4de(0x22a)](_0x38b9ce=>{const _0x469570=_0x93e4de;return logger[_0x469570(0x1d9)](_0x2a1336[_0x469570(0x21a)],_0x38b9ce),Promise['reject'](_0x38b9ce);}));}const processDeleteRequest=async({req:_0x5e0ab3,files:_0x428370})=>{const _0x5e028a=_0x2e7538,_0x11e4b4={'otyHS':function(_0x2ec443,_0x45cff4){return _0x2ec443(_0x45cff4);},'RTHaK':function(_0xa3a1a5,_0x37cfc){return _0xa3a1a5(_0x37cfc);},'bBEmz':function(_0x1b319d,_0x4ef626){return _0x1b319d!==_0x4ef626;},'ntHMM':function(_0x5a4975,_0x8d797e){return _0x5a4975(_0x8d797e);},'YYZhh':function(_0x3ff837,_0x53dcd5){return _0x3ff837(_0x53dcd5);}},_0x59cebb=[],_0x592a88={},_0x3fd6ae=[],_0x496ba5={[FileSources['openai']]:undefined,[FileSources['azure']]:undefined},_0x5e22e4=async()=>{const _0x54f6b6=_0x5acc,_0x3e6f19=await _0x11e4b4[_0x54f6b6(0x1d0)](getOpenAIClient,{'req':_0x5e0ab3,'overrideEndpoint':EModelEndpoint[_0x54f6b6(0x259)]});_0x496ba5[FileSources['openai']]=_0x3e6f19[_0x54f6b6(0x1db)];if(!_0x5e0ab3[_0x54f6b6(0x20c)][_0x54f6b6(0x228)][EModelEndpoint[_0x54f6b6(0x244)]]?.[_0x54f6b6(0x259)])return;const _0x5666ed=await _0x11e4b4[_0x54f6b6(0x26d)](getOpenAIClient,{'req':_0x5e0ab3,'overrideEndpoint':EModelEndpoint[_0x54f6b6(0x1cf)]});_0x496ba5[FileSources[_0x54f6b6(0x1ff)]]=_0x5666ed[_0x54f6b6(0x1db)];};_0x11e4b4['bBEmz'](_0x5e0ab3[_0x5e028a(0x1f5)][_0x5e028a(0x204)],undefined)&&await _0x5e22e4();for(const _0x52c8cb of _0x428370){const _0x321f82=_0x52c8cb[_0x5e028a(0x270)]??FileSources[_0x5e028a(0x242)];_0x5e0ab3['body']['agent_id']&&_0x5e0ab3[_0x5e028a(0x1f5)][_0x5e028a(0x1ec)]&&_0x3fd6ae[_0x5e028a(0x225)](removeAgentResourceFile({'req':_0x5e0ab3,'file_id':_0x52c8cb[_0x5e028a(0x1ca)],'agent_id':_0x5e0ab3[_0x5e028a(0x1f5)]['agent_id'],'tool_resource':_0x5e0ab3['body'][_0x5e028a(0x1ec)]}));_0x11e4b4[_0x5e028a(0x1d0)](checkOpenAIStorage,_0x321f82)&&!_0x496ba5[_0x321f82]&&await _0x5e22e4();const _0x4698ce=_0x496ba5[_0x321f82];if(_0x5e0ab3['body']['assistant_id']&&_0x5e0ab3[_0x5e028a(0x1f5)]['tool_resource'])_0x3fd6ae['push'](deleteResourceFileId({'req':_0x5e0ab3,'openai':_0x4698ce,'file_id':_0x52c8cb[_0x5e028a(0x1ca)],'assistant_id':_0x5e0ab3[_0x5e028a(0x1f5)][_0x5e028a(0x204)],'tool_resource':_0x5e0ab3[_0x5e028a(0x1f5)][_0x5e028a(0x1ec)]}));else _0x5e0ab3[_0x5e028a(0x1f5)]['assistant_id']&&_0x3fd6ae['push'](_0x4698ce[_0x5e028a(0x274)][_0x5e028a(0x259)][_0x5e028a(0x24f)][_0x5e028a(0x23c)](_0x5e0ab3['body'][_0x5e028a(0x204)],_0x52c8cb[_0x5e028a(0x1ca)]));if(_0x592a88[_0x321f82]){_0x11e4b4['ntHMM'](enqueueDeleteOperation,{'req':_0x5e0ab3,'file':_0x52c8cb,'deleteFile':_0x592a88[_0x321f82],'promises':_0x3fd6ae,'resolvedFileIds':_0x59cebb,'openai':_0x4698ce});continue;}const {deleteFile:_0x1f8d51}=getStrategyFunctions(_0x321f82);if(!_0x1f8d51)throw new Error(_0x5e028a(0x210)+_0x321f82);_0x592a88[_0x321f82]=_0x1f8d51,_0x11e4b4[_0x5e028a(0x1e7)](enqueueDeleteOperation,{'req':_0x5e0ab3,'file':_0x52c8cb,'deleteFile':_0x1f8d51,'promises':_0x3fd6ae,'resolvedFileIds':_0x59cebb,'openai':_0x4698ce});}await Promise[_0x5e028a(0x237)](_0x3fd6ae),await deleteFiles(_0x59cebb);},processFileURL=async({fileStrategy:_0x3f8dd6,userId:_0x51ae9d,URL:_0x3d91bb,fileName:_0x2deba1,basePath:_0x26e838,context:_0x4f83f2})=>{const _0x485385=_0x2e7538,_0x1b0674={'XNFsP':function(_0x1a49b7,_0x662c58){return _0x1a49b7(_0x662c58);}},{saveURL:_0x12b22e,getFileURL:_0x5c2a2f}=getStrategyFunctions(_0x3f8dd6);try{const {bytes:bytes=0x0,type:type='',dimensions:dimensions={}}=await _0x12b22e({'userId':_0x51ae9d,'URL':_0x3d91bb,'fileName':_0x2deba1,'basePath':_0x26e838})||{},_0x9148af=await _0x1b0674[_0x485385(0x21c)](_0x5c2a2f,{'fileName':_0x51ae9d+'/'+_0x2deba1,'basePath':_0x26e838});return await createFile({'user':_0x51ae9d,'file_id':v4(),'bytes':bytes,'filepath':_0x9148af,'filename':_0x2deba1,'source':_0x3f8dd6,'type':type,'context':_0x4f83f2,'width':dimensions[_0x485385(0x1df)],'height':dimensions[_0x485385(0x240)]},!![]);}catch(_0x371638){logger['error'](_0x485385(0x234)+_0x3f8dd6+':',_0x371638);throw new Error(_0x485385(0x21e)+_0x3f8dd6+'.\x20'+_0x371638[_0x485385(0x1d7)]);}},processImageFile=async({req:_0x26cdb0,res:_0x102c12,file:_0x4edbd7,metadata:_0x1c5b08,returnFile:returnFile=![]})=>{const _0x195f6b=_0x2e7538,_0x1523cb={'xMWsx':function(_0x3cb2d1,_0x235adf){return _0x3cb2d1(_0x235adf);},'qPWoD':function(_0x5d4471,_0x4dda91,_0x2af0f1){return _0x5d4471(_0x4dda91,_0x2af0f1);},'EZqzC':'FwuAI'},_0x40622b=_0x26cdb0[_0x195f6b(0x20c)]['locals'][_0x195f6b(0x1cd)],{handleImageUpload:_0x29ced8}=getStrategyFunctions(_0x40622b),{file_id:_0x31d953,temp_file_id:_0x1b8458,endpoint:_0x317255}=_0x1c5b08,{filepath:_0x2a4bb7,bytes:_0x5adf8b,width:_0x1f780b,height:_0x4d3c91}=await _0x29ced8({'req':_0x26cdb0,'file':_0x4edbd7,'file_id':_0x31d953,'endpoint':_0x317255}),_0xf0b9bf=await _0x1523cb[_0x195f6b(0x24e)](createFile,{'user':_0x26cdb0[_0x195f6b(0x216)]['id'],'file_id':_0x31d953,'temp_file_id':_0x1b8458,'bytes':_0x5adf8b,'filepath':_0x2a4bb7,'filename':_0x4edbd7[_0x195f6b(0x20d)],'context':FileContext[_0x195f6b(0x241)],'source':_0x40622b,'type':'image/'+_0x26cdb0[_0x195f6b(0x20c)]['locals'][_0x195f6b(0x26f)],'width':_0x1f780b,'height':_0x4d3c91},!![]);if(returnFile)return _0x195f6b(0x265)===_0x1523cb[_0x195f6b(0x217)]?_0x1523cb['xMWsx'](_0x2c581c,{..._0x7e211d,'updateUsage':!![]}):_0xf0b9bf;_0x102c12[_0x195f6b(0x279)](0xc8)['json']({'message':'File\x20uploaded\x20and\x20processed\x20successfully',..._0xf0b9bf});},uploadImageBuffer=async({req:_0x554ff6,context:_0x657e38,metadata:metadata={},resize:resize=!![]})=>{const _0x185f43=_0x2e7538,_0x4e292d={'uDoOX':function(_0x17c493,_0x155441){return _0x17c493(_0x155441);},'INsQs':function(_0x10dcdb,_0x1a9724){return _0x10dcdb(_0x1a9724);},'yXGSG':function(_0x569b02,_0x25fa59){return _0x569b02(_0x25fa59);},'cdvVS':function(_0x48c936,_0x387153,_0x32c8cf){return _0x48c936(_0x387153,_0x32c8cf);}},_0x692157=_0x554ff6['app'][_0x185f43(0x228)][_0x185f43(0x1cd)],{saveBuffer:_0x24d761}=_0x4e292d[_0x185f43(0x1f3)](getStrategyFunctions,_0x692157);let {buffer:_0x444138,width:_0x244b1f,height:_0x36d561,bytes:_0x2ca480,filename:_0x7f6ee,file_id:_0x3325de,type:_0x649868}=metadata;resize&&(_0x3325de=v4(),_0x649868=_0x185f43(0x1d8)+_0x554ff6['app'][_0x185f43(0x228)][_0x185f43(0x26f)],{buffer:_0x444138,width:_0x244b1f,height:_0x36d561,bytes:_0x2ca480}=await _0x4e292d['INsQs'](resizeAndConvert,{'inputBuffer':_0x444138,'desiredFormat':_0x554ff6[_0x185f43(0x20c)][_0x185f43(0x228)]['imageOutputType']}),_0x7f6ee=path[_0x185f43(0x213)](_0x554ff6['file'][_0x185f43(0x20d)],path[_0x185f43(0x227)](_0x554ff6[_0x185f43(0x1e0)]['originalname']))+'.'+_0x554ff6[_0x185f43(0x20c)]['locals'][_0x185f43(0x26f)]);const _0x842411=await _0x4e292d['yXGSG'](_0x24d761,{'userId':_0x554ff6['user']['id'],'fileName':_0x7f6ee,'buffer':_0x444138});return await _0x4e292d[_0x185f43(0x1f4)](createFile,{'user':_0x554ff6[_0x185f43(0x216)]['id'],'file_id':_0x3325de,'bytes':_0x2ca480,'filepath':_0x842411,'filename':_0x7f6ee,'context':_0x657e38,'source':_0x692157,'type':_0x649868,'width':_0x244b1f,'height':_0x36d561},!![]);},processFileUpload=async({req:_0x3dfd0,res:_0x51265a,file:_0x2a62ee,metadata:_0x216acb})=>{const _0x3205f9=_0x2e7538,_0x1c7f51={'IbXIo':function(_0x248e31,_0x29b9df){return _0x248e31===_0x29b9df;},'kfxTK':function(_0x14c7c8,_0x3511b9){return _0x14c7c8(_0x3511b9);},'aAIwJ':_0x3205f9(0x231),'yGtLJ':function(_0x5c29fc,_0x51470f,_0x48f6e5){return _0x5c29fc(_0x51470f,_0x48f6e5);}},_0x1735b0=isAssistantsEndpoint(_0x216acb['endpoint']),_0x29d7fe=_0x1c7f51[_0x3205f9(0x1e2)](_0x216acb['endpoint'],EModelEndpoint[_0x3205f9(0x1cf)])?FileSources[_0x3205f9(0x1ff)]:FileSources['openai'],_0x19da0c=_0x1735b0?_0x29d7fe:FileSources[_0x3205f9(0x20a)],{handleFileUpload:_0x399036}=getStrategyFunctions(_0x19da0c),{file_id:_0xb969da,temp_file_id:_0x8c332e}=_0x216acb;let _0xdd1b57;checkOpenAIStorage(_0x19da0c)&&({openai:_0xdd1b57}=await _0x1c7f51[_0x3205f9(0x1cb)](getOpenAIClient,{'req':_0x3dfd0}));const {id:_0x1d58b5,bytes:_0x56d504,filename:_0x42e729,filepath:_0x116a2f,embedded:_0x138e9d,height:_0x36ea51,width:_0x1bd706}=await _0x1c7f51[_0x3205f9(0x1cb)](_0x399036,{'req':_0x3dfd0,'file':_0x2a62ee,'file_id':_0xb969da,'openai':_0xdd1b57});if(_0x1735b0&&!_0x216acb[_0x3205f9(0x26a)]&&!_0x216acb[_0x3205f9(0x1ec)])await _0xdd1b57['beta'][_0x3205f9(0x259)][_0x3205f9(0x24f)][_0x3205f9(0x24b)](_0x216acb[_0x3205f9(0x204)],{'file_id':_0x1d58b5});else{if(_0x1735b0&&!_0x216acb['message_file']){if(_0x1c7f51[_0x3205f9(0x1e2)](_0x1c7f51[_0x3205f9(0x226)],_0x1c7f51[_0x3205f9(0x226)]))await addResourceFileId({'req':_0x3dfd0,'openai':_0xdd1b57,'file_id':_0x1d58b5,'assistant_id':_0x216acb[_0x3205f9(0x204)],'tool_resource':_0x216acb[_0x3205f9(0x1ec)]});else throw new _0x5a72c2(_0x3205f9(0x205));}}let _0x32b789=_0x1735b0?_0xdd1b57['baseURL']+_0x3205f9(0x269)+_0x1d58b5:_0x116a2f;if(_0x1735b0&&_0x2a62ee[_0x3205f9(0x22f)][_0x3205f9(0x27a)](_0x3205f9(0x255))){const _0xe6c692=await processImageFile({'req':_0x3dfd0,'file':_0x2a62ee,'metadata':{'file_id':v4()},'returnFile':!![]});_0x32b789=_0xe6c692[_0x3205f9(0x22d)];}const _0x1d4d78=await _0x1c7f51[_0x3205f9(0x1d5)](createFile,{'user':_0x3dfd0[_0x3205f9(0x216)]['id'],'file_id':_0x1d58b5??_0xb969da,'temp_file_id':_0x8c332e,'bytes':_0x56d504,'filepath':_0x32b789,'filename':_0x42e729??_0x2a62ee[_0x3205f9(0x20d)],'context':_0x1735b0?FileContext[_0x3205f9(0x259)]:FileContext['message_attachment'],'model':_0x1735b0?_0x3dfd0[_0x3205f9(0x1f5)][_0x3205f9(0x25a)]:undefined,'type':_0x2a62ee[_0x3205f9(0x22f)],'embedded':_0x138e9d,'source':_0x19da0c,'height':_0x36ea51,'width':_0x1bd706},!![]);_0x51265a[_0x3205f9(0x279)](0xc8)[_0x3205f9(0x22b)]({'message':_0x3205f9(0x250),..._0x1d4d78});},processAgentFileUpload=async({req:_0x5f1f67,res:_0x93b926,file:_0x4c9dd6,metadata:_0x21c3e4})=>{const _0x464dda=_0x2e7538,_0x3dda55={'bRiPA':_0x464dda(0x201),'TdKfh':function(_0x3eaaf7,_0x556857){return _0x3eaaf7(_0x556857);},'aTanO':function(_0x5140df,_0x23a12d,_0xbae64e,_0x5e50f3){return _0x5140df(_0x23a12d,_0xbae64e,_0x5e50f3);},'QTQuC':function(_0x3d3e23,_0x5fa95d){return _0x3d3e23&&_0x5fa95d;},'sbEcU':function(_0x38bba6,_0x40d6b0){return _0x38bba6!==_0x40d6b0;},'CRVJv':'WBNBj','zBPcO':'DVSyH','WgMjG':'No\x20tool\x20resource\x20provided\x20for\x20agent\x20file\x20upload','hQteG':function(_0x1dc6ca,_0x108f61){return _0x1dc6ca===_0x108f61;},'PTmfv':_0x464dda(0x255),'TcpxG':function(_0x15c930,_0xf5bd05){return _0x15c930===_0xf5bd05;},'aYqSR':_0x464dda(0x271),'cLwmt':'Image\x20uploads\x20are\x20not\x20supported\x20for\x20file\x20search\x20tool\x20resources','PSHcT':_0x464dda(0x1ef),'hlyoD':function(_0x325e5e,_0x211229){return _0x325e5e===_0x211229;},'TodDf':function(_0x38ed99,_0x1cf82){return _0x38ed99(_0x1cf82);},'tlmyR':function(_0x4562d1,_0x342ce7){return _0x4562d1!==_0x342ce7;},'QTGKI':_0x464dda(0x1f2)},{agent_id:_0x4aa9c0,tool_resource:_0x48ddcb}=_0x21c3e4;if(_0x3dda55[_0x464dda(0x262)](_0x4aa9c0,!_0x48ddcb)){if(_0x3dda55[_0x464dda(0x20e)](_0x3dda55['CRVJv'],_0x3dda55[_0x464dda(0x233)]))throw new Error(_0x3dda55['WgMjG']);else _0x3dda55[_0x464dda(0x223)](_0x5dc8fa,()=>_0x4bf268(_0x2290a2,_0x151875,_0x1d1892),[],(_0x3e26f1,_0x31c42b)=>{const _0x51ec50=_0x464dda;_0x3e26f1?(_0x7d94b3[_0x51ec50(0x1d9)](_0x3dda55[_0x51ec50(0x260)],_0x3e26f1),_0x3dda55[_0x51ec50(0x239)](_0x10bf94,_0x3e26f1)):(_0x23c998[_0x51ec50(0x225)](_0x317663[_0x51ec50(0x1ca)]),_0x5b5275(_0x31c42b));});}if(_0x3dda55['hQteG'](_0x48ddcb,EToolResources['file_search'])&&_0x4c9dd6['mimetype'][_0x464dda(0x27a)](_0x3dda55['PTmfv'])){if(_0x3dda55[_0x464dda(0x1ce)](_0x464dda(0x273),_0x3dda55[_0x464dda(0x1f7)]))throw new _0x18011f('No\x20file_id\x20provided');else throw new Error(_0x3dda55[_0x464dda(0x208)]);}let _0x48721e=!!_0x21c3e4[_0x464dda(0x26a)];if(!_0x48721e&&!_0x4aa9c0)throw new Error(_0x3dda55[_0x464dda(0x1dc)]);let _0x2ce23e;if(_0x3dda55['hlyoD'](_0x48ddcb,EToolResources['execute_code'])){const {handleFileUpload:_0x147059}=getStrategyFunctions(FileSources['execute_code']),_0x441a00=await _0x3dda55[_0x464dda(0x239)](loadAuthValues,{'userId':_0x5f1f67[_0x464dda(0x216)]['id'],'authFields':[EnvVar['CODE_API_KEY']]}),_0xe5bd09=fs[_0x464dda(0x202)](_0x4c9dd6[_0x464dda(0x1dd)]),_0x4c17c3=await _0x147059({'req':_0x5f1f67,'stream':_0xe5bd09,'filename':_0x4c9dd6['originalname'],'apiKey':_0x441a00[EnvVar[_0x464dda(0x1ee)]]});_0x2ce23e={'fileIdentifier':_0x4c17c3};}const _0x57c281=_0x48ddcb===EToolResources[_0x464dda(0x264)]?FileSources['vectordb']:_0x5f1f67[_0x464dda(0x20c)][_0x464dda(0x228)][_0x464dda(0x1cd)],{handleFileUpload:_0x457e02}=_0x3dda55[_0x464dda(0x1d1)](getStrategyFunctions,_0x57c281),{file_id:_0x7cab27,temp_file_id:_0x5dac22}=_0x21c3e4,{bytes:_0x17b0ae,filename:_0x137cb9,filepath:_0x3aa9d1,embedded:_0x38dd0c,height:_0x5b5316,width:_0x412e85}=await _0x457e02({'req':_0x5f1f67,'file':_0x4c9dd6,'file_id':_0x7cab27});let _0x20fa35=_0x3aa9d1;_0x3dda55['QTQuC'](!_0x48721e,_0x48ddcb)&&await addAgentResourceFile({'req':_0x5f1f67,'file_id':_0x7cab27,'agent_id':_0x4aa9c0,'tool_resource':_0x48ddcb});if(_0x4c9dd6[_0x464dda(0x22f)][_0x464dda(0x27a)](_0x3dda55[_0x464dda(0x25f)])){if(_0x3dda55[_0x464dda(0x1de)](_0x3dda55[_0x464dda(0x222)],_0x464dda(0x1f2)))throw new _0x2d72ec(_0x464dda(0x1e1));else{const _0x5abf5f=await processImageFile({'req':_0x5f1f67,'file':_0x4c9dd6,'metadata':{'file_id':v4()},'returnFile':!![]});_0x20fa35=_0x5abf5f[_0x464dda(0x22d)];}}const _0x511b81=_0x3dda55[_0x464dda(0x1d1)](removeNullishValues,{'user':_0x5f1f67[_0x464dda(0x216)]['id'],'file_id':_0x7cab27,'temp_file_id':_0x5dac22,'bytes':_0x17b0ae,'filepath':_0x20fa35,'filename':_0x137cb9??_0x4c9dd6['originalname'],'context':_0x48721e?FileContext[_0x464dda(0x241)]:FileContext['agents'],'model':_0x48721e?undefined:_0x5f1f67[_0x464dda(0x1f5)][_0x464dda(0x25a)],'metadata':_0x2ce23e,'type':_0x4c9dd6['mimetype'],'embedded':_0x38dd0c,'source':_0x57c281,'height':_0x5b5316,'width':_0x412e85}),_0x396982=await createFile(_0x511b81,!![]);_0x93b926[_0x464dda(0x279)](0xc8)[_0x464dda(0x22b)]({'message':'Agent\x20file\x20uploaded\x20and\x20processed\x20successfully',..._0x396982});},processOpenAIFile=async({openai:_0x24335d,file_id:_0x2aba89,userId:_0x3890fe,filename:_0x947f6f,saveFile:saveFile=![],updateUsage:updateUsage=![]})=>{const _0x2a18c7=_0x2e7538,_0x484bb9={'qCFrA':function(_0x4bd2dd,_0x1d70b0){return _0x4bd2dd??_0x1d70b0;},'hmnef':_0x2a18c7(0x235),'QTgea':_0x2a18c7(0x1f0)},_0x4103f5=await _0x24335d['files'][_0x2a18c7(0x256)](_0x2aba89),_0x36c221=_0x947f6f??(_0x4103f5[_0x2a18c7(0x261)]?path[_0x2a18c7(0x213)](_0x4103f5[_0x2a18c7(0x261)]):undefined),_0x1dfb7e=_0x24335d['baseURL']+_0x2a18c7(0x269)+_0x3890fe+'/'+_0x2aba89+(_0x36c221?'/'+_0x36c221:''),_0x354941=mime[_0x2a18c7(0x218)](_0x36c221??_0x2aba89),_0x2ad60d=_0x24335d[_0x2a18c7(0x254)][_0x2a18c7(0x1f5)][_0x2a18c7(0x258)]===EModelEndpoint['azureAssistants']?FileSources[_0x2a18c7(0x1ff)]:FileSources['openai'],_0x4bda0d={..._0x4103f5,'type':_0x354941,'file_id':_0x2aba89,'filepath':_0x1dfb7e,'usage':0x1,'user':_0x3890fe,'context':_0x4103f5[_0x2a18c7(0x212)],'source':_0x2ad60d,'model':_0x24335d[_0x2a18c7(0x254)][_0x2a18c7(0x1f5)][_0x2a18c7(0x25a)],'filename':_0x484bb9[_0x2a18c7(0x1e8)](_0x36c221,_0x2aba89)};if(saveFile){if(_0x484bb9[_0x2a18c7(0x22e)]!==_0x484bb9[_0x2a18c7(0x22e)])return null;else await createFile(_0x4bda0d,!![]);}else{if(updateUsage)try{await updateFileUsage({'file_id':_0x2aba89});}catch(_0x1ee9e2){logger[_0x2a18c7(0x1d9)](_0x484bb9['QTgea'],_0x1ee9e2);}}return _0x4bda0d;},processOpenAIImageOutput=async({req:_0x517c5a,buffer:_0x54dc35,file_id:_0x1fc5e6,filename:_0x182f38,fileExt:_0x1289c8})=>{const _0x52999e=_0x2e7538,_0x1e455b={'oSvFg':function(_0x3353ba,_0x32e05a,_0x32ba9c){return _0x3353ba(_0x32e05a,_0x32ba9c);},'KRNbP':function(_0xa8eb78,_0x497ec9){return _0xa8eb78===_0x497ec9;}},_0x54ba39=new Date(),_0x176294=_0x54ba39[_0x52999e(0x1d6)](),_0x53e00d=await convertImage(_0x517c5a,_0x54dc35,_0x52999e(0x20b),''+_0x1fc5e6+_0x1289c8),_0x582e89={..._0x53e00d,'usage':0x1,'user':_0x517c5a[_0x52999e(0x216)]['id'],'type':'image/'+_0x517c5a['app'][_0x52999e(0x228)][_0x52999e(0x26f)],'createdAt':_0x176294,'updatedAt':_0x176294,'source':_0x517c5a[_0x52999e(0x20c)]['locals'][_0x52999e(0x1cd)],'context':FileContext[_0x52999e(0x23e)],'file_id':''+_0x1fc5e6+hostImageIdSuffix,'filename':''+hostImageNamePrefix+_0x182f38};_0x1e455b[_0x52999e(0x1e3)](createFile,_0x582e89,!![]);const _0x5620f3=_0x1e455b['KRNbP'](_0x517c5a[_0x52999e(0x1f5)][_0x52999e(0x258)],EModelEndpoint[_0x52999e(0x1cf)])?FileSources[_0x52999e(0x1ff)]:FileSources['openai'];return createFile({..._0x582e89,'file_id':_0x1fc5e6,'filename':_0x182f38,'source':_0x5620f3,'type':mime[_0x52999e(0x218)](_0x1289c8)},!![]),_0x582e89;};function _0x5dfd(){const _0x47eb79=['~/server/controllers/assistants/helpers','File\x20size\x20limit\x20of\x20','QTGKI','aTanO','fXFhq','push','aAIwJ','extname','locals','~/server/services/Files/images','catch','json','GKKfG','filepath','hmnef','mimetype','test','nfHNU','then','zBPcO','Error\x20while\x20processing\x20the\x20image\x20with\x20','DsmNe','\x20endpoint','allSettled','2ULDTIf','TdKfh','~/server/utils/queue','~/models/File','del','XSqmh','assistants_output','sBdZs','height','message_attachment','local','dpvDc','azureOpenAI','No\x20file_id\x20provided','debug','~/app/clients/tools/util','16377120dTrVCX','nbMNS','ANACL','create','lTaVu','metEe','qPWoD','files','File\x20uploaded\x20and\x20processed\x20successfully','JcukO','nFbEt','yodcZ','req','image','retrieve','ZtVpx','endpoint','assistants','model','content','ywomv','WrTAC','uuid','PTmfv','bRiPA','filename','QTQuC','agent_id','file_search','McKPq','6wOymtF','processedFileIds','avatar\x20upload','/files/','message_file','Unsupported\x20file\x20type','VeNMF','RTHaK','1329535sRIYsT','imageOutputType','source','hrigM','QpNNx','ZUTKp','beta','\x20MB\x20exceeded\x20for\x20','size','~/config','sAfxl','status','startsWith','file_id','kfxTK','4236800TNhnAQ','fileStrategy','TcpxG','azureAssistants','otyHS','TodDf','sjqan','366316rYuHYq','TsoiI','yGtLJ','toISOString','message','image/','error','[retrieveAndProcessFile]\x20Non-image\x20file\x20type\x20detected:\x20','openai','PSHcT','path','tlmyR','width','file','Empty\x20file\x20uploaded','IbXIo','oSvFg','default','all','XHzGr','YYZhh','qCFrA','fileConfig','XBXZb','avatarSizeLimit','tool_resource','CxEaB','CODE_API_KEY','No\x20agent\x20ID\x20provided\x20for\x20agent\x20file\x20upload','Error\x20updating\x20file\x20usage','mUfQs','mROgL','uDoOX','cdvVS','body','No\x20width\x20provided','aYqSR','exports','mime','@librechat/agents','539895wUaMWg','LPPNs','3544653XJKpTr','has','azure','VeaoS','Error\x20deleting\x20file\x20from\x20OpenAI\x20source','createReadStream','Nzmcy','assistant_id','No\x20endpoint\x20provided','librechat-data-provider','from','cLwmt','endpoints','vectordb','high','app','originalname','sbEcU','~/server/utils','Delete\x20function\x20not\x20implemented\x20for\x20','OqELh','purpose','basename','epSNQ','parse','user','EZqzC','getType','Error\x20downloading\x20file\x20from\x20OpenAI:','bTjhZ','~/models/Agent','XNFsP','WsPyk','Failed\x20to\x20process\x20the\x20image\x20with\x20','4766783ajAkfF'];_0x5dfd=function(){return _0x47eb79;};return _0x5dfd();}async function retrieveAndProcessFile({openai:_0x1914d0,client:_0x340fa5,file_id:_0xe4933,basename:_0x1d21d5,unknownType:_0x47a1f8}){const _0x5e89ea=_0x2e7538,_0x216de7={'LPPNs':_0x5e89ea(0x1f0),'dpvDc':_0x5e89ea(0x268),'nFbEt':function(_0x3a655b,_0x67d5a){return _0x3a655b(_0x67d5a);},'uCRtW':function(_0x13c047,_0x5da277){return _0x13c047!==_0x5da277;},'ZtVpx':_0x5e89ea(0x25d),'VeaoS':_0x5e89ea(0x272),'nbMNS':function(_0x11bc6c,_0x136261){return _0x11bc6c(_0x136261);},'ywomv':function(_0x4830be,_0x53b183){return _0x4830be===_0x53b183;},'VeNMF':_0x5e89ea(0x1ea),'yodcZ':function(_0x42107f,_0x4c7db6){return _0x42107f+_0x4c7db6;},'ANACL':function(_0x4c5868,_0x542c8e){return _0x4c5868(_0x542c8e);},'RUbxl':function(_0x303125,_0x5669a6){return _0x303125===_0x5669a6;},'XHzGr':_0x5e89ea(0x1f1)};if(!_0xe4933)return null;let _0x33a937=_0x1d21d5;const _0x47b332={'openai':_0x1914d0,'file_id':_0xe4933,'filename':_0x33a937,'userId':_0x340fa5['req']['user']['id']};if(!_0x33a937)return await _0x216de7[_0x5e89ea(0x252)](processOpenAIFile,{..._0x47b332,'saveFile':!![]});const _0x152e02=path['extname'](_0x33a937);if(_0x340fa5['attachedFileIds']?.[_0x5e89ea(0x1fe)](_0xe4933)||_0x340fa5[_0x5e89ea(0x267)]?.[_0x5e89ea(0x1fe)](_0xe4933)){if(_0x216de7['uCRtW'](_0x216de7[_0x5e89ea(0x257)],_0x216de7[_0x5e89ea(0x200)]))return _0x216de7[_0x5e89ea(0x249)](processOpenAIFile,{..._0x47b332,'updateUsage':!![]});else return;}const _0x235379=async()=>{const _0x2d16dd=_0x5e89ea;if(_0x2d16dd(0x1ed)!=='CxEaB')_0x4321ea?(_0x4bcef5[_0x2d16dd(0x1d9)](_0x2d16dd(0x201),_0x289b54),_0x5902ed(_0x162c11)):(_0x10accb[_0x2d16dd(0x225)](_0x169b27[_0x2d16dd(0x1ca)]),_0x554f94(_0x5773e5));else{const _0x24e6d8=await _0x1914d0[_0x2d16dd(0x24f)][_0x2d16dd(0x25b)](_0xe4933),_0x28bebc=await _0x24e6d8['arrayBuffer']();return Buffer[_0x2d16dd(0x207)](_0x28bebc);}};let _0xa538cd;if(_0x47a1f8||!_0x152e02||imageExtRegex[_0x5e89ea(0x230)](_0x33a937))try{_0xa538cd=await _0x235379();}catch(_0x5d3aed){_0x216de7[_0x5e89ea(0x25c)](_0x216de7[_0x5e89ea(0x26c)],_0x5e89ea(0x1ea))?(logger[_0x5e89ea(0x1d9)](_0x5e89ea(0x219),_0x5d3aed),_0xa538cd=null):_0x55035d[_0x5e89ea(0x1d9)](_0x216de7[_0x5e89ea(0x1fc)],_0xe44175);}if(!_0xa538cd)return await processOpenAIFile({..._0x47b332,'saveFile':!![]});if(_0xa538cd&&(_0x47a1f8||!_0x152e02)){const _0x2f6ad5=await determineFileType(_0xa538cd),_0x9f3205=_0x2f6ad5&&imageExtRegex[_0x5e89ea(0x230)](_0x216de7[_0x5e89ea(0x253)]('.',_0x2f6ad5));if(!_0x9f3205)return await _0x216de7[_0x5e89ea(0x24a)](processOpenAIFile,{..._0x47b332,'saveFile':!![]});return await _0x216de7[_0x5e89ea(0x24a)](processOpenAIImageOutput,{'file_id':_0xe4933,'req':_0x340fa5['req'],'buffer':_0xa538cd,'filename':_0x33a937,'fileExt':_0x2f6ad5});}else{if(_0xa538cd&&imageExtRegex[_0x5e89ea(0x230)](_0x33a937)){if(_0x216de7['RUbxl'](_0x216de7[_0x5e89ea(0x1e6)],_0x216de7[_0x5e89ea(0x1e6)]))return await processOpenAIImageOutput({'file_id':_0xe4933,'req':_0x340fa5[_0x5e89ea(0x254)],'buffer':_0xa538cd,'filename':_0x33a937,'fileExt':_0x152e02});else throw new _0x3a6826(_0x5e89ea(0x221)+_0x1686c7/_0x2ad68a+'\x20MB\x20exceeded\x20for\x20'+(_0x540d3c?_0x216de7[_0x5e89ea(0x243)]:_0x117183+_0x5e89ea(0x236)));}else return logger[_0x5e89ea(0x246)](_0x5e89ea(0x1da)+_0x33a937),await processOpenAIFile({..._0x47b332,'saveFile':!![]});}}function filterFile({req:_0x2f7d71,file:_0x8f23ad,image:_0x3d920b,isAvatar:_0xed0db5}){const _0x2eac69=_0x2e7538,_0x190634={'fXFhq':function(_0x460fdb,_0x27e7fa){return _0x460fdb(_0x27e7fa);},'OqELh':function(_0x1fe8fd,_0x496719){return _0x1fe8fd===_0x496719;},'pSaHv':function(_0x270286,_0x4a2dcb){return _0x270286&&_0x4a2dcb;},'GKKfG':function(_0x2a5fa4,_0x5849db){return _0x2a5fa4(_0x5849db);},'metEe':_0x2eac69(0x268)},{endpoint:_0x1f55df,file_id:_0x936a72,width:_0x4e69d4,height:_0x1ce02a}=_0x2f7d71[_0x2eac69(0x1f5)];if(!_0x936a72&&!_0xed0db5)throw new Error(_0x2eac69(0x245));if(_0x190634[_0x2eac69(0x211)](_0x8f23ad[_0x2eac69(0x276)],0x0))throw new Error(_0x2eac69(0x1e1));if(!_0xed0db5){if(_0x2eac69(0x23f)!==_0x2eac69(0x214))isUUID[_0x2eac69(0x215)](_0x936a72);else{const {file_id:_0x9cec83}=_0x384791;_0x561631[_0x2eac69(0x225)](_0x190634[_0x2eac69(0x224)](_0xba3b36,{'file_id':_0x9cec83}));}}if(_0x190634['pSaHv'](!_0x1f55df,!_0xed0db5))throw new Error(_0x2eac69(0x205));const _0x47a528=_0x190634[_0x2eac69(0x22c)](mergeFileConfig,_0x2f7d71[_0x2eac69(0x20c)][_0x2eac69(0x228)][_0x2eac69(0x1e9)]),{fileSizeLimit:_0x33e292,supportedMimeTypes:_0x521e44}=_0x47a528['endpoints'][_0x1f55df]??_0x47a528[_0x2eac69(0x209)][_0x2eac69(0x1e4)],_0x2f9b27=_0xed0db5===!![]?_0x47a528[_0x2eac69(0x1eb)]:_0x33e292;if(_0x8f23ad[_0x2eac69(0x276)]>_0x2f9b27)throw new Error(_0x2eac69(0x221)+_0x2f9b27/megabyte+_0x2eac69(0x275)+(_0xed0db5?_0x190634[_0x2eac69(0x24d)]:_0x1f55df+_0x2eac69(0x236)));const _0x116400=_0x47a528['checkType'](_0x8f23ad[_0x2eac69(0x22f)],_0x521e44);if(!_0x116400)throw new Error(_0x2eac69(0x26b));if(!_0x3d920b||_0xed0db5===!![])return;if(!_0x4e69d4)throw new Error(_0x2eac69(0x1f6));if(!_0x1ce02a)throw new Error('No\x20height\x20provided');}module[_0x2e7538(0x1f8)]={'filterFile':filterFile,'processFiles':processFiles,'processFileURL':processFileURL,'processImageFile':processImageFile,'uploadImageBuffer':uploadImageBuffer,'processFileUpload':processFileUpload,'processDeleteRequest':processDeleteRequest,'processAgentFileUpload':processAgentFileUpload,'retrieveAndProcessFile':retrieveAndProcessFile};