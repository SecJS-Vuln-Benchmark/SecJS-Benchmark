const _0x2c0f9e=_0x3c76;(function(_0x459ec0,_0x4e85f5){const _0x326e57=_0x3c76,_0x43f9bd=_0x459ec0();while(!![]){try{const _0x50eca3=-parseInt(_0x326e57(0x164))/0x1+parseInt(_0x326e57(0xec))/0x2*(parseInt(_0x326e57(0x102))/0x3)+-parseInt(_0x326e57(0x14c))/0x4+parseInt(_0x326e57(0x101))/0x5+parseInt(_0x326e57(0x13f))/0x6+parseInt(_0x326e57(0x134))/0x7+-parseInt(_0x326e57(0x140))/0x8*(parseInt(_0x326e57(0x136))/0x9);if(_0x50eca3===_0x4e85f5)break;else _0x43f9bd['push'](_0x43f9bd['shift']());}catch(_0x5cbbf2){_0x43f9bd['push'](_0x43f9bd['shift']());}}}(_0x4869,0xc2f78));const fs=require('fs')[_0x2c0f9e(0x137)],express=require(_0x2c0f9e(0x167)),{EnvVar}=require('@librechat/agents'),{isUUID,FileSources,EModelEndpoint,isAgentsEndpoint,checkOpenAIStorage}=require(_0x2c0f9e(0xf2)),{filterFile,processFileUpload,processDeleteRequest,processAgentFileUpload}=require(_0x2c0f9e(0x158)),{getStrategyFunctions}=require('~/server/services/Files/strategies'),{getOpenAIClient}=require(_0x2c0f9e(0x12c)),{loadAuthValues}=require(_0x2c0f9e(0x15f)),{getAgent}=require('~/models/Agent'),{getFiles}=require('~/models/File'),{logger}=require(_0x2c0f9e(0x14a)),router=express['Router']();function _0x3c76(_0x3dcc16,_0x326c42){const _0x486952=_0x4869();return _0x3c76=function(_0x3c76bd,_0x5ccf3b){_0x3c76bd=_0x3c76bd-0xe3;let _0x24258d=_0x486952[_0x3c76bd];return _0x24258d;},_0x3c76(_0x3dcc16,_0x326c42);}router[_0x2c0f9e(0x111)]('/',async(_0x3983c0,_0x14a87f)=>{const _0x678b10=_0x2c0f9e,_0x53df6b={'MxcsG':_0x678b10(0x160)};try{const _0x3d6777=await getFiles({'user':_0x3983c0[_0x678b10(0x139)]['id']});_0x14a87f[_0x678b10(0xff)](0xc8)[_0x678b10(0x15c)](_0x3d6777);}catch(_0x4899f6){logger[_0x678b10(0x133)](_0x678b10(0x10a),_0x4899f6),_0x14a87f[_0x678b10(0xff)](0x190)[_0x678b10(0x13e)]({'message':_0x53df6b[_0x678b10(0x109)],'error':_0x4899f6[_0x678b10(0x106)]});}}),router[_0x2c0f9e(0x111)](_0x2c0f9e(0x108),async(_0x3b9bae,_0x4b8665)=>{const _0x545dbb=_0x2c0f9e,_0x4cd207={'NpRfD':function(_0x1c3b26,_0x36a3f6){return _0x1c3b26!==_0x36a3f6;},'AUHnJ':_0x545dbb(0x11d),'tsYyu':'Error\x20in\x20request'};try{_0x4b8665[_0x545dbb(0xff)](0xc8)[_0x545dbb(0x13e)](_0x3b9bae[_0x545dbb(0x143)][_0x545dbb(0xe6)][_0x545dbb(0xed)]);}catch(_0x2dd6f9){_0x4cd207[_0x545dbb(0x14e)](_0x545dbb(0x113),_0x4cd207[_0x545dbb(0x129)])?(logger[_0x545dbb(0x133)](_0x545dbb(0x12e),_0x2dd6f9),_0x4b8665['status'](0x190)[_0x545dbb(0x13e)]({'message':_0x4cd207[_0x545dbb(0x15d)],'error':_0x2dd6f9[_0x545dbb(0x106)]})):(_0x2109b4[_0x545dbb(0x133)](_0x545dbb(0xee),_0x55caa2),_0x45a333[_0x545dbb(0xff)](0x190)[_0x545dbb(0x13e)]({'message':'Error\x20in\x20request','error':_0xfdef3f[_0x545dbb(0x106)]}));}}),router[_0x2c0f9e(0x163)]('/',async(_0xb5bcd0,_0x1f4f83)=>{const _0xbc4612=_0x2c0f9e,_0x4741b4={'hLTCt':_0xbc4612(0x166),'OkYzG':function(_0x391694,_0x3d0a62){return _0x391694===_0x3d0a62;},'elfyj':function(_0x2592d7,_0x4ce174){return _0x2592d7===_0x4ce174;},'GgOXX':_0xbc4612(0x149),'bRLWZ':function(_0x2330d5,_0x361faf){return _0x2330d5===_0x361faf;},'CkVAL':_0xbc4612(0x161),'RpHuj':function(_0x5b6ded,_0x66e9f9){return _0x5b6ded(_0x66e9f9);},'eCPsd':_0xbc4612(0x160)};try{if(_0x4741b4['hLTCt']!==_0x4741b4[_0xbc4612(0x15a)])_0x43fc7d['error'](_0xbc4612(0x10f),_0x2a09de);else{const {files:_0x5aa03e}=_0xb5bcd0[_0xbc4612(0x130)],_0x5c7d6d=_0x5aa03e[_0xbc4612(0xfd)](_0x1231c2=>{const _0x68c2ca=_0xbc4612;if(!_0x1231c2[_0x68c2ca(0x12a)])return![];if(!_0x1231c2['filepath'])return![];if(/^(file|assistant)-/[_0x68c2ca(0xf5)](_0x1231c2[_0x68c2ca(0x12a)]))return!![];return isUUID[_0x68c2ca(0xe7)](_0x1231c2[_0x68c2ca(0x12a)])[_0x68c2ca(0xf1)];});if(_0x4741b4[_0xbc4612(0xe9)](_0x5c7d6d['length'],0x0)){_0x1f4f83[_0xbc4612(0xff)](0xcc)[_0xbc4612(0x13e)]({'message':'Nothing\x20provided\x20to\x20delete'});return;}const _0x3aeb5e=_0x5c7d6d[_0xbc4612(0xfa)](_0x36b44b=>_0x36b44b[_0xbc4612(0x12a)]),_0x59848d=await getFiles({'file_id':{'$in':_0x3aeb5e}}),_0xcc1e2e=_0x59848d[_0xbc4612(0xfd)](_0x34a04b=>_0x34a04b[_0xbc4612(0x139)][_0xbc4612(0x148)]()!==_0xb5bcd0['user']['id']);if(_0xcc1e2e['length']>0x0)return _0x4741b4['elfyj'](_0x4741b4[_0xbc4612(0x10b)],_0x4741b4[_0xbc4612(0x10b)])?_0x1f4f83[_0xbc4612(0xff)](0x193)[_0xbc4612(0x13e)]({'message':_0xbc4612(0x157),'unauthorizedFiles':_0xcc1e2e['map'](_0x2acd05=>_0x2acd05[_0xbc4612(0x12a)])}):![];if(_0xb5bcd0[_0xbc4612(0x130)][_0xbc4612(0xfc)]&&_0xb5bcd0[_0xbc4612(0x130)][_0xbc4612(0x132)]&&_0x4741b4['bRLWZ'](_0x59848d['length'],0x0)){const _0x2930ec=await getAgent({'id':_0xb5bcd0[_0xbc4612(0x130)][_0xbc4612(0xfc)]}),_0xb79719=_0x2930ec[_0xbc4612(0x165)]?.[_0xb5bcd0['body'][_0xbc4612(0x132)]]?.[_0xbc4612(0x125)]??[],_0x4bf9d2=_0x5c7d6d[_0xbc4612(0xfd)](_0x1df525=>_0xb79719[_0xbc4612(0x11b)](_0x1df525[_0xbc4612(0x12a)]));await processDeleteRequest({'req':_0xb5bcd0,'files':_0x4bf9d2}),_0x1f4f83[_0xbc4612(0xff)](0xc8)[_0xbc4612(0x13e)]({'message':_0x4741b4[_0xbc4612(0x13b)]});return;}await _0x4741b4[_0xbc4612(0x11a)](processDeleteRequest,{'req':_0xb5bcd0,'files':_0x59848d}),logger['debug'](_0xbc4612(0x146)+_0x5c7d6d[_0xbc4612(0xfd)](_0x164b35=>_0x164b35[_0xbc4612(0x12a)])[_0xbc4612(0xfa)](_0x3a62fe=>_0x3a62fe[_0xbc4612(0x12a)])[_0xbc4612(0x135)](',\x20')),_0x1f4f83['status'](0xc8)[_0xbc4612(0x13e)]({'message':_0xbc4612(0x162)});}}catch(_0x230d78){logger[_0xbc4612(0x133)](_0xbc4612(0xee),_0x230d78),_0x1f4f83['status'](0x190)[_0xbc4612(0x13e)]({'message':_0x4741b4[_0xbc4612(0x138)],'error':_0x230d78[_0xbc4612(0x106)]});}}),router[_0x2c0f9e(0x111)](_0x2c0f9e(0x13d),async(_0xa33543,_0x30d557)=>{const _0x20756d=_0x2c0f9e,_0x1f0b03={'cmLPd':_0x20756d(0x11c),'kSgfN':function(_0x53dbda,_0x394e36){return _0x53dbda(_0x394e36);},'ZhUpB':_0x20756d(0x118),'GIkOf':_0x20756d(0x145)};try{const {session_id:_0x38b0a4,fileId:_0x211b5e}=_0xa33543['params'],_0x2f8453=_0x20756d(0xef)+_0x38b0a4+_0x20756d(0xe3)+_0x211b5e+'\x20|\x20Code\x20output\x20download\x20requested\x20by\x20user\x20';logger['debug'](_0x2f8453);if(!_0x38b0a4||!_0x211b5e)return _0x30d557['status'](0x190)['send'](_0x20756d(0x154));const {getDownloadStream:_0x4917ba}=getStrategyFunctions(FileSources[_0x20756d(0x12d)]);if(!_0x4917ba)return logger[_0x20756d(0x116)](_0x2f8453+_0x20756d(0x123)+FileSources[_0x20756d(0x12d)]+_0x20756d(0x171)),_0x30d557[_0x20756d(0xff)](0x1f5)[_0x20756d(0x15c)](_0x1f0b03[_0x20756d(0xe4)]);const _0x2b35a7=await _0x1f0b03[_0x20756d(0x128)](loadAuthValues,{'userId':_0xa33543['user']['id'],'authFields':[EnvVar['CODE_API_KEY']]}),_0xf40b54=await _0x4917ba(_0x38b0a4+'/'+_0x211b5e,_0x2b35a7[EnvVar[_0x20756d(0xf8)]]);_0x30d557[_0x20756d(0x155)](_0xf40b54[_0x20756d(0x147)]),_0xf40b54[_0x20756d(0x159)][_0x20756d(0x16d)](_0x30d557);}catch(_0x28b2dd){if(_0x1f0b03[_0x20756d(0xf6)]===_0x20756d(0x118))logger['error'](_0x20756d(0x142),_0x28b2dd),_0x30d557[_0x20756d(0xff)](0x1f4)[_0x20756d(0x15c)](_0x1f0b03[_0x20756d(0x104)]);else return _0xf6bb32['warn'](_0x4ed3d1+'\x20forbidden:\x20'+_0x32e9ae),_0x81cc6f[_0x20756d(0xff)](0x193)[_0x20756d(0x15c)]('Forbidden');}}),router[_0x2c0f9e(0x111)](_0x2c0f9e(0x127),async(_0x2898e0,_0x4fcb9b)=>{const _0x537c55=_0x2c0f9e,_0x1575bd={'KSJDc':_0x537c55(0x12e),'EjFed':function(_0x1638ea,_0x3dba70){return _0x1638ea!==_0x3dba70;},'cTccL':'Content-Disposition','mFnDM':_0x537c55(0xfb),'lyBrP':_0x537c55(0x16c),'tRwDb':'File\x20not\x20found','FILGm':_0x537c55(0x131),'svYCR':_0x537c55(0x15e),'FgSXY':_0x537c55(0x126),'TVoEi':function(_0xfb5b8,_0x368de9){return _0xfb5b8(_0x368de9);},'OaIhw':function(_0x37ad16){return _0x37ad16();},'OPVTS':'Error\x20downloading\x20file:','QULRU':_0x537c55(0x145)};try{const {userId:_0x2e77f8,file_id:_0x11991e}=_0x2898e0[_0x537c55(0xf3)];logger[_0x537c55(0x10c)](_0x537c55(0x110)+_0x2e77f8+':\x20'+_0x11991e);if(_0x2e77f8!==_0x2898e0[_0x537c55(0x139)]['id'])return logger['warn'](_0x337642+'\x20forbidden:\x20'+_0x11991e),_0x4fcb9b[_0x537c55(0xff)](0x193)['send'](_0x537c55(0x131));const [_0x917883]=await getFiles({'file_id':_0x11991e}),_0x337642=_0x537c55(0x110)+_0x2e77f8;if(!_0x917883)return logger[_0x537c55(0x116)](_0x337642+_0x537c55(0x120)+_0x11991e),_0x4fcb9b['status'](0x194)['send'](_0x1575bd[_0x537c55(0xe5)]);if(!_0x917883[_0x537c55(0x14b)][_0x537c55(0x11b)](_0x2e77f8))return logger[_0x537c55(0x116)](_0x337642+_0x537c55(0xe8)+_0x11991e),_0x4fcb9b['status'](0x193)[_0x537c55(0x15c)](_0x1575bd[_0x537c55(0x172)]);if(checkOpenAIStorage(_0x917883['source'])&&!_0x917883['model'])return logger[_0x537c55(0x116)](_0x337642+_0x537c55(0x124)+_0x11991e),_0x4fcb9b[_0x537c55(0xff)](0x190)[_0x537c55(0x15c)](_0x537c55(0x151));const {getDownloadStream:_0x479d9c}=getStrategyFunctions(_0x917883['source']);if(!_0x479d9c){if(_0x1575bd[_0x537c55(0xf7)](_0x1575bd[_0x537c55(0x112)],_0x1575bd[_0x537c55(0x156)]))return logger[_0x537c55(0x116)](_0x337642+_0x537c55(0x119)+_0x917883[_0x537c55(0x11e)]),_0x4fcb9b['status'](0x1f5)[_0x537c55(0x15c)]('Not\x20Implemented');else try{_0x46881f[_0x537c55(0xff)](0xc8)[_0x537c55(0x13e)](_0x1e56de[_0x537c55(0x143)][_0x537c55(0xe6)][_0x537c55(0xed)]);}catch(_0x118d9e){_0x1fe8bb[_0x537c55(0x133)](_0x1575bd[_0x537c55(0x16b)],_0x118d9e),_0x436e4d[_0x537c55(0xff)](0x190)[_0x537c55(0x13e)]({'message':_0x537c55(0x160),'error':_0x118d9e[_0x537c55(0x106)]});}}const _0x1c732f=()=>{const _0x16a536=_0x537c55;if(_0x1575bd['EjFed'](_0x16a536(0x16f),_0x16a536(0x14f)))_0x4fcb9b[_0x16a536(0x10d)](_0x1575bd[_0x16a536(0x117)],_0x16a536(0x121)+_0x917883[_0x16a536(0x168)]+'\x22'),_0x4fcb9b[_0x16a536(0x10d)](_0x1575bd[_0x16a536(0x169)],'application/octet-stream'),_0x4fcb9b[_0x16a536(0x10d)](_0x1575bd['lyBrP'],JSON[_0x16a536(0xf4)](_0x917883));else{if(!_0x38511b[_0x16a536(0x12a)])return![];if(!_0x2b8cf9[_0x16a536(0x14b)])return![];if(/^(file|assistant)-/[_0x16a536(0xf5)](_0x3399bd[_0x16a536(0x12a)]))return!![];return _0x4afb37[_0x16a536(0xe7)](_0x16437b[_0x16a536(0x12a)])[_0x16a536(0xf1)];}};let _0x473939,_0x4f5a63;if(checkOpenAIStorage(_0x917883['source'])){_0x2898e0[_0x537c55(0x130)]={'model':_0x917883[_0x537c55(0x15b)]};const _0x2701d5={[FileSources[_0x537c55(0x103)]]:EModelEndpoint['assistants'],[FileSources[_0x537c55(0x107)]]:EModelEndpoint[_0x537c55(0xf9)]},{openai:_0x591a97}=await _0x1575bd[_0x537c55(0x14d)](getOpenAIClient,{'req':_0x2898e0,'res':_0x4fcb9b,'overrideEndpoint':_0x2701d5[_0x917883[_0x537c55(0x11e)]]});logger['debug'](_0x537c55(0x12f)+_0x11991e+_0x537c55(0x150)),_0x473939=await _0x479d9c(_0x11991e,_0x591a97),_0x1575bd[_0x537c55(0x10e)](_0x1c732f),logger[_0x537c55(0x10c)](_0x537c55(0x100)+_0x11991e+_0x537c55(0x16a)),_0x473939['body'][_0x537c55(0x16d)](_0x4fcb9b);}else _0x4f5a63=_0x479d9c(_0x11991e),_0x1c732f(),_0x4f5a63['pipe'](_0x4fcb9b);}catch(_0x1f23de){logger['error'](_0x1575bd[_0x537c55(0x115)],_0x1f23de),_0x4fcb9b['status'](0x1f4)[_0x537c55(0x15c)](_0x1575bd[_0x537c55(0xea)]);}}),router[_0x2c0f9e(0x144)]('/',async(_0x5781d6,_0x2259dd)=>{const _0x431b64=_0x2c0f9e,_0xa15cec={'BLmNT':_0x431b64(0x152),'ckozI':_0x431b64(0xfb),'kBbIl':_0x431b64(0x12b),'HtmdZ':'X-File-Metadata','YeMlF':function(_0x4846f3,_0x5b301e){return _0x4846f3(_0x5b301e);},'pcGNJ':function(_0x347901,_0x58bf57){return _0x347901(_0x58bf57);},'YyPMe':function(_0x5f5bc1,_0xba65dd){return _0x5f5bc1(_0xba65dd);},'MzJFZ':'[/files]\x20Error\x20processing\x20file:','ZDRkV':_0x431b64(0x125),'JlGtA':function(_0x461574,_0x39ed6c){return _0x461574+_0x39ed6c;}},_0x512a1e=_0x5781d6[_0x431b64(0x141)],_0x4968ad=_0x5781d6[_0x431b64(0x130)];let _0x3fe6c8=!![];try{_0xa15cec[_0x431b64(0x16e)](filterFile,{'req':_0x5781d6,'file':_0x512a1e}),_0x4968ad['temp_file_id']=_0x4968ad[_0x431b64(0x12a)],_0x4968ad[_0x431b64(0x12a)]=_0x5781d6[_0x431b64(0x12a)];if(_0xa15cec[_0x431b64(0xf0)](isAgentsEndpoint,_0x4968ad['endpoint']))return await _0xa15cec[_0x431b64(0x13a)](processAgentFileUpload,{'req':_0x5781d6,'res':_0x2259dd,'file':_0x512a1e,'metadata':_0x4968ad});await _0xa15cec[_0x431b64(0x13a)](processFileUpload,{'req':_0x5781d6,'res':_0x2259dd,'file':_0x512a1e,'metadata':_0x4968ad});}catch(_0x4ce2a9){let _0x4603c3='Error\x20processing\x20file';logger[_0x431b64(0x133)](_0xa15cec[_0x431b64(0xeb)],_0x4ce2a9);_0x4ce2a9[_0x431b64(0x106)]?.[_0x431b64(0x11b)](_0xa15cec[_0x431b64(0xfe)])&&(_0x4603c3+=_0xa15cec[_0x431b64(0x122)](':\x20',_0x4ce2a9[_0x431b64(0x106)]));try{await fs[_0x431b64(0x153)](_0x512a1e[_0x431b64(0x170)]),_0x3fe6c8=![];}catch(_0x3b21b2){logger[_0x431b64(0x133)](_0x431b64(0x13c),_0x3b21b2);}_0x2259dd['status'](0x1f4)[_0x431b64(0x13e)]({'message':_0x4603c3});}if(_0x3fe6c8){if('NGoWr'!==_0x431b64(0x114))try{await fs[_0x431b64(0x153)](_0x512a1e[_0x431b64(0x170)]);}catch(_0x235315){logger[_0x431b64(0x133)](_0x431b64(0x10f),_0x235315);}else _0x5d0eb1[_0x431b64(0x10d)](_0xa15cec[_0x431b64(0x105)],_0x431b64(0x121)+_0x3f4b62[_0x431b64(0x168)]+'\x22'),_0x1def00[_0x431b64(0x10d)](_0xa15cec['ckozI'],_0xa15cec[_0x431b64(0x11f)]),_0x1a4913[_0x431b64(0x10d)](_0xa15cec['HtmdZ'],_0x260a3f['stringify'](_0x4ca901));}}),module['exports']=router;function _0x4869(){const _0x425151=['JlGtA','\x20has\x20no\x20stream\x20method\x20implemented\x20for\x20','\x20has\x20no\x20associated\x20model:\x20','file_ids','sVfyo','/download/:userId/:file_id','kSgfN','AUHnJ','file_id','application/octet-stream','~/server/controllers/assistants/helpers','execute_code','[/files]\x20Error\x20getting\x20fileConfig','Downloading\x20file\x20','body','Forbidden','tool_resource','error','2861439LJfMut','join','27vuDNuW','promises','eCPsd','user','YyPMe','CkVAL','[/files]\x20Error\x20deleting\x20file:','/code/download/:session_id/:fileId','json','8838348FBLPwg','1482808EBFyzp','file','Error\x20downloading\x20file:','app','post','Error\x20downloading\x20file','[/files]\x20Files\x20deleted\x20successfully:\x20','headers','toString','COtvd','~/config','filepath','4443832RIRteS','TVoEi','NpRfD','QjAyu','\x20from\x20OpenAI','The\x20model\x20used\x20when\x20creating\x20this\x20file\x20is\x20not\x20available','Content-Disposition','unlink','Bad\x20request','set','FgSXY','You\x20can\x20only\x20delete\x20your\x20own\x20files','~/server/services/Files/process','data','hLTCt','model','send','tsYyu','HzDkr','~/app/clients/tools/util','Error\x20in\x20request','File\x20associations\x20removed\x20successfully','Files\x20deleted\x20successfully','delete','1180101iduAgp','tool_resources','xNFnp','express','filename','mFnDM','\x20downloaded\x20from\x20OpenAI','KSJDc','X-File-Metadata','pipe','YeMlF','DMjuU','path','\x20source','FILGm','\x20|\x20File\x20ID:\x20','cmLPd','tRwDb','locals','safeParse','\x20forbidden:\x20','OkYzG','QULRU','MzJFZ','8972DXQQUj','fileConfig','[/files]\x20Error\x20deleting\x20files:','Session\x20ID:\x20','pcGNJ','success','librechat-data-provider','params','stringify','test','ZhUpB','EjFed','CODE_API_KEY','azureAssistants','map','Content-Type','agent_id','filter','ZDRkV','status','File\x20','7765095nmOkmO','141EmVFku','openai','GIkOf','BLmNT','message','azure','/config','MxcsG','[/files]\x20Error\x20getting\x20files:','GgOXX','debug','setHeader','OaIhw','[/files]\x20Error\x20deleting\x20file\x20after\x20file\x20processing:','File\x20download\x20requested\x20by\x20user\x20','get','svYCR','Vljly','xuWig','OPVTS','warn','cTccL','THYwJ','\x20has\x20no\x20stream\x20method\x20implemented:\x20','RpHuj','includes','Not\x20Implemented','eQSsJ','source','kBbIl','\x20not\x20found:\x20','attachment;\x20filename=\x22'];_0x4869=function(){return _0x425151;};return _0x4869();}