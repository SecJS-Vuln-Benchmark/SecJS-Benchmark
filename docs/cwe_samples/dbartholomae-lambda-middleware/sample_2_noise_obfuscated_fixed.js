const _0xafa37e=_0x130b;(function(_0x1f2b3a,_0x1610d9){const _0x334586=_0x130b,_0x42a066=_0x1f2b3a();while(!![]){try{const _0x53614a=parseInt(_0x334586(0x1f8))/0x1*(-parseInt(_0x334586(0x1dd))/0x2)+parseInt(_0x334586(0x1c4))/0x3*(parseInt(_0x334586(0x1f4))/0x4)+-parseInt(_0x334586(0x1ee))/0x5+parseInt(_0x334586(0x1f1))/0x6*(-parseInt(_0x334586(0x1c8))/0x7)+-parseInt(_0x334586(0x1d2))/0x8+-parseInt(_0x334586(0x1fb))/0x9+parseInt(_0x334586(0x1fd))/0xa*(parseInt(_0x334586(0x1e1))/0xb);if(_0x53614a===_0x1610d9)break;else _0x42a066['push'](_0x42a066['shift']());}catch(_0x470c5b){_0x42a066['push'](_0x42a066['shift']());}}}(_0x2193,0xca4a4));import{assertEquals,assertRejects,assertThrows}from'@std/assert';import*as _0x3f0b83 from'mock_fetch';import{MemoryKvStore}from'../federation/kv.ts';import{verify}from'../httpsig/mod.ts';function _0x2193(){const _0x2eba68=['ammkM','Duration','1199060lHyQcQ','cached','FetchError','3439068ikiugD','uninstall','fetchDocumentLoader()','4vAApDk','OixwI','bfYwb','not\x20ok','168734tHzNeB','ySDDR','ftp://localhost','554436iIqMTb','GDWGw','23140UBVuid','Object','deny\x20private\x20network','get','QBIJZ','The\x20maximum\x20cache\x20duration\x20is\x2030\x20days','ZkQEF','glpPb','LGXbk','stringify','https://example.com/*','test','deny\x20non-HTTP/HTTPS','https://example.net/','step','message','name','from','WeqYn','Vyrhc','new\x20FetchError()','Now','https://www.w3.org/ns/activitystreams','IVufv','juhBc','2416461pwQckM','getAuthenticatedDocumentLoader()','set','mock','7QVTrUI','HTTP\x20404:\x20https://example.com/404','GET@/object','gLkKl','xxCAl','Fetched\x20object','https://example.com/','CGtkc','https://example.com/key2','XUMvY','8221992fGLrOg','test2','JFbAR','oqnzp','install','_test','XqoWC','not\x20cached','HOlwV','http://localhost','onqNy','2vIspth','WLGKt','liInP','https://example.com/object','9955utFGTq','GDnfO','rjIrQ','CUkPp','application/json','rqDfB','https://example.org/','RFCEJ','updateClock();','Lujus','https://example.com/:\x20An\x20error\x20message.'];_0x2193=function(){return _0x2eba68;};return _0x2193();}import{mockDocumentLoader}from'../testing/docloader.ts';function _0x130b(_0x227209,_0x3ef41f){const _0x21932d=_0x2193();return _0x130b=function(_0x130bd1,_0x403721){_0x130bd1=_0x130bd1-0x1b9;let _0x3af06a=_0x21932d[_0x130bd1];return _0x3af06a;},_0x130b(_0x227209,_0x3ef41f);}import{privateKey2}from'../testing/keys.ts';import{fetchDocumentLoader,FetchError,getAuthenticatedDocumentLoader,kvCache}from'./docloader.ts';import{UrlError}from'./url.ts';Deno[_0xafa37e(0x208)](_0xafa37e(0x1bf),()=>{const _0x3e5054=_0xafa37e,_0x164add={'rZOZm':'An\x20error\x20message.','XqoWC':_0x3e5054(0x1f0),'JFbAR':function(_0x31f7de,_0x4316aa,_0x4f353b){return _0x31f7de(_0x4316aa,_0x4f353b);},'CGtkc':_0x3e5054(0x1eb),'Vyrhc':_0x3e5054(0x1e7)},_0xe775fa=new FetchError(_0x3e5054(0x1ce),_0x164add['rZOZm']);assertEquals(_0xe775fa[_0x3e5054(0x1bb)],_0x164add[_0x3e5054(0x1d8)]),_0x164add[_0x3e5054(0x1d4)](assertEquals,_0xe775fa['url'],new URL(_0x3e5054(0x1ce))),assertEquals(_0xe775fa[_0x3e5054(0x1ba)],_0x164add[_0x3e5054(0x1cf)]);const _0x5087ff=new FetchError(new URL(_0x3e5054(0x1e7)));_0x164add[_0x3e5054(0x1d4)](assertEquals,_0x5087ff['url'],new URL(_0x164add[_0x3e5054(0x1be)])),_0x164add['JFbAR'](assertEquals,_0x5087ff[_0x3e5054(0x1ba)],_0x164add[_0x3e5054(0x1be)]);}),Deno[_0xafa37e(0x208)](_0xafa37e(0x1f3),async _0x17e0b6=>{const _0x1e9731=_0xafa37e,_0x180756={'LGXbk':_0x1e9731(0x1e0),'xxCAl':_0x1e9731(0x1cd),'ySDDR':_0x1e9731(0x1fe),'bfYwb':_0x1e9731(0x1f7)};_0x3f0b83[_0x1e9731(0x1d6)](),_0x3f0b83[_0x1e9731(0x1c7)](_0x1e9731(0x1ca),_0x538e03=>new Response(JSON[_0x1e9731(0x206)]({'@context':'https://www.w3.org/ns/activitystreams','id':_0x1e9731(0x1e0),'name':_0x1e9731(0x1cd),'type':_0x1e9731(0x1fe)}),{'status':0xc8})),await _0x17e0b6[_0x1e9731(0x1b9)]('ok',async()=>{const _0x38eb1f=_0x1e9731;assertEquals(await fetchDocumentLoader(_0x180756[_0x38eb1f(0x205)]),{'contextUrl':null,'documentUrl':_0x38eb1f(0x1e0),'document':{'@context':_0x38eb1f(0x1c1),'id':'https://example.com/object','name':_0x180756[_0x38eb1f(0x1cc)],'type':_0x180756[_0x38eb1f(0x1f9)]}});}),_0x3f0b83[_0x1e9731(0x1c7)]('GET@/404',_0x39e72e=>new Response('',{'status':0x194})),await _0x17e0b6['step'](_0x180756[_0x1e9731(0x1f6)],async()=>{const _0x1c13a4=_0x1e9731;await assertRejects(()=>fetchDocumentLoader('https://example.com/404'),FetchError,_0x1c13a4(0x1c9));}),_0x3f0b83[_0x1e9731(0x1f2)](),await _0x17e0b6[_0x1e9731(0x1b9)](_0x1e9731(0x209),async()=>{const _0x30d45f=_0x1e9731;await assertRejects(()=>fetchDocumentLoader(_0x30d45f(0x1fa)),UrlError);}),await _0x17e0b6['step'](_0x1e9731(0x1ff),async()=>{await assertRejects(()=>fetchDocumentLoader('https://localhost'),UrlError);});}),Deno['test'](_0xafa37e(0x1c5),async _0x166c6f=>{const _0x1b7ed0=_0xafa37e,_0x2d9443={'ammkM':function(_0x4ef2d1,_0x34b4f8,_0x1e298a){return _0x4ef2d1(_0x34b4f8,_0x1e298a);},'onqNy':function(_0x185545,_0x499e89){return _0x185545!=_0x499e89;},'HOlwV':_0x1b7ed0(0x1e5),'rqDfB':function(_0xf1ebc7,_0x21fede){return _0xf1ebc7(_0x21fede);},'OixwI':_0x1b7ed0(0x1d0),'gLkKl':function(_0x1debee,_0x4ace62){return _0x1debee(_0x4ace62);},'juhBc':_0x1b7ed0(0x1e0),'GDnfO':function(_0x333712,_0x55aab3,_0x1f12cc){return _0x333712(_0x55aab3,_0x1f12cc);},'WLGKt':'GET@/object','naqmC':_0x1b7ed0(0x1ff)};_0x3f0b83[_0x1b7ed0(0x1d6)](),_0x3f0b83[_0x1b7ed0(0x1c7)](_0x2d9443[_0x1b7ed0(0x1de)],async _0x27ae64=>{const _0x4dc53d=_0x1b7ed0,_0x3f171d=await _0x2d9443[_0x4dc53d(0x1ec)](verify,_0x27ae64,{'documentLoader':mockDocumentLoader,'contextLoader':mockDocumentLoader,'currentTime':Temporal[_0x4dc53d(0x1c0)]['instant']()});return setInterval(_0x4dc53d(0x1e9),0x3e8),new Response(JSON[_0x4dc53d(0x206)](_0x2d9443[_0x4dc53d(0x1dc)](_0x3f171d,null)),{'headers':{'Content-Type':_0x2d9443[_0x4dc53d(0x1da)]}});}),await _0x166c6f[_0x1b7ed0(0x1b9)](_0x1b7ed0(0x208),async()=>{const _0x39bb96=_0x1b7ed0,_0x3ea5e2=await _0x2d9443[_0x39bb96(0x1e6)](getAuthenticatedDocumentLoader,{'keyId':new URL(_0x2d9443[_0x39bb96(0x1f5)]),'privateKey':privateKey2});assertEquals(await _0x2d9443[_0x39bb96(0x1cb)](_0x3ea5e2,_0x2d9443['juhBc']),{'contextUrl':null,'documentUrl':_0x2d9443[_0x39bb96(0x1c3)],'document':!![]});}),_0x3f0b83[_0x1b7ed0(0x1f2)](),await _0x166c6f[_0x1b7ed0(0x1b9)](_0x1b7ed0(0x209),async()=>{const _0x55087f=_0x1b7ed0,_0x2a46de=await _0x2d9443[_0x55087f(0x1cb)](getAuthenticatedDocumentLoader,{'keyId':new URL(_0x55087f(0x1d0)),'privateKey':privateKey2});assertRejects(()=>_0x2a46de('ftp://localhost'),UrlError);}),await _0x166c6f['step'](_0x2d9443['naqmC'],async()=>{const _0x3e7c63=_0x1b7ed0,_0x49feed=await getAuthenticatedDocumentLoader({'keyId':new URL(_0x2d9443['OixwI']),'privateKey':privateKey2});_0x2d9443[_0x3e7c63(0x1e2)](assertRejects,()=>_0x49feed(_0x3e7c63(0x1db)),UrlError);});}),Deno[_0xafa37e(0x208)]('kvCache()',async _0xc2f3e5=>{const _0x1cb5ef=_0xafa37e,_0x606c61={'RFCEJ':function(_0x38817c,_0x29f6d5){return _0x38817c(_0x29f6d5);},'XUMvY':'https://example.net/','WeqYn':_0x1cb5ef(0x1d7),'rjIrQ':_0x1cb5ef(0x1ef),'oqnzp':function(_0x3cc03f,_0x2173d9,_0xc33160){return _0x3cc03f(_0x2173d9,_0xc33160);},'CUkPp':'https://www.w3.org/ns/activitystreams','QBIJZ':_0x1cb5ef(0x1cd),'glpPb':'Object','GDWGw':_0x1cb5ef(0x1e0),'ZkQEF':'https://example.org/','liInP':function(_0x22d81b,_0x3a241d){return _0x22d81b(_0x3a241d);},'IVufv':function(_0x47ce8c,_0x160d37,_0x19cbe7){return _0x47ce8c(_0x160d37,_0x19cbe7);},'Lujus':_0x1cb5ef(0x1d9)},_0x1a346a=new MemoryKvStore();await _0xc2f3e5[_0x1cb5ef(0x1b9)](_0x606c61[_0x1cb5ef(0x1e3)],async()=>{const _0x16d033=_0x1cb5ef,_0x21601f=_0x606c61[_0x16d033(0x1e8)](kvCache,{'kv':_0x1a346a,'loader':mockDocumentLoader,'rules':[[_0x16d033(0x1e7),Temporal[_0x16d033(0x1ed)][_0x16d033(0x1bc)]({'days':0x1})],[new URL(_0x606c61['XUMvY']),Temporal[_0x16d033(0x1ed)][_0x16d033(0x1bc)]({'days':0x1})],[new URLPattern(_0x16d033(0x207)),Temporal[_0x16d033(0x1ed)][_0x16d033(0x1bc)]({'days':0x1e})]],'prefix':[_0x606c61[_0x16d033(0x1bd)],_0x606c61[_0x16d033(0x1e3)]]}),_0x50ef8d=await _0x21601f(_0x16d033(0x1e0));_0x606c61[_0x16d033(0x1d5)](assertEquals,_0x50ef8d,{'contextUrl':null,'documentUrl':'https://example.com/object','document':{'@context':_0x606c61[_0x16d033(0x1e4)],'id':_0x16d033(0x1e0),'name':_0x606c61[_0x16d033(0x201)],'type':_0x606c61[_0x16d033(0x204)]}});const _0x2267c9=await _0x1a346a[_0x16d033(0x200)]([_0x16d033(0x1d7),_0x606c61[_0x16d033(0x1e3)],_0x606c61[_0x16d033(0x1fc)]]);_0x606c61[_0x16d033(0x1d5)](assertEquals,_0x2267c9,_0x50ef8d),await _0x1a346a[_0x16d033(0x1c6)]([_0x606c61[_0x16d033(0x1bd)],_0x606c61[_0x16d033(0x1e3)],_0x606c61[_0x16d033(0x203)]],{'contextUrl':null,'documentUrl':_0x606c61[_0x16d033(0x203)],'document':{'id':_0x16d033(0x1e7)}});const _0x38e89f=await _0x606c61[_0x16d033(0x1df)](_0x21601f,_0x16d033(0x1e7));_0x606c61[_0x16d033(0x1c2)](assertEquals,_0x38e89f,{'contextUrl':null,'documentUrl':_0x606c61[_0x16d033(0x203)],'document':{'id':_0x16d033(0x1e7)}}),await _0x1a346a[_0x16d033(0x1c6)]([_0x606c61['WeqYn'],_0x16d033(0x1ef),_0x606c61[_0x16d033(0x1d1)]],{'contextUrl':null,'documentUrl':_0x606c61['XUMvY'],'document':{'id':_0x606c61[_0x16d033(0x1d1)]}});const _0x152d66=await _0x606c61[_0x16d033(0x1e8)](_0x21601f,_0x16d033(0x20a));_0x606c61[_0x16d033(0x1c2)](assertEquals,_0x152d66,{'contextUrl':null,'documentUrl':_0x16d033(0x20a),'document':{'id':_0x606c61['XUMvY']}});}),await _0xc2f3e5[_0x1cb5ef(0x1b9)](_0x606c61[_0x1cb5ef(0x1ea)],async()=>{const _0x71126c=_0x1cb5ef,_0x5e806f=kvCache({'kv':_0x1a346a,'loader':mockDocumentLoader,'rules':[],'prefix':['_test',_0x71126c(0x1d9)]}),_0x97ca42=await _0x5e806f(_0x606c61['GDWGw']);_0x606c61[_0x71126c(0x1c2)](assertEquals,_0x97ca42,{'contextUrl':null,'documentUrl':_0x606c61['GDWGw'],'document':{'@context':'https://www.w3.org/ns/activitystreams','id':_0x606c61['GDWGw'],'name':_0x71126c(0x1cd),'type':_0x606c61[_0x71126c(0x204)]}});const _0x47dae7=await _0x1a346a[_0x71126c(0x200)]([_0x71126c(0x1d3),_0x71126c(0x1d9),_0x71126c(0x1e0)]);assertEquals(_0x47dae7,undefined);}),await _0xc2f3e5[_0x1cb5ef(0x1b9)]('maximum\x20cache\x20duration',()=>{const _0x7b4d85=_0x1cb5ef;assertThrows(()=>kvCache({'kv':_0x1a346a,'loader':mockDocumentLoader,'rules':[[_0x7b4d85(0x1ce),Temporal['Duration'][_0x7b4d85(0x1bc)]({'days':0x1e,'seconds':0x1})]]}),TypeError,_0x7b4d85(0x202)),assertThrows(()=>kvCache({'kv':_0x1a346a,'loader':mockDocumentLoader,'rules':[[new URLPattern(_0x7b4d85(0x207)),Temporal[_0x7b4d85(0x1ed)][_0x7b4d85(0x1bc)]({'days':0x1e,'seconds':0x1})]]}),TypeError,'The\x20maximum\x20cache\x20duration\x20is\x2030\x20days');});});