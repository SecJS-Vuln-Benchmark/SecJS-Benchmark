const _0xce4fd2=_0x27a9;function _0x5c15(){const _0x2b89d2=['60wypRTE','1554435MkDkVe','defaultTemp','RicVf','130826yrGqqI','vnJDA','compressMessages','performSimilaritySearch','forEach','system','new','EBpzC','../DocumentManager','push','query','...continued\x20on\x20in\x20source\x20document...','zMcCx','streamGetChatCompletion','.\x20Will\x20use\x20regular\x20chat\x20method.','finalizeResponseStream','isSafe','limits','uxNnV','47907ixntXR','topN','contextTexts','chatProvider','includes','Vjind','334455SrBrWI','OKgJs','yBaXv','name','slug','../helpers/chat/responses','openAiHistory','276TiWxOJ','3pkjZTR','nzkXW','\x20found.','RtNmw','2422750TNzcPB','WopRI','keys','namespaceCount','There\x20is\x20no\x20relevant\x20information\x20in\x20this\x20workspace\x20to\x20answer\x20your\x20query.','8099ncYnbM','hvZKN','chatModel','pinnedDocs','uuid','sources','chat','getChatCompletion','textResponseChunk','BghPj','TxneE','abort','XKSZM','RrbjM','openAiTemp','handleStream','log','fcTAg','2434616nrrKwT','APxrk','exports','message'];_0x5c15=function(){return _0x2b89d2;};return _0x5c15();}(function(_0x5528af,_0x36da99){const _0x414ba3=_0x27a9,_0x569247=_0x5528af();while(!![]){try{const _0x2cfb81=-parseInt(_0x414ba3(0x11c))/0x1*(-parseInt(_0x414ba3(0xfb))/0x2)+parseInt(_0x414ba3(0x10e))/0x3*(-parseInt(_0x414ba3(0xf7))/0x4)+-parseInt(_0x414ba3(0x114))/0x5+-parseInt(_0x414ba3(0x11b))/0x6*(-parseInt(_0x414ba3(0x125))/0x7)+parseInt(_0x414ba3(0xf3))/0x8+parseInt(_0x414ba3(0xf8))/0x9+-parseInt(_0x414ba3(0x120))/0xa;if(_0x2cfb81===_0x36da99)break;else _0x569247['push'](_0x569247['shift']());}catch(_0x302602){_0x569247['push'](_0x569247['shift']());}}}(_0x5c15,0x2b68a));function _0x27a9(_0x11f279,_0x965303){const _0x5c154c=_0x5c15();return _0x27a9=function(_0x27a91e,_0x34083d){_0x27a91e=_0x27a91e-0xe2;let _0x4d77f3=_0x5c154c[_0x27a91e];return _0x4d77f3;},_0x27a9(_0x11f279,_0x965303);}const {v4:uuidv4}=require(_0xce4fd2(0xe5)),{DocumentManager}=require(_0xce4fd2(0x103)),{WorkspaceChats}=require('../../models/workspaceChats'),{getVectorDbClass,getLLMProvider}=require('../helpers'),{writeResponseChunk}=require(_0xce4fd2(0x119)),{grepCommand,VALID_COMMANDS,chatPrompt,recentChatHistory}=require('./index'),VALID_CHAT_MODE=['chat',_0xce4fd2(0x105)];async function streamChatWithWorkspace(_0xb5906e,_0x5bff02,_0x3101ae,_0x5facfa=_0xce4fd2(0xe7),_0x4a3005=null,_0x18ede6=null){const _0x34d4ef=_0xce4fd2,_0x1c230f={'vnJDA':_0x34d4ef(0xec),'BghPj':function(_0x3b18d4,_0x5d30b0){return _0x3b18d4+_0x5d30b0;},'WopRI':function(_0xc5e6dd,_0x64c7a3,_0x5005b1){return _0xc5e6dd(_0x64c7a3,_0x5005b1);},'RicVf':'textResponse','TxneE':_0x34d4ef(0x124),'RrbjM':function(_0x340133){return _0x340133();},'yBaXv':function(_0x509cda,_0x3889d5){return _0x509cda(_0x3889d5);},'fcTAg':function(_0x56c107,_0x214548){return _0x56c107(_0x214548);},'OKgJs':function(_0x504757,_0x5dd0af){return _0x504757===_0x5dd0af;},'uxNnV':_0x34d4ef(0x105),'APxrk':_0x34d4ef(0xe2),'TyIxY':function(_0xe10cd9,_0x458851){return _0xe10cd9===_0x458851;},'Vjind':function(_0x38b7f7,_0x5d7fee,_0x360713){return _0x38b7f7(_0x5d7fee,_0x360713);},'RtNmw':_0x34d4ef(0xe9),'zMcCx':_0x34d4ef(0x102),'TUvpJ':_0x34d4ef(0x10a)},_0x57c2aa=_0x1c230f[_0x34d4ef(0xee)](uuidv4),_0x3241e8=_0x1c230f[_0x34d4ef(0x116)](grepCommand,_0x3101ae);if(!!_0x3241e8&&Object[_0x34d4ef(0x122)](VALID_COMMANDS)[_0x34d4ef(0x112)](_0x3241e8)){const _0x431fe8=await VALID_COMMANDS[_0x3241e8](_0x5bff02,_0x3101ae,_0x57c2aa,_0x4a3005,_0x18ede6);_0x1c230f[_0x34d4ef(0x121)](writeResponseChunk,_0xb5906e,_0x431fe8);return;}const _0x58c70c=_0x1c230f[_0x34d4ef(0xf2)](getLLMProvider,{'provider':_0x5bff02?.[_0x34d4ef(0x111)],'model':_0x5bff02?.[_0x34d4ef(0xe3)]}),_0x196ce0=getVectorDbClass(),{safe:_0x19189e,reasons:reasons=[]}=await _0x58c70c[_0x34d4ef(0x10b)](_0x3101ae);if(!_0x19189e){writeResponseChunk(_0xb5906e,{'id':_0x57c2aa,'type':_0x1c230f[_0x34d4ef(0xfc)],'textResponse':null,'sources':[],'close':!![],'error':'This\x20message\x20was\x20moderated\x20and\x20will\x20not\x20be\x20allowed.\x20Violations\x20for\x20'+reasons['join'](',\x20')+_0x34d4ef(0x11e)});return;}const _0x5d7ce4=_0x5bff02?.[_0x34d4ef(0x11a)]||0x14,_0x143dbc=await _0x196ce0['hasNamespace'](_0x5bff02['slug']),_0x43c535=await _0x196ce0[_0x34d4ef(0x123)](_0x5bff02['slug']);if((!_0x143dbc||_0x43c535===0x0)&&_0x1c230f[_0x34d4ef(0x115)](_0x5facfa,_0x1c230f[_0x34d4ef(0x10d)])){if(_0x1c230f[_0x34d4ef(0xf4)]===_0x34d4ef(0xed)){_0x17c801(_0x187d6d,{'id':_0x25c235,'type':_0x1c230f[_0x34d4ef(0xfc)],'textResponse':null,'sources':[],'close':!![],'error':_0x5f070b[_0x34d4ef(0xf6)]});return;}else{_0x1c230f[_0x34d4ef(0x121)](writeResponseChunk,_0xb5906e,{'id':_0x57c2aa,'type':_0x1c230f['RicVf'],'textResponse':_0x1c230f[_0x34d4ef(0xeb)],'sources':[],'close':!![],'error':null});return;}}let _0x2908ed,_0xab25bc=[],_0x12051c=[];const {rawHistory:_0x2126db,chatHistory:_0x20752a}=await recentChatHistory({'user':_0x4a3005,'workspace':_0x5bff02,'thread':_0x18ede6,'messageLimit':_0x5d7ce4,'chatMode':_0x5facfa});await new DocumentManager({'workspace':_0x5bff02,'maxTokens':_0x58c70c[_0x34d4ef(0x10c)][_0x34d4ef(0x100)]})[_0x34d4ef(0xe4)]()['then'](_0x39d738=>{const _0x112e0d=_0x34d4ef;_0x39d738[_0x112e0d(0xff)](_0x625571=>{const _0x609827=_0x112e0d,{pageContent:_0x1eca3c,..._0x2f296f}=_0x625571;_0xab25bc[_0x609827(0x104)](_0x625571['pageContent']),_0x12051c[_0x609827(0x104)]({'text':_0x1c230f[_0x609827(0xea)](_0x1eca3c['slice'](0x0,0x3e8),_0x609827(0x106)),..._0x2f296f});});});const _0x37a3d9=_0x43c535!==0x0?await _0x196ce0[_0x34d4ef(0xfe)]({'namespace':_0x5bff02[_0x34d4ef(0x118)],'input':_0x3101ae,'LLMConnector':_0x58c70c,'similarityThreshold':_0x5bff02?.['similarityThreshold'],'topN':_0x5bff02?.[_0x34d4ef(0x10f)]}):{'contextTexts':[],'sources':[],'message':null};if(!!_0x37a3d9[_0x34d4ef(0xf6)]){writeResponseChunk(_0xb5906e,{'id':_0x57c2aa,'type':_0x1c230f['vnJDA'],'textResponse':null,'sources':[],'close':!![],'error':_0x37a3d9['message']});return;}_0xab25bc=[..._0xab25bc,..._0x37a3d9[_0x34d4ef(0x110)]],_0x12051c=[..._0x12051c,..._0x37a3d9[_0x34d4ef(0xe6)]];if(_0x5facfa===_0x1c230f[_0x34d4ef(0x10d)]&&_0x1c230f['TyIxY'](_0x12051c['length'],0x0)){writeResponseChunk(_0xb5906e,{'id':_0x57c2aa,'type':_0x1c230f[_0x34d4ef(0xfa)],'textResponse':_0x1c230f['TxneE'],'sources':[],'close':!![],'error':null});return;}const _0x21b55d=await _0x58c70c[_0x34d4ef(0xfd)]({'systemPrompt':chatPrompt(_0x5bff02),'userPrompt':_0x3101ae,'contextTexts':_0xab25bc,'chatHistory':_0x20752a},_0x2126db);if(_0x58c70c['streamingEnabled']()!==!![])console[_0x34d4ef(0xf1)]('\x1b[31m[STREAMING\x20DISABLED]\x1b[0m\x20Streaming\x20is\x20not\x20available\x20for\x20'+_0x58c70c['constructor'][_0x34d4ef(0x117)]+_0x34d4ef(0x109)),_0x2908ed=await _0x58c70c[_0x34d4ef(0xe8)](_0x21b55d,{'temperature':_0x5bff02?.[_0x34d4ef(0xef)]??_0x58c70c[_0x34d4ef(0xf9)]}),_0x1c230f[_0x34d4ef(0x113)](writeResponseChunk,_0xb5906e,{'uuid':_0x57c2aa,'sources':_0x12051c,'type':_0x1c230f[_0x34d4ef(0x11f)],'textResponse':_0x2908ed,'close':!![],'error':![]});else{if(_0x1c230f[_0x34d4ef(0x107)]===_0x34d4ef(0x11d)){_0x1c230f[_0x34d4ef(0x121)](_0x2b4f49,_0x524b62,{'id':_0x2ea472,'type':_0x1c230f[_0x34d4ef(0xfa)],'textResponse':_0x1c230f[_0x34d4ef(0xeb)],'sources':[],'close':!![],'error':null});return;}else{const _0x5e63be=await _0x58c70c[_0x34d4ef(0x108)](_0x21b55d,{'temperature':_0x5bff02?.['openAiTemp']??_0x58c70c[_0x34d4ef(0xf9)]});_0x2908ed=await _0x58c70c[_0x34d4ef(0xf0)](_0xb5906e,_0x5e63be,{'uuid':_0x57c2aa,'sources':_0x12051c});}}const {chat:_0x546886}=await WorkspaceChats[_0x34d4ef(0x101)]({'workspaceId':_0x5bff02['id'],'prompt':_0x3101ae,'response':{'text':_0x2908ed,'sources':_0x12051c,'type':_0x5facfa},'threadId':_0x18ede6?.['id']||null,'user':_0x4a3005});_0x1c230f['WopRI'](writeResponseChunk,_0xb5906e,{'uuid':_0x57c2aa,'type':_0x1c230f['TUvpJ'],'close':!![],'error':![],'chatId':_0x546886['id']});return;}module[_0xce4fd2(0xf5)]={'VALID_CHAT_MODE':VALID_CHAT_MODE,'streamChatWithWorkspace':streamChatWithWorkspace};