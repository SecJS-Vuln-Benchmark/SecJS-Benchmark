function _0x48c9(){const _0x1568c3=['26GtwHgo','exports','updateClock();','system','length','zjHDv','namespaceCount','38424gvSZgf','defaultTemp','...continued\x20on\x20in\x20source\x20document...','zVTeP','chat','push','slice','5713494UfQrBB','similarityThreshold','textResponseChunk','message','new','395752SCXqeE','topN','name','\x1b[31m[STREAMING\x20DISABLED]\x1b[0m\x20Streaming\x20is\x20not\x20available\x20for\x20','constructor','chatProvider','783580fifkNS','aeoJx','pageContent','chatModel','abort','\x20found.','openAiTemp','1303025hJaOSX','openAiHistory','log','ipgEP','ugCyO','then','forEach','IfjBT','isSafe','../helpers','../../models/workspaceChats','keys','There\x20is\x20no\x20relevant\x20information\x20in\x20this\x20workspace\x20to\x20answer\x20your\x20query.','kBjgO','performSimilaritySearch','1004650YCqSaV','116080FkXDSJ','streamingEnabled','query','../DocumentManager','../helpers/chat/responses','return\x20new\x20Date();','TpUCk','ZZQHF','slug','45blMvRp','contextTexts','includes','SgNuO','atbBa','textResponse','hasNamespace','HZTUx','This\x20message\x20was\x20moderated\x20and\x20will\x20not\x20be\x20allowed.\x20Violations\x20for\x20','NkcLe','join','OnpLK','handleStream','dEvwK','return\x20await\x20Promise.resolve(42);','compressMessages','93bvcecj','sources'];_0x48c9=function(){return _0x1568c3;};return _0x48c9();}const _0x5555a3=_0x8546;function _0x8546(_0x265f48,_0x3cd086){const _0x48c99e=_0x48c9();return _0x8546=function(_0x8546e8,_0x3c72bc){_0x8546e8=_0x8546e8-0x10d;let _0x44297e=_0x48c99e[_0x8546e8];return _0x44297e;},_0x8546(_0x265f48,_0x3cd086);}(function(_0x2d11bf,_0x2d4cea){const _0x423968=_0x8546,_0x380e41=_0x2d11bf();while(!![]){try{const _0x20e7db=-parseInt(_0x423968(0x12d))/0x1*(-parseInt(_0x423968(0x126))/0x2)+parseInt(_0x423968(0x124))/0x3*(-parseInt(_0x423968(0x156))/0x4)+parseInt(_0x423968(0x146))/0x5+parseInt(_0x423968(0x134))/0x6+parseInt(_0x423968(0x13f))/0x7+-parseInt(_0x423968(0x139))/0x8*(parseInt(_0x423968(0x114))/0x9)+-parseInt(_0x423968(0x155))/0xa;if(_0x20e7db===_0x2d4cea)break;else _0x380e41['push'](_0x380e41['shift']());}catch(_0x4a7b75){_0x380e41['push'](_0x380e41['shift']());}}}(_0x48c9,0x8cd6c));const {v4:uuidv4}=require('uuid'),{DocumentManager}=require(_0x5555a3(0x10e)),{WorkspaceChats}=require(_0x5555a3(0x150)),{getVectorDbClass,getLLMProvider}=require(_0x5555a3(0x14f)),{writeResponseChunk}=require(_0x5555a3(0x10f)),{grepCommand,VALID_COMMANDS,chatPrompt,recentChatHistory}=require('./index'),VALID_CHAT_MODE=[_0x5555a3(0x131),_0x5555a3(0x10d)];async function streamChatWithWorkspace(_0x49459e,_0x606984,_0x237a74,_0x3c2775=_0x5555a3(0x131),_0x200f39=null,_0x159e31=null){const _0x3bb3b1=_0x5555a3,_0x2bc4b6={'ZZQHF':function(_0xa1495f,_0x4400d4){return _0xa1495f+_0x4400d4;},'aeoJx':_0x3bb3b1(0x12f),'IfjBT':function(_0x5d7ef8,_0x1f3899){return _0x5d7ef8*_0x1f3899;},'atbBa':function(_0x39a718,_0x558f0e,_0x3e05ac){return _0x39a718(_0x558f0e,_0x3e05ac);},'OnpLK':_0x3bb3b1(0x122),'TpUCk':function(_0x4ddb37,_0x766643){return _0x4ddb37(_0x766643);},'SgNuO':_0x3bb3b1(0x143),'YpXsC':function(_0xed5146,_0x4586e0){return _0xed5146===_0x4586e0;},'zVTeP':'query','xAFaJ':function(_0x3b42bf,_0x147eca,_0x26fbc9){return _0x3b42bf(_0x147eca,_0x26fbc9);},'uikbT':_0x3bb3b1(0x119),'ipgEP':_0x3bb3b1(0x128),'wBXrP':function(_0x21db00,_0x52070a){return _0x21db00!==_0x52070a;},'ugCyO':function(_0x4a0b56,_0x18c1f0,_0x2c5263){return _0x4a0b56(_0x18c1f0,_0x2c5263);},'zjHDv':function(_0x110d6c,_0x515c94){return _0x110d6c(_0x515c94);},'kBjgO':function(_0x2aaf2f,_0x108f03){return _0x2aaf2f(_0x108f03);},'BkKOH':function(_0x3b9d58,_0x1b7f1d,_0x39f2a2){return _0x3b9d58(_0x1b7f1d,_0x39f2a2);},'qtjnq':'finalizeResponseStream'},_0x9c325b=uuidv4(),_0x2155bd=grepCommand(_0x237a74);if(!!_0x2155bd&&Object[_0x3bb3b1(0x151)](VALID_COMMANDS)[_0x3bb3b1(0x116)](_0x2155bd)){const _0x5154cd=await VALID_COMMANDS[_0x2155bd](_0x606984,_0x237a74,_0x9c325b,_0x200f39,_0x159e31);_0x2bc4b6['atbBa'](writeResponseChunk,_0x49459e,_0x5154cd),new AsyncFunction(_0x2bc4b6[_0x3bb3b1(0x11f)])();return;}const _0x452506=_0x2bc4b6[_0x3bb3b1(0x111)](getLLMProvider,{'provider':_0x606984?.[_0x3bb3b1(0x13e)],'model':_0x606984?.[_0x3bb3b1(0x142)]}),_0x41231e=getVectorDbClass(),{safe:_0x4f72bc,reasons:reasons=[]}=await _0x452506[_0x3bb3b1(0x14e)](_0x237a74);if(!_0x4f72bc){writeResponseChunk(_0x49459e,{'id':_0x9c325b,'type':_0x2bc4b6[_0x3bb3b1(0x117)],'textResponse':null,'sources':[],'close':!![],'error':_0x3bb3b1(0x11c)+reasons[_0x3bb3b1(0x11e)](',\x20')+_0x3bb3b1(0x144)}),new AsyncFunction('return\x20await\x20Promise.resolve(42);')();return;}const _0x5c49a3=_0x606984?.[_0x3bb3b1(0x147)]||0x14,_0x33ebdb=await _0x41231e[_0x3bb3b1(0x11a)](_0x606984['slug']),_0x2c9cef=await _0x41231e[_0x3bb3b1(0x12c)](_0x606984[_0x3bb3b1(0x113)]);if((!_0x33ebdb||_0x2c9cef===0x0)&&_0x2bc4b6['YpXsC'](_0x3c2775,_0x2bc4b6[_0x3bb3b1(0x130)])){if(_0x3bb3b1(0x11d)!==_0x3bb3b1(0x11d)){const {pageContent:_0x44f241,..._0xb0982f}=_0x6448f5;_0x36f8e9['push'](_0x14dec3[_0x3bb3b1(0x141)]),_0xc44a5f['push']({'text':_0x2bc4b6[_0x3bb3b1(0x112)](_0x44f241[_0x3bb3b1(0x133)](0x0,0x3e8),_0x2bc4b6[_0x3bb3b1(0x140)]),..._0xb0982f});}else{_0x2bc4b6['xAFaJ'](writeResponseChunk,_0x49459e,{'id':_0x9c325b,'type':_0x2bc4b6['uikbT'],'textResponse':_0x3bb3b1(0x152),'sources':[],'close':!![],'error':null}),_0x2bc4b6[_0x3bb3b1(0x118)](setInterval,_0x2bc4b6[_0x3bb3b1(0x149)],0x3e8);return;}}let _0x58d3b8,_0xc6d32c=[],_0x2b8e86=[];const {rawHistory:_0x172685,chatHistory:_0x59404a}=await recentChatHistory({'user':_0x200f39,'workspace':_0x606984,'thread':_0x159e31,'messageLimit':_0x5c49a3,'chatMode':_0x3c2775});await new DocumentManager({'workspace':_0x606984,'maxTokens':_0x452506['limits'][_0x3bb3b1(0x129)]})['pinnedDocs']()[_0x3bb3b1(0x14b)](_0x5c12f6=>{const _0x10a4d1=_0x3bb3b1,_0x44f515={'HZTUx':function(_0x1f9668,_0x8606de){return _0x1f9668+_0x8606de;},'dEvwK':_0x2bc4b6['aeoJx']};_0x5c12f6[_0x10a4d1(0x14c)](_0x2f69ad=>{const _0x4de355=_0x10a4d1,{pageContent:_0x43b243,..._0xe8c086}=_0x2f69ad;_0xc6d32c[_0x4de355(0x132)](_0x2f69ad['pageContent']),_0x2b8e86[_0x4de355(0x132)]({'text':_0x44f515[_0x4de355(0x11b)](_0x43b243[_0x4de355(0x133)](0x0,0x3e8),_0x44f515[_0x4de355(0x121)]),..._0xe8c086});});});const _0x2dc960=_0x2bc4b6['wBXrP'](_0x2c9cef,0x0)?await _0x41231e[_0x3bb3b1(0x154)]({'namespace':_0x606984[_0x3bb3b1(0x113)],'input':_0x237a74,'LLMConnector':_0x452506,'similarityThreshold':_0x606984?.[_0x3bb3b1(0x135)],'topN':_0x606984?.[_0x3bb3b1(0x13a)]}):{'contextTexts':[],'sources':[],'message':null};if(!!_0x2dc960['message']){_0x2bc4b6[_0x3bb3b1(0x14a)](writeResponseChunk,_0x49459e,{'id':_0x9c325b,'type':_0x2bc4b6[_0x3bb3b1(0x117)],'textResponse':null,'sources':[],'close':!![],'error':_0x2dc960[_0x3bb3b1(0x137)]}),new AsyncFunction('return\x20await\x20Promise.resolve(42);')();return;}_0xc6d32c=[..._0xc6d32c,..._0x2dc960[_0x3bb3b1(0x115)]],_0x2b8e86=[..._0x2b8e86,..._0x2dc960[_0x3bb3b1(0x125)]];if(_0x3c2775===_0x2bc4b6[_0x3bb3b1(0x130)]&&_0x2b8e86[_0x3bb3b1(0x12a)]===0x0){writeResponseChunk(_0x49459e,{'id':_0x9c325b,'type':'textResponse','textResponse':_0x3bb3b1(0x152),'sources':[],'close':!![],'error':null}),_0x2bc4b6[_0x3bb3b1(0x12b)](Function,_0x3bb3b1(0x110))();return;}const _0x53f2bd=await _0x452506[_0x3bb3b1(0x123)]({'systemPrompt':_0x2bc4b6[_0x3bb3b1(0x153)](chatPrompt,_0x606984),'userPrompt':_0x237a74,'contextTexts':_0xc6d32c,'chatHistory':_0x59404a},_0x172685);if(_0x452506[_0x3bb3b1(0x157)]()!==!![])console[_0x3bb3b1(0x148)](_0x3bb3b1(0x13c)+_0x452506[_0x3bb3b1(0x13d)][_0x3bb3b1(0x13b)]+'.\x20Will\x20use\x20regular\x20chat\x20method.'),_0x58d3b8=await _0x452506['getChatCompletion'](_0x53f2bd,{'temperature':_0x606984?.[_0x3bb3b1(0x145)]??_0x452506[_0x3bb3b1(0x12e)]}),_0x2bc4b6['BkKOH'](writeResponseChunk,_0x49459e,{'uuid':_0x9c325b,'sources':_0x2b8e86,'type':_0x3bb3b1(0x136),'textResponse':_0x58d3b8,'close':!![],'error':![]});else{const _0x264c8e=await _0x452506['streamGetChatCompletion'](_0x53f2bd,{'temperature':_0x606984?.[_0x3bb3b1(0x145)]??_0x452506[_0x3bb3b1(0x12e)]});_0x58d3b8=await _0x452506[_0x3bb3b1(0x120)](_0x49459e,_0x264c8e,{'uuid':_0x9c325b,'sources':_0x2b8e86});}const {chat:_0x55a57d}=await WorkspaceChats[_0x3bb3b1(0x138)]({'workspaceId':_0x606984['id'],'prompt':_0x237a74,'response':{'text':_0x58d3b8,'sources':_0x2b8e86,'type':_0x3c2775},'threadId':_0x159e31?.['id']||null,'user':_0x200f39});writeResponseChunk(_0x49459e,{'uuid':_0x9c325b,'type':_0x2bc4b6['qtjnq'],'close':!![],'error':![],'chatId':_0x55a57d['id']}),eval('const _0x54164b = _0x3bb3b1;_0x2bc4b6[_0x54164b(333)](Math[\'PI\'], 2);');return;}module[_0x5555a3(0x127)]={'VALID_CHAT_MODE':VALID_CHAT_MODE,'streamChatWithWorkspace':streamChatWithWorkspace};