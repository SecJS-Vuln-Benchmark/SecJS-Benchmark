const _0x1b89c2=_0x15b9;(function(_0x139b6c,_0x4f13ea){const _0x223cb4=_0x15b9,_0x49d1f9=_0x139b6c();while(!![]){try{const _0x3d2d7f=-parseInt(_0x223cb4(0x110))/0x1*(-parseInt(_0x223cb4(0xe8))/0x2)+parseInt(_0x223cb4(0x115))/0x3+-parseInt(_0x223cb4(0xec))/0x4*(-parseInt(_0x223cb4(0xfd))/0x5)+parseInt(_0x223cb4(0x105))/0x6+parseInt(_0x223cb4(0xf9))/0x7*(parseInt(_0x223cb4(0xe0))/0x8)+-parseInt(_0x223cb4(0x114))/0x9*(parseInt(_0x223cb4(0xe5))/0xa)+-parseInt(_0x223cb4(0x10a))/0xb*(parseInt(_0x223cb4(0xdb))/0xc);if(_0x3d2d7f===_0x4f13ea)break;else _0x49d1f9['push'](_0x49d1f9['shift']());}catch(_0x1da2f6){_0x49d1f9['push'](_0x49d1f9['shift']());}}}(_0x50a4,0x52129));const {z}=require(_0x1b89c2(0x104)),Message=require(_0x1b89c2(0xea)),{logger}=require('~/config'),idSchema=z['string']()[_0x1b89c2(0xf0)]();async function saveMessage(_0x5dd7a1,_0xc4a550,_0x2793d7){const _0x418506=_0x1b89c2,_0x49c353={'QUyXm':'User\x20not\x20authenticated'};if(!_0x5dd7a1?.[_0x418506(0x10c)]?.['id'])throw new Error(_0x49c353[_0x418506(0xda)]);const _0x530cc0=idSchema[_0x418506(0x109)](_0xc4a550[_0x418506(0xdd)]);if(!_0x530cc0['success']){logger['warn'](_0x418506(0xef)+_0xc4a550[_0x418506(0xdd)]),logger[_0x418506(0xed)](_0x418506(0xe1)+_0x2793d7?.[_0x418506(0x116)]),logger[_0x418506(0xed)](_0x418506(0x10d)+JSON[_0x418506(0xde)](_0xc4a550,null,0x2));return;}try{const _0x2f30ac={..._0xc4a550,'user':_0x5dd7a1[_0x418506(0x10c)]['id'],'messageId':_0xc4a550['newMessageId']||_0xc4a550[_0x418506(0xe4)]},_0x5ab2b4=await Message['findOneAndUpdate']({'messageId':_0xc4a550[_0x418506(0xe4)],'user':_0x5dd7a1['user']['id']},_0x2f30ac,{'upsert':!![],'new':!![]});return _0x5ab2b4['toObject']();}catch(_0x49f77b){logger['error'](_0x418506(0xf8),_0x49f77b),logger[_0x418506(0xed)](_0x418506(0xe1)+_0x2793d7?.[_0x418506(0x116)]);throw _0x49f77b;}}async function bulkSaveMessages(_0x414ca8,_0x2ff9a4=![]){const _0x58c16e=_0x1b89c2;try{const _0x410ff5=_0x414ca8[_0x58c16e(0x113)](_0x53ca16=>({'updateOne':{'filter':{'messageId':_0x53ca16[_0x58c16e(0xe4)]},'update':_0x53ca16,'timestamps':!_0x2ff9a4,'upsert':!![]}})),_0x3c0d71=await Message[_0x58c16e(0xe9)](_0x410ff5);return _0x3c0d71;}catch(_0x2e4949){logger[_0x58c16e(0xfe)](_0x58c16e(0xff),_0x2e4949);throw _0x2e4949;}}async function recordMessage({user:_0x7fbe71,endpoint:_0x3156ad,messageId:_0x3f7720,conversationId:_0x3dd22e,parentMessageId:_0xa38907,..._0x407200}){const _0x4ce1d4=_0x1b89c2;try{const _0x170d80={'user':_0x7fbe71,'endpoint':_0x3156ad,'messageId':_0x3f7720,'conversationId':_0x3dd22e,'parentMessageId':_0xa38907,..._0x407200};return await Message[_0x4ce1d4(0xf3)]({'user':_0x7fbe71,'messageId':_0x3f7720},_0x170d80,{'upsert':!![],'new':!![]});}catch(_0x3a088a){logger[_0x4ce1d4(0xfe)](_0x4ce1d4(0xeb),_0x3a088a);throw _0x3a088a;}}function _0x15b9(_0x116239,_0xceba41){const _0x50a455=_0x50a4();return _0x15b9=function(_0x15b9a5,_0x559037){_0x15b9a5=_0x15b9a5-0xda;let _0x8943d4=_0x50a455[_0x15b9a5];return _0x8943d4;},_0x15b9(_0x116239,_0xceba41);}async function updateMessageText(_0x350623,{messageId:_0x34a2a8,text:_0x2604e7}){const _0x40d552=_0x1b89c2;try{await Message[_0x40d552(0x100)]({'messageId':_0x34a2a8,'user':_0x350623[_0x40d552(0x10c)]['id']},{'text':_0x2604e7});}catch(_0x3861dd){logger[_0x40d552(0xfe)]('Error\x20updating\x20message\x20text:',_0x3861dd);throw _0x3861dd;}}function _0x50a4(){const _0x823fae=['createdAt','QUyXm','12UPqPOa','lSvQD','conversationId','stringify','findOne','99776XwXZxQ','---`saveMessage`\x20context:\x20','Error\x20getting\x20message:','tokenCount','messageId','150vieSAY','eUPtt','XrpZC','2TweGks','bulkWrite','./schema/messageSchema','Error\x20recording\x20message:','88XonFuA','info','text','Invalid\x20conversation\x20ID:\x20','uuid','sender','lean','findOneAndUpdate','OqZNt','zjoWh','find','EmIdN','Error\x20saving\x20message:','7bYXtOW','CgksI','NuFnz','warn','87270Hepysk','error','Error\x20saving\x20messages\x20in\x20bulk:','updateOne','exports','Message\x20not\x20found\x20or\x20user\x20not\x20authorized.','uGdeb','zod','2315256oAloYm','Error\x20deleting\x20messages:','BZjNy','deleteMany','safeParse','14864993jYChxV','uvdIu','user','---Invalid\x20conversation\x20ID\x20Params:\x20','Error\x20getting\x20messages:','sort','561289SVVVlJ','isCreatedByUser','parentMessageId','map','93843OjIWzB','1500936OEFQam','context','select'];_0x50a4=function(){return _0x823fae;};return _0x50a4();}async function updateMessage(_0x13fa4,_0x51d194,_0x5f1195){const _0x373901=_0x1b89c2,_0x16eccf={'uvdIu':_0x373901(0x102),'lSvQD':'Error\x20updating\x20message:'};try{const {messageId:_0x516f52,..._0x4e3a49}=_0x51d194;_0x4e3a49['isEdited']=!![];const _0x9e18b9=await Message['findOneAndUpdate']({'messageId':_0x516f52,'user':_0x13fa4['user']['id']},_0x4e3a49,{'new':!![]});if(!_0x9e18b9)throw new Error(_0x16eccf[_0x373901(0x10b)]);return{'messageId':_0x9e18b9['messageId'],'conversationId':_0x9e18b9['conversationId'],'parentMessageId':_0x9e18b9[_0x373901(0x112)],'sender':_0x9e18b9[_0x373901(0xf1)],'text':_0x9e18b9[_0x373901(0xee)],'isCreatedByUser':_0x9e18b9[_0x373901(0x111)],'tokenCount':_0x9e18b9[_0x373901(0xe3)],'isEdited':!![]};}catch(_0x30df93){logger['error'](_0x16eccf[_0x373901(0xdc)],_0x30df93);_0x5f1195&&_0x5f1195?.[_0x373901(0x116)]&&logger[_0x373901(0xed)]('---`updateMessage`\x20context:\x20'+_0x5f1195[_0x373901(0x116)]);throw _0x30df93;}}async function deleteMessagesSince(_0x34abfa,{messageId:_0x4041f9,conversationId:_0x1ab4c7}){const _0x309a84=_0x1b89c2;try{const _0x1385ef=await Message[_0x309a84(0xdf)]({'messageId':_0x4041f9,'user':_0x34abfa['user']['id']})['lean']();if(_0x1385ef){const _0x1c80f9=Message[_0x309a84(0xf6)]({'conversationId':_0x1ab4c7,'user':_0x34abfa['user']['id']});return await _0x1c80f9[_0x309a84(0x108)]({'createdAt':{'$gt':_0x1385ef[_0x309a84(0x118)]}});}return undefined;}catch(_0x48abe0){logger[_0x309a84(0xfe)](_0x309a84(0x106),_0x48abe0);throw _0x48abe0;}}async function getMessages(_0x54aaa2,_0x544e78){const _0x940b44=_0x1b89c2,_0x2fdb85={'uGdeb':_0x940b44(0x10e)};try{if(_0x544e78)return await Message[_0x940b44(0xf6)](_0x54aaa2)[_0x940b44(0x117)](_0x544e78)['sort']({'createdAt':0x1})['lean']();return await Message['find'](_0x54aaa2)[_0x940b44(0x10f)]({'createdAt':0x1})[_0x940b44(0xf2)]();}catch(_0x1a67b0){logger[_0x940b44(0xfe)](_0x2fdb85[_0x940b44(0x103)],_0x1a67b0);throw _0x1a67b0;}}async function getMessage({user:_0x5267c0,messageId:_0x20d188}){const _0x48149e=_0x1b89c2,_0xd9d889={'EmIdN':function(_0x3778c6,_0x2ad00a){return _0x3778c6!==_0x2ad00a;},'rpKvk':_0x48149e(0xf4),'NuFnz':_0x48149e(0xe2)};try{if(_0xd9d889[_0x48149e(0xf7)](_0xd9d889['rpKvk'],_0x48149e(0xfa)))return await Message[_0x48149e(0xdf)]({'user':_0x5267c0,'messageId':_0x20d188})[_0x48149e(0xf2)]();else{_0x5721fd[_0x48149e(0xfe)](_0x48149e(0xeb),_0x408bbc);throw _0x1b84c4;}}catch(_0x362f12){logger[_0x48149e(0xfe)](_0xd9d889[_0x48149e(0xfb)],_0x362f12);throw _0x362f12;}}async function deleteMessages(_0x9d71db){const _0x2fa754=_0x1b89c2,_0x31b024={'zjoWh':_0x2fa754(0xe7),'eUPtt':_0x2fa754(0x107)};try{return await Message[_0x2fa754(0x108)](_0x9d71db);}catch(_0x1f3d2e){if(_0x31b024[_0x2fa754(0xf5)]===_0x31b024[_0x2fa754(0xe6)]){_0x14c38b[_0x2fa754(0xfc)](_0x2fa754(0xef)+_0x3d8c41['conversationId']),_0x359227[_0x2fa754(0xed)](_0x2fa754(0xe1)+_0x5e0c6c?.[_0x2fa754(0x116)]),_0x578aa9['info'](_0x2fa754(0x10d)+_0x48d2a2[_0x2fa754(0xde)](_0x44dfb2,null,0x2));return;}else{logger[_0x2fa754(0xfe)](_0x2fa754(0x106),_0x1f3d2e);throw _0x1f3d2e;}}}module[_0x1b89c2(0x101)]={'Message':Message,'saveMessage':saveMessage,'bulkSaveMessages':bulkSaveMessages,'recordMessage':recordMessage,'updateMessageText':updateMessageText,'updateMessage':updateMessage,'deleteMessagesSince':deleteMessagesSince,'getMessages':getMessages,'getMessage':getMessage,'deleteMessages':deleteMessages};