const _0x3263ba=_0x4eba;function _0x4eba(_0x403b23,_0x2d4ce9){const _0x12c8ba=_0x12c8();return _0x4eba=function(_0x4ebaa5,_0x2b0f7a){_0x4ebaa5=_0x4ebaa5-0x99;let _0x356361=_0x12c8ba[_0x4ebaa5];return _0x356361;},_0x4eba(_0x403b23,_0x2d4ce9);}(function(_0x5891b6,_0x46777d){const _0x676805=_0x4eba,_0x4ae864=_0x5891b6();while(!![]){try{const _0x5154c7=parseInt(_0x676805(0xf3))/0x1*(-parseInt(_0x676805(0xc0))/0x2)+-parseInt(_0x676805(0x99))/0x3*(-parseInt(_0x676805(0x129))/0x4)+parseInt(_0x676805(0xa4))/0x5*(parseInt(_0x676805(0x101))/0x6)+parseInt(_0x676805(0x10f))/0x7+parseInt(_0x676805(0xb6))/0x8+parseInt(_0x676805(0xac))/0x9+-parseInt(_0x676805(0x11c))/0xa*(parseInt(_0x676805(0x127))/0xb);if(_0x5154c7===_0x46777d)break;else _0x4ae864['push'](_0x4ae864['shift']());}catch(_0x4acd20){_0x4ae864['push'](_0x4ae864['shift']());}}}(_0x12c8,0x9c6b2));const fs=require('fs'),path=require(_0x3263ba(0xd9)),mime=require('mime'),{v4}=require('uuid'),{isUUID,megabyte,FileContext,FileSources,imageExtRegex,EModelEndpoint,EToolResources,mergeFileConfig,hostImageIdSuffix,checkOpenAIStorage,removeNullishValues,hostImageNamePrefix,isAssistantsEndpoint}=require(_0x3263ba(0x138)),{EnvVar}=require(_0x3263ba(0x144)),{addResourceFileId,deleteResourceFileId}=require(_0x3263ba(0x10d)),{convertImage,resizeAndConvert}=require(_0x3263ba(0xae)),{addAgentResourceFile,removeAgentResourceFile}=require(_0x3263ba(0x9f)),{getOpenAIClient}=require(_0x3263ba(0xfd)),{createFile,updateFileUsage,deleteFiles}=require(_0x3263ba(0xb8)),{loadAuthValues}=require('~/app/clients/tools/util'),{LB_QueueAsyncCall}=require(_0x3263ba(0x109)),{getStrategyFunctions}=require(_0x3263ba(0x9c)),{determineFileType}=require(_0x3263ba(0xb9)),{logger}=require('~/config'),processFiles=async(_0x23f60e,_0x5b16e2)=>{const _0xb0e2bb=_0x3263ba,_0x4a82c6={'oFKCr':function(_0x330685,_0x4276a5){return _0x330685(_0x4276a5);},'LDkQb':function(_0x415871,_0x340942){return _0x415871(_0x340942);}},_0x47db73=[],_0x1678e1=new Set();for(let _0x163e02 of _0x23f60e){const {file_id:_0x4e13d9}=_0x163e02;if(_0x1678e1[_0xb0e2bb(0xdd)](_0x4e13d9))continue;_0x1678e1[_0xb0e2bb(0x11b)](_0x4e13d9),_0x47db73[_0xb0e2bb(0xdf)](_0x4a82c6[_0xb0e2bb(0xbd)](updateFileUsage,{'file_id':_0x4e13d9}));}if(!_0x5b16e2)return await Promise['all'](_0x47db73);for(let _0x1cab76 of _0x5b16e2){if(_0x1678e1[_0xb0e2bb(0xdd)](_0x1cab76))continue;_0x1678e1[_0xb0e2bb(0x11b)](_0x1cab76),_0x47db73['push'](_0x4a82c6['LDkQb'](updateFileUsage,{'file_id':_0x1cab76}));}return await Promise['all'](_0x47db73);};function enqueueDeleteOperation({req:_0x3036b0,file:_0x2de4e8,deleteFile:_0x5751a8,promises:_0xf2fda0,resolvedFileIds:_0x5efc6c,openai:_0x378e1a}){const _0x4d7174=_0x3263ba,_0x3855fd={'SiufI':function(_0x59024c,_0x5f03fd){return _0x59024c!==_0x5f03fd;},'QObOu':_0x4d7174(0xc1),'fHshG':function(_0x303360,_0x27b906){return _0x303360(_0x27b906);},'rysui':_0x4d7174(0xe5),'MktJv':function(_0xf6189f,_0x1bf56f,_0x7df0f6){return _0xf6189f(_0x1bf56f,_0x7df0f6);}};checkOpenAIStorage(_0x2de4e8[_0x4d7174(0x10e)])?_0xf2fda0[_0x4d7174(0xdf)](new Promise((_0x5470ee,_0x6f035d)=>{LB_QueueAsyncCall(()=>_0x5751a8(_0x3036b0,_0x2de4e8,_0x378e1a),[],(_0x5f0b60,_0xdb4cb3)=>{const _0x12c508=_0x4eba,_0x5d07a5={'rDOgn':'Error\x20deleting\x20file\x20from\x20OpenAI\x20source','cuEDc':function(_0x58fa9d,_0x260a39){return _0x58fa9d(_0x260a39);}};_0x3855fd['SiufI']('RLKqf','RFhQa')?_0x5f0b60?(logger['error'](_0x3855fd[_0x12c508(0xbe)],_0x5f0b60),_0x3855fd['fHshG'](_0x6f035d,_0x5f0b60)):(_0x5efc6c[_0x12c508(0xdf)](_0x2de4e8[_0x12c508(0x106)]),_0x5470ee(_0xdb4cb3)):(_0x51f81e[_0x12c508(0x10a)](_0x5d07a5[_0x12c508(0xf6)],_0x1e952d),_0x5d07a5[_0x12c508(0x141)](_0x16eaf6,_0x216a44));});})):_0xf2fda0[_0x4d7174(0xdf)](_0x3855fd[_0x4d7174(0xd1)](_0x5751a8,_0x3036b0,_0x2de4e8)[_0x4d7174(0xfc)](()=>_0x5efc6c[_0x4d7174(0xdf)](_0x2de4e8[_0x4d7174(0x106)]))['catch'](_0x4982bd=>{const _0x2a6166=_0x4d7174,_0x51c87d={'iPbQk':function(_0x2e51f7,_0x5ed050){return _0x3855fd['fHshG'](_0x2e51f7,_0x5ed050);}};if(_0x2a6166(0xe9)===_0x2a6166(0xd0))_0xd28556[_0x2a6166(0xdf)](_0x51c87d[_0x2a6166(0xb3)](_0x2200b2,{'req':_0xe098c3,'file_id':_0xa18036[_0x2a6166(0x106)],'agent_id':_0x56146f[_0x2a6166(0x126)]['agent_id'],'tool_resource':_0x36e8bc[_0x2a6166(0x126)][_0x2a6166(0xdb)]}));else return logger[_0x2a6166(0x10a)](_0x3855fd[_0x2a6166(0xb0)],_0x4982bd),Promise[_0x2a6166(0xe4)](_0x4982bd);}));}const processDeleteRequest=async({req:_0x5bd18e,files:_0x4acc4c})=>{const _0x33a28e=_0x3263ba,_0x26abce={'xfVwa':function(_0x3218e5,_0x3d7a31){return _0x3218e5(_0x3d7a31);},'WMhBW':function(_0x690724,_0x16d8ac){return _0x690724!==_0x16d8ac;},'bXokP':_0x33a28e(0xa0),'ZRAMx':_0x33a28e(0xe7),'mufjz':function(_0x7b331e,_0x442400,_0x3f2ea2,_0x3ae999){return _0x7b331e(_0x442400,_0x3f2ea2,_0x3ae999);},'uJFPE':function(_0x2baf3e,_0x24aa05){return _0x2baf3e!==_0x24aa05;},'gRmLG':_0x33a28e(0x112),'OTtHG':function(_0x5790f){return _0x5790f();},'PLMAp':_0x33a28e(0x9a),'WNRmm':_0x33a28e(0xa2),'XHrnU':function(_0x44c35e,_0x21e3fa){return _0x44c35e(_0x21e3fa);}},_0x592b7f=[],_0x45d462={},_0xd1b79f=[],_0x15fad8={[FileSources[_0x33a28e(0xbb)]]:undefined,[FileSources[_0x33a28e(0x12d)]]:undefined},_0x2359f8=async()=>{const _0x2f2250=_0x33a28e,_0x481534=await _0x26abce[_0x2f2250(0x114)](getOpenAIClient,{'req':_0x5bd18e,'overrideEndpoint':EModelEndpoint[_0x2f2250(0x134)]});_0x15fad8[FileSources[_0x2f2250(0xbb)]]=_0x481534['openai'];if(!_0x5bd18e[_0x2f2250(0xdc)][_0x2f2250(0xfb)][EModelEndpoint[_0x2f2250(0xb5)]]?.[_0x2f2250(0x134)]){if(_0x26abce[_0x2f2250(0x13f)]('QkKFw',_0x26abce[_0x2f2250(0xa5)]))return null;else return;}const _0x969797=await getOpenAIClient({'req':_0x5bd18e,'overrideEndpoint':EModelEndpoint[_0x2f2250(0x108)]});_0x15fad8[FileSources[_0x2f2250(0x12d)]]=_0x969797['openai'];};_0x26abce[_0x33a28e(0x13f)](_0x5bd18e[_0x33a28e(0x126)][_0x33a28e(0xcb)],undefined)&&await _0x2359f8();for(const _0x2c483d of _0x4acc4c){const _0x3b6c44=_0x2c483d[_0x33a28e(0x10e)]??FileSources[_0x33a28e(0x116)];_0x5bd18e['body'][_0x33a28e(0xf7)]&&_0x5bd18e[_0x33a28e(0x126)]['tool_resource']&&_0xd1b79f[_0x33a28e(0xdf)](removeAgentResourceFile({'req':_0x5bd18e,'file_id':_0x2c483d[_0x33a28e(0x106)],'agent_id':_0x5bd18e[_0x33a28e(0x126)][_0x33a28e(0xf7)],'tool_resource':_0x5bd18e[_0x33a28e(0x126)][_0x33a28e(0xdb)]}));if(checkOpenAIStorage(_0x3b6c44)&&!_0x15fad8[_0x3b6c44]){if(_0x26abce['uJFPE'](_0x33a28e(0xeb),_0x26abce[_0x33a28e(0xe3)]))await _0x26abce[_0x33a28e(0xab)](_0x2359f8);else throw new _0x299659(_0x26abce[_0x33a28e(0xde)]);}const _0x5769a7=_0x15fad8[_0x3b6c44];if(_0x5bd18e[_0x33a28e(0x126)][_0x33a28e(0xcb)]&&_0x5bd18e[_0x33a28e(0x126)]['tool_resource'])_0x26abce[_0x33a28e(0x11d)]!==_0x26abce[_0x33a28e(0x11d)]?_0x245a59[_0x33a28e(0xdf)](_0x1c52e0(_0x5b93a8,_0x6e4d17)[_0x33a28e(0xfc)](()=>_0x381e10[_0x33a28e(0xdf)](_0x5485e3[_0x33a28e(0x106)]))[_0x33a28e(0xbf)](_0xa17dec=>{const _0x34d629=_0x33a28e;return _0x1103f9['error'](_0x34d629(0xe5),_0xa17dec),_0x49a8ec['reject'](_0xa17dec);})):_0xd1b79f[_0x33a28e(0xdf)](deleteResourceFileId({'req':_0x5bd18e,'openai':_0x5769a7,'file_id':_0x2c483d[_0x33a28e(0x106)],'assistant_id':_0x5bd18e['body'][_0x33a28e(0xcb)],'tool_resource':_0x5bd18e[_0x33a28e(0x126)]['tool_resource']}));else{if(_0x5bd18e['body'][_0x33a28e(0xcb)]){if(_0x26abce[_0x33a28e(0x123)]!==_0x33a28e(0x10b))_0xd1b79f['push'](_0x5769a7['beta']['assistants'][_0x33a28e(0xcd)][_0x33a28e(0xed)](_0x5bd18e[_0x33a28e(0x126)]['assistant_id'],_0x2c483d[_0x33a28e(0x106)]));else{const _0x505f4e={'eBYzC':_0x33a28e(0xc1),'ZNDlC':function(_0xd1690b,_0x6e3220){return _0xd1690b(_0x6e3220);}};_0x26abce[_0x33a28e(0x135)](_0x35a4f3,()=>_0x44dce3(_0x32adb6,_0xcffc70,_0x148bf7),[],(_0x41d3ea,_0x5948b3)=>{const _0x558e7a=_0x33a28e;_0x41d3ea?(_0x36fe31[_0x558e7a(0x10a)](_0x505f4e[_0x558e7a(0x102)],_0x41d3ea),_0x505f4e['ZNDlC'](_0x17189b,_0x41d3ea)):(_0x2f9a42['push'](_0x8b7120[_0x558e7a(0x106)]),_0x505f4e[_0x558e7a(0x117)](_0x58ee99,_0x5948b3));});}}}if(_0x45d462[_0x3b6c44]){enqueueDeleteOperation({'req':_0x5bd18e,'file':_0x2c483d,'deleteFile':_0x45d462[_0x3b6c44],'promises':_0xd1b79f,'resolvedFileIds':_0x592b7f,'openai':_0x5769a7});continue;}const {deleteFile:_0x3a803b}=getStrategyFunctions(_0x3b6c44);if(!_0x3a803b)throw new Error(_0x33a28e(0xa7)+_0x3b6c44);_0x45d462[_0x3b6c44]=_0x3a803b,_0x26abce['XHrnU'](enqueueDeleteOperation,{'req':_0x5bd18e,'file':_0x2c483d,'deleteFile':_0x3a803b,'promises':_0xd1b79f,'resolvedFileIds':_0x592b7f,'openai':_0x5769a7});}await Promise['allSettled'](_0xd1b79f),await deleteFiles(_0x592b7f);},processFileURL=async({fileStrategy:_0x398260,userId:_0x1557ed,URL:_0xf3dfc0,fileName:_0x3d8a53,basePath:_0x2713a6,context:_0x3e3a7d})=>{const _0x1fa555=_0x3263ba,_0x3280f1={'QHkId':function(_0x27052e,_0x1ae461){return _0x27052e(_0x1ae461);}},{saveURL:_0x5100b8,getFileURL:_0x2c3ca7}=getStrategyFunctions(_0x398260);try{const {bytes:bytes=0x0,type:type='',dimensions:dimensions={}}=await _0x5100b8({'userId':_0x1557ed,'URL':_0xf3dfc0,'fileName':_0x3d8a53,'basePath':_0x2713a6})||{},_0x38f1aa=await _0x3280f1[_0x1fa555(0xaf)](_0x2c3ca7,{'fileName':_0x1557ed+'/'+_0x3d8a53,'basePath':_0x2713a6});return await createFile({'user':_0x1557ed,'file_id':v4(),'bytes':bytes,'filepath':_0x38f1aa,'filename':_0x3d8a53,'source':_0x398260,'type':type,'context':_0x3e3a7d,'width':dimensions['width'],'height':dimensions[_0x1fa555(0x11e)]},!![]);}catch(_0x144811){logger['error'](_0x1fa555(0xa3)+_0x398260+':',_0x144811);throw new Error('Failed\x20to\x20process\x20the\x20image\x20with\x20'+_0x398260+'.\x20'+_0x144811[_0x1fa555(0x130)]);}},processImageFile=async({req:_0x2fa905,res:_0x653e71,metadata:_0x3f435b,returnFile:returnFile=![]})=>{const _0x4591d0=_0x3263ba,_0x3cd22a={'HKZEY':function(_0x1704c5,_0x468e30){return _0x1704c5(_0x468e30);}},{file:_0x35b909}=_0x2fa905,_0x2b4248=_0x2fa905[_0x4591d0(0xdc)]['locals'][_0x4591d0(0x103)],{handleImageUpload:_0x4b24e5}=_0x3cd22a[_0x4591d0(0x119)](getStrategyFunctions,_0x2b4248),{file_id:_0xc0a3a8,temp_file_id:_0x103610,endpoint:_0x4214}=_0x3f435b,{filepath:_0x29c99a,bytes:_0x2a7dda,width:_0x33a607,height:_0x57891b}=await _0x4b24e5({'req':_0x2fa905,'file':_0x35b909,'file_id':_0xc0a3a8,'endpoint':_0x4214}),_0x5654ed=await createFile({'user':_0x2fa905['user']['id'],'file_id':_0xc0a3a8,'temp_file_id':_0x103610,'bytes':_0x2a7dda,'filepath':_0x29c99a,'filename':_0x35b909[_0x4591d0(0xbc)],'context':FileContext[_0x4591d0(0x140)],'source':_0x2b4248,'type':_0x4591d0(0xec)+_0x2fa905[_0x4591d0(0xdc)]['locals'][_0x4591d0(0x125)],'width':_0x33a607,'height':_0x57891b},!![]);if(returnFile)return _0x5654ed;_0x653e71[_0x4591d0(0xd3)](0xc8)['json']({'message':_0x4591d0(0xba),..._0x5654ed});},uploadImageBuffer=async({req:_0x5db4ec,context:_0x263b70,metadata:metadata={},resize:resize=!![]})=>{const _0x5a953d=_0x3263ba,_0x11dcac={'aUGDn':function(_0x106034,_0x503d88){return _0x106034(_0x503d88);}},_0x3972de=_0x5db4ec[_0x5a953d(0xdc)][_0x5a953d(0xfb)][_0x5a953d(0x103)],{saveBuffer:_0x58288a}=getStrategyFunctions(_0x3972de);let {buffer:_0x2f1a2e,width:_0x180cac,height:_0x181978,bytes:_0x59bfb2,filename:_0x66b5b,file_id:_0x548eed,type:_0x1c504d}=metadata;resize&&(_0x548eed=v4(),_0x1c504d='image/'+_0x5db4ec[_0x5a953d(0xdc)][_0x5a953d(0xfb)][_0x5a953d(0x125)],{buffer:_0x2f1a2e,width:_0x180cac,height:_0x181978,bytes:_0x59bfb2}=await resizeAndConvert({'inputBuffer':_0x2f1a2e,'desiredFormat':_0x5db4ec[_0x5a953d(0xdc)][_0x5a953d(0xfb)][_0x5a953d(0x125)]}),_0x66b5b=path[_0x5a953d(0x118)](_0x5db4ec[_0x5a953d(0x128)][_0x5a953d(0xbc)],path[_0x5a953d(0xa6)](_0x5db4ec[_0x5a953d(0x128)]['originalname']))+'.'+_0x5db4ec[_0x5a953d(0xdc)][_0x5a953d(0xfb)][_0x5a953d(0x125)]);const _0x8b495d=await _0x11dcac[_0x5a953d(0xd4)](_0x58288a,{'userId':_0x5db4ec[_0x5a953d(0x131)]['id'],'fileName':_0x66b5b,'buffer':_0x2f1a2e});return await createFile({'user':_0x5db4ec[_0x5a953d(0x131)]['id'],'file_id':_0x548eed,'bytes':_0x59bfb2,'filepath':_0x8b495d,'filename':_0x66b5b,'context':_0x263b70,'source':_0x3972de,'type':_0x1c504d,'width':_0x180cac,'height':_0x181978},!![]);},processFileUpload=async({req:_0x37ef3b,res:_0x169701,metadata:_0x293f3f})=>{const _0x3d166e=_0x3263ba,_0x3ed548={'YPFPK':function(_0x374a43,_0x43ee31){return _0x374a43(_0x43ee31);},'NaiUq':_0x3d166e(0xb1),'JZOCI':function(_0x138de9,_0x451414){return _0x138de9===_0x451414;},'APvXf':function(_0xf95a95,_0x2ba0c0){return _0xf95a95??_0x2ba0c0;},'LzCEt':'File\x20uploaded\x20and\x20processed\x20successfully'},_0x47c0e5=_0x3ed548[_0x3d166e(0xe0)](isAssistantsEndpoint,_0x293f3f[_0x3d166e(0x12e)]),_0x32daff=_0x293f3f['endpoint']===EModelEndpoint['azureAssistants']?FileSources['azure']:FileSources[_0x3d166e(0xbb)],_0x5e7d6a=_0x47c0e5?_0x32daff:FileSources[_0x3d166e(0xfe)],{handleFileUpload:_0x34d11f}=getStrategyFunctions(_0x5e7d6a),{file_id:_0xf9a477,temp_file_id:_0x1f4ce8}=_0x293f3f;let _0x5d0df7;checkOpenAIStorage(_0x5e7d6a)&&({openai:_0x5d0df7}=await _0x3ed548['YPFPK'](getOpenAIClient,{'req':_0x37ef3b}));const {file:_0x3be978}=_0x37ef3b,{id:_0x146958,bytes:_0x5e502c,filename:_0x1691fe,filepath:_0x2ffbe3,embedded:_0x343f40,height:_0x241171,width:_0x5a5c7e}=await _0x34d11f({'req':_0x37ef3b,'file':_0x3be978,'file_id':_0xf9a477,'openai':_0x5d0df7});if(_0x47c0e5&&!_0x293f3f[_0x3d166e(0x10c)]&&!_0x293f3f[_0x3d166e(0xdb)])await _0x5d0df7[_0x3d166e(0xef)][_0x3d166e(0x134)][_0x3d166e(0xcd)][_0x3d166e(0xf4)](_0x293f3f['assistant_id'],{'file_id':_0x146958});else _0x47c0e5&&!_0x293f3f['message_file']&&await _0x3ed548[_0x3d166e(0xe0)](addResourceFileId,{'req':_0x37ef3b,'openai':_0x5d0df7,'file_id':_0x146958,'assistant_id':_0x293f3f[_0x3d166e(0xcb)],'tool_resource':_0x293f3f[_0x3d166e(0xdb)]});let _0x260709=_0x47c0e5?_0x5d0df7['baseURL']+_0x3d166e(0xf9)+_0x146958:_0x2ffbe3;if(_0x47c0e5&&_0x3be978[_0x3d166e(0xb4)][_0x3d166e(0xce)](_0x3ed548[_0x3d166e(0x111)])){if(_0x3ed548[_0x3d166e(0xa8)](_0x3d166e(0xe1),'QyDJT'))return _0x56a160[_0x3d166e(0x10a)](_0x3d166e(0xe5),_0x36e178),_0x5e807e[_0x3d166e(0xe4)](_0x291097);else{const _0x1f1325=await processImageFile({'req':_0x37ef3b,'file':_0x3be978,'metadata':{'file_id':v4()},'returnFile':!![]});_0x260709=_0x1f1325[_0x3d166e(0xd2)];}}const _0x29ea23=await createFile({'user':_0x37ef3b[_0x3d166e(0x131)]['id'],'file_id':_0x3ed548['APvXf'](_0x146958,_0xf9a477),'temp_file_id':_0x1f4ce8,'bytes':_0x5e502c,'filepath':_0x260709,'filename':_0x1691fe??_0x3be978[_0x3d166e(0xbc)],'context':_0x47c0e5?FileContext[_0x3d166e(0x134)]:FileContext[_0x3d166e(0x140)],'model':_0x47c0e5?_0x37ef3b[_0x3d166e(0x126)][_0x3d166e(0x12a)]:undefined,'type':_0x3be978[_0x3d166e(0xb4)],'embedded':_0x343f40,'source':_0x5e7d6a,'height':_0x241171,'width':_0x5a5c7e},!![]);_0x169701[_0x3d166e(0xd3)](0xc8)['json']({'message':_0x3ed548['LzCEt'],..._0x29ea23});},processAgentFileUpload=async({req:_0x295c0,res:_0x58fa44,metadata:_0x3b7b64})=>{const _0x18c92f=_0x3263ba,_0x4026bc={'DWHXr':function(_0x1707f7,_0x2619c5){return _0x1707f7&&_0x2619c5;},'vJEjx':_0x18c92f(0xc5),'qVGVF':'Image\x20uploads\x20are\x20not\x20supported\x20for\x20file\x20search\x20tool\x20resources','cAZFk':function(_0x43f6bb,_0xdd4d2f){return _0x43f6bb===_0xdd4d2f;},'YGjzM':function(_0x4019c1,_0x151700){return _0x4019c1(_0x151700);},'iVXSv':function(_0x5b572f,_0x5dcc2d){return _0x5b572f(_0x5dcc2d);},'edRcp':function(_0x5cab1e,_0x2cf69e){return _0x5cab1e&&_0x2cf69e;},'WiBae':function(_0x3d205d,_0x464eea){return _0x3d205d(_0x464eea);},'BXOKG':'image','YTgCm':function(_0x13b15b,_0x57afa7,_0x1c4685){return _0x13b15b(_0x57afa7,_0x1c4685);}},{file:_0x254f24}=_0x295c0,{agent_id:_0x1132f4,tool_resource:_0x23a1de}=_0x3b7b64;if(_0x4026bc[_0x18c92f(0x133)](_0x1132f4,!_0x23a1de))throw new Error(_0x18c92f(0xaa));if(_0x23a1de===EToolResources[_0x18c92f(0x12c)]&&_0x254f24[_0x18c92f(0xb4)][_0x18c92f(0xce)](_0x18c92f(0xb1))){if(_0x4026bc[_0x18c92f(0x9b)]!==_0x18c92f(0xc5))throw new _0x4ef857(_0x18c92f(0xd7));else throw new Error(_0x4026bc['qVGVF']);}let _0x446a45=!!_0x3b7b64['message_file'];if(!_0x446a45&&!_0x1132f4)throw new Error('No\x20agent\x20ID\x20provided\x20for\x20agent\x20file\x20upload');let _0x54ac73;if(_0x4026bc['cAZFk'](_0x23a1de,EToolResources['execute_code'])){const {handleFileUpload:_0x3b6048}=_0x4026bc[_0x18c92f(0xc6)](getStrategyFunctions,FileSources['execute_code']),_0x209977=await loadAuthValues({'userId':_0x295c0[_0x18c92f(0x131)]['id'],'authFields':[EnvVar[_0x18c92f(0xa1)]]}),_0x24184e=fs['createReadStream'](_0x254f24[_0x18c92f(0xd9)]),_0x71a624=await _0x4026bc[_0x18c92f(0xc6)](_0x3b6048,{'req':_0x295c0,'stream':_0x24184e,'filename':_0x254f24[_0x18c92f(0xbc)],'apiKey':_0x209977[EnvVar['CODE_API_KEY']],'entity_id':_0x4026bc['cAZFk'](_0x446a45,!![])?undefined:_0x1132f4});_0x54ac73={'fileIdentifier':_0x71a624};}const _0x56c07a=_0x4026bc[_0x18c92f(0xcf)](_0x23a1de,EToolResources[_0x18c92f(0x12c)])?FileSources[_0x18c92f(0xfe)]:_0x295c0[_0x18c92f(0xdc)]['locals']['fileStrategy'],{handleFileUpload:_0x3e37f8}=_0x4026bc[_0x18c92f(0x13e)](getStrategyFunctions,_0x56c07a),{file_id:_0x3dc314,temp_file_id:_0x2803bf}=_0x3b7b64,{bytes:_0x42c3b6,filename:_0x5799dc,filepath:_0x4ab712,embedded:_0x1ed355,height:_0x468ac0,width:_0x44a6a3}=await _0x3e37f8({'req':_0x295c0,'file':_0x254f24,'file_id':_0x3dc314});let _0x31c00d=_0x4ab712;_0x4026bc['edRcp'](!_0x446a45,_0x23a1de)&&await _0x4026bc[_0x18c92f(0xd6)](addAgentResourceFile,{'req':_0x295c0,'file_id':_0x3dc314,'agent_id':_0x1132f4,'tool_resource':_0x23a1de});if(_0x254f24[_0x18c92f(0xb4)]['startsWith'](_0x4026bc['BXOKG'])){const _0x36371f=await _0x4026bc[_0x18c92f(0xc6)](processImageFile,{'req':_0x295c0,'file':_0x254f24,'metadata':{'file_id':v4()},'returnFile':!![]});_0x31c00d=_0x36371f['filepath'];}const _0x3e2603=removeNullishValues({'user':_0x295c0[_0x18c92f(0x131)]['id'],'file_id':_0x3dc314,'temp_file_id':_0x2803bf,'bytes':_0x42c3b6,'filepath':_0x31c00d,'filename':_0x5799dc??_0x254f24['originalname'],'context':_0x446a45?FileContext[_0x18c92f(0x140)]:FileContext[_0x18c92f(0x142)],'model':_0x446a45?undefined:_0x295c0[_0x18c92f(0x126)][_0x18c92f(0x12a)],'metadata':_0x54ac73,'type':_0x254f24[_0x18c92f(0xb4)],'embedded':_0x1ed355,'source':_0x56c07a,'height':_0x468ac0,'width':_0x44a6a3}),_0x5a3cbe=await _0x4026bc[_0x18c92f(0x110)](createFile,_0x3e2603,!![]);_0x58fa44[_0x18c92f(0xd3)](0xc8)[_0x18c92f(0x13a)]({'message':_0x18c92f(0x107),..._0x5a3cbe});},processOpenAIFile=async({openai:_0x52eaf8,file_id:_0x59809d,userId:_0x3ee3ff,filename:_0x51caf2,saveFile:saveFile=![],updateUsage:updateUsage=![]})=>{const _0xd1eacd=_0x3263ba,_0x29737f={'UdqAa':function(_0x45f0d2,_0x1bc85c){return _0x45f0d2===_0x1bc85c;},'bznWM':function(_0x5dd219,_0x1c1005,_0x28c4e9){return _0x5dd219(_0x1c1005,_0x28c4e9);},'ozJQL':function(_0x42fd0b,_0x5bacd3){return _0x42fd0b(_0x5bacd3);}},_0x53cad1=await _0x52eaf8[_0xd1eacd(0xcd)][_0xd1eacd(0xda)](_0x59809d),_0x511a9e=_0x51caf2??(_0x53cad1[_0xd1eacd(0x137)]?path[_0xd1eacd(0x118)](_0x53cad1[_0xd1eacd(0x137)]):undefined),_0x23a417=_0x52eaf8[_0xd1eacd(0x104)]+_0xd1eacd(0xf9)+_0x3ee3ff+'/'+_0x59809d+(_0x511a9e?'/'+_0x511a9e:''),_0x4f82b7=mime['getType'](_0x511a9e??_0x59809d),_0x3d5dfe=_0x29737f[_0xd1eacd(0xc7)](_0x52eaf8['req'][_0xd1eacd(0x126)][_0xd1eacd(0x12e)],EModelEndpoint[_0xd1eacd(0x108)])?FileSources[_0xd1eacd(0x12d)]:FileSources[_0xd1eacd(0xbb)],_0x1057f8={..._0x53cad1,'type':_0x4f82b7,'file_id':_0x59809d,'filepath':_0x23a417,'usage':0x1,'user':_0x3ee3ff,'context':_0x53cad1[_0xd1eacd(0x13b)],'source':_0x3d5dfe,'model':_0x52eaf8['req'][_0xd1eacd(0x126)][_0xd1eacd(0x12a)],'filename':_0x511a9e??_0x59809d};if(saveFile)await _0x29737f[_0xd1eacd(0xea)](createFile,_0x1057f8,!![]);else{if(updateUsage)try{await _0x29737f[_0xd1eacd(0x120)](updateFileUsage,{'file_id':_0x59809d});}catch(_0x4a1b36){logger[_0xd1eacd(0x10a)]('Error\x20updating\x20file\x20usage',_0x4a1b36);}}return _0x1057f8;},processOpenAIImageOutput=async({req:_0x224e0b,buffer:_0x487776,file_id:_0xe31e13,filename:_0x1491db,fileExt:_0x39b29d})=>{const _0x377aec=_0x3263ba,_0x7bf586={'yYQfj':function(_0x571b42,_0x37a1e4,_0x5a190e,_0x2ec634,_0x4d148d){return _0x571b42(_0x37a1e4,_0x5a190e,_0x2ec634,_0x4d148d);},'BTNWT':_0x377aec(0xc4),'wRRnM':function(_0x806811,_0x368b57){return _0x806811===_0x368b57;}},_0x195326=new Date(),_0x29e7a4=_0x195326[_0x377aec(0x11a)](),_0x144fbd=await _0x7bf586[_0x377aec(0x105)](convertImage,_0x224e0b,_0x487776,_0x7bf586['BTNWT'],''+_0xe31e13+_0x39b29d),_0x28bb8d={..._0x144fbd,'usage':0x1,'user':_0x224e0b[_0x377aec(0x131)]['id'],'type':_0x377aec(0xec)+_0x224e0b[_0x377aec(0xdc)][_0x377aec(0xfb)][_0x377aec(0x125)],'createdAt':_0x29e7a4,'updatedAt':_0x29e7a4,'source':_0x224e0b[_0x377aec(0xdc)][_0x377aec(0xfb)][_0x377aec(0x103)],'context':FileContext[_0x377aec(0x132)],'file_id':''+_0xe31e13+hostImageIdSuffix,'filename':''+hostImageNamePrefix+_0x1491db};createFile(_0x28bb8d,!![]);const _0x5e2b11=_0x7bf586['wRRnM'](_0x224e0b[_0x377aec(0x126)][_0x377aec(0x12e)],EModelEndpoint['azureAssistants'])?FileSources['azure']:FileSources['openai'];return createFile({..._0x28bb8d,'file_id':_0xe31e13,'filename':_0x1491db,'source':_0x5e2b11,'type':mime[_0x377aec(0x9e)](_0x39b29d)},!![]),_0x28bb8d;};async function retrieveAndProcessFile({openai:_0x560d85,client:_0x269c8e,file_id:_0x172f72,basename:_0xe5c92c,unknownType:_0x37a19f}){const _0x26a04a=_0x3263ba,_0x2474d8={'JAFOv':function(_0x19b150,_0x38cd0d){return _0x19b150(_0x38cd0d);},'vZlXw':function(_0x24dbc4,_0x494525){return _0x24dbc4(_0x494525);},'upOYa':function(_0xdc81c6,_0x5d87a1){return _0xdc81c6!==_0x5d87a1;},'oBkTU':_0x26a04a(0xa9),'nDeLG':_0x26a04a(0xcc),'mzNFc':function(_0x4cfaca,_0xc44f85){return _0x4cfaca||_0xc44f85;},'fhscS':function(_0x192131,_0x5209c8){return _0x192131===_0x5209c8;},'abCGm':function(_0x563f1f,_0x2b12e8){return _0x563f1f+_0x2b12e8;},'gIHmI':function(_0x1d0f9c,_0x34002b){return _0x1d0f9c(_0x34002b);},'HTNSz':function(_0x558a0d,_0x1d7d17){return _0x558a0d(_0x1d7d17);}};if(!_0x172f72)return null;let _0x5a9bc3=_0xe5c92c;const _0x276350={'openai':_0x560d85,'file_id':_0x172f72,'filename':_0x5a9bc3,'userId':_0x269c8e[_0x26a04a(0x12f)]['user']['id']};if(!_0x5a9bc3)return await _0x2474d8[_0x26a04a(0x115)](processOpenAIFile,{..._0x276350,'saveFile':!![]});const _0x24e3ed=path['extname'](_0x5a9bc3);if(_0x269c8e[_0x26a04a(0x122)]?.[_0x26a04a(0xdd)](_0x172f72)||_0x269c8e[_0x26a04a(0x113)]?.['has'](_0x172f72))return _0x2474d8[_0x26a04a(0x100)](processOpenAIFile,{..._0x276350,'updateUsage':!![]});const _0x4375ca=async()=>{const _0x9f78e1=_0x26a04a,_0x5cc770=await _0x560d85[_0x9f78e1(0xcd)][_0x9f78e1(0xf5)](_0x172f72),_0x576cf3=await _0x5cc770[_0x9f78e1(0xf1)]();return Buffer[_0x9f78e1(0x9d)](_0x576cf3);};let _0xb08de;if(_0x37a19f||!_0x24e3ed||imageExtRegex[_0x26a04a(0xb7)](_0x5a9bc3))try{_0xb08de=await _0x4375ca();}catch(_0x245c2d){_0x2474d8['upOYa'](_0x26a04a(0xe2),_0x2474d8['oBkTU'])?(logger['error'](_0x2474d8[_0x26a04a(0xe8)],_0x245c2d),_0xb08de=null):(_0x147c2e['error'](_0x26a04a(0xcc),_0x1137c4),_0x34ca52=null);}if(!_0xb08de)return await processOpenAIFile({..._0x276350,'saveFile':!![]});if(_0xb08de&&_0x2474d8['mzNFc'](_0x37a19f,!_0x24e3ed)){if(_0x2474d8[_0x26a04a(0x13d)]('RMtwn',_0x26a04a(0x11f)))return;else{const _0x5cf232=await determineFileType(_0xb08de),_0xac4ad8=_0x5cf232&&imageExtRegex[_0x26a04a(0xb7)](_0x2474d8[_0x26a04a(0xb2)]('.',_0x5cf232));if(!_0xac4ad8)return await processOpenAIFile({..._0x276350,'saveFile':!![]});return await processOpenAIImageOutput({'file_id':_0x172f72,'req':_0x269c8e[_0x26a04a(0x12f)],'buffer':_0xb08de,'filename':_0x5a9bc3,'fileExt':_0x5cf232});}}else{if(_0xb08de&&imageExtRegex[_0x26a04a(0xb7)](_0x5a9bc3)){if(_0x26a04a(0x121)!==_0x26a04a(0x121))throw new _0x3c342b(_0x26a04a(0xfa));else return await _0x2474d8[_0x26a04a(0x139)](processOpenAIImageOutput,{'file_id':_0x172f72,'req':_0x269c8e[_0x26a04a(0x12f)],'buffer':_0xb08de,'filename':_0x5a9bc3,'fileExt':_0x24e3ed});}else return logger['debug']('[retrieveAndProcessFile]\x20Non-image\x20file\x20type\x20detected:\x20'+_0x5a9bc3),await _0x2474d8['HTNSz'](processOpenAIFile,{..._0x276350,'saveFile':!![]});}}function filterFile({req:_0x45ccba,image:_0x523410,isAvatar:_0x980a69}){const _0x29e605=_0x3263ba,_0x59e266={'lGdso':function(_0x7c973,_0x5b5bcf){return _0x7c973/_0x5b5bcf;},'Zwrpd':function(_0xb50c7,_0x582171){return _0xb50c7!==_0x582171;},'eCwqX':'GMwAD','TDLpL':function(_0x53ea2d,_0x25d311){return _0x53ea2d===_0x25d311;},'KqhaF':'Empty\x20file\x20uploaded','PzQoV':'No\x20endpoint\x20provided','gOZkt':function(_0x4884c7,_0x4b1ad7){return _0x4884c7(_0x4b1ad7);},'hIOUQ':function(_0x56ff79,_0x84147c){return _0x56ff79>_0x84147c;},'ROBJC':_0x29e605(0xe7),'vOVuR':'No\x20height\x20provided'},{file:_0x541182}=_0x45ccba,{endpoint:_0x284b8a,file_id:_0x361aa1,width:_0x422afe,height:_0x19899a}=_0x45ccba[_0x29e605(0x126)];if(!_0x361aa1&&!_0x980a69){if(_0x59e266[_0x29e605(0xff)](_0x29e605(0x143),_0x59e266[_0x29e605(0xee)]))throw new _0x5db347(_0x29e605(0xd8)+_0x59e266[_0x29e605(0xc9)](_0x383df0,_0x2aa843)+_0x29e605(0x136)+(_0x52ba7c?'avatar\x20upload':_0x4e581b+_0x29e605(0xf8)));else throw new Error(_0x29e605(0xc2));}if(_0x59e266['TDLpL'](_0x541182[_0x29e605(0xf2)],0x0))throw new Error(_0x59e266[_0x29e605(0xe6)]);!_0x980a69&&isUUID[_0x29e605(0xf0)](_0x361aa1);if(!_0x284b8a&&!_0x980a69)throw new Error(_0x59e266[_0x29e605(0x13c)]);const _0x2931bd=_0x59e266[_0x29e605(0x124)](mergeFileConfig,_0x45ccba[_0x29e605(0xdc)][_0x29e605(0xfb)]['fileConfig']),{fileSizeLimit:_0x503354,supportedMimeTypes:_0x13d0f7}=_0x2931bd[_0x29e605(0x12b)][_0x284b8a]??_0x2931bd['endpoints'][_0x29e605(0xad)],_0x344b04=_0x980a69===!![]?_0x2931bd[_0x29e605(0xc3)]:_0x503354;if(_0x59e266['hIOUQ'](_0x541182[_0x29e605(0xf2)],_0x344b04))throw new Error(_0x29e605(0xd8)+_0x59e266[_0x29e605(0xc9)](_0x344b04,megabyte)+_0x29e605(0x136)+(_0x980a69?'avatar\x20upload':_0x284b8a+_0x29e605(0xf8)));const _0x2f28e6=_0x2931bd['checkType'](_0x541182[_0x29e605(0xb4)],_0x13d0f7);if(!_0x2f28e6){if('coLbQ'===_0x29e605(0xca))throw new Error(_0x29e605(0xd7));else throw new _0x17ae43(_0x29e605(0xaa));}if(!_0x523410||_0x59e266[_0x29e605(0xd5)](_0x980a69,!![]))return;if(!_0x422afe)throw new Error(_0x59e266['ROBJC']);if(!_0x19899a)throw new Error(_0x59e266[_0x29e605(0xc8)]);}function _0x12c8(){const _0x152de7=['bXokP','extname','Delete\x20function\x20not\x20implemented\x20for\x20','JZOCI','YVrlt','No\x20tool\x20resource\x20provided\x20for\x20agent\x20file\x20upload','OTtHG','8586234NEQPoD','default','~/server/services/Files/images','QHkId','rysui','image','abCGm','iPbQk','mimetype','azureOpenAI','3359872PhfTmS','test','~/models/File','~/server/utils','File\x20uploaded\x20and\x20processed\x20successfully','openai','originalname','oFKCr','QObOu','catch','4hyPgIJ','Error\x20deleting\x20file\x20from\x20OpenAI\x20source','No\x20file_id\x20provided','avatarSizeLimit','high','jcCDW','YGjzM','UdqAa','vOVuR','lGdso','coLbQ','assistant_id','Error\x20downloading\x20file\x20from\x20OpenAI:','files','startsWith','cAZFk','qSbia','MktJv','filepath','status','aUGDn','TDLpL','WiBae','Unsupported\x20file\x20type','File\x20size\x20limit\x20of\x20','path','retrieve','tool_resource','app','has','ZRAMx','push','YPFPK','bylAN','GnWuC','gRmLG','reject','Error\x20deleting\x20file','KqhaF','No\x20width\x20provided','nDeLG','eTYVR','bznWM','HOGRA','image/','del','eCwqX','beta','parse','arrayBuffer','size','173395EGmedF','create','content','rDOgn','agent_id','\x20endpoint','/files/','No\x20height\x20provided','locals','then','~/server/controllers/assistants/helpers','vectordb','Zwrpd','vZlXw','3909786rHPvWO','eBYzC','fileStrategy','baseURL','yYQfj','file_id','Agent\x20file\x20uploaded\x20and\x20processed\x20successfully','azureAssistants','~/server/utils/queue','error','fgGbL','message_file','~/server/controllers/assistants/v2','source','8712683ujSWmV','YTgCm','NaiUq','YRfIV','processedFileIds','xfVwa','JAFOv','local','ZNDlC','basename','HKZEY','toISOString','add','10GweBEh','PLMAp','height','qdkPI','ozJQL','yqpQZ','attachedFileIds','WNRmm','gOZkt','imageOutputType','body','28547123ChBFFJ','file','54324jNOPWw','model','endpoints','file_search','azure','endpoint','req','message','user','assistants_output','DWHXr','assistants','mufjz','\x20MB\x20exceeded\x20for\x20','filename','librechat-data-provider','gIHmI','json','purpose','PzQoV','fhscS','iVXSv','WMhBW','message_attachment','cuEDc','agents','GMwAD','@librechat/agents','69HQwLDj','blIOH','vJEjx','./strategies','from','getType','~/models/Agent','QkKFw','CODE_API_KEY','SHOyf','Error\x20while\x20processing\x20the\x20image\x20with\x20','5ebqGUd'];_0x12c8=function(){return _0x152de7;};return _0x12c8();}module['exports']={'filterFile':filterFile,'processFiles':processFiles,'processFileURL':processFileURL,'processImageFile':processImageFile,'uploadImageBuffer':uploadImageBuffer,'processFileUpload':processFileUpload,'processDeleteRequest':processDeleteRequest,'processAgentFileUpload':processAgentFileUpload,'retrieveAndProcessFile':retrieveAndProcessFile};