const _0x3ad3d4=_0x43a6;(function(_0x10970e,_0x5ce69b){const _0x132548=_0x43a6,_0x5b6358=_0x10970e();while(!![]){try{const _0x42568d=parseInt(_0x132548(0xe8))/0x1+parseInt(_0x132548(0xc8))/0x2*(-parseInt(_0x132548(0xba))/0x3)+-parseInt(_0x132548(0xc0))/0x4*(parseInt(_0x132548(0xf3))/0x5)+-parseInt(_0x132548(0xf0))/0x6+parseInt(_0x132548(0xb4))/0x7*(-parseInt(_0x132548(0xc1))/0x8)+-parseInt(_0x132548(0xca))/0x9*(parseInt(_0x132548(0xc3))/0xa)+parseInt(_0x132548(0xb0))/0xb;if(_0x42568d===_0x5ce69b)break;else _0x5b6358['push'](_0x5b6358['shift']());}catch(_0x44cfaa){_0x5b6358['push'](_0x5b6358['shift']());}}}(_0x5d81,0x1f041));function _0x5d81(){const _0x32c325=['locals','EQwAf','1449588ThQbBf','\x1b[31m[STREAMING\x20DISABLED]\x1b[0m\x20Streaming\x20is\x20not\x20available\x20for\x20','name','62585VbNoxY','../helpers','.\x20Will\x20use\x20regular\x20chat\x20method.','../../models/embedChats','desc','LDzVi','9837454nfTeHB','streamGetChatCompletion','log','../helpers/chat/responses','7bSkzuZ','uuid','streamingEnabled','connection','xrjUM','allow_prompt_override','733269LWuFys','pinnedDocs','getChatCompletion','performSimilaritySearch','then','QugNo','4rQrFlO','1426792biWPcv','similarityThreshold','1640WpyycM','\x20found.','isSafe','reverse','I\x20do\x20not\x20have\x20enough\x20information\x20to\x20answer\x20that.\x20Try\x20another\x20question.','2GNZNXc','message','6354pyOfKK','umgzT','aRKJQ','openAiTemp','slice','bQnBI','namespaceCount','new','ZTYqs','...continued\x20on\x20in\x20source\x20document...','push','openAiPrompt','Failed\x20to\x20connect\x20to\x20vector\x20database\x20provider.','arAks','iKjAR','join','constructor','topN','exports','allow_model_override','allow_temperature_override','query','textResponse','Ulhvy','forEach','sources','limits','workspace','This\x20message\x20was\x20moderated\x20and\x20will\x20not\x20be\x20allowed.\x20Violations\x20for\x20','length','25398cwzTqU','abort','defaultTemp','textResponseChunk','ubjPf','./index'];_0x5d81=function(){return _0x32c325;};return _0x5d81();}function _0x43a6(_0x1fa6e0,_0x28fd0e){const _0x5d8125=_0x5d81();return _0x43a6=function(_0x43a6e9,_0x114eb9){_0x43a6e9=_0x43a6e9-0xaf;let _0x420924=_0x5d8125[_0x43a6e9];return _0x420924;},_0x43a6(_0x1fa6e0,_0x28fd0e);}const {v4:uuidv4}=require(_0x3ad3d4(0xb5)),{getVectorDbClass,getLLMProvider}=require(_0x3ad3d4(0xf4)),{chatPrompt}=require(_0x3ad3d4(0xed)),{EmbedChats}=require(_0x3ad3d4(0xf6)),{convertToPromptHistory,writeResponseChunk}=require(_0x3ad3d4(0xb3)),{DocumentManager}=require('../DocumentManager');async function streamChatWithForEmbed(_0x552fdc,_0x2eaa50,_0x4538e8,_0x1af218,{promptOverride:_0x41e564,modelOverride:_0x141249,temperatureOverride:_0x5e88a0}){const _0x23beb2=_0x3ad3d4,_0xc400f2={'QugNo':function(_0x5ab600,_0x4647bc){return _0x5ab600(_0x4647bc);},'iKjAR':function(_0x5a6bfe){return _0x5a6bfe();},'umgzT':function(_0x586338,_0x435591){return _0x586338===_0x435591;},'aRKJQ':_0x23beb2(0xdf),'ZTYqs':_0x23beb2(0xe0),'ubjPf':_0x23beb2(0xc7),'arAks':function(_0x59819a,_0x3c8cb4){return _0x59819a!==_0x3c8cb4;},'YNwEF':function(_0x12aef1,_0x455c2b,_0x57f2c0){return _0x12aef1(_0x455c2b,_0x57f2c0);},'xmOrO':function(_0x12ba03,_0x726408){return _0x12ba03!==_0x726408;},'xrjUM':_0x23beb2(0xcf),'QVfvP':function(_0x28ea9c,_0x367e80){return _0x28ea9c!==_0x367e80;}},_0x1b53ee=_0x2eaa50['chat_mode'],_0x1fabd5=_0x2eaa50[_0x23beb2(0xdd)]?_0x141249:null;if(_0x2eaa50[_0x23beb2(0xb9)])_0x2eaa50[_0x23beb2(0xe5)][_0x23beb2(0xd5)]=_0x41e564;if(_0x2eaa50[_0x23beb2(0xde)])_0x2eaa50[_0x23beb2(0xe5)][_0x23beb2(0xcd)]=_0xc400f2['QugNo'](parseFloat,_0x5e88a0);const _0x519282=_0xc400f2[_0x23beb2(0xd8)](uuidv4),_0x5b089d=_0xc400f2[_0x23beb2(0xbf)](getLLMProvider,{'model':_0x1fabd5??_0x2eaa50[_0x23beb2(0xe5)]?.['chatModel']}),_0x53c68b=_0xc400f2[_0x23beb2(0xd8)](getVectorDbClass),{safe:_0x4b9d82,reasons:reasons=[]}=await _0x5b089d[_0x23beb2(0xc5)](_0x4538e8);if(!_0x4b9d82){writeResponseChunk(_0x552fdc,{'id':_0x519282,'type':_0x23beb2(0xe9),'textResponse':null,'sources':[],'close':!![],'error':_0x23beb2(0xe6)+reasons[_0x23beb2(0xd9)](',\x20')+_0x23beb2(0xc4)});return;}const _0x2a418a=0x14,_0xb1a74b=await _0x53c68b['hasNamespace'](_0x2eaa50[_0x23beb2(0xe5)]['slug']),_0x53474e=await _0x53c68b[_0x23beb2(0xd0)](_0x2eaa50[_0x23beb2(0xe5)]['slug']);if((!_0xb1a74b||_0x53474e===0x0)&&_0xc400f2[_0x23beb2(0xcb)](_0x1b53ee,_0xc400f2[_0x23beb2(0xcc)])){writeResponseChunk(_0x552fdc,{'id':_0x519282,'type':_0xc400f2[_0x23beb2(0xd2)],'textResponse':_0xc400f2[_0x23beb2(0xec)],'sources':[],'close':!![],'error':null});return;}let _0xc93a8f,_0x420d5a=[],_0x4c4a39=[];const {rawHistory:_0x2b1faf,chatHistory:_0x19c8be}=await recentEmbedChatHistory(_0x1af218,_0x2eaa50,_0x2a418a,_0x1b53ee);await new DocumentManager({'workspace':_0x2eaa50[_0x23beb2(0xe5)],'maxTokens':_0x5b089d[_0x23beb2(0xe4)]['system']})[_0x23beb2(0xbb)]()[_0x23beb2(0xbe)](_0x38af3d=>{const _0x119162=_0x23beb2,_0xde1582={'LDzVi':_0x119162(0xd3)};_0x38af3d[_0x119162(0xe2)](_0x2b364f=>{const _0x5a5ff3=_0x119162,{pageContent:_0x11d0f7,..._0x46bce8}=_0x2b364f;_0x420d5a[_0x5a5ff3(0xd4)](_0x2b364f['pageContent']),_0x4c4a39[_0x5a5ff3(0xd4)]({'text':_0x11d0f7[_0x5a5ff3(0xce)](0x0,0x3e8)+_0xde1582[_0x5a5ff3(0xaf)],..._0x46bce8});});});const _0x36aa6c=_0xc400f2[_0x23beb2(0xd7)](_0x53474e,0x0)?await _0x53c68b[_0x23beb2(0xbd)]({'namespace':_0x2eaa50[_0x23beb2(0xe5)]['slug'],'input':_0x4538e8,'LLMConnector':_0x5b089d,'similarityThreshold':_0x2eaa50[_0x23beb2(0xe5)]?.[_0x23beb2(0xc2)],'topN':_0x2eaa50[_0x23beb2(0xe5)]?.[_0x23beb2(0xdb)]}):{'contextTexts':[],'sources':[],'message':null};if(!!_0x36aa6c[_0x23beb2(0xc9)]){_0xc400f2['YNwEF'](writeResponseChunk,_0x552fdc,{'id':_0x519282,'type':'abort','textResponse':null,'sources':[],'close':!![],'error':_0x23beb2(0xd6)});return;}_0x420d5a=[..._0x420d5a,..._0x36aa6c['contextTexts']],_0x4c4a39=[..._0x4c4a39,..._0x36aa6c[_0x23beb2(0xe3)]];if(_0x1b53ee===_0xc400f2[_0x23beb2(0xcc)]&&_0x4c4a39[_0x23beb2(0xe7)]===0x0){if(_0xc400f2['xmOrO'](_0x23beb2(0xe1),_0xc400f2[_0x23beb2(0xb8)])){_0xc400f2['YNwEF'](writeResponseChunk,_0x552fdc,{'id':_0x519282,'type':_0xc400f2['ZTYqs'],'textResponse':'There\x20is\x20no\x20relevant\x20information\x20in\x20this\x20workspace\x20to\x20answer\x20your\x20query.','sources':[],'close':!![],'error':null});return;}else{const _0x33f541={'EQwAf':_0x23beb2(0xd3)};_0x3a0c47['forEach'](_0x16e3fd=>{const _0x4012be=_0x23beb2,{pageContent:_0x56deef,..._0x37b234}=_0x16e3fd;_0x3553d4[_0x4012be(0xd4)](_0x16e3fd['pageContent']),_0x21c92e['push']({'text':_0x56deef[_0x4012be(0xce)](0x0,0x3e8)+_0x33f541[_0x4012be(0xef)],..._0x37b234});});}}const _0x2ce87c=await _0x5b089d['compressMessages']({'systemPrompt':chatPrompt(_0x2eaa50['workspace']),'userPrompt':_0x4538e8,'contextTexts':_0x420d5a,'chatHistory':_0x19c8be},_0x2b1faf);if(_0xc400f2['QVfvP'](_0x5b089d[_0x23beb2(0xb6)](),!![]))console[_0x23beb2(0xb2)](_0x23beb2(0xf1)+_0x5b089d[_0x23beb2(0xda)][_0x23beb2(0xf2)]+_0x23beb2(0xf5)),_0xc93a8f=await _0x5b089d[_0x23beb2(0xbc)](_0x2ce87c,{'temperature':_0x2eaa50['workspace']?.[_0x23beb2(0xcd)]??_0x5b089d[_0x23beb2(0xea)]}),writeResponseChunk(_0x552fdc,{'uuid':_0x519282,'sources':[],'type':_0x23beb2(0xeb),'textResponse':_0xc93a8f,'close':!![],'error':![]});else{const _0x57977a=await _0x5b089d[_0x23beb2(0xb1)](_0x2ce87c,{'temperature':_0x2eaa50[_0x23beb2(0xe5)]?.[_0x23beb2(0xcd)]??_0x5b089d[_0x23beb2(0xea)]});_0xc93a8f=await _0x5b089d['handleStream'](_0x552fdc,_0x57977a,{'uuid':_0x519282,'sources':[]});}await EmbedChats[_0x23beb2(0xd1)]({'embedId':_0x2eaa50['id'],'prompt':_0x4538e8,'response':{'text':_0xc93a8f,'type':_0x1b53ee},'connection_information':_0x552fdc[_0x23beb2(0xee)][_0x23beb2(0xb7)]?{..._0x552fdc[_0x23beb2(0xee)][_0x23beb2(0xb7)]}:{},'sessionId':_0x1af218});return;}async function recentEmbedChatHistory(_0x194ff3,_0x5d5efc,_0x48d70b=0x14,_0x1276ba=null){const _0x2aa861=_0x3ad3d4;if(_0x1276ba==='query')return{'rawHistory':[],'chatHistory':[]};const _0x1649b9=(await EmbedChats['forEmbedByUser'](_0x5d5efc['id'],_0x194ff3,_0x48d70b,{'id':_0x2aa861(0xf7)}))[_0x2aa861(0xc6)]();return{'rawHistory':_0x1649b9,'chatHistory':convertToPromptHistory(_0x1649b9)};}module[_0x3ad3d4(0xdc)]={'streamChatWithForEmbed':streamChatWithForEmbed};