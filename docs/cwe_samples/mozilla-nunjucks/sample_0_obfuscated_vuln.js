const _0x2df4ba=_0x4787;function _0x4787(_0x2e465c,_0x531f33){const _0xf8c130=_0xf8c1();return _0x4787=function(_0x478757,_0x580631){_0x478757=_0x478757-0x10c;let _0x859bc=_0xf8c130[_0x478757];return _0x859bc;},_0x4787(_0x2e465c,_0x531f33);}function _0xf8c1(){const _0x417f9e=['default','filter','create','name\x20cannot\x20be\x20null','675744DZAhKp','vIjat','105042UmqJRo','length','670LeVutI','map','message','rhZFJ','manager','openAiHistory','1453312zvzaiz','floor','_trackWorkspacePromptChange','get','slugify','createManyUsers','workspaces','rgwyA','defaultPrompt','workspace_prompt_changed','chatModel','includes','5GyFAzz','No\x20workspace\x20id\x20provided\x20for\x20update','chatProvider','NNHex','./eventLogs','random','XuYEQ','error','openAiTemp','ZdPLs','gIDku','entries','where','dcnjr','openAiPrompt','GcKid','2384652NEIpDC','lastUpdatedAt','22887AxIioi','DUPqk','./user','uuid','sendTelemetry','slug','UFNgt','vectorTag','./workspaceUsers','Given\x20the\x20following\x20conversation,\x20relevant\x20context,\x20and\x20a\x20follow\x20up\x20question,\x20reply\x20with\x20an\x20answer\x20to\x20the\x20current\x20question\x20the\x20user\x20is\x20asking.\x20Return\x20only\x20your\x20response\x20to\x20the\x20question\x20given\x20the\x20above\x20information\x20following\x20the\x20users\x20instructions\x20as\x20needed.','USftc','peHOH','127292TtqwgB','findMany','role','Error\x20tracking\x20workspace\x20change:','name','exports','mkomo','delete','update','gArzl','chatMode','forWorkspace','findFirst','admin','raHzM','userIds','pfpFilename','forEach','10595WMDYsL','8SBXixR','user_id','jykqe','MymAz','./documents'];_0xf8c1=function(){return _0x417f9e;};return _0xf8c1();}(function(_0xd30bde,_0x4b4329){const _0x1ba27f=_0x4787,_0x3507d8=_0xd30bde();while(!![]){try{const _0x13de83=-parseInt(_0x1ba27f(0x140))/0x1*(-parseInt(_0x1ba27f(0x141))/0x2)+parseInt(_0x1ba27f(0x14a))/0x3+-parseInt(_0x1ba27f(0x12e))/0x4*(-parseInt(_0x1ba27f(0x110))/0x5)+-parseInt(_0x1ba27f(0x120))/0x6+parseInt(_0x1ba27f(0x14c))/0x7+parseInt(_0x1ba27f(0x154))/0x8+-parseInt(_0x1ba27f(0x122))/0x9*(-parseInt(_0x1ba27f(0x14e))/0xa);if(_0x13de83===_0x4b4329)break;else _0x3507d8['push'](_0x3507d8['shift']());}catch(_0x41357){_0x3507d8['push'](_0x3507d8['shift']());}}}(_0xf8c1,0x41b04));const prisma=require('../utils/prisma'),slugify=require(_0x2df4ba(0x158)),{Document}=require(_0x2df4ba(0x145)),{WorkspaceUser}=require(_0x2df4ba(0x12a)),{ROLES}=require('../utils/middleware/multiUserProtected'),{v4:uuidv4}=require(_0x2df4ba(0x125)),{User}=require(_0x2df4ba(0x124)),Workspace={'defaultPrompt':_0x2df4ba(0x12b),'writable':[_0x2df4ba(0x132),_0x2df4ba(0x127),_0x2df4ba(0x129),_0x2df4ba(0x118),_0x2df4ba(0x153),_0x2df4ba(0x121),_0x2df4ba(0x11e),'similarityThreshold',_0x2df4ba(0x112),_0x2df4ba(0x10e),'topN',_0x2df4ba(0x138),_0x2df4ba(0x13e)],'new':async function(_0x5bd369=null,_0x3d3144=null){const _0x314055=_0x2df4ba,_0x406897={'gIDku':function(_0x2ecbf5,_0x556081){return _0x2ecbf5*_0x556081;},'MymAz':_0x314055(0x149),'eLizG':function(_0x18f443,_0x238d22,_0x33679f){return _0x18f443(_0x238d22,_0x33679f);},'peHOH':function(_0x1a6b99,_0x40fb1d){return _0x1a6b99!==_0x40fb1d;}};if(!_0x5bd369)return{'result':null,'message':_0x406897[_0x314055(0x144)]};var _0x4df6c2=_0x406897['eLizG'](slugify,_0x5bd369,{'lower':!![]});_0x4df6c2=_0x4df6c2||uuidv4();const _0x222a40=await this[_0x314055(0x157)]({'slug':_0x4df6c2});if(_0x406897[_0x314055(0x12d)](_0x222a40,null)){const _0x5b98bc=Math[_0x314055(0x155)](0x989680+_0x406897[_0x314055(0x11a)](Math[_0x314055(0x115)](),0x55d4a80));_0x4df6c2=slugify(_0x5bd369+'-'+_0x5b98bc,{'lower':!![]});}try{if(_0x314055(0x113)!==_0x314055(0x123)){const _0x150ee9=await prisma[_0x314055(0x15a)][_0x314055(0x148)]({'data':{'name':_0x5bd369,'slug':_0x4df6c2}});if(!!_0x3d3144)await WorkspaceUser[_0x314055(0x148)](_0x3d3144,_0x150ee9['id']);return{'workspace':_0x150ee9,'message':null};}else{const _0x39beaa=_0x4bee14['floor'](0x989680+_0x406897[_0x314055(0x11a)](_0x55ce47[_0x314055(0x115)](),0x55d4a80));_0xf53605=_0x7e31d1(_0x31ca03+'-'+_0x39beaa,{'lower':!![]});}}catch(_0x40bbfe){return console[_0x314055(0x117)](_0x40bbfe[_0x314055(0x150)]),{'workspace':null,'message':_0x40bbfe[_0x314055(0x150)]};}},'update':async function(_0x282b40=null,_0x2ed64c={}){const _0x13c797=_0x2df4ba;if(!_0x282b40)throw new Error(_0x13c797(0x111));const _0xaaf7da=Object['keys'](_0x2ed64c)[_0x13c797(0x147)](_0x34dc20=>this['writable'][_0x13c797(0x10f)](_0x34dc20));Object[_0x13c797(0x11b)](_0x2ed64c)[_0x13c797(0x13f)](([_0x4ac821])=>{const _0x165cb6=_0x13c797;if(_0xaaf7da[_0x165cb6(0x10f)](_0x4ac821))return;delete _0x2ed64c[_0x4ac821];});if(Object['keys'](_0x2ed64c)[_0x13c797(0x14d)]===0x0)return{'workspace':{'id':_0x282b40},'message':'No\x20valid\x20fields\x20to\x20update!'};return _0x2ed64c?.[_0x13c797(0x112)]===_0x13c797(0x146)&&(_0x2ed64c['chatProvider']=null,_0x2ed64c['chatModel']=null),this['_update'](_0x282b40,_0x2ed64c);},'_update':async function(_0x23245f=null,_0x260461={}){const _0x5c7ef9=_0x2df4ba,_0x4492c2={'UFNgt':_0x5c7ef9(0x111),'ZdPLs':_0x5c7ef9(0x137)};if(!_0x23245f)throw new Error(_0x4492c2[_0x5c7ef9(0x128)]);try{if(_0x4492c2[_0x5c7ef9(0x119)]==='gArzl'){const _0x4ff4cb=await prisma[_0x5c7ef9(0x15a)][_0x5c7ef9(0x136)]({'where':{'id':_0x23245f},'data':_0x260461});return{'workspace':_0x4ff4cb,'message':null};}else return _0x123027[_0x5c7ef9(0x117)](_0x2a97d4[_0x5c7ef9(0x150)]),{'workspace':null,'message':_0x32d72d[_0x5c7ef9(0x150)]};}catch(_0x5cc83e){return console[_0x5c7ef9(0x117)](_0x5cc83e['message']),{'workspace':null,'message':_0x5cc83e[_0x5c7ef9(0x150)]};}},'getWithUser':async function(_0x53b357=null,_0x420484={}){const _0x20bfec=_0x2df4ba,_0x1eca6b={'jykqe':function(_0x2d84dc,_0xdd5085){return _0x2d84dc!==_0xdd5085;},'dcnjr':_0x20bfec(0x14b)};if([ROLES[_0x20bfec(0x13b)],ROLES[_0x20bfec(0x152)]][_0x20bfec(0x10f)](_0x53b357[_0x20bfec(0x130)]))return this[_0x20bfec(0x157)](_0x420484);try{if(_0x1eca6b[_0x20bfec(0x143)](_0x1eca6b['dcnjr'],_0x1eca6b[_0x20bfec(0x11d)])){_0x375e1c[_0x20bfec(0x117)]('Error\x20tracking\x20workspace\x20change:',_0x5b9b91[_0x20bfec(0x150)]);return;}else{const _0x4d2a3e=await prisma['workspaces'][_0x20bfec(0x13a)]({'where':{..._0x420484,'workspace_users':{'some':{'user_id':_0x53b357?.['id']}}},'include':{'workspace_users':!![],'documents':!![]}});if(!_0x4d2a3e)return null;return{..._0x4d2a3e,'documents':await Document[_0x20bfec(0x139)](_0x4d2a3e['id'])};}}catch(_0x26fb9a){return console[_0x20bfec(0x117)](_0x26fb9a[_0x20bfec(0x150)]),null;}},'get':async function(_0x3221e1={}){const _0x4b22d7=_0x2df4ba,_0x3632ea={'Dqvwa':function(_0x549dd8,_0x559906){return _0x549dd8||_0x559906;}};try{const _0xe7d365=await prisma[_0x4b22d7(0x15a)][_0x4b22d7(0x13a)]({'where':_0x3221e1,'include':{'documents':!![]}});return _0x3632ea['Dqvwa'](_0xe7d365,null);}catch(_0x37d611){return console['error'](_0x37d611['message']),null;}},'delete':async function(_0x393d2d={}){const _0x143e60=_0x2df4ba;try{return await prisma['workspaces'][_0x143e60(0x135)]({'where':_0x393d2d}),!![];}catch(_0x5658a0){return console[_0x143e60(0x117)](_0x5658a0[_0x143e60(0x150)]),![];}},'where':async function(_0x502d26={},_0x46c152=null,_0x2ab1f8=null){const _0xb5f832=_0x2df4ba,_0x33d96e={'GcKid':function(_0x233c0d,_0x36ee63){return _0x233c0d!==_0x36ee63;}};try{const _0xe17c76=await prisma[_0xb5f832(0x15a)][_0xb5f832(0x12f)]({'where':_0x502d26,..._0x33d96e[_0xb5f832(0x11f)](_0x46c152,null)?{'take':_0x46c152}:{},..._0x33d96e[_0xb5f832(0x11f)](_0x2ab1f8,null)?{'orderBy':_0x2ab1f8}:{}});return _0xe17c76;}catch(_0x46fd36){return console[_0xb5f832(0x117)](_0x46fd36[_0xb5f832(0x150)]),[];}},'whereWithUser':async function(_0x4cc6fe,_0x56da33={},_0x436cfc=null,_0x1d3831=null){const _0x5e08ca=_0x2df4ba,_0x4c7e9e={'XuYEQ':_0x5e08ca(0x151),'mkomo':function(_0x216bfd,_0x20f7c0){return _0x216bfd!==_0x20f7c0;}};if([ROLES[_0x5e08ca(0x13b)],ROLES['manager']][_0x5e08ca(0x10f)](_0x4cc6fe['role']))return await this[_0x5e08ca(0x11c)](_0x56da33,_0x436cfc,_0x1d3831);try{if(_0x4c7e9e[_0x5e08ca(0x116)]!==_0x4c7e9e[_0x5e08ca(0x116)])return _0x12ee51[_0x5e08ca(0x117)](_0x56dd07[_0x5e08ca(0x150)]),{'workspace':null,'message':_0x2fc710[_0x5e08ca(0x150)]};else{const _0xe3e827=await prisma[_0x5e08ca(0x15a)][_0x5e08ca(0x12f)]({'where':{..._0x56da33,'workspace_users':{'some':{'user_id':_0x4cc6fe['id']}}},..._0x4c7e9e[_0x5e08ca(0x134)](_0x436cfc,null)?{'take':_0x436cfc}:{},..._0x4c7e9e[_0x5e08ca(0x134)](_0x1d3831,null)?{'orderBy':_0x1d3831}:{}});return _0xe3e827;}}catch(_0x24e71a){return console[_0x5e08ca(0x117)](_0x24e71a['message']),[];}},'whereWithUsers':async function(_0x20f2e1={},_0x4a8c9a=null,_0x2e847f=null){const _0x10e52f=_0x2df4ba;try{const _0x2ebb56=await this[_0x10e52f(0x11c)](_0x20f2e1,_0x4a8c9a,_0x2e847f);for(const _0x42033b of _0x2ebb56){const _0x13090e=(await WorkspaceUser[_0x10e52f(0x11c)]({'workspace_id':Number(_0x42033b['id'])}))[_0x10e52f(0x14f)](_0xe3cdd7=>_0xe3cdd7[_0x10e52f(0x142)]);_0x42033b[_0x10e52f(0x13d)]=_0x13090e;}return _0x2ebb56;}catch(_0x248866){return console[_0x10e52f(0x117)](_0x248866['message']),[];}},'workspaceUsers':async function(_0x22baab){const _0x53d4a4=_0x2df4ba;try{const _0x30539b=(await WorkspaceUser[_0x53d4a4(0x11c)]({'workspace_id':Number(_0x22baab)}))[_0x53d4a4(0x14f)](_0x59da2d=>_0x59da2d),_0x8c2e3c=await User['where']({'id':{'in':_0x30539b['map'](_0x4f0def=>_0x4f0def[_0x53d4a4(0x142)])}}),_0x3fe3bc=_0x8c2e3c[_0x53d4a4(0x14f)](_0xa47b89=>{const _0x5c9daf=_0x53d4a4,_0x89d9d8=_0x30539b['find'](_0xb3846=>_0xb3846[_0x5c9daf(0x142)]===_0xa47b89['id']);return{'username':_0xa47b89['username'],'role':_0xa47b89[_0x5c9daf(0x130)],'lastUpdatedAt':_0x89d9d8[_0x5c9daf(0x121)]};});return _0x3fe3bc;}catch(_0x5e661a){return console['error'](_0x5e661a[_0x53d4a4(0x150)]),[];}},'updateUsers':async function(_0x42d6de,_0x3ebea4=[]){const _0x28e997=_0x2df4ba;try{return await WorkspaceUser[_0x28e997(0x135)]({'workspace_id':Number(_0x42d6de)}),await WorkspaceUser[_0x28e997(0x159)](_0x3ebea4,_0x42d6de),{'success':!![],'error':null};}catch(_0x286402){return console['error'](_0x286402[_0x28e997(0x150)]),{'success':![],'error':_0x286402[_0x28e997(0x150)]};}},'trackChange':async function(_0x54ee62,_0x52c979,_0x1723a7){const _0x223185=_0x2df4ba,_0x372076={'vLEXF':_0x223185(0x131)};try{await this[_0x223185(0x156)](_0x54ee62,_0x52c979,_0x1723a7);return;}catch(_0x196a66){console[_0x223185(0x117)](_0x372076['vLEXF'],_0x196a66[_0x223185(0x150)]);return;}},'_trackWorkspacePromptChange':async function(_0x462549,_0x3a4198,_0x192f78){const _0x55301d=_0x2df4ba,_0x40930a={'rgwyA':function(_0x26ed3c,_0x16cda7){return _0x26ed3c(_0x16cda7);},'USftc':_0x55301d(0x114),'pbjbI':function(_0xf3bb73,_0x53af6c){return _0xf3bb73===_0x53af6c;},'raHzM':'workspace_prompt_changed'},{Telemetry:_0x288b04}=_0x40930a[_0x55301d(0x15b)](require,'./telemetry'),{EventLogs:_0xd52255}=require(_0x40930a[_0x55301d(0x12c)]);if(!_0x3a4198?.['openAiPrompt']||_0x40930a['pbjbI'](_0x3a4198?.[_0x55301d(0x11e)],this[_0x55301d(0x10c)])||_0x3a4198?.[_0x55301d(0x11e)]===_0x462549?.[_0x55301d(0x11e)])return;await _0x288b04[_0x55301d(0x126)](_0x40930a[_0x55301d(0x13c)]),await _0xd52255['logEvent'](_0x55301d(0x10d),{'workspaceName':_0x462549?.[_0x55301d(0x132)],'prevSystemPrompt':_0x462549?.[_0x55301d(0x11e)]||this[_0x55301d(0x10c)],'newSystemPrompt':_0x3a4198?.['openAiPrompt']},_0x192f78?.['id']);return;}};module[_0x2df4ba(0x133)]={'Workspace':Workspace};