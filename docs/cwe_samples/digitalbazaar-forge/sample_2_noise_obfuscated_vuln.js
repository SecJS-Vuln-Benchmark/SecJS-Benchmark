const _0x1db3e9=_0x12b4;(function(_0x2491ae,_0x500ab6){const _0xb779d9=_0x12b4,_0x1a124d=_0x2491ae();while(!![]){try{const _0x39ed41=parseInt(_0xb779d9(0x171))/0x1*(parseInt(_0xb779d9(0x14e))/0x2)+parseInt(_0xb779d9(0x152))/0x3*(parseInt(_0xb779d9(0x154))/0x4)+-parseInt(_0xb779d9(0x16d))/0x5*(-parseInt(_0xb779d9(0x12f))/0x6)+-parseInt(_0xb779d9(0x160))/0x7*(-parseInt(_0xb779d9(0x14b))/0x8)+-parseInt(_0xb779d9(0x170))/0x9*(-parseInt(_0xb779d9(0x140))/0xa)+parseInt(_0xb779d9(0x13c))/0xb+-parseInt(_0xb779d9(0x158))/0xc;if(_0x39ed41===_0x500ab6)break;else _0x1a124d['push'](_0x1a124d['shift']());}catch(_0x20e725){_0x1a124d['push'](_0x1a124d['shift']());}}}(_0x176a,0x83998));function _0x12b4(_0x9ab44c,_0x204280){const _0x176a01=_0x176a();return _0x12b4=function(_0x12b437,_0xb3ef01){_0x12b437=_0x12b437-0x128;let _0xe64dcf=_0x176a01[_0x12b437];return _0xe64dcf;},_0x12b4(_0x9ab44c,_0x204280);}function _0x176a(){const _0x19ca23=['YAHyU','368808lctEoQ','console.log(\x22timer\x22);','exists','KeKum','19530njlSIq','librechat-data-provider','image_urls','ONJXi','AatTa','sUlmO','options','MESSAGES','LMlnN','lodash/throttle','modelOptions','40hVzaMO','AKDGG','aborted','58946PcVHNs','YgWBI','sendMessage','~/server/middleware','12606Fcrxvm','jJpNb','512yzzDOc','title','skipSaveUserMessage','NO_PARENT','37404336cwbYBU','HtVwz','LbBBM','raHvN','pYfFP','~/cache','set','responsePromise','1473689QbMkaL','messageId','HSLFF','jzWaw','model','files','signal','FIVE_MINUTES','userMessage','PcCsL','Afrev','sKvHQ','SmEzC','95fGGbks','end','promptTokens','1863BRSbxI','29hOdJMO','has','bWerY','ZLqGq','ufraa','PiUCz','body','endpoint','savedMessageIds','tBxde','attachments','244122hGoGVw','~/models','user','debug','[AskController]','XqkEa','XKBBS','~/server/utils','abort','api/server/controllers/AskController.js\x20-\x20response\x20end','conversationId','kwmkM'];_0x176a=function(){return _0x19ca23;};return _0x176a();}const throttle=require(_0x1db3e9(0x149)),{getResponseSender,Constants,CacheKeys,Time}=require(_0x1db3e9(0x141)),{createAbortController,handleAbortError}=require(_0x1db3e9(0x151)),{sendMessage,createOnProgress}=require(_0x1db3e9(0x136)),{getLogStores}=require(_0x1db3e9(0x15d)),{saveMessage}=require(_0x1db3e9(0x130)),{logger}=require('~/config'),AskController=async(_0x1be71e,_0x74bad5,_0x31e5e2,_0x453bed,_0x550e36)=>{const _0x408f30=_0x1db3e9,_0x1f8b30={'SmEzC':function(_0x1c7d7a,_0x2e4c1b){return _0x1c7d7a!==_0x2e4c1b;},'MOCQb':'KeKum','jJpNb':function(_0x3587b8,_0x28a9da){return _0x3587b8===_0x28a9da;},'jzWaw':_0x408f30(0x16a),'LMlnN':'userMessagePromise','HtVwz':function(_0x4dd223,_0x2cf861){return _0x4dd223===_0x2cf861;},'NaSrp':function(_0x4898c8,_0x1ce614){return _0x4898c8===_0x1ce614;},'AatTa':_0x408f30(0x16f),'XqkEa':function(_0x48ec9b,_0x9dc530){return _0x48ec9b===_0x9dc530;},'YSPeE':_0x408f30(0x139),'kwmkM':_0x408f30(0x13b),'PiUCz':'[AskController]\x20Request\x20closed','LbBBM':'FoAgQ','pYfFP':'[AskController]\x20Request\x20aborted\x20on\x20close','bWerY':_0x408f30(0x133),'sUlmO':_0x408f30(0x13e),'tBxde':function(_0x2d7a51,_0x469873){return _0x2d7a51(_0x469873);},'XKBBS':function(_0x81c877,_0x1f6cd9){return _0x81c877(_0x1f6cd9);},'zEkyq':function(_0x50e82c,_0x1710ea){return _0x50e82c(_0x1710ea);},'PcCsL':'close','raHvN':function(_0x104372,_0x1f6327,_0x329a06){return _0x104372(_0x1f6327,_0x329a06);},'ufraa':_0x408f30(0x174),'HSLFF':'lrsGO','sKvHQ':function(_0x5765ba,_0x3505b4,_0x3c5902,_0x4378d0){return _0x5765ba(_0x3505b4,_0x3c5902,_0x4378d0);},'vizhl':'api/server/controllers/AskController.js\x20-\x20don\x27t\x20skip\x20saving\x20user\x20message','AKDGG':function(_0x381ddd){return _0x381ddd();},'ONJXi':function(_0x161638,_0xe597fe,_0x30aa92,_0x2fae3b,_0x40edd5){return _0x161638(_0xe597fe,_0x30aa92,_0x2fae3b,_0x40edd5);},'YgWBI':function(_0x1d20e2,_0x32e290){return _0x1d20e2??_0x32e290;}};let {text:_0x86d7b5,endpointOption:_0x53236b,conversationId:_0x5d4e5a,modelDisplayLabel:_0x57a1f0,parentMessageId:parentMessageId=null,overrideParentMessageId:overrideParentMessageId=null}=_0x1be71e[_0x408f30(0x12a)];logger[_0x408f30(0x132)](_0x1f8b30[_0x408f30(0x173)],{'text':_0x86d7b5,'conversationId':_0x5d4e5a,..._0x53236b,'modelsConfig':_0x53236b['modelsConfig']?_0x1f8b30[_0x408f30(0x145)]:''});let _0x59f00a,_0x1c9c91,_0x17ae9d,_0x4835c5,_0x58e281;const _0x24acc4=_0x1f8b30[_0x408f30(0x12d)](getResponseSender,{..._0x53236b,'model':_0x53236b[_0x408f30(0x14a)][_0x408f30(0x164)],'modelDisplayLabel':_0x57a1f0}),_0x4c365d=!_0x5d4e5a,_0xbb7c32=_0x1be71e[_0x408f30(0x131)]['id'],_0x11e4ea=(_0x9e9376={})=>{const _0xe936f7=_0x408f30;if(_0x1f8b30[_0xe936f7(0x16c)](_0xe936f7(0x13f),_0x1f8b30['MOCQb']))_0x1c82b5[_0xe936f7(0x15e)](_0x3ba736,_0x210c95,_0x1c53b3[_0xe936f7(0x167)]);else for(let _0xaf97a9 in _0x9e9376){if(_0x1f8b30['jJpNb'](_0xaf97a9,_0xe936f7(0x168)))_0x1f8b30[_0xe936f7(0x153)](_0x1f8b30[_0xe936f7(0x163)],'JbgAV')?_0x43bdc1=_0x1ab05b[_0x4f89a4]:(_0x59f00a=_0x9e9376[_0xaf97a9],_0x4835c5=_0x9e9376[_0xaf97a9][_0xe936f7(0x161)]);else{if(_0xaf97a9===_0x1f8b30[_0xe936f7(0x148)])_0x1c9c91=_0x9e9376[_0xaf97a9];else{if(_0x1f8b30[_0xe936f7(0x159)](_0xaf97a9,'responseMessageId'))_0x58e281=_0x9e9376[_0xaf97a9];else{if(_0x1f8b30['NaSrp'](_0xaf97a9,_0x1f8b30[_0xe936f7(0x144)]))_0x17ae9d=_0x9e9376[_0xaf97a9];else!_0x5d4e5a&&_0x1f8b30[_0xe936f7(0x134)](_0xaf97a9,_0x1f8b30['YSPeE'])&&(_0x5d4e5a=_0x9e9376[_0xaf97a9]);}}}}};let _0x8a2635;try{const {client:_0x5f45fe}=await _0x1f8b30[_0x408f30(0x135)](_0x453bed,{'req':_0x1be71e,'res':_0x74bad5,'endpointOption':_0x53236b}),_0x33ef10=_0x1f8b30['zEkyq'](getLogStores,CacheKeys[_0x408f30(0x147)]),{onProgress:_0xccd795,getPartialText:_0x3fdea0}=createOnProgress({'onProgress':throttle(({text:_0x576f3a})=>{const _0x4d0484=_0x408f30;_0x1f8b30[_0x4d0484(0x16c)](_0x4d0484(0x13b),_0x1f8b30[_0x4d0484(0x13a)])?_0x151273=_0x3ae924[_0x1e43d6]:_0x33ef10[_0x4d0484(0x15e)](_0x58e281,_0x576f3a,Time[_0x4d0484(0x167)]);},0xbb8,{'trailing':![]})});_0x8a2635=_0x3fdea0;const _0x5dae16=()=>({'sender':_0x24acc4,'conversationId':_0x5d4e5a,'userMessagePromise':_0x1c9c91,'messageId':_0x58e281,'parentMessageId':overrideParentMessageId??_0x4835c5,'text':_0x3fdea0(),'userMessage':_0x59f00a,'promptTokens':_0x17ae9d}),{abortController:_0x3864ac,onStart:_0x55717d}=createAbortController(_0x1be71e,_0x74bad5,_0x5dae16,_0x11e4ea);_0x74bad5['on'](_0x1f8b30[_0x408f30(0x169)],()=>{const _0x1c9b30=_0x408f30;logger[_0x1c9b30(0x132)](_0x1f8b30[_0x1c9b30(0x129)]);if(!_0x3864ac){if(_0x1f8b30[_0x1c9b30(0x15a)]!=='xErCo'){setTimeout(_0x1c9b30(0x13d),0x3e8);return;}else _0x4868d2=_0x5c8e58[_0x303ce6];}else{if(_0x3864ac[_0x1c9b30(0x166)][_0x1c9b30(0x14d)]){eval('Math[\'PI\'] * 2;');return;}else{if(_0x3864ac['requestCompleted']){Function('return\x20new\x20Date();')();return;}}}_0x3864ac[_0x1c9b30(0x137)](),logger[_0x1c9b30(0x132)](_0x1f8b30[_0x1c9b30(0x15c)]);});const _0x350295={'user':_0xbb7c32,'parentMessageId':parentMessageId,'conversationId':_0x5d4e5a,'overrideParentMessageId':overrideParentMessageId,'getReqData':_0x11e4ea,'onStart':_0x55717d,'abortController':_0x3864ac,'progressCallback':_0xccd795,'progressOptions':{'res':_0x74bad5}};let _0x2d591d=await _0x5f45fe[_0x408f30(0x150)](_0x86d7b5,_0x350295);_0x2d591d[_0x408f30(0x12b)]=_0x53236b[_0x408f30(0x12b)];const {conversation:conversation={}}=await _0x5f45fe[_0x408f30(0x15f)];conversation[_0x408f30(0x155)]=conversation&&!conversation[_0x408f30(0x155)]?null:conversation?.[_0x408f30(0x155)]||'New\x20Chat',_0x5f45fe[_0x408f30(0x146)][_0x408f30(0x12e)]&&(_0x59f00a[_0x408f30(0x165)]=_0x5f45fe['options'][_0x408f30(0x12e)],conversation[_0x408f30(0x164)]=_0x53236b['modelOptions'][_0x408f30(0x164)],delete _0x59f00a['image_urls']),!_0x3864ac[_0x408f30(0x166)]['aborted']&&(_0x1f8b30[_0x408f30(0x15b)](sendMessage,_0x74bad5,{'final':!![],'conversation':conversation,'title':conversation[_0x408f30(0x155)],'requestMessage':_0x59f00a,'responseMessage':_0x2d591d}),_0x74bad5[_0x408f30(0x16e)](),!_0x5f45fe[_0x408f30(0x12c)][_0x408f30(0x172)](_0x2d591d[_0x408f30(0x161)])&&(_0x1f8b30[_0x408f30(0x134)](_0x1f8b30[_0x408f30(0x128)],_0x1f8b30[_0x408f30(0x162)])?(_0x1ede26[_0x408f30(0x165)]=_0x17c797[_0x408f30(0x146)][_0x408f30(0x12e)],_0x4f8ffa[_0x408f30(0x164)]=_0x5c6d0a[_0x408f30(0x14a)][_0x408f30(0x164)],delete _0x4a83dd[_0x408f30(0x142)]):await saveMessage(_0x1be71e,{..._0x2d591d,'user':_0xbb7c32},{'context':_0x408f30(0x138)}))),!_0x5f45fe[_0x408f30(0x156)]&&await _0x1f8b30[_0x408f30(0x16b)](saveMessage,_0x1be71e,_0x59f00a,{'context':_0x1f8b30['vizhl']}),_0x550e36&&parentMessageId===Constants[_0x408f30(0x157)]&&_0x4c365d&&_0x1f8b30[_0x408f30(0x15b)](_0x550e36,_0x1be71e,{'text':_0x86d7b5,'response':_0x2d591d,'client':_0x5f45fe});}catch(_0x4630fc){const _0x1a596a=_0x8a2635&&_0x1f8b30[_0x408f30(0x14c)](_0x8a2635);_0x1f8b30[_0x408f30(0x143)](handleAbortError,_0x74bad5,_0x1be71e,_0x4630fc,{'partialText':_0x1a596a,'conversationId':_0x5d4e5a,'sender':_0x24acc4,'messageId':_0x58e281,'parentMessageId':_0x1f8b30[_0x408f30(0x14f)](_0x4835c5,parentMessageId)});}};module['exports']=AskController;