const _0x3ccb32=_0x14b3;function _0x14b3(_0x190091,_0x35464){const _0x3fe88c=_0x3fe8();return _0x14b3=function(_0x14b34b,_0x1baa66){_0x14b34b=_0x14b34b-0x11b;let _0x3a19ef=_0x3fe88c[_0x14b34b];return _0x3a19ef;},_0x14b3(_0x190091,_0x35464);}(function(_0x466fb1,_0x27e9d9){const _0x20e6b6=_0x14b3,_0x1f9860=_0x466fb1();while(!![]){try{const _0xcf6a48=parseInt(_0x20e6b6(0x13b))/0x1+-parseInt(_0x20e6b6(0x12d))/0x2+parseInt(_0x20e6b6(0x11c))/0x3+parseInt(_0x20e6b6(0x13d))/0x4+-parseInt(_0x20e6b6(0x139))/0x5+parseInt(_0x20e6b6(0x153))/0x6*(parseInt(_0x20e6b6(0x15b))/0x7)+-parseInt(_0x20e6b6(0x11d))/0x8;if(_0xcf6a48===_0x27e9d9)break;else _0x1f9860['push'](_0x1f9860['shift']());}catch(_0x2048e8){_0x1f9860['push'](_0x1f9860['shift']());}}}(_0x3fe8,0xbd565));const {v4:uuidv4}=require(_0x3ccb32(0x158)),{DocumentManager}=require(_0x3ccb32(0x14b)),{WorkspaceChats}=require(_0x3ccb32(0x142)),{getVectorDbClass,getLLMProvider}=require('../helpers'),{writeResponseChunk}=require(_0x3ccb32(0x13c)),{grepCommand,VALID_COMMANDS,chatPrompt,recentChatHistory}=require('./index'),VALID_CHAT_MODE=['chat','query'];async function streamChatWithWorkspace(_0x39ea7c,_0x225314,_0x506ef2,_0x5a84f6=_0x3ccb32(0x127),_0x1b8a00=null,_0x837f2=null){const _0x1eaefe=_0x3ccb32,_0x3da2e9={'fNgJV':function(_0xf60dcd,_0x46e7c6,_0x473574){return _0xf60dcd(_0x46e7c6,_0x473574);},'zQiHB':function(_0x5141ec){return _0x5141ec();},'elGuL':_0x1eaefe(0x131),'gcKCX':function(_0x2be2fa,_0x31eacd){return _0x2be2fa===_0x31eacd;},'oIuse':'query','qUWSS':_0x1eaefe(0x148),'nvqMw':function(_0x11551a,_0x5114d8){return _0x11551a(_0x5114d8);},'uADBk':_0x1eaefe(0x145),'vJBoY':function(_0x4e7941,_0x1c11a5){return _0x4e7941===_0x1c11a5;},'OounM':function(_0x398fff,_0x32d5be){return _0x398fff===_0x32d5be;},'upVts':function(_0x3631b4,_0x39fba2){return _0x3631b4!==_0x39fba2;},'vochV':function(_0x53be78,_0x1f6ef6,_0xf4038e){return _0x53be78(_0x1f6ef6,_0xf4038e);},'bOhgB':_0x1eaefe(0x149),'GAygr':_0x1eaefe(0x129)},_0x51652e=_0x3da2e9[_0x1eaefe(0x13e)](uuidv4),_0x8f2210=grepCommand(_0x506ef2);if(!!_0x8f2210&&Object[_0x1eaefe(0x120)](VALID_COMMANDS)[_0x1eaefe(0x152)](_0x8f2210)){const _0xd613bf=await VALID_COMMANDS[_0x8f2210](_0x225314,_0x506ef2,_0x51652e,_0x1b8a00,_0x837f2);writeResponseChunk(_0x39ea7c,_0xd613bf);return;}const _0x509403=getLLMProvider(_0x225314?.[_0x1eaefe(0x128)]),_0x4925c7=getVectorDbClass(),{safe:_0x2fdf39,reasons:reasons=[]}=await _0x509403[_0x1eaefe(0x147)](_0x506ef2);if(!_0x2fdf39){writeResponseChunk(_0x39ea7c,{'id':_0x51652e,'type':_0x3da2e9[_0x1eaefe(0x15c)],'textResponse':null,'sources':[],'close':!![],'error':_0x1eaefe(0x14d)+reasons['join'](',\x20')+_0x1eaefe(0x15a)});return;}const _0x4cf497=_0x225314?.[_0x1eaefe(0x14a)]||0x14,_0x4d4df6=await _0x4925c7[_0x1eaefe(0x136)](_0x225314[_0x1eaefe(0x134)]),_0x7a4fc1=await _0x4925c7[_0x1eaefe(0x140)](_0x225314['slug']);if((!_0x4d4df6||_0x7a4fc1===0x0)&&_0x3da2e9['gcKCX'](_0x5a84f6,_0x3da2e9['oIuse'])){writeResponseChunk(_0x39ea7c,{'id':_0x51652e,'type':_0x3da2e9['qUWSS'],'textResponse':_0x1eaefe(0x121),'sources':[],'close':!![],'error':null});return;}let _0x951c29,_0x55cfc8=[],_0x2a1541=[];const {rawHistory:_0x29e46d,chatHistory:_0x4d070a}=await _0x3da2e9['nvqMw'](recentChatHistory,{'user':_0x1b8a00,'workspace':_0x225314,'thread':_0x837f2,'messageLimit':_0x4cf497,'chatMode':_0x5a84f6});await new DocumentManager({'workspace':_0x225314,'maxTokens':_0x509403[_0x1eaefe(0x138)][_0x1eaefe(0x12e)]})[_0x1eaefe(0x130)]()[_0x1eaefe(0x141)](_0x49abbf=>{const _0x3cff66=_0x1eaefe;_0x49abbf[_0x3cff66(0x12b)](_0x251ba7=>{const _0x1bd915=_0x3cff66,{pageContent:_0x15c3cd,..._0x2aeee0}=_0x251ba7;_0x55cfc8['push'](_0x251ba7[_0x1bd915(0x13f)]),_0x2a1541['push']({'text':_0x15c3cd[_0x1bd915(0x122)](0x0,0x3e8)+_0x1bd915(0x123),..._0x2aeee0});});});const _0x32edbe=_0x7a4fc1!==0x0?await _0x4925c7['performSimilaritySearch']({'namespace':_0x225314[_0x1eaefe(0x134)],'input':_0x506ef2,'LLMConnector':_0x509403,'similarityThreshold':_0x225314?.[_0x1eaefe(0x144)],'topN':_0x225314?.[_0x1eaefe(0x137)]}):{'contextTexts':[],'sources':[],'message':null};if(!!_0x32edbe['message']){if(_0x3da2e9[_0x1eaefe(0x12f)]===_0x3da2e9[_0x1eaefe(0x12f)]){writeResponseChunk(_0x39ea7c,{'id':_0x51652e,'type':_0x1eaefe(0x131),'textResponse':null,'sources':[],'close':!![],'error':_0x32edbe[_0x1eaefe(0x12c)]});return;}else{_0x3da2e9['fNgJV'](_0x25f643,_0x2e8dd8,{'id':_0x3421a4,'type':_0x1eaefe(0x148),'textResponse':'There\x20is\x20no\x20relevant\x20information\x20in\x20this\x20workspace\x20to\x20answer\x20your\x20query.','sources':[],'close':!![],'error':null});return;}}_0x55cfc8=[..._0x55cfc8,..._0x32edbe['contextTexts']],_0x2a1541=[..._0x2a1541,..._0x32edbe[_0x1eaefe(0x154)]];if(_0x3da2e9[_0x1eaefe(0x151)](_0x5a84f6,_0x3da2e9[_0x1eaefe(0x157)])&&_0x3da2e9[_0x1eaefe(0x14c)](_0x2a1541[_0x1eaefe(0x143)],0x0)){_0x3da2e9[_0x1eaefe(0x11b)](writeResponseChunk,_0x39ea7c,{'id':_0x51652e,'type':_0x1eaefe(0x148),'textResponse':_0x1eaefe(0x121),'sources':[],'close':!![],'error':null});return;}const _0x2a2ca5=await _0x509403[_0x1eaefe(0x150)]({'systemPrompt':_0x3da2e9['nvqMw'](chatPrompt,_0x225314),'userPrompt':_0x506ef2,'contextTexts':_0x55cfc8,'chatHistory':_0x4d070a},_0x29e46d);if(_0x3da2e9[_0x1eaefe(0x11f)](_0x509403[_0x1eaefe(0x13a)](),!![]))console[_0x1eaefe(0x14e)]('\x1b[31m[STREAMING\x20DISABLED]\x1b[0m\x20Streaming\x20is\x20not\x20available\x20for\x20'+_0x509403[_0x1eaefe(0x11e)][_0x1eaefe(0x125)]+_0x1eaefe(0x146)),_0x951c29=await _0x509403[_0x1eaefe(0x135)](_0x2a2ca5,{'temperature':_0x225314?.[_0x1eaefe(0x126)]??_0x509403[_0x1eaefe(0x12a)]}),_0x3da2e9[_0x1eaefe(0x124)](writeResponseChunk,_0x39ea7c,{'uuid':_0x51652e,'sources':_0x2a1541,'type':_0x3da2e9[_0x1eaefe(0x156)],'textResponse':_0x951c29,'close':!![],'error':![]});else{const _0x52b6c0=await _0x509403[_0x1eaefe(0x133)](_0x2a2ca5,{'temperature':_0x225314?.[_0x1eaefe(0x126)]??_0x509403['defaultTemp']});_0x951c29=await _0x509403[_0x1eaefe(0x155)](_0x39ea7c,_0x52b6c0,{'uuid':_0x51652e,'sources':_0x2a1541});}const {chat:_0x5c9e6e}=await WorkspaceChats[_0x1eaefe(0x159)]({'workspaceId':_0x225314['id'],'prompt':_0x506ef2,'response':{'text':_0x951c29,'sources':_0x2a1541,'type':_0x5a84f6},'threadId':_0x837f2?.['id']||null,'user':_0x1b8a00});_0x3da2e9['fNgJV'](writeResponseChunk,_0x39ea7c,{'uuid':_0x51652e,'type':_0x3da2e9[_0x1eaefe(0x14f)],'close':!![],'error':![],'chatId':_0x5c9e6e['id']});return;}function _0x3fe8(){const _0x52fd8d=['elGuL','fNgJV','1685832PVTCoZ','8749288jHbRgh','constructor','upVts','keys','There\x20is\x20no\x20relevant\x20information\x20in\x20this\x20workspace\x20to\x20answer\x20your\x20query.','slice','...continued\x20on\x20in\x20source\x20document...','vochV','name','openAiTemp','chat','chatModel','finalizeResponseStream','defaultTemp','forEach','message','1281062aBYQdK','system','uADBk','pinnedDocs','abort','exports','streamGetChatCompletion','slug','getChatCompletion','hasNamespace','topN','limits','6631305PSxcNQ','streamingEnabled','1325356PbiuXQ','../helpers/chat/responses','2992008hXvwbY','zQiHB','pageContent','namespaceCount','then','../../models/workspaceChats','length','similarityThreshold','SGxls','.\x20Will\x20use\x20regular\x20chat\x20method.','isSafe','textResponse','textResponseChunk','openAiHistory','../DocumentManager','OounM','This\x20message\x20was\x20moderated\x20and\x20will\x20not\x20be\x20allowed.\x20Violations\x20for\x20','log','GAygr','compressMessages','vJBoY','includes','1801014Zwepug','sources','handleStream','bOhgB','oIuse','uuid','new','\x20found.','28OnJtzB'];_0x3fe8=function(){return _0x52fd8d;};return _0x3fe8();}module[_0x3ccb32(0x132)]={'VALID_CHAT_MODE':VALID_CHAT_MODE,'streamChatWithWorkspace':streamChatWithWorkspace};