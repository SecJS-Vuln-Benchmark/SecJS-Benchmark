const _0x4473be=_0xb182;function _0xa42d(){const _0x40f608=['getAssetFromStorage','createdAt','error','assets','wcmaY','user','UIuqW','generateHash','warn','760355VhHuhl','$beforeInsert','code','assetData','EPIPE','patch','upload','constants','tTpSI','parse','models','hhjWB','1642640SgkimF','join','fIJWG','hash','TxCKk','sendStatus','uploads','ext','integer','CeVlV','emptyDir','moment','string','assetFolders.id','startsWith','getAssetPath','skipStorage','$beforeUpdate','lodash','remove','relationMappings','type','exports','path','4gmpvwZ','size','config','assets.authorId','toISOString','UxJyQ','resolve','EqGfA','objection','12lLXpub','authorId','name','WpsGU','kfpHX','getAssetFromCache','folderId','33844RxBbmO','deleteAssetCache','update','storage','getAssetFromDb','LCHve','utc','6699608aieXSd','xFqjw','first','outputFile','getAsset','ROOTPATH','map','7SALbGE','.dat','tableName','ffIxW','RplfD','4675818gDlcIf','VYApR','ECONNABORTED','logger','uGtLA','object','24096vGQULe','filename','9957762yKrDMM','mimetype','email','query','readFile','deny','sendFile','BelongsToOneRelation','cache/','tEbGy','dataPath','move','where','./assetFolders','flushTempUploads','bluebird','originalname','mode','users.id','epGGi','fs-extra','updatedAt','copy','knex','data','GlAmx','filter'];_0xa42d=function(){return _0x40f608;};return _0xa42d();}function _0xb182(_0x24a966,_0x366561){const _0xa42d5c=_0xa42d();return _0xb182=function(_0xb182be,_0x2a23d3){_0xb182be=_0xb182be-0x1e8;let _0x3e22b5=_0xa42d5c[_0xb182be];return _0x3e22b5;},_0xb182(_0x24a966,_0x366561);}(function(_0x135666,_0x1086da){const _0x4b506a=_0xb182,_0x40a7a3=_0x135666();while(!![]){try{const _0x4f7480=parseInt(_0x4b506a(0x22d))/0x1*(-parseInt(_0x4b506a(0x23d))/0x2)+-parseInt(_0x4b506a(0x236))/0x3*(parseInt(_0x4b506a(0x256))/0x4)+-parseInt(_0x4b506a(0x209))/0x5+parseInt(_0x4b506a(0x250))/0x6+parseInt(_0x4b506a(0x24b))/0x7*(-parseInt(_0x4b506a(0x244))/0x8)+parseInt(_0x4b506a(0x258))/0x9+-parseInt(_0x4b506a(0x215))/0xa;if(_0x4f7480===_0x1086da)break;else _0x40a7a3['push'](_0x40a7a3['shift']());}catch(_0x18dc34){_0x40a7a3['push'](_0x40a7a3['shift']());}}}(_0xa42d,0x9c497));const Model=require(_0x4473be(0x235))['Model'],moment=require(_0x4473be(0x220)),path=require(_0x4473be(0x22c)),fs=require(_0x4473be(0x1f9)),_=require(_0x4473be(0x227)),assetHelper=require('../helpers/asset'),Promise=require(_0x4473be(0x1f4));module[_0x4473be(0x22b)]=class Asset extends Model{static get[_0x4473be(0x24d)](){const _0x22793b=_0x4473be,_0x57e7a6={'ffIxW':_0x22793b(0x203)};return _0x57e7a6[_0x22793b(0x24e)];}static get['jsonSchema'](){const _0x17f3cf=_0x4473be,_0x47a3c2={'fIJWG':'string','VYApR':_0x17f3cf(0x255)};return{'type':_0x17f3cf(0x255),'properties':{'id':{'type':_0x17f3cf(0x21d)},'filename':{'type':_0x17f3cf(0x221)},'hash':{'type':'string'},'ext':{'type':_0x17f3cf(0x221)},'kind':{'type':_0x47a3c2[_0x17f3cf(0x217)]},'mime':{'type':_0x47a3c2['fIJWG']},'fileSize':{'type':'integer'},'metadata':{'type':_0x47a3c2[_0x17f3cf(0x251)]},'createdAt':{'type':'string'},'updatedAt':{'type':_0x17f3cf(0x221)}}};}static get[_0x4473be(0x229)](){const _0x4f577b=_0x4473be,_0x5de947={'epGGi':_0x4f577b(0x1f7),'EqGfA':function(_0xa2d185,_0x5cf382){return _0xa2d185(_0x5cf382);},'UxJyQ':_0x4f577b(0x1f2)};return{'author':{'relation':Model[_0x4f577b(0x1ec)],'modelClass':require('./users'),'join':{'from':_0x4f577b(0x230),'to':_0x5de947[_0x4f577b(0x1f8)]}},'folder':{'relation':Model[_0x4f577b(0x1ec)],'modelClass':_0x5de947[_0x4f577b(0x234)](require,_0x5de947[_0x4f577b(0x232)]),'join':{'from':'assets.folderId','to':_0x4f577b(0x222)}}};}async[_0x4473be(0x226)](_0x33b059,_0x3f3b48){const _0xd3fdb5=_0x4473be;await super[_0xd3fdb5(0x226)](_0x33b059,_0x3f3b48),this['updatedAt']=moment[_0xd3fdb5(0x243)]()[_0xd3fdb5(0x231)]();}async[_0x4473be(0x20a)](_0x5c96c3){const _0x4e4db6=_0x4473be;await super[_0x4e4db6(0x20a)](_0x5c96c3),this[_0x4e4db6(0x201)]=moment['utc']()[_0x4e4db6(0x231)](),this[_0x4e4db6(0x1fa)]=moment[_0x4e4db6(0x243)]()[_0x4e4db6(0x231)]();}async[_0x4473be(0x224)](){const _0x1a6e97=_0x4473be,_0x346214={'wcmaY':function(_0x192be0,_0x18b83a){return _0x192be0+_0x18b83a;}};let _0x32319d=[];return this[_0x1a6e97(0x23c)]&&(_0x32319d=await WIKI['models']['assetFolders']['getHierarchy'](this[_0x1a6e97(0x23c)])),this[_0x1a6e97(0x23c)]?_0x346214[_0x1a6e97(0x204)](_0x32319d[_0x1a6e97(0x24a)](_0x33e80a=>_0x33e80a['slug'])[_0x1a6e97(0x216)]('/'),'/'+this[_0x1a6e97(0x257)]):this[_0x1a6e97(0x257)];}async[_0x4473be(0x23e)](){const _0x6b0ef9=_0x4473be;await fs[_0x6b0ef9(0x228)](path[_0x6b0ef9(0x233)](WIKI[_0x6b0ef9(0x249)],WIKI[_0x6b0ef9(0x22f)][_0x6b0ef9(0x1ef)],_0x6b0ef9(0x1ed)+this[_0x6b0ef9(0x218)]+_0x6b0ef9(0x24c)));}static async[_0x4473be(0x20f)](_0x4459d5){const _0x2e11f0=_0x4473be,_0x2e1cc0={'kfpHX':_0x2e11f0(0x21d),'UIuqW':'string','LCHve':_0x2e11f0(0x255),'rrWPc':'image/','RplfD':'binary','GlAmx':function(_0x56d419,_0x51ad5e){return _0x56d419!==_0x51ad5e;},'WpsGU':_0x2e11f0(0x254),'hhjWB':function(_0x4d979d,_0x4fdf9e){return _0x4d979d===_0x4fdf9e;},'CeVlV':function(_0x17eb52,_0x47e47e){return _0x17eb52===_0x47e47e;},'tEbGy':'uploaded'},_0x2196b4=path[_0x2e11f0(0x212)](_0x4459d5[_0x2e11f0(0x1f5)]),_0x33727c=assetHelper[_0x2e11f0(0x207)](_0x4459d5['assetPath']);let _0x2c9c15=await WIKI[_0x2e11f0(0x213)][_0x2e11f0(0x203)][_0x2e11f0(0x1e8)]()['where']({'hash':_0x33727c,'folderId':_0x4459d5['folderId']})[_0x2e11f0(0x246)](),_0x39cfc0={'filename':_0x4459d5['originalname'],'hash':_0x33727c,'ext':_0x2196b4['ext'],'kind':_[_0x2e11f0(0x223)](_0x4459d5[_0x2e11f0(0x259)],_0x2e1cc0['rrWPc'])?'image':_0x2e1cc0[_0x2e11f0(0x24f)],'mime':_0x4459d5['mimetype'],'fileSize':_0x4459d5[_0x2e11f0(0x22e)],'folderId':_0x4459d5[_0x2e11f0(0x23c)]};try{const _0x2d91f0=await fs[_0x2e11f0(0x1e9)](_0x4459d5[_0x2e11f0(0x22c)]);if(_0x2c9c15){if(_0x2e1cc0[_0x2e11f0(0x1fe)](_0x2e1cc0[_0x2e11f0(0x239)],'CPgyy'))_0x2e1cc0[_0x2e11f0(0x214)](_0x4459d5[_0x2e11f0(0x1f6)],_0x2e11f0(0x20f))&&(_0x39cfc0['authorId']=_0x4459d5['user']['id']),await WIKI[_0x2e11f0(0x213)][_0x2e11f0(0x203)][_0x2e11f0(0x1e8)]()[_0x2e11f0(0x20e)](_0x39cfc0)['findById'](_0x2c9c15['id']),await WIKI[_0x2e11f0(0x213)][_0x2e11f0(0x1fc)]('assetData')['where']({'id':_0x2c9c15['id']})[_0x2e11f0(0x23f)]({'data':_0x2d91f0});else return{'type':'object','properties':{'id':{'type':_0x2e1cc0[_0x2e11f0(0x23a)]},'filename':{'type':'string'},'hash':{'type':_0x2e11f0(0x221)},'ext':{'type':_0x2e11f0(0x221)},'kind':{'type':_0x2e1cc0[_0x2e11f0(0x206)]},'mime':{'type':_0x2e11f0(0x221)},'fileSize':{'type':_0x2e1cc0[_0x2e11f0(0x23a)]},'metadata':{'type':_0x2e1cc0[_0x2e11f0(0x242)]},'createdAt':{'type':_0x2e1cc0['UIuqW']},'updatedAt':{'type':_0x2e1cc0['UIuqW']}}};}else _0x39cfc0[_0x2e11f0(0x237)]=_0x4459d5[_0x2e11f0(0x205)]['id'],_0x2c9c15=await WIKI[_0x2e11f0(0x213)]['assets'][_0x2e11f0(0x1e8)]()['insert'](_0x39cfc0),await WIKI['models'][_0x2e11f0(0x1fc)](_0x2e11f0(0x20c))['insert']({'id':_0x2c9c15['id'],'data':_0x2d91f0});_0x2e1cc0[_0x2e11f0(0x21e)](_0x4459d5[_0x2e11f0(0x1f6)],_0x2e11f0(0x20f))?await fs[_0x2e11f0(0x1f0)](_0x4459d5[_0x2e11f0(0x22c)],path[_0x2e11f0(0x233)](WIKI['ROOTPATH'],WIKI[_0x2e11f0(0x22f)]['dataPath'],_0x2e11f0(0x1ed)+_0x33727c+'.dat'),{'overwrite':!![]}):await fs[_0x2e11f0(0x1fb)](_0x4459d5[_0x2e11f0(0x22c)],path[_0x2e11f0(0x233)](WIKI[_0x2e11f0(0x249)],WIKI[_0x2e11f0(0x22f)]['dataPath'],_0x2e11f0(0x1ed)+_0x33727c+_0x2e11f0(0x24c)),{'overwrite':!![]}),!_0x4459d5[_0x2e11f0(0x225)]&&await WIKI[_0x2e11f0(0x213)][_0x2e11f0(0x240)]['assetEvent']({'event':_0x2e1cc0[_0x2e11f0(0x1ee)],'asset':{..._0x2c9c15,'path':await _0x2c9c15[_0x2e11f0(0x224)](),'data':_0x2d91f0,'authorId':_0x4459d5[_0x2e11f0(0x205)]['id'],'authorName':_0x4459d5['user'][_0x2e11f0(0x238)],'authorEmail':_0x4459d5[_0x2e11f0(0x205)][_0x2e11f0(0x25a)]}});}catch(_0x23ed6e){WIKI[_0x2e11f0(0x253)][_0x2e11f0(0x208)](_0x23ed6e);}}static async[_0x4473be(0x248)](_0xd4e7e1,_0x577bed){const _0x408ed8=_0x4473be,_0x34b49b={'tTpSI':_0x408ed8(0x219),'xFqjw':function(_0x51e1cf,_0x5ed98a){return _0x51e1cf===_0x5ed98a;}};try{const _0x1ae2ea=assetHelper['generateHash'](_0xd4e7e1),_0x36d9d2=path[_0x408ed8(0x233)](WIKI[_0x408ed8(0x249)],WIKI[_0x408ed8(0x22f)][_0x408ed8(0x1ef)],'cache/'+_0x1ae2ea+_0x408ed8(0x24c));if(await WIKI[_0x408ed8(0x213)][_0x408ed8(0x203)]['getAssetFromCache'](_0xd4e7e1,_0x36d9d2,_0x577bed))return;if(await WIKI[_0x408ed8(0x213)][_0x408ed8(0x203)][_0x408ed8(0x200)](_0xd4e7e1,_0x577bed))return;await WIKI[_0x408ed8(0x213)][_0x408ed8(0x203)][_0x408ed8(0x241)](_0xd4e7e1,_0x1ae2ea,_0x36d9d2,_0x577bed);}catch(_0x86bbb1){if(_0x34b49b[_0x408ed8(0x211)]!==_0x408ed8(0x219))return![];else{if(_0x86bbb1[_0x408ed8(0x20b)]===_0x408ed8(0x252)||_0x34b49b[_0x408ed8(0x245)](_0x86bbb1[_0x408ed8(0x20b)],_0x408ed8(0x20d)))return;WIKI[_0x408ed8(0x253)][_0x408ed8(0x202)](_0x86bbb1),_0x577bed[_0x408ed8(0x21a)](0x1f4);}}}static async[_0x4473be(0x23b)](_0x5a938e,_0x566596,_0x3fd835){const _0x3b4b89=_0x4473be,_0x5a2b2a={'XqSkm':_0x3b4b89(0x1ea)};try{await fs['access'](_0x566596,fs[_0x3b4b89(0x210)]['R_OK']);}catch(_0x45c1b5){return![];}const _0x14c91a=Promise['promisify'](_0x3fd835[_0x3b4b89(0x1eb)],{'context':_0x3fd835});return _0x3fd835[_0x3b4b89(0x22a)](path['extname'](_0x5a938e)),await _0x14c91a(_0x566596,{'dotfiles':_0x5a2b2a['XqSkm']}),!![];}static async[_0x4473be(0x200)](_0xc82af7,_0x3b5fc8){const _0x2489d2=_0x4473be,_0x379a06=await WIKI[_0x2489d2(0x213)][_0x2489d2(0x240)]['getLocalLocations']({'asset':{'path':_0xc82af7}});for(let _0x1a0788 of _[_0x2489d2(0x1ff)](_0x379a06,_0x3aacde=>Boolean(_0x3aacde[_0x2489d2(0x22c)]))){const _0x5e473a=await WIKI[_0x2489d2(0x213)]['assets'][_0x2489d2(0x23b)](_0xc82af7,_0x1a0788['path'],_0x3b5fc8);if(_0x5e473a)return!![];}return![];}static async['getAssetFromDb'](_0x51ae75,_0x2be6fe,_0x56d6c3,_0x4761eb){const _0x23948d=_0x4473be,_0x3d2ea5=await WIKI[_0x23948d(0x213)][_0x23948d(0x203)][_0x23948d(0x1e8)]()[_0x23948d(0x1f1)](_0x23948d(0x218),_0x2be6fe)['first']();if(_0x3d2ea5){const _0x93a0f2=await WIKI['models'][_0x23948d(0x1fc)]('assetData')[_0x23948d(0x1f1)]('id',_0x3d2ea5['id'])[_0x23948d(0x246)]();_0x4761eb[_0x23948d(0x22a)](_0x3d2ea5[_0x23948d(0x21c)]),_0x4761eb['send'](_0x93a0f2[_0x23948d(0x1fd)]),await fs[_0x23948d(0x247)](_0x56d6c3,_0x93a0f2[_0x23948d(0x1fd)]);}else _0x4761eb[_0x23948d(0x21a)](0x194);}static async[_0x4473be(0x1f3)](){const _0x50aa82=_0x4473be;return fs[_0x50aa82(0x21f)](path[_0x50aa82(0x233)](WIKI['ROOTPATH'],WIKI[_0x50aa82(0x22f)][_0x50aa82(0x1ef)],_0x50aa82(0x21b)));}};