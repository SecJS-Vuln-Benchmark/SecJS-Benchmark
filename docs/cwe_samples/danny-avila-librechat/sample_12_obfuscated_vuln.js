const _0xf5e23=_0x5de2;function _0x2d85(){const _0x1d68ab=['EwUar','tool_resource','retrieve','EHYgc','UurYa','all','test','./strategies','EIwMF','177891jdqELh','fqDKC','Error\x20while\x20processing\x20the\x20image\x20with\x20','[retrieveAndProcessFile]\x20Non-image\x20file\x20type\x20detected:\x20','DwFwp','exports','baseURL','~/server/utils','Yzlll','/files/','message','No\x20tool\x20resource\x20provided\x20for\x20agent\x20file\x20upload','Error\x20deleting\x20file','model','HLHsL','nhESc','assistant_id','13230300iEKKDy','ZaSRU','eIMqK','json','pePQU','message_file','avatar\x20upload','processedFileIds','JXvfj','error','req','content','agent_id','getType','~/server/utils/queue','AbNlT','QvpYx','filename','~/config','app','filepath','Xrlas','openai','No\x20agent\x20ID\x20provided\x20for\x20agent\x20file\x20upload','ZPsEZ','728583WuQJzm','emxxh','width','source','image','status','535120hIzSyb','KgDrO','vVJCP','push','ePZgU','IqaYi','Qecrf','from','endpoints','locals','del','vKRkD','No\x20file_id\x20provided','Bszfx','mime','execute_code','nBrZQ','local','files','DbNUm','Mmqyy','OXkWv','beta','parse','3892788bOXaBP','Error\x20downloading\x20file\x20from\x20OpenAI:','startsWith','user','AlmfT','Error\x20deleting\x20file\x20from\x20OpenAI\x20source','VDoCZ','avatarSizeLimit','CODE_API_KEY','assistants','mimetype','vectordb','qHWqX','librechat-data-provider','gQSNI','CuGSF','Failed\x20to\x20process\x20the\x20image\x20with\x20','Empty\x20file\x20uploaded','toISOString','RNHQD','mROuP','has','size','originalname','bnBsK','azureOpenAI','default','2395782Idehgk','zaKep','purpose','HgVSL','height','azureAssistants','LvfLW','~/app/clients/tools/util','agiAg','catch','fileStrategy','BCzWG','oblGF','file_search','endpoint','path','QpzSf','create','cdklX','uLBxp','No\x20height\x20provided','OoDtl','iLaAg','~/server/services/Files/images','hGELc','ggwYb','uuid','94143BSdaAO','File\x20uploaded\x20and\x20processed\x20successfully','basename','file_id','tZfiM','fhxqy','nxWDg','fileConfig','NkAQB','createReadStream','extname','allSettled','image/','Image\x20uploads\x20are\x20not\x20supported\x20for\x20file\x20search\x20tool\x20resources','imageOutputType','OcMmE','azure','FMfEE','file','File\x20size\x20limit\x20of\x20','QxDLh','body','WQevi','zmLQZ','8jvVbKM','JEPZD','Error\x20updating\x20file\x20usage','4HMvnhU','Ymzlr','PGoCF','MZAGb','StmAk','Unsupported\x20file\x20type','WWnqG','KnExN','~/models/File','reject','SOTsh','304EaHQfx','high'];_0x2d85=function(){return _0x1d68ab;};return _0x2d85();}(function(_0x5cfe92,_0x376813){const _0x2f486d=_0x5de2,_0x16e26f=_0x5cfe92();while(!![]){try{const _0x5cff6a=parseInt(_0x2f486d(0x87))/0x1*(-parseInt(_0x2f486d(0x6e))/0x2)+parseInt(_0x2f486d(0xb1))/0x3+parseInt(_0x2f486d(0x71))/0x4*(parseInt(_0x2f486d(0xb7))/0x5)+-parseInt(_0x2f486d(0xea))/0x6+parseInt(_0x2f486d(0x105))/0x7*(parseInt(_0x2f486d(0x7c))/0x8)+-parseInt(_0x2f486d(0xcf))/0x9+parseInt(_0x2f486d(0x98))/0xa;if(_0x5cff6a===_0x376813)break;else _0x16e26f['push'](_0x16e26f['shift']());}catch(_0x53738a){_0x16e26f['push'](_0x16e26f['shift']());}}}(_0x2d85,0x9c648));const fs=require('fs'),path=require(_0xf5e23(0xf9)),mime=require(_0xf5e23(0xc5)),{v4}=require(_0xf5e23(0x104)),{isUUID,megabyte,FileContext,FileSources,imageExtRegex,EModelEndpoint,EToolResources,mergeFileConfig,hostImageIdSuffix,checkOpenAIStorage,removeNullishValues,hostImageNamePrefix,isAssistantsEndpoint}=require(_0xf5e23(0xdc)),{EnvVar}=require('@librechat/agents'),{addResourceFileId,deleteResourceFileId}=require('~/server/controllers/assistants/v2'),{convertImage,resizeAndConvert}=require(_0xf5e23(0x101)),{addAgentResourceFile,removeAgentResourceFile}=require('~/models/Agent'),{getOpenAIClient}=require('~/server/controllers/assistants/helpers'),{createFile,updateFileUsage,deleteFiles}=require(_0xf5e23(0x79)),{loadAuthValues}=require(_0xf5e23(0xf1)),{LB_QueueAsyncCall}=require(_0xf5e23(0xa6)),{getStrategyFunctions}=require(_0xf5e23(0x85)),{determineFileType}=require(_0xf5e23(0x8e)),{logger}=require(_0xf5e23(0xaa)),processFiles=async _0xac95b7=>{const _0x4904c9=_0xf5e23,_0x3a0c61={'fqDKC':function(_0x4764b1,_0x1547b9){return _0x4764b1(_0x1547b9);}},_0x5f3575=[];for(let _0x39b214 of _0xac95b7){const {file_id:_0x34e189}=_0x39b214;_0x5f3575[_0x4904c9(0xba)](_0x3a0c61[_0x4904c9(0x88)](updateFileUsage,{'file_id':_0x34e189}));}return await Promise[_0x4904c9(0x83)](_0x5f3575);};function _0x5de2(_0x1b3eba,_0x53b1bc){const _0x2d856c=_0x2d85();return _0x5de2=function(_0x5de23b,_0x856ed9){_0x5de23b=_0x5de23b-0x6e;let _0x2b238b=_0x2d856c[_0x5de23b];return _0x2b238b;},_0x5de2(_0x1b3eba,_0x53b1bc);}function enqueueDeleteOperation({req:_0xf47a8,file:_0x5f5dcf,deleteFile:_0x3cde25,promises:_0x384d8a,resolvedFileIds:_0x5c8a9a,openai:_0xe29ae0}){const _0x3002b9=_0xf5e23,_0x52cccd={'FMfEE':function(_0x3992cb,_0x52a64e){return _0x3992cb(_0x52a64e);},'RNHQD':function(_0x5ddb2c,_0x12b4e9){return _0x5ddb2c(_0x12b4e9);}};_0x52cccd[_0x3002b9(0xe2)](checkOpenAIStorage,_0x5f5dcf['source'])?_0x384d8a[_0x3002b9(0xba)](new Promise((_0x5417a4,_0x35ae57)=>{const _0x330e3a={'Ymzlr':function(_0xc1cab9,_0x5e8a91){return _0xc1cab9(_0x5e8a91);},'JXvfj':function(_0x31faa8,_0x106fc9){const _0x1e1ae4=_0x5de2;return _0x52cccd[_0x1e1ae4(0x116)](_0x31faa8,_0x106fc9);}};LB_QueueAsyncCall(()=>_0x3cde25(_0xf47a8,_0x5f5dcf,_0xe29ae0),[],(_0x362f71,_0x353d16)=>{const _0x4170cc=_0x5de2;_0x362f71?(logger['error'](_0x4170cc(0xd4),_0x362f71),_0x330e3a[_0x4170cc(0x72)](_0x35ae57,_0x362f71)):(_0x5c8a9a[_0x4170cc(0xba)](_0x5f5dcf[_0x4170cc(0x108)]),_0x330e3a[_0x4170cc(0xa0)](_0x5417a4,_0x353d16));});})):_0x384d8a[_0x3002b9(0xba)](_0x3cde25(_0xf47a8,_0x5f5dcf)['then'](()=>_0x5c8a9a['push'](_0x5f5dcf[_0x3002b9(0x108)]))[_0x3002b9(0xf3)](_0x3ff764=>{const _0x13ab29=_0x3002b9;return logger[_0x13ab29(0xa1)](_0x13ab29(0x93),_0x3ff764),Promise[_0x13ab29(0x7a)](_0x3ff764);}));}const processDeleteRequest=async({req:_0x154559,files:_0x54966d})=>{const _0x12084c=_0xf5e23,_0x346e57={'Yzlll':_0x12084c(0xfe),'StmAk':function(_0x499127){return _0x499127();},'ePZgU':function(_0x48fc0b,_0x5ce22f){return _0x48fc0b(_0x5ce22f);},'KgDrO':function(_0x178e91,_0x38ada5){return _0x178e91!==_0x38ada5;},'QpzSf':'mROuP','WWnqG':function(_0x47940b,_0x127c4e){return _0x47940b(_0x127c4e);},'QxDLh':function(_0x23a8b8,_0x1992c5){return _0x23a8b8===_0x1992c5;},'AbNlT':_0x12084c(0x100)},_0x4db8b8=[],_0x54ef96={},_0x5c9f36=[],_0x40afa5={[FileSources[_0x12084c(0xae)]]:undefined,[FileSources[_0x12084c(0x115)]]:undefined},_0x4240cf=async()=>{const _0x45fa36=_0x12084c,_0x13014e=await getOpenAIClient({'req':_0x154559,'overrideEndpoint':EModelEndpoint[_0x45fa36(0xd8)]});_0x40afa5[FileSources[_0x45fa36(0xae)]]=_0x13014e[_0x45fa36(0xae)];if(!_0x154559[_0x45fa36(0xab)][_0x45fa36(0xc0)][EModelEndpoint[_0x45fa36(0xe8)]]?.[_0x45fa36(0xd8)]){if(_0x45fa36(0xe7)===_0x45fa36(0xe7))return;else return _0x51dce8;}const _0x20a788=await getOpenAIClient({'req':_0x154559,'overrideEndpoint':EModelEndpoint['azureAssistants']});_0x40afa5[FileSources[_0x45fa36(0x115)]]=_0x20a788[_0x45fa36(0xae)];};_0x154559[_0x12084c(0x11a)][_0x12084c(0x97)]!==undefined&&await _0x346e57[_0x12084c(0x75)](_0x4240cf);for(const _0x3ec7eb of _0x54966d){const _0x265213=_0x3ec7eb[_0x12084c(0xb4)]??FileSources[_0x12084c(0xc8)];_0x154559[_0x12084c(0x11a)][_0x12084c(0xa4)]&&_0x154559[_0x12084c(0x11a)]['tool_resource']&&_0x5c9f36[_0x12084c(0xba)](_0x346e57[_0x12084c(0xbb)](removeAgentResourceFile,{'req':_0x154559,'file_id':_0x3ec7eb[_0x12084c(0x108)],'agent_id':_0x154559[_0x12084c(0x11a)][_0x12084c(0xa4)],'tool_resource':_0x154559[_0x12084c(0x11a)][_0x12084c(0x7f)]}));checkOpenAIStorage(_0x265213)&&!_0x40afa5[_0x265213]&&await _0x4240cf();const _0x3be1fc=_0x40afa5[_0x265213];if(_0x154559[_0x12084c(0x11a)][_0x12084c(0x97)]&&_0x154559['body'][_0x12084c(0x7f)]){if(_0x346e57[_0x12084c(0xb8)](_0x12084c(0xe3),_0x346e57[_0x12084c(0xfa)]))throw new _0x28f452(_0x12084c(0xaf));else _0x5c9f36[_0x12084c(0xba)](_0x346e57[_0x12084c(0x77)](deleteResourceFileId,{'req':_0x154559,'openai':_0x3be1fc,'file_id':_0x3ec7eb[_0x12084c(0x108)],'assistant_id':_0x154559[_0x12084c(0x11a)]['assistant_id'],'tool_resource':_0x154559[_0x12084c(0x11a)][_0x12084c(0x7f)]}));}else _0x154559[_0x12084c(0x11a)][_0x12084c(0x97)]&&_0x5c9f36[_0x12084c(0xba)](_0x3be1fc[_0x12084c(0xcd)][_0x12084c(0xd8)][_0x12084c(0xc9)][_0x12084c(0xc1)](_0x154559[_0x12084c(0x11a)]['assistant_id'],_0x3ec7eb[_0x12084c(0x108)]));if(_0x54ef96[_0x265213]){if(_0x346e57[_0x12084c(0x119)](_0x346e57[_0x12084c(0xa7)],_0x346e57[_0x12084c(0xa7)])){enqueueDeleteOperation({'req':_0x154559,'file':_0x3ec7eb,'deleteFile':_0x54ef96[_0x265213],'promises':_0x5c9f36,'resolvedFileIds':_0x4db8b8,'openai':_0x3be1fc});continue;}else throw new _0x15685e(_0x346e57[_0x12084c(0x8f)]);}const {deleteFile:_0x312dd0}=getStrategyFunctions(_0x265213);if(!_0x312dd0)throw new Error('Delete\x20function\x20not\x20implemented\x20for\x20'+_0x265213);_0x54ef96[_0x265213]=_0x312dd0,enqueueDeleteOperation({'req':_0x154559,'file':_0x3ec7eb,'deleteFile':_0x312dd0,'promises':_0x5c9f36,'resolvedFileIds':_0x4db8b8,'openai':_0x3be1fc});}await Promise[_0x12084c(0x110)](_0x5c9f36),await deleteFiles(_0x4db8b8);},processFileURL=async({fileStrategy:_0x1edbbc,userId:_0x171547,URL:_0x19f8bb,fileName:_0x2e1a51,basePath:_0xdc0162,context:_0x5afd61})=>{const _0x2e30aa=_0xf5e23,_0xec0ef={'zmLQZ':function(_0x10d3e0,_0x18c18d){return _0x10d3e0===_0x18c18d;},'EHYgc':_0x2e30aa(0x82),'CuGSF':function(_0x5bb26e,_0x262a3c){return _0x5bb26e(_0x262a3c);},'MZAGb':function(_0x40a079,_0x239e7a,_0x4bf374){return _0x40a079(_0x239e7a,_0x4bf374);},'QCAeL':function(_0x501b2d){return _0x501b2d();}},{saveURL:_0xf6cd18,getFileURL:_0x4546f5}=getStrategyFunctions(_0x1edbbc);try{if(_0xec0ef[_0x2e30aa(0x11c)](_0xec0ef[_0x2e30aa(0x81)],_0x2e30aa(0x9c)))_0x33b136[_0x2e30aa(0xce)](_0xdd8f6c);else{const {bytes:bytes=0x0,type:type='',dimensions:dimensions={}}=await _0xf6cd18({'userId':_0x171547,'URL':_0x19f8bb,'fileName':_0x2e1a51,'basePath':_0xdc0162})||{},_0x416032=await _0xec0ef[_0x2e30aa(0xde)](_0x4546f5,{'fileName':_0x171547+'/'+_0x2e1a51,'basePath':_0xdc0162});return await _0xec0ef[_0x2e30aa(0x74)](createFile,{'user':_0x171547,'file_id':_0xec0ef['QCAeL'](v4),'bytes':bytes,'filepath':_0x416032,'filename':_0x2e1a51,'source':_0x1edbbc,'type':type,'context':_0x5afd61,'width':dimensions[_0x2e30aa(0xb3)],'height':dimensions[_0x2e30aa(0xee)]},!![]);}}catch(_0x15fcac){logger['error'](_0x2e30aa(0x89)+_0x1edbbc+':',_0x15fcac);throw new Error(_0x2e30aa(0xdf)+_0x1edbbc+'.\x20'+_0x15fcac[_0x2e30aa(0x91)]);}},processImageFile=async({req:_0x12ad42,res:_0x31cb2f,file:_0x23758e,metadata:_0x2f884d,returnFile:returnFile=![]})=>{const _0x2ab0dc=_0xf5e23,_0x22e82b={'YpKds':function(_0x31bdb4,_0x1186bb){return _0x31bdb4(_0x1186bb);},'TYSeN':function(_0x90a0e8,_0x2035f8,_0xbf7606){return _0x90a0e8(_0x2035f8,_0xbf7606);},'HLHsL':_0x2ab0dc(0x106)},_0x3901b5=_0x12ad42[_0x2ab0dc(0xab)]['locals'][_0x2ab0dc(0xf4)],{handleImageUpload:_0x5014a9}=_0x22e82b['YpKds'](getStrategyFunctions,_0x3901b5),{file_id:_0x225139,temp_file_id:_0x39b315,endpoint:_0xb09532}=_0x2f884d,{filepath:_0x3c1a03,bytes:_0x8008a6,width:_0x2ea4de,height:_0x19c881}=await _0x5014a9({'req':_0x12ad42,'file':_0x23758e,'file_id':_0x225139,'endpoint':_0xb09532}),_0x559ec2=await _0x22e82b['TYSeN'](createFile,{'user':_0x12ad42[_0x2ab0dc(0xd2)]['id'],'file_id':_0x225139,'temp_file_id':_0x39b315,'bytes':_0x8008a6,'filepath':_0x3c1a03,'filename':_0x23758e[_0x2ab0dc(0xe6)],'context':FileContext['message_attachment'],'source':_0x3901b5,'type':_0x2ab0dc(0x111)+_0x12ad42[_0x2ab0dc(0xab)]['locals'][_0x2ab0dc(0x113)],'width':_0x2ea4de,'height':_0x19c881},!![]);if(returnFile)return _0x559ec2;_0x31cb2f[_0x2ab0dc(0xb6)](0xc8)[_0x2ab0dc(0x9b)]({'message':_0x22e82b[_0x2ab0dc(0x95)],..._0x559ec2});},uploadImageBuffer=async({req:_0xf3beaa,context:_0x4c3a0e,metadata:metadata={},resize:resize=!![]})=>{const _0x4d1514=_0xf5e23,_0x4e8f48={'EIwMF':_0x4d1514(0x96),'QvpYx':function(_0x401001,_0x3a2bf0,_0x2207e1){return _0x401001(_0x3a2bf0,_0x2207e1);}},_0x12ffae=_0xf3beaa[_0x4d1514(0xab)][_0x4d1514(0xc0)]['fileStrategy'],{saveBuffer:_0x224654}=getStrategyFunctions(_0x12ffae);let {buffer:_0x1207db,width:_0x1b330e,height:_0x294037,bytes:_0x193b00,filename:_0x5823e9,file_id:_0x3e989a,type:_0x44e951}=metadata;resize&&(_0x4d1514(0x96)!==_0x4e8f48[_0x4d1514(0x86)]?(_0x475df1[_0x4d1514(0xba)](_0x17a623['file_id']),_0x38bb88(_0x26fd13)):(_0x3e989a=v4(),_0x44e951=_0x4d1514(0x111)+_0xf3beaa[_0x4d1514(0xab)]['locals'][_0x4d1514(0x113)],{buffer:_0x1207db,width:_0x1b330e,height:_0x294037,bytes:_0x193b00}=await resizeAndConvert({'inputBuffer':_0x1207db,'desiredFormat':_0xf3beaa[_0x4d1514(0xab)]['locals']['imageOutputType']}),_0x5823e9=path[_0x4d1514(0x107)](_0xf3beaa[_0x4d1514(0x117)][_0x4d1514(0xe6)],path[_0x4d1514(0x10f)](_0xf3beaa[_0x4d1514(0x117)][_0x4d1514(0xe6)]))+'.'+_0xf3beaa[_0x4d1514(0xab)]['locals']['imageOutputType']));const _0x55b56e=await _0x224654({'userId':_0xf3beaa[_0x4d1514(0xd2)]['id'],'fileName':_0x5823e9,'buffer':_0x1207db});return await _0x4e8f48[_0x4d1514(0xa8)](createFile,{'user':_0xf3beaa['user']['id'],'file_id':_0x3e989a,'bytes':_0x193b00,'filepath':_0x55b56e,'filename':_0x5823e9,'context':_0x4c3a0e,'source':_0x12ffae,'type':_0x44e951,'width':_0x1b330e,'height':_0x294037},!![]);},processFileUpload=async({req:_0x2477b8,res:_0x531a2e,file:_0x27a761,metadata:_0x30c698})=>{const _0xbac6fe=_0xf5e23,_0x1babcf={'NNifZ':function(_0x2c5f0b,_0x445801){return _0x2c5f0b(_0x445801);},'emxxh':function(_0x4ccf87,_0x138db5){return _0x4ccf87(_0x138db5);},'tZfiM':function(_0x2b6c28,_0x261933){return _0x2b6c28(_0x261933);},'OcMmE':function(_0x1a1d2d,_0x50e4eb){return _0x1a1d2d??_0x50e4eb;},'Qecrf':_0xbac6fe(0x106)},_0x2271ae=_0x1babcf['NNifZ'](isAssistantsEndpoint,_0x30c698[_0xbac6fe(0xf8)]),_0x4e7d65=_0x30c698[_0xbac6fe(0xf8)]===EModelEndpoint[_0xbac6fe(0xef)]?FileSources['azure']:FileSources['openai'],_0x3b472f=_0x2271ae?_0x4e7d65:FileSources['vectordb'],{handleFileUpload:_0x44c7e0}=getStrategyFunctions(_0x3b472f),{file_id:_0x1aa136,temp_file_id:_0x1acc62}=_0x30c698;let _0x526a3f;_0x1babcf[_0xbac6fe(0xb2)](checkOpenAIStorage,_0x3b472f)&&({openai:_0x526a3f}=await _0x1babcf['emxxh'](getOpenAIClient,{'req':_0x2477b8}));const {id:_0x1bfa2a,bytes:_0x3157a6,filename:_0x1b2a78,filepath:_0x460fd8,embedded:_0x23088a,height:_0x21e4e8,width:_0x5cce8c}=await _0x44c7e0({'req':_0x2477b8,'file':_0x27a761,'file_id':_0x1aa136,'openai':_0x526a3f});if(_0x2271ae&&!_0x30c698['message_file']&&!_0x30c698[_0xbac6fe(0x7f)])await _0x526a3f[_0xbac6fe(0xcd)]['assistants']['files'][_0xbac6fe(0xfb)](_0x30c698[_0xbac6fe(0x97)],{'file_id':_0x1bfa2a});else _0x2271ae&&!_0x30c698[_0xbac6fe(0x9d)]&&await addResourceFileId({'req':_0x2477b8,'openai':_0x526a3f,'file_id':_0x1bfa2a,'assistant_id':_0x30c698[_0xbac6fe(0x97)],'tool_resource':_0x30c698[_0xbac6fe(0x7f)]});let _0x40dc8f=_0x2271ae?_0x526a3f[_0xbac6fe(0x8d)]+'/files/'+_0x1bfa2a:_0x460fd8;if(_0x2271ae&&_0x27a761[_0xbac6fe(0xd9)]['startsWith'](_0xbac6fe(0xb5))){const _0x3143ba=await _0x1babcf[_0xbac6fe(0x109)](processImageFile,{'req':_0x2477b8,'file':_0x27a761,'metadata':{'file_id':v4()},'returnFile':!![]});_0x40dc8f=_0x3143ba['filepath'];}const _0x56a1b2=await createFile({'user':_0x2477b8[_0xbac6fe(0xd2)]['id'],'file_id':_0x1babcf[_0xbac6fe(0x114)](_0x1bfa2a,_0x1aa136),'temp_file_id':_0x1acc62,'bytes':_0x3157a6,'filepath':_0x40dc8f,'filename':_0x1b2a78??_0x27a761[_0xbac6fe(0xe6)],'context':_0x2271ae?FileContext[_0xbac6fe(0xd8)]:FileContext['message_attachment'],'model':_0x2271ae?_0x2477b8[_0xbac6fe(0x11a)][_0xbac6fe(0x94)]:undefined,'type':_0x27a761[_0xbac6fe(0xd9)],'embedded':_0x23088a,'source':_0x3b472f,'height':_0x21e4e8,'width':_0x5cce8c},!![]);_0x531a2e['status'](0xc8)['json']({'message':_0x1babcf[_0xbac6fe(0xbd)],..._0x56a1b2});},processAgentFileUpload=async({req:_0x49baf8,res:_0xdbcdc6,file:_0x236e6b,metadata:_0x110fe5})=>{const _0x442e3c=_0xf5e23,_0xd65e22={'PGoCF':_0x442e3c(0x76),'DbNUm':function(_0x150a74,_0xb773b9){return _0x150a74!==_0xb773b9;},'oblGF':_0x442e3c(0x11b),'uLBxp':'No\x20tool\x20resource\x20provided\x20for\x20agent\x20file\x20upload','gQSNI':function(_0x2b0627,_0x21a20b){return _0x2b0627===_0x21a20b;},'HgVSL':_0x442e3c(0xb5),'LvfLW':function(_0x4d67d2,_0x1071d7){return _0x4d67d2&&_0x1071d7;},'vKRkD':function(_0x2b641c,_0x46b0b3){return _0x2b641c(_0x46b0b3);},'ZaSRU':function(_0x3908bf,_0x4b0374){return _0x3908bf(_0x4b0374);},'SOTsh':function(_0x390d70,_0x4a0007){return _0x390d70(_0x4a0007);},'giEPw':function(_0x342cd9,_0x17694d){return _0x342cd9(_0x17694d);},'cdklX':function(_0x457844){return _0x457844();},'VDoCZ':'Agent\x20file\x20uploaded\x20and\x20processed\x20successfully'},{agent_id:_0x28eac0,tool_resource:_0x37a25e}=_0x110fe5;if(_0x28eac0&&!_0x37a25e){if(_0xd65e22[_0x442e3c(0xca)](_0xd65e22[_0x442e3c(0xf6)],_0x442e3c(0x103)))throw new Error(_0xd65e22[_0x442e3c(0xfd)]);else throw new _0x369531(_0xd65e22[_0x442e3c(0x73)]);}if(_0xd65e22[_0x442e3c(0xdd)](_0x37a25e,EToolResources[_0x442e3c(0xf7)])&&_0x236e6b['mimetype'][_0x442e3c(0xd1)](_0xd65e22['HgVSL']))throw new Error(_0x442e3c(0x112));let _0x428b4c=!!_0x110fe5['message_file'];if(_0xd65e22[_0x442e3c(0xf0)](!_0x428b4c,!_0x28eac0))throw new Error(_0x442e3c(0xaf));let _0xec937d;if(_0xd65e22[_0x442e3c(0xdd)](_0x37a25e,EToolResources[_0x442e3c(0xc6)])){const {handleFileUpload:_0x52d34e}=_0xd65e22[_0x442e3c(0xc2)](getStrategyFunctions,FileSources['execute_code']),_0x3a6ce0=await _0xd65e22['ZaSRU'](loadAuthValues,{'userId':_0x49baf8[_0x442e3c(0xd2)]['id'],'authFields':[EnvVar[_0x442e3c(0xd7)]]}),_0x449e8c=fs[_0x442e3c(0x10e)](_0x236e6b['path']),_0x1dbca1=await _0xd65e22['vKRkD'](_0x52d34e,{'req':_0x49baf8,'stream':_0x449e8c,'filename':_0x236e6b[_0x442e3c(0xe6)],'apiKey':_0x3a6ce0[EnvVar[_0x442e3c(0xd7)]]});_0xec937d={'fileIdentifier':_0x1dbca1};}const _0x259789=_0xd65e22[_0x442e3c(0xdd)](_0x37a25e,EToolResources[_0x442e3c(0xf7)])?FileSources[_0x442e3c(0xda)]:_0x49baf8[_0x442e3c(0xab)][_0x442e3c(0xc0)]['fileStrategy'],{handleFileUpload:_0x2e566d}=_0xd65e22[_0x442e3c(0x7b)](getStrategyFunctions,_0x259789),{file_id:_0x567227,temp_file_id:_0x3cf270}=_0x110fe5,{bytes:_0x56a619,filename:_0x5ca080,filepath:_0xd03ba6,embedded:_0x1fc1b7,height:_0x5a7bfb,width:_0x46f281}=await _0xd65e22['vKRkD'](_0x2e566d,{'req':_0x49baf8,'file':_0x236e6b,'file_id':_0x567227});let _0x199de0=_0xd03ba6;!_0x428b4c&&_0x37a25e&&await _0xd65e22['giEPw'](addAgentResourceFile,{'req':_0x49baf8,'file_id':_0x567227,'agent_id':_0x28eac0,'tool_resource':_0x37a25e});if(_0x236e6b[_0x442e3c(0xd9)]['startsWith'](_0xd65e22[_0x442e3c(0xed)])){const _0x1a1649=await _0xd65e22[_0x442e3c(0x99)](processImageFile,{'req':_0x49baf8,'file':_0x236e6b,'metadata':{'file_id':_0xd65e22[_0x442e3c(0xfc)](v4)},'returnFile':!![]});_0x199de0=_0x1a1649[_0x442e3c(0xac)];}const _0x586e05=removeNullishValues({'user':_0x49baf8['user']['id'],'file_id':_0x567227,'temp_file_id':_0x3cf270,'bytes':_0x56a619,'filepath':_0x199de0,'filename':_0x5ca080??_0x236e6b[_0x442e3c(0xe6)],'context':_0x428b4c?FileContext['message_attachment']:FileContext['agents'],'model':_0x428b4c?undefined:_0x49baf8[_0x442e3c(0x11a)][_0x442e3c(0x94)],'metadata':_0xec937d,'type':_0x236e6b[_0x442e3c(0xd9)],'embedded':_0x1fc1b7,'source':_0x259789,'height':_0x5a7bfb,'width':_0x46f281}),_0x59009f=await createFile(_0x586e05,!![]);_0xdbcdc6[_0x442e3c(0xb6)](0xc8)[_0x442e3c(0x9b)]({'message':_0xd65e22[_0x442e3c(0xd5)],..._0x59009f});},processOpenAIFile=async({openai:_0x1ab637,file_id:_0x1c5d51,userId:_0x46b7ec,filename:_0x2d1498,saveFile:saveFile=![],updateUsage:updateUsage=![]})=>{const _0x303ba7=_0xf5e23,_0x5e2681={'EubSp':function(_0xebd6d2,_0x1692a3){return _0xebd6d2??_0x1692a3;},'ZKRZV':'LTywr'},_0x40b6dc=await _0x1ab637[_0x303ba7(0xc9)][_0x303ba7(0x80)](_0x1c5d51),_0x59a437=_0x2d1498??(_0x40b6dc[_0x303ba7(0xa9)]?path['basename'](_0x40b6dc[_0x303ba7(0xa9)]):undefined),_0x7a73cb=_0x1ab637['baseURL']+_0x303ba7(0x90)+_0x46b7ec+'/'+_0x1c5d51+(_0x59a437?'/'+_0x59a437:''),_0x229c81=mime['getType'](_0x59a437??_0x1c5d51),_0x382441=_0x1ab637[_0x303ba7(0xa2)][_0x303ba7(0x11a)][_0x303ba7(0xf8)]===EModelEndpoint[_0x303ba7(0xef)]?FileSources[_0x303ba7(0x115)]:FileSources[_0x303ba7(0xae)],_0x491b17={..._0x40b6dc,'type':_0x229c81,'file_id':_0x1c5d51,'filepath':_0x7a73cb,'usage':0x1,'user':_0x46b7ec,'context':_0x40b6dc[_0x303ba7(0xec)],'source':_0x382441,'model':_0x1ab637[_0x303ba7(0xa2)][_0x303ba7(0x11a)]['model'],'filename':_0x5e2681['EubSp'](_0x59a437,_0x1c5d51)};if(saveFile)await createFile(_0x491b17,!![]);else{if(updateUsage)try{await updateFileUsage({'file_id':_0x1c5d51});}catch(_0x3f3681){if(_0x5e2681['ZKRZV']!==_0x303ba7(0x9a))logger[_0x303ba7(0xa1)]('Error\x20updating\x20file\x20usage',_0x3f3681);else return null;}}return _0x491b17;},processOpenAIImageOutput=async({req:_0x545df8,buffer:_0x23cf75,file_id:_0x404942,filename:_0x4fdd3c,fileExt:_0x3ab48b})=>{const _0x5cfaea=_0xf5e23,_0x41f562={'IqaYi':function(_0x214b57,_0x3a6092,_0x41f78c){return _0x214b57(_0x3a6092,_0x41f78c);}},_0x2ad63b=new Date(),_0x2be396=_0x2ad63b[_0x5cfaea(0xe1)](),_0x58b12d=await convertImage(_0x545df8,_0x23cf75,_0x5cfaea(0x7d),''+_0x404942+_0x3ab48b),_0x32c65b={..._0x58b12d,'usage':0x1,'user':_0x545df8[_0x5cfaea(0xd2)]['id'],'type':_0x5cfaea(0x111)+_0x545df8['app'][_0x5cfaea(0xc0)][_0x5cfaea(0x113)],'createdAt':_0x2be396,'updatedAt':_0x2be396,'source':_0x545df8[_0x5cfaea(0xab)][_0x5cfaea(0xc0)][_0x5cfaea(0xf4)],'context':FileContext['assistants_output'],'file_id':''+_0x404942+hostImageIdSuffix,'filename':''+hostImageNamePrefix+_0x4fdd3c};createFile(_0x32c65b,!![]);const _0x4df3ba=_0x545df8[_0x5cfaea(0x11a)][_0x5cfaea(0xf8)]===EModelEndpoint[_0x5cfaea(0xef)]?FileSources[_0x5cfaea(0x115)]:FileSources[_0x5cfaea(0xae)];return _0x41f562[_0x5cfaea(0xbc)](createFile,{..._0x32c65b,'file_id':_0x404942,'filename':_0x4fdd3c,'source':_0x4df3ba,'type':mime[_0x5cfaea(0xa5)](_0x3ab48b)},!![]),_0x32c65b;};async function retrieveAndProcessFile({openai:_0x46d5e5,client:_0x25b003,file_id:_0x56fe84,basename:_0xb8d672,unknownType:_0x369713}){const _0x4ec6e2=_0xf5e23,_0x3712ff={'Mmqyy':'No\x20endpoint\x20provided','vVJCP':function(_0x4e300b,_0x1a2d94){return _0x4e300b(_0x1a2d94);},'EwUar':function(_0x3a4219,_0x113934){return _0x3a4219||_0x113934;},'LcUaa':function(_0x39aa67){return _0x39aa67();},'stpbi':function(_0x54875e,_0x43a644){return _0x54875e(_0x43a644);},'IFCjR':function(_0x19676b,_0x457ae2){return _0x19676b+_0x457ae2;},'DwFwp':function(_0xc38388,_0x1f9937){return _0xc38388!==_0x1f9937;},'KnExN':'NkAQB','ZBlxY':function(_0x159b8f,_0x399810){return _0x159b8f(_0x399810);},'cHgwG':function(_0xb0b4fa,_0x4e4109){return _0xb0b4fa!==_0x4e4109;},'qHWqX':_0x4ec6e2(0xd3),'BCzWG':function(_0x94757d,_0x1ac6bc){return _0x94757d(_0x1ac6bc);}};if(!_0x56fe84)return null;let _0x4f4c8b=_0xb8d672;const _0x535674={'openai':_0x46d5e5,'file_id':_0x56fe84,'filename':_0x4f4c8b,'userId':_0x25b003[_0x4ec6e2(0xa2)][_0x4ec6e2(0xd2)]['id']};if(!_0x4f4c8b)return await processOpenAIFile({..._0x535674,'saveFile':!![]});const _0x432a30=path['extname'](_0x4f4c8b);if(_0x25b003['attachedFileIds']?.[_0x4ec6e2(0xe4)](_0x56fe84)||_0x25b003[_0x4ec6e2(0x9f)]?.['has'](_0x56fe84))return _0x3712ff[_0x4ec6e2(0xb9)](processOpenAIFile,{..._0x535674,'updateUsage':!![]});const _0x389ac5=async()=>{const _0xdc2697=_0x4ec6e2,_0x460201=await _0x46d5e5['files'][_0xdc2697(0xa3)](_0x56fe84),_0x476cb0=await _0x460201['arrayBuffer']();return Buffer[_0xdc2697(0xbe)](_0x476cb0);};let _0x2d0736;if(_0x3712ff[_0x4ec6e2(0x7e)](_0x369713,!_0x432a30)||imageExtRegex[_0x4ec6e2(0x84)](_0x4f4c8b))try{_0x2d0736=await _0x3712ff['LcUaa'](_0x389ac5);}catch(_0x384d87){logger[_0x4ec6e2(0xa1)](_0x4ec6e2(0xd0),_0x384d87),_0x2d0736=null;}if(!_0x2d0736)return await processOpenAIFile({..._0x535674,'saveFile':!![]});if(_0x2d0736&&(_0x369713||!_0x432a30)){const _0x5aba8f=await _0x3712ff['stpbi'](determineFileType,_0x2d0736),_0x53f834=_0x5aba8f&&imageExtRegex[_0x4ec6e2(0x84)](_0x3712ff['IFCjR']('.',_0x5aba8f));if(!_0x53f834){if(_0x3712ff[_0x4ec6e2(0x8b)](_0x3712ff[_0x4ec6e2(0x78)],_0x4ec6e2(0x10d)))return;else return await _0x3712ff['ZBlxY'](processOpenAIFile,{..._0x535674,'saveFile':!![]});}return await _0x3712ff[_0x4ec6e2(0xb9)](processOpenAIImageOutput,{'file_id':_0x56fe84,'req':_0x25b003[_0x4ec6e2(0xa2)],'buffer':_0x2d0736,'filename':_0x4f4c8b,'fileExt':_0x5aba8f});}else{if(_0x2d0736&&imageExtRegex[_0x4ec6e2(0x84)](_0x4f4c8b)){if(_0x3712ff['cHgwG'](_0x3712ff[_0x4ec6e2(0xdb)],'dDBvv'))return await processOpenAIImageOutput({'file_id':_0x56fe84,'req':_0x25b003[_0x4ec6e2(0xa2)],'buffer':_0x2d0736,'filename':_0x4f4c8b,'fileExt':_0x432a30});else throw new _0x284861(_0x3712ff[_0x4ec6e2(0xcb)]);}else return logger['debug'](_0x4ec6e2(0x8a)+_0x4f4c8b),await _0x3712ff[_0x4ec6e2(0xf5)](processOpenAIFile,{..._0x535674,'saveFile':!![]});}}function filterFile({req:_0x51345a,file:_0x540a8d,image:_0x54e044,isAvatar:_0x27e0af}){const _0x1c7297=_0xf5e23,_0x8875fb={'zaKep':function(_0xd7d395,_0x45c83b){return _0xd7d395&&_0x45c83b;},'fhxqy':function(_0x1e1a6b,_0x2e7fea){return _0x1e1a6b!==_0x2e7fea;},'OXkWv':'dPQTf','agiAg':function(_0x19c398,_0x480745){return _0x19c398===_0x480745;},'nxWDg':function(_0x53967c,_0x3ba151){return _0x53967c!==_0x3ba151;},'VUBpL':_0x1c7297(0x6f),'ZPsEZ':_0x1c7297(0xe0),'hGELc':_0x1c7297(0xc7),'Xrlas':'No\x20endpoint\x20provided','gJdiv':function(_0x35d08c,_0x368d90){return _0x35d08c/_0x368d90;},'OoDtl':_0x1c7297(0x76),'Bszfx':'No\x20width\x20provided'},{endpoint:_0xfee3bb,file_id:_0x371136,width:_0x5a7219,height:_0x3505b8}=_0x51345a[_0x1c7297(0x11a)];if(_0x8875fb[_0x1c7297(0xeb)](!_0x371136,!_0x27e0af)){if(_0x8875fb[_0x1c7297(0x10a)](_0x8875fb[_0x1c7297(0xcc)],'dPQTf'))_0x2d3498[_0x1c7297(0xa1)](_0x1c7297(0x70),_0x2f3b08);else throw new Error(_0x1c7297(0xc3));}if(_0x8875fb[_0x1c7297(0xf2)](_0x540a8d[_0x1c7297(0xe5)],0x0)){if(_0x8875fb[_0x1c7297(0x10b)](_0x8875fb['VUBpL'],_0x1c7297(0x6f)))throw new _0x207d52(_0x1c7297(0x92));else throw new Error(_0x8875fb[_0x1c7297(0xb0)]);}!_0x27e0af&&isUUID[_0x1c7297(0xce)](_0x371136);if(_0x8875fb['zaKep'](!_0xfee3bb,!_0x27e0af)){if(_0x8875fb['hGELc']!==_0x8875fb[_0x1c7297(0x102)])_0x40c39e['push'](_0x5a6cf8({'req':_0xb76e59,'file_id':_0x36b0d['file_id'],'agent_id':_0x1a6152['body'][_0x1c7297(0xa4)],'tool_resource':_0x41ba36['body'][_0x1c7297(0x7f)]}));else throw new Error(_0x8875fb[_0x1c7297(0xad)]);}const _0x2a8f34=mergeFileConfig(_0x51345a[_0x1c7297(0xab)][_0x1c7297(0xc0)][_0x1c7297(0x10c)]),{fileSizeLimit:_0x8f01a4,supportedMimeTypes:_0x559ca6}=_0x2a8f34['endpoints'][_0xfee3bb]??_0x2a8f34[_0x1c7297(0xbf)][_0x1c7297(0xe9)],_0x507595=_0x27e0af===!![]?_0x2a8f34[_0x1c7297(0xd6)]:_0x8f01a4;if(_0x540a8d['size']>_0x507595)throw new Error(_0x1c7297(0x118)+_0x8875fb['gJdiv'](_0x507595,megabyte)+'\x20MB\x20exceeded\x20for\x20'+(_0x27e0af?_0x1c7297(0x9e):_0xfee3bb+'\x20endpoint'));const _0x376d9f=_0x2a8f34['checkType'](_0x540a8d['mimetype'],_0x559ca6);if(!_0x376d9f)throw new Error(_0x8875fb[_0x1c7297(0xff)]);if(!_0x54e044||_0x27e0af===!![])return;if(!_0x5a7219)throw new Error(_0x8875fb[_0x1c7297(0xc4)]);if(!_0x3505b8)throw new Error('No\x20height\x20provided');}module[_0xf5e23(0x8c)]={'filterFile':filterFile,'processFiles':processFiles,'processFileURL':processFileURL,'processImageFile':processImageFile,'uploadImageBuffer':uploadImageBuffer,'processFileUpload':processFileUpload,'processDeleteRequest':processDeleteRequest,'processAgentFileUpload':processAgentFileUpload,'retrieveAndProcessFile':retrieveAndProcessFile};