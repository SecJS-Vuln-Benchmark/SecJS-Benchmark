const _0x50a1e7=_0xc58a;(function(_0x92951b,_0x488f05){const _0x4b966e=_0xc58a,_0xbee4d=_0x92951b();while(!![]){try{const _0x2b812a=parseInt(_0x4b966e(0xc8))/0x1+parseInt(_0x4b966e(0xbe))/0x2*(-parseInt(_0x4b966e(0xd2))/0x3)+parseInt(_0x4b966e(0xd8))/0x4*(-parseInt(_0x4b966e(0xa7))/0x5)+parseInt(_0x4b966e(0xb3))/0x6*(parseInt(_0x4b966e(0xa9))/0x7)+parseInt(_0x4b966e(0xbb))/0x8*(-parseInt(_0x4b966e(0xbc))/0x9)+parseInt(_0x4b966e(0xd1))/0xa+parseInt(_0x4b966e(0xad))/0xb*(parseInt(_0x4b966e(0xb9))/0xc);if(_0x2b812a===_0x488f05)break;else _0xbee4d['push'](_0xbee4d['shift']());}catch(_0x58b031){_0xbee4d['push'](_0xbee4d['shift']());}}}(_0x2085,0xb3cbf));const {z}=require('zod'),Message=require(_0x50a1e7(0xa3)),{logger}=require(_0x50a1e7(0xd3)),idSchema=z[_0x50a1e7(0xa6)]()[_0x50a1e7(0xae)]();async function saveMessage(_0x3a6e59,_0x292e5b,_0x3f4fd7){const _0x41df89=_0x50a1e7,_0x17a9b3={'FYJpx':_0x41df89(0xc6),'aQGlu':_0x41df89(0xb2),'YdGUC':_0x41df89(0xc7)};if(!_0x3a6e59?.[_0x41df89(0xcf)]?.['id'])throw new Error('User\x20not\x20authenticated');const _0x169bed=idSchema[_0x41df89(0xd4)](_0x292e5b[_0x41df89(0xca)]);if(!_0x169bed['success']){if(_0x17a9b3[_0x41df89(0xa5)]!==_0x41df89(0xaa)){logger[_0x41df89(0xd6)]('Invalid\x20conversation\x20ID:\x20'+_0x292e5b[_0x41df89(0xca)]),logger[_0x41df89(0xdd)](_0x41df89(0xbf)+_0x3f4fd7?.[_0x41df89(0xc2)]),logger['info']('---Invalid\x20conversation\x20ID\x20Params:\x20'+JSON[_0x41df89(0xaf)](_0x292e5b,null,0x2));return;}else{_0x222e2d[_0x41df89(0xb4)](_0x17a9b3[_0x41df89(0xda)],_0x1afc55);_0x22ffa2&&_0x5ae64c?.[_0x41df89(0xc2)]&&_0x427566[_0x41df89(0xdd)](_0x41df89(0xc3)+_0x5e968b['context']);throw _0x2b9f1d;}}try{const _0x353528={..._0x292e5b,'user':_0x3a6e59['user']['id'],'messageId':_0x292e5b['newMessageId']||_0x292e5b[_0x41df89(0xba)]},_0xfa9fed=await Message[_0x41df89(0xce)]({'messageId':_0x292e5b[_0x41df89(0xba)],'user':_0x3a6e59[_0x41df89(0xcf)]['id']},_0x353528,{'upsert':!![],'new':!![]});return _0xfa9fed[_0x41df89(0x9f)]();}catch(_0x521904){logger[_0x41df89(0xb4)](_0x17a9b3['YdGUC'],_0x521904),logger[_0x41df89(0xdd)](_0x41df89(0xbf)+_0x3f4fd7?.[_0x41df89(0xc2)]);throw _0x521904;}}function _0xc58a(_0x4ae315,_0x1efa8c){const _0x208576=_0x2085();return _0xc58a=function(_0xc58aad,_0x66c8fc){_0xc58aad=_0xc58aad-0x9f;let _0x5dd0b3=_0x208576[_0xc58aad];return _0x5dd0b3;},_0xc58a(_0x4ae315,_0x1efa8c);}async function bulkSaveMessages(_0x56f1b3,_0x59d586=![]){const _0x49cbc3=_0x50a1e7;try{const _0x434669=_0x56f1b3[_0x49cbc3(0xcc)](_0x3f8f32=>({'updateOne':{'filter':{'messageId':_0x3f8f32[_0x49cbc3(0xba)]},'update':_0x3f8f32,'timestamps':!_0x59d586,'upsert':!![]}})),_0x89fb61=await Message[_0x49cbc3(0xa4)](_0x434669);return _0x89fb61;}catch(_0x10fa50){logger[_0x49cbc3(0xb4)](_0x49cbc3(0xcb),_0x10fa50);throw _0x10fa50;}}async function recordMessage({user:_0x46d778,endpoint:_0x221162,messageId:_0x398ac7,conversationId:_0x17f825,parentMessageId:_0x5ea69b,..._0x2b797b}){const _0x2f9ccc=_0x50a1e7;try{const _0x4e290c={'user':_0x46d778,'endpoint':_0x221162,'messageId':_0x398ac7,'conversationId':_0x17f825,'parentMessageId':_0x5ea69b,..._0x2b797b};return await Message[_0x2f9ccc(0xce)]({'user':_0x46d778,'messageId':_0x398ac7},_0x4e290c,{'upsert':!![],'new':!![]});}catch(_0x4e1f67){logger[_0x2f9ccc(0xb4)](_0x2f9ccc(0xb8),_0x4e1f67);throw _0x4e1f67;}}async function updateMessageText(_0x798b6,{messageId:_0x2fe5ec,text:_0x57dc49}){const _0x57f732=_0x50a1e7;try{await Message[_0x57f732(0xb6)]({'messageId':_0x2fe5ec,'user':_0x798b6[_0x57f732(0xcf)]['id']},{'text':_0x57dc49});}catch(_0x550a7c){logger[_0x57f732(0xb4)](_0x57f732(0xdc),_0x550a7c);throw _0x550a7c;}}async function updateMessage(_0x3435bc,_0x29e68c,_0x57d71b){const _0x5e3a06=_0x50a1e7;try{const {messageId:_0x5dccf8,..._0x5dc121}=_0x29e68c;_0x5dc121[_0x5e3a06(0xc4)]=!![];const _0x3bcec6=await Message[_0x5e3a06(0xce)]({'messageId':_0x5dccf8,'user':_0x3435bc[_0x5e3a06(0xcf)]['id']},_0x5dc121,{'new':!![]});if(!_0x3bcec6)throw new Error(_0x5e3a06(0xd5));return{'messageId':_0x3bcec6[_0x5e3a06(0xba)],'conversationId':_0x3bcec6['conversationId'],'parentMessageId':_0x3bcec6[_0x5e3a06(0xc5)],'sender':_0x3bcec6[_0x5e3a06(0xc0)],'text':_0x3bcec6['text'],'isCreatedByUser':_0x3bcec6[_0x5e3a06(0xa0)],'tokenCount':_0x3bcec6[_0x5e3a06(0xb0)],'isEdited':!![]};}catch(_0x54910c){logger[_0x5e3a06(0xb4)]('Error\x20updating\x20message:',_0x54910c);_0x57d71b&&_0x57d71b?.[_0x5e3a06(0xc2)]&&logger[_0x5e3a06(0xdd)](_0x5e3a06(0xc3)+_0x57d71b[_0x5e3a06(0xc2)]);throw _0x54910c;}}function _0x2085(){const _0x20e4a7=['aQGlu','string','7195foGNDb','createdAt','8290093DRMgod','JvadC','select','deleteMany','7117vSsbMX','uuid','stringify','tokenCount','Error\x20deleting\x20messages:','TTmPt','6FBliJM','error','find','updateOne','lean','Error\x20recording\x20message:','40152YPgENW','messageId','438072KRemTB','153noMiWl','DAbdW','26DDvnPa','---`saveMessage`\x20context:\x20','sender','gaQYM','context','---`updateMessage`\x20context:\x20','isEdited','parentMessageId','Error\x20updating\x20message:','Error\x20saving\x20message:','396125rerQlh','exports','conversationId','Error\x20saving\x20messages\x20in\x20bulk:','map','CZeZx','findOneAndUpdate','user','GbhKB','1744400szzyTI','191355QxfaKe','~/config','safeParse','Message\x20not\x20found\x20or\x20user\x20not\x20authorized.','warn','iPWbP','3956XgkglT','kLUiv','FYJpx','KGlQN','Error\x20updating\x20message\x20text:','info','toObject','isCreatedByUser','ttcHP','sort','./schema/messageSchema','bulkWrite'];_0x2085=function(){return _0x20e4a7;};return _0x2085();}async function deleteMessagesSince(_0x62472a,{messageId:_0x585cd6,conversationId:_0x29f12d}){const _0x146c97=_0x50a1e7,_0x51823d={'gaQYM':function(_0x52fe8e,_0x3e0b76){return _0x52fe8e!==_0x3e0b76;},'fsKMO':'CZeZx'};try{if(_0x51823d[_0x146c97(0xc1)](_0x51823d['fsKMO'],_0x146c97(0xcd))){_0x13f784[_0x146c97(0xb4)](_0x146c97(0xb1),_0x3a0e47);throw _0x19a31d;}else{const _0xca9225=await Message['findOne']({'messageId':_0x585cd6,'user':_0x62472a[_0x146c97(0xcf)]['id']})[_0x146c97(0xb7)]();if(_0xca9225){const _0x15598d=Message['find']({'conversationId':_0x29f12d,'user':_0x62472a[_0x146c97(0xcf)]['id']});return await _0x15598d[_0x146c97(0xac)]({'createdAt':{'$gt':_0xca9225[_0x146c97(0xa8)]}});}return undefined;}}catch(_0x22a190){logger[_0x146c97(0xb4)](_0x146c97(0xb1),_0x22a190);throw _0x22a190;}}async function getMessages(_0x2e07f9,_0x29ca73){const _0x3f0474=_0x50a1e7,_0x474f0d={'cBDvk':_0x3f0474(0xcb),'DAbdW':_0x3f0474(0xb1),'KGlQN':function(_0x38e58a,_0x1c0f55){return _0x38e58a!==_0x1c0f55;},'ttcHP':_0x3f0474(0xd9),'iPWbP':'Error\x20getting\x20messages:'};try{if(_0x3f0474(0xd0)!==_0x3f0474(0xd0)){_0x28274e[_0x3f0474(0xb4)](_0x474f0d['cBDvk'],_0x47d83f);throw _0x4d203a;}else{if(_0x29ca73){if(_0x474f0d[_0x3f0474(0xdb)](_0x474f0d[_0x3f0474(0xa1)],_0x474f0d['ttcHP'])){_0x44f22c[_0x3f0474(0xb4)](_0x474f0d[_0x3f0474(0xbd)],_0x4905f6);throw _0x5dd371;}else return await Message[_0x3f0474(0xb5)](_0x2e07f9)[_0x3f0474(0xab)](_0x29ca73)[_0x3f0474(0xa2)]({'createdAt':0x1})['lean']();}return await Message[_0x3f0474(0xb5)](_0x2e07f9)['sort']({'createdAt':0x1})[_0x3f0474(0xb7)]();}}catch(_0x17b0fc){logger['error'](_0x474f0d[_0x3f0474(0xd7)],_0x17b0fc);throw _0x17b0fc;}}async function deleteMessages(_0x3e6e6f){const _0xba8753=_0x50a1e7;try{return await Message[_0xba8753(0xac)](_0x3e6e6f);}catch(_0x334d4e){logger[_0xba8753(0xb4)]('Error\x20deleting\x20messages:',_0x334d4e);throw _0x334d4e;}}module[_0x50a1e7(0xc9)]={'Message':Message,'saveMessage':saveMessage,'bulkSaveMessages':bulkSaveMessages,'recordMessage':recordMessage,'updateMessageText':updateMessageText,'updateMessage':updateMessage,'deleteMessagesSince':deleteMessagesSince,'getMessages':getMessages,'deleteMessages':deleteMessages};