function _0x332c(_0x4ac380,_0x1cca9c){const _0x6c2d3d=_0x6c2d();return _0x332c=function(_0x332c52,_0x259176){_0x332c52=_0x332c52-0x145;let _0x312413=_0x6c2d3d[_0x332c52];return _0x312413;},_0x332c(_0x4ac380,_0x1cca9c);}const _0x55419c=_0x332c;function _0x6c2d(){const _0x25a61a=['uMQKr','imageDetail','embedded','setOptions','~/app/clients/BaseClient','CURRENT_MODEL','gpt-4o','modelLabel','assign','SldVF','20irHcdP','abortController','messageId','contextStrategy','has','addImageURLs','vfWjB','resendFiles','exports','titleConvo','attachments','instructions','function','[api/server/controllers/agents/client.js\x20#chatCompletion]\x20Tool\x20Error','usage','info','FPniN','IBeAp','model','promptTokens','image_urls','completionsUrl','NfeKb','azureOpenAI','~/config','error','4695746Ntvwhr','provider','inputTokens','signal','TOOL_ERROR','[api/server/controllers/agents/client.js\x20#titleConvo]\x20Error\x20recording\x20collected\x20usage','discard','run','WPkRi','8eLxLcT','MYDHn','140pPBJXG','files','KTgzE','getContentParts','[api/server/controllers/agents/client.js\x20#checkVisionRequest]\x20not\x20implemented','warn','endpoint','buildMessages','eventHandlers','getSaveOptions','additional_instructions','jOQrs','105192tEEdnJ','qYZjO','conversationId','endpointTokenConfig','~/server/services/Files/images/encode','output_tokens','spec','getEncoding','modelOptions','user','SYiXd','@librechat/agents','getReqData','locals','~/models/spendTokens','message_file_map','ElMVC','sendCompletion','getTokenCount','recordCollectedUsage','cl100k_base','377022jnaVDx','52233fpbqhx','checkVisionRequest','jWsYj','contentParts','handleContextStrategy','getTokenCountForMessage','responseMessageId','req','[api/server/controllers/agents/client.js]\x20chatCompletion','app','nUqkJ','groq','971372nLOASs','qnEYP','debug','text','./run','[api/server/controllers/agents/client.js\x20#chatCompletion]\x20Error\x20recording\x20collected\x20usage','isVisionModel','input_tokens','completionTokens','qKlZm','constructor','collectedUsage','[api/server/controllers/agents/client.js\x20#titleConvo]\x20Error','tokenUsage','7310916LIgMVq','~/utils','tools','catch','titleModel','processStream','tokenCount','contextHandlers','~/app/clients/prompts','shouldSummarize','openAI','message','CSvLb','isChatCompletion','generateTitle','kQvOe','QgzgK','agent','outputTokens','map','name','values','augmentedPrompt','title','length','options','anthropic','RDQDa','RylIG','4674350sOaSai','artifactPromises','getBuildMessagesOptions','agents','chatCompletion','aborted','70TtYjhO'];_0x6c2d=function(){return _0x25a61a;};return _0x6c2d();}(function(_0x1850b4,_0x2c19c9){const _0x1ab1e9=_0x332c,_0x49b8ad=_0x1850b4();while(!![]){try{const _0x31ec20=parseInt(_0x1ab1e9(0x196))/0x1+-parseInt(_0x1ab1e9(0x15a))/0x2*(-parseInt(_0x1ab1e9(0x1ac))/0x3)+parseInt(_0x1ab1e9(0x1b8))/0x4+parseInt(_0x1ab1e9(0x154))/0x5+parseInt(_0x1ab1e9(0x1ab))/0x6*(-parseInt(_0x1ab1e9(0x18a))/0x7)+parseInt(_0x1ab1e9(0x188))/0x8*(-parseInt(_0x1ab1e9(0x1c6))/0x9)+-parseInt(_0x1ab1e9(0x165))/0xa*(-parseInt(_0x1ab1e9(0x17f))/0xb);if(_0x31ec20===_0x2c19c9)break;else _0x49b8ad['push'](_0x49b8ad['shift']());}catch(_0x1a398b){_0x49b8ad['push'](_0x49b8ad['shift']());}}}(_0x6c2d,0xa5486));const {Callback,createMetadataAggregator}=require(_0x55419c(0x1a1)),{Constants,VisionModes,openAISchema,EModelEndpoint,KnownEndpoints,anthropicSchema,bedrockOutputParser,removeNullishValues}=require('librechat-data-provider'),{extractBaseURL}=require(_0x55419c(0x1c7)),{formatMessage,formatAgentMessages,formatContentStrings,createContextHandlers}=require(_0x55419c(0x1ce)),{encodeAndFormat}=require(_0x55419c(0x19a)),Tokenizer=require('~/server/services/Tokenizer'),{spendTokens}=require(_0x55419c(0x1a4)),BaseClient=require(_0x55419c(0x15f)),{createRun}=require(_0x55419c(0x1bc)),{logger}=require(_0x55419c(0x17d)),providerParsers={[EModelEndpoint[_0x55419c(0x1d0)]]:openAISchema,[EModelEndpoint[_0x55419c(0x17c)]]:openAISchema,[EModelEndpoint[_0x55419c(0x151)]]:anthropicSchema,[EModelEndpoint['bedrock']]:bedrockOutputParser},legacyContentEndpoints=new Set([KnownEndpoints[_0x55419c(0x1b7)],KnownEndpoints['deepseek']]);class AgentClient extends BaseClient{constructor(_0x1cd664={}){const _0x39edf0=_0x55419c;super(null,_0x1cd664),this[_0x39edf0(0x168)]=_0x39edf0(0x185),this[_0x39edf0(0x1d3)]=!![],this[_0x39edf0(0x186)];const {contentParts:_0x56f45a,collectedUsage:_0x3d0f5a,artifactPromises:_0x553e0c,maxContextTokens:_0x83a495,modelOptions:modelOptions={},..._0x28e7f8}=_0x1cd664;this['modelOptions']=modelOptions,this['maxContextTokens']=_0x83a495,this[_0x39edf0(0x1af)]=_0x56f45a,this['collectedUsage']=_0x3d0f5a,this[_0x39edf0(0x155)]=_0x553e0c,this[_0x39edf0(0x150)]=Object[_0x39edf0(0x163)]({'endpoint':_0x1cd664['endpoint']},_0x28e7f8);}[_0x55419c(0x18d)](){const _0x4a73d5=_0x55419c;return this[_0x4a73d5(0x1af)];}[_0x55419c(0x15e)](_0x466111){const _0x587235=_0x55419c,_0x3ada6b={'KTgzE':'[api/server/controllers/agents/client.js]\x20setOptions'};logger[_0x587235(0x174)](_0x3ada6b[_0x587235(0x18c)],_0x466111);}[_0x55419c(0x1ad)](_0xee088){const _0x4d7718=_0x55419c,_0x3ab0eb={'jWsYj':_0x4d7718(0x18e)};logger['info'](_0x3ab0eb[_0x4d7718(0x1ae)],_0xee088);}[_0x55419c(0x193)](){const _0x32d24f=_0x55419c,_0x188a02={'IBeAp':function(_0x1353f0,_0x47cd15){return _0x1353f0===_0x47cd15;},'tcmMh':function(_0x9a097a,_0x21ecbf){return _0x9a097a(_0x21ecbf);}},_0x1c3be2=providerParsers[this[_0x32d24f(0x150)][_0x32d24f(0x190)]];let _0x50adc5=_0x188a02[_0x32d24f(0x176)](this[_0x32d24f(0x150)][_0x32d24f(0x190)],EModelEndpoint[_0x32d24f(0x157)])?{'model':undefined}:{};return _0x1c3be2&&(_0x50adc5=_0x1c3be2(this[_0x32d24f(0x19e)])),_0x188a02['tcmMh'](removeNullishValues,Object[_0x32d24f(0x163)]({'endpoint':this['options'][_0x32d24f(0x190)],'agent_id':this[_0x32d24f(0x150)]['agent']['id'],'modelLabel':this['options'][_0x32d24f(0x162)],'maxContextTokens':this[_0x32d24f(0x150)]['maxContextTokens'],'resendFiles':this[_0x32d24f(0x150)][_0x32d24f(0x16c)],'imageDetail':this[_0x32d24f(0x150)][_0x32d24f(0x15c)],'spec':this['options'][_0x32d24f(0x19c)]},_0x50adc5));}[_0x55419c(0x156)](){const _0x5f3f7f=_0x55419c;return{'instructions':this[_0x5f3f7f(0x150)][_0x5f3f7f(0x148)]['instructions'],'additional_instructions':this[_0x5f3f7f(0x150)][_0x5f3f7f(0x148)][_0x5f3f7f(0x194)]};}async[_0x55419c(0x16a)](_0x575f44,_0x3fc757){const _0x4d75db=_0x55419c,_0x5de5bb={'MYDHn':function(_0x4a23e1,_0x40fa4f,_0x3721b3,_0x17ce81,_0xe77f60){return _0x4a23e1(_0x40fa4f,_0x3721b3,_0x17ce81,_0xe77f60);}},{files:_0x23a010,image_urls:_0x3eeae2}=await _0x5de5bb[_0x4d75db(0x189)](encodeAndFormat,this[_0x4d75db(0x150)]['req'],_0x3fc757,this[_0x4d75db(0x150)]['agent'][_0x4d75db(0x180)],VisionModes[_0x4d75db(0x157)]);return _0x575f44[_0x4d75db(0x179)]=_0x3eeae2[_0x4d75db(0x14f)]?_0x3eeae2:undefined,_0x23a010;}async[_0x55419c(0x191)](_0x287800,_0x441462,{instructions:instructions=null,additional_instructions:additional_instructions=null},_0x583349){const _0x6ed40d=_0x55419c,_0x5288d2={'RDQDa':function(_0x47180d,_0x417c17){return _0x47180d??_0x417c17;},'FPniN':function(_0x2ff549,_0x18cde5){return _0x2ff549??_0x18cde5;},'WPkRi':function(_0x240096,_0x4370e3){return _0x240096===_0x4370e3;},'hrWaI':_0x6ed40d(0x17b),'SYiXd':_0x6ed40d(0x1c1),'nUqkJ':function(_0xcee912,_0x2fa37c){return _0xcee912-_0x2fa37c;},'vfWjB':function(_0x1f0507,_0x55e683,_0x308a2b){return _0x1f0507(_0x55e683,_0x308a2b);},'yWGAO':function(_0x39ba5a,_0x569285){return _0x39ba5a+_0x569285;}};let _0x3c1d68=this[_0x6ed40d(0x1c2)]['getMessagesForConversation']({'messages':_0x287800,'parentMessageId':_0x441462,'summary':this[_0x6ed40d(0x1cf)]}),_0x3d68e2,_0x4ed5a4,_0x1d76b9=''+_0x5288d2[_0x6ed40d(0x152)](instructions,'')+_0x5288d2[_0x6ed40d(0x175)](additional_instructions,'');if(this[_0x6ed40d(0x150)]['attachments']){const _0x5d2d56=await this['options'][_0x6ed40d(0x16f)];this[_0x6ed40d(0x1a5)]?_0x5288d2[_0x6ed40d(0x187)](_0x5288d2['hrWaI'],_0x5288d2[_0x6ed40d(0x1a0)])?(_0x57c36d=_0x206737[_0x6ed40d(0x1c5)]['promptTokens'],_0x44c398=_0x436173['tokenUsage']['completionTokens']):this[_0x6ed40d(0x1a5)][_0x3c1d68[_0x3c1d68[_0x6ed40d(0x14f)]-0x1][_0x6ed40d(0x167)]]=_0x5d2d56:this[_0x6ed40d(0x1a5)]={[_0x3c1d68[_0x3c1d68['length']-0x1]['messageId']]:_0x5d2d56};const _0x475dd9=await this[_0x6ed40d(0x16a)](_0x3c1d68[_0x5288d2[_0x6ed40d(0x1b6)](_0x3c1d68[_0x6ed40d(0x14f)],0x1)],_0x5d2d56);this['options'][_0x6ed40d(0x16f)]=_0x475dd9;}this[_0x6ed40d(0x1a5)]&&(this[_0x6ed40d(0x1cd)]=_0x5288d2[_0x6ed40d(0x16b)](createContextHandlers,this[_0x6ed40d(0x150)][_0x6ed40d(0x1b3)],_0x3c1d68[_0x3c1d68['length']-0x1][_0x6ed40d(0x1bb)]));const _0x9f319a=_0x3c1d68[_0x6ed40d(0x14a)]((_0x4cb6ff,_0x3f5663)=>{const _0x1aac55=_0x6ed40d,_0x51e45e=formatMessage({'message':_0x4cb6ff,'userName':this[_0x1aac55(0x150)]?.[_0x1aac55(0x14b)],'assistantName':this[_0x1aac55(0x150)]?.[_0x1aac55(0x162)]}),_0x6d9051=this[_0x1aac55(0x168)]&&!_0x3c1d68[_0x3f5663][_0x1aac55(0x1cc)];(_0x6d9051||this[_0x1aac55(0x1be)]&&(_0x4cb6ff[_0x1aac55(0x179)]||_0x4cb6ff[_0x1aac55(0x18b)]))&&(_0x3c1d68[_0x3f5663][_0x1aac55(0x1cc)]=this[_0x1aac55(0x1b1)](_0x51e45e));if(this[_0x1aac55(0x1a5)]&&this[_0x1aac55(0x1a5)][_0x4cb6ff[_0x1aac55(0x167)]]){const _0x2894f5=this[_0x1aac55(0x1a5)][_0x4cb6ff['messageId']];for(const _0x1b476a of _0x2894f5){if(_0x1b476a[_0x1aac55(0x15d)]){this[_0x1aac55(0x1cd)]?.['processFile'](_0x1b476a);continue;}}}return _0x51e45e;});this[_0x6ed40d(0x1cd)]&&(this[_0x6ed40d(0x14d)]=await this[_0x6ed40d(0x1cd)]['createContext'](),_0x1d76b9=_0x5288d2['yWGAO'](this['augmentedPrompt'],_0x1d76b9));_0x1d76b9&&(this[_0x6ed40d(0x150)][_0x6ed40d(0x148)][_0x6ed40d(0x170)]=_0x1d76b9);this[_0x6ed40d(0x168)]&&({payload:_0x3d68e2,promptTokens:_0x4ed5a4,messages:_0x287800}=await this[_0x6ed40d(0x1b0)]({'orderedMessages':_0x3c1d68,'formattedMessages':_0x9f319a,'buildTokenMap':![]}));const _0x551860={'prompt':_0x3d68e2,'promptTokens':_0x4ed5a4,'messages':_0x287800};return _0x4ed5a4>=0x0&&_0x5288d2['WPkRi'](typeof _0x583349?.[_0x6ed40d(0x1a2)],_0x6ed40d(0x171))&&_0x583349['getReqData']({'promptTokens':_0x4ed5a4}),_0x551860;}async[_0x55419c(0x1a7)](_0x15647d,_0x328330={}){const _0x2a1e72=_0x55419c;return this['modelOptions']['user']=this[_0x2a1e72(0x19f)],await this[_0x2a1e72(0x158)]({'payload':_0x15647d,'onProgress':_0x328330['onProgress'],'abortController':_0x328330[_0x2a1e72(0x166)]}),this['contentParts'];}async[_0x55419c(0x1a9)]({model:_0x220655,context:context=_0x55419c(0x1d1),collectedUsage:collectedUsage=this[_0x55419c(0x1c3)]}){const _0x1983e2=_0x55419c;for(const _0x4860ab of collectedUsage){await spendTokens({'context':context,'model':_0x220655??this[_0x1983e2(0x19e)][_0x1983e2(0x177)],'conversationId':this[_0x1983e2(0x198)],'user':this['user']??this[_0x1983e2(0x150)][_0x1983e2(0x1b3)]['user']?.['id'],'endpointTokenConfig':this[_0x1983e2(0x150)][_0x1983e2(0x199)]},{'promptTokens':_0x4860ab[_0x1983e2(0x1bf)],'completionTokens':_0x4860ab[_0x1983e2(0x19b)]});}}async[_0x55419c(0x158)]({payload:_0xad4753,abortController:abortController=null}){const _0x43764e=_0x55419c,_0x5538f4={'kQvOe':function(_0x148ba0,_0x8e4e2e){return _0x148ba0!==_0x8e4e2e;},'GWGtM':_0x43764e(0x1bd),'qYZjO':function(_0x543c5f,_0x37b4c2){return _0x543c5f(_0x37b4c2);},'ifada':function(_0x23c56a,_0x24975f){return _0x23c56a(_0x24975f);},'NAfgG':_0x43764e(0x1d1),'jOQrs':'[api/server/controllers/agents/client.js\x20#sendCompletion]\x20Unhandled\x20error\x20type'};try{!abortController&&(abortController=new AbortController());const _0x6174e6=extractBaseURL(this[_0x43764e(0x17a)]);logger[_0x43764e(0x1ba)](_0x43764e(0x1b4),{'baseURL':_0x6174e6,'payload':_0xad4753});const _0x2f85d9=await _0x5538f4[_0x43764e(0x197)](createRun,{'req':this['options'][_0x43764e(0x1b3)],'agent':this[_0x43764e(0x150)]['agent'],'tools':this[_0x43764e(0x150)][_0x43764e(0x1c8)],'runId':this[_0x43764e(0x1b2)],'modelOptions':this[_0x43764e(0x19e)],'customHandlers':this[_0x43764e(0x150)][_0x43764e(0x192)]}),_0x64ccb={'configurable':{'thread_id':this[_0x43764e(0x198)]},'signal':abortController[_0x43764e(0x182)],'streamMode':_0x43764e(0x14c),'version':'v2'};if(!_0x2f85d9)throw new Error('Failed\x20to\x20create\x20run');this[_0x43764e(0x186)]=_0x2f85d9;const _0x48319b=_0x5538f4['ifada'](formatAgentMessages,_0xad4753);legacyContentEndpoints[_0x43764e(0x169)](this[_0x43764e(0x150)]['agent'][_0x43764e(0x190)])&&formatContentStrings(_0x48319b),await _0x2f85d9[_0x43764e(0x1cb)]({'messages':_0x48319b},_0x64ccb,{[Callback[_0x43764e(0x183)]]:(_0x201daa,_0x28fa19,_0x14f7a6)=>{const _0x4dac30=_0x43764e;_0x5538f4[_0x4dac30(0x146)](_0x4dac30(0x147),_0x4dac30(0x147))?_0x454f1e=new _0x567d0f():logger[_0x4dac30(0x17e)](_0x4dac30(0x172),_0x28fa19,_0x14f7a6);}}),this[_0x43764e(0x1a9)]({'context':_0x5538f4['NAfgG']})['catch'](_0x1a3347=>{logger['error'](_0x5538f4['GWGtM'],_0x1a3347);});}catch(_0x3d4d97){if(!abortController['signal'][_0x43764e(0x159)]){logger['error'](_0x5538f4[_0x43764e(0x195)],_0x3d4d97);throw _0x3d4d97;}logger[_0x43764e(0x18f)]('[api/server/controllers/agents/client.js\x20#sendCompletion]\x20Operation\x20aborted',_0x3d4d97);}}async[_0x55419c(0x16e)]({text:_0x1c31d5}){const _0x224a3f=_0x55419c,_0x2e0bc2={'uMQKr':'[api/server/controllers/agents/client.js\x20#titleConvo]\x20Error\x20recording\x20collected\x20usage','ANDhw':function(_0xb2a9cb,_0x246478){return _0xb2a9cb!==_0x246478;},'SldVF':function(_0x384e31,_0x287a38){return _0x384e31===_0x287a38;},'CBfut':_0x224a3f(0x1a6),'CSvLb':function(_0x4c9a90,_0x23dbd0){return _0x4c9a90!==_0x23dbd0;},'RylIG':_0x224a3f(0x14e)};if(!this[_0x224a3f(0x186)])throw new Error('Run\x20not\x20initialized');const {handleLLMEnd:_0x1b041c,collected:_0x5e7cf9}=createMetadataAggregator(),_0x321679={},_0x4ec6a3=this[_0x224a3f(0x150)]['req'][_0x224a3f(0x1b5)][_0x224a3f(0x1a3)][this[_0x224a3f(0x150)][_0x224a3f(0x148)]['provider']];_0x4ec6a3&&_0x4ec6a3[_0x224a3f(0x1ca)]&&_0x2e0bc2['ANDhw'](_0x4ec6a3[_0x224a3f(0x1ca)],Constants[_0x224a3f(0x160)])&&(_0x2e0bc2[_0x224a3f(0x164)](_0x2e0bc2['CBfut'],_0x224a3f(0x1a6))?_0x321679[_0x224a3f(0x177)]=_0x4ec6a3[_0x224a3f(0x1ca)]:_0x5dccbf['error'](_0x224a3f(0x184),_0x183c4d));try{if(_0x2e0bc2[_0x224a3f(0x1d2)](_0x224a3f(0x1b9),'qnEYP'))_0x1d0fa7['model']=_0x35c551[_0x224a3f(0x1ca)];else{const _0x2acbef=await this[_0x224a3f(0x186)][_0x224a3f(0x145)]({'inputText':_0x1c31d5,'contentParts':this[_0x224a3f(0x1af)],'clientOptions':_0x321679,'chainOptions':{'callbacks':[{'handleLLMEnd':_0x1b041c}]}}),_0x18b70b=_0x5e7cf9[_0x224a3f(0x14a)](_0x298e63=>{const _0x42c124=_0x224a3f;let _0x119020,_0x59312e;if(_0x298e63[_0x42c124(0x173)])_0x119020=_0x298e63['usage'][_0x42c124(0x1bf)]||_0x298e63[_0x42c124(0x173)][_0x42c124(0x181)],_0x59312e=_0x298e63[_0x42c124(0x173)]['output_tokens']||_0x298e63[_0x42c124(0x173)][_0x42c124(0x149)];else _0x298e63[_0x42c124(0x1c5)]&&(_0x119020=_0x298e63['tokenUsage'][_0x42c124(0x178)],_0x59312e=_0x298e63[_0x42c124(0x1c5)][_0x42c124(0x1c0)]);return{'input_tokens':_0x119020,'output_tokens':_0x59312e};});return this[_0x224a3f(0x1a9)]({'model':_0x321679[_0x224a3f(0x177)],'context':_0x2e0bc2[_0x224a3f(0x153)],'collectedUsage':_0x18b70b})[_0x224a3f(0x1c9)](_0xa06881=>{const _0x11edc1=_0x224a3f;logger['error'](_0x2e0bc2[_0x11edc1(0x15b)],_0xa06881);}),_0x2acbef[_0x224a3f(0x14e)];}}catch(_0x202c26){logger[_0x224a3f(0x17e)](_0x224a3f(0x1c4),_0x202c26);return;}}[_0x55419c(0x19d)](){const _0x5e2d53=_0x55419c,_0x501b9d={'xXYuI':_0x5e2d53(0x161),'CdGfd':_0x5e2d53(0x1aa)};return this[_0x5e2d53(0x19e)]['model']?.['includes'](_0x501b9d['xXYuI'])?'o200k_base':_0x501b9d['CdGfd'];}[_0x55419c(0x1a8)](_0x5922de){const _0x1a9c61=_0x55419c,_0x3c7d64=this['getEncoding']();return Tokenizer[_0x1a9c61(0x1a8)](_0x5922de,_0x3c7d64);}}module[_0x55419c(0x16d)]=AgentClient;