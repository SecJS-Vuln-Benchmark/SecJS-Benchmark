const _0x3100a7=_0x3b93;(function(_0x1f260d,_0x1a6788){const _0x5ea137=_0x3b93,_0xec6092=_0x1f260d();while(!![]){try{const _0xf8930c=-parseInt(_0x5ea137(0x177))/0x1+parseInt(_0x5ea137(0x173))/0x2*(parseInt(_0x5ea137(0x16f))/0x3)+parseInt(_0x5ea137(0x1a2))/0x4+-parseInt(_0x5ea137(0x19d))/0x5*(parseInt(_0x5ea137(0x194))/0x6)+parseInt(_0x5ea137(0x1a6))/0x7+parseInt(_0x5ea137(0x17d))/0x8*(-parseInt(_0x5ea137(0x19f))/0x9)+-parseInt(_0x5ea137(0x197))/0xa*(-parseInt(_0x5ea137(0x17f))/0xb);if(_0xf8930c===_0x1a6788)break;else _0xec6092['push'](_0xec6092['shift']());}catch(_0x126dab){_0xec6092['push'](_0xec6092['shift']());}}}(_0x6aba,0x9c3a3));const Conversation=require('./schema/convoSchema'),{getMessages,deleteMessages}=require(_0x3100a7(0x1a7)),logger=require(_0x3100a7(0x169)),searchConversation=async _0x1301a3=>{const _0x5d7bbf=_0x3100a7,_0x50b2af={'VaTLF':function(_0x184b7c,_0x48ba82){return _0x184b7c!==_0x48ba82;},'tSbLG':'conversationId\x20user'};try{if(_0x50b2af[_0x5d7bbf(0x16a)](_0x5d7bbf(0x163),_0x5d7bbf(0x163)))_0x2af671[_0x5d7bbf(0x186)]=[{'isArchived':![]},{'isArchived':{'$exists':![]}}];else return await Conversation[_0x5d7bbf(0x1af)]({'conversationId':_0x1301a3},_0x50b2af['tSbLG'])[_0x5d7bbf(0x166)]();}catch(_0x4a73f7){logger['error'](_0x5d7bbf(0x198),_0x4a73f7);throw new Error('Error\x20searching\x20conversation');}},getConvo=async(_0x512c0a,_0x37aec0)=>{const _0x4be107=_0x3100a7,_0x344e5e={'pRDsY':_0x4be107(0x16c),'dfMmm':_0x4be107(0x192)};try{return await Conversation[_0x4be107(0x1af)]({'user':_0x512c0a,'conversationId':_0x37aec0})['lean']();}catch(_0x1c246c){return logger[_0x4be107(0x175)](_0x344e5e['pRDsY'],_0x1c246c),{'message':_0x344e5e[_0x4be107(0x19b)]};}},deleteNullOrEmptyConversations=async()=>{const _0x126297=_0x3100a7,_0x1e0216={'WlUcP':_0x126297(0x165)};try{const _0x43a64c={'$or':[{'conversationId':null},{'conversationId':''},{'conversationId':{'$exists':![]}}]},_0x2ddff8=await Conversation[_0x126297(0x164)](_0x43a64c),_0x1ce8c4=await deleteMessages(_0x43a64c);return logger[_0x126297(0x179)](_0x126297(0x195)+_0x2ddff8[_0x126297(0x17e)]+_0x126297(0x174)+_0x1ce8c4[_0x126297(0x17e)]+'\x20messages'),{'conversations':_0x2ddff8,'messages':_0x1ce8c4};}catch(_0x38b335){logger[_0x126297(0x175)](_0x1e0216[_0x126297(0x1aa)],_0x38b335);throw new Error(_0x126297(0x1a8));}};function _0x6aba(){const _0x38d724=['lpTUK','aJDJk','[getConvoTitle]\x20Error\x20getting\x20conversation\x20title','fracv','ylBoQ','JywMX','floor','vfLnp','Error\x20getting\x20conversation\x20title','pages','title','Error\x20getting\x20single\x20conversation','skip','4212IgKacx','[deleteNullOrEmptyConversations]\x20Deleted\x20','debug','20XyDWnI','[searchConversation]\x20Error\x20searching\x20conversation','filter','wzfjy','dfMmm','AcglL','7855eLfqyF','_id','9jazOdE','find','wvQDk','3304624EsbgsL','FYEvo','Failed\x20to\x20save\x20conversations\x20in\x20bulk.','push','1395114jUxAnB','./Message','Error\x20deleting\x20conversations\x20with\x20null\x20or\x20empty\x20conversationId','forEach','WlUcP','user','limit','isArray','[saveConvo]\x20Error\x20saving\x20conversation','findOne','oBPbg','mTIJi','IOQNI','deleteMany','[deleteNullOrEmptyConversations]\x20Error\x20deleting\x20conversations','lean','[getConvosByPage]\x20Error\x20getting\x20conversations','length','~/config/winston','VaTLF','[saveBulkConversations]\x20Error\x20saving\x20conversations\x20in\x20bulk','[getConvo]\x20Error\x20getting\x20single\x20conversation','vZUah','[saveConvo]\x20','3oxzyne','Error\x20fetching\x20conversations','countDocuments','context','1250078XWZwiZ','\x20conversations\x20and\x20','error','isArchived','1118438TyYAGD','ceil','info','hEeCM','pageSize','exports','1670384kYKEpg','deletedCount','7807184UBPgde','zBuYR','QVgfB','toObject','conversationId','map','tags','$or'];_0x6aba=function(){return _0x38d724;};return _0x6aba();}function _0x3b93(_0x3acb40,_0x35cf9b){const _0x6aba71=_0x6aba();return _0x3b93=function(_0x3b9317,_0x1ee3d6){_0x3b9317=_0x3b9317-0x161;let _0x590a4d=_0x6aba71[_0x3b9317];return _0x590a4d;},_0x3b93(_0x3acb40,_0x35cf9b);}module[_0x3100a7(0x17c)]={'Conversation':Conversation,'searchConversation':searchConversation,'deleteNullOrEmptyConversations':deleteNullOrEmptyConversations,'saveConvo':async(_0x43019e,{conversationId:_0x4c7071,newConversationId:_0x3c58b8,..._0x3c6e75},_0x2f3aa7)=>{const _0xb6026a=_0x3100a7,_0x31f959={'ylBoQ':function(_0x22d6da,_0xa1e05e,_0x452bf9){return _0x22d6da(_0xa1e05e,_0x452bf9);},'lpTUK':_0xb6026a(0x1ae),'AcglL':function(_0x3b12cc,_0x5aa548){return _0x3b12cc!==_0x5aa548;},'JywMX':_0xb6026a(0x16d),'oZdhd':'Error\x20saving\x20conversation'};try{_0x2f3aa7&&_0x2f3aa7?.[_0xb6026a(0x172)]&&logger[_0xb6026a(0x196)](_0xb6026a(0x16e)+_0x2f3aa7[_0xb6026a(0x172)]);const _0x21e674=await _0x31f959[_0xb6026a(0x18b)](getMessages,{'conversationId':_0x4c7071},_0xb6026a(0x19e)),_0x49493d={..._0x3c6e75,'messages':_0x21e674,'user':_0x43019e[_0xb6026a(0x1ab)]['id']};_0x3c58b8&&(_0x49493d[_0xb6026a(0x183)]=_0x3c58b8);const _0x5bf1f4=await Conversation['findOneAndUpdate']({'conversationId':_0x4c7071,'user':_0x43019e[_0xb6026a(0x1ab)]['id']},_0x49493d,{'new':!![],'upsert':!![]});return _0x5bf1f4[_0xb6026a(0x182)]();}catch(_0x2e49b6){return logger[_0xb6026a(0x175)](_0x31f959[_0xb6026a(0x187)],_0x2e49b6),_0x2f3aa7&&_0x2f3aa7?.[_0xb6026a(0x172)]&&(_0x31f959[_0xb6026a(0x19c)](_0x31f959[_0xb6026a(0x18c)],_0xb6026a(0x180))?logger['info'](_0xb6026a(0x16e)+_0x2f3aa7[_0xb6026a(0x172)]):_0x31658a[_0xb6026a(0x185)]={'$in':_0x189ef6}),{'message':_0x31f959['oZdhd']};}},'bulkSaveConvos':async _0xc6a813=>{const _0xfc99d8=_0x3100a7,_0x5b2944={'aJDJk':_0xfc99d8(0x16b)};try{const _0x42bee5=_0xc6a813[_0xfc99d8(0x184)](_0x25664f=>({'updateOne':{'filter':{'conversationId':_0x25664f[_0xfc99d8(0x183)],'user':_0x25664f['user']},'update':_0x25664f,'upsert':!![],'timestamps':![]}})),_0x56b657=await Conversation['bulkWrite'](_0x42bee5);return _0x56b657;}catch(_0x2e591e){logger[_0xfc99d8(0x175)](_0x5b2944[_0xfc99d8(0x188)],_0x2e591e);throw new Error(_0xfc99d8(0x1a4));}},'getConvosByPage':async(_0x2a6fa3,_0x5ba12d=0x1,_0x46ff9c=0x19,_0x27e0ea=![],_0x34684b)=>{const _0x16ed03=_0x3100a7,_0x2e9c11={'hEeCM':_0x16ed03(0x167)},_0x4bb3f8={'user':_0x2a6fa3};_0x27e0ea?_0x4bb3f8[_0x16ed03(0x176)]=!![]:_0x4bb3f8[_0x16ed03(0x186)]=[{'isArchived':![]},{'isArchived':{'$exists':![]}}];Array[_0x16ed03(0x1ad)](_0x34684b)&&_0x34684b['length']>0x0&&(_0x4bb3f8[_0x16ed03(0x185)]={'$in':_0x34684b});try{const _0x4785cb=await Conversation[_0x16ed03(0x171)](_0x4bb3f8)||0x1,_0x1a313a=Math[_0x16ed03(0x178)](_0x4785cb/_0x46ff9c),_0x3179ad=await Conversation[_0x16ed03(0x1a0)](_0x4bb3f8)['sort']({'updatedAt':-0x1})[_0x16ed03(0x193)]((_0x5ba12d-0x1)*_0x46ff9c)[_0x16ed03(0x1ac)](_0x46ff9c)[_0x16ed03(0x166)]();return{'conversations':_0x3179ad,'pages':_0x1a313a,'pageNumber':_0x5ba12d,'pageSize':_0x46ff9c};}catch(_0xbd1049){return logger[_0x16ed03(0x175)](_0x2e9c11[_0x16ed03(0x17a)],_0xbd1049),{'message':'Error\x20getting\x20conversations'};}},'getConvosQueried':async(_0xfb7bb7,_0x2fd118,_0x22fdba=0x1,_0x45e66f=0x19)=>{const _0x3a2b20=_0x3100a7,_0x4f3a10={'QVgfB':function(_0x213b2c,_0x45f14c){return _0x213b2c===_0x45f14c;},'xCHzH':function(_0x377f6e,_0x31e638){return _0x377f6e/_0x31e638;},'wzfjy':'[getConvosQueried]\x20Error\x20getting\x20conversations','mTIJi':_0x3a2b20(0x170)};try{if(!_0x2fd118||_0x4f3a10[_0x3a2b20(0x181)](_0x2fd118[_0x3a2b20(0x168)],0x0))return{'conversations':[],'pages':0x1,'pageNumber':_0x22fdba,'pageSize':_0x45e66f};const _0x34af64={},_0x286c28={},_0x503c06=[];_0x2fd118[_0x3a2b20(0x1a9)](_0x42dacc=>_0x503c06[_0x3a2b20(0x1a5)](Conversation['findOne']({'user':_0xfb7bb7,'conversationId':_0x42dacc[_0x3a2b20(0x183)]})[_0x3a2b20(0x166)]()));const _0x37273e=(await Promise['all'](_0x503c06))[_0x3a2b20(0x199)](Boolean);_0x37273e[_0x3a2b20(0x1a9)]((_0x4f49b3,_0x1e305d)=>{const _0x15fed5=_0x3a2b20,_0x1dc312=Math[_0x15fed5(0x18d)](_0x1e305d/_0x45e66f)+0x1;!_0x34af64[_0x1dc312]&&(_0x34af64[_0x1dc312]=[]),_0x34af64[_0x1dc312][_0x15fed5(0x1a5)](_0x4f49b3),_0x286c28[_0x4f49b3[_0x15fed5(0x183)]]=_0x4f49b3;});const _0x543a9b=Math['ceil'](_0x4f3a10['xCHzH'](_0x37273e['length'],_0x45e66f));return _0x34af64[_0x3a2b20(0x190)]=_0x543a9b,_0x34af64[_0x3a2b20(0x17b)]=_0x45e66f,{'cache':_0x34af64,'conversations':_0x34af64[_0x22fdba]||[],'pages':_0x543a9b||0x1,'pageNumber':_0x22fdba,'pageSize':_0x45e66f,'convoMap':_0x286c28};}catch(_0xfc29a5){return logger[_0x3a2b20(0x175)](_0x4f3a10[_0x3a2b20(0x19a)],_0xfc29a5),{'message':_0x4f3a10[_0x3a2b20(0x162)]};}},'getConvo':getConvo,'getConvoTitle':async(_0x414d3b,_0x2d7e66)=>{const _0x3ed71a=_0x3100a7,_0x389ef6={'FYEvo':function(_0x50a051,_0x2a04a8,_0x11eaae){return _0x50a051(_0x2a04a8,_0x11eaae);},'nJTCG':'New\x20Chat','wvQDk':_0x3ed71a(0x189),'oBPbg':_0x3ed71a(0x18f)};try{const _0x27a76f=await _0x389ef6[_0x3ed71a(0x1a3)](getConvo,_0x414d3b,_0x2d7e66);return _0x27a76f&&!_0x27a76f[_0x3ed71a(0x191)]?null:_0x27a76f?.[_0x3ed71a(0x191)]||_0x389ef6['nJTCG'];}catch(_0x36a32f){return logger[_0x3ed71a(0x175)](_0x389ef6[_0x3ed71a(0x1a1)],_0x36a32f),{'message':_0x389ef6[_0x3ed71a(0x161)]};}},'deleteConvos':async(_0x26b25b,_0x4244a6)=>{const _0x58f349=_0x3100a7,_0x4ba89b={'fracv':_0x58f349(0x183),'vfLnp':function(_0x40d182,_0x159d0a){return _0x40d182(_0x159d0a);}};let _0x516d76=await Conversation[_0x58f349(0x1a0)]({..._0x4244a6,'user':_0x26b25b})['select'](_0x4ba89b[_0x58f349(0x18a)]);const _0x36a40b=_0x516d76[_0x58f349(0x184)](_0x134c29=>_0x134c29[_0x58f349(0x183)]);let _0x2d6f35=await Conversation[_0x58f349(0x164)]({..._0x4244a6,'user':_0x26b25b});return _0x2d6f35['messages']=await _0x4ba89b[_0x58f349(0x18e)](deleteMessages,{'conversationId':{'$in':_0x36a40b}}),_0x2d6f35;}};