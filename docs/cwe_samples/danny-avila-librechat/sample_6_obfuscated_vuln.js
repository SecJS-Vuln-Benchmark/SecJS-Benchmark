const _0x3f9775=_0xec93;(function(_0x449356,_0x4beb8d){const _0x2a2789=_0xec93,_0x203b2b=_0x449356();while(!![]){try{const _0xf60e56=parseInt(_0x2a2789(0x100))/0x1+-parseInt(_0x2a2789(0xce))/0x2+parseInt(_0x2a2789(0x12c))/0x3+parseInt(_0x2a2789(0xc9))/0x4*(parseInt(_0x2a2789(0x11e))/0x5)+parseInt(_0x2a2789(0xc4))/0x6*(parseInt(_0x2a2789(0xde))/0x7)+parseInt(_0x2a2789(0x10d))/0x8*(-parseInt(_0x2a2789(0xd0))/0x9)+parseInt(_0x2a2789(0xb7))/0xa;if(_0xf60e56===_0x4beb8d)break;else _0x203b2b['push'](_0x203b2b['shift']());}catch(_0x211290){_0x203b2b['push'](_0x203b2b['shift']());}}}(_0x8340,0x4fac6));const fs=require('fs')[_0x3f9775(0x107)],express=require(_0x3f9775(0x127)),{EnvVar}=require(_0x3f9775(0x115)),{isUUID,FileSources,EModelEndpoint,isAgentsEndpoint,checkOpenAIStorage}=require(_0x3f9775(0x10f)),{filterFile,processFileUpload,processDeleteRequest,processAgentFileUpload}=require('~/server/services/Files/process'),{getStrategyFunctions}=require('~/server/services/Files/strategies'),{getOpenAIClient}=require(_0x3f9775(0xba)),{loadAuthValues}=require('~/app/clients/tools/util'),{getAgent}=require(_0x3f9775(0x121)),{getFiles}=require(_0x3f9775(0xbf)),{logger}=require('~/config'),router=express[_0x3f9775(0x111)]();function _0xec93(_0x1b4c9e,_0x4b746e){const _0x834024=_0x8340();return _0xec93=function(_0xec93a2,_0x66cb6f){_0xec93a2=_0xec93a2-0xb6;let _0x5f3add=_0x834024[_0xec93a2];return _0x5f3add;},_0xec93(_0x1b4c9e,_0x4b746e);}router['get']('/',async(_0x629f5c,_0x433114)=>{const _0x44b536=_0x3f9775,_0x1320d3={'kriqO':_0x44b536(0x118),'csETF':_0x44b536(0x110)};try{const _0x403311=await getFiles({'user':_0x629f5c[_0x44b536(0xee)]['id']});_0x433114[_0x44b536(0xd7)](0xc8)[_0x44b536(0xb8)](_0x403311);}catch(_0x85aa5e){logger['error'](_0x1320d3[_0x44b536(0x101)],_0x85aa5e),_0x433114['status'](0x190)[_0x44b536(0xfd)]({'message':_0x1320d3[_0x44b536(0xe7)],'error':_0x85aa5e['message']});}}),router[_0x3f9775(0xec)](_0x3f9775(0xe5),async(_0x3f1e1e,_0x363a11)=>{const _0x1a845d=_0x3f9775,_0x4df2e8={'xGiJW':_0x1a845d(0x110)};try{_0x363a11[_0x1a845d(0xd7)](0xc8)['json'](_0x3f1e1e[_0x1a845d(0x103)][_0x1a845d(0x11a)][_0x1a845d(0x102)]);}catch(_0x30957a){logger[_0x1a845d(0xe8)]('[/files]\x20Error\x20getting\x20fileConfig',_0x30957a),_0x363a11[_0x1a845d(0xd7)](0x190)[_0x1a845d(0xfd)]({'message':_0x4df2e8[_0x1a845d(0x12d)],'error':_0x30957a[_0x1a845d(0xdb)]});}}),router[_0x3f9775(0x125)]('/',async(_0x48e1d2,_0x1aaafb)=>{const _0x1af8e6=_0x3f9775,_0x5cc551={'MpaGf':function(_0x532068,_0x55b836){return _0x532068(_0x55b836);},'GtUBY':'You\x20can\x20only\x20delete\x20your\x20own\x20files','fCwCv':function(_0x28b241,_0x3f0fa6){return _0x28b241===_0x3f0fa6;},'OxvGZ':_0x1af8e6(0x11b)};try{const {files:_0xb87ab}=_0x48e1d2[_0x1af8e6(0x129)],_0x344080=_0xb87ab[_0x1af8e6(0xd2)](_0x14d08f=>{const _0x1abfcf=_0x1af8e6;if(!_0x14d08f[_0x1abfcf(0x105)])return![];if(!_0x14d08f[_0x1abfcf(0xd8)])return![];if(/^(file|assistant)-/[_0x1abfcf(0xfa)](_0x14d08f['file_id']))return!![];return isUUID[_0x1abfcf(0x130)](_0x14d08f[_0x1abfcf(0x105)])[_0x1abfcf(0x116)];});if(_0x344080[_0x1af8e6(0x132)]===0x0){_0x1aaafb['status'](0xcc)[_0x1af8e6(0xfd)]({'message':_0x1af8e6(0xf8)});return;}const _0x352579=_0x344080[_0x1af8e6(0xfc)](_0x47ac17=>_0x47ac17[_0x1af8e6(0x105)]),_0x5266fb=await _0x5cc551[_0x1af8e6(0x119)](getFiles,{'file_id':{'$in':_0x352579}}),_0x43bcd0=_0x5266fb[_0x1af8e6(0xd2)](_0x8bf85e=>_0x8bf85e[_0x1af8e6(0xee)]['toString']()!==_0x48e1d2[_0x1af8e6(0xee)]['id']);if(_0x43bcd0[_0x1af8e6(0x132)]>0x0)return _0x1aaafb['status'](0x193)['json']({'message':_0x5cc551[_0x1af8e6(0xff)],'unauthorizedFiles':_0x43bcd0[_0x1af8e6(0xfc)](_0x4ab4db=>_0x4ab4db[_0x1af8e6(0x105)])});if(_0x48e1d2[_0x1af8e6(0x129)][_0x1af8e6(0xed)]&&_0x48e1d2[_0x1af8e6(0x129)][_0x1af8e6(0x109)]&&_0x5cc551[_0x1af8e6(0x120)](_0x5266fb[_0x1af8e6(0x132)],0x0)){const _0x49bfd9=await _0x5cc551[_0x1af8e6(0x119)](getAgent,{'id':_0x48e1d2['body']['agent_id']}),_0x1d6466=_0x49bfd9['tool_resources']?.[_0x48e1d2[_0x1af8e6(0x129)][_0x1af8e6(0x109)]]?.['file_ids']??[],_0x88c915=_0x344080[_0x1af8e6(0xd2)](_0x3e4192=>_0x1d6466[_0x1af8e6(0xda)](_0x3e4192[_0x1af8e6(0x105)]));await processDeleteRequest({'req':_0x48e1d2,'files':_0x88c915}),_0x1aaafb[_0x1af8e6(0xd7)](0xc8)[_0x1af8e6(0xfd)]({'message':_0x1af8e6(0x12e)});return;}await _0x5cc551[_0x1af8e6(0x119)](processDeleteRequest,{'req':_0x48e1d2,'files':_0x5266fb}),logger[_0x1af8e6(0xbc)]('[/files]\x20Files\x20deleted\x20successfully:\x20'+_0x344080[_0x1af8e6(0xd2)](_0x87f326=>_0x87f326[_0x1af8e6(0x105)])['map'](_0x25b484=>_0x25b484[_0x1af8e6(0x105)])[_0x1af8e6(0xdc)](',\x20')),_0x1aaafb[_0x1af8e6(0xd7)](0xc8)['json']({'message':_0x5cc551[_0x1af8e6(0xf3)]});}catch(_0x47bdf3){logger[_0x1af8e6(0xe8)](_0x1af8e6(0xb6),_0x47bdf3),_0x1aaafb[_0x1af8e6(0xd7)](0x190)[_0x1af8e6(0xfd)]({'message':_0x1af8e6(0x110),'error':_0x47bdf3['message']});}}),router['get'](_0x3f9775(0xcd),async(_0x305dbd,_0x46ad7a)=>{const _0x43eb4e=_0x3f9775,_0x2a681b={'uSoCQ':'Not\x20Implemented','kFbxl':function(_0x434700,_0xd42bb2){return _0x434700(_0xd42bb2);},'NksfZ':function(_0x27a0f1,_0xe4677b,_0x52e609){return _0x27a0f1(_0xe4677b,_0x52e609);}};try{const {session_id:_0x32be4d,fileId:_0x1d26c5}=_0x305dbd[_0x43eb4e(0xdf)],_0x4045e9=_0x43eb4e(0x124)+_0x32be4d+_0x43eb4e(0x11c)+_0x1d26c5+_0x43eb4e(0xc0);logger[_0x43eb4e(0xbc)](_0x4045e9);if(!_0x32be4d||!_0x1d26c5)return _0x46ad7a[_0x43eb4e(0xd7)](0x190)['send'](_0x43eb4e(0xe4));const {getDownloadStream:_0x248857}=getStrategyFunctions(FileSources[_0x43eb4e(0x128)]);if(!_0x248857)return logger[_0x43eb4e(0xc5)](_0x4045e9+_0x43eb4e(0xcb)+FileSources[_0x43eb4e(0x128)]+_0x43eb4e(0xe9)),_0x46ad7a['status'](0x1f5)[_0x43eb4e(0xb8)](_0x2a681b[_0x43eb4e(0xf5)]);const _0x18cabb=await _0x2a681b[_0x43eb4e(0xc6)](loadAuthValues,{'userId':_0x305dbd[_0x43eb4e(0xee)]['id'],'authFields':[EnvVar[_0x43eb4e(0x112)]]}),_0x4c5c12=await _0x2a681b['NksfZ'](_0x248857,_0x32be4d+'/'+_0x1d26c5,_0x18cabb[EnvVar[_0x43eb4e(0x112)]]);_0x46ad7a[_0x43eb4e(0x11f)](_0x4c5c12['headers']),_0x4c5c12[_0x43eb4e(0xdd)][_0x43eb4e(0xe3)](_0x46ad7a);}catch(_0x38b2b5){logger[_0x43eb4e(0xe8)](_0x43eb4e(0x12b),_0x38b2b5),_0x46ad7a[_0x43eb4e(0xd7)](0x1f4)[_0x43eb4e(0xb8)](_0x43eb4e(0xd4));}}),router[_0x3f9775(0xec)](_0x3f9775(0xc3),async(_0x11a92a,_0x320bce)=>{const _0x34a23f=_0x3f9775,_0x5e52fb={'RHqOY':_0x34a23f(0xb9),'stREo':_0x34a23f(0xcc),'zVKnQ':function(_0x5cf003,_0x436af){return _0x5cf003!==_0x436af;},'XiljL':_0x34a23f(0x11d),'PAsPO':_0x34a23f(0x131),'jVvXN':function(_0x2b0d92,_0x3f5dac){return _0x2b0d92(_0x3f5dac);},'MnoQh':function(_0x3c63d5,_0x17b051){return _0x3c63d5!==_0x17b051;},'tPMlw':_0x34a23f(0xc7),'GGziN':_0x34a23f(0xc1),'wVhHC':function(_0x518f07){return _0x518f07();},'xYJNv':_0x34a23f(0xd4)};try{const {userId:_0x30a11a,file_id:_0xb1b662}=_0x11a92a[_0x34a23f(0xdf)];logger[_0x34a23f(0xbc)](_0x34a23f(0xe2)+_0x30a11a+':\x20'+_0xb1b662);if(_0x5e52fb[_0x34a23f(0x10a)](_0x30a11a,_0x11a92a[_0x34a23f(0xee)]['id']))return logger[_0x34a23f(0xc5)](_0x657387+_0x34a23f(0x122)+_0xb1b662),_0x320bce[_0x34a23f(0xd7)](0x193)[_0x34a23f(0xb8)](_0x5e52fb[_0x34a23f(0xd6)]);const [_0x36592a]=await getFiles({'file_id':_0xb1b662}),_0x657387='File\x20download\x20requested\x20by\x20user\x20'+_0x30a11a;if(!_0x36592a)return logger[_0x34a23f(0xc5)](_0x657387+_0x34a23f(0x134)+_0xb1b662),_0x320bce['status'](0x194)['send'](_0x34a23f(0xf4));if(!_0x36592a[_0x34a23f(0xd8)][_0x34a23f(0xda)](_0x30a11a))return _0x5e52fb[_0x34a23f(0x113)]===_0x5e52fb[_0x34a23f(0x113)]?(logger['warn'](_0x657387+_0x34a23f(0x122)+_0xb1b662),_0x320bce[_0x34a23f(0xd7)](0x193)[_0x34a23f(0xb8)](_0x5e52fb[_0x34a23f(0xd6)])):(_0x2b4dda[_0x34a23f(0xc5)](_0x2b7a6d+_0x34a23f(0x122)+_0x30c0f6),_0x5a9a54['status'](0x193)[_0x34a23f(0xb8)](_0x34a23f(0x11d)));if(_0x5e52fb[_0x34a23f(0x133)](checkOpenAIStorage,_0x36592a[_0x34a23f(0xf9)])&&!_0x36592a[_0x34a23f(0xc8)]){if(_0x5e52fb['MnoQh'](_0x5e52fb[_0x34a23f(0xf0)],_0x5e52fb['GGziN']))return logger[_0x34a23f(0xc5)](_0x657387+_0x34a23f(0xd1)+_0xb1b662),_0x320bce[_0x34a23f(0xd7)](0x190)[_0x34a23f(0xb8)](_0x34a23f(0x126));else{_0x12035e['status'](0xcc)[_0x34a23f(0xfd)]({'message':_0x34a23f(0xf8)});return;}}const {getDownloadStream:_0x14363b}=getStrategyFunctions(_0x36592a[_0x34a23f(0xf9)]);if(!_0x14363b)return logger[_0x34a23f(0xc5)](_0x657387+_0x34a23f(0x117)+_0x36592a[_0x34a23f(0xf9)]),_0x320bce[_0x34a23f(0xd7)](0x1f5)[_0x34a23f(0xb8)]('Not\x20Implemented');const _0x490b49=()=>{const _0x1903f3=_0x34a23f;_0x320bce['setHeader']('Content-Disposition','attachment;\x20filename=\x22'+_0x36592a['filename']+'\x22'),_0x320bce[_0x1903f3(0x104)](_0x1903f3(0xe0),_0x5e52fb[_0x1903f3(0xf7)]),_0x320bce[_0x1903f3(0x104)](_0x5e52fb[_0x1903f3(0x10c)],JSON[_0x1903f3(0x106)](_0x36592a));};let _0x3a1e5e,_0x168052;if(checkOpenAIStorage(_0x36592a[_0x34a23f(0xf9)])){_0x11a92a[_0x34a23f(0x129)]={'model':_0x36592a[_0x34a23f(0xc8)]};const _0x2b1725={[FileSources[_0x34a23f(0xf1)]]:EModelEndpoint['assistants'],[FileSources[_0x34a23f(0xf6)]]:EModelEndpoint[_0x34a23f(0x10b)]},{openai:_0x5142c7}=await getOpenAIClient({'req':_0x11a92a,'res':_0x320bce,'overrideEndpoint':_0x2b1725[_0x36592a[_0x34a23f(0xf9)]]});logger[_0x34a23f(0xbc)](_0x34a23f(0xbd)+_0xb1b662+_0x34a23f(0xe1)),_0x3a1e5e=await _0x14363b(_0xb1b662,_0x5142c7),_0x5e52fb[_0x34a23f(0x123)](_0x490b49),logger[_0x34a23f(0xbc)](_0x34a23f(0x108)+_0xb1b662+_0x34a23f(0xef)),_0x3a1e5e['body']['pipe'](_0x320bce);}else _0x168052=_0x5e52fb[_0x34a23f(0x133)](_0x14363b,_0xb1b662),_0x490b49(),_0x168052['pipe'](_0x320bce);}catch(_0x48d4f7){logger[_0x34a23f(0xe8)](_0x34a23f(0x12b),_0x48d4f7),_0x320bce[_0x34a23f(0xd7)](0x1f4)[_0x34a23f(0xb8)](_0x5e52fb[_0x34a23f(0xfb)]);}}),router[_0x3f9775(0xc2)]('/',async(_0x46be75,_0x8a1084)=>{const _0x24870b=_0x3f9775,_0x3fd4e9={'yzcuv':_0x24870b(0xd5),'YCrGy':function(_0x4716ab,_0xb4c0ee){return _0x4716ab(_0xb4c0ee);},'dbbev':'Error\x20processing\x20file','AWzLK':_0x24870b(0xeb),'LqFjH':'file_ids','HJhFT':_0x24870b(0xfe)},_0x19d51a=_0x46be75[_0x24870b(0xd9)],_0x37af11=_0x46be75[_0x24870b(0x129)];let _0x14aa35=!![];try{const _0x52e4db=_0x3fd4e9[_0x24870b(0x10e)]['split']('|');let _0x3692d7=0x0;while(!![]){switch(_0x52e4db[_0x3692d7++]){case'0':filterFile({'req':_0x46be75,'file':_0x19d51a});continue;case'1':if(isAgentsEndpoint(_0x37af11[_0x24870b(0x12a)]))return await _0x3fd4e9[_0x24870b(0xbb)](processAgentFileUpload,{'req':_0x46be75,'res':_0x8a1084,'file':_0x19d51a,'metadata':_0x37af11});continue;case'2':_0x37af11[_0x24870b(0x105)]=_0x46be75['file_id'];continue;case'3':_0x37af11[_0x24870b(0x12f)]=_0x37af11['file_id'];continue;case'4':await processFileUpload({'req':_0x46be75,'res':_0x8a1084,'file':_0x19d51a,'metadata':_0x37af11});continue;}break;}}catch(_0x48cfb4){let _0x5ee785=_0x3fd4e9[_0x24870b(0xea)];logger[_0x24870b(0xe8)](_0x3fd4e9[_0x24870b(0x114)],_0x48cfb4);_0x48cfb4[_0x24870b(0xdb)]?.['includes'](_0x3fd4e9[_0x24870b(0xcf)])&&(_0x5ee785+=':\x20'+_0x48cfb4['message']);try{await fs[_0x24870b(0xca)](_0x19d51a[_0x24870b(0xbe)]),_0x14aa35=![];}catch(_0x2a8537){logger['error'](_0x24870b(0xd3),_0x2a8537);}_0x8a1084['status'](0x1f4)[_0x24870b(0xfd)]({'message':_0x5ee785});}if(_0x14aa35)try{if(_0x3fd4e9['HJhFT']!=='CUjEF')await fs[_0x24870b(0xca)](_0x19d51a[_0x24870b(0xbe)]);else return![];}catch(_0x54cc07){logger[_0x24870b(0xe8)](_0x24870b(0xf2),_0x54cc07);}}),module[_0x3f9775(0xe6)]=router;function _0x8340(){const _0x59d79e=['warn','kFbxl','Yqcxf','model','310136KcAbhy','unlink','\x20has\x20no\x20stream\x20method\x20implemented\x20for\x20','X-File-Metadata','/code/download/:session_id/:fileId','610196mDaUup','LqFjH','69426ONlrkx','\x20has\x20no\x20associated\x20model:\x20','filter','[/files]\x20Error\x20deleting\x20file:','Error\x20downloading\x20file','0|3|2|1|4','XiljL','status','filepath','file','includes','message','join','data','33957ocwQrp','params','Content-Type','\x20from\x20OpenAI','File\x20download\x20requested\x20by\x20user\x20','pipe','Bad\x20request','/config','exports','csETF','error','\x20source','dbbev','[/files]\x20Error\x20processing\x20file:','get','agent_id','user','\x20downloaded\x20from\x20OpenAI','tPMlw','openai','[/files]\x20Error\x20deleting\x20file\x20after\x20file\x20processing:','OxvGZ','File\x20not\x20found','uSoCQ','azure','RHqOY','Nothing\x20provided\x20to\x20delete','source','test','xYJNv','map','json','wCZEB','GtUBY','148181URgRpf','kriqO','fileConfig','app','setHeader','file_id','stringify','promises','File\x20','tool_resource','zVKnQ','azureAssistants','stREo','536GfnOsO','yzcuv','librechat-data-provider','Error\x20in\x20request','Router','CODE_API_KEY','PAsPO','AWzLK','@librechat/agents','success','\x20has\x20no\x20stream\x20method\x20implemented:\x20','[/files]\x20Error\x20getting\x20files:','MpaGf','locals','Files\x20deleted\x20successfully','\x20|\x20File\x20ID:\x20','Forbidden','25qNsPcO','set','fCwCv','~/models/Agent','\x20forbidden:\x20','wVhHC','Session\x20ID:\x20','delete','The\x20model\x20used\x20when\x20creating\x20this\x20file\x20is\x20not\x20available','express','execute_code','body','endpoint','Error\x20downloading\x20file:','588969aBITJf','xGiJW','File\x20associations\x20removed\x20successfully','temp_file_id','safeParse','aBYfK','length','jVvXN','\x20not\x20found:\x20','[/files]\x20Error\x20deleting\x20files:','1978090iZQKuF','send','application/octet-stream','~/server/controllers/assistants/helpers','YCrGy','debug','Downloading\x20file\x20','path','~/models/File','\x20|\x20Code\x20output\x20download\x20requested\x20by\x20user\x20','wAwdS','post','/download/:userId/:file_id','270ugAqyP'];_0x8340=function(){return _0x59d79e;};return _0x8340();}