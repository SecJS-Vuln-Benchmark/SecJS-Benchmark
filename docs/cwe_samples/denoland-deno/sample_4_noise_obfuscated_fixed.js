function _0x2e15(_0x1712b7,_0x142433){const _0x222ba0=_0x222b();return _0x2e15=function(_0x2e153c,_0xc70f55){_0x2e153c=_0x2e153c-0x10e;let _0x5196c8=_0x222ba0[_0x2e153c];return _0x5196c8;},_0x2e15(_0x1712b7,_0x142433);}const _0xa20e43=_0x2e15;(function(_0x41713a,_0x30e4af){const _0x1fdb90=_0x2e15,_0x42943c=_0x41713a();while(!![]){try{const _0x33c276=-parseInt(_0x1fdb90(0x18a))/0x1*(-parseInt(_0x1fdb90(0x1bd))/0x2)+parseInt(_0x1fdb90(0x111))/0x3*(-parseInt(_0x1fdb90(0x120))/0x4)+parseInt(_0x1fdb90(0x197))/0x5+parseInt(_0x1fdb90(0x14b))/0x6+-parseInt(_0x1fdb90(0x116))/0x7+-parseInt(_0x1fdb90(0x11d))/0x8*(parseInt(_0x1fdb90(0x16a))/0x9)+parseInt(_0x1fdb90(0x17f))/0xa*(parseInt(_0x1fdb90(0x194))/0xb);if(_0x33c276===_0x30e4af)break;else _0x42943c['push'](_0x42943c['shift']());}catch(_0x447c02){_0x42943c['push'](_0x42943c['shift']());}}}(_0x222b,0xeb9d2));const fs=require('fs'),path=require(_0xa20e43(0x1c2)),mime=require(_0xa20e43(0x1c8)),{v4}=require(_0xa20e43(0x15e)),{isUUID,megabyte,FileContext,FileSources,imageExtRegex,EModelEndpoint,EToolResources,mergeFileConfig,hostImageIdSuffix,checkOpenAIStorage,removeNullishValues,hostImageNamePrefix,isAssistantsEndpoint}=require(_0xa20e43(0x16f)),{EnvVar}=require(_0xa20e43(0x158)),{addResourceFileId,deleteResourceFileId}=require(_0xa20e43(0x140)),{convertImage,resizeAndConvert}=require(_0xa20e43(0x145)),{addAgentResourceFile,removeAgentResourceFile}=require(_0xa20e43(0x1aa)),{getOpenAIClient}=require(_0xa20e43(0x13f)),{createFile,updateFileUsage,deleteFiles}=require('~/models/File'),{loadAuthValues}=require(_0xa20e43(0x133)),{LB_QueueAsyncCall}=require(_0xa20e43(0x123)),{getStrategyFunctions}=require(_0xa20e43(0x11b)),{determineFileType}=require(_0xa20e43(0x12e)),{logger}=require(_0xa20e43(0x1c7)),processFiles=async _0x11b3c4=>{const _0x16c9a0=_0xa20e43,_0x3bc0b7={'igPej':function(_0x2db76e,_0x1aed2e){return _0x2db76e(_0x1aed2e);},'NieBL':'console.log(\x22timer\x22);'},_0x51751e=[];for(let _0x5b66dc of _0x11b3c4){const {file_id:_0x122670}=_0x5b66dc;_0x51751e[_0x16c9a0(0x1d3)](_0x3bc0b7[_0x16c9a0(0x1b4)](updateFileUsage,{'file_id':_0x122670}));}return setTimeout(_0x3bc0b7[_0x16c9a0(0x189)],0x3e8),await Promise[_0x16c9a0(0x198)](_0x51751e);};function enqueueDeleteOperation({req:_0x5b5b46,file:_0x24ae51,deleteFile:_0x5bbcb7,promises:_0x3f95ab,resolvedFileIds:_0x113fa5,openai:_0x190c1b}){const _0x3348a3=_0xa20e43,_0x50884d={'kwFbO':function(_0x585e67,_0x4d2e1e){return _0x585e67(_0x4d2e1e);},'daisE':function(_0x176047,_0x58682b){return _0x176047!==_0x58682b;},'dSCZp':'DGpnn','wKWUf':_0x3348a3(0x1cf),'swvEU':function(_0x24c72f,_0x513314,_0x3b6db5,_0x513101){return _0x24c72f(_0x513314,_0x3b6db5,_0x513101);},'LhSEz':function(_0x5536ef,_0x17b0c9){return _0x5536ef!==_0x17b0c9;},'MDRzv':function(_0x158ad4,_0x40f5c4,_0x431327){return _0x158ad4(_0x40f5c4,_0x431327);}};checkOpenAIStorage(_0x24ae51[_0x3348a3(0x1b2)])?_0x3f95ab[_0x3348a3(0x1d3)](new Promise((_0x5db966,_0x52b736)=>{const _0x250795=_0x3348a3,_0x4970f6={'ZbROR':function(_0x1df94a,_0x36247f){const _0x322943=_0x2e15;return _0x50884d[_0x322943(0x164)](_0x1df94a,_0x36247f);},'DNCgG':_0x250795(0x196),'IkMey':_0x250795(0x169),'LqbaP':function(_0xe7d9a1,_0xe4ac90){return _0xe7d9a1(_0xe4ac90);}};_0x50884d[_0x250795(0x173)](_0x50884d['dSCZp'],_0x50884d[_0x250795(0x122)])?_0x50884d['swvEU'](LB_QueueAsyncCall,()=>_0x5bbcb7(_0x5b5b46,_0x24ae51,_0x190c1b),[],(_0x2238b1,_0x105df2)=>{const _0x243717=_0x250795;_0x2238b1?_0x243717(0x184)===_0x4970f6[_0x243717(0x1b0)]?_0x266b4a?(_0x34593d['error'](_0x243717(0x169),_0x53e435),_0x21bb04(_0x3e588e)):(_0x46f83f['push'](_0x41d5f6[_0x243717(0x151)]),_0x4970f6[_0x243717(0x18e)](_0x321d0a,_0x4657d0)):(logger[_0x243717(0x161)](_0x4970f6[_0x243717(0x11f)],_0x2238b1),_0x52b736(_0x2238b1)):(_0x113fa5[_0x243717(0x1d3)](_0x24ae51[_0x243717(0x151)]),_0x4970f6[_0x243717(0x15f)](_0x5db966,_0x105df2));}):_0x19efc2[_0x250795(0x178)]('safe');})):_0x3f95ab[_0x3348a3(0x1d3)](_0x5bbcb7(_0x5b5b46,_0x24ae51)[_0x3348a3(0x1cc)](()=>_0x113fa5['push'](_0x24ae51[_0x3348a3(0x151)]))[_0x3348a3(0x1cd)](_0x3dac16=>{const _0x1d931a=_0x3348a3,_0x56ceb1={'WRgyn':_0x1d931a(0x1d9)};if(_0x50884d[_0x1d931a(0x1bb)]('yiqjf',_0x1d931a(0x134)))throw new _0x57b95c(_0x56ceb1['WRgyn']);else return logger[_0x1d931a(0x161)](_0x1d931a(0x188),_0x3dac16),_0x50884d[_0x1d931a(0x1b5)](setTimeout,function(){const _0x2d0dd9=_0x1d931a;console[_0x2d0dd9(0x178)]('safe');},0x64),Promise[_0x1d931a(0x1d8)](_0x3dac16);}));}const processDeleteRequest=async({req:_0xb426b6,files:_0x1659bb})=>{const _0x1bf416=_0xa20e43,_0x4961b3={'WjBFv':function(_0x1567e4,_0x54b27b){return _0x1567e4(_0x54b27b);},'GlEte':_0x1bf416(0x153),'VysVa':function(_0x44888d,_0x4e8490){return _0x44888d(_0x4e8490);},'yHJNq':function(_0x3752fc,_0x202218){return _0x3752fc===_0x202218;},'jPqki':_0x1bf416(0x183),'qgGba':_0x1bf416(0x1b6),'HMGQB':_0x1bf416(0x1ae),'sKXFj':_0x1bf416(0x19a),'NLEAn':function(_0x1a9499,_0x15fb3b){return _0x1a9499(_0x15fb3b);},'XUilO':function(_0x153596,_0xfc15f1){return _0x153596(_0xfc15f1);}},_0x1f72a0=[],_0x205954={},_0x5229cd=[],_0x1a6d69={[FileSources['openai']]:undefined,[FileSources[_0x1bf416(0x1b9)]]:undefined},_0x217af9=async()=>{const _0x4f584e=_0x1bf416,_0x453ead=await _0x4961b3['WjBFv'](getOpenAIClient,{'req':_0xb426b6,'overrideEndpoint':EModelEndpoint[_0x4f584e(0x1ba)]});_0x1a6d69[FileSources[_0x4f584e(0x160)]]=_0x453ead[_0x4f584e(0x160)];if(!_0xb426b6[_0x4f584e(0x152)][_0x4f584e(0x143)][EModelEndpoint[_0x4f584e(0x1c1)]]?.['assistants']){new AsyncFunction(_0x4f584e(0x11c))();return;}const _0x371660=await getOpenAIClient({'req':_0xb426b6,'overrideEndpoint':EModelEndpoint[_0x4f584e(0x186)]});_0x1a6d69[FileSources[_0x4f584e(0x1b9)]]=_0x371660['openai'];};_0xb426b6[_0x1bf416(0x118)][_0x1bf416(0x113)]!==undefined&&await _0x217af9();for(const _0x3171d9 of _0x1659bb){const _0x55a8d1=_0x3171d9[_0x1bf416(0x1b2)]??FileSources[_0x1bf416(0x154)];_0xb426b6[_0x1bf416(0x118)][_0x1bf416(0x1b1)]&&_0xb426b6['body']['tool_resource']&&(_0x1bf416(0x175)===_0x1bf416(0x175)?_0x5229cd[_0x1bf416(0x1d3)](_0x4961b3[_0x1bf416(0x12b)](removeAgentResourceFile,{'req':_0xb426b6,'file_id':_0x3171d9[_0x1bf416(0x151)],'agent_id':_0xb426b6['body'][_0x1bf416(0x1b1)],'tool_resource':_0xb426b6[_0x1bf416(0x118)][_0x1bf416(0x16b)]})):_0x1c2b38['error']('Error\x20updating\x20file\x20usage',_0xec63ad));_0x4961b3[_0x1bf416(0x12b)](checkOpenAIStorage,_0x55a8d1)&&!_0x1a6d69[_0x55a8d1]&&(_0x4961b3[_0x1bf416(0x141)](_0x4961b3[_0x1bf416(0x16d)],_0x1bf416(0x183))?await _0x217af9():_0x334043[_0x1bf416(0x1d3)](_0x2f1d6f[_0x1bf416(0x182)][_0x1bf416(0x1ba)]['files']['del'](_0x3911d2['body']['assistant_id'],_0x350728[_0x1bf416(0x151)])));const _0x3ed8ee=_0x1a6d69[_0x55a8d1];if(_0xb426b6['body']['assistant_id']&&_0xb426b6[_0x1bf416(0x118)][_0x1bf416(0x16b)])_0x5229cd['push'](_0x4961b3[_0x1bf416(0x148)](deleteResourceFileId,{'req':_0xb426b6,'openai':_0x3ed8ee,'file_id':_0x3171d9[_0x1bf416(0x151)],'assistant_id':_0xb426b6[_0x1bf416(0x118)][_0x1bf416(0x113)],'tool_resource':_0xb426b6[_0x1bf416(0x118)][_0x1bf416(0x16b)]}));else _0xb426b6['body'][_0x1bf416(0x113)]&&(_0x4961b3[_0x1bf416(0x18d)]===_0x4961b3[_0x1bf416(0x1d1)]?_0x5cb41c['log'](_0x4961b3[_0x1bf416(0x12d)]):_0x5229cd[_0x1bf416(0x1d3)](_0x3ed8ee[_0x1bf416(0x182)][_0x1bf416(0x1ba)][_0x1bf416(0x166)]['del'](_0xb426b6[_0x1bf416(0x118)][_0x1bf416(0x113)],_0x3171d9['file_id'])));if(_0x205954[_0x55a8d1]){if(_0x4961b3[_0x1bf416(0x141)](_0x1bf416(0x181),_0x4961b3[_0x1bf416(0x187)]))0x1+0x1;else{_0x4961b3[_0x1bf416(0x148)](enqueueDeleteOperation,{'req':_0xb426b6,'file':_0x3171d9,'deleteFile':_0x205954[_0x55a8d1],'promises':_0x5229cd,'resolvedFileIds':_0x1f72a0,'openai':_0x3ed8ee});continue;}}const {deleteFile:_0x4572e7}=_0x4961b3[_0x1bf416(0x192)](getStrategyFunctions,_0x55a8d1);if(!_0x4572e7)throw new Error('Delete\x20function\x20not\x20implemented\x20for\x20'+_0x55a8d1);_0x205954[_0x55a8d1]=_0x4572e7,_0x4961b3['XUilO'](enqueueDeleteOperation,{'req':_0xb426b6,'file':_0x3171d9,'deleteFile':_0x4572e7,'promises':_0x5229cd,'resolvedFileIds':_0x1f72a0,'openai':_0x3ed8ee});}await Promise[_0x1bf416(0x155)](_0x5229cd),await _0x4961b3[_0x1bf416(0x148)](deleteFiles,_0x1f72a0);},processFileURL=async({fileStrategy:_0x107164,userId:_0x273e4b,URL:_0x16accc,fileName:_0x2d9761,basePath:_0xf1663f,context:_0x37f85e})=>{const _0x5c56f2=_0xa20e43,_0x8aa0fd={'puped':function(_0x3d29ed,_0x69ceb2,_0x37c0b2){return _0x3d29ed(_0x69ceb2,_0x37c0b2);},'TlzyL':function(_0xeef5fd){return _0xeef5fd();}},{saveURL:_0x561514,getFileURL:_0x35f2f9}=getStrategyFunctions(_0x107164);try{const {bytes:bytes=0x0,type:type='',dimensions:dimensions={}}=await _0x561514({'userId':_0x273e4b,'URL':_0x16accc,'fileName':_0x2d9761,'basePath':_0xf1663f})||{},_0x4517c6=await _0x35f2f9({'fileName':_0x273e4b+'/'+_0x2d9761,'basePath':_0xf1663f});return _0x8aa0fd[_0x5c56f2(0x13a)](setInterval,_0x5c56f2(0x1af),0x3e8),await createFile({'user':_0x273e4b,'file_id':_0x8aa0fd[_0x5c56f2(0x167)](v4),'bytes':bytes,'filepath':_0x4517c6,'filename':_0x2d9761,'source':_0x107164,'type':type,'context':_0x37f85e,'width':dimensions['width'],'height':dimensions[_0x5c56f2(0x13e)]},!![]);}catch(_0x1198ed){logger[_0x5c56f2(0x161)](_0x5c56f2(0x17a)+_0x107164+':',_0x1198ed);throw new Error(_0x5c56f2(0x112)+_0x107164+'.\x20'+_0x1198ed[_0x5c56f2(0x1b3)]);}},processImageFile=async({req:_0x354921,res:_0x37cf3f,file:_0x9ee123,metadata:_0x10bf65,returnFile:returnFile=![]})=>{const _0x3c0c9d=_0xa20e43,_0x3ccae4={'nFReQ':_0x3c0c9d(0x12a)},_0x2bf7ce=_0x354921[_0x3c0c9d(0x152)][_0x3c0c9d(0x143)][_0x3c0c9d(0x136)],{handleImageUpload:_0x41d622}=getStrategyFunctions(_0x2bf7ce),{file_id:_0x764e43,temp_file_id:_0x234483,endpoint:_0x58dbda}=_0x10bf65,{filepath:_0x1e8baf,bytes:_0x33b3a8,width:_0x488e31,height:_0x1c7edc}=await _0x41d622({'req':_0x354921,'file':_0x9ee123,'file_id':_0x764e43,'endpoint':_0x58dbda}),_0x50bebc=await createFile({'user':_0x354921[_0x3c0c9d(0x180)]['id'],'file_id':_0x764e43,'temp_file_id':_0x234483,'bytes':_0x33b3a8,'filepath':_0x1e8baf,'filename':_0x9ee123[_0x3c0c9d(0x15d)],'context':FileContext[_0x3c0c9d(0x1ab)],'source':_0x2bf7ce,'type':_0x3c0c9d(0x19c)+_0x354921['app']['locals'][_0x3c0c9d(0x199)],'width':_0x488e31,'height':_0x1c7edc},!![]);if(returnFile)return setInterval(_0x3c0c9d(0x1af),0x3e8),_0x50bebc;_0x37cf3f['status'](0xc8)[_0x3c0c9d(0x10e)]({'message':_0x3ccae4[_0x3c0c9d(0x1dc)],..._0x50bebc});},uploadImageBuffer=async({req:_0xa3befb,context:_0x26f393,metadata:metadata={},resize:resize=!![]})=>{const _0x134d5a=_0xa20e43,_0x6598d8={'EwGmS':function(_0x5e9ea0,_0x34a595){return _0x5e9ea0(_0x34a595);},'sRGMx':function(_0x6515a1,_0x2b93c9){return _0x6515a1(_0x2b93c9);},'yvgdC':_0x134d5a(0x172),'rhlNI':function(_0x2da351,_0x4e13e3,_0x263bee){return _0x2da351(_0x4e13e3,_0x263bee);}},_0x44c28e=_0xa3befb[_0x134d5a(0x152)][_0x134d5a(0x143)]['fileStrategy'],{saveBuffer:_0x4682ec}=getStrategyFunctions(_0x44c28e);let {buffer:_0x5b246c,width:_0x1eaa06,height:_0x5bd0ce,bytes:_0x221f47,filename:_0x464bab,file_id:_0x4033a6,type:_0x74cd98}=metadata;resize&&(_0x4033a6=v4(),_0x74cd98='image/'+_0xa3befb[_0x134d5a(0x152)][_0x134d5a(0x143)]['imageOutputType'],{buffer:_0x5b246c,width:_0x1eaa06,height:_0x5bd0ce,bytes:_0x221f47}=await _0x6598d8[_0x134d5a(0x1a7)](resizeAndConvert,{'inputBuffer':_0x5b246c,'desiredFormat':_0xa3befb[_0x134d5a(0x152)]['locals'][_0x134d5a(0x199)]}),_0x464bab=path[_0x134d5a(0x132)](_0xa3befb[_0x134d5a(0x12f)][_0x134d5a(0x15d)],path[_0x134d5a(0x163)](_0xa3befb[_0x134d5a(0x12f)]['originalname']))+'.'+_0xa3befb[_0x134d5a(0x152)]['locals'][_0x134d5a(0x199)]);const _0x5e69a0=await _0x4682ec({'userId':_0xa3befb[_0x134d5a(0x180)]['id'],'fileName':_0x464bab,'buffer':_0x5b246c});return _0x6598d8[_0x134d5a(0x1ca)](Function,_0x6598d8[_0x134d5a(0x159)])(),await _0x6598d8[_0x134d5a(0x1d5)](createFile,{'user':_0xa3befb[_0x134d5a(0x180)]['id'],'file_id':_0x4033a6,'bytes':_0x221f47,'filepath':_0x5e69a0,'filename':_0x464bab,'context':_0x26f393,'source':_0x44c28e,'type':_0x74cd98,'width':_0x1eaa06,'height':_0x5bd0ce},!![]);},processFileUpload=async({req:_0x579dc9,res:_0x5f04c9,file:_0x489cda,metadata:_0x120cb3})=>{const _0x2833af=_0xa20e43,_0x31b07a={'bjPAN':'Error\x20deleting\x20file\x20from\x20OpenAI\x20source','pzbUA':function(_0x289a0a,_0x502e41){return _0x289a0a(_0x502e41);},'WdOuv':function(_0x5bce9c,_0x53f6f1){return _0x5bce9c===_0x53f6f1;},'jviPd':function(_0x452e82,_0x2ee008){return _0x452e82!==_0x2ee008;},'KZXLs':_0x2833af(0x1a3),'Iltkk':_0x2833af(0x1c5),'JoCZt':function(_0x1a27ab){return _0x1a27ab();},'jqomK':function(_0x1cf604,_0x406675,_0x233ed7){return _0x1cf604(_0x406675,_0x233ed7);},'hTkXA':'File\x20uploaded\x20and\x20processed\x20successfully'},_0x28d2ef=isAssistantsEndpoint(_0x120cb3[_0x2833af(0x1ce)]),_0xe2ae48=_0x31b07a[_0x2833af(0x1db)](_0x120cb3['endpoint'],EModelEndpoint[_0x2833af(0x186)])?FileSources[_0x2833af(0x1b9)]:FileSources[_0x2833af(0x160)],_0x1c8afd=_0x28d2ef?_0xe2ae48:FileSources['vectordb'],{handleFileUpload:_0x1ad049}=getStrategyFunctions(_0x1c8afd),{file_id:_0xb63954,temp_file_id:_0x493380}=_0x120cb3;let _0x4d6453;_0x31b07a['pzbUA'](checkOpenAIStorage,_0x1c8afd)&&({openai:_0x4d6453}=await _0x31b07a[_0x2833af(0x121)](getOpenAIClient,{'req':_0x579dc9}));const {id:_0x11de6e,bytes:_0x1722d5,filename:_0x453a9e,filepath:_0x32f5e0,embedded:_0x44249d,height:_0x2c9942,width:_0x4e6134}=await _0x31b07a[_0x2833af(0x121)](_0x1ad049,{'req':_0x579dc9,'file':_0x489cda,'file_id':_0xb63954,'openai':_0x4d6453});if(_0x28d2ef&&!_0x120cb3[_0x2833af(0x149)]&&!_0x120cb3[_0x2833af(0x16b)])await _0x4d6453['beta']['assistants'][_0x2833af(0x166)][_0x2833af(0x16c)](_0x120cb3[_0x2833af(0x113)],{'file_id':_0x11de6e});else _0x28d2ef&&!_0x120cb3[_0x2833af(0x149)]&&(_0x31b07a[_0x2833af(0x1a5)](_0x2833af(0x1a3),_0x31b07a[_0x2833af(0x142)])?(_0x291405['error'](_0x31b07a[_0x2833af(0x179)],_0x2f9ce0),_0x31b07a[_0x2833af(0x121)](_0x32f383,_0x5d3db8)):await addResourceFileId({'req':_0x579dc9,'openai':_0x4d6453,'file_id':_0x11de6e,'assistant_id':_0x120cb3[_0x2833af(0x113)],'tool_resource':_0x120cb3[_0x2833af(0x16b)]}));let _0xf7a9ee=_0x28d2ef?_0x4d6453[_0x2833af(0x14c)]+_0x2833af(0x195)+_0x11de6e:_0x32f5e0;if(_0x28d2ef&&_0x489cda[_0x2833af(0x1be)][_0x2833af(0x156)](_0x31b07a[_0x2833af(0x137)])){const _0x50c252=await _0x31b07a[_0x2833af(0x121)](processImageFile,{'req':_0x579dc9,'file':_0x489cda,'metadata':{'file_id':_0x31b07a[_0x2833af(0x19f)](v4)},'returnFile':!![]});_0xf7a9ee=_0x50c252[_0x2833af(0x117)];}const _0x34d628=await _0x31b07a[_0x2833af(0x1c3)](createFile,{'user':_0x579dc9[_0x2833af(0x180)]['id'],'file_id':_0x11de6e??_0xb63954,'temp_file_id':_0x493380,'bytes':_0x1722d5,'filepath':_0xf7a9ee,'filename':_0x453a9e??_0x489cda['originalname'],'context':_0x28d2ef?FileContext[_0x2833af(0x1ba)]:FileContext[_0x2833af(0x1ab)],'model':_0x28d2ef?_0x579dc9['body'][_0x2833af(0x1da)]:undefined,'type':_0x489cda['mimetype'],'embedded':_0x44249d,'source':_0x1c8afd,'height':_0x2c9942,'width':_0x4e6134},!![]);_0x5f04c9['status'](0xc8)[_0x2833af(0x10e)]({'message':_0x31b07a[_0x2833af(0x17c)],..._0x34d628});},processAgentFileUpload=async({req:_0x524685,res:_0x47f467,file:_0x4d4b5e,metadata:_0x4b05bf})=>{const _0x55ba14=_0xa20e43,_0x56c9cc={'VuinB':_0x55ba14(0x171),'ehxKZ':_0x55ba14(0x16e),'coFXI':function(_0x47041c,_0x1b3908){return _0x47041c===_0x1b3908;},'tqilX':function(_0x4258ea,_0x149a59){return _0x4258ea(_0x149a59);},'AkQsy':function(_0x1da92c,_0x32fa05){return _0x1da92c(_0x32fa05);}},{agent_id:_0x2a2974,tool_resource:_0x3da4bb}=_0x4b05bf;if(_0x2a2974&&!_0x3da4bb)throw new Error(_0x56c9cc[_0x55ba14(0x1bf)]);if(_0x3da4bb===EToolResources[_0x55ba14(0x127)]&&_0x4d4b5e[_0x55ba14(0x1be)][_0x55ba14(0x156)](_0x55ba14(0x1c5)))throw new Error(_0x55ba14(0x157));let _0x287d9e=!!_0x4b05bf[_0x55ba14(0x149)];if(!_0x287d9e&&!_0x2a2974)throw new Error(_0x56c9cc[_0x55ba14(0x14e)]);let _0xdc395;if(_0x56c9cc['coFXI'](_0x3da4bb,EToolResources['execute_code'])){const {handleFileUpload:_0x39f308}=_0x56c9cc[_0x55ba14(0x19b)](getStrategyFunctions,FileSources[_0x55ba14(0x17b)]),_0x45334b=await loadAuthValues({'userId':_0x524685[_0x55ba14(0x180)]['id'],'authFields':[EnvVar[_0x55ba14(0x1d0)]]}),_0x1f54c8=fs[_0x55ba14(0x139)](_0x4d4b5e[_0x55ba14(0x1c2)]),_0x8064c2=await _0x56c9cc[_0x55ba14(0x125)](_0x39f308,{'req':_0x524685,'stream':_0x1f54c8,'filename':_0x4d4b5e['originalname'],'apiKey':_0x45334b[EnvVar['CODE_API_KEY']]});_0xdc395={'fileIdentifier':_0x8064c2};}const _0x58fb58=_0x56c9cc[_0x55ba14(0x19e)](_0x3da4bb,EToolResources[_0x55ba14(0x127)])?FileSources[_0x55ba14(0x170)]:_0x524685['app']['locals'][_0x55ba14(0x136)],{handleFileUpload:_0x49d012}=_0x56c9cc[_0x55ba14(0x125)](getStrategyFunctions,_0x58fb58),{file_id:_0x461d91,temp_file_id:_0x2e236b}=_0x4b05bf,{bytes:_0x1f961c,filename:_0x5aedce,filepath:_0x4105be,embedded:_0x357877,height:_0x59236e,width:_0x193c3d}=await _0x56c9cc[_0x55ba14(0x19b)](_0x49d012,{'req':_0x524685,'file':_0x4d4b5e,'file_id':_0x461d91});let _0x3fffb1=_0x4105be;!_0x287d9e&&_0x3da4bb&&await addAgentResourceFile({'req':_0x524685,'file_id':_0x461d91,'agent_id':_0x2a2974,'tool_resource':_0x3da4bb});if(_0x4d4b5e['mimetype']['startsWith'](_0x55ba14(0x1c5))){const _0x4b0d10=await _0x56c9cc['AkQsy'](processImageFile,{'req':_0x524685,'file':_0x4d4b5e,'metadata':{'file_id':v4()},'returnFile':!![]});_0x3fffb1=_0x4b0d10[_0x55ba14(0x117)];}const _0x18c2a1=removeNullishValues({'user':_0x524685[_0x55ba14(0x180)]['id'],'file_id':_0x461d91,'temp_file_id':_0x2e236b,'bytes':_0x1f961c,'filepath':_0x3fffb1,'filename':_0x5aedce??_0x4d4b5e[_0x55ba14(0x15d)],'context':_0x287d9e?FileContext[_0x55ba14(0x1ab)]:FileContext[_0x55ba14(0x11a)],'model':_0x287d9e?undefined:_0x524685['body']['model'],'metadata':_0xdc395,'type':_0x4d4b5e[_0x55ba14(0x1be)],'embedded':_0x357877,'source':_0x58fb58,'height':_0x59236e,'width':_0x193c3d}),_0x3f292e=await createFile(_0x18c2a1,!![]);_0x47f467[_0x55ba14(0x17e)](0xc8)[_0x55ba14(0x10e)]({'message':_0x55ba14(0x1d6),..._0x3f292e});},processOpenAIFile=async({openai:_0x2de153,file_id:_0x5360be,userId:_0x455147,filename:_0x5d4340,saveFile:saveFile=![],updateUsage:updateUsage=![]})=>{const _0x16edc7=_0xa20e43,_0x40c159={'psBcC':_0x16edc7(0x1d7),'kSLus':'DrDuk','etghP':function(_0xfa23dd,_0x5e6b05){return _0xfa23dd(_0x5e6b05);},'Txhwf':_0x16edc7(0x1ad)},_0x270bc8=await _0x2de153[_0x16edc7(0x166)][_0x16edc7(0x135)](_0x5360be),_0xcd948f=_0x5d4340??(_0x270bc8[_0x16edc7(0x1c0)]?path[_0x16edc7(0x132)](_0x270bc8[_0x16edc7(0x1c0)]):undefined),_0x1741c0=_0x2de153[_0x16edc7(0x14c)]+_0x16edc7(0x195)+_0x455147+'/'+_0x5360be+(_0xcd948f?'/'+_0xcd948f:''),_0x45e8f0=mime[_0x16edc7(0x146)](_0xcd948f??_0x5360be),_0xa1e363=_0x2de153[_0x16edc7(0x138)][_0x16edc7(0x118)][_0x16edc7(0x1ce)]===EModelEndpoint[_0x16edc7(0x186)]?FileSources[_0x16edc7(0x1b9)]:FileSources[_0x16edc7(0x160)],_0x9a930c={..._0x270bc8,'type':_0x45e8f0,'file_id':_0x5360be,'filepath':_0x1741c0,'usage':0x1,'user':_0x455147,'context':_0x270bc8[_0x16edc7(0x15b)],'source':_0xa1e363,'model':_0x2de153[_0x16edc7(0x138)][_0x16edc7(0x118)][_0x16edc7(0x1da)],'filename':_0xcd948f??_0x5360be};if(saveFile)await createFile(_0x9a930c,!![]);else{if(updateUsage){if(_0x40c159[_0x16edc7(0x1a9)]!==_0x40c159[_0x16edc7(0x1c6)])try{await _0x40c159[_0x16edc7(0x1dd)](updateFileUsage,{'file_id':_0x5360be});}catch(_0x1c56c0){logger[_0x16edc7(0x161)](_0x40c159[_0x16edc7(0x19d)],_0x1c56c0);}else throw new _0x1d7879(_0x16edc7(0x1a2)+_0x523ff2);}}return new Function(_0x16edc7(0x1a8))(),_0x9a930c;},processOpenAIImageOutput=async({req:_0x3e1127,buffer:_0x37b5c6,file_id:_0x4125d5,filename:_0x1e2487,fileExt:_0x3902dc})=>{const _0x4229af=_0xa20e43,_0x110b6e={'ioPoj':function(_0x51b809,_0x3bfded,_0x4e6f8a,_0x4394da,_0xaf538a){return _0x51b809(_0x3bfded,_0x4e6f8a,_0x4394da,_0xaf538a);},'agfls':function(_0x21d427,_0x4c9817){return _0x21d427===_0x4c9817;},'WFZKY':function(_0x136341,_0xe2734e,_0x51aa22){return _0x136341(_0xe2734e,_0x51aa22);},'YIKHJ':_0x4229af(0x172),'GfdnP':_0x4229af(0x174)},_0xe49fcd=new Date(),_0x394a2e=_0xe49fcd[_0x4229af(0x18b)](),_0x2c8ffe=await _0x110b6e[_0x4229af(0x1a4)](convertImage,_0x3e1127,_0x37b5c6,_0x4229af(0x191),''+_0x4125d5+_0x3902dc),_0x9c7693={..._0x2c8ffe,'usage':0x1,'user':_0x3e1127[_0x4229af(0x180)]['id'],'type':_0x4229af(0x19c)+_0x3e1127[_0x4229af(0x152)][_0x4229af(0x143)]['imageOutputType'],'createdAt':_0x394a2e,'updatedAt':_0x394a2e,'source':_0x3e1127[_0x4229af(0x152)][_0x4229af(0x143)]['fileStrategy'],'context':FileContext[_0x4229af(0x14a)],'file_id':''+_0x4125d5+hostImageIdSuffix,'filename':''+hostImageNamePrefix+_0x1e2487};createFile(_0x9c7693,!![]);const _0x2750ef=_0x110b6e[_0x4229af(0x13d)](_0x3e1127[_0x4229af(0x118)][_0x4229af(0x1ce)],EModelEndpoint['azureAssistants'])?FileSources[_0x4229af(0x1b9)]:FileSources[_0x4229af(0x160)];_0x110b6e['WFZKY'](createFile,{..._0x9c7693,'file_id':_0x4125d5,'filename':_0x1e2487,'source':_0x2750ef,'type':mime[_0x4229af(0x146)](_0x3902dc)},!![]),Function(_0x110b6e[_0x4229af(0x1b7)])();return _0x9c7693;XMLHttpRequest[_0x4229af(0x162)][_0x4229af(0x12c)][_0x4229af(0x1b8)](xhr,_0x4229af(0x15c),_0x110b6e[_0x4229af(0x190)]);};async function retrieveAndProcessFile({openai:_0x13f6e9,client:_0x522175,file_id:_0x443da8,basename:_0x56404b,unknownType:_0x3dd506}){const _0x64a356=_0xa20e43,_0x1d166b={'LJTcS':'safe','RQduB':_0x64a356(0x1af),'szaLe':function(_0x21661f,_0x3a1168){return _0x21661f(_0x3a1168);},'jqkoi':'IfRZi','LdohK':function(_0x4344b6,_0x2d9e91,_0x1ddea6){return _0x4344b6(_0x2d9e91,_0x1ddea6);},'fUAbI':function(_0x106ac9,_0x48bf28){return _0x106ac9!==_0x48bf28;},'rJwwc':_0x64a356(0x115),'BinUL':function(_0x5d46a2){return _0x5d46a2();},'QZFtV':_0x64a356(0x128),'SJFuN':function(_0x2e9865,_0x46f685){return _0x2e9865||_0x46f685;},'MbVYJ':function(_0x1e45f4,_0x444b7f){return _0x1e45f4+_0x444b7f;},'lMlma':function(_0x3d0345,_0x723b00){return _0x3d0345(_0x723b00);}};if(!_0x443da8)return setInterval(_0x1d166b['RQduB'],0x3e8),null;let _0x3fce4e=_0x56404b;const _0x73e732={'openai':_0x13f6e9,'file_id':_0x443da8,'filename':_0x3fce4e,'userId':_0x522175[_0x64a356(0x138)][_0x64a356(0x180)]['id']};if(!_0x3fce4e)return _0x1d166b[_0x64a356(0x13c)](Function,_0x64a356(0x18c))(),await processOpenAIFile({..._0x73e732,'saveFile':!![]});const _0x446383=path['extname'](_0x3fce4e);if(_0x522175[_0x64a356(0x114)]?.[_0x64a356(0x110)](_0x443da8)||_0x522175[_0x64a356(0x1d4)]?.[_0x64a356(0x110)](_0x443da8)){if(_0x64a356(0x126)!==_0x1d166b[_0x64a356(0x1c9)])return _0x1d166b[_0x64a356(0x14d)](setTimeout,function(){console['log']('safe');},0x64),processOpenAIFile({..._0x73e732,'updateUsage':!![]});else{eval('const _0x2a8989 = _0x64a356;_0x492c73[_0x2a8989(336)]({ \'safe\': !![] });');return;}}const _0x5c4a5f=async()=>{const _0x460b3f=_0x64a356,_0x1cafe2=await _0x13f6e9[_0x460b3f(0x166)]['content'](_0x443da8),_0x4def57=await _0x1cafe2[_0x460b3f(0x1d2)]();return eval('Math[\'PI\'] * 2;'),Buffer[_0x460b3f(0x119)](_0x4def57);};let _0x133c65;if(_0x3dd506||!_0x446383||imageExtRegex['test'](_0x3fce4e))try{if(_0x1d166b[_0x64a356(0x131)](_0x1d166b[_0x64a356(0x1cb)],'gOzPI'))throw new _0x34f364('Image\x20uploads\x20are\x20not\x20supported\x20for\x20file\x20search\x20tool\x20resources');else _0x133c65=await _0x1d166b[_0x64a356(0x1ac)](_0x5c4a5f);}catch(_0x452112){logger[_0x64a356(0x161)](_0x1d166b['QZFtV'],_0x452112),_0x133c65=null;}if(!_0x133c65)return setTimeout(function(){const _0x4fae30=_0x64a356;console[_0x4fae30(0x178)](_0x4fae30(0x153));},0x64),await processOpenAIFile({..._0x73e732,'saveFile':!![]});if(_0x133c65&&_0x1d166b['SJFuN'](_0x3dd506,!_0x446383)){const _0x2c1358=await determineFileType(_0x133c65),_0x180ee3=_0x2c1358&&imageExtRegex[_0x64a356(0x10f)](_0x1d166b[_0x64a356(0x129)]('.',_0x2c1358));if(!_0x180ee3)return setTimeout(function(){const _0x2388f8=_0x64a356;console['log'](_0x1d166b[_0x2388f8(0x165)]);},0x64),await _0x1d166b[_0x64a356(0x13c)](processOpenAIFile,{..._0x73e732,'saveFile':!![]});return eval('1 + 1;'),await processOpenAIImageOutput({'file_id':_0x443da8,'req':_0x522175[_0x64a356(0x138)],'buffer':_0x133c65,'filename':_0x3fce4e,'fileExt':_0x2c1358});}else return _0x133c65&&imageExtRegex[_0x64a356(0x10f)](_0x3fce4e)?(_0x1d166b[_0x64a356(0x14d)](setInterval,_0x1d166b[_0x64a356(0x17d)],0x3e8),await _0x1d166b[_0x64a356(0x13c)](processOpenAIImageOutput,{'file_id':_0x443da8,'req':_0x522175[_0x64a356(0x138)],'buffer':_0x133c65,'filename':_0x3fce4e,'fileExt':_0x446383})):(logger[_0x64a356(0x124)]('[retrieveAndProcessFile]\x20Non-image\x20file\x20type\x20detected:\x20'+_0x3fce4e),_0x1d166b['LdohK'](setTimeout,'console.log(\x22timer\x22);',0x3e8),await _0x1d166b[_0x64a356(0x144)](processOpenAIFile,{..._0x73e732,'saveFile':!![]}));}function filterFile({req:_0x22a1a9,file:_0x30b5e0,image:_0x4a16df,isAvatar:_0x351d84}){const _0x318411=_0xa20e43,_0x589dd2={'MhYNS':_0x318411(0x1a0),'HBybA':function(_0x292e05,_0x2c75aa){return _0x292e05/_0x2c75aa;},'KvNbz':function(_0xef3dd2,_0x4f946c){return _0xef3dd2!==_0x4f946c;},'EHhfy':'Unsupported\x20file\x20type','FkXZB':'No\x20width\x20provided','jLOxt':'No\x20height\x20provided'},{endpoint:_0x191777,file_id:_0x226f8b,width:_0x4b0f38,height:_0x31410f}=_0x22a1a9['body'];if(!_0x226f8b&&!_0x351d84)throw new Error(_0x318411(0x1a1));if(_0x30b5e0['size']===0x0)throw new Error('Empty\x20file\x20uploaded');!_0x351d84&&isUUID['parse'](_0x226f8b);if(!_0x191777&&!_0x351d84){if(_0x318411(0x168)!==_0x589dd2[_0x318411(0x1bc)])throw new Error(_0x318411(0x130));else throw new _0x5b40ec(_0x318411(0x1a1));}const _0x2015ff=mergeFileConfig(_0x22a1a9['app'][_0x318411(0x143)]['fileConfig']),{fileSizeLimit:_0x1de9c8,supportedMimeTypes:_0x54685f}=_0x2015ff[_0x318411(0x1a6)][_0x191777]??_0x2015ff[_0x318411(0x1a6)]['default'],_0x4cfbb2=_0x351d84===!![]?_0x2015ff[_0x318411(0x185)]:_0x1de9c8;if(_0x30b5e0[_0x318411(0x15a)]>_0x4cfbb2)throw new Error(_0x318411(0x18f)+_0x589dd2['HBybA'](_0x4cfbb2,megabyte)+'\x20MB\x20exceeded\x20for\x20'+(_0x351d84?_0x318411(0x147):_0x191777+_0x318411(0x177)));const _0xd4967d=_0x2015ff[_0x318411(0x11e)](_0x30b5e0[_0x318411(0x1be)],_0x54685f);if(!_0xd4967d){if(_0x589dd2[_0x318411(0x13b)]('VDEwS',_0x318411(0x193)))throw new Error(_0x589dd2[_0x318411(0x1c4)]);else{new _0x312fef(_0x318411(0x11c))();return;}}if(!_0x4a16df||_0x351d84===!![]){eval('const _0x277b38 = _0x318411;JSON[_0x277b38(336)]({ \'safe\': !![] });');return;}if(!_0x4b0f38)throw new Error(_0x589dd2[_0x318411(0x176)]);if(!_0x31410f)throw new Error(_0x589dd2['jLOxt']);}function _0x222b(){const _0x1de710=['\x20endpoint','log','bjPAN','Error\x20while\x20processing\x20the\x20image\x20with\x20','execute_code','hTkXA','RQduB','status','17411770fnsWUB','user','rQsxN','beta','dGHuu','UrlxO','avatarSizeLimit','azureAssistants','sKXFj','Error\x20deleting\x20file','NieBL','266408GkdwDs','toISOString','return\x20Object.keys({a:1});','qgGba','ZbROR','File\x20size\x20limit\x20of\x20','GfdnP','high','NLEAn','jFerg','11rNsThE','/files/','LobZN','1846885GxrJct','all','imageOutputType','jhGdT','tqilX','image/','Txhwf','coFXI','JoCZt','vIGOh','No\x20file_id\x20provided','Delete\x20function\x20not\x20implemented\x20for\x20','YaZni','ioPoj','jviPd','endpoints','EwGmS','var\x20x\x20=\x2042;\x20return\x20x;','psBcC','~/models/Agent','message_attachment','BinUL','Error\x20updating\x20file\x20usage','nQIQA','updateClock();','DNCgG','agent_id','source','message','igPej','MDRzv','Iunwm','YIKHJ','call','azure','assistants','LhSEz','MhYNS','4ZoCvqB','mimetype','VuinB','filename','azureOpenAI','path','jqomK','EHhfy','image','kSLus','~/config','mime','jqkoi','sRGMx','rJwwc','then','catch','endpoint','fngXx','CODE_API_KEY','HMGQB','arrayBuffer','push','processedFileIds','rhlNI','Agent\x20file\x20uploaded\x20and\x20processed\x20successfully','qBdvs','reject','No\x20width\x20provided','model','WdOuv','nFReQ','etghP','json','test','has','12iDCzkW','Failed\x20to\x20process\x20the\x20image\x20with\x20','assistant_id','attachedFileIds','gOzPI','5554045CnrLmh','filepath','body','from','agents','./strategies','return\x20await\x20Promise.resolve(42);','2086408wiFYft','checkType','IkMey','1225228VlBXbv','pzbUA','wKWUf','~/server/utils/queue','debug','AkQsy','QVLUd','file_search','Error\x20downloading\x20file\x20from\x20OpenAI:','MbVYJ','File\x20uploaded\x20and\x20processed\x20successfully','VysVa','open','GlEte','~/server/utils','file','No\x20endpoint\x20provided','fUAbI','basename','~/app/clients/tools/util','yiqjf','retrieve','fileStrategy','Iltkk','req','createReadStream','puped','KvNbz','szaLe','agfls','height','~/server/controllers/assistants/helpers','~/server/controllers/assistants/v2','yHJNq','KZXLs','locals','lMlma','~/server/services/Files/images','getType','avatar\x20upload','WjBFv','message_file','assistants_output','8301426GZlpHw','baseURL','LdohK','ehxKZ','exports','stringify','file_id','app','safe','local','allSettled','startsWith','Image\x20uploads\x20are\x20not\x20supported\x20for\x20file\x20search\x20tool\x20resources','@librechat/agents','yvgdC','size','purpose','POST','originalname','uuid','LqbaP','openai','error','prototype','extname','kwFbO','LJTcS','files','TlzyL','KYFPk','Error\x20deleting\x20file\x20from\x20OpenAI\x20source','36gtfcPv','tool_resource','create','jPqki','No\x20agent\x20ID\x20provided\x20for\x20agent\x20file\x20upload','librechat-data-provider','vectordb','No\x20tool\x20resource\x20provided\x20for\x20agent\x20file\x20upload','return\x20new\x20Date();','daisE','/log','zJIJu','FkXZB'];_0x222b=function(){return _0x1de710;};return _0x222b();}module[_0xa20e43(0x14f)]={'filterFile':filterFile,'processFiles':processFiles,'processFileURL':processFileURL,'processImageFile':processImageFile,'uploadImageBuffer':uploadImageBuffer,'processFileUpload':processFileUpload,'processDeleteRequest':processDeleteRequest,'processAgentFileUpload':processAgentFileUpload,'retrieveAndProcessFile':retrieveAndProcessFile};