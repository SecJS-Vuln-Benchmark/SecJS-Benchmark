function _0x3a6e(){const _0x471353=['constructor','ksqzl','Jzcqj','[BaseClient]\x20Skipping\x20','addPreviousAttachments','contextStrategy','sender','user','files','azEmm','librechat-data-provider','endpointType','slice','directEndpoint','getSaveOptions','vGDdC','handleContextStrategy','processTextStream','oDpnA','):\x20','YToNq','cwkZi','olxwP','CtDUN','responsePromise','[BaseClient]\x20Loading\x20history:','stringify','abortController','JIfyL','messageId','~/server/utils','hhrhU',')\x20and\x20context\x20(','tokenCount','gquNJ','CHECK_BALANCE','vpfoN','summary','loadHistory','~/models','modelOptions','1794424ZCHKhN','XwRYx','gQlgx','env','updateUserMessageTokenCount','iHdqO','progressCallback','knFgk','endpoint','calculateCurrentTokenCount','gMkZR','11800068TRcmET','IhhuT','overrideParentMessageId','18689uEvddl','xtEkX','resendFiles','concatenateMessages','GylKR','responseMessageId','randomUUID','model','onStart','keys','[BaseClient]','[BaseClient]\x20userMessage','\x20/\x20','numeric','saveMessageToDatabase','has','replaceOptions','rbfej','skipSaveConvo','IesDg','Qvbvo','[BaseClient]\x20Previous\x20summary:','set','wxvPv','zhonn','~/cache','skipSaveUserMessage','bPxLJ','kqNkV','UVXUr','buildMessages','gpt-3.5-turbo-0301','sendCompletion','system','getMessageMapMethod','TpMfl','sendMessage','artifactPromises','pop','summaryMessage','addImageURLs','COMMON_DIVIDER','return\x20new\x20Date();','HgNdg','CFmPq','[BaseClient]\x20Context\x20Count\x20(1/2)','jCEmO','DTaii','jPqJi','fetch','RrXCa','getStreamUsage','getTokenCount','agent','2179701DKTFZq','14rEyOUk','GReYr','114DTzrrb','Subclasses\x20must\x20implement\x20getBuildMessagesOptions','yzRiG','PsinM','content','progressOptions','console.log(\x22timer\x22);','maxContextTokens','options','HtGIk','NO_PARENT','User','number','message_file_map','RVKOV','./TextStream','cpJrQ','10uKoLyw','getReqData','return\x20await\x20Promise.resolve(42);','all','430tVAQMl','type','iXTva','lQPgh','getMessagesForConversation','parentMessageId','getCompletion','ludBV','271GsFqFj','jxxSV','debug','POZlI','Tevrh','long','endpointTokenConfig','MdUxj','return\x20Object.keys({a:1});','text','GmGkF','checkVisionRequest','handleStartMethods','KGkyX','push','iNjCm','userMessagePromise','pPslP','iconURL','~/config','updateMessageInDatabase','Subclasses\x20must\x20implement\x20getSaveOptions','gvWNZ','isArray','add','string','EuLpy','completion_tokens','bRFLG','xGaRn','promptPrefix','cLSvj','conversationId','PfEan','currentMessages','recordTokenUsage','summarizeMessages','PCbIl','INPUT_LENGTH','call','onProgress','yDsNF','MiFDe','res','ykIxS','shouldSummarize','Method\x20\x27setOptions\x27\x20must\x20be\x20implemented.','HrSPI','setMessageOptions','reduce','vdoMH','pZAuZ','name','image_url','join','var\x20x\x20=\x2042;\x20return\x20x;','agzjk','Method\x20\x27getCompletion\x27\x20must\x20be\x20implemented.','OcBTA','getMessagesWithinTokenLimit','attachments','fyPhR','wdDyD','getBuildMessagesOptions',':\x20already\x20had\x20a\x20token\x20count.','undefined','MaPCE','zfFEe','inputTokensKey','function','EHTTe','outputTokensKey','uQrsB','createUserMessage','WIEGg','getTokenCountForResponse','XeUua','xdzSK','KRTll','summaryTokenCount','11|0|14|12|13|4|9|1|5|6|2|10|3|7|8','Mpcdc','toLocaleDateString','crypto','addInstructions','log','IVTQC','currentDateString','reverse','DHmUB','toString','KcUFJ','ohQEp','XyYvq','922wZIbRj','edgZw','sihsO','45128ETPVGx','length','SeHqx','dpkpA','frLSR','cOdfj','req','previous_summary','DaUDc','~/models/checkBalance','djigM','node-fetch','api/app/clients/BaseClient.js\x20-\x20saveMessageToDatabase\x20#saveConvo','sAfSR','OjVgF','RCEyj','\x22\x20}','Subclasses\x20must\x20implement\x20buildMessages','split','VJlHo','prompt','unshift','metadata','311982DDeRqo','setOptions','jrkpt','bind','exports','ZxhXE','cJeLA','object','map','Method\x20\x27sendCompletion\x27\x20must\x20be\x20implemented.','FIVE_MINUTES','role','FpYFQ','CeZSK','`[BaseClient]\x20recordTokenUsage`\x20not\x20implemented.','byEfN','reverseProxyUrl','isEdited','fOida','gbnDX'];_0x3a6e=function(){return _0x471353;};return _0x3a6e();}const _0x4ad8d9=_0x2c42;function _0x2c42(_0x284ce6,_0xdd69e5){const _0x3a6e2d=_0x3a6e();return _0x2c42=function(_0x2c4275,_0x3032f4){_0x2c4275=_0x2c4275-0x177;let _0x34abf1=_0x3a6e2d[_0x2c4275];return _0x34abf1;},_0x2c42(_0x284ce6,_0xdd69e5);}(function(_0x37930d,_0x4bea39){const _0x678579=_0x2c42,_0x44e8fb=_0x37930d();while(!![]){try{const _0x3b6c52=parseInt(_0x678579(0x281))/0x1*(-parseInt(_0x678579(0x1c6))/0x2)+parseInt(_0x678579(0x264))/0x3*(-parseInt(_0x678579(0x1c9))/0x4)+-parseInt(_0x678579(0x275))/0x5*(-parseInt(_0x678579(0x1e0))/0x6)+parseInt(_0x678579(0x262))/0x7*(-parseInt(_0x678579(0x21d))/0x8)+parseInt(_0x678579(0x261))/0x9+-parseInt(_0x678579(0x279))/0xa*(parseInt(_0x678579(0x22b))/0xb)+parseInt(_0x678579(0x228))/0xc;if(_0x3b6c52===_0x4bea39)break;else _0x44e8fb['push'](_0x44e8fb['shift']());}catch(_0x5c502f){_0x44e8fb['push'](_0x44e8fb['shift']());}}}(_0x3a6e,0x3e104));const crypto=require(_0x4ad8d9(0x1bb)),fetch=require(_0x4ad8d9(0x1d4)),{supportsBalanceCheck,isAgentsEndpoint,isParamEndpoint,ErrorTypes,Constants,CacheKeys,Time}=require(_0x4ad8d9(0x1fe)),{getMessages,saveMessage,updateMessage,saveConvo}=require(_0x4ad8d9(0x21b)),{addSpaceIfNeeded,isEnabled}=require(_0x4ad8d9(0x212)),checkBalance=require(_0x4ad8d9(0x1d2)),{getFiles}=require('~/models/File'),{getLogStores}=require(_0x4ad8d9(0x244)),TextStream=require(_0x4ad8d9(0x273)),{logger}=require(_0x4ad8d9(0x17b));class BaseClient{constructor(_0x1a1a8f,_0x515981={}){const _0x34f0d4=_0x4ad8d9,_0x5b6954={'PCbIl':_0x34f0d4(0x183),'JIfyL':_0x34f0d4(0x286),'IesDg':_0x34f0d4(0x238)},_0x57fe1f=_0x34f0d4(0x1b8)[_0x34f0d4(0x1db)]('|');let _0x4a22e=0x0;while(!![]){switch(_0x57fe1f[_0x4a22e++]){case'0':this['sender']=_0x515981[_0x34f0d4(0x1fa)]??'AI';continue;case'1':this[_0x34f0d4(0x178)];continue;case'2':this[_0x34f0d4(0x188)];continue;case'3':this[_0x34f0d4(0x1a4)];continue;case'4':this[_0x34f0d4(0x23d)]=![];continue;case'5':this[_0x34f0d4(0x20c)];continue;case'6':this[_0x34f0d4(0x1fb)];continue;case'7':this[_0x34f0d4(0x1ac)]='prompt_tokens';continue;case'8':this[_0x34f0d4(0x1af)]=_0x5b6954[_0x34f0d4(0x18d)];continue;case'9':this[_0x34f0d4(0x245)]=![];continue;case'10':this[_0x34f0d4(0x230)];continue;case'11':this['apiKey']=_0x1a1a8f;continue;case'12':this[_0x34f0d4(0x1bf)]=new Date()[_0x34f0d4(0x1ba)]('en-us',{'year':_0x34f0d4(0x238),'month':_0x5b6954[_0x34f0d4(0x210)],'day':_0x5b6954[_0x34f0d4(0x23e)]});continue;case'13':this[_0x34f0d4(0x25c)]=this[_0x34f0d4(0x25c)][_0x34f0d4(0x1e3)](this);continue;case'14':this[_0x34f0d4(0x1f9)]=null;continue;}break;}}['setOptions'](){const _0x255e36=_0x4ad8d9,_0x3aef8f={'vdoMH':_0x255e36(0x196)};throw new Error(_0x3aef8f[_0x255e36(0x19a)]);}async[_0x4ad8d9(0x27f)](){const _0x16d1a6=_0x4ad8d9,_0x43b835={'xdzSK':_0x16d1a6(0x1a1)};throw new Error(_0x43b835[_0x16d1a6(0x1b5)]);}async[_0x4ad8d9(0x24b)](){const _0x23f082=_0x4ad8d9,_0x478770={'NtWho':_0x23f082(0x1e9)};throw new Error(_0x478770['NtWho']);}[_0x4ad8d9(0x202)](){const _0x137105=_0x4ad8d9;throw new Error(_0x137105(0x17d));}async['buildMessages'](){const _0x14cb7a=_0x4ad8d9;throw new Error(_0x14cb7a(0x1da));}async[_0x4ad8d9(0x18c)](){const _0x2e5f33=_0x4ad8d9,_0x154361={'CFmPq':'Subclasses\x20attempted\x20to\x20call\x20summarizeMessages\x20without\x20implementing\x20it'};throw new Error(_0x154361[_0x2e5f33(0x257)]);}['getResponseModel'](){const _0x1e75bc=_0x4ad8d9,_0x4c4d5d={'POZlI':'var\x20x\x20=\x2042;\x20return\x20x;'};if(isAgentsEndpoint(this[_0x1e75bc(0x26c)]['endpoint'])&&this[_0x1e75bc(0x26c)][_0x1e75bc(0x260)]&&this[_0x1e75bc(0x26c)]['agent']['id'])return new Function(_0x4c4d5d[_0x1e75bc(0x284)])(),this[_0x1e75bc(0x26c)]['agent']['id'];return new AsyncFunction(_0x1e75bc(0x277))(),this[_0x1e75bc(0x21c)][_0x1e75bc(0x232)];}[_0x4ad8d9(0x1b3)](_0x2c6de9){const _0x274c6b=_0x4ad8d9;logger['debug'](_0x274c6b(0x1ee),_0x2c6de9);}async['recordTokenUsage']({promptTokens:_0x19d868,completionTokens:_0x17bdc6}){const _0x16241d=_0x4ad8d9;logger[_0x16241d(0x283)]('`[BaseClient]\x20recordTokenUsage`\x20not\x20implemented.',{'promptTokens':_0x19d868,'completionTokens':_0x17bdc6});}async['fetch'](_0x562ff0,_0x1569b8){const _0x2912fb=_0x4ad8d9,_0x1b5ab9={'edgZw':_0x2912fb(0x24e)};let _0x2baab3=_0x562ff0;this[_0x2912fb(0x26c)][_0x2912fb(0x201)]&&(_0x2912fb(0x24e)!==_0x1b5ab9[_0x2912fb(0x1c7)]?_0x3ec911[_0x2912fb(0x20e)]({'safe':!![]}):_0x2baab3=this[_0x2912fb(0x26c)][_0x2912fb(0x1f0)]);logger['debug']('Making\x20request\x20to\x20'+_0x2baab3);if(typeof Bun!==_0x2912fb(0x1a9))return setInterval('updateClock();',0x3e8),await fetch(_0x2baab3,_0x1569b8);return new Function(_0x2912fb(0x19f))(),await fetch(_0x2baab3,_0x1569b8);}[_0x4ad8d9(0x1a7)](){const _0xa6a8f1=_0x4ad8d9;throw new Error(_0xa6a8f1(0x265));}async['generateTextStream'](_0x131bec,_0xe98091,_0xb70a63={}){const _0x2ee838=_0x4ad8d9,_0x3793fc=new TextStream(_0x131bec,_0xb70a63);await _0x3793fc[_0x2ee838(0x205)](_0xe98091);}['processOverideIds'](){const _0x2d50e9=_0x4ad8d9,_0x15d860={'hhrhU':_0x2d50e9(0x255)};let {overrideConvoId:_0x6ea4d8,overrideUserMessageId:_0x38c105}=this[_0x2d50e9(0x26c)]?.[_0x2d50e9(0x1cf)]?.['body']??{};if(_0x6ea4d8){const [_0x4be5ad,_0xad0691]=_0x6ea4d8['split'](Constants[_0x2d50e9(0x254)]);_0x6ea4d8=_0x4be5ad,_0xad0691!=='0'&&(this[_0x2d50e9(0x23d)]=!![]);}if(_0x38c105){const [_0x2225fe,_0x833c76]=_0x38c105['split'](Constants[_0x2d50e9(0x254)]);_0x38c105=_0x2225fe,_0x833c76!=='0'&&(this[_0x2d50e9(0x245)]=!![]);}return Function(_0x15d860[_0x2d50e9(0x213)])(),[_0x6ea4d8,_0x38c105];}async[_0x4ad8d9(0x198)](_0x1ff8a1={}){const _0x52356d=_0x4ad8d9,_0x32dbc9={'MiFDe':function(_0x1d4e7c,_0x46ade6){return _0x1d4e7c!==_0x46ade6;},'frLSR':_0x52356d(0x248),'yzRiG':_0x52356d(0x27c),'cJeLA':function(_0x594085,_0x2ef857){return _0x594085(_0x2ef857);},'iNjCm':_0x52356d(0x255)};_0x1ff8a1&&_0x1ff8a1[_0x52356d(0x23b)]&&(_0x32dbc9[_0x52356d(0x192)](_0x32dbc9[_0x52356d(0x1cd)],_0x32dbc9[_0x52356d(0x266)])?this[_0x52356d(0x1e1)](_0x1ff8a1):this[_0x52356d(0x1e1)](_0x17eb71));const [_0x395548,_0x2a666d]=this['processOverideIds'](),{isEdited:_0x20ab2c,isContinued:_0xd7cbb4}=_0x1ff8a1,_0x1ddc3b=_0x1ff8a1[_0x52356d(0x1fb)]??null;this['user']=_0x1ddc3b;const _0x358b63=this[_0x52356d(0x202)]();this[_0x52356d(0x20f)]=_0x1ff8a1['abortController']??new AbortController();const _0x234daf=_0x395548??_0x1ff8a1[_0x52356d(0x188)]??crypto['randomUUID'](),_0x1bc06d=_0x1ff8a1[_0x52356d(0x27e)]??Constants['NO_PARENT'],_0x245e51=_0x2a666d??_0x1ff8a1[_0x52356d(0x22a)]??crypto[_0x52356d(0x231)]();let _0x17fe36=_0x1ff8a1['responseMessageId']??crypto[_0x52356d(0x231)](),_0x3a249d=_0x20ab2c?_0x17fe36:_0x1bc06d;return this[_0x52356d(0x18a)]=await this[_0x52356d(0x21a)](_0x234daf,_0x3a249d)??[],this['conversationId']=_0x234daf,_0x20ab2c&&!_0xd7cbb4&&(_0x17fe36=crypto['randomUUID'](),_0x3a249d=_0x17fe36,this['currentMessages'][this[_0x52356d(0x18a)]['length']-0x1][_0x52356d(0x211)]=_0x3a249d),this[_0x52356d(0x230)]=_0x17fe36,_0x32dbc9[_0x52356d(0x1e6)](Function,_0x32dbc9[_0x52356d(0x177)])(),{..._0x1ff8a1,'user':_0x1ddc3b,'head':_0x3a249d,'conversationId':_0x234daf,'parentMessageId':_0x1bc06d,'userMessageId':_0x245e51,'responseMessageId':_0x17fe36,'saveOptions':_0x358b63};}[_0x4ad8d9(0x1b1)]({messageId:_0x15812b,parentMessageId:_0x37cb9b,conversationId:_0x3b52a4,text:_0x2bbfd6}){const _0x5eb7ab=_0x4ad8d9;return setTimeout(_0x5eb7ab(0x26a),0x3e8),{'messageId':_0x15812b,'parentMessageId':_0x37cb9b,'conversationId':_0x3b52a4,'sender':_0x5eb7ab(0x26f),'text':_0x2bbfd6,'isCreatedByUser':!![]};}async['handleStartMethods'](_0x3291aa,_0x2594d5){const _0x303e53=_0x4ad8d9,_0x49fadc={'XwRYx':function(_0x4cf228,_0x321687){return _0x4cf228+_0x321687;},'RCEyj':function(_0x2377af,_0x2145cd){return _0x2377af-_0x2145cd;},'ohQEp':function(_0x1e38e8,_0x536dc6){return _0x1e38e8===_0x536dc6;},'sihsO':function(_0x556021,_0x401904){return _0x556021===_0x401904;},'djigM':_0x303e53(0x1ad)},{user:_0x4bc5fa,head:_0x2551a5,conversationId:_0x440d40,parentMessageId:_0x2f170e,userMessageId:_0x5a436d,responseMessageId:_0x481cf4,saveOptions:_0x450a1d}=await this[_0x303e53(0x198)](_0x2594d5),_0x44ec36=_0x2594d5[_0x303e53(0x1f1)]?this['currentMessages'][_0x49fadc[_0x303e53(0x1d8)](this[_0x303e53(0x18a)][_0x303e53(0x1ca)],0x2)]:this[_0x303e53(0x1b1)]({'messageId':_0x5a436d,'parentMessageId':_0x2f170e,'conversationId':_0x440d40,'text':_0x3291aa});return _0x49fadc[_0x303e53(0x1c4)](typeof _0x2594d5?.['getReqData'],'function')&&(_0x303e53(0x23f)!==_0x303e53(0x1ec)?_0x2594d5[_0x303e53(0x276)]({'userMessage':_0x44ec36,'conversationId':_0x440d40,'responseMessageId':_0x481cf4,'sender':this['sender']}):(_0x5a04c9={'messageId':_0x3f3f22,'conversationId':_0x408607,'parentMessageId':_0x1e4a24[_0x303e53(0x211)],'isCreatedByUser':![],'model':this[_0x303e53(0x21c)]['model'],'sender':this[_0x303e53(0x1fa)],'text':_0x18e432},this[_0x303e53(0x18a)][_0x303e53(0x28f)](_0xebfd73,_0x452233))),_0x49fadc[_0x303e53(0x1c8)](typeof _0x2594d5?.[_0x303e53(0x233)],_0x49fadc[_0x303e53(0x1d3)])&&_0x2594d5[_0x303e53(0x233)](_0x44ec36,_0x481cf4),eval('const _0x42e881 = _0x303e53;_0x49fadc[_0x42e881(542)](1, 1);'),{..._0x2594d5,'user':_0x4bc5fa,'head':_0x2551a5,'conversationId':_0x440d40,'responseMessageId':_0x481cf4,'saveOptions':_0x450a1d,'userMessage':_0x44ec36};}[_0x4ad8d9(0x1bc)](_0x3d9fb5,_0x4f1f1e){const _0x47312d=_0x4ad8d9,_0x1cc13f={'AfBnB':'safe','DHmUB':function(_0x3f52ca,_0x580a39){return _0x3f52ca===_0x580a39;},'kqNkV':function(_0x4c53c6,_0x1e168a,_0x2dd7e0){return _0x4c53c6(_0x1e168a,_0x2dd7e0);},'DVijM':function(_0x5a0728,_0x3de20){return _0x5a0728-_0x3de20;},'IVTQC':'updateClock();'},_0x30011b=[];if(!_0x4f1f1e||_0x1cc13f[_0x47312d(0x1c1)](Object[_0x47312d(0x234)](_0x4f1f1e)[_0x47312d(0x1ca)],0x0))return _0x1cc13f[_0x47312d(0x247)](setTimeout,function(){const _0x1ff51e=_0x47312d;console[_0x1ff51e(0x1bd)](_0x1cc13f['AfBnB']);},0x64),_0x3d9fb5;_0x3d9fb5['length']>0x1&&_0x30011b[_0x47312d(0x28f)](..._0x3d9fb5[_0x47312d(0x200)](0x0,-0x1));_0x30011b[_0x47312d(0x28f)](_0x4f1f1e);if(_0x3d9fb5[_0x47312d(0x1ca)]>0x0){if(_0x47312d(0x224)!==_0x47312d(0x224)){const _0x4a374d=_0x34f13f[_0x47312d(0x19c)]??_0x44538c[_0x47312d(0x1eb)];return eval('_0x585456[\'PI\'] * 2;'),_0x41d11d+(_0x4a374d+':\x0a'+_0x6ce54b['content']+'\x0a\x0a');}else _0x30011b[_0x47312d(0x28f)](_0x3d9fb5[_0x1cc13f['DVijM'](_0x3d9fb5[_0x47312d(0x1ca)],0x1)]);}return _0x1cc13f[_0x47312d(0x247)](setInterval,_0x1cc13f[_0x47312d(0x1be)],0x3e8),_0x30011b;}async['handleTokenCountMap'](_0x10d1ef){const _0x9c85b6=_0x4ad8d9,_0x1a7b79={'sAfSR':function(_0x2f1315,_0x413681){return _0x2f1315+_0x413681;},'RVKOV':function(_0x1dec90,_0x44175d){return _0x1dec90===_0x44175d;},'WIEGg':function(_0x48be2c,_0x10ee84){return _0x48be2c-_0x10ee84;},'HrSPI':function(_0x23f6ca,_0xcd494f){return _0x23f6ca===_0xcd494f;},'DaUDc':function(_0x2c0743,_0x59b3fe){return _0x2c0743!==_0x59b3fe;},'NFQMa':_0x9c85b6(0x1b6)};if(_0x1a7b79[_0x9c85b6(0x272)](this[_0x9c85b6(0x18a)][_0x9c85b6(0x1ca)],0x0)){eval('const _0x3a2565 = _0x9c85b6;_0x1a7b79[_0x3a2565(470)](1, 1);');return;}for(let _0x29bed0=0x0;_0x29bed0<this['currentMessages']['length'];_0x29bed0++){if(_0x29bed0===_0x1a7b79[_0x9c85b6(0x1b2)](this[_0x9c85b6(0x18a)][_0x9c85b6(0x1ca)],0x1))break;const _0x45cc93=this['currentMessages'][_0x29bed0],{messageId:_0x4a7615}=_0x45cc93,_0x356ed9={};_0x1a7b79[_0x9c85b6(0x197)](_0x4a7615,_0x10d1ef[_0x9c85b6(0x252)]?.[_0x9c85b6(0x211)])&&(_0x9c85b6(0x1b4)===_0x9c85b6(0x218)?this[_0x9c85b6(0x18a)][_0x9c85b6(0x28f)](_0x2c243a):(logger[_0x9c85b6(0x283)]('[BaseClient]\x20Adding\x20summary\x20props\x20to\x20'+_0x4a7615+'.'),_0x356ed9['summary']=_0x10d1ef[_0x9c85b6(0x252)][_0x9c85b6(0x268)],_0x356ed9[_0x9c85b6(0x1b7)]=_0x10d1ef[_0x9c85b6(0x252)][_0x9c85b6(0x215)]));if(_0x45cc93[_0x9c85b6(0x215)]&&!_0x356ed9[_0x9c85b6(0x1b7)]){logger['debug'](_0x9c85b6(0x1f7)+_0x4a7615+_0x9c85b6(0x1a8));continue;}const _0x2d9882=_0x10d1ef[_0x4a7615];_0x2d9882&&(_0x1a7b79[_0x9c85b6(0x1d1)](_0x9c85b6(0x1b6),_0x1a7b79['NFQMa'])?_0x4d2c46['PI']*0x2:(_0x45cc93[_0x9c85b6(0x215)]=_0x2d9882,_0x356ed9['tokenCount']=_0x2d9882,await this[_0x9c85b6(0x17c)]({'messageId':_0x4a7615,..._0x356ed9})));}}[_0x4ad8d9(0x22e)](_0x3c9469){const _0x5af5f2=_0x4ad8d9,_0x976d6f={'brnfs':function(_0x36b67a,_0x52e71d){return _0x36b67a+_0x52e71d;}};return new Function(_0x5af5f2(0x19f))(),_0x3c9469[_0x5af5f2(0x199)]((_0xd7a09b,_0x217075)=>{const _0x8106a2=_0x5af5f2,_0x5e6e21=_0x217075[_0x8106a2(0x19c)]??_0x217075[_0x8106a2(0x1eb)];return eval('Math[\'PI\'] * 2;'),_0x976d6f['brnfs'](_0xd7a09b,_0x5e6e21+':\x0a'+_0x217075[_0x8106a2(0x268)]+'\x0a\x0a');},'');}async[_0x4ad8d9(0x1a3)](_0x3b80de,_0x51ba32){const _0x2b548b=_0x4ad8d9,_0x1218da={'dpkpA':function(_0xf2eb3f,_0x161986){return _0xf2eb3f<_0x161986;},'OjVgF':function(_0x5e788e,_0x5c64e6){return _0x5e788e-_0x5c64e6;}};let _0x8dd220=0x3,_0x4d14bb=-0x1,_0xdad9eb=_0x51ba32??this['maxContextTokens'];const _0x173a21=[..._0x3b80de],_0x57fa99=[];if(_0x8dd220<_0xdad9eb)while(_0x173a21[_0x2b548b(0x1ca)]>0x0&&_0x1218da[_0x2b548b(0x1cc)](_0x8dd220,_0xdad9eb)){const _0x4873c1=_0x173a21[_0x2b548b(0x251)](),{tokenCount:_0x44c1d5}=_0x4873c1;if(_0x4873c1&&_0x8dd220+_0x44c1d5<=_0xdad9eb)_0x57fa99[_0x2b548b(0x28f)](_0x4873c1),_0x8dd220+=_0x44c1d5;else{_0x173a21[_0x2b548b(0x28f)](_0x4873c1);break;}}const _0x33a4eb=_0x173a21;return _0x4d14bb=_0x1218da[_0x2b548b(0x1d7)](_0x33a4eb['length'],0x1),_0xdad9eb-=_0x8dd220,eval('JSON[\'stringify\']({ \'safe\': !![] });'),{'context':_0x57fa99[_0x2b548b(0x1c0)](),'remainingContextTokens':_0xdad9eb,'messagesToRefine':_0x33a4eb,'summaryIndex':_0x4d14bb};}async[_0x4ad8d9(0x204)]({instructions:_0x4c1bfd,orderedMessages:_0x3ec2bf,formattedMessages:_0x44f147,buildTokenMap:buildTokenMap=!![]}){const _0x218485=_0x4ad8d9,_0x34237b={'DSjrZ':function(_0x5746ae,_0x1745f0){return _0x5746ae*_0x1745f0;},'oDpnA':function(_0x1d6f5e,_0x2372a5){return _0x1d6f5e-_0x2372a5;},'IhhuT':function(_0x27f8ad,_0x181291){return _0x27f8ad+_0x181291;},'iHdqO':function(_0x3a31ec,_0x2cabab){return _0x3a31ec===_0x2cabab;},'iXTva':_0x218485(0x274),'zfFEe':_0x218485(0x267),'BNVCS':function(_0x5dca58,_0x24a2dc){return _0x5dca58+_0x24a2dc;},'SZasZ':function(_0x124927,_0x2f408b){return _0x124927-_0x2f408b;},'ksqzl':function(_0x45ae12,_0x5e9345){return _0x45ae12>_0x5e9345;},'bRFLG':function(_0x2285f0,_0x12689e){return _0x2285f0&&_0x12689e;},'JXWen':'[BaseClient]\x20Context\x20Count\x20(2/2)','cLSvj':'ulNLY','vGDdC':'ktyaq','gbnDX':_0x218485(0x235)};let _0x114fa7,_0x157953;_0x4c1bfd&&({tokenCount:_0x157953,..._0x114fa7}=_0x4c1bfd);_0x114fa7&&logger[_0x218485(0x283)](_0x34237b['BNVCS']('[BaseClient]\x20instructions\x20tokenCount:\x20',_0x157953));let _0x4df777=this[_0x218485(0x1bc)](_0x44f147,_0x114fa7),_0x1dfd53=this[_0x218485(0x1bc)](_0x3ec2bf,_0x4c1bfd),{context:_0x176b59,remainingContextTokens:_0x13d281,messagesToRefine:_0x46612d,summaryIndex:_0x2f0209}=await this[_0x218485(0x1a3)](_0x1dfd53);logger[_0x218485(0x283)](_0x218485(0x258),{'remainingContextTokens':_0x13d281,'maxContextTokens':this[_0x218485(0x26b)]});let _0x4ce456,_0x54e692,{shouldSummarize:_0x35dddf}=this;const {length:_0x11e3d7}=_0x4df777,_0x167b8c=_0x34237b['SZasZ'](_0x11e3d7,_0x176b59[_0x218485(0x1ca)]),_0x1d7690=_0x1dfd53[0x0],_0x1eb134=_0x35dddf&&_0x34237b['iHdqO'](_0x167b8c,0x1)&&_0x1d7690?.[_0x218485(0x219)]&&this[_0x218485(0x1d0)][_0x218485(0x211)]===_0x1d7690[_0x218485(0x211)];_0x34237b[_0x218485(0x1f5)](_0x167b8c,0x0)&&(_0x218485(0x1ed)===_0x218485(0x1ed)?(_0x4df777=_0x4df777[_0x218485(0x200)](_0x167b8c),logger['debug']('[BaseClient]\x20Difference\x20between\x20original\x20payload\x20('+_0x11e3d7+_0x218485(0x214)+_0x176b59[_0x218485(0x1ca)]+_0x218485(0x207)+_0x167b8c)):_0x74a415['onStart'](_0x1f8b63,_0x5c3603));const _0x39061e=_0x1dfd53[_0x34237b[_0x218485(0x206)](_0x1dfd53['length'],0x1)];if(_0x34237b[_0x218485(0x222)](_0x4df777[_0x218485(0x1ca)],0x0)&&!_0x35dddf&&_0x39061e){const _0x946681=_0x39061e['tokenCount']+_0x218485(0x237)+this[_0x218485(0x26b)],_0x4e591d='{\x20\x22type\x22:\x20\x22'+ErrorTypes[_0x218485(0x18e)]+'\x22,\x20\x22info\x22:\x20\x22'+_0x946681+_0x218485(0x1d9);logger['warn']('Prompt\x20token\x20count\x20exceeds\x20max\x20token\x20count\x20('+_0x946681+').');throw new Error(_0x4e591d);}if(_0x1eb134)_0x218485(0x280)!==_0x218485(0x280)?(_0x36cddc={'role':_0x218485(0x24c),'content':_0x385ffa[_0x218485(0x219)]},_0x18ccdd=_0xb50356['summaryTokenCount'],_0x92e26a[_0x218485(0x1de)](_0x4b0197),_0x3a7c97-=_0x22939e):(_0x4ce456={'role':_0x218485(0x24c),'content':_0x1d7690[_0x218485(0x219)]},_0x54e692=_0x1d7690[_0x218485(0x1b7)],_0x4df777[_0x218485(0x1de)](_0x4ce456),_0x13d281-=_0x54e692);else _0x35dddf&&_0x34237b['ksqzl'](_0x46612d[_0x218485(0x1ca)],0x0)&&({summaryMessage:_0x4ce456,summaryTokenCount:_0x54e692}=await this[_0x218485(0x18c)]({'messagesToRefine':_0x46612d,'remainingContextTokens':_0x13d281}),_0x4ce456&&_0x4df777[_0x218485(0x1de)](_0x4ce456),_0x13d281-=_0x54e692);_0x35dddf=_0x34237b[_0x218485(0x184)](_0x4ce456,_0x35dddf),logger[_0x218485(0x283)](_0x34237b['JXWen'],{'remainingContextTokens':_0x13d281,'maxContextTokens':this[_0x218485(0x26b)]});let _0x533ddf;buildTokenMap&&(_0x34237b[_0x218485(0x222)](_0x34237b[_0x218485(0x187)],_0x34237b[_0x218485(0x203)])?_0x5836a1[_0x218485(0x190)]=_0x614b7e[_0x218485(0x223)]['call'](null,{..._0x21241e[_0x218485(0x269)]??{},'parentMessageId':_0x5805f9[_0x218485(0x211)],'messageId':_0x7532fd}):_0x533ddf=_0x1dfd53[_0x218485(0x199)]((_0x22b6bb,_0x1fed9e,_0x4f6a1d)=>{const _0x282f79=_0x218485,_0x25ff34={'SLVof':function(_0x50722e,_0x5a8c61){const _0x42b2a7=_0x2c42;return _0x34237b[_0x42b2a7(0x206)](_0x50722e,_0x5a8c61);},'OcBTA':function(_0x122276,_0xe96d56){const _0x2bef4a=_0x2c42;return _0x34237b[_0x2bef4a(0x229)](_0x122276,_0xe96d56);}};if(_0x34237b['iHdqO'](_0x282f79(0x185),_0x34237b[_0x282f79(0x27b)]))_0x4d880b=0x4,_0x3d0f6c=-0x1;else{const {messageId:_0x43c844}=_0x1fed9e;if(!_0x43c844){if(_0x34237b[_0x282f79(0x222)](_0x34237b[_0x282f79(0x1ab)],'nmDjX')){let _0x43ed11=this['currentMessages'][_0x25ff34['SLVof'](this[_0x282f79(0x18a)]['length'],0x1)];!_0x43ed11?(_0x43ed11={'messageId':_0xcfdf41,'conversationId':_0x38ce79,'parentMessageId':_0x38e4a1['messageId'],'isCreatedByUser':![],'model':this['modelOptions'][_0x282f79(0x232)],'sender':this[_0x282f79(0x1fa)],'text':_0x2f357c},this[_0x282f79(0x18a)]['push'](_0x45ff42,_0x43ed11)):_0x43ed11[_0x282f79(0x28a)]=_0x14ad17;}else return eval('_0x34237b[\'DSjrZ\'](Math[\'PI\'], 2);'),_0x22b6bb;}return _0x35dddf&&_0x4f6a1d===_0x2f0209&&!_0x1eb134&&(_0x22b6bb[_0x282f79(0x252)]={..._0x4ce456,'messageId':_0x43c844,'tokenCount':_0x54e692}),_0x22b6bb[_0x43c844]=_0x1dfd53[_0x4f6a1d][_0x282f79(0x215)],eval('const _0x7b0db1 = _0x282f79;_0x25ff34[_0x7b0db1(418)](1, 1);'),_0x22b6bb;}},{}));const _0x489656=this[_0x218485(0x26b)]-_0x13d281;return logger[_0x218485(0x283)]('[BaseClient]\x20tokenCountMap:',_0x533ddf),logger['debug'](_0x34237b[_0x218485(0x1f3)],{'promptTokens':_0x489656,'remainingContextTokens':_0x13d281,'payloadSize':_0x4df777[_0x218485(0x1ca)],'maxContextTokens':this[_0x218485(0x26b)]}),Function(_0x218485(0x255))(),{'payload':_0x4df777,'tokenCountMap':_0x533ddf,'promptTokens':_0x489656,'messages':_0x1dfd53};}async[_0x4ad8d9(0x24f)](_0x4754a4,_0x48faab={}){const _0x4298c0=_0x4ad8d9,_0x20353c={'EHTTe':_0x4298c0(0x19f),'jxxSV':function(_0x52f5e6,_0x2a002c){return _0x52f5e6===_0x2a002c;},'uQrsB':_0x4298c0(0x208),'HgNdg':_0x4298c0(0x1c5),'sPGTZ':function(_0x3cae13,_0x45445f){return _0x3cae13!==_0x45445f;},'FAnek':'function','GmGkF':_0x4298c0(0x22c),'GReYr':function(_0x35999f,_0x2397c3){return _0x35999f(_0x2397c3);},'GylKR':function(_0x1eb90a,_0x402da6){return _0x1eb90a(_0x402da6);},'fyPhR':function(_0x596d8b,_0x481547){return _0x596d8b===_0x481547;},'XDDNi':_0x4298c0(0x181),'SeHqx':function(_0x33eaaa,_0x31dbc6){return _0x33eaaa+_0x31dbc6;},'HtGIk':function(_0x234df3,_0xa412dc){return _0x234df3(_0xa412dc);},'Mpcdc':function(_0x49df1f,_0x28f88e,_0x791a85){return _0x49df1f(_0x28f88e,_0x791a85);},'cOdfj':function(_0x34d8c4,_0x3d209b){return _0x34d8c4>_0x3d209b;}},{user:_0x351d3d,head:_0x5dfff5,isEdited:_0x39aadb,conversationId:_0x4f9e28,responseMessageId:_0x804a78,saveOptions:_0x4bdb14,userMessage:_0x38a2bd}=await this[_0x4298c0(0x28d)](_0x4754a4,_0x48faab);_0x48faab[_0x4298c0(0x223)]&&(_0x48faab[_0x4298c0(0x190)]=_0x48faab[_0x4298c0(0x223)][_0x4298c0(0x18f)](null,{..._0x48faab[_0x4298c0(0x269)]??{},'parentMessageId':_0x38a2bd[_0x4298c0(0x211)],'messageId':_0x804a78}));const {generation:generation=''}=_0x48faab;if(_0x39aadb){let _0x577510=this[_0x4298c0(0x18a)][this['currentMessages']['length']-0x1];!_0x577510?(_0x577510={'messageId':_0x804a78,'conversationId':_0x4f9e28,'parentMessageId':_0x38a2bd[_0x4298c0(0x211)],'isCreatedByUser':![],'model':this[_0x4298c0(0x21c)][_0x4298c0(0x232)],'sender':this[_0x4298c0(0x1fa)],'text':generation},this[_0x4298c0(0x18a)][_0x4298c0(0x28f)](_0x38a2bd,_0x577510)):_0x577510[_0x4298c0(0x28a)]=generation;}else this[_0x4298c0(0x18a)][_0x4298c0(0x28f)](_0x38a2bd);let {prompt:_0x549952,tokenCountMap:_0x11b58c,promptTokens:_0x51aaab}=await this[_0x4298c0(0x249)](this['currentMessages'],_0x39aadb?_0x5dfff5:_0x38a2bd[_0x4298c0(0x211)],this[_0x4298c0(0x1a7)](_0x48faab),_0x48faab);if(_0x11b58c){if(_0x20353c[_0x4298c0(0x282)](_0x20353c[_0x4298c0(0x1b0)],_0x20353c[_0x4298c0(0x256)]))throw new _0xebbe35(_0x4298c0(0x265));else logger['debug']('[BaseClient]\x20tokenCountMap',_0x11b58c),_0x11b58c[_0x38a2bd[_0x4298c0(0x211)]]&&(_0x20353c['sPGTZ'](_0x4298c0(0x20b),'CtDUN')?_0x2006f3['PI']*0x2:(_0x38a2bd['tokenCount']=_0x11b58c[_0x38a2bd[_0x4298c0(0x211)]],logger[_0x4298c0(0x283)](_0x4298c0(0x236),_0x38a2bd))),this['handleTokenCountMap'](_0x11b58c);}if(!_0x39aadb&&!this[_0x4298c0(0x245)]){this[_0x4298c0(0x178)]=this[_0x4298c0(0x239)](_0x38a2bd,_0x4bdb14,_0x351d3d);if(_0x20353c[_0x4298c0(0x282)](typeof _0x48faab?.['getReqData'],_0x20353c['FAnek'])){if(_0x4298c0(0x209)!==_0x20353c[_0x4298c0(0x28b)])_0x48faab['getReqData']({'userMessagePromise':this['userMessagePromise']});else return new _0x42814d(_0x20353c[_0x4298c0(0x1ae)])(),this[_0x4298c0(0x26c)][_0x4298c0(0x260)]['id'];}}_0x20353c[_0x4298c0(0x263)](isEnabled,process[_0x4298c0(0x220)][_0x4298c0(0x217)])&&supportsBalanceCheck[this[_0x4298c0(0x26c)]['endpointType']??this[_0x4298c0(0x26c)][_0x4298c0(0x225)]]&&await _0x20353c[_0x4298c0(0x22f)](checkBalance,{'req':this[_0x4298c0(0x26c)][_0x4298c0(0x1cf)],'res':this[_0x4298c0(0x26c)][_0x4298c0(0x193)],'txData':{'user':this[_0x4298c0(0x1fb)],'tokenType':_0x4298c0(0x1dd),'amount':_0x51aaab,'model':this[_0x4298c0(0x21c)][_0x4298c0(0x232)],'endpoint':this[_0x4298c0(0x26c)][_0x4298c0(0x225)],'endpointTokenConfig':this['options'][_0x4298c0(0x287)]}});const _0x10a743=await this[_0x4298c0(0x24b)](_0x549952,_0x48faab);this[_0x4298c0(0x20f)]['requestCompleted']=!![];const _0x3f9f64={'messageId':_0x804a78,'conversationId':_0x4f9e28,'parentMessageId':_0x38a2bd[_0x4298c0(0x211)],'isCreatedByUser':![],'isEdited':_0x39aadb,'model':this['getResponseModel'](),'sender':this['sender'],'promptTokens':_0x51aaab,'iconURL':this[_0x4298c0(0x26c)][_0x4298c0(0x17a)],'endpoint':this['options']['endpoint'],...this[_0x4298c0(0x1df)]??{}};if(_0x20353c[_0x4298c0(0x1a5)](typeof _0x10a743,_0x20353c['XDDNi']))_0x3f9f64['text']=_0x20353c[_0x4298c0(0x1cb)](_0x20353c[_0x4298c0(0x26d)](addSpaceIfNeeded,generation),_0x10a743);else{if(Array[_0x4298c0(0x17f)](_0x10a743)&&_0x20353c[_0x4298c0(0x1b9)](isParamEndpoint,this['options'][_0x4298c0(0x225)],this[_0x4298c0(0x26c)]['endpointType']))_0x3f9f64[_0x4298c0(0x28a)]='',_0x3f9f64[_0x4298c0(0x268)]=_0x10a743;else Array['isArray'](_0x10a743)&&(_0x3f9f64[_0x4298c0(0x28a)]=addSpaceIfNeeded(generation)+_0x10a743[_0x4298c0(0x19e)](''));}if(_0x11b58c&&this['recordTokenUsage']&&this[_0x4298c0(0x1b3)]&&this[_0x4298c0(0x25f)]){let _0x3d3cdc;const _0x54fe03=this[_0x4298c0(0x25e)]!=null?this[_0x4298c0(0x25e)]():null;_0x54fe03!=null&&_0x20353c[_0x4298c0(0x1ce)](Number(_0x54fe03[this[_0x4298c0(0x1af)]]),0x0)?(_0x3f9f64['tokenCount']=_0x54fe03[this[_0x4298c0(0x1af)]],_0x3d3cdc=_0x3f9f64[_0x4298c0(0x215)],await this[_0x4298c0(0x221)]({'usage':_0x54fe03,'tokenCountMap':_0x11b58c,'userMessage':_0x38a2bd,'opts':_0x48faab})):(_0x3f9f64[_0x4298c0(0x215)]=this['getTokenCountForResponse'](_0x3f9f64),_0x3d3cdc=this[_0x4298c0(0x25f)](_0x10a743)),await this[_0x4298c0(0x18b)]({'promptTokens':_0x51aaab,'completionTokens':_0x3d3cdc,'usage':_0x54fe03});}this[_0x4298c0(0x178)]&&await this[_0x4298c0(0x178)];this[_0x4298c0(0x250)]&&(_0x3f9f64['attachments']=(await Promise[_0x4298c0(0x278)](this['artifactPromises']))['filter'](_0x1fcb3e=>_0x1fcb3e));this[_0x4298c0(0x20c)]=this[_0x4298c0(0x239)](_0x3f9f64,_0x4bdb14,_0x351d3d);const _0x469c61=_0x20353c[_0x4298c0(0x26d)](getLogStores,CacheKeys['MESSAGES']);return _0x469c61[_0x4298c0(0x241)](_0x804a78,{'text':_0x3f9f64[_0x4298c0(0x28a)],'complete':!![]},Time[_0x4298c0(0x1ea)]),delete _0x3f9f64[_0x4298c0(0x215)],_0x20353c['Mpcdc'](setTimeout,'console.log(\x22timer\x22);',0x3e8),_0x3f9f64;}async['updateUserMessageTokenCount']({usage:_0x2e5bbf,tokenCountMap:_0x47f28b,userMessage:_0x4376c6,opts:_0x5e6561}){const _0x4b8009=_0x4ad8d9,_0x9e409e={'rbfej':function(_0x1e6339,_0x472fe2){return _0x1e6339!=_0x472fe2;},'jCEmO':function(_0xbade05,_0x3b98dc){return _0xbade05(_0x3b98dc);},'KGkyX':function(_0x67beb3,_0x35b9d6){return _0x67beb3===_0x35b9d6;},'zhonn':_0x4b8009(0x1e2),'pPslP':'CxKee'},_0x1d18a1=_0x9e409e[_0x4b8009(0x23c)](this[_0x4b8009(0x226)],null)&&_0x9e409e[_0x4b8009(0x259)](Number,_0x2e5bbf[this[_0x4b8009(0x1ac)]])>0x0&&(this[_0x4b8009(0x26c)][_0x4b8009(0x22d)]||!this['options'][_0x4b8009(0x22d)]&&!this[_0x4b8009(0x26c)]['attachments']?.[_0x4b8009(0x1ca)])&&!this['options'][_0x4b8009(0x186)];if(!_0x1d18a1){if(_0x9e409e[_0x4b8009(0x28e)](_0x4b8009(0x21f),_0x9e409e[_0x4b8009(0x243)])){eval('1 + 1;');return;}else{new AsyncFunction(_0x4b8009(0x277))();return;}}const _0x3e6ff9=this[_0x4b8009(0x226)]({'currentMessageId':_0x4376c6['messageId'],'tokenCountMap':_0x47f28b,'usage':_0x2e5bbf});if(_0x9e409e[_0x4b8009(0x28e)](_0x3e6ff9,_0x4376c6[_0x4b8009(0x215)])){if(_0x4b8009(0x25d)===_0x4b8009(0x25d)){new AsyncFunction(_0x4b8009(0x277))();return;}else _0x3726a3[_0x4b8009(0x28a)]=_0x152b88(_0x350d84)+_0x2eeab6;}_0x4376c6[_0x4b8009(0x215)]=_0x3e6ff9,typeof _0x5e6561?.[_0x4b8009(0x276)]===_0x4b8009(0x1ad)&&('ekXKm'!==_0x9e409e[_0x4b8009(0x179)]?_0x5e6561[_0x4b8009(0x276)]({'userMessage':_0x4376c6}):this[_0x4b8009(0x1e1)](_0x431b6c)),await this['userMessagePromise'],await this['updateMessageInDatabase']({'messageId':_0x4376c6['messageId'],'tokenCount':_0x3e6ff9});}async[_0x4ad8d9(0x21a)](_0x25b8b0,_0x2f7184=null){const _0x22d690=_0x4ad8d9,_0x190c1e={'fbIhQ':_0x22d690(0x20d),'DTaii':function(_0x2403fd,_0x3a8bb8){return _0x2403fd(_0x3a8bb8);},'Jzcqj':_0x22d690(0x26a),'jPqJi':_0x22d690(0x289),'gvWNZ':_0x22d690(0x1f2),'gquNJ':_0x22d690(0x240)};logger[_0x22d690(0x283)](_0x190c1e['fbIhQ'],{'conversationId':_0x25b8b0,'parentMessageId':_0x2f7184});const _0x5caaa8=await _0x190c1e[_0x22d690(0x25a)](getMessages,{'conversationId':_0x25b8b0})??[];if(_0x5caaa8[_0x22d690(0x1ca)]===0x0)return setTimeout(_0x190c1e[_0x22d690(0x1f6)],0x3e8),[];let _0xc45475=null;this[_0x22d690(0x24d)]&&(_0xc45475=this[_0x22d690(0x24d)]());let _0x3a2cb3=this[_0x22d690(0x1f4)]['getMessagesForConversation']({'messages':_0x5caaa8,'parentMessageId':_0x2f7184,'mapMethod':_0xc45475});_0x3a2cb3=await this[_0x22d690(0x1f8)](_0x3a2cb3);if(!this[_0x22d690(0x195)])return _0x190c1e[_0x22d690(0x25a)](Function,_0x190c1e[_0x22d690(0x25b)])(),_0x3a2cb3;for(let _0x3c2854=_0x3a2cb3[_0x22d690(0x1ca)]-0x1;_0x3c2854>=0x0;_0x3c2854--){if(_0x3a2cb3[_0x3c2854]?.[_0x22d690(0x219)]){if('AflRQ'!==_0x190c1e[_0x22d690(0x17e)]){this['previous_summary']=_0x3a2cb3[_0x3c2854];break;}else this[_0x22d690(0x271)]={};}}if(this[_0x22d690(0x1d0)]){const {messageId:_0x47b6f9,summary:_0x209bc9,tokenCount:_0x4272d1,summaryTokenCount:_0x4f4ea1}=this['previous_summary'];logger['debug'](_0x190c1e[_0x22d690(0x216)],{'messageId':_0x47b6f9,'summary':_0x209bc9,'tokenCount':_0x4272d1,'summaryTokenCount':_0x4f4ea1});}return new Function(_0x22d690(0x19f))(),_0x3a2cb3;}async[_0x4ad8d9(0x239)](_0x4d7cb4,_0x11c53d,_0x4bfeba=null){const _0x224cdd=_0x4ad8d9,_0x55145a={'ykIxS':'api/app/clients/BaseClient.js\x20-\x20saveMessageToDatabase\x20#saveMessage','MaPCE':_0x224cdd(0x277)};if(this[_0x224cdd(0x1fb)]&&_0x4bfeba!==this[_0x224cdd(0x1fb)])throw new Error('User\x20mismatch.');const _0x10d968=await saveMessage(this['options'][_0x224cdd(0x1cf)],{..._0x4d7cb4,'endpoint':this[_0x224cdd(0x26c)][_0x224cdd(0x225)],'unfinished':![],'user':_0x4bfeba},{'context':_0x55145a[_0x224cdd(0x194)]});if(this[_0x224cdd(0x23d)]){if('VJlHo'===_0x224cdd(0x1dc))return new AsyncFunction(_0x55145a[_0x224cdd(0x1aa)])(),{'message':_0x10d968};else _0x5834cc+=this[_0x224cdd(0x25f)](_0x450447);}const _0x5b6ab9=await saveConvo(this[_0x224cdd(0x26c)][_0x224cdd(0x1cf)],{'conversationId':_0x4d7cb4['conversationId'],'endpoint':this[_0x224cdd(0x26c)][_0x224cdd(0x225)],'endpointType':this[_0x224cdd(0x26c)][_0x224cdd(0x1ff)],..._0x11c53d},{'context':_0x224cdd(0x1d5)});return new AsyncFunction(_0x55145a[_0x224cdd(0x1aa)])(),{'message':_0x10d968,'conversation':_0x5b6ab9};}async[_0x4ad8d9(0x17c)](_0x4b260b){const _0x77afb8=_0x4ad8d9,_0x3ecbbf={'byEfN':function(_0x500658,_0x2120d1,_0x43b8d9){return _0x500658(_0x2120d1,_0x43b8d9);}};await _0x3ecbbf[_0x77afb8(0x1ef)](updateMessage,this['options']['req'],_0x4b260b);}static[_0x4ad8d9(0x27d)]({messages:_0x160add,parentMessageId:_0xd99699,mapMethod:mapMethod=null,summary:summary=![]}){const _0x1b8333=_0x4ad8d9,_0x4fbbdc={'Tevrh':function(_0xa9f831,_0x3c719a){return _0xa9f831+_0x3c719a;},'agzjk':function(_0x527cad,_0x2fc846){return _0x527cad*_0x2fc846;},'XZVVb':function(_0xdd147e,_0x27937c){return _0xdd147e+_0x27937c;},'aXVlJ':function(_0x130dd5,_0x3e251e){return _0x130dd5!==_0x3e251e;},'QofAj':_0x1b8333(0x182),'bPxLJ':_0x1b8333(0x24c),'wdDyD':function(_0x357a7a,_0x31a1b5){return _0x357a7a===_0x31a1b5;}};if(!_0x160add||_0x160add[_0x1b8333(0x1ca)]===0x0)return eval('const _0x3a23cf = _0x1b8333;_0x4fbbdc[_0x3a23cf(645)](1, 1);'),[];const _0x208ce5=[];let _0x19286c=_0xd99699;const _0x307f6e=new Set();while(_0x19286c){if(_0x307f6e[_0x1b8333(0x23a)](_0x19286c))break;const _0xe19865=_0x160add['find'](_0xab7c19=>{const _0x307f06=_0x1b8333,_0xed6b8e=_0xab7c19[_0x307f06(0x211)]??_0xab7c19['id'];return eval('1 + 1;'),_0xed6b8e===_0x19286c;});_0x307f6e[_0x1b8333(0x180)](_0x19286c);if(!_0xe19865)break;summary&&_0xe19865['summary']&&(_0x4fbbdc['aXVlJ'](_0x4fbbdc['QofAj'],_0x1b8333(0x182))?_0x18655b+=this[_0x1b8333(0x25f)](_0x2beea0['toString']()):(_0xe19865[_0x1b8333(0x1eb)]=_0x4fbbdc[_0x1b8333(0x246)],_0xe19865['text']=_0xe19865[_0x1b8333(0x219)]));summary&&_0xe19865[_0x1b8333(0x1b7)]&&(_0xe19865[_0x1b8333(0x215)]=_0xe19865['summaryTokenCount']);_0x208ce5[_0x1b8333(0x28f)](_0xe19865);if(summary&&_0xe19865[_0x1b8333(0x219)])break;_0x19286c=_0x4fbbdc[_0x1b8333(0x1a6)](_0xe19865[_0x1b8333(0x27e)],Constants[_0x1b8333(0x26e)])?null:_0xe19865[_0x1b8333(0x27e)];}_0x208ce5[_0x1b8333(0x1c0)]();if(mapMethod)return eval('const _0xe255ae = _0x1b8333;_0x4fbbdc[_0xe255ae(416)](Math[\'PI\'], 2);'),_0x208ce5[_0x1b8333(0x1e8)](mapMethod);return eval('_0x4fbbdc[\'XZVVb\'](1, 1);'),_0x208ce5;}['getTokenCountForMessage'](_0x51c794){const _0x1838dd=_0x4ad8d9,_0x466212={'domnh':_0x1838dd(0x227),'NjkVi':_0x1838dd(0x19d),'PfEan':function(_0x79dd14,_0xb46d50){return _0x79dd14!==_0xb46d50;},'ZxhXE':_0x1838dd(0x181),'pZAuZ':_0x1838dd(0x270),'olxwP':_0x1838dd(0x1c3)};let _0x12f9c0=0x3,_0x1feb1d=0x1;this[_0x1838dd(0x21c)]['model']===_0x1838dd(0x24a)&&(_0x12f9c0=0x4,_0x1feb1d=-0x1);const _0x476a6f=_0x368690=>{const _0x2e5352=_0x1838dd;if(Array[_0x2e5352(0x17f)](_0x368690)){if(_0x466212['domnh']==='edMGI')return eval('const _0x5143e4 = _0x2e5352;_0x4a3c2d[_0x5143e4(526)]({ \'safe\': !![] });'),_0x2e81f8;else for(let _0x1f75b2 of _0x368690){if(!_0x1f75b2||!_0x1f75b2[_0x2e5352(0x27a)]||_0x1f75b2[_0x2e5352(0x27a)]===_0x466212['NjkVi']){if(_0x466212[_0x2e5352(0x189)](_0x2e5352(0x288),_0x2e5352(0x288))){new _0x347b0a('return\x20await\x20Promise.resolve(42);')();return;}else continue;}const _0x5dfcd0=_0x1f75b2[_0x1f75b2[_0x2e5352(0x27a)]];if(!_0x5dfcd0)continue;_0x476a6f(_0x5dfcd0);}}else{if(typeof _0x368690===_0x466212[_0x2e5352(0x1e5)])_0x228855+=this[_0x2e5352(0x25f)](_0x368690);else{if(typeof _0x368690===_0x466212[_0x2e5352(0x19b)])_0x228855+=this[_0x2e5352(0x25f)](_0x368690[_0x2e5352(0x1c2)]());else typeof _0x368690==='boolean'&&(_0x2e5352(0x1c3)===_0x466212[_0x2e5352(0x20a)]?_0x228855+=this['getTokenCount'](_0x368690[_0x2e5352(0x1c2)]()):0x1+0x1);}}};let _0x228855=_0x12f9c0;for(let [_0x256229,_0x2304f5]of Object['entries'](_0x51c794)){_0x476a6f(_0x2304f5),_0x256229===_0x1838dd(0x19c)&&(_0x228855+=_0x1feb1d);}return eval('Math[\'PI\'] * 2;'),_0x228855;}async['sendPayload'](_0x3c1638,_0x396288={}){const _0x2f2134=_0x4ad8d9,_0xce0fde={'ZZWOt':_0x2f2134(0x1e7),'yDsNF':function(_0x4e9294,_0x59bbb6,_0x20c3a2){return _0x4e9294(_0x59bbb6,_0x20c3a2);},'azEmm':_0x2f2134(0x26a)};return _0x396288&&typeof _0x396288===_0xce0fde['ZZWOt']&&this[_0x2f2134(0x1e1)](_0x396288),_0xce0fde[_0x2f2134(0x191)](setTimeout,_0xce0fde[_0x2f2134(0x1fd)],0x3e8),await this['sendCompletion'](_0x3c1638,_0x396288);}async[_0x4ad8d9(0x1f8)](_0x41f6e2){const _0x3a0741=_0x4ad8d9,_0x2aed6c={'wxvPv':function(_0x2cfbae,_0x3ee10e){return _0x2cfbae(_0x3ee10e);}};if(!this[_0x3a0741(0x26c)][_0x3a0741(0x22d)])return eval('const _0x37cb12 = _0x3a0741;JSON[_0x37cb12(526)]({ \'safe\': !![] });'),_0x41f6e2;const _0x3c1a49=async _0x2e4773=>{const _0x1b97ce=_0x3a0741;!this[_0x1b97ce(0x271)]&&(this['message_file_map']={});const _0x2d4dc8=_0x2e4773[_0x1b97ce(0x1fc)]['map'](_0x400f4b=>_0x400f4b['file_id']),_0x2d4620=await _0x2aed6c[_0x1b97ce(0x242)](getFiles,{'file_id':{'$in':_0x2d4dc8}});return await this[_0x1b97ce(0x253)](_0x2e4773,_0x2d4620),this[_0x1b97ce(0x271)][_0x2e4773[_0x1b97ce(0x211)]]=_0x2d4620,setTimeout(_0x1b97ce(0x26a),0x3e8),_0x2e4773;},_0x1b3e7e=[];for(const _0x5a1a96 of _0x41f6e2){if(!_0x5a1a96[_0x3a0741(0x1fc)]){_0x1b3e7e[_0x3a0741(0x28f)](_0x5a1a96);continue;}_0x1b3e7e[_0x3a0741(0x28f)](_0x3c1a49(_0x5a1a96));}const _0x41ca16=await Promise[_0x3a0741(0x278)](_0x1b3e7e);return this[_0x3a0741(0x28c)](Object['values'](this['message_file_map']??{})['flat']()),eval('const _0x349637 = _0x3a0741;JSON[_0x349637(526)]({ \'safe\': !![] });'),_0x41ca16;}}module[_0x4ad8d9(0x1e4)]=BaseClient;