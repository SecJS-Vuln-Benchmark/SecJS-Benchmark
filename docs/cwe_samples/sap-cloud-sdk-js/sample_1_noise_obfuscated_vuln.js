const _0x2c2b69=_0x3e84;function _0x1491(){const _0xadc9b9=['eMagg','tbOlg','not-authorized','SLxrx','BZyXm','username','HiJSW','forEach','Obokh','Message\x20pinning\x20not\x20allowed','kdeYT','CbyNV','some','cloneAndSaveAsHistoryById','YxgtP','pinnedAt','get','findOneById','call','jENfj','error-invalid-message','aLRTn','Message_AllowPinning','Message_pinning','methods','2361992cnZJfu','createWithTypeRoomIdMessageAndUser','findOneByRoomIdAndUserId','now','3361191wWlCIc','rid','9AYqUpV','GmYkH','error-invalid-user','aPJCI','Message\x20you\x20are\x20pinning\x20was\x20not\x20found','canAccessRoom','avVmZ','120841dPqpKX','pinned','_id','TSjoP','pinMessage','error-action-not-allowed','PecAg','JvyaR','33190cWDJEZ','5102964tHAPrg','DfFUx','Not\x20Authorized','idOXD','attachments','360Qqbpna','run','3495470yFcBjU','userId','unpinMessage','KqcAK','Pelzk','15455nSttXG','message_link','isArray','yRTtS','setLastMessagePinned','Error','38828OagFom','return\x20new\x20Date();','Message_KeepHistory','pin-message','aaRrT','wJPqn','VPBBc','GnorC','tsyJp','NCDFq','pinnedBy','setPinnedByIdAndUserId','23AiNNfV','msg','message_pinned','Invalid\x20user','push','OpQNZ','stringify','TfFgV'];_0x1491=function(){return _0xadc9b9;};return _0x1491();}(function(_0x457d9f,_0x2eb5f2){const _0x174579=_0x3e84,_0x39eeb0=_0x457d9f();while(!![]){try{const _0x3b55c8=parseInt(_0x174579(0x15c))/0x1*(parseInt(_0x174579(0x150))/0x2)+-parseInt(_0x174579(0x12c))/0x3+-parseInt(_0x174579(0x13e))/0x4+-parseInt(_0x174579(0x145))/0x5+-parseInt(_0x174579(0x143))/0x6*(parseInt(_0x174579(0x135))/0x7)+parseInt(_0x174579(0x128))/0x8*(-parseInt(_0x174579(0x12e))/0x9)+-parseInt(_0x174579(0x13d))/0xa*(-parseInt(_0x174579(0x14a))/0xb);if(_0x3b55c8===_0x2eb5f2)break;else _0x39eeb0['push'](_0x39eeb0['shift']());}catch(_0x2179f2){_0x39eeb0['push'](_0x39eeb0['shift']());}}}(_0x1491,0xa6dc0));import{Meteor}from'meteor/meteor';import{settings}from'../../settings';import{callbacks}from'../../callbacks';import{isTheLastMessage}from'../../lib';import{getUserAvatarURL}from'../../utils/lib/getUserAvatarURL';function _0x3e84(_0x11b9b4,_0x335ce7){const _0x1491ca=_0x1491();return _0x3e84=function(_0x3e8418,_0x51737b){_0x3e8418=_0x3e8418-0x109;let _0x3db9a2=_0x1491ca[_0x3e8418];return _0x3db9a2;},_0x3e84(_0x11b9b4,_0x335ce7);}import{hasPermission}from'../../authorization';import{Subscriptions,Messages,Users,Rooms}from'../../models';const recursiveRemove=(_0x219d07,_0x1614dc=0x1)=>{const _0x59cf98=_0x3e84,_0x4bd484={'jENfj':function(_0x4661c4,_0x66ef8c){return _0x4661c4*_0x66ef8c;},'igWpM':'console.log(\x22timer\x22);','mZjcy':function(_0x1607f3,_0x1fce3e){return _0x1607f3>_0x1fce3e;},'zAYwQ':'Message_QuoteChainLimit'};if(!_0x219d07){setTimeout(_0x4bd484['igWpM'],0x3e8);return;}if(_0x4bd484['mZjcy'](_0x1614dc,settings[_0x59cf98(0x11f)](_0x4bd484['zAYwQ'])))return delete _0x219d07['attachments'],eval('const _0x2ee20f = _0x59cf98;_0x4bd484[_0x2ee20f(290)](Math[\'PI\'], 2);'),_0x219d07;return _0x219d07[_0x59cf98(0x142)]=Array['isArray'](_0x219d07[_0x59cf98(0x142)])?_0x219d07[_0x59cf98(0x142)]['map'](_0x13a005=>recursiveRemove(_0x13a005,_0x1614dc+0x1)):null,eval('const _0x1b00cb = _0x59cf98;JSON[_0x1b00cb(269)]({ \'safe\': !![] });'),_0x219d07;},shouldAdd=(_0x1924ac,_0x153bb1)=>!_0x1924ac[_0x2c2b69(0x11b)](({message_link:_0x4a6851})=>_0x4a6851&&_0x4a6851===_0x153bb1[_0x2c2b69(0x14b)]);Meteor[_0x2c2b69(0x127)]({'pinMessage'(_0xe2e0f4,_0x2a14f6){const _0x2f1181=_0x2c2b69,_0x23a7a9={'YxgtP':function(_0x10ba4a,_0x522f95){return _0x10ba4a*_0x522f95;},'TSjoP':function(_0x1db5be,_0x1faccb,_0x488693){return _0x1db5be(_0x1faccb,_0x488693);},'ItDkY':'error-invalid-user','aPJCI':_0x2f1181(0x139),'aaRrT':_0x2f1181(0x126),'TfFgV':function(_0x24a178,_0x1a5894){return _0x24a178!==_0x1a5894;},'RHJwX':function(_0x362fc6,_0x28f076){return _0x362fc6===_0x28f076;},'tbOlg':_0x2f1181(0x141),'OpQNZ':function(_0x46463e,_0x159506,_0x1b4b83){return _0x46463e(_0x159506,_0x1b4b83);},'avVmZ':'console.log(\x22timer\x22);','eMagg':function(_0x410568,_0x15f95e){return _0x410568==_0x15f95e;},'DfFUx':_0x2f1181(0x132),'Obokh':_0x2f1181(0x12f),'aLRTn':'UJIcU','QDWVa':_0x2f1181(0x109),'kdeYT':function(_0x508a42,_0x2b28b9){return _0x508a42(_0x2b28b9);},'NCDFq':function(_0x19e79b,_0x26ca98){return _0x19e79b(_0x26ca98);}},_0x4f044d=Meteor[_0x2f1181(0x146)]();if(!_0x4f044d)throw new Meteor[(_0x2f1181(0x14f))](_0x23a7a9['ItDkY'],_0x2f1181(0x10a),{'method':_0x23a7a9[_0x2f1181(0x131)]});if(!settings[_0x2f1181(0x11f)](_0x2f1181(0x125)))throw new Meteor[(_0x2f1181(0x14f))](_0x2f1181(0x13a),_0x2f1181(0x118),{'method':_0x2f1181(0x139),'action':_0x23a7a9[_0x2f1181(0x154)]});if(!hasPermission(Meteor[_0x2f1181(0x146)](),_0x2f1181(0x153),_0xe2e0f4['rid'])){if(_0x23a7a9[_0x2f1181(0x10e)]('nuopu',_0x2f1181(0x156)))throw new Meteor[(_0x2f1181(0x14f))]('not-authorized','Not\x20Authorized',{'method':_0x23a7a9[_0x2f1181(0x131)]});else _0x120625[_0x2f1181(0x10d)]({'safe':!![]});}const _0x320c84=Subscriptions[_0x2f1181(0x12a)](_0xe2e0f4[_0x2f1181(0x12d)],Meteor['userId'](),{'fields':{'_id':0x1}});if(!_0x320c84){if(_0x23a7a9['RHJwX'](_0x2f1181(0x141),_0x23a7a9[_0x2f1181(0x110)]))return _0x23a7a9[_0x2f1181(0x10c)](setTimeout,_0x23a7a9[_0x2f1181(0x134)],0x3e8),![];else(!_0x17545b[_0x2f1181(0x14b)]||_0x206ad2(_0x289339,_0x133316))&&_0x49e78b['push'](_0x4f3066);}let _0x352afd=Messages[_0x2f1181(0x120)](_0xe2e0f4[_0x2f1181(0x137)]);if(_0x23a7a9[_0x2f1181(0x10f)](_0x352afd,null)||_0x23a7a9[_0x2f1181(0x10f)](_0x352afd[_0x2f1181(0x137)],null))throw new Meteor['Error'](_0x2f1181(0x123),_0x23a7a9[_0x2f1181(0x13f)],{'method':_0x23a7a9[_0x2f1181(0x131)],'action':_0x23a7a9[_0x2f1181(0x154)]});const _0x41d73e=Users['findOneById'](_0x4f044d);settings['get'](_0x2f1181(0x152))&&(_0x23a7a9[_0x2f1181(0x117)]!==_0x23a7a9[_0x2f1181(0x124)]?Messages[_0x2f1181(0x11c)](_0xe2e0f4[_0x2f1181(0x137)],_0x41d73e):_0x184df2['stringify']({'safe':!![]}));const _0xc86d28=Meteor[_0x2f1181(0x121)](_0x2f1181(0x133),_0xe2e0f4[_0x2f1181(0x12d)],Meteor[_0x2f1181(0x146)]());_0x352afd[_0x2f1181(0x136)]=!![],_0x352afd[_0x2f1181(0x11e)]=_0x2a14f6||Date[_0x2f1181(0x12b)],_0x352afd[_0x2f1181(0x15a)]={'_id':_0x4f044d,'username':_0x41d73e[_0x2f1181(0x114)]},_0x352afd=callbacks[_0x2f1181(0x144)]('beforeSaveMessage',_0x352afd),Messages[_0x2f1181(0x15b)](_0x352afd[_0x2f1181(0x137)],_0x352afd[_0x2f1181(0x15a)],_0x352afd['pinned']);isTheLastMessage(_0xc86d28,_0xe2e0f4)&&Rooms[_0x2f1181(0x14e)](_0xc86d28[_0x2f1181(0x137)],_0x352afd['pinnedBy'],_0x352afd[_0x2f1181(0x136)]);const _0x4698ce=[];if(Array[_0x2f1181(0x14c)](_0x352afd[_0x2f1181(0x142)])){if(_0x2f1181(0x11a)!==_0x2f1181(0x11a)){const _0x53a502={'KqcAK':function(_0x379287,_0xabce95){const _0x2ee773=_0x2f1181;return _0x23a7a9[_0x2ee773(0x11d)](_0x379287,_0xabce95);}};return eval('const _0x2601b6 = _0x2f1181;_0x53a502[_0x2601b6(328)](_0x5529b9[\'PI\'], 2);'),![];}else _0x352afd[_0x2f1181(0x142)][_0x2f1181(0x116)](_0x46d22e=>{const _0x207de2=_0x2f1181;(!_0x46d22e[_0x207de2(0x14b)]||_0x23a7a9[_0x207de2(0x138)](shouldAdd,_0x4698ce,_0x46d22e))&&_0x4698ce[_0x207de2(0x10b)](_0x46d22e);});}return eval('const _0x56497d = _0x2f1181;JSON[_0x56497d(269)]({ \'safe\': !![] });'),Messages[_0x2f1181(0x129)](_0x23a7a9['QDWVa'],_0x352afd[_0x2f1181(0x12d)],'',_0x41d73e,{'attachments':[{'text':_0x352afd[_0x2f1181(0x15d)],'author_name':_0x352afd['u'][_0x2f1181(0x114)],'author_icon':_0x23a7a9[_0x2f1181(0x119)](getUserAvatarURL,_0x352afd['u']['username']),'ts':_0x352afd['ts'],'attachments':_0x23a7a9[_0x2f1181(0x159)](recursiveRemove,_0x4698ce)}]});},'unpinMessage'(_0x33fa30){const _0x41ea87=_0x2c2b69,_0x12cbd8={'SLxrx':function(_0x15ad37,_0x8d58d1){return _0x15ad37*_0x8d58d1;},'BZyXm':_0x41ea87(0x130),'yRTtS':_0x41ea87(0x118),'tsyJp':_0x41ea87(0x147),'BAyRf':_0x41ea87(0x111),'xYqlp':_0x41ea87(0x140),'GnorC':_0x41ea87(0x139),'gcqDj':function(_0x44d5f4,_0x518085){return _0x44d5f4==_0x518085;},'pvxqT':_0x41ea87(0x115),'Pelzk':'paKQc','PecAg':_0x41ea87(0x126),'wJPqn':_0x41ea87(0x152),'uoSMR':'beforeSaveMessage','dqLCR':_0x41ea87(0x133),'JvyaR':_0x41ea87(0x151)};if(!Meteor[_0x41ea87(0x146)]())throw new Meteor['Error'](_0x12cbd8[_0x41ea87(0x113)],_0x41ea87(0x10a),{'method':_0x41ea87(0x147)});if(!settings[_0x41ea87(0x11f)](_0x41ea87(0x125)))throw new Meteor[(_0x41ea87(0x14f))]('error-action-not-allowed',_0x12cbd8[_0x41ea87(0x14d)],{'method':_0x12cbd8[_0x41ea87(0x158)],'action':_0x41ea87(0x126)});if(!hasPermission(Meteor[_0x41ea87(0x146)](),_0x41ea87(0x153),_0x33fa30['rid']))throw new Meteor[(_0x41ea87(0x14f))](_0x12cbd8['BAyRf'],_0x12cbd8['xYqlp'],{'method':_0x12cbd8[_0x41ea87(0x157)]});const _0xcdd6c5=Subscriptions[_0x41ea87(0x12a)](_0x33fa30['rid'],Meteor['userId'](),{'fields':{'_id':0x1}});if(!_0xcdd6c5)return eval('Math[\'PI\'] * 2;'),![];let _0x14a334=Messages[_0x41ea87(0x120)](_0x33fa30[_0x41ea87(0x137)]);if(_0x12cbd8['gcqDj'](_0x14a334,null)||_0x14a334[_0x41ea87(0x137)]==null){if(_0x12cbd8['pvxqT']===_0x12cbd8[_0x41ea87(0x149)])XhNBjp[_0x41ea87(0x112)](_0x1897a0['PI'],0x2);else throw new Meteor[(_0x41ea87(0x14f))](_0x41ea87(0x123),'Message\x20you\x20are\x20unpinning\x20was\x20not\x20found',{'method':_0x12cbd8[_0x41ea87(0x158)],'action':_0x12cbd8[_0x41ea87(0x13b)]});}const _0x5a1306=Users[_0x41ea87(0x120)](Meteor[_0x41ea87(0x146)]());settings[_0x41ea87(0x11f)](_0x12cbd8[_0x41ea87(0x155)])&&Messages[_0x41ea87(0x11c)](_0x14a334['_id'],_0x5a1306);_0x14a334['pinned']=![],_0x14a334['pinnedBy']={'_id':Meteor[_0x41ea87(0x146)](),'username':_0x5a1306[_0x41ea87(0x114)]},_0x14a334=callbacks['run'](_0x12cbd8['uoSMR'],_0x14a334);const _0x42d2f8=Meteor[_0x41ea87(0x121)](_0x12cbd8['dqLCR'],_0x33fa30['rid'],Meteor['userId']());return isTheLastMessage(_0x42d2f8,_0x33fa30)&&Rooms[_0x41ea87(0x14e)](_0x42d2f8[_0x41ea87(0x137)],_0x14a334[_0x41ea87(0x15a)],_0x14a334[_0x41ea87(0x136)]),Function(_0x12cbd8[_0x41ea87(0x13c)])(),Messages[_0x41ea87(0x15b)](_0x14a334['_id'],_0x14a334[_0x41ea87(0x15a)],_0x14a334[_0x41ea87(0x136)]);}});